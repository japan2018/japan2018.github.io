<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] Create a machine learning app with ABEJA Platform &#43; LINE Bot | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] Create a machine learning app with ABEJA Platform + LINE Bot</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 1, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/machine-learning"> machine learning</a></code></small>


<small><code><a href="https://memotut.com/tags/linebot"> linebot</a></code></small>


<small><code><a href="https://memotut.com/tags/abejaplatform"> ABEJAPlatform</a></code></small>

</p>
<pre><code>This article is from the second day of [ABEJA Advent Calendar 2019](https://qiita.com/advent-calendar/2019/abeja).
</code></pre>
<p>Last year&rsquo;s <a href="https://qiita.com/advent-calendar/2018/abejaplatform">ABEJA Platform Advent Calendar</a>said,“<a href="https://qiita.com/ishikawa@github/items/150a0705d9581c1000c6">SummaryofABEJAPlatformauthentication</a>”, I introduced the authentication of API calls on the ABEJA Platform, but I wrote it again this year on the ABEJA Platform newsletter.</p>
<p>Unfortunately, the ABEJA Platform does not support <a href="https://elixir-lang.org/">Elixir</a>, so all the code is written in Python.</p>
<h2 id="overview">Overview</h2>
<p>Posted in July 2019 by <a href="https://qiita.com/yushin_n">@yushin_n</a>&quot;<a href="https://qiita.com/yushin_n/items/0d115efa705579a53cfe">CreatemachinelearningapplicationwithABEJAPlatform+CloudFunctions+LINEBot</a>'&rsquo;,</p>
<ul>
<li>ABEJA Platform</li>
<li>Google Cloud Functions</li>
<li>LINE Bot</li>
</ul>
<p>The theme was to create a serverless machine learning application by combining.</p>
<p>This time, I will introduce the procedure to improve this machine learning application and develop LINE Bot only on ABEJA Platform without using Google Cloud Functions **.</p>
<p>To that end, this article uses three features of the ABEJA Platform:</p>
<h3 id="new-container-image">New container image</h3>
<p>ABEJA Platform is divided into <a href="https://developers.abeja.io/function/model/model-handler/">18.10</a>and<a href="https://developers.abeja.io/function/model/model-handler-19.04/">19.xseries</a> provides two types of images. In the 19.x series, not only newer libraries and frameworks have been installed, but the implementation method of the machine learning API has been revamped so that more flexible processing can be implemented.</p>
<h3 id="inference-template">Inference template</h3>
<p>ABEJA Platform provides learning and reasoning templates for some machine learning tasks. By using this template, you can not only learn and infer the machine learning model without writing a single line of code, but also suitable for the business domain (this time LINE bot of image classification) you want to implement by modifying the code. Can be improved to.</p>
<h3 id="api-endpoint-authentication-method">API endpoint authentication method</h3>
<p>You can select the authentication method of the deployed API. In addition to the built-in user authentication and API key authentication options, you can turn off the authentication itself and implement your own processing. The LINE bot implementation uses this feature to implement authentication by signature verification.</p>
<h2 id="system-configuration">System configuration</h2>
<ul>
<li>Send images to LINE Bot</li>
<li>Receive HTTP request (webhook) from LINE Messaging API with HTTP service of ABEJA Platform</li>
<li>Get image data from request, get inference result from image class prediction result</li>
<li>Return prediction result to LINE</li>
</ul>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/e23e0d79-4157-ca53-352c-b1f3dd251dee.png" alt="ABEJA_Platform_LINEbot_Arch.png"></p>
<h2 id="implementation-of-inference-code">Implementation of inference code</h2>
<p>&ldquo;<a href="https://qiita.com/yushin_n/items/6852ad042913617d8892">Learning a machine learning model by non-programming using ABEJA Platform template</a>&rdquo;, network learning has already been completed, and the resulting parameters Is saved as the &ldquo;model&rdquo; of ABEJA Platform.</p>
<img width="1306" alt="Screenshots 2019-12-01 18.18.38.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/419408a2-6611-5ca9-5e15-41f88e6f8049.png">
<h3 id="create-first-version-from-template">Create first version from template</h3>
<p>I don&rsquo;t want to write the inference code from scratch, so I will modify the inference template code of ABEJA Platform. In the inference template,</p>
<ul>
<li>Image classification inference</li>
<li>Return inference result in JSON</li>
</ul>
<p>Since the processing is implemented, you should add the processing unique to LINE bot (details will be described later) here.</p>
<p>In order to generate the code for the inference template, we need to create a &ldquo;deployment&rdquo;, which is a container for managing the code (and the deployed services). Create a new deployment from the &ldquo;Create Deployment&rdquo; button on the <a href="https://console.abeja.io/deployments">Deployment List Screen</a>.</p>
<img width="756" alt="Screenshots 2019-12-01 18.28.45.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/a13bc151-0c1b-ea24-4a65-b903fed026fc.png">
<p>The newly created deployment should show &ldquo;0 model version&rdquo; in the list. This link takes you to the code management screen.</p>
<img width="1117" alt="Screenshots 2019-12-01 18.33.00.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/f5df4cd0-dd00-98bb-2791-69530ca76b4d.png">
<p>The Manage Codes screen allows you to version control the code that belongs to this deployment. Immediately, create a new code version from &ldquo;Create Version&rdquo; on the upper right.</p>
<img width="1373" alt="Screenshots 2019-12-01 18.33.24.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/da47c729-25b1-26a1-f9e5-0170641cfbcf.png">
<p>Since I want to modify the template code this time, select &ldquo;Template&rdquo; from the tab and select &ldquo;Image classification (CPU)&rdquo;.</p>
<img width="745" alt="Screenshots 2019-12-01 18.33.43.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/40aed93b-5a16-9ba3-316d-b147de71a156.png">
<p>The newly created code version &ldquo;0.0.1&rdquo;. Click the link to go to the individual screen.</p>
<img width="1137" alt="Screenshots 2019-12-01 18.34.10.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/9ae9a809-a1eb-c0d4-e821-6f21c1d2b331.png">
<p>You can download the source code zip from the &ldquo;Download&rdquo; link in the individual code version screens.</p>
<img width="1126" alt="Screenshots 2019-12-01 18.34.20.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/8ed1e767-fa2e-cfaf-b8ca-57a37007b1eb.png">
<h3 id="improve-template-code">Improve template code</h3>
<p>Unzip the downloaded zip file and you should have the following directory structure:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls -l
total <span style="color:#ae81ff">96</span>
- rw-r--r--@ <span style="color:#ae81ff">1</span> user staff <span style="color:#ae81ff">1068</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">30</span> 01:31 LICENSE
- rw-r--r--@ <span style="color:#ae81ff">1</span> user staff <span style="color:#ae81ff">4452</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">30</span> 01:31 README.md
- rw-r--r--@ <span style="color:#ae81ff">1</span> user staff <span style="color:#ae81ff">1909</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">30</span> 01:31 predict.py
- rw-r--r--@ <span style="color:#ae81ff">1</span> user staff <span style="color:#ae81ff">12823</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">30</span> 01:31 preprocessor.py
- rw-r--r--@ <span style="color:#ae81ff">1</span> user staff <span style="color:#ae81ff">82</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">30</span> 01:31 requirements-local.txt
- rw-r--r--@ <span style="color:#ae81ff">1</span> user staff <span style="color:#ae81ff">25</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">30</span> 01:31 requirements.txt
- rw-r--r--@ <span style="color:#ae81ff">1</span> user staff <span style="color:#ae81ff">4406</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">30</span> 01:31 train.py
drwxr-xr-x@ <span style="color:#ae81ff">6</span> user staff <span style="color:#ae81ff">192</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">30</span> 01:31 utils
</code></pre></div><p>Add the required libraries to <code>requirements.txt</code> by referring to <a href="https://qiita.com/yushin_n/items/0d115efa705579a53cfe">Original Article</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">line-bot-sdk
googletrans
...
</code></pre></div><p>And, <code>predict.py</code> is a file that implements inference processing, but here is the processing required for LINE bot,</p>
<ol>
<li>Verification of signature sent in header</li>
<li>Get image data from LINE message</li>
<li>Reply result with LINE</li>
</ol>
<p>It is necessary to additionally implement.</p>
<p>First, I will post the <code>predict.py</code> with these implementations completed. The <code>handler</code> function which is the entry point of the request is fixed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> io
<span style="color:#f92672">import</span> linebot
<span style="color:#f92672">import</span> linebot.exceptions
<span style="color:#f92672">import</span> linebot.models
<span style="color:#f92672">import</span> googletrans

<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> load_model
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> npfrom PIL import Image

<span style="color:#f92672">from</span> preprocessor <span style="color:#f92672">import</span> preprocessor
<span style="color:#f92672">from</span> utils <span style="color:#f92672">import</span> set_categories, IMG_ROWS, IMG_COLS


<span style="color:#75715e"># Initialize model</span>
model <span style="color:#f92672">=</span> load_model(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(
    <span style="color:#e6db74">&#39;ABEJA_TRAINING_RESULT_DIR&#39;</span>, <span style="color:#e6db74">&#39;.&#39;</span>), <span style="color:#e6db74">&#39;model.h5&#39;</span>))
_, index2label <span style="color:#f92672">=</span> set_categories(os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(
    <span style="color:#e6db74">&#39;TRAINING_JOB_DATASET_IDS&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#f92672">.</span>split())

<span style="color:#75715e"># (1) Get channel_secret and channel_access_token from your environment variable</span>
channel_secret <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;LINE_CHANNEL_SECRET&#39;</span>]
channel_access_token <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;LINE_CHANNEL_ACCESS_TOKEN&#39;</span>]

line_bot_api <span style="color:#f92672">=</span> linebot<span style="color:#f92672">.</span>LineBotApi(channel_access_token)
parser <span style="color:#f92672">=</span> linebot<span style="color:#f92672">.</span>WebhookParser(channel_secret)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decode_predictions</span>(result):
    result_with_labels <span style="color:#f92672">=</span> [{<span style="color:#e6db74">&#34;label&#34;</span>: index2label[i],
                           <span style="color:#e6db74">&#34;probability&#34;</span>: score} <span style="color:#66d9ef">for</span> i, score <span style="color:#f92672">in</span> enumerate(result)]
    <span style="color:#66d9ef">return</span> sorted(result_with_labels, key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> x: x[<span style="color:#e6db74">&#39;probability&#39;</span>], reverse<span style="color:#f92672">=</span>True)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handler</span>(request, context):
    headers <span style="color:#f92672">=</span> request[<span style="color:#e6db74">&#39;headers&#39;</span>]
    body <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)

    <span style="color:#75715e"># (2) get X-Line-Signature header value</span>
    signature <span style="color:#f92672">=</span> next(h[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#ae81ff">0</span>]
                     <span style="color:#66d9ef">for</span> h <span style="color:#f92672">in</span> headers <span style="color:#66d9ef">if</span> h[<span style="color:#e6db74">&#39;key&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;x-line-signature&#39;</span>)

    <span style="color:#66d9ef">try</span>:
        <span style="color:#75715e"># parse webhook body</span>
        events <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse(body, signature)
        <span style="color:#66d9ef">for</span> event <span style="color:#f92672">in</span> events:
            <span style="color:#75715e"># initialize reply message</span>
            text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>

            <span style="color:#75715e"># if message is TextMessage, then ask for image</span>
            <span style="color:#66d9ef">if</span> event<span style="color:#f92672">.</span>message<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;text&#39;</span>:
                text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;画像を送ってください！&#39;</span>

            <span style="color:#75715e"># (3) if message is ImageMessage, then predict</span>
            <span style="color:#66d9ef">if</span> event<span style="color:#f92672">.</span>message<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;image&#39;</span>:
                message_id <span style="color:#f92672">=</span> event<span style="color:#f92672">.</span>message<span style="color:#f92672">.</span>id
                message_content <span style="color:#f92672">=</span> line_bot_api<span style="color:#f92672">.</span>get_message_content(message_id)

                img_io <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>BytesIO(message_content<span style="color:#f92672">.</span>content)
                img <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(img_io)
                img <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>resize((IMG_ROWS, IMG_COLS))

                x <span style="color:#f92672">=</span> preprocessor(img)
                x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>expand_dims(x, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)

                result <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(x)[<span style="color:#ae81ff">0</span>]
                sorted_result <span style="color:#f92672">=</span> decode_predictions(result<span style="color:#f92672">.</span>tolist())

                <span style="color:#75715e"># translate english label to japanese</span>
                label_en <span style="color:#f92672">=</span> sorted_result[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;label&#39;</span>]
                translator <span style="color:#f92672">=</span> googletrans<span style="color:#f92672">.</span>Translator()
                label_ja <span style="color:#f92672">=</span> translator<span style="color:#f92672">.</span>translate(label_en<span style="color:#f92672">.</span>lower(), dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ja&#39;</span>)

                prob <span style="color:#f92672">=</span> sorted_result[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;probability&#39;</span>]

                <span style="color:#75715e"># set reply message</span>
                text <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#39;{int(prob*100)}%の確率で、{label_ja.text}です！&#39;</span>

            line_bot_api<span style="color:#f92672">.</span>reply_message(
                event<span style="color:#f92672">.</span>reply_token,
                linebot<span style="color:#f92672">.</span>models<span style="color:#f92672">.</span>TextSendMessage(text<span style="color:#f92672">=</span>text))

    <span style="color:#66d9ef">except</span> linebot<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>InvalidSignatureError:
        <span style="color:#66d9ef">raise</span> context<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>ModelError(<span style="color:#e6db74">&#39;Invalid signature&#39;</span>)

    <span style="color:#66d9ef">return</span> {
        <span style="color:#e6db74">&#39;status_code&#39;</span>: <span style="color:#ae81ff">200</span>,
        <span style="color:#e6db74">&#39;content_type&#39;</span>: <span style="color:#e6db74">&#39;text/plain; charset=utf8&#39;</span>,
        <span style="color:#e6db74">&#39;content&#39;</span>: <span style="color:#e6db74">&#39;OK&#39;</span>
    }
</code></pre></div><h2 id="コードの解説">コードの解説</h2>
<p>LINE bot 実装に関連した部分にコメントで番号を振ってあります。順を追って見ていきましょう。ここで解説している以外のコードは推論テンプレートおよび元記事そのままです。</p>
<h4 id="1-line-bot-sdk-の初期化">1. LINE bot SDK の初期化</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># (1) Get channel_secret and channel_access_token from your environment variable</span>
channel_secret <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;LINE_CHANNEL_SECRET&#39;</span>]
channel_access_token <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;LINE_CHANNEL_ACCESS_TOKEN&#39;</span>]

line_bot_api <span style="color:#f92672">=</span> linebot<span style="color:#f92672">.</span>LineBotApi(channel_access_token)
parser <span style="color:#f92672">=</span> linebot<span style="color:#f92672">.</span>WebhookParser(channel_secret)
</code></pre></div><p>ここでは、LINE bot SDK を使って、API クライアントとメッセージの Parser を初期化しています。初期化に必要なパラメータ（秘密鍵とアクセストークン）は、環境変数で渡される想定です。</p>
<h4 id="2-署名の検証">2. 署名の検証</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># (2) get X-Line-Signature header value</span>
signature <span style="color:#f92672">=</span> next(h[<span style="color:#e6db74">&#39;values&#39;</span>][<span style="color:#ae81ff">0</span>]
                 <span style="color:#66d9ef">for</span> h <span style="color:#f92672">in</span> headers <span style="color:#66d9ef">if</span> h[<span style="color:#e6db74">&#39;key&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;x-line-signature&#39;</span>)

<span style="color:#66d9ef">try</span>:
  <span style="color:#75715e"># parse webhook body</span>
  events <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse(body, signature)
</code></pre></div><p>HTTP のリクエスト・ヘッダーで渡される署名 <code>X-Line-Signature</code> を SDK で検証します。HTTP のリクエスト・ヘッダーは handler 関数に渡される <code>request</code> dict に格納されています。</p>
<h4 id="3-メッセージで送られてきた画像を取得">3. メッセージで送られてきた画像を取得</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># (3) if message is ImageMessage, then predict</span>
<span style="color:#66d9ef">if</span> event<span style="color:#f92672">.</span>message<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;image&#39;</span>:
  message_id <span style="color:#f92672">=</span> event<span style="color:#f92672">.</span>message<span style="color:#f92672">.</span>id
  message_content <span style="color:#f92672">=</span> line_bot_api<span style="color:#f92672">.</span>get_message_content(message_id)

  img_io <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>BytesIO(message_content<span style="color:#f92672">.</span>content)
  img <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(img_io)
  img <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>resize((IMG_ROWS, IMG_COLS))
</code></pre></div><p>メッセージの内容を取得し、PIL の Image オブジェクトに変換します。</p>
<h2 id="機械学習モデルのデプロイ">機械学習モデルのデプロイ</h2>
<p>では、出来上がったソースコードを zip に圧縮して、新しくコードバージョンを作りましょう。</p>
<img width="356" alt="スクリーンショット 2019-12-01 19.10.45.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/eb6d4258-696c-8186-af47-d3d45a56e002.png">
<h3 id="新しいコードバージョン">新しいコードバージョン</h3>
<p>さきほどのコード管理画面から新しくコードバージョン作成画面を表示し、zip をアップロードします。このとき、ランタイム（コンテナイメージ）を「<strong>abeja-inc/all-cpu:19.10</strong>」とし、必要な環境変数も設定します。</p>
<img width="751" alt="スクリーンショット_2019-12-01_17_44_11.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/639bdbbd-c1cb-0d00-e5c9-a18648e042fb.png">
<h3 id="api-のデプロイ">API のデプロイ</h3>
<p>API のデプロイは「<a href="https://qiita.com/yushin_n/items/fb338ca9bd3c685ad691">ABEJA Platformのテンプレートを使用して、ノンプログラミングで機械学習モデルをデプロイする</a>」で解説されている通りなので繰り返しません。</p>
<p>ただ、最初に説明したとおり、LINE bot からのリクエストを「認証なし」で通すために、新しいエンドポイントを作成し、</p>
<ul>
<li>プライマリのエンドポイントにする</li>
<li>こうすることで、あとから HTTP サービスを切り替えても、API の URL を変更せずにすみます</li>
<li>アクセス制御で「認証なし」を選択<img width="859" alt="Screenshots 2019-12-01 17.49.02.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/4448968d-0205-b68b-544f-4e918bcdf311.png"></li>
</ul>
<p>You can check the URL of the newly created endpoint from the eye icon in the service list.</p>
<img width="255" alt="Screenshots 2019-12-01 19.20.30.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/fd59f837-11c4-293d-8934-ac7278aef0d7.png">
<p>It should be in the format <code>https://{ORGANIZATION_NAME}.api.abeja.io/deployments/{DEPLOYMENT_ID}</code>. Register this as a webhook for LINE bot.</p>
<img width="955" alt="Screenshot_2019-12-01_17_49_17.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/eb90698d-49bf-d900-bfb1-18ca3c0dd2ab.png">
<h2 id="line-bot-operation-check">LINE bot operation check</h2>
<p>In order to check the operation, I posted some photos on the LINE bot I created this time. <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/18990/fc5d530f-b79a-3ec1-f754-3115ab09dda1.png" alt="IMG_1528.png"></p>
<p>It seems that the result is true (?) LINE bot.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>The photos I used for this post are as follows. <a href="https://www.flickr.com/photos/aikos/4755861023">sunflower by Aiko, Thomas &amp; Juliette+Isaac</a>,<a href="https://www.flickr.com/photos/128905059@N02/22138314909/">rosebyWaldemarJan</a>,<a href="https://www.flickr.com/photos/calliope/8130880534">cauliflowerbylizwest</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
