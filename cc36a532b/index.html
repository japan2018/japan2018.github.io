<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] Python program is slow! I want to speed up! At that time... | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] Python program is slow! I want to speed up! At that time&hellip;</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 23, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/c-language"> C language</a></code></small>


<small><code><a href="https://memotut.com/tags/library"> library</a></code></small>


<small><code><a href="https://memotut.com/tags/cython"> Cython</a></code></small>


<small><code><a href="https://memotut.com/tags/acceleration"> acceleration</a></code></small>

</p>
<pre><code># Python program is slow! I want to speed up! At that time...
</code></pre>
<p>When implemented in Python, the processing time may be too long to meet the requirements. In that case, there are four types of measures shown in this article.</p>
<p>If you do something to speed it up, you lose something else. Typical examples of trade-offs are freedom of expression, readability, dependency, memory usage, and CPU usage. Please follow the usage and capacity and use correctly.</p>
<p>Also, before speeding up, you need to check what is slow in the script using profiling tools etc. Even if you try to speed up the processing that is not slow, the overall execution time will not be affected. This article does not cover that step.</p>
<h2 id="4-types-of-speedup-method">4 types of speedup method</h2>
<p>In this article, I will introduce the following four types of acceleration methods.</p>
<ol>
<li>Rewrite the script in the category of language specification/standard library</li>
<li>Use the library</li>
<li>Make a library</li>
<li>Optimize your bytecode</li>
</ol>
<h2 id="1-rewrite-the-script-in-the-category-of-language-specificationstandard-library">1. Rewrite the script in the category of language specification/standard library</h2>
<p>Originally, other measures such as &ldquo;use library&rdquo; and &ldquo;make library&rdquo; also correspond to &ldquo;rewrite script&rdquo;. Here, <a href="https://docs.python.org/ja/3/reference/index.html">Language specifications</a>and[Standardlibrary]ofPython(<a href="https://docs.python.org/ja/3/library)Thefollowingmethodsareintroducedaswhatcanbedoneinthecategoryof(/index.html).Itdoesn'tgrowtoomuch(thoughitmaydependonthePythonversion">https://docs.python.org/ja/3/library)Thefollowingmethodsareintroducedaswhatcanbedoneinthecategoryof(/index.html).Itdoesn'tgrowtoomuch(thoughitmaydependonthePythonversion</a>) as it can be done within the scope of the standard library.</p>
<ul>
<li>1-1. Review how to write Python script</li>
<li>1-2. Devise algorithm and data structure</li>
<li>1-3. Use the cache</li>
<li>1-4. Parallelize</li>
</ul>
<h3 id="1-1-review-how-to-write-python-script">1-1. Review how to write Python script</h3>
<p>Optimizing the Python interpreter doesn&rsquo;t do much for me. There are various ways to do the same thing, so you can choose a faster way to speed it up.</p>
<p>However, in the actual application, there is not much difference due to the difference in the writing method given here. If you can&rsquo;t think of a style conversion or a slow process, you&rsquo;ll probably find it elsewhere.</p>
<p>Of course, if you collect dust, you can do it. For example, if you try to implement a database only with Python, the processing slowness as shown in this example will work, and it will be unusable as a whole.</p>
<h4 id="example-1-sum-of-1-to-n">Example 1: Sum of 1 to n</h4>
<p>For example, the process of adding integers from 1 to n is added using &ldquo;(1)for&rdquo; and &ldquo;(2) Built-in <a href="https://docs.python.org/ja/3/library/functions.html#sum">sum</a>isused”and“(3) Use the summation formula” is implemented and the time is as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: sum <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1000000</span>):
   <span style="color:#f92672">...</span>: sum <span style="color:#f92672">+=</span> n
<span style="color:#ae81ff">87.3</span> ms <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">492</span> <span style="color:#960050;background-color:#1e0010">μ</span>s per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">10</span> loops each)

In [<span style="color:#ae81ff">2</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: sum(range(<span style="color:#ae81ff">1000000</span>))
<span style="color:#ae81ff">33.3</span> ms <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">1.47</span> ms per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">10</span> loops each)

In [<span style="color:#ae81ff">3</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: ((<span style="color:#ae81ff">1000000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">1000000</span>)<span style="color:#f92672">//</span><span style="color:#ae81ff">2</span>
<span style="color:#ae81ff">13</span> ns <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">0.538</span> ns per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">100000000</span> loops each)
</code></pre></div><p>In this example, the summation formula is fast, but we don&rsquo;t always think of such a conversion.</p>
<h4 id="example-2-generating-a-list">Example 2: Generating a list</h4>
<p>When generating a list, &ldquo;(1) <a href="https://docs.python.org/ja/3/reference/expressions.html?highlight=%E5%86%85%E5%8C%85#displays-for-lists-sets-and-dictionaries">List comprehension</a>&quot;&quot;(2)Forloop<a href="https://docs.python.org/ja/3/tutorial/datastructures.html">append</a>&ldquo;4waysof&rdquo;(3)Cacheappend&quot;and&rdquo;(4)Usebuilt-in<a href="https://docs.python.org/ja/3/library/functions.html#func-list">list</a> function&rdquo; It is as follows when it is implemented with and the time is measured.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: l <span style="color:#f92672">=</span> [n <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1000000</span>)]
<span style="color:#ae81ff">81.7</span> ms <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">1.31</span> ms per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">10</span> loops each)

In [<span style="color:#ae81ff">2</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: l <span style="color:#f92672">=</span> []
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1000000</span>):
   <span style="color:#f92672">...</span>: l<span style="color:#f92672">.</span>append(n)
<span style="color:#ae81ff">130</span> ms <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">2.08</span> ms per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">10</span> loops each)

In [<span style="color:#ae81ff">3</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: l <span style="color:#f92672">=</span> []
   <span style="color:#f92672">...</span>: l_append <span style="color:#f92672">=</span> l<span style="color:#f92672">.</span>append
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1000000</span>):
   <span style="color:#f92672">...</span>: l_append(n)
<span style="color:#ae81ff">97.9</span> ms <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">2.01</span> ms per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">10</span> loops each)

In [<span style="color:#ae81ff">4</span>]: <span style="color:#f92672">%%</span>timeit
    <span style="color:#f92672">...</span>: l <span style="color:#f92672">=</span> list(range(<span style="color:#ae81ff">1000000</span>))
<span style="color:#ae81ff">58.1</span> ms <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">1.49</span> ms per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">10</span> loops each)
</code></pre></div><p>In this example, we&rsquo;re just generating a list, but generally you should do &ldquo;various things&rdquo; before appending. Since this &ldquo;various processing&rdquo; is often slower, it is more effective to speed up &ldquo;various processing&rdquo;.</p>
<h3 id="1-2-devise-algorithm-and-data-structure">1-2. Devise algorithm and data structure</h3>
<p>Algorithms and data structures have been an area of research since ancient times. The execution time is completely different when the calculation amount is $O(n)$ and $O(n^2)$ in order notation. You might implement the algorithms and data structures yourself, or you might use the convenience classes in the standard library.</p>
<p>Here are some examples of algorithms and data structures in the standard library.</p>
<h4 id="example-3-exploring-the-data">Example 3: Exploring the data</h4>
<p>If you want to determine how many times a list contains a particular element, you can [set] the list (<a href="https://docs.python.org/ja/3/library/stdtypes.html#set-">https://docs.python.org/ja/3/library/stdtypes.html#set-</a> It is faster to check with in after converting to types-set-frozenset). If you judge only once, the processing time to convert to a set will be effective.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: l <span style="color:#f92672">=</span> list(range(<span style="color:#ae81ff">10000</span>))
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10000</span>):
   <span style="color:#f92672">...</span>: n <span style="color:#f92672">in</span> l
<span style="color:#ae81ff">1.04</span> s <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">19</span> ms per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">1</span> loop each)

In [<span style="color:#ae81ff">2</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: l <span style="color:#f92672">=</span> list(range(<span style="color:#ae81ff">10000</span>))
   <span style="color:#f92672">...</span>: s <span style="color:#f92672">=</span> set(l)
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10000</span>):
   <span style="color:#f92672">...</span>: n <span style="color:#f92672">in</span> s
<span style="color:#ae81ff">1.45</span> ms <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">14.5</span> <span style="color:#960050;background-color:#1e0010">μ</span>s per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">1000</span> loops each)
</code></pre></div><p>This time, a list of 10,000 elements was searched 10,000 times, and this result was obtained. With such an amount of exploration, I think it often occurs in actual applications.</p>
<h4 id="example-4-manipulating-data">Example 4: Manipulating data</h4>
<p>You can use <a href="https://docs.python.org/ja/3/library/collections.html#collections.deque">collections.deque</a> if you want to add values to the beginning of the list many times.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> deque

In [<span style="color:#ae81ff">2</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: l <span style="color:#f92672">=</span> []
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100000</span>):
   <span style="color:#f92672">...</span>: l<span style="color:#f92672">.</span>insert(<span style="color:#ae81ff">0</span>, n)
<span style="color:#ae81ff">6.29</span> s <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">28.1</span> ms per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">1</span> loop each)

In [<span style="color:#ae81ff">3</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: dq <span style="color:#f92672">=</span> deque()
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100000</span>):
   <span style="color:#f92672">...</span>: dq<span style="color:#f92672">.</span>appendleft(n)
<span style="color:#ae81ff">11.7</span> ms <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">93.1</span> <span style="color:#960050;background-color:#1e0010">μ</span>s per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">100</span> loops each)

</code></pre></div><p>Lists in Python are like variable length arrays. The contents of the array are highly versatile because there are no assumptions about the type or order, but there is room for speeding up and efficiency in certain processes. Besides collections.deque, <a href="https://docs.python.org/ja/3/library/heapq.html">heapq</a>and<a href="https://docs.python.org/ja/3/Library/bisect.html">bisect</a>andotherfunctionsthathandlecollections(collectionofdata) are provided in the standard library.</p>
<h3 id="1-3-use-the-cache">1-3. Use the cache</h3>
<p>The result of the calculation once performed is stored in the memory and reused, or the data fetched from the database is in <a href="https://docs.python.org/ja/3/library/pickle.html">pickle</a>format.Youcanspeeditupby<a href="https://docs.python.org/ja/3/library/pickle.html#pickle.dump">dump</a> with. Anything that returns the same result when the arguments are together, such as a mathematical function, can be cached. In some cases, reading a local file is faster than communicating with the database.</p>
<h4 id="example-5-function-memoizationin-python-a-decorator-to-memoize-the-function-functoolslru_cachehttpsdocspythonorgja3libraryfunctoolshtmlfunctoolslru_cache-is-defined-in-the-standard-library--if-you-use-this-the-calculation-result-will-be-cached-once-and-if-the-arguments-are-the-same-it-will-be-reused">Example 5: Function memoizationIn Python, a decorator to memoize the function <a href="https://docs.python.org/ja/3/library/functools.html#functools.lru_cache">functools.lru_cache</a> is defined in the standard library. .. If you use this, the calculation result will be cached once, and if the arguments are the same, it will be reused.</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> lru_cache

In [<span style="color:#ae81ff">2</span>]: <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fib</span>(n):
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">return</span> n <span style="color:#66d9ef">if</span> n <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> fib(n<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span> fib(n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)

In [<span style="color:#ae81ff">3</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: fib(<span style="color:#ae81ff">30</span>)
<span style="color:#ae81ff">448</span> ms <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">4.22</span> ms per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">1</span> loop each)

In [<span style="color:#ae81ff">4</span>]: <span style="color:#a6e22e">@lru_cache</span>()
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fib</span>(n):
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">return</span> n <span style="color:#66d9ef">if</span> n <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> fib(n<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span> fib(n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)

In [<span style="color:#ae81ff">5</span>]: <span style="color:#f92672">%%</span>timeit <span style="color:#f92672">-</span>n1 <span style="color:#f92672">-</span>r1
   <span style="color:#f92672">...</span>: fib(<span style="color:#ae81ff">30</span>)
<span style="color:#ae81ff">24.2</span> <span style="color:#960050;background-color:#1e0010">μ</span>s <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">0</span> ns per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">1</span> run, <span style="color:#ae81ff">1</span> loop each)
</code></pre></div><p>It&rsquo;s easy because you only need to add the @lru_cache decorator. I don&rsquo;t really want to calculate the Fibonacci sequence, and maybe I would like to calculate it differently. Is it a typical application when you want to calculate the integral by machine learning?</p>
<h3 id="1-4-parallelize">1-4. Parallelize</h3>
<p>Standard library <a href="https://docs.python.org/ja/3/library/threading.html">threading</a>and<a href="https://docs.python.org/ja/3/library/multiprocessing.html">multiprocessing</a>,orbyusing<a href="https://docs.python.org/ja/3/library/concurrent.html">concurrent</a>addedinPython3.2tospeeduptheprocess.IftheCPUisnotthebottleneck,usethreading,otherwiseusemultiprocessing.Threadingmakesiteasiertosharedata,butyoucan&rsquo;tgooverthe100%CPUbarrierduetoGIL(GlobalInterpreterLock), so if you want to use up a multi-core CPU, use multiprocessing.</p>
<h4 id="example-6-concurrent-library">Example 6: concurrent library</h4>
<p>It&rsquo;s easy to use <a href="https://docs.python.org/ja/3/library/concurrent.futures.html">concurrent.future</a>.Ifyouuse<a href="https://docs.python.org/ja/3/library/concurrent.futures.html#concurrent.futures.ProcessPoolExecutor">ProcessPoolExecutor</a>,youcanexecutemultipleprocessesinparallel.Thereisalsoa<a href="https://docs.python.org/ja/3/library/concurrent.futures.html#concurrent.futures.ThreadPoolExecutor">ThreadPoolExecutor</a> that runs in multiple threads.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep
<span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> uniform
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">f</span>(x):
    sleep(uniform(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>)
    <span style="color:#66d9ef">return</span> x

<span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ProcessPoolExecutor, Future, wait
<span style="color:#66d9ef">with</span> ProcessPoolExecutor(max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>) <span style="color:#66d9ef">as</span> executor:
    futures <span style="color:#f92672">=</span> [executor<span style="color:#f92672">.</span>submit(f, x) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>)]
    done, not_done <span style="color:#f92672">=</span> wait(futures)
    results <span style="color:#f92672">=</span> [future<span style="color:#f92672">.</span>result() <span style="color:#66d9ef">for</span> future <span style="color:#f92672">in</span> futures]
</code></pre></div><p>All you have to do is to convert the processing you want to parallelize into a function and call it by specifying the number of workers. Let&rsquo;s remember it as a fixed phrase.</p>
<h4 id="example-7-split-command--python-script">Example 7: split command + Python script</h4>
<p>If you want multi-process, you can do your best with shell instead of Python. Multi-process can be realized by making the above-mentioned function f executable from the command line and calling it in parallel from the shell.</p>
<p>For example, suppose the input file is the following (input).</p>
<pre><code class="language-text:input" data-lang="text:input">0
1
2
3
Four
Five
6
7
8
9
</code></pre><p>Split appropriately with the split command.</p>
<pre><code class="language-console" data-lang="console">$ split -l 1 input
</code></pre><p>Run the Python script with the split file as input.</p>
<pre><code class="language-console" data-lang="console">$ for file in `ls x*`; do python f.py ${file}&amp;; done
</code></pre><p>Combine the divided execution results.</p>
<pre><code class="language-console" data-lang="console">$ cat x*.result&gt; result
</code></pre><p>You can do it all in Python, but I think it&rsquo;s possible to easily make it a multi-process simply by adding &amp; in shell.</p>
<h2 id="2-using-the-library">2. Using the library</h2>
<p>Python has many standard libraries and many third party libraries. Third party libraries are published on <a href="https://pypi.org/">PyPI</a> and can be easily installed with the pip command.</p>
<ul>
<li>2-1. Using the library</li>
<li>2-2. Review the library environment variables and compilation conditions.</li>
</ul>
<h3 id="2-1-using-the-library">2-1. Using the library</h3>
<p>Numerical calculation can be performed at high speed by using a library specialized for numerical calculation such as <a href="https://numpy.org/">NumPy</a>.Therearelibrariesoptimizedforspecificcalculations,notjustnumericalones.<a href="https://cupy.chainer.org/">CuPy</a> makes it easy to run GPU computations from Python using CUDA.</p>
<h4 id="example-8-numpy">Example 8: NumPy</h4>
<p>NumPy can speed up matrix and vector calculations. Not only is it faster, but it also simplifies the code and makes it easier to understand. Here, a 100×1000 matrix is imaged and each element of a list of 100000 elements is added.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np

In [<span style="color:#ae81ff">2</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: X <span style="color:#f92672">=</span> range(<span style="color:#ae81ff">100000</span>)
   <span style="color:#f92672">...</span>: Y <span style="color:#f92672">=</span> range(<span style="color:#ae81ff">100000</span>)
   <span style="color:#f92672">...</span>: Z <span style="color:#f92672">=</span> [x <span style="color:#f92672">+</span> y <span style="color:#66d9ef">for</span> x, y <span style="color:#f92672">in</span> zip(X, Y)]
<span style="color:#ae81ff">13.7</span> ms <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">140</span> <span style="color:#960050;background-color:#1e0010">μ</span>s per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">100</span> loops each)

In [<span style="color:#ae81ff">3</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: X <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">100000</span>)
   <span style="color:#f92672">...</span>: Y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">100000</span>)
   <span style="color:#f92672">...</span>: Z <span style="color:#f92672">=</span> X <span style="color:#f92672">+</span> Y
<span style="color:#ae81ff">416</span> <span style="color:#960050;background-color:#1e0010">μ</span>s <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">2.33</span> <span style="color:#960050;background-color:#1e0010">μ</span>s per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">1000</span> loops each)
</code></pre></div><p>You can see that NumPy is overwhelmingly faster. In the list, we consider that the type of the element and the method of the list change, but the type is fixed in NumPy and <a href="https://en.wikipedia.org/wiki/Basic_Linear_Algebra_Subprograms">BLAS</a> etc. You can use the library of to speed up.</p>
<h4 id="example-9-pickle-and-cpickle">Example 9: pickle and cPickle</h4>
<p>No matter what the library is implemented in, there can be speed differences. In the Python 2 series that will soon be discontinued, <a href="https://docs.python.org/ja/2.7/library/pickle.html#module-pickle">pickle</a>and<a href="https://Thereweretwolibrariescalleddocs.python.org/ja/2.7/library/pickle.html#module-cPickle">cPickle</a>. There is a considerable difference in execution time depending on which one is used. In Python 3, cPickle is now called internally if cPickle is available when you import pickle instead of the name _pickle library.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">import</span> pickle
In [<span style="color:#ae81ff">2</span>]: <span style="color:#f92672">import</span> cPickle
In [<span style="color:#ae81ff">3</span>]: l <span style="color:#f92672">=</span> range(<span style="color:#ae81ff">1000000</span>)

In [<span style="color:#ae81ff">4</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;pickle.pkl&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>) <span style="color:#66d9ef">as</span> f:
   <span style="color:#f92672">...</span>: pickle<span style="color:#f92672">.</span>dump(l, f)
<span style="color:#ae81ff">1</span> loops, best of <span style="color:#ae81ff">3</span>: <span style="color:#ae81ff">3.75</span> s per loop

In [<span style="color:#ae81ff">5</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;cPickle.pkl&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>) <span style="color:#66d9ef">as</span> f:
   <span style="color:#f92672">...</span>: cPickle<span style="color:#f92672">.</span>dump(l, f)
<span style="color:#ae81ff">1</span> loops, best of <span style="color:#ae81ff">3</span>: <span style="color:#ae81ff">376</span> ms per loop
</code></pre></div><p>The display is different from the others because it is IPython of the Python 2 series, but the execution time ratio is about 10 times.</p>
<h3 id="2-2-review-the-library-environment-variables-and-compilation-conditions">2-2. Review the library environment variables and compilation conditions</h3>
<p>Recent CPUs have various speed-up functions. The execution time can be different depending on whether the acceleration function itself is enabled or if the library that can use the acceleration function is called. There is an explanation on the following page.</p>
<ul>
<li><a href="https://insilico-notebook.com/python-blas-performance/">Calculation speed depends on BLAS used in Numpy [Python]-In-slico Notebook</a></li>
</ul>
<h2 id="3-create-a-library">3. Create a library</h2>
<p>If you already have a Python library, all you have to do is install it and use it, but you don&rsquo;t always have a Python library that does what you want to do. Also, there are quite a few wasteful processes that cannot be solved by writing in Python. If you still want to speed it up, you can use one of the following methods.</p>
<ul>
<li>3-1. Implement processing in C language and call with ctypes</li>
<li>3-2. Make Python library in C language</li>
<li>3-3. Using Boost.Python (C++ library)</li>
<li>3-4. Using Cython</li>
</ul>
<h3 id="3-1-implement-processing-in-c-language-and-call-with-ctypesa-function-that-loads-a-library-from-a-windows-dll-file-or-a-linux-so-file-and-executes-the-function-in-the-library-ctypeshttpsdocspythonorgja3libraryctypeshtml-is-a-standard-library-you-can-use-it-if-you-already-have-an-implementation-that-writes-slower-faster-things-when-written-in-python-but-is-not-yet-callable-from-python">3-1. Implement processing in C language and call with ctypesA function that loads a library from a Windows dll file or a Linux so file and executes the function in the library (<a href="https://docs.python.org/ja/3/library/ctypes.html">ctypes</a>) is a standard library. You can use it if you already have an implementation that writes slower, faster things when written in Python, but is not yet callable from Python.</h3>
<h4 id="example-10-ctypes">Example 10: ctypes</h4>
<p>Python&rsquo;s <a href="https://docs.python.org/ja/3/library/math.html">math</a>librarydoesn&rsquo;thaveacbrtfunctionforcuberoot,but<a href="http://www.c-tipsref.com/reference/math.html">libm</a>. To call it, do the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">from</span> ctypes <span style="color:#f92672">import</span> cdll, c_double
In [<span style="color:#ae81ff">2</span>]: libm <span style="color:#f92672">=</span> cdll<span style="color:#f92672">.</span>LoadLibrary(<span style="color:#e6db74">&#34;libm.so.6&#34;</span>)
In [<span style="color:#ae81ff">3</span>]: libm<span style="color:#f92672">.</span>cbrt<span style="color:#f92672">.</span>restype <span style="color:#f92672">=</span> c_double
In [<span style="color:#ae81ff">4</span>]: libm<span style="color:#f92672">.</span>cbrt<span style="color:#f92672">.</span>argtypes <span style="color:#f92672">=</span> (c_double,)
In [<span style="color:#ae81ff">5</span>]: libm<span style="color:#f92672">.</span>cbrt(<span style="color:#ae81ff">8.0</span>)
Out[<span style="color:#ae81ff">5</span>]: <span style="color:#ae81ff">2.0</span>
</code></pre></div><p>I&rsquo;m not happy with this example, but I&rsquo;m sure it&rsquo;s easy to call. Turning for on Python is slow, so you can speed it up by calling a function that also executes the process of turning with for.</p>
<h3 id="3-2-make-python-library-in-c-language">3-2. Make Python library in C language</h3>
<p>By using <a href="https://docs.python.org/ja/3/extending/extending.html">C extension</a> of Python, you can create a library that can be called from Python using C or C++. Python is like a library wrapper written in C/C++ in the first place, so let&rsquo;s make the callee of the wrapper.</p>
<h4 id="example-11-implementing-an-addition-function-that-can-be-called-from-python-in-c">Example 11: Implementing an addition function that can be called from Python in C</h4>
<p>Let&rsquo;s make an addition function with C extension. First, write the following source code in C language.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c:samplemodule.c" data-lang="c:samplemodule.c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Python.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">static</span> PyObject <span style="color:#f92672">*</span> <span style="color:#a6e22e">sample_add</span>(PyObject <span style="color:#f92672">*</span>self, PyObject <span style="color:#f92672">*</span>args) {
    <span style="color:#66d9ef">int</span> x, y, z;

    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>PyArg_ParseTuple(args, <span style="color:#e6db74">&#34;ii&#34;</span>, <span style="color:#f92672">&amp;</span>x, <span style="color:#f92672">&amp;</span>y)) {
        <span style="color:#66d9ef">return</span> NULL;
    }

    z <span style="color:#f92672">=</span> x <span style="color:#f92672">+</span> y;
    <span style="color:#66d9ef">return</span> PyLong_FromLong(z);
}

<span style="color:#66d9ef">static</span> PyObject <span style="color:#f92672">*</span>SampleError;

<span style="color:#66d9ef">static</span> PyMethodDef SampleMethods[] <span style="color:#f92672">=</span> {
    {<span style="color:#e6db74">&#34;add&#34;</span>, sample_add, METH_VARARGS, <span style="color:#e6db74">&#34;Sum x and y then return the sum.&#34;</span>},
    {NULL, NULL, <span style="color:#ae81ff">0</span>, NULL}
};

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> PyModuleDef samplemodule <span style="color:#f92672">=</span> (
    PyModuleDef_HEAD_INIT, <span style="color:#e6db74">&#34;sample&#34;</span>, NULL, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, SampleMethods
};

PyMODINIT_FUNC <span style="color:#a6e22e">PyInit_sample</span>(<span style="color:#66d9ef">void</span>) {
    PyObject <span style="color:#f92672">*</span>m;

    m <span style="color:#f92672">=</span> PyModule_Create(<span style="color:#f92672">&amp;</span>samplemodule);
    <span style="color:#66d9ef">if</span> (m <span style="color:#f92672">==</span> NULL) {
        <span style="color:#66d9ef">return</span> NULL;
    }

    SampleError <span style="color:#f92672">=</span> PyErr_NewException(<span style="color:#e6db74">&#34;sample.error&#34;</span>, NULL, NULL);
    Py_XINCREF(SampleError);
    <span style="color:#66d9ef">if</span> (PyModule_AddObject(m, <span style="color:#e6db74">&#34;error&#34;</span>, SampleError) <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span>) {
        Py_XDECREF(SampleError);
        Py_CLEAR(SampleError);
        Py_DECREF(m);
        <span style="color:#66d9ef">return</span> NULL;
    }

    <span style="color:#66d9ef">return</span> m;
}
</code></pre></div><p>Specify a Python header file and compile with gcc.</p>
<pre><code class="language-console" data-lang="console">$ gcc -I`python -c'from distutils.sysconfig import *; print(get_python_inc())'` -DPIC -shared -fPIC -o sample.so samplemodule.c
</code></pre><p>Since sample.so is completed, start the Python interpreter (IPython) and load it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">import</span> sample
In [<span style="color:#ae81ff">2</span>]: sample<span style="color:#f92672">.</span>add(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>)
Out[<span style="color:#ae81ff">2</span>]: <span style="color:#ae81ff">3</span>
</code></pre></div><h3 id="3-3-using-boostpython-c-library">3-3. Using Boost.Python (C++ library)</h3>
<p>With <a href="https://www.boost.org/doc/libs/1_72_0/libs/python/doc/html/index.html">Boost.Python</a>, you can implement Python library with less code. You don&rsquo;t have to worry too much about Python version differences. Instead, it depends on the Boost library, so the Python library will not load in an environment without the Boost library. A library created using Boost.Python is as fast as a C implementation, depending on how it&rsquo;s implemented.</p>
<h4 id="example-12-implementing-an-add-function-that-can-be-called-from-python-with-boost">Example 12: Implementing an add function that can be called from Python with Boost</h4>
<p>Let&rsquo;s create an addition function with Boost.Python. First, write the following source code in C++. That&rsquo;s it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;boost/python.hpp&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">int</span> y) {
    <span style="color:#66d9ef">return</span> x <span style="color:#f92672">+</span> y;
}

BOOST_PYTHON_MODULE(sample) {
    <span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> boost<span style="color:#f92672">::</span>python;
    def(<span style="color:#e6db74">&#34;add&#34;</span>, <span style="color:#f92672">&amp;</span>add);
}
</code></pre></div><p>Compile with g++ by specifying the Python header file and Boost.Python.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ g++ -I<span style="color:#e6db74">`</span>python -c<span style="color:#e6db74">&#39;from distutils.sysconfig import *; print(get_python_inc())&#39;</span><span style="color:#e6db74">`</span> -lboost_python -DPIC -shared -fPIC -o sample.so sample.cpp
</code></pre></div><p>Since sample.so is completed, start the Python interpreter (IPython) and load it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">import</span> sample
In [<span style="color:#ae81ff">2</span>]: sample<span style="color:#f92672">.</span>add(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>)
Out[<span style="color:#ae81ff">2</span>]: <span style="color:#ae81ff">3</span>
</code></pre></div><p>The amount of code is much shorter than writing from scratch in C. It&rsquo;s nice</p>
<h3 id="3-4-using-cython">3-4. Using Cython</h3>
<p>With <a href="https://cython.org/">Cython</a>, you can write source code in a slightly modified Python language and generate a library as fast as the one written in C. The procedure is to create a pyx file in a Python-like language, generate C language source code, and compile it.</p>
<h4 id="example-13-implementing-a-fibonacci-function-in-cython">Example 13: Implementing a Fibonacci function in Cython</h4>
<p>Let&rsquo;s create a function to calculate the Fibonacci sequence with Cython. First, create a pyx file. There is a little type information, and it has almost the same syntax as Python.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cython:fib.pyx" data-lang="cython:fib.pyx"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fib</span>(int n):
    <span style="color:#66d9ef">return</span> n <span style="color:#66d9ef">if</span> n <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> fib(n<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span> fib(n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</code></pre></div><p>Use the cython command to convert the pyx file into C language source code. Then compile with gcc.</p>
<pre><code class="language-console" data-lang="console">$ cython fib.pyx
$ gcc -I`python -c'from distutils.sysconfig import *; print(get_python_inc())'` -DPIC -shared -fPIC -o fib.so fib.c
</code></pre><p>fib.so is completed, so start the Python interpreter (IPython) and load it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">from</span> fib <span style="color:#f92672">import</span> fib

In [<span style="color:#ae81ff">2</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: fib(<span style="color:#ae81ff">30</span>)
<span style="color:#ae81ff">304</span> ns <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">2.53</span> ns per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">1000000</span> loops each)
</code></pre></div><p>When I wrote everything in Python, it was &ldquo;448 ms ± 4.22 ms&rdquo;, so it was considerably improved.</p>
<h2 id="4-optimizing-bytecode">4. Optimizing bytecode</h2>
<p>Up to this point, I made a library in C language to speed up. Creating a library required knowledge of the C language and languages extended by Cython for Python, and required learning languages other than Python. However, learning a new language is difficult. Here, I will introduce the following methods that can extend existing Python programs as they are.</p>
<ul>
<li>4-1. Using Numba</li>
<li>4-2. Using PyPy</li>
</ul>
<h3 id="4-1-using-numba">4-1. Using Numba</h3>
<p><a href="http://numba.pydata.org/">Numba</a>uses<a href="https://llvm.org/">LLVM</a>togeneratebytecodesfromLLRMIRtospeedup.Asdescribedin<a href="https://qiita.com/intermezzo-fr/items/3ae7645bd7d4414d9607">WhatcanIdobeforethePythonscriptisexecuted-Qiita</a>,PythonisaVMtypescriptinglanguagewithintermediateinstructions(bytecode). The processing is realized by executing frankly.</p>
<p>According to the <a href="http://numba.pydata.org/numba-doc/latest/user/5minguide.html#how-does-numba-work">guide</a> of the main site, it not only optimizes bytecode but also machines It seems to generate instructions and replace function calls. That&rsquo;s amazing&hellip;</p>
<h4 id="example-14-numbas-jit-decorator">Example 14: Numba&rsquo;s jit decorator</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#a6e22e">@jit</span>
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fib</span>(n):
   <span style="color:#f92672">...</span>: <span style="color:#66d9ef">return</span> n <span style="color:#66d9ef">if</span> n <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> fib(n<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span> fib(n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
In [<span style="color:#ae81ff">9</span>]: <span style="color:#f92672">%%</span>timeit
   <span style="color:#f92672">...</span>: fib(<span style="color:#ae81ff">30</span>)
<span style="color:#ae81ff">12.6</span> ms <span style="color:#960050;background-color:#1e0010">±</span> <span style="color:#ae81ff">187</span> <span style="color:#960050;background-color:#1e0010">μ</span>s per loop (mean <span style="color:#960050;background-color:#1e0010">±</span> std<span style="color:#f92672">.</span>dev<span style="color:#f92672">.</span> of <span style="color:#ae81ff">7</span> runs, <span style="color:#ae81ff">100</span> loops each)
</code></pre></div><h3 id="4-2-using-pypypypyhttpspypyorgisapythonimplementationwritteninpythonrpythonhttpsrpythonreadthedocsioenlatestindexhtmlindexwhichisalittlemorerestrictedthanpythonandeasytooptimizeworksitisimplementedinrpythonhttpsrpythonreadthedocsioenlatestindexhtmlindexandiscompatiblewithpython27andpython36accordingtopythoncompatibility-pypyhttpspypyorgcompathtmldjangohttpsdjangoprojectjpandflaskhttpspalletsprojectscompflaskwell-knownlibrariessuchashavebeenconfirmedtoworkandaccordingtopypyspeedhttpsspeedpypyorg-the-execution-speed-seems-to-be-quite-excellent">4-2. Using PyPy<a href="https://pypy.org/">PyPy</a>isaPythonimplementationwritteninPython.<del><a href="https://rpython.readthedocs.io/en/latest/index.html#index">RPython</a>,whichisalittlemorerestrictedthanPythonandeasytooptimize,works.Itisimplementedin</del><a href="https://rpython.readthedocs.io/en/latest/index.html#index">RPython</a>andiscompatiblewithPython2.7andPython3.6.Accordingto<a href="https://pypy.org/compat.html">Pythoncompatibility-PyPy</a>,<a href="https://djangoproject.jp/">Django</a>and<a href="https://palletsprojects.com/p/flaskWell-knownlibrariessuchas/">Flask</a>havebeenconfirmedtowork,andaccordingto<a href="https://speed.pypy.org/">PyPySpeed</a>, the execution speed seems to be quite excellent.</h3>
<p>*Some words have been revised based on the comments.</p>
<h2 id="finally">Finally</h2>
<p>In this article, we introduced the following speed-up methods.</p>
<ol>
<li>Rewrite the script in the category of language specification/standard library
<ul>
<li>1-1. Review how to write Python script</li>
<li>1-2. Devise algorithm and data structure</li>
<li>1-3. Use the cache</li>
<li>1-4. Parallelize</li>
</ul>
</li>
<li>Use the library
<ul>
<li>2-1. Using the library</li>
<li>2-2. Review the library environment variables and compilation conditions.</li>
</ul>
</li>
<li>Make a library
<ul>
<li>3-1. Implement processing in C language and call with ctypes</li>
<li>3-2. Make Python library in C language</li>
<li>3-3. Using Boost.Python (C++ library)</li>
<li>3-4. Using Cython</li>
</ul>
</li>
<li>Optimize your bytecode
<ul>
<li>4-1. Using Numba</li>
<li>4-2. Using PyPy</li>
</ul>
</li>
</ol>
<p>It depends on time and case which method is appropriate for dealing with the processing that you feel is slow. It would be nice to be able to apply the optimal method after considering various options.</p>
<p>We have only given examples of Fibonacci sequences, but finding a Fibonacci sequence is not a common task in an application. Depending on the processing you want to speed up, Cython may be faster than Numba.
This time I&rsquo;m using the recurrence to find the Fibonacci sequence, but if we remove the recurrence in the first place, it will be even faster&hellip;</p>
<p>May your Quality of Python Life be great.</p>
<h2 id="reference">Reference</h2>
<p>In writing this article, I referred to the following article.</p>
<ul>
<li><a href="https://docs.python.org/ja/3/reference/index.html">Python language specification</a></li>
<li><a href="https://docs.python.org/ja/3/library/index.html">Python standard library</a></li>
<li><a href="https://insilico-notebook.com/python-blas-performance/">Calculation speed depends on BLAS used in Numpy [Python]-In-slico Notebook</a></li>
</ul>
<p>I have been learning a lot of nice articles and books other than the above when learning Python. I am very sorry for not being able to introduce here. Thank you for publishing and publishing the wonderful information. We believe that great information will be useful to anyone learning Python from now on.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
