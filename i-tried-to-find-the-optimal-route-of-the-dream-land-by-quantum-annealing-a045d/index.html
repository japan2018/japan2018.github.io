<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>I tried to find the optimal route of the dream land by (quantum) annealing | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>I tried to find the optimal route of the dream land by (quantum) annealing</h1>
<p>
  <small class="text-secondary">
  
  
  Nov 24, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/quantum-annealing"> quantum annealing</a></code></small>


<small><code><a href="https://memotut.com/tags/ising-model"> Ising model</a></code></small>

</p>
<pre><code>## Introduction
</code></pre>
<p>Land of dreams&hellip; Yes, that is Tokyo Disneyland, known as the Kingdom of Dreams and Magic.</p>
<p>I&rsquo;m sure you&rsquo;ve visited once, but it&rsquo;s quite crowded on holidays.
In such a case, waiting time and traveling distance are the burdens in dreamland.</p>
<p>It would be ideal if there was a course where the waiting time and travel distance would be shortened.
However, when it comes to thinking for yourself, it is necessary to accurately grasp the positions and waiting times of the enormous attractions.</p>
<p>It&rsquo;s troublesome, so it seems to break the dream, but I made a web application that optimizes the route of the dreamland.
There are various optimization methods, but I just tried quantum annealing, which I am dealing with in my university graduation thesis.</p>
<p>If you want to try it first, please click here!
<a href="https://tdr-planner.web.app/">https://tdr-planner.web.app/</a>
The optimization process takes about 30 seconds, so please wait for a while m(_ _)m
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/57cf8d71-d56d-48d9-254a-9fccc5d66e97.png" alt="ss.png"></p>
<h2 id="glossary">Glossary</h2>
<p>A lot of technical terms will appear, so I will briefly explain it in advance.</p>
<h3 id="quantum-computer">Quantum computer</h3>
<p>Quantum computers are broadly classified into the following two types.</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Features</th>
</tr>
</thead>
<tbody>
<tr>
<td>Gate method</td>
<td>General purpose and capable of realizing all kinds of quantum computation (general purpose machine)</td>
</tr>
<tr>
<td>Ising model method</td>
<td>Specializing in combinatorial optimization problems (dedicated machine)</td>
</tr>
</tbody>
</table>
<p>At first glance, the general-purpose gate method seems to be superior, but the calculations that are guaranteed to be fast are still limited.</p>
<p>This time we will consider the Disney course optimization problem as a combinatorial optimization problem and solve it using the Ising model method.</p>
<h3 id="combinatorial-optimization-problem">combinatorial optimization problem</h3>
<p>The <strong>combinatorial optimization problem</strong> that can be handled by the Ising model quantum computer is the following problem.</p>
<blockquote>
<p>Combinatorial optimization problem is to find the value (combination) of variables that maximizes a certain index (value) ** from many options under various constraints.</p>
</blockquote>
<p>Quoted from <a href="https://annealing-cloud.com/knowledge/1.html">Annealing Cloud Web</a></p>
<p>There are concrete examples in the above citation source, so I think it will be easier to understand by referring to them.</p>
<p>The problem to be dealt with this time is to find the combination with the highest degree of satisfaction from the huge combinations of the order in which the attractions are to be visited.</p>
<h3 id="ising-model">Ising model</h3>
<p>The specialization suddenly became higher, but I will explain it because it cannot be avoided.</p>
<p>The Ising model quantum computer is a dedicated machine specialized for combinatorial optimization problems, and its input is limited to a specific form. The input form is a model used in statistical mechanics called ** Ising model **.</p>
<p>When you input it in the form of Ising model into a quantum computer (Ising model method), it feels like searching for a combination of variables that minimizes the energy of the model.</p>
<p>The concrete energy formula is expressed as follows.</p>
<p>$$
H = \sum_{i \neq j}J_{ij}\sigma_{i}\sigma_{j} + \sum_{i}h_{i}\sigma_{i}\quad(\sigma = \pm 1)
$$</p>
<p>Suddenly a complicated formula came out, what? I&rsquo;m feeling. I am not confident in the theoretical explanation, so I will omit it here.
Just be aware that <strong>H$ is represented by a polynomial of maximum quadratic degree in $\sigma$</strong>.</p>
<p>When solving, input the coefficient of $\sigma$ in matrix form, and it will search for the combination of $\sigma$ that minimizes $H$.
For the time being, the first goal for solving with a quantum computer is to represent a polynomial of maximum $2 sigma$.</p>
<h3 id="qubo">QUBO</h3>
<p>QUBO is another model similar to Ising model, and energy is expressed by the following formula.</p>
<p>$$
H = \sum_{i \neq j}J_{ij}x_{i}x_{j} + \sum_{i}h_{i}x_{i}\quad(x \in 0,1)
$$</p>
<p>The only difference with the Ising model is that the variables are replaced from $\sigma$ which takes $\pm 1$ to $x$ which takes $0,1$.</p>
<p>We will use QUBO for this Disney course optimization.</p>
<h2 id="rough-flow">Rough flow</h2>
<ol>
<li>Formulate Disney&rsquo;s course optimization as a combinatorial optimization problem in QUBO</li>
<li>Try to solve with a (quantum) computer</li>
<li>Make it a web application</li>
</ol>
<h2 id="problem-formulation">Problem formulation</h2>
<p>In formulating the problem, we will consider using the following figure.</p>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/a2ff1e8c-9e77-c021-7a12-1ff12483dadf.png" width="480">
<p>The circle in the figure above corresponds to the binary variable $x_{i,j}\ (1 \leq i,j \leq 4)$ in QUBO.
&ldquo;Number of uses&rdquo; corresponds to the row, &ldquo;Which attraction to use&rdquo; corresponds to the column,
A matrix representing whether to use the $i$ attraction $j$.</p>
<p>In the case of the above figure, the course used in the order of Haunted Mansion → Pooh&rsquo;s Honey Hunt → Space Mountain → Splash Mountain.</p>
<p>Though we consider only 4 attractions, 4×4=16 combinations of $x$ are 2536 to reach 65536 combinations.
The quantum computer finds the combination of $x$ that minimizes the energy $H$ shown in <a href="#qubo">QUBO</a> from these 65536 combinations, and returns it in the matrix form as shown above. I will.</p>
<p>In other words, if an expression that minimizes $H$ in an ideal course can be expressed using $x$ (quadratic or lower), it can be optimized by a quantum computer. In general, when considering $H$, consider the objective and constraint terms as the terms that make up $H$.</p>
<table>
<thead>
<tr>
<th>Section</th>
<th>Role</th>
</tr>
</thead>
<tbody>
<tr>
<td>Objective term</td>
<td>The objective term that you want to maximize or minimize. Set so that the better the result, the smaller the value.</td>
</tr>
<tr>
<td>Constraint term</td>
<td>The minimum term when the constraint is satisfied. If the constraint is violated, the penalty is set to be larger.</td>
</tr>
</tbody>
</table>
<p>After that, we will consider $H$ based on ↑.
However, the number of attractions (rows) and the number of attractions (columns) are generalized to $n and m$ respectively.
($n=m=4$ for convenience of illustration)</p>
<h3 id="purpose">Purpose</h3>
<p>At the beginning, I mentioned that I wanted to shorten the waiting time and traveling distance, so that seems to be the purpose, but when I actually go to Disneyland, I don&rsquo;t think there is anyone who wants to wait within 3 hours!</p>
<p>In reality, I think the purpose is &ldquo;I want to ride a lot of attractions!&rdquo; However, it is necessary to consider quality as well as quantity. I don&rsquo;t like going to Minnie&rsquo;s house 10 times because the waiting time is short.
Therefore, we set 10 levels of satisfaction for each attraction, and aim to <strong>maximize total satisfaction</strong>.</p>
<p>If the satisfaction of attraction $j$ is $s_j\ \ (1 \leq j \leq n, 1 \leq s_j \leq 10)$, then the total satisfaction $S$ is</p>
<p>$$
S = \sum_{j=1}^{m}\sum_{i=1}^{n}s_{j}x_{i,j}
$$</p>
<p>It is like this when expressed in the figure.</p>
<img width="560" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/247f8a27-c323-4c22-bda3-531505ca29aa.png">
<p>This time, the purpose is to <strong>maximize total satisfaction</strong>, but since the objective term must be set so that the better the result, the smaller the value, the inverse of the sign is the objective term $H_{aim}$ Set as.</p>
<p>$$
H_{aim} = -\sum_{j=1}^{m}\sum_{i=1}^{n}s_{j}x_{i,j}
$$</p>
<h3 id="constraint-a">Constraint A</h3>
<p>Now that the goal has been decided, what happens if we just optimize it for the time being?
There is a high probability that such a solution will be obtained.</p>
<img width="480" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/d5f46758-d1cb-1ec9-240c-56d5ae42c90d.png">
<p>That&rsquo;s right. Satisfaction will be maximized if you use all of them.
However, this means that you will be using 4 attractions at the same time, and it has not been established as a course.</p>
<p>Therefore, we will set a constraint <strong>Prohibit the use of multiple attractions at the same time</strong>.
This is equivalent to having exactly one blue circle on each line. This constraint is a one-hot constraint that appears frequently in QUBO and is expressed by the following formula.</p>
<p>$$
H_{a} = \sum_{i=1}^{n}\left(1-\sum_{j=1}^{m}x_{i,j}\right)^2
$$</p>
<p>It is like this when expressed in the figure.</p>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/749d520d-2e3c-1103-0c84-305a69f9f3e8.png">
<p>In the above figure, there are two blue circles on the 2nd line, so $H_{a}=1$ due to a constraint violation.
If the constraint is satisfied, $H_{a}$ has a minimum value of 0.</p>
<h3 id="constraint-b">Constraint B</h3>
<p>What happens when you optimize with the objective and constraint terms A?
You will probably get a solution like this: (*Numbers in parentheses are satisfaction levels)</p>
<img width="480" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/95d50759-8fcd-fc47-019d-74c6d1826c14.png">
<p>Although the course is approved by the constraint term A, it is a bold course with 4 consecutive splash mountains.
It&rsquo;s only natural that we set the highest satisfaction level for Splash Mountain.
However, it&rsquo;s not a good course to ride four times, no matter how popular it is.</p>
<p>Therefore, if you use an attraction multiple times, set a constraint that satisfaction will decrease by 3 each time you use **.
For example, if you use Splash Mountain three times, the first time will be 10, the second time will be 7, the third time will be 4, and so on. If you do this, you will be able to choose Space Mountain (6) or Haunted Mansion (5) as your third satisfaction level is 4.</p>
<p>Although it is a constraint, since it is related to the calculation of total satisfaction, the target term $H_{aim}$ is modified.</p>
<p>The policy is to calculate the total satisfaction level for a certain attraction and then add up all the attractions.
The number of times $k_{a}$ has been used by an attraction $a$ is</p>
<p>$$
k_{a}=\sum_{i=1}^{n}x_{i,a}
$$Will be. Since the satisfaction level of attraction $a$ decreases by 3 each time it is used, it can be regarded as an arithmetic sequence with the first term $s_a$ tolerance -3, and the total $S_{a}$ is represented by the following formula. I will. (Sum of arithmetic sequences)</p>
<p>$$
S_{a}=\frac{1}{2}k_{a}(2s_{a}+(k_{a}-1)\times(-3))= k_{a}(s_{a}-\ frac{3}{2}k_{a} + \frac{3}{2})
$$</p>
<p>The figure below shows the case of using Splash Mountain three times.</p>
<img width="480" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/8e44a75e-1457-3c3f-9ddd-e7bb4cbf2cf0.png">
<p>The total satisfaction is the sum of all the attractions,</p>
<p>$$
S = \sum_{j=1}^{m}S_{j}
= \sum_{j=1}^{m}
\left(
\sum_{i=1}^{n}x_{i,j}
\left(
s_j-\frac{3}{2}\sum_{i=1}^{n}x_{i,j}+\frac{3}{2}
\right)
\right)
$$</p>
<p>Will be. Similar to <a href="#objective">Initial term set first</a>, set the inverse of the sign as the objective term.</p>
<p>$$
H_{aim}= -\sum_{j=1}^{m}
\left(
\sum_{i=1}^{n}x_{i,j}
\left(
s_j-\frac{3}{2}\sum_{i=1}^{n}x_{i,j}+\frac{3}{2}
\right)
\right)
$$</p>
<h3 id="constraint-c">Constraint C</h3>
<p>What happens when you optimize using the newly set objectives?
The following is obtained as an example of the optimal solution.</p>
<img width="480" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/d6534ebd-2731-f45a-6fc3-c151f84e50b9.png">
<p>The course has become quite decent, so let&rsquo;s think about the distance traveled next.
The location of each attraction and the course in the above figure are as follows.</p>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/c2d80e89-90d3-0a28-b945-a8169b48adaf.png">
<p>Since it is a schematic diagram, it differs from the actual positional relationship, but the magnitude relationship of the movement distance is expressed correctly.
If the order of Space Mountain and Haunted Mansion is reversed, the travel distance will be shorter.</p>
<p>As mentioned above, it is ideal to shorten the travel distance, but it is not realistic to specifically aim for the total travel distance to be less than 0.00m.</p>
<p>Therefore, set a constraint that <strong>total required time is within XX hours</strong>.
If you calculate travel time and waiting time and express this constraint, you will maximize total satisfaction within a limited time, so you should naturally reduce travel time and waiting time.</p>
<p>In expressing this constraint, the following three are defined.</p>
<ul>
<li>Expected time of stay (minutes): $t_{max}$</li>
<li>Cost of attraction $j$ (= waiting time + required time) (min): $c_{j}\ (1 \leq j \leq n)$</li>
<li>Travel time (minutes) between two attractions $i, j$: $d_{i,j}\ (1 \leq i,j \leq n)$</li>
</ul>
<p>Divide the total travel time into ** &ldquo;total cost of attractions used&rdquo; ** + ** &ldquo;total travel time&rdquo; **.</p>
<p>First, the total cost of attractions to use, $C$, can be expressed as follows, in the same way as the <a href="#objective">initially set objective term</a>. I just replaced satisfaction $s$ with cost $c$.</p>
<p>$$
C = \sum_{j=1}^{m}\sum_{i=1}^{n}c_{j}x_{i,j}
$$</p>
<p>Next, the total travel time $D$ is [traveling salesman problem](<a href="http://blog.brainpad.co.jp/entry/2017/04/20/160000#%E4%BE%8B3-%E5%B7%A1%E5%9B%9E%E3%82%BB%E3%83%BC%E3%83%AB%E3%82%B9%E3%83%9E%E3%83%B3%E5%95%8FThesameideaas(%E9%A1%8C)">http://blog.brainpad.co.jp/entry/2017/04/20/160000#%E4%BE%8B3-%E5%B7%A1%E5%9B%9E%E3%82%BB%E3%83%BC%E3%83%AB%E3%82%B9%E3%83%9E%E3%83%B3%E5%95%8FThesameideaas(%E9%A1%8C)</a> can be expressed as follows.
(I abandoned it because it was difficult to describe it in the diagram&hellip;If you want to understand it, please check the traveling salesman problem)</p>
<p>$$
D = \sum_{t=1}^{n-1}\sum_{i=1}^{m}\sum_{j=1}^{m}d_{i,j}x_{t,i}x_ {t+1,j}
$$</p>
<p>Set the difference between the total required time $(C+D)$ and the planned stay time $t_{max}$ as the constraint term $H_{b}$.</p>
<p>$$
H_{b}=\sum_{j=1}^{m}\sum_{i=1}^{n}c_{j}x_{i,j}+\sum_{t=1}^{m-1 }\sum_{i=1}^{n}\sum_{j=1}^{n}d_{i,j}x_{t,i}x_{t+1,j} -t_{max}
$$</p>
<p>If the total required time exceeds the planned stay time, $H_{b}$ will play a role as a constraint because the value will increase as a penalty.
However, the shorter the total travel time, the smaller $H_{b}$, so it will be easier to choose a course with a shorter total travel time. This is adjusted with the hyper parameter described later.</p>
<h3 id="constraint-d">Constraint D</h3>
<p>This is the result when optimizing by adding the constraint term $H_{b}$.</p>
<img width="480" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/6d3cd952-5ef3-517a-a1de-494bc34b5ee9.png">
<p>Considering the distance properly, I went to Haunted Mansion first.
However, I&rsquo;m worried that Splash Mountain will continue.</p>
<p>In terms of computer, if you ride continuously, the moving time between them will be 0, so if you use it multiple times, it will be continuous.
Even if it&rsquo;s okay to ride twice, if you can, you want to avoid continuous trains.</p>
<p>Therefore, set a constraint that <strong>the same attraction cannot be used continuously</strong>.
This corresponds to the fact that the blue circles are not adjacent in the column direction, and is expressed by the following formula.</p>
<p>$$
H_{c} = \sum_{j=1}^{m}\sum_{i=1}^{n-1}x_{i,j}x_{i+1,j}
$$</p>
<p>It is like this when expressed in the figure.</p>
<img width="560" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/cbd78a5c-4e1b-51f9-e3cd-6fd93b190e1b.png">
<p>In the figure above, there is a part where a blue circle is adjacent to the 1st column, so it is $H_{c}=1$ because of constraint violation.
If the constraint is satisfied, $H_{c}$ has a minimum value of 0.</p>
<h3 id="constraint-e">Constraint E</h3>
<p>I&rsquo;ve been thinking about 4 attractions so far, and suddenly the course is like Splash Mountain.
But in a real course, you have to come in and come back to the entrance.</p>
<p>Therefore, we will set a constraint <strong>Use the entrance at the beginning and end of the course</strong>.
The entrance is also considered as one attraction and will be added as a line. Satisfaction is set to 0 because it is not necessary to use it during the course.
Assuming the entrance is in the first column, this constraint is given by</p>
<pre><code class="language-math" data-lang="math">H_{d} = 2-x_{1,1}-x_{n,1}
</code></pre><p>It is like this when expressed in the figure. The constraint is satisfied if the first $(x_{1,1})$ and the last $(x_{5,1})$ in the first column are blue circles.</p>
<img width="560" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/30550a7a-c127-9276-14e9-93740c9e19e7.png">
<p>If the constraint is satisfied, $H_{d}$ has a minimum value of 0.</p>
<h3 id="formulation-summary">Formulation summary</h3>
<p>It&rsquo;s been a long time, but now I can find a fairly reasonable course.
The formulation for Disney&rsquo;s course optimization is summarized below.</p>
<h4 id="input-data">Input data</h4>
<table>
<thead>
<tr>
<th align="center">Variable</th>
<th>Content</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">$n$</td>
<td>Number of attractions used per course (how many rides you want)</td>
</tr>
<tr>
<td align="center">$m$</td>
<td>Number of attractions (Tokyo Disneyland: 34)</td>
</tr>
<tr>
<td align="center">$t_{max}$</td>
<td>Estimated stay time (minutes)</td>
</tr>
<tr>
<td align="center">$s_{j}$</td>
<td>Satisfaction with attraction $j$ $(1 \leq j \leq n, 1 \leq s_{j} \leq 10)$</td>
</tr>
<tr>
<td align="center">$c_{j}$</td>
<td>Cost of attraction $j$ (min) $(1 \leq j \leq n)$</td>
</tr>
<tr>
<td align="center">$d_{i,j}$</td>
<td>Travel time (min) between attractions $i,j$ $(1 \leq i,j \leq n)$</td>
</tr>
</tbody>
</table>
<h4 id="purpose-1">Purpose</h4>
<ul>
<li>Maximize total satisfaction</li>
</ul>
<h4 id="constraints">constraints</h4>
<ul>
<li>Do not use multiple attractions at the same time</li>
<li>If you use the attraction multiple times, the satisfaction level will decrease by 3 each time you use it</li>
<li>Total required time is less than expected stay</li>
<li>Continuous use of the same attraction is prohibited</li>
<li>Use the entrance at the beginning and end of the course</li>
</ul>
<h4 id="energy-function">Energy function</h4>
<pre><code class="language-math" data-lang="math">\begin{align}
H_{aim}&amp;=-\sum_{j=1}^{m}\left(\sum_{i=1}^{n}x_{i,j}\left(s_j-\frac{3}{2 }\sum_{i=1}^{n}x_{i,j}+\frac{3}{2}\right)\right) \\
H_{a}&amp;=\sum_{i=1}^{n}\left(1-\sum_{j=1}^{m}x_{i,j}\right)^2 \\
H_{b}&amp;=\sum_{j=1}^{m}\sum_{i=1}^{n}c_{j}x_{i,j}+\sum_{t=1}^{n- 1}\sum_{i=1}^{m}\sum_{j=1}^{m}d_{i,j}x_{t,i}x_{t+1,j} -t_{max} \ \
H_{c}&amp;=\sum_{j=1}^{m}\sum_{i=1}^{n-1}x_{i,j}x_{i+1,j} \\
H_{d}&amp;=2- x_{1,1}-x_{n,1}
\end{align}
</code></pre><p>The final energy function $H$ is
$\alpha,\beta,\gamma,\delta$ are positive hyperparameters that represent constraint weights.</p>
<pre><code class="language-math" data-lang="math">H = H_{aim} + \alpha H_{a} + \beta H_{b} + \gamma H_{c} + \delta H_{d}
</code></pre><h2 id="quantum-try-to-solve-with-a-computer">(Quantum) Try to solve with a computer</h2>
<p>Let&rsquo;s actually solve it using the formulated energy function.
This time, we will target 10 popular attractions that are selected based on dogma and prejudice.</p>
<p>First, prepare the following input data.<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/e6706c7a-cfcf-ebb1-21ef-48767725863b.png" alt="image.png">
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/41b6a5ec-fc1a-1fba-cb8c-a45df069a08c.png" alt="image.png"></p>
<p>For the waiting time, I referred to the site of <a href="https://disneyreal.asumirai.info/index.html">here</a>. Use the average daily wait time for each attraction on weekends and days with normal congestion.
(Waiting time, but is time-series data that changes from moment to moment, be carried out at any time for calculation simplicity we assume a constant waiting time.)
The time required uses the one posted on the official Disney website.
The cost is waiting time + required time, satisfaction is my preference.</p>
<p>As for the travel time between attractions, I was in trouble because I could not find the data, but a friend who liked Disney cooperated and calculated the distance between attractions.
When asked how it was calculated, he said that he set each attraction and the branch point of the passage as a node in Google Maps and calculated the shortest distance by the Dijkstra method.
Moreover, there are some passages that can only be cast through Google Maps, so it is the first time to make a map of only passages that guests can pass through based on Google Maps. It&rsquo;s scary to love science Disney&hellip;
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/7e9e130d-ddc0-7232-7d04-99bde17ee32b.png" alt="EdgesMap_Land.png">
↑ A map created by a friend to find the shortest distance between attractions on Dijkstra.
Is there anyone who can see this as Disneyland?</p>
<p>Now that the input data is ready, convert it into a format that can be input to the quantum computer.
Originally, I somehow expand $H$ and create a coefficient matrix (QUBO matrix) of the first-order term and the second-order term of $x$, but this time, I generate the QUBO matrix with highly readable code. I used the python library <a href="https://pyqubo.readthedocs.io/en/latest/">pyqubo</a>, which gives me python.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">from</span> pyqubo <span style="color:#f92672">import</span> Array, Sum, Num, Constraint, Placeholder

cost_data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;tdl_cost.csv&#39;</span>)
distance_data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;tdl_distance.csv&#39;</span>, header<span style="color:#f92672">=</span>None)

s <span style="color:#f92672">=</span> cost_data[<span style="color:#e6db74">&#39;value&#39;</span>]<span style="color:#f92672">.</span>to_numpy()
c <span style="color:#f92672">=</span> cost_data[<span style="color:#e6db74">&#39;cost&#39;</span>]<span style="color:#f92672">.</span>to_numpy()
d <span style="color:#f92672">=</span> (distance_data <span style="color:#f92672">/</span> <span style="color:#ae81ff">80</span>)<span style="color:#f92672">.</span>to_numpy() <span style="color:#75715e"># Convert walking time (min) assuming walking speed is 80m/min</span>
n <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>
m <span style="color:#f92672">=</span> len(c)
t_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">12</span>
x <span style="color:#f92672">=</span> Array<span style="color:#f92672">.</span>create(<span style="color:#e6db74">&#39;x&#39;</span>, (n, m),<span style="color:#e6db74">&#39;BINARY&#39;</span>)

<span style="color:#75715e"># Objective</span>
H_aim <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>Sum(<span style="color:#ae81ff">0</span>, m, <span style="color:#66d9ef">lambda</span> j: Sum(<span style="color:#ae81ff">0</span>, n, <span style="color:#66d9ef">lambda</span> i: x[i,j]) <span style="color:#f92672">*</span> (s[j]<span style="color:#f92672">-</span><span style="color:#ae81ff">1.5</span> <span style="color:#f92672">*</span> Sum(<span style="color:#ae81ff">0</span>, n, <span style="color:#66d9ef">lambda</span> i: x[i, j]) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1.5</span>))

<span style="color:#75715e"># Do not use multiple attractions at the same time</span>
H_a <span style="color:#f92672">=</span> Constraint(Sum(<span style="color:#ae81ff">0</span>, n, <span style="color:#66d9ef">lambda</span> i: (<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>Sum(<span style="color:#ae81ff">0</span>, m, <span style="color:#66d9ef">lambda</span> j: x[i,j])) <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span>),<span style="color:#e6db74">&#39;alpha&#39;</span>)

<span style="color:#75715e"># Total required time is less than planned stay time</span>
C <span style="color:#f92672">=</span> Sum(<span style="color:#ae81ff">0</span>, m, <span style="color:#66d9ef">lambda</span> j: Sum(<span style="color:#ae81ff">0</span>, n, <span style="color:#66d9ef">lambda</span> i: (c[j] <span style="color:#f92672">*</span> x[i,j])))
D <span style="color:#f92672">=</span> Sum(<span style="color:#ae81ff">0</span>, n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">lambda</span> t: Sum(<span style="color:#ae81ff">0</span>, m, <span style="color:#66d9ef">lambda</span> i: Sum(<span style="color:#ae81ff">0</span>, m, <span style="color:#66d9ef">lambda</span> j: (d[i,j] <span style="color:#f92672">*</span> x[t,i] <span style="color:#f92672">*</span> x[t<span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,j]))))
H_b <span style="color:#f92672">=</span> Constraint(C <span style="color:#f92672">+</span> D<span style="color:#f92672">-</span>t_max,<span style="color:#e6db74">&#39;beta&#39;</span>)

<span style="color:#75715e"># Continuous use of the same attraction is prohibited</span>
H_c <span style="color:#f92672">=</span> Constraint(Sum(<span style="color:#ae81ff">0</span>, m, <span style="color:#66d9ef">lambda</span> j: Sum(<span style="color:#ae81ff">0</span>, n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">lambda</span> i: x[i,j] <span style="color:#f92672">*</span> x[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,j])),<span style="color:#e6db74">&#39;gamma&#39;</span>)

<span style="color:#75715e"># Use the entrance at the beginning and end of the course</span>
H_d <span style="color:#f92672">=</span> Constraint(<span style="color:#ae81ff">2</span><span style="color:#f92672">-</span>x[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span>x[n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>],<span style="color:#e6db74">&#39;delta&#39;</span>)

<span style="color:#75715e"># Energy function (objectives are also weighted)</span>
H <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">*</span> H_aim <span style="color:#f92672">+</span> Placeholder(<span style="color:#e6db74">&#39;alpha&#39;</span>) <span style="color:#f92672">*</span> H_a <span style="color:#f92672">+</span> Placeholder(<span style="color:#e6db74">&#39;beta&#39;</span>) <span style="color:#f92672">*</span> H_b <span style="color:#f92672">+</span> Placeholder(<span style="color:#e6db74">&#39;gamma&#39;</span>) <span style="color:#f92672">*</span> H_c <span style="color:#f92672">+</span> Placeholder(<span style="color:#e6db74">&#39;delta&#39;</span>) <span style="color:#f92672">*</span> H_d

<span style="color:#75715e"># Constraint term weighting hyperparameter</span>
params <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#39;alpha&#39;</span>: <span style="color:#ae81ff">60</span>,
    <span style="color:#e6db74">&#39;beta&#39;</span>: <span style="color:#ae81ff">2</span>,
    <span style="color:#e6db74">&#39;gamma&#39;</span>: <span style="color:#ae81ff">60</span>,
    <span style="color:#e6db74">&#39;delta&#39;</span>: <span style="color:#ae81ff">100</span>
}

<span style="color:#75715e"># Generate QUBO matrix</span>
model <span style="color:#f92672">=</span> H<span style="color:#f92672">.</span>compile()
qubo, offset <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>to_qubo(feed_dict<span style="color:#f92672">=</span>params)
</code></pre></div><p>You can get the optimized result by throwing the qubo generated in the last line to the quantum computer.
There is a machine called <a href="https://www.dwavesys.com/">D-Wave</a> as a quantum computer that can be used generally, but D-Wave is not suitable for this problem due to the limited QUBO model that can be solved. Hmm.</p>
<p>This time, I used <a href="https://www.fujitsu.com/jp/digitalannealer/">Fujitsu Digital Annealer</a> used in university research.
Digital annealing is composed of digital circuits inspired by quantum phenomena, not exactly quantum computers.
So, he says, &ldquo;I tried to find the optimal route of the dreamland by quantum annealing&rdquo;, but I&rsquo;m sorry title scam m(_ _)m
Please recognize it as a simulation of quantum annealing m(_ _)m</p>
<p>Code using Digital Annealer cannot be posted because it uses a private library, but the result is as follows.</p>
<img width="860" alt="result.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/00ba49de-a802-3eab-5721-6fc76aba3255.png">
<p>The total required time is over 10 minutes, but it is within the acceptable range.
Tuning the hyperparameters should help.
I don&rsquo;t use only Pooh&rsquo;s Honey Hunt, but it&rsquo;s a reasonable result because it&rsquo;s the 4th highest cost but the lowest satisfaction level.</p>
<p>When you draw a course on the Disney map, it looks like this:
The arrow is a straight route, so it is not accurate, but it has become a course that goes around the park without waste.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/e97bbcb6-e5f8-6633-8213-9b6e1a82ce12.png" alt="course_map.png"></p>
<h2 id="web-application">Web application</h2>
<p>I was asked by a friend of Disney who cooperated with me to check the validity of the course, but each time I changed the input on the local PC and recalculated it, it was difficult to send the result, so I made it a web application. I tried.</p>
<p><a href="https://tdr-planner.web.app/">https://tdr-planner.web.app/</a></p>
<p>There are Disney Sea data, so you can try both Land and Sea!</p>
<h3 id="backend">backend</h3>
<p>I used <a href="https://cloud.google.com/functions/?hl=ja">Google Cloud Functions</a> because I need only one simple API that optimizes and returns the course.</p>
<p>Basically the same as the python implementation of <a href="#solvewithquantumcomputer">here</a>,satisfaction$(s)$,numberofattractionsused$(m)$,plannedstaytime$(t_{I&rsquo;vemademax})$ an input from an HTTP request.</p>
<p>Although it is the essential annealing process, I could not use the research machine for the private application to be published, so I had to think of an alternative. Thankfully, pyqubo implements SA (Simulated Annealing), so I used this on Cloud Functions.</p>
<p>You can easily simulate the generated QUBO matrix with the following code.
*Of course, this is not quantum annealing m(_ _)m</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pyqubo <span style="color:#f92672">import</span> solve_qubo

raw_solution <span style="color:#f92672">=</span> solve_qubo(qubo)
decoded_solution, broken, energy <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>decode_solution(raw_solution, vartype<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;BINARY&#39;</span>, feed_dict<span style="color:#f92672">=</span>params)
</code></pre></div><p>I shaped the result obtained in ↑ to a nice feeling and made it an API that returns the following json.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;totalScore&#34;</span>: <span style="color:#ae81ff">72.0</span>,
    <span style="color:#f92672">&#34;totalAttractionTime&#34;</span>: <span style="color:#ae81ff">699</span>,
    <span style="color:#f92672">&#34;totalTravelTime&#34;</span>: <span style="color:#ae81ff">26</span>,
    <span style="color:#f92672">&#34;totalTime&#34;</span>: <span style="color:#ae81ff">725</span>
    <span style="color:#e6db74">&#34;course&#34;</span>: [
        {
            <span style="color:#f92672">&#34;attraction&#34;</span>: <span style="color:#e6db74">&#34;entrance&#34;</span>,
            <span style="color:#f92672">&#34;attractionId&#34;</span>: <span style="color:#ae81ff">0</span>,
            <span style="color:#f92672">&#34;waitingTime&#34;</span>: <span style="color:#ae81ff">0</span>,
            <span style="color:#f92672">&#34;requiredTime&#34;</span>: <span style="color:#ae81ff">0.0</span>,
            <span style="color:#f92672">&#34;startTime&#34;</span>: <span style="color:#e6db74">&#34;09:00&#34;</span>,
            <span style="color:#f92672">&#34;endTime&#34;</span>: <span style="color:#e6db74">&#34;09:00&#34;</span>,
            <span style="color:#f92672">&#34;x&#34;</span>: <span style="color:#ae81ff">655</span>,
            <span style="color:#f92672">&#34;y&#34;</span>: <span style="color:#ae81ff">830</span>
        },
        {
            <span style="color:#f92672">&#34;attraction&#34;</span>: <span style="color:#e6db74">&#34;Monsters, Inc.&#34;</span>,
            <span style="color:#f92672">&#34;attractionId&#34;</span>: <span style="color:#ae81ff">31</span>,
            <span style="color:#f92672">&#34;waitingTime&#34;</span>: <span style="color:#ae81ff">85</span>,
            <span style="color:#f92672">&#34;requiredTime&#34;</span>: <span style="color:#ae81ff">4.0</span>,
            <span style="color:#f92672">&#34;startTime&#34;</span>: <span style="color:#e6db74">&#34;09:02&#34;</span>,
            <span style="color:#f92672">&#34;endTime&#34;</span>: <span style="color:#e6db74">&#34;10:31&#34;</span>,
            <span style="color:#f92672">&#34;x&#34;</span>: <span style="color:#ae81ff">815</span>,
            <span style="color:#f92672">&#34;y&#34;</span>: <span style="color:#ae81ff">740</span>
        },
        {<span style="color:#f92672">&#34;attraction&#34;</span>: <span style="color:#e6db74">&#34;Space Mountain&#34;</span>,
            <span style="color:#f92672">&#34;attractionId&#34;</span>: <span style="color:#ae81ff">33</span>,
            <span style="color:#f92672">&#34;waitingTime&#34;</span>: <span style="color:#ae81ff">87</span>,
            <span style="color:#f92672">&#34;requiredTime&#34;</span>: <span style="color:#ae81ff">3.0</span>,
            <span style="color:#f92672">&#34;startTime&#34;</span>: <span style="color:#e6db74">&#34;10:35&#34;</span>,
            <span style="color:#f92672">&#34;endTime&#34;</span>: <span style="color:#e6db74">&#34;12:05&#34;</span>,
            <span style="color:#f92672">&#34;x&#34;</span>: <span style="color:#ae81ff">1005</span>,
            <span style="color:#f92672">&#34;y&#34;</span>: <span style="color:#ae81ff">600</span>
        },
        <span style="color:#960050;background-color:#1e0010">...</span>
        {
            <span style="color:#f92672">&#34;attraction&#34;</span>: <span style="color:#e6db74">&#34;entrance&#34;</span>,
            <span style="color:#f92672">&#34;attractionId&#34;</span>: <span style="color:#ae81ff">0</span>,
            <span style="color:#f92672">&#34;waitingTime&#34;</span>: <span style="color:#ae81ff">0</span>,
            <span style="color:#f92672">&#34;requiredTime&#34;</span>: <span style="color:#ae81ff">0.0</span>,
            <span style="color:#f92672">&#34;startTime&#34;</span>: <span style="color:#e6db74">&#34;21:13&#34;</span>,
            <span style="color:#f92672">&#34;endTime&#34;</span>: <span style="color:#e6db74">&#34;21:13&#34;</span>,
            <span style="color:#f92672">&#34;x&#34;</span>: <span style="color:#ae81ff">655</span>,
            <span style="color:#f92672">&#34;y&#34;</span>: <span style="color:#ae81ff">830</span>
        }
    ]
}
</code></pre></div><h3 id="front-end">front end</h3>
<p>I only needed the input form for time and satisfaction and the function to display the results by hitting the API, so I made it quickly with Nuxt + Vuetify which I often see recently, and host it on firebase as SPA. (Favicon is Nuxt and I feel a little embarrassed because Vuetify feeling is fully exposed&hellip;)
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/240875/57cf8d71-d56d-48d9-254a-9fccc5d66e97.png" alt="ss.png">
Ideally I wanted to draw a route on the official Disney map.
When I contacted Tokyo Disney Resort for the time being, it was usually NG.
However, as expected, it was Disney, and he kindly responded to the annoying college student who asked me to use the official map image.</p>
<blockquote>
<p>Please refrain from posting images of Tokyo Disneyland Sea maps on individual websites.
We are sorry to hear that you will receive such an answer, even though you have contacted us, but please understand it.</p>
</blockquote>
<h2 id="in-conclusion">in conclusion</h2>
<p>Since I am doing quantum annealing in my graduation thesis, the original reason was to try to get used to it by solving various combinatorial optimization problems.
However, I settled on such a problem because I thought that a realistic and interesting problem would be better if I could solve it anyway.</p>
<p>At first, I was going to do it as lightly as a graduation thesis, but my friend helped me amazingly (the person who calculated the distance) and it was a decent result than I imagined, so I was out I thought it would be better to keep it together.</p>
<p>In actual Disney, more complicated elements are involved, so the following issues are piled up as an application.</p>
<ul>
<li>Wait time is not treated as time-series data (the same wait time is used no matter what time)</li>
<li>Don&rsquo;t consider fastpass</li>
<li>Do not consider anything other than attractions such as lunch, dinner, shows</li>
</ul>
<p>In short, it&rsquo;s still a fucking app, so I think I&rsquo;ll evolve it in my free time.</p>
<p>We are also looking for other problems to be solved by quantum annealing, so if you have an interesting idea, please write it in the comments!</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
