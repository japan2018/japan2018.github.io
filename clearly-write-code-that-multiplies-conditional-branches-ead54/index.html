<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Clearly write code that multiplies conditional branches | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Clearly write code that multiplies conditional branches</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 9, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>

</p>
<pre><code>## Introduction
</code></pre>
<p>When writing code, conditional branching sometimes occurs in a multiplying (combinative) manner.
For example,</p>
<ul>
<li>Depending on the user type such as new user or existing user, change the text of the email sent or do not send it. There are multiple types of text.</li>
<li>Processing branches depending on the external service API acquisition result. Furthermore, the correspondence changes depending on the state of the internal database.</li>
</ul>
<p>etc.</p>
<p>The theme of this article is how to make changes stronger without making the outlook worse.
The code example is shown in Python, but I think that the idea is almost the same if the implementation is object-oriented language regardless of programming language.</p>
<h2 id="example-movie-pricing">Example) Movie pricing</h2>
<p>I would like to take a look at movie pricing here as an example.
For example, the purchaser includes general adults, students, and seniors, and the price changes depending on the time of day (daytime, late show).</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">Daytime</th>
<th align="left">Late Show</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">General</td>
<td align="left">1800 yen</td>
<td align="left">1300 yen</td>
</tr>
<tr>
<td align="left">Student</td>
<td align="left">1500 Yen</td>
<td align="left">1500 Yen</td>
</tr>
<tr>
<td align="left">Senior</td>
<td align="left">1100 Yen</td>
<td align="left">1100 Yen</td>
</tr>
</tbody>
</table>
<p>Suppose there is a discount charge rule for the standard charge (1800 yen), and let&rsquo;s consider expressing the rule application with a code.</p>
<p>Discount rate rule from the standard amount</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">Weekdays</th>
<th align="left">Weekdays (late show)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">General</td>
<td align="left">+-0 yen</td>
<td align="left">-500 yen</td>
</tr>
<tr>
<td align="left">Student</td>
<td align="left">-300 Yen</td>
<td align="left">-500 Yen</td>
</tr>
<tr>
<td align="left">Senior</td>
<td align="left">-700 yen</td>
<td align="left">-700 yen</td>
</tr>
</tbody>
</table>
<h3 id="when-writing-procedurally">When writing procedurally</h3>
<p>In such a case, if you simply write in a procedural conditional branch, it will be painful as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
<span style="color:#f92672">import</span> enum


<span style="color:#75715e"># Viewer category</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ViewerType</span>(enum<span style="color:#f92672">.</span>Enum):
  ADULT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;adult&#34;</span>
  STUDENT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;student&#34;</span>
  SENIOR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;senior&#34;</span>


<span style="color:#75715e"># Return the viewing fee based on the viewer category, movie start time, and standard fee</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">charge</span>(viewer_type: ViewerType, movie_start_at: datetime base_charge: int) <span style="color:#f92672">-&gt;</span> int:
  <span style="color:#75715e"># Late show after 20:00</span>
  <span style="color:#66d9ef">if</span> movie_start_at<span style="color:#f92672">.</span>hour <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">20</span>:
    <span style="color:#66d9ef">if</span> viewer_type <span style="color:#f92672">==</span> ViewerType<span style="color:#f92672">.</span>ADULT:
      <span style="color:#66d9ef">return</span> base_charge
    <span style="color:#66d9ef">elif</span> viewer_type <span style="color:#f92672">==</span> ViewerType<span style="color:#f92672">.</span>STUDENT:
      <span style="color:#66d9ef">return</span> base_charge<span style="color:#f92672">-</span><span style="color:#ae81ff">300</span>
    <span style="color:#66d9ef">else</span>:
      <span style="color:#66d9ef">return</span> base_charge<span style="color:#f92672">-</span><span style="color:#ae81ff">700</span>

  <span style="color:#66d9ef">if</span> viewer_type <span style="color:#f92672">==</span> ViewerType<span style="color:#f92672">.</span>ADULT <span style="color:#f92672">or</span> viewer_type <span style="color:#f92672">==</span> ViewerType<span style="color:#f92672">.</span>STUDENT:
    <span style="color:#66d9ef">return</span> base_charge<span style="color:#f92672">-</span><span style="color:#ae81ff">500</span>
  <span style="color:#66d9ef">else</span>:
    <span style="color:#66d9ef">return</span> base_charge<span style="color:#f92672">-</span><span style="color:#ae81ff">700</span>
</code></pre></div><p>At first glance, the overall outlook is bad, and I don&rsquo;t think it&rsquo;s easy to tell if it is implemented without omission.
Also, when the types of purchasers such as member registrants increase or the rules for senior fees change, it is difficult to know where to add processing.</p>
<h3 id="treat-conditional-branches-as-context">Treat conditional branches as context</h3>
<p>In such a case, you can get a better view by catching the event that affects the processing you want to do (the data that is the source of the conditional branch) as the <strong>context</strong>.</p>
<p>In this case, the <strong>show start time</strong>, which is the basis of whether it is a late show or not, is expressed by a code as the context** for determining the final price.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
<span style="color:#f92672">import</span> dataclasses

<span style="color:#a6e22e">@dataclasses.dataclass</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MovieStartAtContext</span>:
  movie_start_at: datetime

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_late_show</span>(self) <span style="color:#f92672">-&gt;</span> bool:
    <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>movie_start_at<span style="color:#f92672">.</span>hour <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">20</span>
</code></pre></div><p>For the time being, I was able to express the context of whether the show start time is a late show **, but if this is expanded to the procedural code above, it is meaningless.</p>
<p>The key is to allow this <strong>judgmental code execution</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
<span style="color:#f92672">import</span> dataclasses

<span style="color:#a6e22e">@dataclasses.dataclass</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MovieStartAtContext</span>:
  movie_start_at: datetime

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_late_show</span>(self) <span style="color:#f92672">-&gt;</span> bool:
    <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>movie_start_at<span style="color:#f92672">.</span>hour <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">20</span>

  <span style="color:#75715e"># Charge calculation by viewer</span>
  <span style="color:#75715e">#</span>
  <span style="color:#75715e"># The method called by the viewer changes depending on whether it is a late show or not.</span>
  <span style="color:#75715e">#</span>
  <span style="color:#75715e">#-For late shows: late_show_charge()</span>
  <span style="color:#75715e">#-During daytime: normal_charge()</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">charge_for</span>(self, viewer: Viewer, base_charge: int) <span style="color:#f92672">-&gt;</span> int:
    <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>is_late_show():
      <span style="color:#66d9ef">return</span> viewer<span style="color:#f92672">.</span>late_show_charge(base_charge)

    <span style="color:#66d9ef">return</span> viewer<span style="color:#f92672">.</span>normal_charge(base_charge)
</code></pre></div><p>By doing so, it suffices to define a calculation method for each of the late show and the normal charge for each viewer type (it is the responsibility of the show time context side to call the appropriate method).</p>
<h3 id="implementation-of-charge-calculation-logic-for-each-viewer">Implementation of charge calculation logic for each viewer</h3>
<p>The implementation of charge calculation for each viewer is as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Viewer</span>:
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">normal_charge</span>(self, base_charge: int) <span style="color:#f92672">-&gt;</span> int:
    <span style="color:#66d9ef">pass</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">late_show_charge</span>(self, base_charge: int) <span style="color:#f92672">-&gt;</span> int:
    <span style="color:#66d9ef">pass</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AdultViewer</span>(Viewer):
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">normal_charge</span>(self, base_charge: int) <span style="color:#f92672">-&gt;</span> int:
    <span style="color:#66d9ef">return</span> base_charge

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">late_show_charge</span>(self, base_charge: int) <span style="color:#f92672">-&gt;</span> int:
    <span style="color:#66d9ef">return</span> base_charge<span style="color:#f92672">-</span><span style="color:#ae81ff">500</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StudentViewer</span>(Viewer):
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">normal_charge</span>(self, base_charge: int) <span style="color:#f92672">-&gt;</span> int:
    <span style="color:#66d9ef">return</span> base_charge<span style="color:#f92672">-</span><span style="color:#ae81ff">300</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">late_show_charge</span>(self, base_charge: int) <span style="color:#f92672">-&gt;</span> int:
    <span style="color:#66d9ef">return</span> base_charge<span style="color:#f92672">-</span><span style="color:#ae81ff">500</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SeniorViewer</span>(Viewer):
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">normal_charge</span>(self, base_charge: int) <span style="color:#f92672">-&gt;</span> int:
    <span style="color:#66d9ef">return</span> base_charge<span style="color:#f92672">-</span><span style="color:#ae81ff">700</span>

  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">late_show_charge</span>(self, base_charge: int) <span style="color:#f92672">-&gt;</span> int:
    <span style="color:#66d9ef">return</span> base_charge<span style="color:#f92672">-</span><span style="color:#ae81ff">700</span>
</code></pre></div><p>You can see that the table of discount charge rules is expressed almost as it is in the code.</p>
<p>Discount rate rule from the standard amount</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">Weekdays</th>
<th align="left">Weekdays (late show)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">General</td>
<td align="left">+-0 yen</td>
<td align="left">-500 yen</td>
</tr>
<tr>
<td align="left">Student</td>
<td align="left">-300 Yen</td>
<td align="left">-500 Yen</td>
</tr>
<tr>
<td align="left">Senior</td>
<td align="left">-700 yen</td>
<td align="left">-700 yen</td>
</tr>
</tbody>
</table>
<h3 id="code-integration">Code integration</h3>
<p>Finally, integrating the code defined so far, the original <code>charge()</code> function looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ViewerFactory</span>:
  viewer_mapping <span style="color:#f92672">=</span> {
    ViewerType<span style="color:#f92672">.</span>ADULT: AdultViewer(),
    ViewerType<span style="color:#f92672">.</span>STUDENT: StudentViewer(),
    ViewerType<span style="color:#f92672">.</span>SENIOR: SeniorViewer()
  }

  <span style="color:#a6e22e">@classmethod</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create</span>(cls, viewer_type: ViewerType) <span style="color:#f92672">-&gt;</span> Viewer:
    <span style="color:#66d9ef">return</span> cls<span style="color:#f92672">.</span>viewer_mapping[viewer_type]


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">charge</span>(viewer_type: ViewerType, movie_start_at: datetime, base_charge: int) <span style="color:#f92672">-&gt;</span> int:
  context <span style="color:#f92672">=</span> MovieStartAtContext(movie_start_at)

  viewer <span style="color:#f92672">=</span> ViewerFactory<span style="color:#f92672">.</span>create(viewer_type)

  <span style="color:#66d9ef">return</span> context<span style="color:#f92672">.</span>charge_for(viewer, base_charge)
</code></pre></div><p>By doing this, if the number of registered members mentioned in the example increases, it is only necessary to define a new viewer class, and even if new charge categories such as holiday charges increase, I think that you can implement it without getting lost in the implementation location.</p>
<h2 id="summary">Summary</h2>
<p>When a conditional branch occurs in multiplication (combination)</p>
<ul>
<li>Try to grasp the event (data) that causes the branch as context</li>
<li>Express that context as an object and aggregate the conditional decisions there</li>
<li>Furthermore, make it possible to execute processing based on aggregated condition judgment</li>
</ul>
<p>Hopefully, you can make your code cleaner and easier to extend.
I hope it will be useful for implementation.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
