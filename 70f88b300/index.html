<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] Introduction of data driven controller design method | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] Introduction of data driven controller design method</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 10, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/matlab"> matlab</a></code></small>


<small><code><a href="https://memotut.com/tags/control-engineering"> control engineering</a></code></small>


<small><code><a href="https://memotut.com/tags/pythoncontrol"> PythonControl</a></code></small>


<small><code><a href="https://memotut.com/tags/vrft"> VRFT</a></code></small>

</p>
<pre><code>#Introduction
</code></pre>
<p>Feedback control has been used to “control” everything from home appliances to industrial equipment.
A device that performs this control is called a controller, and various design methods have been considered.
This time, I would like to introduce a relatively new approach called &ldquo;data-driven controller design method&rdquo;.</p>
<p>I will leave the theoretical part to the paper and write it focusing on the use.
So, I&rsquo;d like to explain it while mixing the code of MATLAB and Python.</p>
<h1 id="up-to-data-driven-control">Up to data-driven control</h1>
<p>There are roughly three approaches to designing a controller:</p>
<ol>
<li>Manual parameter adjustment (eg limit sensitivity method)</li>
<li>Model-based controller design (optimal regulator, etc.)</li>
<li>Other than that ($H_{\infty}$ control, data-driven control, etc.)</li>
</ol>
<p>Since 1 is manual, you have to make trial and error and it is easy to imagine that the design is difficult.
Therefore, a method has been proposed in which the mathematical model of the controlled object * is precisely obtained* and is designed using the model, as in 2.
The task of exactly obtaining this model is called &ldquo;identification&rdquo;.
By describing the optimization problem using the identified model, we are now able to obtain a theoretically optimal controller.
However, it is a musician who exactly asks for this model, and it takes time and effort to match theory and experiment.
Therefore, other methods based on the assumption that the model cannot be exactly obtained were examined.
Data-driven control is one of them.</p>
<h1 id="what-is-data-driven-control">What is data-driven control?</h1>
<p>According to Professor Kaneko&rsquo;s website at the University of Electro-Communications, what is data-driven control?</p>
<blockquote>
<p>A method of directly designing a controller from the data and behavior of the controlled device when it is driven</p>
</blockquote>
<p>is.
In other words, the controller can be designed without the need to create a model, simply by using the signal data during driving.</p>
<p>The following two methods are currently popular as data-driven controller design methods <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">VRFT<br>(Virtual Reference Feedback Tuning)</th>
<th align="center">FRIT<br>(Fictious Reference Iterative Tuning)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">Proposed by</td>
<td align="center">M.C. Campi, S. Savaresi</td>
<td align="center">Osamu Kaneko</td>
</tr>
<tr>
<td align="center">Publication year</td>
<td align="center"><a href="http://marco-campi.unibs.it/VRFTwebsite/downloads/Virtual_Refrence_Feedback_Tuning_a%20_direct_method_for_the_design_of_feedback_controllers.pdf">2002</a>(Automatica)</td>
<td align="center"><a href="https://www.jstage.jst.go.jp/article/iscie1988/17/12/17_12_528/_article/-char/ja/">2004</a>(ISCIE)</td>
</tr>
<tr>
<td align="center">Data of interest</td>
<td align="center">Control input $u(t)$</td>
<td align="center">Control output $y(t)$</td>
</tr>
<tr>
<td align="center">Optimization problem</td>
<td align="center">Linear (solvable by least squares)</td>
<td align="center">Non-linear (requires non-linear solver)</td>
</tr>
<tr>
<td align="center">Library provided</td>
<td align="center"><a href="http://marco-campi.unibs.it/VRFTwebsite/download_toolbox.html">MATLAB toolbox available</a></td>
<td align="center"><a href="http://e-frit.chase-dream.com/matlab.html">MATLABtoolboxavailable</a></td>
</tr>
</tbody>
</table>
<p>This time, I wrote a code about VRFT to solve the optimization problem easily.</p>
<p>#Sample code execution environment</p>
<ul>
<li>MATLAB 2017b
<ul>
<li><a href="https://jp.mathworks.com/help/control/index.html">Control System Toolbox</a></li>
<li><a href="https://jp.mathworks.com/help/ident/index.html">System Identification Toolbox</a></li>
</ul>
</li>
<li>Python 3.7.5 (<a href="https://www.anaconda.com/">Anaconda</a>environment)
<ul>
<li><a href="https://matplotlib.org/">matplotlib</a></li>
<li><a href="https://numpy.org/">numpy</a></li>
<li><a href="https://www.scipy.org/">scipy</a></li>
<li><a href="https://python-control.readthedocs.io/en/0.8.1/index.html">python-control</a></li>
</ul>
</li>
</ul>
<p>In the Python code in the explanation, import statements are omitted.
See <a href="#OverallCode">Overall Code</a> for working code.</p>
<h1 id="vrft-procedure">VRFT procedure</h1>
<p>There are only three things designers need to do to use VRFT.</p>
<ol>
<li>Determination of design specifications</li>
<li>Acquisition of input/output data</li>
<li>Solve the optimization problem according to the algorithm</li>
</ol>
<p>This time, I will explain the controller design of a speed control system using a motor as an example.</p>
<h2 id="determining-design-specifications">Determining design specifications</h2>
<p>First, let&rsquo;s decide the design specifications.
The following three can be determined as design specifications.</p>
<table>
<thead>
<tr>
<th align="center">Specifications</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">Reference model $M(z)$</td>
<td align="center">Closed-loop response transfer function to be realized</td>
</tr>
<tr>
<td align="center">Frequency weight $W(z)$</td>
<td align="center">Transfer function whose gain decreases at frequencies you do not want to evaluate</td>
</tr>
<tr>
<td align="center">Structure of the controller $\boldsymbol{\beta}(z)$</td>
<td align="center">Determining the order of the controller, etc.</td>
</tr>
</tbody>
</table>
<p>For example, if you want to realize the response of time constant $\tau = 0.02$ [s] by PID controller,</p>
<pre><code class="language-math" data-lang="math">\begin{align}
M(s) &amp;= \frac{1}{0.02 s + 1} \\&amp;= \frac{50}{s + 50}\\
\boldsymbol{\beta}(s) &amp;= \begin{bmatrix}1&amp; \frac{1}{s}&amp; s\end{bmatrix}^\mathrm{T}
\end{align}
</code></pre><p>Set like.
In addition, it is often sufficient to set a low-pass filter for the frequency weight, considering that noise may be mixed in the data in the high range.</p>
<p>The above code is as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-matlab:vrft.m" data-lang="matlab:vrft.m"><span style="color:#75715e">% Sampling time and operator</span>
Ts = <span style="color:#ae81ff">0.001</span>;
s = tf(<span style="color:#e6db74">&#39;s&#39;</span>);<span style="color:#75715e">% Laplace operator s</span>
z = tf(<span style="color:#e6db74">&#39;z&#39;</span>, Ts); <span style="color:#75715e">%time advance operator z</span>

<span style="color:#75715e">% Reference model M</span>
tau = <span style="color:#ae81ff">0.02</span>;
M = c2d(<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>(tau<span style="color:#f92672">*</span>s <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>), Ts);<span style="color:#75715e">% First-order lag system discretized with zero-order hold</span>

<span style="color:#75715e">% Weight function</span>
gW = <span style="color:#ae81ff">100</span>;
W = c2d(gW<span style="color:#f92672">/</span>(s <span style="color:#f92672">+</span> gW), Ts); <span style="color:#75715e">%First-order lag system discretized by zero-order hold</span>

<span style="color:#75715e">% Controller structure beta</span>
beta = minreal([<span style="color:#ae81ff">1</span>; Ts<span style="color:#f92672">/</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>z^<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>); (<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>z^<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span>Ts]); <span style="color:#75715e">%PID controller</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:vrft.py" data-lang="python:vrft.py"><span style="color:#75715e"># === Determination of design specifications ===</span>
<span style="color:#75715e"># Sampling time</span>
Ts <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.001</span>

<span style="color:#75715e"># Reference model M</span>
tau <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.02</span>
M <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>c2d(ctl<span style="color:#f92672">.</span>tf([<span style="color:#ae81ff">1</span>], [tau, <span style="color:#ae81ff">1</span>]), Ts) <span style="color:#75715e"># first-order lag system discretized with zero-order hold</span>

<span style="color:#75715e"># Weight function W</span>
gW <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
W <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>c2d(ctl<span style="color:#f92672">.</span>tf([gW], [<span style="color:#ae81ff">1</span>, gW]), Ts) <span style="color:#75715e"># first-order lag system discretized by zero-order hold</span>

<span style="color:#75715e"># Controller structure beta</span>
A, B, C, D <span style="color:#f92672">=</span> abcd_normalize(
    [[<span style="color:#ae81ff">1.</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>]],
    [[<span style="color:#ae81ff">1.</span>], [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.</span>]],
    [[<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], [Ts, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>Ts]],
    [[<span style="color:#ae81ff">1.</span>], [<span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>Ts]])
beta <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>ss(A, B, C, D, Ts)
<span style="color:#66d9ef">del</span> A, B, C, D
</code></pre></div><h2 id="acquisition-of-inputoutput-data">Acquisition of input/output data</h2>
<p>Next, I/O data ${u_0(t), y_0(t)}$ is acquired from the control target.
In the case of VRFT, acquire data so that the following conditions are met.</p>
<ul>
<li>Be sure to get the open-loop ($P(s)$ without a controller only) response</li>
<li>If possible, use white input signal $u_0(t)$</li>
</ul>
<p>As the white signal, it is recommended to use the M-sequence signal that is often used in system identification.
In the case of MATLAB, M-sequence signals can be easily generated using <a href="https://jp.mathworks.com/help/ident/ref/idinput.html">idinput function</a> of System Identification Toolbox.
In the case of Python, it can be generated by Scipy&rsquo;s <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.max_len_seq.html?highlight=correlation">max_len_seq function</a>.
However, it seems that a signal with a different sequence from MATLAB is generated, so I made and used the function prbs() in this Python version.</p>
<p>Here, a model of the controlled object (motor in this case) is required to perform the simulation <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.
So, I originally thought that it would be necessary to explain the model of the motor, but <a href="https://qiita.com/Manao">Manao</a>&rsquo;s<a href="https://qiita.com/Manao/Ifounditems/ed383a30bbe0c7b9534a">Greatarticle</a>.
Therefore, the modeling is omitted here and the motor can be represented by the primary system.</p>
<p>Therefore, in simulation, data can be acquired with the following code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-matlab:vrft.m" data-lang="matlab:vrft.m"><span style="color:#75715e">% Input signal used for data acquisition u (m-sequence signal)</span>
n = <span style="color:#ae81ff">15</span>;<span style="color:#75715e">% number of steps</span>
T = <span style="color:#ae81ff">2</span>^n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">%Number of data per cycle</span>
p = <span style="color:#ae81ff">15</span>; <span style="color:#75715e">%number of data cycles</span>
N = T<span style="color:#f92672">*</span>p;<span style="color:#75715e">% number of data</span>
u0 = idinput([T <span style="color:#ae81ff">1</span> p],<span style="color:#e6db74">&#39;prbs&#39;</span>,[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>],[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>]);<span style="color:#75715e">% signal vector</span>

<span style="color:#75715e">% Power spectral density of input signal phi_u</span>
phi_u = <span style="color:#ae81ff">1</span>; <span style="color:#75715e">%The input signal is assumed to be white</span>

<span style="color:#75715e">% Controlled model P</span>
Tp = <span style="color:#ae81ff">0.74</span>;
Kp = <span style="color:#ae81ff">1.02</span>;
P = c2d(Kp<span style="color:#f92672">/</span>(Tp<span style="color:#f92672">*</span>s <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>), Ts);

<span style="color:#75715e">% Output signal y0</span>
y0 = lsim(P, u0);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:vrft.py" data-lang="python:vrft.py"><span style="color:#75715e"># === Acquisition of input/output data ===</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">prbs</span>(n, p):<span style="color:#75715e"># matlab compatible PRBS signal generator</span>

    taps <span style="color:#f92672">=</span> {<span style="color:#ae81ff">3</span>: [<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">4</span>: [<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">5</span>: [<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">6</span>: [<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">7</span>: [<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],
            <span style="color:#ae81ff">8</span>: [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">6</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">9</span>: [<span style="color:#ae81ff">3</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">10</span>: [<span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">11</span>: [<span style="color:#ae81ff">8</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],
            <span style="color:#ae81ff">12</span>: [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">10</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">13</span>: [<span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">11</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">14</span>: [<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">12</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],
            <span style="color:#ae81ff">15</span>: [<span style="color:#ae81ff">13</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">16</span>: [<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">14</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">17</span>: [<span style="color:#ae81ff">13</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">18</span>: [<span style="color:#ae81ff">10</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]}
    N <span style="color:#f92672">=</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span>p
    x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>ones(n, dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>int8)
    u <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros(N, dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>int8)
    tap <span style="color:#f92672">=</span> taps[n]
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(N):
        u[i] <span style="color:#f92672">=</span> x[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
        x0 <span style="color:#f92672">=</span> x[tap[<span style="color:#ae81ff">0</span>]] <span style="color:#f92672">^</span> x[tap[<span style="color:#ae81ff">1</span>]]
        x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>roll(x, <span style="color:#ae81ff">1</span>)
        x[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> x0
    <span style="color:#66d9ef">return</span> u


<span style="color:#75715e"># Input signal u (m series signal) used for data acquisition</span>
n <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
T <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
p <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
N <span style="color:#f92672">=</span> T<span style="color:#f92672">*</span>p
<span style="color:#75715e"># u0, _ = max_len_seq(n, length=N) # Signals of different series from MATLAB</span>
u0 <span style="color:#f92672">=</span> prbs(n, p)
u0 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>(<span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>u0<span style="color:#f92672">-</span><span style="color:#ae81ff">1.</span>)

<span style="color:#75715e"># Input signal power spectral density phi_u</span>
phi_u <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.</span>

<span style="color:#75715e"># Controlled model P</span>
Tp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.74</span>
Kp <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.02</span>
P <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>c2d(ctl<span style="color:#f92672">.</span>tf([Kp], [Tp, <span style="color:#ae81ff">1</span>]), Ts)

<span style="color:#75715e"># Output signal y0</span>
y0, t0, _ <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>lsim(P, u0)
</code></pre></div><h2 id="solve-the-optimization-calculation-according-to-the-algorithm">Solve the optimization calculation according to the algorithm</h2>
<p>Finally, generate a signal according to the VRFT algorithm and solve the optimization calculation.</p>
<p>This is a minimization problem of the evaluation function $J_\mathrm{MR}(\boldsymbol{\rho})$, because VRFT aims to have a response as close as possible to the reference model $M(z)$.</p>
<pre><code class="language-math" data-lang="math">\begin{align}
J_\mathrm{MR}(\boldsymbol{\rho}) &amp;= \left\| \left( \frac{P(z) C(z, \boldsymbol{\rho})}{1 + P(z) C (z, \boldsymbol{\rho})}-M(z) \right) W(z) \right\|_2 ^2
\end{align}
</code></pre><p>Where $\boldsymbol{\rho}$ represents the controller parameter and $C(z, \boldsymbol{\rho}) = \boldsymbol{\rho}^{\rm T} \boldsymbol{\beta }(z)$.
However, this expression uses the model under control $P(z)$, so it is necessary to rewrite it with input/output data.
Although the theoretical explanation is cut off, the problem of minimizing the evaluation function $J_\mathrm{MR}$ is the asymptotic problem of minimizing $J_\mathrm{VR}^N$ below. Is equivalent to.</p>
<pre><code class="language-math" data-lang="math">\begin{align}
J_{\rm VR}^{N}(\boldsymbol{\rho}) &amp;= \frac{1}{N} \sum_{t=1}^{N}(u_L(k)-\boldsymbol{\rho }^{\rm T} \boldsymbol{\varphi}(t))^2
\end{align}
</code></pre><p>Here, the time series data $u_L(t)$ and $\boldsymbol{\rho}$ can be generated by the following formula using the filter $L(z)$.</p>
<pre><code class="language-math" data-lang="math">\begin{align}
u_L(t) &amp;= L(z) u_0(t)\\
y_L(t) &amp;= L(z) y_0(t)\\
%\boldsymbol{\varphi}(k) &amp;= \boldsymbol{\beta}(z) (\tilde{r}_L(t)-y_L(t))
e_L(t) &amp;= (M^{-1}-1)y_L(t)\\
\boldsymbol{\varphi}(k) &amp;= \boldsymbol{\beta}(z) e_L(t)
\end{align}
</code></pre><p>However, the filter $L(z)$ shall satisfy the following.</p>
<pre><code class="language-math" data-lang="math">\begin{align}
|L(z)|^2 &amp;= \frac{|1-M(z)|^2 |M(z)|^2 |W(z)|^2}{\phi_u(\omega)} &amp;\ forall \omega
\end{align}
</code></pre><p>Then, $J_\mathrm{VR}^N(\boldsymbol{\rho})$ does not use the model $P(z)$ to be controlled, and the input/output data ${u_0(t), y_0(t )}$ can be used alone.
Also, since this equation is linear with respect to the controller parameter $\boldsymbol{\rho}$, it can be solved by the method of least squares.</p>
<p>From the above, the code that solves the optimization problem is as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-matlab:vrft.m" data-lang="matlab:vrft.m"><span style="color:#75715e">% Prefilter L</span>
L = minreal(M<span style="color:#f92672">*</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>M)<span style="color:#f92672">/</span>phi_u);

<span style="color:#75715e">% Filtered input signal ul</span>
ul = lsim(L, u0);

<span style="color:#75715e">% Pseudo error signal el</span>
el = lsim(L<span style="color:#f92672">*</span>(M^(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), y0);

Controller output before <span style="color:#75715e">%parameter phi</span>
phi = lsim(beta, el);

<span style="color:#75715e">% Optimal parameter rho</span>
rho = phi<span style="color:#f92672">\</span>ul;<span style="color:#75715e">% Solve least squares method in matrix form (mldivide)</span>

<span style="color:#75715e">% Designed controller C</span>
C = minreal(rho.<span style="color:#f92672">&#39;</span> <span style="color:#f92672">*</span> beta);<span style="color:#75715e">% find controller</span>

<span style="color:#75715e">% Evaluation function Jmr</span>
Jmr = mean(ul<span style="color:#f92672">-</span>phi <span style="color:#f92672">*</span> rho);<span style="color:#75715e">% Confirm the evaluation function in matrix form</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:vrft.py" data-lang="python:vrft.py"><span style="color:#75715e"># === Design by VRFT ===</span>
<span style="color:#75715e"># Prefilter L</span>
L <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>minreal(M<span style="color:#f92672">*</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>M)<span style="color:#f92672">/</span>phi_u)

<span style="color:#75715e"># Filtered input signal ul</span>
ul, _, _ <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>lsim(L, u0)

<span style="color:#75715e"># Pseudo error signal el</span>
el, _, _ <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>lsim(ctl<span style="color:#f92672">.</span>minreal(L<span style="color:#f92672">*</span>(M<span style="color:#f92672">**-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)), y0<span style="color:#f92672">.</span>flatten())

Controller output before <span style="color:#75715e">#parameter</span>
phi, _, _ <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>lsim(beta, el<span style="color:#f92672">.</span>flatten())

<span style="color:#75715e"># Optimal parameter rho</span>
solution <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linalg<span style="color:#f92672">.</span>lstsq(phi, ul, rcond<span style="color:#f92672">=</span>None)
rho <span style="color:#f92672">=</span> solution[<span style="color:#ae81ff">0</span>]

<span style="color:#75715e"># Designed controller C</span>
C <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>ss([<span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">0</span>], rho<span style="color:#f92672">.</span>T, Ts) <span style="color:#f92672">*</span> find beta <span style="color:#75715e"># controller</span>

<span style="color:#75715e"># Evaluation function Jmr</span>
Jmr <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(ul<span style="color:#f92672">-</span>np<span style="color:#f92672">.</span>dot(phi, rho)) <span style="color:#75715e"># Check the evaluation function in matrix form</span>
</code></pre></div><h1 id="performance-check">Performance check</h1>
<p>According to the above procedure, it seems that the controller could be designed using only the input/output data without using the model to be controlled.
The obtained optimal controller parameter $\rho$ is as follows.
You can see that the results are almost the same in MATLAB and Python.</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">MATLAB</th>
<th align="center">Python</th>
<th align="center">Theoretical value <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">Proportional gain $K_p$</td>
<td align="center">$35.4$</td>
<td align="center">$35.4$</td>
<td align="center">$36.3$</td>
</tr>
<tr>
<td align="center">Integral gain $K_i$</td>
<td align="center">$47.8$</td>
<td align="center">$47.8$</td>
<td align="center">$49.0$</td>
</tr>
<tr>
<td align="center">Differential Gain $K_d$</td>
<td align="center">$0.00$</td>
<td align="center">$-9.59 \times 10^{-16}$</td>
<td align="center">$0.00$</td>
</tr>
</tbody>
</table>
<p>Then, let&rsquo;s confirm whether the response of the reference model is really realized with this controller.
The code to check is as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-matlab:vrft.m" data-lang="matlab:vrft.m"><span style="color:#75715e">% Entire system with controller G</span>
G = minreal(feedback(P<span style="color:#f92672">*</span>C, <span style="color:#ae81ff">1</span>));

<span style="color:#75715e">% Step response</span>
fig1 = figure(<span style="color:#e6db74">&#39;name&#39;</span>,<span style="color:#e6db74">&#39;Step plot&#39;</span>);
stepplot(G, M);
legend({<span style="color:#e6db74">&#39;$$\frac{CP}{1+CP}$$&#39;</span>,<span style="color:#e6db74">&#39;$M$&#39;</span>},<span style="color:#75715e">...</span>
    <span style="color:#e6db74">&#39;Interpreter&#39;</span>,<span style="color:#e6db74">&#39;latex&#39;</span>,<span style="color:#e6db74">&#39;FontSize&#39;</span>, <span style="color:#ae81ff">14</span>,<span style="color:#e6db74">&#39;Location&#39;</span>,<span style="color:#e6db74">&#39;southeast&#39;</span>);

<span style="color:#75715e">%Board diagram display</span>
fig2 = figure(<span style="color:#e6db74">&#39;name&#39;</span>,<span style="color:#e6db74">&#39;Bode plot of controller&#39;</span>);
bodeplot(G, M, {<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">100</span>});
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:vrft.py" data-lang="python:vrft.py"><span style="color:#75715e"># === Confirmation of performance ===</span>
<span style="color:#75715e"># Whole system with controller G</span>
G <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>minreal(ctl<span style="color:#f92672">.</span>feedback(P<span style="color:#f92672">*</span>C, <span style="color:#ae81ff">1</span>))

<span style="color:#75715e">#Step response</span>
plt<span style="color:#f92672">.</span>figure()
plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#34;Step response of closed loop system&#34;</span>)
timeRange <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.12</span> <span style="color:#f92672">+</span> Ts, Ts)
ym, _ <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>step(M, timeRange)
yg, _ <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>step(G, timeRange)
plt<span style="color:#f92672">.</span>plot(timeRange, ym, timeRange, yg)
plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#34;Time [s]&#34;</span>, usetex<span style="color:#f92672">=</span>True)
plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#34;Velocity [V]&#34;</span>)
plt<span style="color:#f92672">.</span>legend([<span style="color:#e6db74">&#39;Reference model&#39;</span>,<span style="color:#e6db74">&#39;Closed loop system&#39;</span>], loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;lower right&#39;</span>)

<span style="color:#75715e">#Bode diagram display</span>
plt<span style="color:#f92672">.</span>figure()
plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#34;Bode plot of closed loop system&#34;</span>)
ctl<span style="color:#f92672">.</span>bode(M, G)
plt<span style="color:#f92672">.</span>legend([<span style="color:#e6db74">&#39;Reference model&#39;</span>,<span style="color:#e6db74">&#39;Closed loop system&#39;</span>], loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;lower left&#39;</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p>Here, only the step response image is posted.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/248335/a132553f-3c6a-223b-208a-8dec4bf85f11.png" alt="step.png">
It can be seen that the response of the reference model can be reproduced with inaccurate accuracy.</p>
<h1 id="whole-code">Whole code</h1>
<p>Finally, here&rsquo;s the whole code I&rsquo;ve introduced:</p>
<details><summary> Code using MATLAB `vrft.m`</summary><div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-matlab:vrft.m" data-lang="matlab:vrft.m"><span style="color:#75715e">% VRFT design script</span>
<span style="color:#75715e">% Design for the motor speed control system.% Copyright (c) 2019 larking95(https://qiita.com/larking95)</span>
<span style="color:#75715e">% Released under the MIT License</span>
<span style="color:#75715e">% https://opensource.org/licenses/mit-license.php</span>

<span style="color:#75715e">%% Initialization</span>
clearvars;
close all;

<span style="color:#75715e">%% Determination of design specifications</span>
<span style="color:#75715e">% Sampling time and operator</span>
Ts = <span style="color:#ae81ff">0.001</span>;
s = tf(<span style="color:#e6db74">&#39;s&#39;</span>);<span style="color:#75715e">% Laplace operator s</span>
z = tf(<span style="color:#e6db74">&#39;z&#39;</span>, Ts); <span style="color:#75715e">%time advance operator z</span>

<span style="color:#75715e">% Reference model M</span>
tau = <span style="color:#ae81ff">0.02</span>;
M = c2d(<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>(tau<span style="color:#f92672">*</span>s <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>), Ts);<span style="color:#75715e">% First-order lag system discretized with zero-order hold</span>

<span style="color:#75715e">% Weight function</span>
gW = <span style="color:#ae81ff">100</span>;
W = c2d(gW<span style="color:#f92672">/</span>(s <span style="color:#f92672">+</span> gW), Ts); <span style="color:#75715e">%First-order lag system discretized by zero-order hold</span>

<span style="color:#75715e">% Controller structure beta</span>
beta = minreal([<span style="color:#ae81ff">1</span>; Ts<span style="color:#f92672">/</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>z^<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>); (<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>z^<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span>Ts]); <span style="color:#75715e">%PID controller</span>

<span style="color:#75715e">%% Input/output data acquisition</span>
<span style="color:#75715e">% Input signal used for data acquisition u (m-sequence signal)</span>
n = <span style="color:#ae81ff">15</span>;<span style="color:#75715e">% number of steps</span>
T = <span style="color:#ae81ff">2</span>^n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">%Number of data per cycle</span>
p = <span style="color:#ae81ff">15</span>; <span style="color:#75715e">%number of data cycles</span>
N = T<span style="color:#f92672">*</span>p;<span style="color:#75715e">% number of data</span>
u0 = idinput([T <span style="color:#ae81ff">1</span> p],<span style="color:#e6db74">&#39;prbs&#39;</span>,[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>],[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>]);<span style="color:#75715e">% signal vector</span>

<span style="color:#75715e">% Power spectral density of input signal phi_u</span>
phi_u = <span style="color:#ae81ff">1</span>; <span style="color:#75715e">%The input signal is assumed to be white</span>

<span style="color:#75715e">% Controlled model P</span>
Tp = <span style="color:#ae81ff">0.74</span>;
Kp = <span style="color:#ae81ff">1.02</span>;
P = c2d(Kp<span style="color:#f92672">/</span>(Tp<span style="color:#f92672">*</span>s <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>), Ts);

<span style="color:#75715e">% Output signal y0</span>
y0 = lsim(P, u0);

Designed by <span style="color:#75715e">%% VRFT</span>
<span style="color:#75715e">% Prefilter L</span>
L = minreal(M<span style="color:#f92672">*</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>M)<span style="color:#f92672">/</span>phi_u);

<span style="color:#75715e">% Filtered input signal ul</span>
ul = lsim(L, u0);

<span style="color:#75715e">% Pseudo error signal el =</span>
el = lsim(L<span style="color:#f92672">*</span>(M^(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), y0);

Controller output before <span style="color:#75715e">%parameter phi</span>
phi = lsim(beta, el);

<span style="color:#75715e">% Optimal parameter rho</span>
rho = phi<span style="color:#f92672">\</span>ul;<span style="color:#75715e">% Solve least squares method in matrix form (mldivide)</span>

<span style="color:#75715e">% Designed controller C</span>
C = minreal(rho.<span style="color:#f92672">&#39;</span> <span style="color:#f92672">*</span> beta);<span style="color:#75715e">% find controller</span>

<span style="color:#75715e">% Evaluation function Jmr</span>
Jmr = mean(ul<span style="color:#f92672">-</span>phi <span style="color:#f92672">*</span> rho);<span style="color:#75715e">% Confirm the evaluation function in matrix form</span>

<span style="color:#75715e">%% Confirm performance</span>
<span style="color:#75715e">% Entire system with controller G</span>
G = minreal(feedback(P<span style="color:#f92672">*</span>C, <span style="color:#ae81ff">1</span>));

<span style="color:#75715e">% Step response</span>
fig1 = figure(<span style="color:#e6db74">&#39;name&#39;</span>,<span style="color:#e6db74">&#39;Step plot&#39;</span>);
stepplot(G, M);

<span style="color:#75715e">%Board diagram display</span>
fig2 = figure(<span style="color:#e6db74">&#39;name&#39;</span>,<span style="color:#e6db74">&#39;Bode plot of controller&#39;</span>);
bodeplot(G, M, {<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">100</span>});
</code></pre></div></div></details>
<details><summary>Code using Python Control `vrft.py`</summary><div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:vrft.py" data-lang="python:vrft.py"><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">VRFT design script
</span><span style="color:#e6db74">Design for the motor speed control system.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Copyright (c) 2019 larking95(https://qiita.com/larking95)
</span><span style="color:#e6db74">Released under the MIT License
</span><span style="color:#e6db74">https://opensource.org/licenses/mit-license.php
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> control.matlab <span style="color:#f92672">as</span> ctl

<span style="color:#75715e"># from scipy.signal import max_len_seq</span>
<span style="color:#f92672">from</span> scipy.signal <span style="color:#f92672">import</span> abcd_normalize


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">prbs</span>(n, p):
    <span style="color:#75715e"># matlab compatible PRBS signal generator</span>

    taps <span style="color:#f92672">=</span> {<span style="color:#ae81ff">3</span>: [<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">4</span>: [<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">5</span>: [<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">6</span>: [<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">7</span>: [<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],
            <span style="color:#ae81ff">8</span>: [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">6</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">9</span>: [<span style="color:#ae81ff">3</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">10</span>: [<span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">11</span>: [<span style="color:#ae81ff">8</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],
            <span style="color:#ae81ff">12</span>: [<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">10</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">13</span>: [<span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">11</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">14</span>: [<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">12</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>],
            <span style="color:#ae81ff">15</span>: [<span style="color:#ae81ff">13</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">16</span>: [<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">14</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">17</span>: [<span style="color:#ae81ff">13</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">18</span>: [<span style="color:#ae81ff">10</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]}
    N <span style="color:#f92672">=</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span>p
    x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>ones(n, dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>int8)
    u <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros(N, dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>int8)
    tap <span style="color:#f92672">=</span> taps[n]
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(N):
        u[i] <span style="color:#f92672">=</span> x[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
        x0 <span style="color:#f92672">=</span> x[tap[<span style="color:#ae81ff">0</span>]] <span style="color:#f92672">^</span> x[tap[<span style="color:#ae81ff">1</span>]]
        x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>roll(x, <span style="color:#ae81ff">1</span>)
        x[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> x0
    <span style="color:#66d9ef">return</span> u


<span style="color:#75715e"># === Determination of design specifications ===</span>
<span style="color:#75715e"># Sampling time</span>
Ts <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.001</span>

<span style="color:#75715e"># Reference model M</span>
tau <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.02</span>
M <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>c2d(ctl<span style="color:#f92672">.</span>tf([<span style="color:#ae81ff">1</span>], [tau, <span style="color:#ae81ff">1</span>]), Ts) <span style="color:#75715e"># first-order lag system discretized with zero-order hold</span>

<span style="color:#75715e"># Weight function W</span>
gW <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
W <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>c2d(ctl<span style="color:#f92672">.</span>tf([gW], [<span style="color:#ae81ff">1</span>, gW]), Ts) <span style="color:#75715e"># first-order lag system discretized by zero-order hold</span>

<span style="color:#75715e"># Controller structure beta</span>
A, B, C, D <span style="color:#f92672">=</span> abcd_normalize(
    [[<span style="color:#ae81ff">1.</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>]],
    [[<span style="color:#ae81ff">1.</span>], [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.</span>]],
    [[<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], [Ts, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>Ts]],
    [[<span style="color:#ae81ff">1.</span>], [<span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>Ts]])
beta <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>ss(A, B, C, D, Ts)
<span style="color:#66d9ef">del</span> A, B, C, D

<span style="color:#75715e"># === Acquisition of input/output data ===</span>
<span style="color:#75715e"># Input signal u (m series signal) used for data acquisition</span>
n <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
T <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
p <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
N <span style="color:#f92672">=</span> T<span style="color:#f92672">*</span>p
<span style="color:#75715e"># u0, _ = max_len_seq(n, length=N) # Signals of different series from MATLAB</span>
u0 <span style="color:#f92672">=</span> prbs(n, p)
u0 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>(<span style="color:#ae81ff">2.</span><span style="color:#f92672">*</span>u0<span style="color:#f92672">-</span><span style="color:#ae81ff">1.</span>)

<span style="color:#75715e"># Input signal power spectral density phi_u</span>
phi_u <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.</span>

<span style="color:#75715e"># Controlled model P</span>
Tp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.74</span>
Kp <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.02</span>
P <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>c2d(ctl<span style="color:#f92672">.</span>tf([Kp], [Tp, <span style="color:#ae81ff">1</span>]), Ts)

<span style="color:#75715e"># Output signal y0</span>
y0, t0, _ <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>lsim(P, u0)

<span style="color:#75715e"># === Design by VRFT ===</span>
<span style="color:#75715e"># Prefilter L</span>
L <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>minreal(M<span style="color:#f92672">*</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>M)<span style="color:#f92672">/</span>phi_u)

<span style="color:#75715e"># Filtered input signal ul</span>
ul, _, _ <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>lsim(L, u0)

<span style="color:#75715e"># Pseudo error signal el</span>
el, _, _ <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>lsim(ctl<span style="color:#f92672">.</span>minreal(L<span style="color:#f92672">*</span>(M<span style="color:#f92672">**-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)), y0<span style="color:#f92672">.</span>flatten())

Controller output before <span style="color:#75715e">#parameter</span>
phi, _, _ <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>lsim(beta, el<span style="color:#f92672">.</span>flatten())

<span style="color:#75715e"># Optimal parameter rho</span>
solution <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linalg<span style="color:#f92672">.</span>lstsq(phi, ul, rcond<span style="color:#f92672">=</span>None)
rho <span style="color:#f92672">=</span> solution[<span style="color:#ae81ff">0</span>]

<span style="color:#75715e"># Designed controller C</span>
C <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>ss([<span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">0</span>], rho<span style="color:#f92672">.</span>T, Ts) <span style="color:#f92672">*</span> find beta <span style="color:#75715e"># controller</span>

<span style="color:#75715e"># Evaluation function Jmr</span>
Jmr <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(ul<span style="color:#f92672">-</span>np<span style="color:#f92672">.</span>dot(phi, rho)) <span style="color:#75715e"># Check the evaluation function in matrix form</span>

<span style="color:#75715e"># === Confirmation of performance ===</span>
<span style="color:#75715e"># Whole system with controller G</span>
G <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>minreal(ctl<span style="color:#f92672">.</span>feedback(P<span style="color:#f92672">*</span>C, <span style="color:#ae81ff">1</span>))

<span style="color:#75715e">#Step response</span>
plt<span style="color:#f92672">.</span>figure()
plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#34;Step response of closed loop system&#34;</span>)
timeRange <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.12</span> <span style="color:#f92672">+</span> Ts, Ts)
ym, _ <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>step(M, timeRange)
yg, _ <span style="color:#f92672">=</span> ctl<span style="color:#f92672">.</span>step(G, timeRange)
plt<span style="color:#f92672">.</span>plot(timeRange, ym, timeRange, yg)
plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#34;Time [s]&#34;</span>, usetex<span style="color:#f92672">=</span>True)
plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#34;Velocity [V]&#34;</span>)
plt<span style="color:#f92672">.</span>legend([<span style="color:#e6db74">&#39;Reference model&#39;</span>,<span style="color:#e6db74">&#39;Closed loop system&#39;</span>], loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;lower right&#39;</span>)

<span style="color:#75715e">#Bode diagram display</span>
plt<span style="color:#f92672">.</span>figure()
plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#34;Bode plot of closed loop system&#34;</span>)
ctl<span style="color:#f92672">.</span>bode(M, G)
plt<span style="color:#f92672">.</span>legend([<span style="color:#e6db74">&#39;Reference model&#39;</span>,<span style="color:#e6db74">&#39;Closed loop system&#39;</span>], loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;lower left&#39;</span>)
plt<span style="color:#f92672">.</span>show()

</code></pre></div></div></details>
<h1 id="in-conclusion">in conclusion</h1>
<p>This time, while completely omitting the theory, I introduced the outline of data-driven controller design and the actual code of one of them, VRFT.
Control Engineering I don&rsquo;t have as much knowledge as the other participants in the Advent Calendar, but I hope everyone who sees it will be interested in data-driven control.</p>
<p>Also, if you have any concerns, please feel free to comment.</p>
<h1 id="references">References</h1>
<ol>
<li><a href="http://marco-campi.unibs.it/VRFTwebsite/index.html">Introduction to VRFT</a>(SitesofCampiandSavaresi)</li>
<li><a href="https://www.uec.ac.jp/research/information/opal-ring/0007003.html">Introduction to FRIT</a>(IntroductionarticlebyProfessorKaneko)</li>
<li>[Basics of system identification](<a href="https://www.amazon.co.jp/%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%90%8C%E5%AE%9A%E3%81%AE%E5%9F%BA%E7%A4%8E-%E8%B6%B3%E7%AB%8B-%E4%BF%AE%E4%B8%25(80/dp/4501114800)(BookbyProfessorAdachi)3.%5BDCmotorsystemidentificationusingArduinoandMATLAB/Simulink%5D(https://qiita.com/Manao/items/ed383a30bbe0c7b9534a)(%5BManao-sama%5D(https://qiita.com/Manao)article)">https://www.amazon.co.jp/%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%90%8C%E5%AE%9A%E3%81%AE%E5%9F%BA%E7%A4%8E-%E8%B6%B3%E7%AB%8B-%E4%BF%AE%E4%B8%(80/dp/4501114800)(BookbyProfessorAdachi)3.[DCmotorsystemidentificationusingArduinoandMATLAB/Simulink](https://qiita.com/Manao/items/ed383a30bbe0c7b9534a)([Manao-sama](https://qiita.com/Manao)article)</a></li>
<li><a href="https://docs.scipy.org/doc/numpy/user/numpy-for-matlab-users.html">NumPy for Matlab users</a>(Scipy.org)</li>
</ol>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Actually, it is historically necessary to explain non-falsification control and IFT, but I will omit it. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>Please note that this is only necessary for data acquisition, we do not use any models in the design. (In fact, it is possible to design as <code>clearvars P</code> after data acquisition.) <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>$M(z) = \frac{C^* (z) P(z)}{1 + C^* (z) P(z)}$ of controller $C^*$ satisfying Value (this is called the ideal controller) <a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
