<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Kaggle Tutorial Know-how in the top 2% of Titanic | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Kaggle Tutorial Know-how in the top 2% of Titanic</h1>
<p>
  <small class="text-secondary">
  
  
  Nov 21, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/machine-learning"> machine learning</a></code></small>


<small><code><a href="https://memotut.com/tags/kaggle"> Kaggle</a></code></small>


<small><code><a href="https://memotut.com/tags/titanic"> titanic</a></code></small>

</p>
<pre><code>#1.First of all
</code></pre>
<p>Since I started studying machine learning, I tried <strong>Kaggle&rsquo;s tutorial for beginners, Titanic</strong>.</p>
<p>At first, I tried to play around with the feature amount on my own, referring to Japanese Web information, but even if the training data showed good accuracy, when I submitted the test data, the accuracy did not rise as expected, It was difficult to break the wall of 80% and I was in agony.</p>
<p>In such a situation, it is hard to get it because it is in English, but I borrowed the wisdom of the ancestor in <strong>Notebook</strong> of Kaggle/Taitanic and finally put it in the top 2%, so I especially memorized the points that were helpful Leave as.</p>
<p>Then, I will explain along the code.</p>
<p>#1. Loading data
First, load the data set. If train and test are handled separately, it is necessary to perform the same processing twice, so combine them and use df.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> seaborn <span style="color:#f92672">as</span> sns

<span style="color:#75715e">#Load dataset</span>
train_data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;./train.csv&#39;</span>)
test_data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;./test.csv&#39;</span>)

<span style="color:#75715e"># concatenation of train_data and test_data</span>
test_data[<span style="color:#e6db74">&#39;Survived&#39;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nan
df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([train_data, test_data], ignore_index<span style="color:#f92672">=</span>True, sort<span style="color:#f92672">=</span>False)

<span style="color:#75715e">#df information</span>
df<span style="color:#f92672">.</span>info()

Relationship between <span style="color:#75715e"># Sex and survival rate</span>
sns<span style="color:#f92672">.</span>barplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Sex&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Survived&#39;</span>, data<span style="color:#f92672">=</span>df, palette<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Set3&#39;</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p>![Screenshot 2019-11-20 19.43.33.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/0080f9f6-794f-ff56-380d-(7cd96849b6cc.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/0080f9f6-794f-ff56-380d-(7cd96849b6cc.png)</a>
df is 13 items x 1309 lines. Missing values are <strong>Age</strong>: 1309-1046=263, <strong>Fare</strong>: 1309-1308=1, <strong>Cabin</strong>: 1309-295=1014, <strong>Embarked</strong>: 1309. -1307 = 2 pieces.</p>
<p>![Screenshot 2019-11-21 09.47.01.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/d43ecc21-d9bd-54e9-fe05-(56cedf8e360c.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/d43ecc21-d9bd-54e9-fe05-(56cedf8e360c.png)</a>
Looking at the survival rates for males and females, the survival rate for females is by far the highest **.</p>
<p>#2.Age missing value complement
First of all, since there is a relation between the title and age, I supplemented it with the average age according to the title. However, for some reason, if this feature amount is used, the accuracy will drop, so we did not use it for the feature amount. Perhaps I think the titles with different ages are bad.</p>
<p>In Notebook, there was a person who estimated the missing value of Age in random forest ** using complete data (Pclass, Sex, SibSp, Parch) with no missing value.
â€¥
I had this idea from the beginning, but I thought that it would not be necessary to do that. But it was a mistake. This works.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ------------ Age ------------</span>
Estimate <span style="color:#75715e"># Age from Pclass, Sex, Parch, SibSp in random forest</span>
<span style="color:#f92672">from</span> sklearn.ensemble <span style="color:#f92672">import</span> RandomForestRegressor

<span style="color:#75715e"># Specify the item to be used for estimation</span>
age_df <span style="color:#f92672">=</span> df[[<span style="color:#e6db74">&#39;Age&#39;</span>,<span style="color:#e6db74">&#39;Pclass&#39;</span>,<span style="color:#e6db74">&#39;Sex&#39;</span>,<span style="color:#e6db74">&#39;Parch&#39;</span>,<span style="color:#e6db74">&#39;SibSp&#39;</span>]]

<span style="color:#75715e">#One-hot encoding of label features</span>
age_df<span style="color:#f92672">=</span>pd<span style="color:#f92672">.</span>get_dummies(age_df)

<span style="color:#75715e"># Separate into learning data and test data and convert to numpy</span>
known_age <span style="color:#f92672">=</span> age_df[age_df<span style="color:#f92672">.</span>Age<span style="color:#f92672">.</span>notnull()]<span style="color:#f92672">.</span>values
unknown_age <span style="color:#f92672">=</span> age_df[age_df<span style="color:#f92672">.</span>Age<span style="color:#f92672">.</span>isnull()]<span style="color:#f92672">.</span>values

<span style="color:#75715e"># Separate learning data into X and y</span>
X <span style="color:#f92672">=</span> known_age[:, <span style="color:#ae81ff">1</span>:]
y <span style="color:#f92672">=</span> known_age[:, <span style="color:#ae81ff">0</span>]

<span style="color:#75715e"># Build estimation model in random forest</span>
rfr <span style="color:#f92672">=</span> RandomForestRegressor(random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, n_estimators<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>, n_jobs<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)
rfr<span style="color:#f92672">.</span>fit(X, y)

<span style="color:#75715e"># Use estimated model to predict and supplement Age of test data</span>
predictedAges <span style="color:#f92672">=</span> rfr<span style="color:#f92672">.</span>predict(unknown_age[:, <span style="color:#ae81ff">1</span>::])
df<span style="color:#f92672">.</span>loc[(df<span style="color:#f92672">.</span>Age<span style="color:#f92672">.</span>isnull()),<span style="color:#e6db74">&#39;Age&#39;</span>] <span style="color:#f92672">=</span> predictedAges

<span style="color:#75715e"># Survival and death curves by age</span>
facet <span style="color:#f92672">=</span> sns<span style="color:#f92672">.</span>FacetGrid(df[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">890</span>], hue<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Survived&#34;</span>, aspect<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
facet<span style="color:#f92672">.</span>map(sns<span style="color:#f92672">.</span>kdeplot,<span style="color:#e6db74">&#39;Age&#39;</span>,shade<span style="color:#f92672">=</span> True)
facet<span style="color:#f92672">.</span>set(xlim<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0</span>, df<span style="color:#f92672">.</span>loc[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">890</span>,<span style="color:#e6db74">&#39;Age&#39;</span>]<span style="color:#f92672">.</span>max()))
facet<span style="color:#f92672">.</span>add_legend()
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p>![Screenshot 2019-11-20 20.00.40.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/9a38a289-8b22-600c-fd22-(ca7c98dd1997.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/9a38a289-8b22-600c-fd22-(ca7c98dd1997.png)</a>
As a result of supplementing Age&rsquo;s missing value, if you draw a survival curve and death curve by age, it seems that **peak of survival is under 10 years old **, peak of death is late 20s ** Or?</p>
<p>Create new features from #3.Name
From the beginning, I also extracted the title from **Name and used it as a feature quantity. **And this certainly contributed to the improvement of accuracy (the accuracy decreases when pulled out).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ------------ Name --------------</span>
Grouping by extracting titles <span style="color:#f92672">from</span> <span style="color:#75715e"># Name</span>
df[<span style="color:#e6db74">&#39;Title&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Name&#39;</span>]<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> x: x<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;,&#39;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#ae81ff">0</span>])
df[<span style="color:#e6db74">&#39;Title&#39;</span>]<span style="color:#f92672">.</span>replace([<span style="color:#e6db74">&#39;Capt&#39;</span>,<span style="color:#e6db74">&#39;Col&#39;</span>,<span style="color:#e6db74">&#39;Major&#39;</span>,<span style="color:#e6db74">&#39;Dr&#39;</span>,<span style="color:#e6db74">&#39;Rev&#39;</span>],<span style="color:#e6db74">&#39;Officer&#39;</span>, inplace<span style="color:#f92672">=</span>True)
df[<span style="color:#e6db74">&#39;Title&#39;</span>]<span style="color:#f92672">.</span>replace([<span style="color:#e6db74">&#39;Don&#39;</span>,<span style="color:#e6db74">&#39;Sir&#39;</span>,<span style="color:#e6db74">&#39;the Countess&#39;</span>,<span style="color:#e6db74">&#39;Lady&#39;</span>,<span style="color:#e6db74">&#39;Dona&#39;</span>],<span style="color:#e6db74">&#39;Royalty&#39;</span>, inplace<span style="color:#f92672">=</span>True)
df[<span style="color:#e6db74">&#39;Title&#39;</span>]<span style="color:#f92672">.</span>replace([<span style="color:#e6db74">&#39;Mme&#39;</span>,<span style="color:#e6db74">&#39;Ms&#39;</span>],<span style="color:#e6db74">&#39;Mrs&#39;</span>, inplace<span style="color:#f92672">=</span>True)
df[<span style="color:#e6db74">&#39;Title&#39;</span>]<span style="color:#f92672">.</span>replace([<span style="color:#e6db74">&#39;Mlle&#39;</span>],<span style="color:#e6db74">&#39;Miss&#39;</span>, inplace<span style="color:#f92672">=</span>True)
df[<span style="color:#e6db74">&#39;Title&#39;</span>]<span style="color:#f92672">.</span>replace([<span style="color:#e6db74">&#39;Jonkheer&#39;</span>],<span style="color:#e6db74">&#39;Master&#39;</span>, inplace<span style="color:#f92672">=</span>True)
sns<span style="color:#f92672">.</span>barplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Title&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Survived&#39;</span>, data<span style="color:#f92672">=</span>df, palette<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Set3&#39;</span>)
</code></pre></div><p>![Screenshot 2019-11-20 15.23.08.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/67b3cd6b-9b35-feb2-6d71-(d69add1f42b4.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/67b3cd6b-9b35-feb2-6d71-(d69add1f42b4.png)</a>
Looking at the survival rate by title, it can be seen that <strong>Mr survival rate is the lowest and Mrs survival rate is the highest</strong>.</p>
<p>By the way, in addition to this, in Notebook, there was a person who took out the last name from <strong>Name and paid attention to the group with multiple same last names</strong>.
â€¥
In other words, from the perspective of <strong>if you have a family, you may tend to share your destiny</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ------------ Surname ------------</span>
Extract Surname <span style="color:#f92672">from</span> <span style="color:#75715e"># Name</span>
df[<span style="color:#e6db74">&#39;Surname&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Name&#39;</span>]<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> name:name<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;,&#39;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>strip())

<span style="color:#75715e">#Count the frequency of appearance of the same Surname (family name if the number of appearances is 2 or more)</span>
df[<span style="color:#e6db74">&#39;FamilyGroup&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Surname&#39;</span>]<span style="color:#f92672">.</span>map(df[<span style="color:#e6db74">&#39;Surname&#39;</span>]<span style="color:#f92672">.</span>value_counts())
</code></pre></div><p>And when we look at the survival rate by dividing the family into a group under 16 years old or female ** (generally speaking, female child) and a group over 16 years old and male ** I can see it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Family 16 and under or female survival</span>
Female_Child_Group<span style="color:#f92672">=</span>df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;FamilyGroup&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&amp;</span> ((df[<span style="color:#e6db74">&#39;Age&#39;</span>]<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">16</span>) <span style="color:#f92672">|</span> (df[<span style="color:#e6db74">&#39;Sex&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;female&#39;</span>))]
Female_Child_Group<span style="color:#f92672">=</span>Female_Child_Group<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;Surname&#39;</span>)[<span style="color:#e6db74">&#39;Survived&#39;</span>]<span style="color:#f92672">.</span>mean()
<span style="color:#66d9ef">print</span>(Female_Child_Group<span style="color:#f92672">.</span>value_counts())
</code></pre></div><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/392c33a9-249f-5024-3d03-94c407ef57dc.png" alt="Screenshot 2019-11-20 20.18.34.png">
â€ In the group of 16 years old or younger or women**, most of the 113 groups have a survival rate of 100%, but only 32 groups have a survival rate of 0%. So ** many groups are all alive, but some groups are annihilated **.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Male over 16 years old and male survival</span>
Male_Adult_Group<span style="color:#f92672">=</span>df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;FamilyGroup&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;Age&#39;</span>]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">16</span>) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;Sex&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;male&#39;</span>)]
Male_Adult_List<span style="color:#f92672">=</span>Male_Adult_Group<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;Surname&#39;</span>)[<span style="color:#e6db74">&#39;Survived&#39;</span>]<span style="color:#f92672">.</span>mean()
<span style="color:#66d9ef">print</span>(Male_Adult_List<span style="color:#f92672">.</span>value_counts())
</code></pre></div><p>![Screenshot 2019-11-20 20.22.17.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/b8fa0648-a599-ce1e-6cd1-(a24c4738763f.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/b8fa0648-a599-ce1e-6cd1-(a24c4738763f.png)</a>
â‰ªMost of the groups over 16 years old and males** have a survival rate of 0% in 115 groups, while the survival rate is 100% in 21 groups. In other words, **although many groups are annihilated, some groups are all alive**.A valuable piece of information from these facts is that there are minorities with a fate that is the opposite of the whole flow**. We will take the following actions based on this minority information.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#Create deadlist and survivor list</span>
Dead_list<span style="color:#f92672">=</span>set(Female_Child_Group[Female_Child_Group<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x:x<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>)]<span style="color:#f92672">.</span>index)
Survived_list<span style="color:#f92672">=</span>set(Male_Adult_List[Male_Adult_List<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x:x<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>)]<span style="color:#f92672">.</span>index)

<span style="color:#75715e">#Display Dead List and Survival List</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Dead_list =&#39;</span>, Dead_list)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Survived_list =&#39;</span>, Survived_list)

<span style="color:#75715e"># Reflect Dead List and Survival List in Sex, Age, Title</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;Survived&#39;</span>]<span style="color:#f92672">.</span>isnull()) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;Surname&#39;</span>]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x:x <span style="color:#f92672">in</span> Dead_list)),\
             [<span style="color:#e6db74">&#39;Sex&#39;</span>,<span style="color:#e6db74">&#39;Age&#39;</span>,<span style="color:#e6db74">&#39;Title&#39;</span>]] <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;male&#39;</span>,<span style="color:#ae81ff">28.0</span>,<span style="color:#e6db74">&#39;Mr&#39;</span>]
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;Survived&#39;</span>]<span style="color:#f92672">.</span>isnull()) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;Surname&#39;</span>]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x:x <span style="color:#f92672">in</span> Survived_list)),\
             [<span style="color:#e6db74">&#39;Sex&#39;</span>,<span style="color:#e6db74">&#39;Age&#39;</span>,<span style="color:#e6db74">&#39;Title&#39;</span>]] <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;female&#39;</span>,<span style="color:#ae81ff">5.0</span>,<span style="color:#e6db74">&#39;Mrs&#39;</span>]
</code></pre></div><p>![Screenshot 2019-11-21 15.27.26.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/58712e8d-fbfc-9261-85a4-(99790b19e525.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/58712e8d-fbfc-9261-85a4-(99790b19e525.png)</a>
This is a collection of surnames that were all dead in a group of 16 years old or less or a female from the learning data ** Dead list * and surnames that were all surviving in a group of males over 16 years old * <em>Survived list</em> (Survived_list). This is reflected in the test data.</p>
<p>Specifically, in the test data, if there is a line that corresponds to the <strong>dead list</strong>, Sex, Age, Title will be changed to typical death data** so that it is always judged as dead. Rewriting, if there is a line that corresponds to **Survive list**, **Rewrite Sex, Age, Title to typical survival data** so that it is always judged as alive.</p>
<p>It seems a bit tricky, but I think it&rsquo;s a smart way because the estimation model is simple. As expected, it is the wisdom of the ancestors. â€¥</p>
<p>#4.Fare missing value completion
Fares are complemented by taking the median of Fare from the setting of missing values (Embarked=S, Pclass=3) by saying that the boarding location (Emabarked) and class (Pclass) will be related. This will be fine.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ----------- Fare -------------</span>
<span style="color:#75715e"># Fill in missing values with the average of Embarked=&#39;S&#39;, Pclass=3</span>
fare<span style="color:#f92672">=</span>df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;Embarked&#39;</span>] <span style="color:#f92672">==</span><span style="color:#e6db74">&#39;S&#39;</span>) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;Pclass&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>),<span style="color:#e6db74">&#39;Fare&#39;</span>]<span style="color:#f92672">.</span>median()
df[<span style="color:#e6db74">&#39;Fare&#39;</span>]<span style="color:#f92672">=</span>df[<span style="color:#e6db74">&#39;Fare&#39;</span>]<span style="color:#f92672">.</span>fillna(fare)
</code></pre></div><p>#5. Make features from SibSp and Parch
<strong>SibSp</strong> is the number of siblings and spouses who are on the Titanic, and <strong>Parch</strong> is the number of parents and children who are on the Titanic. It is better to use <strong>Family</strong> in total as the feature amount than to use the feature amount independently. Grouped by survival rate. This will also be no problem.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ----------- Family -------------</span>
Grouping <span style="color:#66d9ef">with</span> <span style="color:#75715e"># Family = SibSp + Parch + 1 as a feature</span>
df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">=</span>df[<span style="color:#e6db74">&#39;SibSp&#39;</span>]<span style="color:#f92672">+</span>df[<span style="color:#e6db74">&#39;Parch&#39;</span>]<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">4</span>),<span style="color:#e6db74">&#39;Family_label&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">5</span>) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">7</span>) <span style="color:#f92672">|</span> (df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>),<span style="color:#e6db74">&#39;Family_label&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e"># == Note</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">8</span>),<span style="color:#e6db74">&#39;Family_label&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</code></pre></div><p>#6. Extract meaningful features from Ticket
First, without any reason, I made the feature quantity ** with the first letter of the Ticket number. As a matter of course, if this feature amount is used, the accuracy will drop, so we did not use it for the feature amount. After all, it seems that it is not a good idea to make it a feature amount without any reason.</p>
<p>In Notebook, there was a person who made a feature quantity ** based on how many people had the same ticket number. I see, then. <strong>People with the same ticket number are likely to live in the same room and share their destiny, and the ease of survival will change depending on the number of people</strong>.</p>
<p>The following is a graph of survival rates by the number of people with the same ticket number.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ----------- Ticket ----------------</span>
<span style="color:#75715e"># How many people with the same ticket number are extracted as feature quantities</span>
Ticket_Count <span style="color:#f92672">=</span> dict(df[<span style="color:#e6db74">&#39;Ticket&#39;</span>]<span style="color:#f92672">.</span>value_counts())
df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Ticket&#39;</span>]<span style="color:#f92672">.</span>map(Ticket_Count)
sns<span style="color:#f92672">.</span>barplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;TicketGroup&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Survived&#39;</span>, data<span style="color:#f92672">=</span>df, palette<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Set3&#39;</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p>![Screenshot 2019-11-20 20.50.34.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/8f2f5246-5b9d-d822-1445-(b0126007368d.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/8f2f5246-5b9d-d822-1445-(b0126007368d.png)</a>
The survival rate of 2 to 4 people is high, the survival rate of 5 to 8 people and 1 person is medium, and the survival rate of 11 people is zero. Therefore, group it into three.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Group by survival rate to 3</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>]<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">4</span>),<span style="color:#e6db74">&#39;Ticket_label&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">5</span>) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>]<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">|</span> (df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>),<span style="color:#e6db74">&#39;Ticket_label&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">11</span>),<span style="color:#e6db74">&#39;Ticket_label&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
sns<span style="color:#f92672">.</span>barplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Ticket_label&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Survived&#39;</span>, data<span style="color:#f92672">=</span>df, palette<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Set3&#39;</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/b073103b-4efc-39d3-4bd1-73c66b3ebbfe.png" alt="Screenshot 2019-11-21 10.29.01.png"></p>
<p>#7.Cabin
There are many missing values, but since the survival rate of the missing value U is obviously low, we do not do any missing value complementation. This will also be no problem.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ------------- Cabin ----------------</span>
The first character of <span style="color:#75715e"># Cabin is the feature value (missing value is U ).</span>
df[<span style="color:#e6db74">&#39;Cabin&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Cabin&#39;</span>]<span style="color:#f92672">.</span>fillna(<span style="color:#e6db74">&#39;Unknown&#39;</span>)
df[<span style="color:#e6db74">&#39;Cabin_label&#39;</span>]<span style="color:#f92672">=</span>df[<span style="color:#e6db74">&#39;Cabin&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>get(<span style="color:#ae81ff">0</span>)
sns<span style="color:#f92672">.</span>barplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Cabin_label&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Survived&#39;</span>, data<span style="color:#f92672">=</span>df, palette<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Set3&#39;</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p>![Screenshot 2019-11-20 21.21.46.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/ee50fcdb-dd55-4317-b055-(8fe12036c13a.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/ee50fcdb-dd55-4317-b055-(8fe12036c13a.png)</a></p>
<p>#8.Embarked
âˆ™ The missing value is complemented by S, which has the most passengers. This will also be fine.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ---------- Embarked ---------------</span>
<span style="color:#75715e"># Complement missing values with S</span>
df[<span style="color:#e6db74">&#39;Embarked&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Embarked&#39;</span>]<span style="color:#f92672">.</span>fillna(<span style="color:#e6db74">&#39;S&#39;</span>)
</code></pre></div><p>#9. Pretreatment
Pre-processing to create an estimation model in random forest. **The label feature can be decomposed by one-hot encoding the label feature. **</p>
<p>For example, the content of Embarked consists of three labels, C, Q and S. If you apply one-hot encoding to this, three items Embarked_C, Embarked_Q, Embarked_S will be automatically created, and only one of the three items will be changed to 1 and the rest will be changed to 0.</p>
<p>By doing this, Embarked_C and Embarked_S are used as features, but Embarked_Q is overlearned, so you can take detailed measures to prevent overlearning, such as not using it.</p>
<p>This is what I learned from Notebook for the first time, and I thought that one-hot encoding feature decomposition would be a powerful weapon for selecting only what you need after finding various features. It was</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ------------- Preprocessing ---------------</span>
<span style="color:#75715e"># Specify the item to be used for estimation</span>
df <span style="color:#f92672">=</span> df[[<span style="color:#e6db74">&#39;Survived&#39;</span>,<span style="color:#e6db74">&#39;Pclass&#39;</span>,<span style="color:#e6db74">&#39;Sex&#39;</span>,<span style="color:#e6db74">&#39;Age&#39;</span>,<span style="color:#e6db74">&#39;Fare&#39;</span>,<span style="color:#e6db74">&#39;Embarked&#39;</span>,<span style="color:#e6db74">&#39;Title&#39;</span>,<span style="color:#e6db74">&#39;Family_label&#39;</span>,<span style="color:#e6db74">&#39;Cabin_label&#39;</span>,<span style="color:#e6db74">&#39;Ticket_label&#39;</span>]]

<span style="color:#75715e">#One-hot encoding of label features</span>
df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>get_dummies(df)

<span style="color:#75715e"># Split dataset into train and test</span>
train <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;Survived&#39;</span>]<span style="color:#f92672">.</span>notnull()]
test <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;Survived&#39;</span>]<span style="color:#f92672">.</span>isnull()]<span style="color:#f92672">.</span>drop(<span style="color:#e6db74">&#39;Survived&#39;</span>,axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

<span style="color:#75715e"># Convert dataframe to numpy</span>
X <span style="color:#f92672">=</span> train<span style="color:#f92672">.</span>values[:,<span style="color:#ae81ff">1</span>:]
y <span style="color:#f92672">=</span> train<span style="color:#f92672">.</span>values[:,<span style="color:#ae81ff">0</span>]
test_x <span style="color:#f92672">=</span> test<span style="color:#f92672">.</span>values
</code></pre></div><p>#10. Construction of estimation model by random forest
First, I selected the best combination while manually adding or subtracting the created features and seeing what the accuracy would be.</p>
<p>However, with Notbook, there were some people who automatically select and sort feature quantities using <strong>SelectKbest</strong>. This is efficient!The number of features to narrow down is specified in the form <strong>select = SelectKBest(k = 20)</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ----------- Estimated model construction ---------------</span>
<span style="color:#f92672">from</span> sklearn.feature_selection <span style="color:#f92672">import</span> SelectKBest
<span style="color:#f92672">from</span> sklearn.ensemble <span style="color:#f92672">import</span> RandomForestClassifier
<span style="color:#f92672">from</span> sklearn.pipeline <span style="color:#f92672">import</span> make_pipeline
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> cross_validate

<span style="color:#75715e"># Reduce the number of features to be used from 25 to 20</span>
select <span style="color:#f92672">=</span> SelectKBest(k <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>)

clf <span style="color:#f92672">=</span> RandomForestClassifier(random_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>,
                             warm_start <span style="color:#f92672">=</span> True, <span style="color:#75715e"># add training to already fitted model</span>
                             n_estimators <span style="color:#f92672">=</span> <span style="color:#ae81ff">26</span>,
                             max_depth <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>,
                             max_features <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sqrt&#39;</span>)
pipeline <span style="color:#f92672">=</span> make_pipeline(select, clf)
pipeline<span style="color:#f92672">.</span>fit(X, y)

<span style="color:#75715e"># View fit results</span>
cv_result <span style="color:#f92672">=</span> cross_validate(pipeline, X, y, cv<span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;mean_score =&#39;</span>, np<span style="color:#f92672">.</span>mean(cv_result[<span style="color:#e6db74">&#39;test_score&#39;</span>]))
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;mean_std =&#39;</span>, np<span style="color:#f92672">.</span>std(cv_result[<span style="color:#e6db74">&#39;test_score&#39;</span>]))
</code></pre></div><p>![Screenshot 2019-11-21 14.36.59.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/2faeab6a-e375-4e91-e07c-(346cece59480.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/2faeab6a-e375-4e91-e07c-(346cece59480.png)</a>
The average score of the results narrowed down to 20 features is 0.8417441.</p>
<p>Now, let&rsquo;s check which feature quantity was adopted in the model built with the above code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># -------- Adopted feature quantity ---------------</span>
<span style="color:#75715e"># Adoption status</span>
mask<span style="color:#f92672">=</span> select<span style="color:#f92672">.</span>get_support()

<span style="color:#75715e"># List of items</span>
list_col <span style="color:#f92672">=</span> list(df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">1</span>:])

<span style="color:#75715e">#List of approval/disapproval by item</span>
<span style="color:#66d9ef">for</span> i, j <span style="color:#f92672">in</span> enumerate(list_col):
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;No&#39;</span><span style="color:#f92672">+</span>str(i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>), j,<span style="color:#e6db74">&#39;=&#39;</span>, mask[i])

<span style="color:#75715e">#Check the shape</span>
X_selected <span style="color:#f92672">=</span> select<span style="color:#f92672">.</span>transform(X)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;X.shape={}, X_selected.shape={}&#39;</span><span style="color:#f92672">.</span>format(X<span style="color:#f92672">.</span>shape, X_selected<span style="color:#f92672">.</span>shape))
</code></pre></div><p>![Screenshot 2019-11-21 11.01.14.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/297dd7c5-47f9-6839-7810-(c2eb38c2f1d4.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/297dd7c5-47f9-6839-7810-(c2eb38c2f1d4.png)</a>
Of the 25 feature quantities prepared, Embarked_Q, Title_officer, Cabin_label_A, Cabin_label_G, Cabin_label_T were not adopted, and after that they were adopted, and the feature quantity was certainly narrowed down to 20.</p>
<p>#11.Create Submit_data</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ----- Create Submit data -------</span>
PassengerId<span style="color:#f92672">=</span>test_data[<span style="color:#e6db74">&#39;PassengerId&#39;</span>]
predictions <span style="color:#f92672">=</span> pipeline<span style="color:#f92672">.</span>predict(test_x)
submission <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#34;PassengerId&#34;</span>: PassengerId, <span style="color:#e6db74">&#34;Survived&#34;</span>: predictions<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>int32)})
submission<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">&#34;my_submission.csv&#34;</span>, index<span style="color:#f92672">=</span>False)
</code></pre></div><p>![Screenshot 2019-11-21 11.09.39.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/1f2b3a44-042b-1960-98de-(bec4fef72aba.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/209705/1f2b3a44-042b-1960-98de-(bec4fef72aba.png)</a>
The result was <strong>259th</strong> with <strong>accuracy 0.83732</strong> as of November 21, 2019.
The number of participating members is 15,889, so it is about <strong>Top 1.6%</strong>.</p>
<p>#12. Summary
This time, I will summarize the know-how obtained from Kaggle/titanic&rsquo;s Notebook.
**1) For missing value interpolation, there is a method of creating an estimated model from complete data without missing values and complementing it (Age).
2) Even if seemingly random features, new features should always be found from a rational reason (Ticket).
3) In some cases, even if a new feature is found, the feature can still be found (Name).
4) Frequency is a viewpoint for exploring new features (Surname, Ticket)
5) It is effective to prevent over-learning by separating label features and selecting them (Embarked, Title, Cabin).
6) Use SelectKBset for efficient selection of features. **</p>
<p>#13.code
Finally, I will summarize the code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> seaborn <span style="color:#f92672">as</span> sns

<span style="color:#75715e">#Load dataset</span>
train_data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;./train.csv&#39;</span>)
test_data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;./test.csv&#39;</span>)

<span style="color:#75715e"># concatenation of train_data and test_data</span>
test_data[<span style="color:#e6db74">&#39;Survived&#39;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nan
df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([train_data, test_data], ignore_index<span style="color:#f92672">=</span>True, sort<span style="color:#f92672">=</span>False)

<span style="color:#75715e">#df information</span>
df<span style="color:#f92672">.</span>info()

Relationship between <span style="color:#75715e"># Sex and survival rate</span>
sns<span style="color:#f92672">.</span>barplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Sex&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Survived&#39;</span>, data<span style="color:#f92672">=</span>df, palette<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Set3&#39;</span>)
plt<span style="color:#f92672">.</span>show()

<span style="color:#75715e"># ------------ Age ------------</span>
Estimate <span style="color:#75715e"># Age from Pclass, Sex, Parch, SibSp in random forest</span>
<span style="color:#f92672">from</span> sklearn.ensemble <span style="color:#f92672">import</span> RandomForestRegressor

<span style="color:#75715e"># Specify the item to be used for estimation</span>
age_df <span style="color:#f92672">=</span> df[[<span style="color:#e6db74">&#39;Age&#39;</span>,<span style="color:#e6db74">&#39;Pclass&#39;</span>,<span style="color:#e6db74">&#39;Sex&#39;</span>,<span style="color:#e6db74">&#39;Parch&#39;</span>,<span style="color:#e6db74">&#39;SibSp&#39;</span>]]

<span style="color:#75715e">#One-hot encoding of label features</span>
age_df<span style="color:#f92672">=</span>pd<span style="color:#f92672">.</span>get_dummies(age_df)

<span style="color:#75715e"># Separate into learning data and test data and convert to numpy</span>
known_age <span style="color:#f92672">=</span> age_df[age_df<span style="color:#f92672">.</span>Age<span style="color:#f92672">.</span>notnull()]<span style="color:#f92672">.</span>values
unknown_age <span style="color:#f92672">=</span> age_df[age_df<span style="color:#f92672">.</span>Age<span style="color:#f92672">.</span>isnull()]<span style="color:#f92672">.</span>values

<span style="color:#75715e"># Separate learning data into X and y</span>
X <span style="color:#f92672">=</span> known_age[:, <span style="color:#ae81ff">1</span>:]
y <span style="color:#f92672">=</span> known_age[:, <span style="color:#ae81ff">0</span>]

<span style="color:#75715e"># Build estimation model in random forest</span>
rfr <span style="color:#f92672">=</span> RandomForestRegressor(random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, n_estimators<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>, n_jobs<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)
rfr<span style="color:#f92672">.</span>fit(X, y)

<span style="color:#75715e"># Use estimated model to predict and supplement Age of test data</span>
predictedAges <span style="color:#f92672">=</span> rfr<span style="color:#f92672">.</span>predict(unknown_age[:, <span style="color:#ae81ff">1</span>::])
df<span style="color:#f92672">.</span>loc[(df<span style="color:#f92672">.</span>Age<span style="color:#f92672">.</span>isnull()),<span style="color:#e6db74">&#39;Age&#39;</span>] <span style="color:#f92672">=</span> predictedAges

<span style="color:#75715e"># Survival and death curves by age</span>
facet <span style="color:#f92672">=</span> sns<span style="color:#f92672">.</span>FacetGrid(df[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">890</span>], hue<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Survived&#34;</span>, aspect<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
facet<span style="color:#f92672">.</span>map(sns<span style="color:#f92672">.</span>kdeplot,<span style="color:#e6db74">&#39;Age&#39;</span>,shade<span style="color:#f92672">=</span> True)
facet<span style="color:#f92672">.</span>set(xlim<span style="color:#f92672">=</span>(<span style="color:#ae81ff">0</span>, df<span style="color:#f92672">.</span>loc[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">890</span>,<span style="color:#e6db74">&#39;Age&#39;</span>]<span style="color:#f92672">.</span>max()))
facet<span style="color:#f92672">.</span>add_legend()
plt<span style="color:#f92672">.</span>show()

<span style="color:#75715e"># ------------ Name --------------</span>
Grouping by extracting titles <span style="color:#f92672">from</span> <span style="color:#75715e"># Name</span>
df[<span style="color:#e6db74">&#39;Title&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Name&#39;</span>]<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> x: x<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;,&#39;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#ae81ff">0</span>])
df[<span style="color:#e6db74">&#39;Title&#39;</span>]<span style="color:#f92672">.</span>replace([<span style="color:#e6db74">&#39;Capt&#39;</span>,<span style="color:#e6db74">&#39;Col&#39;</span>,<span style="color:#e6db74">&#39;Major&#39;</span>,<span style="color:#e6db74">&#39;Dr&#39;</span>,<span style="color:#e6db74">&#39;Rev&#39;</span>],<span style="color:#e6db74">&#39;Officer&#39;</span>, inplace<span style="color:#f92672">=</span>True)
df[<span style="color:#e6db74">&#39;Title&#39;</span>]<span style="color:#f92672">.</span>replace([<span style="color:#e6db74">&#39;Don&#39;</span>,<span style="color:#e6db74">&#39;Sir&#39;</span>,<span style="color:#e6db74">&#39;the Countess&#39;</span>,<span style="color:#e6db74">&#39;Lady&#39;</span>,<span style="color:#e6db74">&#39;Dona&#39;</span>],<span style="color:#e6db74">&#39;Royalty&#39;</span>, inplace<span style="color:#f92672">=</span>True)
df[<span style="color:#e6db74">&#39;Title&#39;</span>]<span style="color:#f92672">.</span>replace([<span style="color:#e6db74">&#39;Mme&#39;</span>,<span style="color:#e6db74">&#39;Ms&#39;</span>],<span style="color:#e6db74">&#39;Mrs&#39;</span>, inplace<span style="color:#f92672">=</span>True)
df[<span style="color:#e6db74">&#39;Title&#39;</span>]<span style="color:#f92672">.</span>replace([<span style="color:#e6db74">&#39;Mlle&#39;</span>],<span style="color:#e6db74">&#39;Miss&#39;</span>, inplace<span style="color:#f92672">=</span>True)
df[<span style="color:#e6db74">&#39;Title&#39;</span>]<span style="color:#f92672">.</span>replace([<span style="color:#e6db74">&#39;Jonkheer&#39;</span>],<span style="color:#e6db74">&#39;Master&#39;</span>, inplace<span style="color:#f92672">=</span>True)
sns<span style="color:#f92672">.</span>barplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Title&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Survived&#39;</span>, data<span style="color:#f92672">=</span>df, palette<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Set3&#39;</span>)

<span style="color:#75715e"># ------------ Surname ------------</span>
Extract Surname <span style="color:#f92672">from</span> <span style="color:#75715e"># Name</span>
df[<span style="color:#e6db74">&#39;Surname&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Name&#39;</span>]<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> name:name<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;,&#39;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>strip())

<span style="color:#75715e">#Count the frequency of appearance of the same Surname (family name if the number of appearances is 2 or more)</span>
df[<span style="color:#e6db74">&#39;FamilyGroup&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Surname&#39;</span>]<span style="color:#f92672">.</span>map(df[<span style="color:#e6db74">&#39;Surname&#39;</span>]<span style="color:#f92672">.</span>value_counts())

<span style="color:#75715e"># Family 16 and under or female survival</span>
Female_Child_Group<span style="color:#f92672">=</span>df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;FamilyGroup&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&amp;</span> ((df[<span style="color:#e6db74">&#39;Age&#39;</span>]<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">16</span>) <span style="color:#f92672">|</span> (df[<span style="color:#e6db74">&#39;Sex&#39;</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;female&#39;</span>))]
Female_Child_Group<span style="color:#f92672">=</span>Female_Child_Group<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;Surname&#39;</span>)[<span style="color:#e6db74">&#39;Survived&#39;</span>]<span style="color:#f92672">.</span>mean()
<span style="color:#66d9ef">print</span>(Female_Child_Group<span style="color:#f92672">.</span>value_counts())

<span style="color:#75715e"># Male over 16 years old and male survivalMale_Adult_Group=df.loc[(df[&#39;FamilyGroup&#39;]&gt;=2) &amp; (df[&#39;Age&#39;]&gt;16) &amp; (df[&#39;Sex&#39;]==&#39;male&#39;)]</span>
Male_Adult_List<span style="color:#f92672">=</span>Male_Adult_Group<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;Surname&#39;</span>)[<span style="color:#e6db74">&#39;Survived&#39;</span>]<span style="color:#f92672">.</span>mean()
<span style="color:#66d9ef">print</span>(Male_Adult_List<span style="color:#f92672">.</span>value_counts())

<span style="color:#75715e">#Create deadlist and survivor list</span>
Dead_list<span style="color:#f92672">=</span>set(Female_Child_Group[Female_Child_Group<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x:x<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>)]<span style="color:#f92672">.</span>index)
Survived_list<span style="color:#f92672">=</span>set(Male_Adult_List[Male_Adult_List<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x:x<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>)]<span style="color:#f92672">.</span>index)

<span style="color:#75715e">#Display Dead List and Survival List</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Dead_list =&#39;</span>, Dead_list)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Survived_list =&#39;</span>, Survived_list)

<span style="color:#75715e"># Reflect Dead List and Survival List in Sex, Age, Title</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;Survived&#39;</span>]<span style="color:#f92672">.</span>isnull()) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;Surname&#39;</span>]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x:x <span style="color:#f92672">in</span> Dead_list)),\
             [<span style="color:#e6db74">&#39;Sex&#39;</span>,<span style="color:#e6db74">&#39;Age&#39;</span>,<span style="color:#e6db74">&#39;Title&#39;</span>]] <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;male&#39;</span>,<span style="color:#ae81ff">28.0</span>,<span style="color:#e6db74">&#39;Mr&#39;</span>]
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;Survived&#39;</span>]<span style="color:#f92672">.</span>isnull()) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;Surname&#39;</span>]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x:x <span style="color:#f92672">in</span> Survived_list)),\
             [<span style="color:#e6db74">&#39;Sex&#39;</span>,<span style="color:#e6db74">&#39;Age&#39;</span>,<span style="color:#e6db74">&#39;Title&#39;</span>]] <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;female&#39;</span>,<span style="color:#ae81ff">5.0</span>,<span style="color:#e6db74">&#39;Mrs&#39;</span>]

<span style="color:#75715e"># ----------- Fare -------------</span>
<span style="color:#75715e"># Fill in missing values with the average of Embarked=&#39;S&#39;, Pclass=3</span>
fare<span style="color:#f92672">=</span>df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;Embarked&#39;</span>] <span style="color:#f92672">==</span><span style="color:#e6db74">&#39;S&#39;</span>) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;Pclass&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>),<span style="color:#e6db74">&#39;Fare&#39;</span>]<span style="color:#f92672">.</span>median()
df[<span style="color:#e6db74">&#39;Fare&#39;</span>]<span style="color:#f92672">=</span>df[<span style="color:#e6db74">&#39;Fare&#39;</span>]<span style="color:#f92672">.</span>fillna(fare)

<span style="color:#75715e"># ----------- Family -------------</span>
Grouping <span style="color:#66d9ef">with</span> <span style="color:#75715e"># Family = SibSp + Parch + 1 as a feature</span>
df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">=</span>df[<span style="color:#e6db74">&#39;SibSp&#39;</span>]<span style="color:#f92672">+</span>df[<span style="color:#e6db74">&#39;Parch&#39;</span>]<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">4</span>),<span style="color:#e6db74">&#39;Family_label&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">5</span>) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">7</span>) <span style="color:#f92672">|</span> (df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>),<span style="color:#e6db74">&#39;Family_label&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e"># == Note</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;Family&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">8</span>),<span style="color:#e6db74">&#39;Family_label&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

<span style="color:#75715e"># ----------- Ticket ----------------</span>
<span style="color:#75715e"># How many people with the same ticket number are extracted as feature quantities</span>
Ticket_Count <span style="color:#f92672">=</span> dict(df[<span style="color:#e6db74">&#39;Ticket&#39;</span>]<span style="color:#f92672">.</span>value_counts())
df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Ticket&#39;</span>]<span style="color:#f92672">.</span>map(Ticket_Count)
sns<span style="color:#f92672">.</span>barplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;TicketGroup&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Survived&#39;</span>, data<span style="color:#f92672">=</span>df, palette<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Set3&#39;</span>)
plt<span style="color:#f92672">.</span>show()

<span style="color:#75715e"># Group by survival rate to 3</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>]<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">4</span>),<span style="color:#e6db74">&#39;Ticket_label&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">5</span>) <span style="color:#f92672">&amp;</span> (df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>]<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">|</span> (df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>),<span style="color:#e6db74">&#39;Ticket_label&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
df<span style="color:#f92672">.</span>loc[(df[<span style="color:#e6db74">&#39;TicketGroup&#39;</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">11</span>),<span style="color:#e6db74">&#39;Ticket_label&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
sns<span style="color:#f92672">.</span>barplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Ticket_label&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Survived&#39;</span>, data<span style="color:#f92672">=</span>df, palette<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Set3&#39;</span>)
plt<span style="color:#f92672">.</span>show()

<span style="color:#75715e"># ------------- Cabin ----------------</span>
The first character of <span style="color:#75715e"># Cabin is the feature value (missing value is U ).</span>
df[<span style="color:#e6db74">&#39;Cabin&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Cabin&#39;</span>]<span style="color:#f92672">.</span>fillna(<span style="color:#e6db74">&#39;Unknown&#39;</span>)
df[<span style="color:#e6db74">&#39;Cabin_label&#39;</span>]<span style="color:#f92672">=</span>df[<span style="color:#e6db74">&#39;Cabin&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>get(<span style="color:#ae81ff">0</span>)
sns<span style="color:#f92672">.</span>barplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Cabin_label&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Survived&#39;</span>, data<span style="color:#f92672">=</span>df, palette<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Set3&#39;</span>)
plt<span style="color:#f92672">.</span>show()

<span style="color:#75715e"># ---------- Embarked ---------------</span>
<span style="color:#75715e"># Complement missing values with S</span>
df[<span style="color:#e6db74">&#39;Embarked&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Embarked&#39;</span>]<span style="color:#f92672">.</span>fillna(<span style="color:#e6db74">&#39;S&#39;</span>)

<span style="color:#75715e"># ------------- Preprocessing ---------------</span>
<span style="color:#75715e"># Specify the item to be used for estimation</span>
df <span style="color:#f92672">=</span> df[[<span style="color:#e6db74">&#39;Survived&#39;</span>,<span style="color:#e6db74">&#39;Pclass&#39;</span>,<span style="color:#e6db74">&#39;Sex&#39;</span>,<span style="color:#e6db74">&#39;Age&#39;</span>,<span style="color:#e6db74">&#39;Fare&#39;</span>,<span style="color:#e6db74">&#39;Embarked&#39;</span>,<span style="color:#e6db74">&#39;Title&#39;</span>,<span style="color:#e6db74">&#39;Family_label&#39;</span>,<span style="color:#e6db74">&#39;Cabin_label&#39;</span>,<span style="color:#e6db74">&#39;Ticket_label&#39;</span>]]

<span style="color:#75715e">#One-hot encoding of label features</span>
df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>get_dummies(df)

<span style="color:#75715e"># Split dataset into train and test</span>
train <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;Survived&#39;</span>]<span style="color:#f92672">.</span>notnull()]
test <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;Survived&#39;</span>]<span style="color:#f92672">.</span>isnull()]<span style="color:#f92672">.</span>drop(<span style="color:#e6db74">&#39;Survived&#39;</span>,axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

<span style="color:#75715e"># Convert dataframe to numpy</span>
X <span style="color:#f92672">=</span> train<span style="color:#f92672">.</span>values[:,<span style="color:#ae81ff">1</span>:]
y <span style="color:#f92672">=</span> train<span style="color:#f92672">.</span>values[:,<span style="color:#ae81ff">0</span>]
test_x <span style="color:#f92672">=</span> test<span style="color:#f92672">.</span>values

<span style="color:#75715e"># ----------- Estimated model construction ---------------</span>
<span style="color:#f92672">from</span> sklearn.feature_selection <span style="color:#f92672">import</span> SelectKBest
<span style="color:#f92672">from</span> sklearn.ensemble <span style="color:#f92672">import</span> RandomForestClassifier
<span style="color:#f92672">from</span> sklearn.pipeline <span style="color:#f92672">import</span> make_pipeline
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> cross_validate

<span style="color:#75715e"># Reduce the number of features to be used from 25 to 20</span>
select <span style="color:#f92672">=</span> SelectKBest(k <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>)

clf <span style="color:#f92672">=</span> RandomForestClassifier(random_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>,
                             warm_start <span style="color:#f92672">=</span> True, <span style="color:#75715e"># add training to already fitted model</span>
                             n_estimators <span style="color:#f92672">=</span> <span style="color:#ae81ff">26</span>,
                             max_depth <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>,
                             max_features <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sqrt&#39;</span>)
pipeline <span style="color:#f92672">=</span> make_pipeline(select, clf)
pipeline<span style="color:#f92672">.</span>fit(X, y)

<span style="color:#75715e"># View fit results</span>
cv_result <span style="color:#f92672">=</span> cross_validate(pipeline, X, y, cv<span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;mean_score =&#39;</span>, np<span style="color:#f92672">.</span>mean(cv_result[<span style="color:#e6db74">&#39;test_score&#39;</span>]))
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;mean_std =&#39;</span>, np<span style="color:#f92672">.</span>std(cv_result[<span style="color:#e6db74">&#39;test_score&#39;</span>]))

<span style="color:#75715e"># -------- Adopted feature quantity ---------------</span>
<span style="color:#75715e"># Adoption status</span>
mask<span style="color:#f92672">=</span> select<span style="color:#f92672">.</span>get_support()

<span style="color:#75715e"># List of items</span>
list_col <span style="color:#f92672">=</span> list(df<span style="color:#f92672">.</span>columns[<span style="color:#ae81ff">1</span>:])

<span style="color:#75715e">#List of approval/disapproval by item</span>
<span style="color:#66d9ef">for</span> i, j <span style="color:#f92672">in</span> enumerate(list_col):
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;No&#39;</span><span style="color:#f92672">+</span>str(i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>), j,<span style="color:#e6db74">&#39;=&#39;</span>, mask[i])

<span style="color:#75715e">#Check the shape</span>
X_selected <span style="color:#f92672">=</span> select<span style="color:#f92672">.</span>transform(X)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;X.shape={}, X_selected.shape={}&#39;</span><span style="color:#f92672">.</span>format(X<span style="color:#f92672">.</span>shape, X_selected<span style="color:#f92672">.</span>shape))

<span style="color:#75715e"># ----- Create Submit data -------</span>
PassengerId<span style="color:#f92672">=</span>test_data[<span style="color:#e6db74">&#39;PassengerId&#39;</span>]
predictions <span style="color:#f92672">=</span> pipeline<span style="color:#f92672">.</span>predict(test_x)
submission <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#34;PassengerId&#34;</span>: PassengerId, <span style="color:#e6db74">&#34;Survived&#34;</span>: predictions<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>int32)})
submission<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">&#34;my_submission.csv&#34;</span>, index<span style="color:#f92672">=</span>False)
</code></pre></div>
    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
