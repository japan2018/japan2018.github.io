<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://japan2018.github.io/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://japan2018.github.io/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://japan2018.github.io/favicon-16x16.png">

  
  <link rel="manifest" href="https://japan2018.github.io/site.webmanifest">

  
  <link rel="mask-icon" href="https://japan2018.github.io/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://japan2018.github.io/css/bootstrap.min.css" />

  
  <title>Beginners want to make a Rubik&#39;s Cube style thing in UE4 and make it a library for reinforcement learning #6 | Some Title</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Beginners want to make a Rubik&rsquo;s Cube style thing in UE4 and make it a library for reinforcement learning #6</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 2, 2019
  </small>
  

<small><code><a href="https://japan2018.github.io/tags/python">Python</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/beginner"> Beginner</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/python3"> Python3</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/ue4"> UE4</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/unrealengine"> UnrealEngine</a></code></small>

</p>
<pre><code>Continuing from the previous article, this article is about how beginners can make various Python libraries that involve UE4 (almost as a memorandum for themselves...).
</code></pre>
<p>First: <a href="https://qiita.com/simonritchie/items/e8d84c2941b5bd2862f5">#1</a>
Last time: <a href="https://qiita.com/simonritchie/items/f276a207da295e4ca581">#5</a></p>
<h2 id="observation-we-will-implement-around">Observation We will implement around</h2>
<p>I will write the control processing around the observed value.
Basically, it is necessary to perform processing such as saving after the action, and the column of the action ID is prepared in the prepared SQLite table, so we will add the place to connect with BP to the action module ( I also thought about adding a module that uses PyActor for Observation separately, but I will add it to the action because cooperation with action relations becomes useless and complicated).
However, for the processing where BP is not involved, prepare a general-purpose module separately and describe it there.</p>
<p>Add the process to get the world-based coordinates of the orange plane to BP_Action. We&rsquo;ve already added the process of getting coordinates to a previous article, so it&rsquo;s mostly just an interface here. For the time being, only the orange side is supported, and we will proceed after checking the others.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/3da3bd08-4d72-d864-5f5c-2d0f3415628e.png" alt="image.png"></p>
<p>In the Python class, prepare a function to connect to the BP function prepared earlier.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py:Content\Scripts\action.py" data-lang="py:Content\Scripts\action.py">    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_orange_plane_world_locations</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">        Acquire each coordinate value of the world standard of the orange plane.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Returns
</span><span style="color:#e6db74">        ----------
</span><span style="color:#e6db74">        x_list: list of int
</span><span style="color:#e6db74">            A list of world-based X coordinates.
</span><span style="color:#e6db74">        y_list: list of int
</span><span style="color:#e6db74">            A list of world-based Y coordinates.
</span><span style="color:#e6db74">        z_list: list of int
</span><span style="color:#e6db74">            A list of world-based Z coordinates.
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        x_list, y_list, z_list <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>uobject<span style="color:#f92672">.</span>getOrangePlaneWorldLocations()
        <span style="color:#66d9ef">return</span> x_list, y_list, z_list
</code></pre></div><p>In addition, we will add a module called observation_utils.py, and add constant definitions and general-purpose functions there (only a part of it is listed because it is long in all aspects).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py:Plugins\UnrealEnginePython\Binaries\Win64\common\observation_utils.py" data-lang="py:Plugins\UnrealEnginePython\Binaries\Win64\common\observation_utils.py"><span style="color:#e6db74">&#34;&#34;&#34; A module that describes common processing related to observation values.
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

<span style="color:#f92672">from</span> common <span style="color:#f92672">import</span> sqlite_utils


<span style="color:#75715e"># ------------------------------------------------- ----------------------</span>
<span style="color:#75715e">#Define the coordinate value of the front plane.</span>

FRONT_POS_X_1_1 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">151</span>
FRONT_POS_X_2_1 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">151</span>
FRONT_POS_X_3_1 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">151</span>
FRONT_POS_X_1_2 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">151</span>
FRONT_POS_X_2_2 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">151</span>
FRONT_POS_X_3_2 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">151</span>
FRONT_POS_X_1_3 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">151</span>
FRONT_POS_X_2_3 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">151</span>
FRONT_POS_X_3_3 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">151</span>

FRONT_POS_X_LIST <span style="color:#f92672">=</span> [
    FRONT_POS_X_1_1,
    FRONT_POS_X_2_1,
    FRONT_POS_X_3_1,
    FRONT_POS_X_1_2,
    FRONT_POS_X_2_2,
    FRONT_POS_X_3_2,
    FRONT_POS_X_1_3,
    FRONT_POS_X_2_3,
    FRONT_POS_X_3_3,
]

FRONT_POS_Y_1_1 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>
FRONT_POS_Y_2_1 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>
FRONT_POS_Y_3_1 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>
FRONT_POS_Y_1_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
FRONT_POS_Y_2_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
FRONT_POS_Y_3_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
FRONT_POS_Y_1_3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
FRONT_POS_Y_2_3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
FRONT_POS_Y_3_3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>

FRONT_POS_Y_LIST <span style="color:#f92672">=</span> [
    FRONT_POS_Y_1_1,
    FRONT_POS_Y_2_1,
    FRONT_POS_Y_3_1,
    FRONT_POS_Y_1_2,
    FRONT_POS_Y_2_2,
    FRONT_POS_Y_3_2,
    FRONT_POS_Y_1_3,
    FRONT_POS_Y_2_3,
    FRONT_POS_Y_3_3,
]

FRONT_POS_Z_1_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
FRONT_POS_Z_2_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
FRONT_POS_Z_3_1 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>
FRONT_POS_Z_1_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
FRONT_POS_Z_2_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
FRONT_POS_Z_3_2 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>
FRONT_POS_Z_1_3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
FRONT_POS_Z_2_3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
FRONT_POS_Z_3_3 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>

FRONT_POS_Z_LIST <span style="color:#f92672">=</span> [
    FRONT_POS_Z_1_1,
    FRONT_POS_Z_2_1,
    FRONT_POS_Z_3_1,
    FRONT_POS_Z_1_2,
    FRONT_POS_Z_2_2,
    FRONT_POS_Z_3_2,
    FRONT_POS_Z_1_3,
    FRONT_POS_Z_2_3,
    FRONT_POS_Z_3_3,
]


<span style="color:#75715e"># ------------------------------------------------- ----------------------</span>
<span style="color:#75715e">#Define the coordinate value of the left plane.</span>

LEFT_POS_X_1_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
LEFT_POS_X_2_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
LEFT_POS_X_3_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
LEFT_POS_X_1_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
LEFT_POS_X_2_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
LEFT_POS_X_3_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
LEFT_POS_X_1_3 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>
LEFT_POS_X_2_3 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>
LEFT_POS_X_3_3 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>
<span style="color:#f92672">...</span>


<span style="color:#75715e"># ------------------------------------------------- ----------------------</span>
<span style="color:#75715e"># Class definition of position coordinates and position type values.</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_PositionAndPositionNumLists</span>:

    <span style="color:#66d9ef">def</span> __init__(
            self, pos_x_list, pos_y_list, pos_z_list, position_num_list):
        <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">        A class that has a list of the coordinates of each plane and the type value of the position associated with it as an attribute.
</span><span style="color:#e6db74">        The contents of the index of each list must match.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Parameters
</span><span style="color:#e6db74">        ----------
</span><span style="color:#e6db74">        pos_x_list: list of int
</span><span style="color:#e6db74">            A list of X coordinates of the plane of interest.
</span><span style="color:#e6db74">        pos_y_list: list of int
</span><span style="color:#e6db74">            A list of Y coordinates of the plane of interest.
</span><span style="color:#e6db74">        pos_z_list: list of int
</span><span style="color:#e6db74">            A list of Z coordinates of the plane of interest.
</span><span style="color:#e6db74">        position_num_list: list of int
</span><span style="color:#e6db74">            A list that stores the type value of the target position.
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        self<span style="color:#f92672">.</span>pos_x_list <span style="color:#f92672">=</span> pos_x_list
        self<span style="color:#f92672">.</span>pos_y_list <span style="color:#f92672">=</span> pos_y_list
        self<span style="color:#f92672">.</span>pos_z_list <span style="color:#f92672">=</span> pos_z_list
        self<span style="color:#f92672">.</span>position_num_list <span style="color:#f92672">=</span> position_num_list


FRONT_POS_AND_POS_NUM_LISTS <span style="color:#f92672">=</span> _PositionAndPositionNumLists(
    pos_x_list<span style="color:#f92672">=</span>FRONT_POS_X_LIST,
    pos_y_list<span style="color:#f92672">=</span>FRONT_POS_Y_LIST,
    pos_z_list<span style="color:#f92672">=</span>FRONT_POS_Z_LIST,
    position_num_list<span style="color:#f92672">=</span>sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_LIST,
)

LEFT_POS_AND_POS_NUM_LISTS <span style="color:#f92672">=</span> _PositionAndPositionNumLists(
    pos_x_list<span style="color:#f92672">=</span>LEFT_POS_X_LIST,
    pos_y_list<span style="color:#f92672">=</span>LEFT_POS_Y_LIST,
    pos_z_list<span style="color:#f92672">=</span>LEFT_POS_Z_LIST,
    position_num_list<span style="color:#f92672">=</span>sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_LEFT_LIST)

RIGHT_POS_AND_POS_NUM_LISTS <span style="color:#f92672">=</span> _PositionAndPositionNumLists(
    pos_x_list<span style="color:#f92672">=</span>RIGHT_POS_X_LIST,
    pos_y_list<span style="color:#f92672">=</span>RIGHT_POS_Y_LIST,
    pos_z_list<span style="color:#f92672">=</span>RIGHT_POS_Z_LIST,
    position_num_list<span style="color:#f92672">=</span>sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_RIGHT_LIST)

TOP_POS_AND_POS_NUM_LISTS <span style="color:#f92672">=</span> _PositionAndPositionNumLists(
    pos_x_list<span style="color:#f92672">=</span>TOP_POS_X_LIST,
    pos_y_list<span style="color:#f92672">=</span>TOP_POS_Y_LIST,
    pos_z_list<span style="color:#f92672">=</span>TOP_POS_Z_LIST,
    position_num_list<span style="color:#f92672">=</span>sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_TOP_LIST)

BACK_POS_AND_POS_NUM_LISTS <span style="color:#f92672">=</span> _PositionAndPositionNumLists(
    pos_x_list<span style="color:#f92672">=</span>BACK_POS_X_LIST,
    pos_y_list<span style="color:#f92672">=</span>BACK_POS_Y_LIST,
    pos_z_list<span style="color:#f92672">=</span>BACK_POS_Z_LIST,
    position_num_list<span style="color:#f92672">=</span>sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_BACK_LIST)BOTTOM_POS_AND_POS_NUM_LISTS <span style="color:#f92672">=</span> _PositionAndPositionNumLists(
    pos_x_list<span style="color:#f92672">=</span>BOTTOM_POS_X_LIST,
    pos_y_list<span style="color:#f92672">=</span>BOTTOM_POS_Y_LIST,
    pos_z_list<span style="color:#f92672">=</span>BOTTOM_POS_Z_LIST,
    position_num_list<span style="color:#f92672">=</span>sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_BOTTOM_LIST)

POS_AND_POS_NUM_LISTS <span style="color:#f92672">=</span> [
    FRONT_POS_AND_POS_NUM_LISTS,
    LEFT_POS_AND_POS_NUM_LISTS,
    RIGHT_POS_AND_POS_NUM_LISTS,
    TOP_POS_AND_POS_NUM_LISTS,
    BACK_POS_AND_POS_NUM_LISTS,
    BOTTOM_POS_AND_POS_NUM_LISTS,
]


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_position_num_by_world_location</span>(world_x, world_y, world_z):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Acquires the position type value according to the world standard coordinates.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Parameters
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    world_x: int
</span><span style="color:#e6db74">        The world-referenced X coordinate of the target.
</span><span style="color:#e6db74">    world_y :int
</span><span style="color:#e6db74">        World-based Y coordinate of the target.
</span><span style="color:#e6db74">    world_z :int
</span><span style="color:#e6db74">        World Z coordinate of the target.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    position_num: int
</span><span style="color:#e6db74">        Type value of the target position. A value from 1 to 54, if applicable
</span><span style="color:#e6db74">        Is set.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Raises
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    ValueError
</span><span style="color:#e6db74">        If the corresponding coordinate definition does not exist.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">for</span> unit_pos_and_pos_num_lists <span style="color:#f92672">in</span> POS_AND_POS_NUM_LISTS:
        pos_x_list <span style="color:#f92672">=</span> unit_pos_and_pos_num_lists<span style="color:#f92672">.</span>pos_x_list
        pos_y_list <span style="color:#f92672">=</span> unit_pos_and_pos_num_lists<span style="color:#f92672">.</span>pos_y_list
        pos_z_list <span style="color:#f92672">=</span> unit_pos_and_pos_num_lists<span style="color:#f92672">.</span>pos_z_list
        <span style="color:#66d9ef">for</span> i, (pos_x, pos_y, pos_z) <span style="color:#f92672">in</span> \
                enumerate(zip(pos_x_list, pos_y_list, pos_z_list)):
            <span style="color:#66d9ef">if</span> pos_x <span style="color:#f92672">!=</span> world_x <span style="color:#f92672">or</span> pos_y <span style="color:#f92672">!=</span> world_y <span style="color:#f92672">or</span> pos_z <span style="color:#f92672">!=</span> world_z:
                <span style="color:#66d9ef">continue</span>
            position_num <span style="color:#f92672">=</span> unit_pos_and_pos_num_lists<span style="color:#f92672">.</span>position_num_list[i]
            <span style="color:#66d9ef">return</span> position_num
    err_msg <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;No corresponding coordinate definition exists. X: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, Y: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, Z: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span>\
        <span style="color:#f92672">%</span> (world_x, world_y, world_z)
    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(err_msg)

</code></pre></div><p>I added a lot of constant definitions, but I tend to inadvertently make mistakes in the values, so I will add a check process to the test.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py:Plugins\UnrealEnginePython\Binaries\Win64\common\tests\test_observation_utils.py" data-lang="py:Plugins\UnrealEnginePython\Binaries\Win64\common\tests\test_observation_utils.py"><span style="color:#e6db74">&#34;&#34;&#34;A module for testing the observation_utils module.
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

<span style="color:#f92672">import</span> importlib
<span style="color:#f92672">import</span> inspect
<span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> defaultdict

<span style="color:#f92672">from</span> nose.tools <span style="color:#f92672">import</span> assert_equal, assert_raises

<span style="color:#f92672">from</span> common <span style="color:#f92672">import</span> observation_utils

importlib<span style="color:#f92672">.</span>reload(observation_utils)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_check_all_values_are_same</span>(target_list, const_prefix, expected_val):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    The constant with the desired prefix and the value of the list of constants are
</span><span style="color:#e6db74">    Confirm that
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Parameters
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    target_list: list of int
</span><span style="color:#e6db74">        An array containing the coordinates to be checked.
</span><span style="color:#e6db74">    const_prefix: str
</span><span style="color:#e6db74">        Prefix for constant name.
</span><span style="color:#e6db74">    expected_val: int
</span><span style="color:#e6db74">        The assumed coordinate value.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Raises
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    AssertionError
</span><span style="color:#e6db74">        -When the value in the target list is not the expected value.
</span><span style="color:#e6db74">        -When the constant of the target prefix is not the expected value.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">for</span> pos_val <span style="color:#f92672">in</span> target_list:
        assert_equal(pos_val, expected_val)
    members <span style="color:#f92672">=</span> inspect<span style="color:#f92672">.</span>getmembers(observation_utils)
    <span style="color:#66d9ef">for</span> obj_name, obj_val <span style="color:#f92672">in</span> members:
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> obj_name<span style="color:#f92672">.</span>startswith(const_prefix):
            <span style="color:#66d9ef">continue</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> <span style="color:#f92672">is</span> instance(obj_val, int):
            <span style="color:#66d9ef">continue</span>
        assert_equal(obj_val, expected_val)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_check_values_are_three_sequence</span>(
        target_list, const_prefix, expected_three_vals):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    The value of the target constant list is the same three consecutive values
</span><span style="color:#e6db74">    And the value of the constant of the specified prefix is three assumed values and three each
</span><span style="color:#e6db74">    Check that it exists.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Parameters
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    target_list: list of int
</span><span style="color:#e6db74">        An array containing the coordinates to be checked.
</span><span style="color:#e6db74">    const_prefix: str
</span><span style="color:#e6db74">        Prefix for constant name.
</span><span style="color:#e6db74">    expected_three_vals: list of int
</span><span style="color:#e6db74">        A list of three possible values.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Raises
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    AssertionError
</span><span style="color:#e6db74">        -If the values in the list are not three consecutive expected values.
</span><span style="color:#e6db74">        -A constant with the specified prefix, three of the expected three
</span><span style="color:#e6db74">            If not a value.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">for</span> pos_val <span style="color:#f92672">in</span> target_list[:<span style="color:#ae81ff">3</span>]:
        assert_equal(
            pos_val, expected_three_vals[<span style="color:#ae81ff">0</span>],
        )
    <span style="color:#66d9ef">for</span> pos_val <span style="color:#f92672">in</span> target_list[<span style="color:#ae81ff">3</span>:<span style="color:#ae81ff">6</span>]:
        assert_equal(
            pos_val, expected_three_vals[<span style="color:#ae81ff">1</span>],
        )
    <span style="color:#66d9ef">for</span> pos_val <span style="color:#f92672">in</span> target_list[<span style="color:#ae81ff">6</span>:<span style="color:#ae81ff">9</span>]:
        assert_equal(
            pos_val, expected_three_vals[<span style="color:#ae81ff">2</span>],
        )
    _check_target_prefix_const_are_three_vals(
        const_prefix<span style="color:#f92672">=</span>const_prefix,
        expected_three_vals<span style="color:#f92672">=</span>expected_three_vals)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_check_target_prefix_const_are_three_vals</span>(
        const_prefix, expected_three_vals):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Each value of the constant with the prefix of interest becomes three values of three
</span><span style="color:#e6db74">    Confirm that
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Parameters
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    const_prefix: str
</span><span style="color:#e6db74">        Prefix for constant name.
</span><span style="color:#e6db74">    expected_three_vals: list of int
</span><span style="color:#e6db74">        A list of three possible values.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    count_dict <span style="color:#f92672">=</span> defaultdict(int)
    members <span style="color:#f92672">=</span> inspect<span style="color:#f92672">.</span>getmembers(observation_utils)
    <span style="color:#66d9ef">for</span> obj_name, obj_val <span style="color:#f92672">in</span> members:
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> obj_name<span style="color:#f92672">.</span>startswith(const_prefix):
            <span style="color:#66d9ef">continue</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> <span style="color:#f92672">is</span> instance(obj_val, int):
            <span style="color:#66d9ef">continue</span>
        count_dict[obj_val] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">for</span> expected_val <span style="color:#f92672">in</span> expected_three_vals:
        assert_equal(count_dict[expected_val], <span style="color:#ae81ff">3</span>)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_check_values_are_repeated_three_values</span>(
        target_list, const_prefix, expected_three_vals):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    The value of the target constant list repeats three times (eg: 1, 2, 3, 1, 2, 3, ...)
</span><span style="color:#e6db74">    And that the value of the specified prefix constant is three expected values.
</span><span style="color:#e6db74">    Check that there are 3 cases each.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Parameters
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    target_list: list of int
</span><span style="color:#e6db74">        An array containing the coordinates to be checked.
</span><span style="color:#e6db74">    const_prefix: str
</span><span style="color:#e6db74">        Prefix for constant name.
</span><span style="color:#e6db74">    expected_three_vals: list of int
</span><span style="color:#e6db74">        A list of three possible values.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Raises
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    AssertionError
</span><span style="color:#e6db74">        -If the value in the list is not a repeat of three values.
</span><span style="color:#e6db74">        -A constant with the specified prefix, three of the expected three
</span><span style="color:#e6db74">            If not a value.&#34;&#34;&#34;</span>
    assert_equal(
        target_list[:<span style="color:#ae81ff">3</span>],
        expected_three_vals,
    )
    assert_equal(
        target_list[<span style="color:#ae81ff">3</span>:<span style="color:#ae81ff">6</span>],
        expected_three_vals,
    )
    assert_equal(
        target_list[<span style="color:#ae81ff">6</span>:<span style="color:#ae81ff">9</span>],
        expected_three_vals,
    )
    _check_target_prefix_const_are_three_vals(
        const_prefix<span style="color:#f92672">=</span>const_prefix,
        expected_three_vals<span style="color:#f92672">=</span>expected_three_vals)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_front_pos_const</span>():
    _check_all_values_are_same(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>FRONT_POS_X_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;FRONT_POS_X_&#39;</span>,
        expected_val<span style="color:#f92672">=-</span><span style="color:#ae81ff">151</span>)
    _check_values_are_three_sequence(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>FRONT_POS_Y_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;FRONT_POS_Y_&#39;</span>,
        expected_three_vals<span style="color:#f92672">=</span>[<span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">100</span>])
    _check_values_are_repeated_three_values(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>FRONT_POS_Z_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;FRONT_POS_Z_&#39;</span>,
        expected_three_vals<span style="color:#f92672">=</span>[<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>])


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_left_pos_const</span>():
    _check_values_are_three_sequence(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>LEFT_POS_X_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;LEFT_POS_X_&#39;</span>,
        expected_three_vals<span style="color:#f92672">=</span>[<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>])
    _check_all_values_are_same(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>LEFT_POS_Y_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;LEFT_POS_Y_&#39;</span>,
        expected_val<span style="color:#f92672">=-</span><span style="color:#ae81ff">151</span>)
    _check_values_are_repeated_three_values(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>LEFT_POS_Z_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;LEFT_POS_Z_&#39;</span>,
        expected_three_vals<span style="color:#f92672">=</span>[<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>])


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_right_pos_const</span>():
    _check_values_are_three_sequence(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>RIGHT_POS_X_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RIGHT_POS_X_&#39;</span>,
        expected_three_vals<span style="color:#f92672">=</span>[<span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">100</span>])
    _check_all_values_are_same(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>RIGHT_POS_Y_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RIGHT_POS_Y_&#39;</span>,
        expected_val<span style="color:#f92672">=</span><span style="color:#ae81ff">151</span>)
    _check_values_are_repeated_three_values(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>RIGHT_POS_Z_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;RIGHT_POS_Z_&#39;</span>,
        expected_three_vals<span style="color:#f92672">=</span>[<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>])


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_top_pos_const</span>():
    _check_values_are_repeated_three_values(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>TOP_POS_X_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;TOP_POS_X_&#39;</span>,
        expected_three_vals<span style="color:#f92672">=</span>[<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>])
    _check_values_are_three_sequence(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>TOP_POS_Y_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;TOP_POS_Y_&#39;</span>,
        expected_three_vals<span style="color:#f92672">=</span>[<span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">100</span>])
    _check_all_values_are_same(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>TOP_POS_Z_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;TOP_POS_Z_&#39;</span>,
        expected_val<span style="color:#f92672">=</span><span style="color:#ae81ff">151</span>)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_back_pos_const</span>():
    _check_all_values_are_same(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>BACK_POS_X_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;BACK_POS_X_&#39;</span>,
        expected_val<span style="color:#f92672">=</span><span style="color:#ae81ff">151</span>)
    _check_values_are_three_sequence(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>BACK_POS_Y_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;BACK_POS_Y_&#39;</span>,
        expected_three_vals<span style="color:#f92672">=</span>[<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>])
    _check_values_are_repeated_three_values(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>BACK_POS_Z_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;BACK_POS_Z_&#39;</span>,
        expected_three_vals<span style="color:#f92672">=</span>[<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>])


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_bottom_post_const</span>():
    _check_values_are_repeated_three_values(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>BOTTOM_POS_X_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;BOTTOM_POS_X_&#39;</span>,
        expected_three_vals<span style="color:#f92672">=</span>[<span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">100</span>])
    _check_values_are_three_sequence(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>BOTTOM_POS_Y_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;BOTTOM_POS_Y_&#39;</span>,
        expected_three_vals<span style="color:#f92672">=</span>[<span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">100</span>])
    _check_all_values_are_same(
        target_list<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>BOTTOM_POS_Z_LIST,
        const_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;BOTTOM_POS_Z_&#39;</span>,
        expected_val<span style="color:#f92672">=-</span><span style="color:#ae81ff">151</span>)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_target_name_obj</span>(obj_name, module_obj):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    指定された名前のオブジェクトをobservation_utils.pyモジュールから
</span><span style="color:#e6db74">    取得する。
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Parameters
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    obj_name : str
</span><span style="color:#e6db74">        取得対象のオブジェクト名。
</span><span style="color:#e6db74">    module_obj : module
</span><span style="color:#e6db74">        検索対象のモジュール。
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    obj_val : *
</span><span style="color:#e6db74">        取得されたオブジェクト。
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Raises
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    ValueError
</span><span style="color:#e6db74">        対象の名前のオブジェクトがモジュール内に存在しない場合。
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    members <span style="color:#f92672">=</span> inspect<span style="color:#f92672">.</span>getmembers(module_obj)
    <span style="color:#66d9ef">for</span> member_name, obj_val <span style="color:#f92672">in</span> members:
        <span style="color:#66d9ef">if</span> member_name <span style="color:#f92672">!=</span> obj_name:
            <span style="color:#66d9ef">continue</span>
        <span style="color:#66d9ef">return</span> obj_val
    err_msg <span style="color:#f92672">=</span> \
        <span style="color:#e6db74">&#39;指定された名前のオブジェクトがモジュール内に存在しません : </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span>\
        <span style="color:#f92672">%</span> obj_name
    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(err_msg)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_pos_and_pos_num_lists</span>():
    const_type_str_key_lists_dict <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;FRONT&#39;</span>: observation_utils<span style="color:#f92672">.</span>FRONT_POS_AND_POS_NUM_LISTS,
        <span style="color:#e6db74">&#39;LEFT&#39;</span>: observation_utils<span style="color:#f92672">.</span>LEFT_POS_AND_POS_NUM_LISTS,
        <span style="color:#e6db74">&#39;RIGHT&#39;</span>: observation_utils<span style="color:#f92672">.</span>RIGHT_POS_AND_POS_NUM_LISTS,
        <span style="color:#e6db74">&#39;TOP&#39;</span>: observation_utils<span style="color:#f92672">.</span>TOP_POS_AND_POS_NUM_LISTS,
        <span style="color:#e6db74">&#39;BACK&#39;</span>: observation_utils<span style="color:#f92672">.</span>BACK_POS_AND_POS_NUM_LISTS,
        <span style="color:#e6db74">&#39;BOTTOM&#39;</span>: observation_utils<span style="color:#f92672">.</span>BOTTOM_POS_AND_POS_NUM_LISTS,
    }
    <span style="color:#66d9ef">for</span> const_type_str, lists_obj <span style="color:#f92672">in</span> const_type_str_key_lists_dict<span style="color:#f92672">.</span>items():
        expected_pos_x_list <span style="color:#f92672">=</span> _get_target_name_obj(
            obj_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_POS_X_LIST&#39;</span> <span style="color:#f92672">%</span> const_type_str,
            module_obj<span style="color:#f92672">=</span>observation_utils)
        expected_pos_y_list <span style="color:#f92672">=</span> _get_target_name_obj(obj_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_POS_Y_LIST&#39;</span> <span style="color:#f92672">%</span> const_type_str,
            module_obj<span style="color:#f92672">=</span>observation_utils)
        expected_pos_z_list <span style="color:#f92672">=</span> _get_target_name_obj(
            obj_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_POS_Z_LIST&#39;</span> <span style="color:#f92672">%</span> const_type_str,
            module_obj<span style="color:#f92672">=</span>observation_utils)
        expected_position_num_list <span style="color:#f92672">=</span> _get_target_name_obj(
            obj_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;POSITION_NUM_</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_LIST&#39;</span> <span style="color:#f92672">%</span> const_type_str,
            module_obj<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>sqlite_utils)

        assert_equal(
            lists_obj<span style="color:#f92672">.</span>pos_x_list,
            expected_pos_x_list,
        )
        assert_equal(
            lists_obj<span style="color:#f92672">.</span>pos_y_list,
            expected_pos_y_list,
        )
        assert_equal(
            lists_obj<span style="color:#f92672">.</span>pos_z_list,
            expected_pos_z_list,
        )
        assert_equal(
            lists_obj<span style="color:#f92672">.</span>position_num_list,
            expected_position_num_list,
        )


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_get_position_num_by_world_location</span>():

    <span style="color:#75715e"># 定義が存在する組み合わせを指定した際の挙動を確認する。</span>
    position_num <span style="color:#f92672">=</span> observation_utils<span style="color:#f92672">.</span>get_position_num_by_world_location(
        world_x<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>FRONT_POS_X_2_2,
        world_y<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>FRONT_POS_Y_2_2,
        world_z<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>FRONT_POS_Z_2_2)
    assert_equal(
        position_num,
        observation_utils<span style="color:#f92672">.</span>sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_2_2,
    )
    position_num <span style="color:#f92672">=</span> observation_utils<span style="color:#f92672">.</span>get_position_num_by_world_location(
        world_x<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>BOTTOM_POS_X_3_3,
        world_y<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>BOTTOM_POS_Y_3_3,
        world_z<span style="color:#f92672">=</span>observation_utils<span style="color:#f92672">.</span>BOTTOM_POS_Z_3_3)
    assert_equal(
        position_num,
        observation_utils<span style="color:#f92672">.</span>sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_BOTTOM_3_3,
    )

    <span style="color:#75715e"># 定義が存在しない座標を指定した際にエラーになることを確認する。</span>
    kwargs <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;world_x&#39;</span>: <span style="color:#ae81ff">100</span>,
        <span style="color:#e6db74">&#39;world_y&#39;</span>: <span style="color:#ae81ff">100</span>,
        <span style="color:#e6db74">&#39;world_z&#39;</span>: <span style="color:#ae81ff">100</span>,
    }
    assert_raises(
        <span style="color:#a6e22e">ValueError</span>,
        observation_utils<span style="color:#f92672">.</span>get_position_num_by_world_location,
        <span style="color:#f92672">**</span>kwargs
    )
</code></pre></div><p>これで平面座標と位置の種別の取得処理などができるようになったので、オレンジ面の座標の取得結果のテストを加えます。シャッフルなどの実行前の初期位置でチェックが実行されるので、一通りオレンジ面が前面判定になることを確認します。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py:Content\Scripts\action.py" data-lang="py:Content\Scripts\action.py">    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_get_orange_plane_world_locations</span>(self):
        x_list, y_list, z_list <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_orange_plane_world_locations()
        <span style="color:#66d9ef">for</span> x, y, z <span style="color:#f92672">in</span> zip(x_list, y_list, z_list):
            _check_position_num_is_in_list(
                x<span style="color:#f92672">=</span>x, y<span style="color:#f92672">=</span>y, z<span style="color:#f92672">=</span>z,
                expected_position_num_list<span style="color:#f92672">=</span>sqlite_utils<span style="color:#f92672">.</span>\
                    POSITION_NUM_FRONT_LIST)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_check_position_num_is_in_list</span>(x, y, z, expected_position_num_list):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    対象の座標の組み合わせによって算出される位置の種別値が、指定のリスト
</span><span style="color:#e6db74">    に含まれていることをチェックする。
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Parameters
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    x : int
</span><span style="color:#e6db74">        対象のワールド基準のX座標。
</span><span style="color:#e6db74">    y : int
</span><span style="color:#e6db74">        対象のワールド基準のY座標。
</span><span style="color:#e6db74">    z : int
</span><span style="color:#e6db74">        対象のワールド基準のZ座標。
</span><span style="color:#e6db74">    expected_position_num_list : list of int
</span><span style="color:#e6db74">        位置の種別値を格納している想定のリスト。
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Raises
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    AssertionError
</span><span style="color:#e6db74">        - もし算出された位置の種別値がリストに含まれていない場合。
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    position_num <span style="color:#f92672">=</span>  \
        observation_utils<span style="color:#f92672">.</span>get_position_num_by_world_location(
            world_x<span style="color:#f92672">=</span>x,
            world_y<span style="color:#f92672">=</span>y,
            world_z<span style="color:#f92672">=</span>z)
    is_in <span style="color:#f92672">=</span> position_num <span style="color:#f92672">in</span> expected_position_num_list
    assert_true(is_in)
</code></pre></div><p>実行してみて、テストで引っかからないことを確認し、他の色の平面に対してもBPの関数の追加 → action.pyに関数の追加 → テストの追加と進めておきます（割愛）。</p>
<h1 id="アクションの定数を共通モジュールに移動させる">アクションの定数を共通モジュールに移動させる</h1>
<p>PyActorで指定するモジュールだと、import上の問題がある（観測値関係などの他のモジュールから使いづらい）ため、action.pyに記載していた定数関係をcommon.action_utils.pyというパスでモジュールを用意してそちらに移動させておきます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py:Win64\common\action_utils.py" data-lang="py:Win64\common\action_utils.py"><span style="color:#e6db74">&#34;&#34;&#34;アクションに関連した共通の処理や定義などを記述したモジュール。
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

ACTION_ROTATE_X_LEFT_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
ACTION_ROTATE_X_LEFT_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
ACTION_ROTATE_X_LEFT_3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
ACTION_ROTATE_X_RIGHT_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>
ACTION_ROTATE_X_RIGHT_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
ACTION_ROTATE_X_RIGHT_3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>
ACTION_ROTATE_Y_UP_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
ACTION_ROTATE_Y_UP_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
ACTION_ROTATE_Y_UP_3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>
ACTION_ROTATE_Y_DOWN_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
ACTION_ROTATE_Y_DOWN_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>
ACTION_ROTATE_Y_DOWN_3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>
ACTION_ROTATE_Z_UP_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">13</span>
ACTION_ROTATE_Z_UP_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">14</span>
ACTION_ROTATE_Z_UP_3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>
ACTION_ROTATE_Z_DOWN_1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>
ACTION_ROTATE_Z_DOWN_2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">17</span>
ACTION_ROTATE_Z_DOWN_3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">18</span>
ACTION_RESET <span style="color:#f92672">=</span> <span style="color:#ae81ff">19</span>

ACTION_LIST <span style="color:#f92672">=</span> [
    ACTION_ROTATE_X_LEFT_1,
    ACTION_ROTATE_X_LEFT_2,
    ACTION_ROTATE_X_LEFT_3,
    ACTION_ROTATE_X_RIGHT_1,
    ACTION_ROTATE_X_RIGHT_2,
    ACTION_ROTATE_X_RIGHT_3,
    ACTION_ROTATE_Y_UP_1,
    ACTION_ROTATE_Y_UP_2,
    ACTION_ROTATE_Y_UP_3,
    ACTION_ROTATE_Y_DOWN_1,
    ACTION_ROTATE_Y_DOWN_2,
    ACTION_ROTATE_Y_DOWN_3,
    ACTION_ROTATE_Z_UP_1,
    ACTION_ROTATE_Z_UP_2,
    ACTION_ROTATE_Z_UP_3,
    ACTION_ROTATE_Z_DOWN_1,
    ACTION_ROTATE_Z_DOWN_2,
    ACTION_ROTATE_Z_DOWN_3,
    ACTION_RESET,
]

ACTION_KEY_FUNC_NAME_DICT <span style="color:#f92672">=</span> {
    ACTION_ROTATE_X_LEFT_1: <span style="color:#e6db74">&#39;rotateXLeft1&#39;</span>,
    ACTION_ROTATE_X_LEFT_2: <span style="color:#e6db74">&#39;rotateXLeft2&#39;</span>,
    ACTION_ROTATE_X_LEFT_3: <span style="color:#e6db74">&#39;rotateXLeft3&#39;</span>,
    ACTION_ROTATE_X_RIGHT_1: <span style="color:#e6db74">&#39;rotateXRight1&#39;</span>,
    ACTION_ROTATE_X_RIGHT_2: <span style="color:#e6db74">&#39;rotateXRight2&#39;</span>,
    ACTION_ROTATE_X_RIGHT_3: <span style="color:#e6db74">&#39;rotateXRight3&#39;</span>,
    ACTION_ROTATE_Y_UP_1: <span style="color:#e6db74">&#39;rotateYUp1&#39;</span>,
    ACTION_ROTATE_Y_UP_2: <span style="color:#e6db74">&#39;rotateYUp2&#39;</span>,
    ACTION_ROTATE_Y_UP_3: <span style="color:#e6db74">&#39;rotateYUp3&#39;</span>,
    ACTION_ROTATE_Y_DOWN_1: <span style="color:#e6db74">&#39;rotateYDown1&#39;</span>,
    ACTION_ROTATE_Y_DOWN_2: <span style="color:#e6db74">&#39;rotateYDown2&#39;</span>,
    ACTION_ROTATE_Y_DOWN_3: <span style="color:#e6db74">&#39;rotateYDown3&#39;</span>,
    ACTION_ROTATE_Z_UP_1: <span style="color:#e6db74">&#39;rotateZUp1&#39;</span>,ACTION_ROTATE_Z_UP_2:<span style="color:#e6db74">&#39;rotateZUp2&#39;</span>,
    ACTION_ROTATE_Z_UP_3:<span style="color:#e6db74">&#39;rotateZUp3&#39;</span>,
    ACTION_ROTATE_Z_DOWN_1:<span style="color:#e6db74">&#39;rotateZDown1&#39;</span>,
    ACTION_ROTATE_Z_DOWN_2:<span style="color:#e6db74">&#39;rotateZDown2&#39;</span>,
    ACTION_ROTATE_Z_DOWN_3:<span style="color:#e6db74">&#39;rotateZDown3&#39;</span>,
    ACTION_RESET:<span style="color:#e6db74">&#39;reset&#39;</span>,
}
</code></pre></div><h1 id="observing-the-value-of-observation">Observing the value of Observation</h1>
<p>I will write the process of saving observations using the prepared ones.
First of all, since it is necessary to run the save process with the timing when the processing of the action is finished as a trigger, the process flows from action.py as the starting point.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py:Content\Scripts\action.py" data-lang="py:Content\Scripts\action.py"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Action</span>:
<span style="color:#f92672">...</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tick</span>(self, delta_time):
        <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">        A function that is executed at regular intervals during game play.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Parameters
</span><span style="color:#e6db74">        ----------
</span><span style="color:#e6db74">        delta_time: float
</span><span style="color:#e6db74">            The number of seconds since the last call to tick.
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        self<span style="color:#f92672">.</span>_save_current_observation()
        self<span style="color:#f92672">.</span>_set_ended_status_to_animation_ended_action()
        action_instruction_id, action, skip_animation <span style="color:#f92672">=</span> \
            self<span style="color:#f92672">.</span>_get_action_instruction_data()
        <span style="color:#66d9ef">if</span> action_instruction_id <span style="color:#f92672">is</span> None:
            <span style="color:#66d9ef">return</span>
        action_func_name: str <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_get_action_func_name(
            action<span style="color:#f92672">=</span>action,
            skip_animation<span style="color:#f92672">=</span>skip_animation,
        )
        action_func <span style="color:#f92672">=</span> getattr(self<span style="color:#f92672">.</span>uobject, action_func_name)
        action_func()
        self<span style="color:#f92672">.</span>_set_running_status(
            action_instruction_id<span style="color:#f92672">=</span>action_instruction_id)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_save_current_observation</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">        Save the current observations.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Notes
</span><span style="color:#e6db74">        ----------
</span><span style="color:#e6db74">        Saving is not executed in the following cases.
</span><span style="color:#e6db74">        -When a rotation animation etc. is being executed.
</span><span style="color:#e6db74">        -If there is no new action with the exit status.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Returns
</span><span style="color:#e6db74">        ----------
</span><span style="color:#e6db74">        saved: bool
</span><span style="color:#e6db74">            Whether it was saved
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>is_any_cube_rotating():
            <span style="color:#66d9ef">return</span> False
        newly_ended_action_exists <span style="color:#f92672">=</span> False
        action_instructions <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>query(
            sqlite_utils<span style="color:#f92672">.</span>ActionInstruction
        )<span style="color:#f92672">.</span>filter_by(
            current_status<span style="color:#f92672">=</span>sqlite_utils<span style="color:#f92672">.</span>ACTION_INSTRUCTION_STATUS_RUNNING
        )<span style="color:#f92672">.</span>order_by(
            ActionInstruction<span style="color:#f92672">.</span>id<span style="color:#f92672">.</span>desc()
        )<span style="color:#f92672">.</span>limit(<span style="color:#ae81ff">1</span>)
        action_instruction: sqlite_utils<span style="color:#f92672">.</span>ActionInstruction
        <span style="color:#66d9ef">for</span> action_instruction <span style="color:#f92672">in</span> action_instructions:
            newly_ended_action_exists <span style="color:#f92672">=</span> True
            action_instruction_id <span style="color:#f92672">=</span> action_instruction<span style="color:#f92672">.</span>id
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> newly_ended_action_exists:
            <span style="color:#66d9ef">return</span>
        observation_utils<span style="color:#f92672">.</span>save_observation(
            action_instruction_id<span style="color:#f92672">=</span>action_instruction_id,
            orange_plane_loc_tpl<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>get_orange_plane_world_locations(),
            white_plane_loc_tpl<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>get_white_plane_world_locations(),
            yellow_plane_loc_tpl<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>get_yellow_plane_world_locations(),
            green_plane_loc_tpl<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>get_green_plane_world_locations(),
            red_plane_loc_tpl<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>get_red_plane_world_location(),
            blue_plane_loc_tpl<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>get_blue_plane_world_location(),
        )
        <span style="color:#66d9ef">return</span> True
<span style="color:#f92672">...</span>
</code></pre></div><p>Data that cannot be obtained without accessing the uobject (coordinates of each plane, status during rotation, etc.) is taken by the action.py side, and other detailed storage processing is processed by the common module side of the observation_utils.py.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#f92672">...</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save_observation</span>(
        action_instruction_id, orange_plane_loc_tpl, white_plane_loc_tpl,
        yellow_plane_loc_tpl, green_plane_loc_tpl, red_plane_loc_tpl,
        blue_plane_loc_tpl):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Save the observation value to SQLite.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Parameters
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    action_instruction_id: int
</span><span style="color:#e6db74">        The ID of the primary key of the last action setting.
</span><span style="color:#e6db74">    orange_plane_loc_tpl: tuple of lists
</span><span style="color:#e6db74">        A tuple containing a list of world-based coordinates for the orange plane.
</span><span style="color:#e6db74">    white_plane_loc_tpl: tuple of lists
</span><span style="color:#e6db74">        A tuple containing a list of world-based coordinates for the white plane.
</span><span style="color:#e6db74">    yellow_plane_loc_tpl: tuple of lists
</span><span style="color:#e6db74">        A tuple containing a list of world-relative coordinates for the yellow plane.
</span><span style="color:#e6db74">    green_plane_loc_tpl: tuple of lists
</span><span style="color:#e6db74">        A tuple containing a list of world-based coordinates for the green plane.
</span><span style="color:#e6db74">    red_plane_loc_tpl: tuple of lists
</span><span style="color:#e6db74">        A tuple containing a list of world-based coordinates for the red plane.
</span><span style="color:#e6db74">    blue_plane_loc_tpl: tuple of lists
</span><span style="color:#e6db74">        A tuple containing a list of world-based coordinates for the blue plane.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    observation_ids_dict: dict
</span><span style="color:#e6db74">        The color type for the key and the ID of the primary key of the observed value stored for the value
</span><span style="color:#e6db74">        A dictionary that stores the list.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    observation_ids_dict <span style="color:#f92672">=</span> {}

    color_type_list <span style="color:#f92672">=</span> [
        sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_ORANGE,
        sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_WHITE,
        sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_YELLOW,
        sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_GREEN,
        sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_RED,
        sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_BLUE,
    ]
    plane_loc_tpl_list <span style="color:#f92672">=</span> [
        orange_plane_loc_tpl,
        white_plane_loc_tpl,
        yellow_plane_loc_tpl,
        green_plane_loc_tpl,
        red_plane_loc_tpl,
        blue_plane_loc_tpl,
    ]
    <span style="color:#66d9ef">for</span> color_type, plane_loc_tpl <span style="color:#f92672">in</span> zip(color_type_list, plane_loc_tpl_list):
        observation_ids <span style="color:#f92672">=</span> _save_each_plane_observation(
            action_instruction_id<span style="color:#f92672">=</span>action_instruction_id,
            plane_loc_tpl<span style="color:#f92672">=</span>plane_loc_tpl,
            color_type<span style="color:#f92672">=</span>color_type)
        observation_ids_dict[color_type] <span style="color:#f92672">=</span> observation_ids
    <span style="color:#66d9ef">return</span> observation_ids_dict


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_save_each_plane_observation</span>(
        action_instruction_id, plane_loc_tpl, color_type):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Save the observed values of the target plane to SQLite.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Parameters
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    action_instruction_id: int
</span><span style="color:#e6db74">        The ID of the primary key of the last action setting.
</span><span style="color:#e6db74">    plane_loc_tpl: tuple of lists
</span><span style="color:#e6db74">        A tuple containing a list of world-based coordinates for the plane of interest.
</span><span style="color:#e6db74">        The list is stored in the order of X, Y, Z with 3 indexes.
</span><span style="color:#e6db74">    color_type: int
</span><span style="color:#e6db74">        Type value of the color at the target position.Returns
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    observation_id_list : list of int
</span><span style="color:#e6db74">        保存された観測値の主キーのIDのリスト。
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    session <span style="color:#f92672">=</span> sqlite_utils<span style="color:#f92672">.</span>create_action_data_db_session()
    x_list, y_list, z_list <span style="color:#f92672">=</span> plane_loc_tpl
    observation_id_list <span style="color:#f92672">=</span> []
    observation_list <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> x, y, z <span style="color:#f92672">in</span> zip(x_list, y_list, z_list):
        position_num <span style="color:#f92672">=</span> get_position_num_by_world_location(
            world_x<span style="color:#f92672">=</span>x,
            world_y<span style="color:#f92672">=</span>y,
            world_z<span style="color:#f92672">=</span>z)
        observation <span style="color:#f92672">=</span> sqlite_utils<span style="color:#f92672">.</span>Observation()
        observation<span style="color:#f92672">.</span>action_instruction_id <span style="color:#f92672">=</span> action_instruction_id
        observation<span style="color:#f92672">.</span>position_num <span style="color:#f92672">=</span> position_num
        observation<span style="color:#f92672">.</span>color_type <span style="color:#f92672">=</span> color_type
        session<span style="color:#f92672">.</span>add(instance<span style="color:#f92672">=</span>observation)
        observation_list<span style="color:#f92672">.</span>append(observation)
    session<span style="color:#f92672">.</span>commit()
    <span style="color:#66d9ef">for</span> observation <span style="color:#f92672">in</span> observation_list:
        observation_id_list<span style="color:#f92672">.</span>append(observation<span style="color:#f92672">.</span>id)
    <span style="color:#66d9ef">return</span> observation_id_list
</code></pre></div><p>テストもある程度書いておきます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py:Content\Scripts\action.py" data-lang="py:Content\Scripts\action.py">    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test__save_current_observation</span>(self):

        <span style="color:#75715e"># 回転中の場合の挙動を確認する。</span>
        original_is_any_cube_rotating_func <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>is_any_cube_rotating

        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dummy_is_any_cube_rotating</span>():
            <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">            テスト用の is_any_cube_rotating 関数のダミー関数。
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">            Returns
</span><span style="color:#e6db74">            ----------
</span><span style="color:#e6db74">            is_any_cube_rotating : bool
</span><span style="color:#e6db74">                固定でTrueが設定される。
</span><span style="color:#e6db74">            &#34;&#34;&#34;</span>
            <span style="color:#66d9ef">return</span> True

        self<span style="color:#f92672">.</span>is_any_cube_rotating <span style="color:#f92672">=</span> dummy_is_any_cube_rotating
        saved <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_save_current_observation()
        assert_false(saved)
        self<span style="color:#f92672">.</span>is_any_cube_rotating <span style="color:#f92672">=</span> original_is_any_cube_rotating_func

        <span style="color:#75715e"># 新たに処理が終わっているアクションが存在しない場合の挙動を</span>
        <span style="color:#75715e"># 確認する。</span>
        saved <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_save_current_observation()
        assert_false(saved)

        <span style="color:#75715e"># 新たに観測値を保存する条件を満たすアクションが存在する場合の挙動を</span>
        <span style="color:#75715e"># 確認する。</span>
        action_instruction <span style="color:#f92672">=</span> sqlite_utils<span style="color:#f92672">.</span>ActionInstruction()
        action_instruction<span style="color:#f92672">.</span>action <span style="color:#f92672">=</span> action_utils<span style="color:#f92672">.</span>ACTION_RESET
        action_instruction<span style="color:#f92672">.</span>current_status <span style="color:#f92672">=</span> \
            sqlite_utils<span style="color:#f92672">.</span>ACTION_INSTRUCTION_STATUS_RUNNING
        action_instruction<span style="color:#f92672">.</span>skip_animation <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>add(instance<span style="color:#f92672">=</span>action_instruction)
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>commit()
        saved <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_save_current_observation()
        assert_true(saved)
        color_type_key_expected_position_nums_dict <span style="color:#f92672">=</span> {
            sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_ORANGE:
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_LIST,
            sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_WHITE:
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_LEFT_LIST,
            sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_YELLOW:
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_RIGHT_LIST,
            sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_GREEN:
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_TOP_LIST,
            sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_RED:
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_BACK_LIST,
            sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_BLUE:
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_BOTTOM_LIST,
        }
        observation_list <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> color_type, expected_position_nums <span style="color:#f92672">in</span> \
                color_type_key_expected_position_nums_dict<span style="color:#f92672">.</span>items():
            <span style="color:#66d9ef">for</span> expected_position_num <span style="color:#f92672">in</span> expected_position_nums:
                <span style="color:#75715e"># 保存が実行されており、値が取れる（エラーにならない）</span>
                <span style="color:#75715e"># ことを確認する。</span>
                observation: sqlite_utils<span style="color:#f92672">.</span>Observation
                observation <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>query(
                    sqlite_utils<span style="color:#f92672">.</span>Observation
                )<span style="color:#f92672">.</span>filter_by(
                    action_instruction_id<span style="color:#f92672">=</span>action_instruction<span style="color:#f92672">.</span>id,
                    position_num<span style="color:#f92672">=</span>expected_position_num,
                    color_type<span style="color:#f92672">=</span>color_type,
                )<span style="color:#f92672">.</span>one()
                observation_list<span style="color:#f92672">.</span>append(observation)

        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>delete(instance<span style="color:#f92672">=</span>action_instruction)
        <span style="color:#66d9ef">for</span> observation <span style="color:#f92672">in</span> observation_list:
            self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>delete(instance<span style="color:#f92672">=</span>observation)
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>commit()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py:Win64\common\tests\test_observation_utils.py" data-lang="py:Win64\common\tests\test_observation_utils.py"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test__save_each_plane_observation</span>():
    observation_id_list <span style="color:#f92672">=</span>  observation_utils<span style="color:#f92672">.</span>_save_each_plane_observation(
        action_instruction_id<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,
        plane_loc_tpl<span style="color:#f92672">=</span>(
            [
                observation_utils<span style="color:#f92672">.</span>FRONT_POS_X_2_2,
                observation_utils<span style="color:#f92672">.</span>BACK_POS_X_3_3,
            ], [
                observation_utils<span style="color:#f92672">.</span>FRONT_POS_Y_2_2,
                observation_utils<span style="color:#f92672">.</span>BACK_POS_Y_3_3,
            ], [
                observation_utils<span style="color:#f92672">.</span>FRONT_POS_Z_2_2,
                observation_utils<span style="color:#f92672">.</span>BACK_POS_Z_3_3,
            ]),
        color_type<span style="color:#f92672">=</span>sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_RED)
    assert_equal(len(observation_id_list), <span style="color:#ae81ff">2</span>)
    session <span style="color:#f92672">=</span> sqlite_utils<span style="color:#f92672">.</span>create_action_data_db_session()
    <span style="color:#66d9ef">for</span> i, observation_id <span style="color:#f92672">in</span> enumerate(observation_id_list):
        observation: sqlite_utils<span style="color:#f92672">.</span>Observation <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(
            sqlite_utils<span style="color:#f92672">.</span>Observation
        )<span style="color:#f92672">.</span>filter_by(
            id<span style="color:#f92672">=</span>observation_id
        )<span style="color:#f92672">.</span>one()
        assert_equal(observation<span style="color:#f92672">.</span>action_instruction_id, <span style="color:#ae81ff">3</span>)
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
            assert_equal(
                observation<span style="color:#f92672">.</span>position_num,
                sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_2_2,
            )
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:assert_equal(
                observation<span style="color:#f92672">.</span>position_num,
                sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_BACK_3_3,
            )
        assert_equal(
            observation<span style="color:#f92672">.</span>color_type,
            sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_RED)
        session<span style="color:#f92672">.</span>delete(observation)
    session<span style="color:#f92672">.</span>commit()


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_save_observation</span>():
    <span style="color:#e6db74">&#34;&#34;&#34;save_observation 関数のテスト。
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    orange_plane_loc_tpl <span style="color:#f92672">=</span> (
        [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_X_1_1,
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_X_2_1,
        ], [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Y_1_1,
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Y_2_1,
        ], [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Z_1_1,
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Z_2_1,
        ]
    )
    white_plane_loc_tpl <span style="color:#f92672">=</span> (
        [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_X_3_1,
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_X_1_2,
        ], [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Y_3_1,
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Y_1_2,
        ], [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Z_3_1,
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Z_1_2,
        ]
    )
    yellow_plane_loc_tpl <span style="color:#f92672">=</span> (
        [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_X_2_2,
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_X_3_2,
        ], [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Y_2_2,
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Y_3_2,
        ], [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Z_2_2,
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Z_3_2,
        ]
    )
    green_plane_loc_tpl <span style="color:#f92672">=</span> (
        [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_X_1_3,
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_X_2_3,
        ], [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Y_1_3,
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Y_2_3,
        ], [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Z_1_3,
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Z_2_3,
        ]
    )
    red_plane_loc_tpl <span style="color:#f92672">=</span> (
        [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_X_3_3,
            observation_utils<span style="color:#f92672">.</span>LEFT_POS_X_1_1,
        ], [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Y_3_3,
            observation_utils<span style="color:#f92672">.</span>LEFT_POS_Y_1_1,
        ], [
            observation_utils<span style="color:#f92672">.</span>FRONT_POS_Z_3_3,
            observation_utils<span style="color:#f92672">.</span>LEFT_POS_Z_1_1,
        ]
    )
    blue_plane_loc_tpl <span style="color:#f92672">=</span> (
        [
            observation_utils<span style="color:#f92672">.</span>LEFT_POS_X_2_1,
            observation_utils<span style="color:#f92672">.</span>LEFT_POS_X_3_1,
        ], [
            observation_utils<span style="color:#f92672">.</span>LEFT_POS_Y_2_1,
            observation_utils<span style="color:#f92672">.</span>LEFT_POS_Y_3_1,
        ], [
            observation_utils<span style="color:#f92672">.</span>LEFT_POS_Z_2_1,
            observation_utils<span style="color:#f92672">.</span>LEFT_POS_Z_3_1,
        ]
    )
    observation_ids_dict <span style="color:#f92672">=</span> observation_utils<span style="color:#f92672">.</span>save_observation(
        action_instruction_id<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,
        orange_plane_loc_tpl<span style="color:#f92672">=</span>orange_plane_loc_tpl,
        white_plane_loc_tpl<span style="color:#f92672">=</span>white_plane_loc_tpl,
        yellow_plane_loc_tpl<span style="color:#f92672">=</span>yellow_plane_loc_tpl,
        green_plane_loc_tpl<span style="color:#f92672">=</span>green_plane_loc_tpl,
        red_plane_loc_tpl<span style="color:#f92672">=</span>red_plane_loc_tpl,
        blue_plane_loc_tpl<span style="color:#f92672">=</span>blue_plane_loc_tpl)
    assert_equal(len(observation_ids_dict), <span style="color:#ae81ff">6</span>)
    <span style="color:#66d9ef">for</span> color_type, observation_ids <span style="color:#f92672">in</span> observation_ids_dict<span style="color:#f92672">.</span>items():
        assert_true(isinstance(observation_ids, list))
        is_in <span style="color:#f92672">=</span> color_type <span style="color:#f92672">in</span> sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_LIST
        assert_true(is_in)
        assert_equal(len(observation_ids), <span style="color:#ae81ff">2</span>)

    <span style="color:#75715e"># 保存された観測値の位置の番号が想定した値になっているかを確認する。</span>
    color_type_key_expected_position_nums_dict <span style="color:#f92672">=</span> {
        sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_ORANGE: [
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_1_1,
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_2_1,
        ],
        sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_WHITE: [
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_3_1,
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_1_2,
        ],
        sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_YELLOW: [
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_2_2,
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_3_2,
        ],
        sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_GREEN: [
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_1_3,
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_2_3,
        ],
        sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_RED: [
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_3_3,
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_LEFT_1_1,
        ],
        sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_BLUE: [
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_LEFT_2_1,
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_LEFT_3_1,
        ]
    }
    session <span style="color:#f92672">=</span> sqlite_utils<span style="color:#f92672">.</span>create_action_data_db_session()
    <span style="color:#66d9ef">for</span> color_type, expected_position_nums <span style="color:#f92672">in</span> \
            color_type_key_expected_position_nums_dict<span style="color:#f92672">.</span>items():
        observation_ids <span style="color:#f92672">=</span> observation_ids_dict[color_type]
        <span style="color:#66d9ef">for</span> i, observation_id <span style="color:#f92672">in</span> enumerate(observation_ids):
            expected_position_num <span style="color:#f92672">=</span> expected_position_nums[i]
            observation: sqlite_utils<span style="color:#f92672">.</span>Observation <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(
                sqlite_utils<span style="color:#f92672">.</span>Observation
            )<span style="color:#f92672">.</span>filter_by(
                id<span style="color:#f92672">=</span>observation_id
            )<span style="color:#f92672">.</span>one()
            assert_equal(observation<span style="color:#f92672">.</span>position_num, expected_position_num)
</code></pre></div><p>Playボタンを押して試してみます。
SQLiteに値を手作業で保存してみて動かしてみます。
action=1, current_status=1で保存しました。眺めていると一度回転のアニメーションが終わり、current_status=3となります。<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/f35a2ea1-21c1-f345-86ad-796d96f528da.png" alt="image.png"></p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/e3ac533b-0565-40ba-c66c-20437a0cfa8c.png" alt="image.png"></p>
<p>Also check the values in the observation table&hellip;</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/ba15879f-78d6-83de-4f41-c21bff19b275.png" alt="image.png"></p>
<p>It seems to be saved properly.
Try sorting by position_num and lightly check if there are any duplicates.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/690781ec-d592-eb76-90aa-1f3fbe482a9c.png" alt="image.png"></p>
<p>For the time being, isn&rsquo;t it okay?</p>
<h1 id="be-sure-to-delete-the-data-before-the-reset-after-reset">Be sure to delete the data before the reset after reset</h1>
<p>After the reset action, delete the data of the SQLite action instruction and the observation data before that.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py:Content\Scripts\action.py" data-lang="py:Content\Scripts\action.py"><span style="color:#f92672">...</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tick</span>(self, delta_time):
        <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">        A function that is executed at regular intervals during game play.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Parameters
</span><span style="color:#e6db74">        ----------
</span><span style="color:#e6db74">        delta_time: float
</span><span style="color:#e6db74">            The number of seconds since the last call to tick.
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        self<span style="color:#f92672">.</span>_save_current_observation()
        updated_action_instructions <span style="color:#f92672">=</span> \
            self<span style="color:#f92672">.</span>_set_ended_status_to_animation_ended_action()
        self<span style="color:#f92672">.</span>_del_old_action_data_if_reset_action_exists(
            updated_action_instructions<span style="color:#f92672">=</span>updated_action_instructions)
<span style="color:#f92672">...</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_del_old_action_data_if_reset_action_exists</span>(
            self, updated_action_instructions):
        <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">        A reset action is included in the completed actions
</span><span style="color:#e6db74">        In this case, delete the old data before the reset.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Parameters
</span><span style="color:#e6db74">        ----------
</span><span style="color:#e6db74">        updated_action_instructions: list of ActionInstruction
</span><span style="color:#e6db74">            A list of completed action settings.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Returns
</span><span style="color:#e6db74">        ----------
</span><span style="color:#e6db74">        deleted :bool
</span><span style="color:#e6db74">            True is set when the deletion process is executed.
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> updated_action_instructions:
            <span style="color:#66d9ef">return</span> False
        updated_action_instruction: sqlite_utils<span style="color:#f92672">.</span>ActionInstruction
        reset_action_id <span style="color:#f92672">=</span> None
        <span style="color:#66d9ef">for</span> updated_action_instruction <span style="color:#f92672">in</span> updated_action_instructions:
            <span style="color:#66d9ef">if</span> updated_action_instruction<span style="color:#f92672">.</span>action <span style="color:#f92672">!=</span> action_utils<span style="color:#f92672">.</span>ACTION_RESET:
                <span style="color:#66d9ef">continue</span>
            reset_action_id <span style="color:#f92672">=</span> updated_action_instruction<span style="color:#f92672">.</span>id
        <span style="color:#66d9ef">if</span> reset_action_id <span style="color:#f92672">is</span> None:
            <span style="color:#66d9ef">return</span> False
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>query(
            sqlite_utils<span style="color:#f92672">.</span>ActionInstruction
        )<span style="color:#f92672">.</span>filter(
            sqlite_utils<span style="color:#f92672">.</span>ActionInstruction<span style="color:#f92672">.</span>id <span style="color:#f92672">&lt;</span>reset_action_id
        )<span style="color:#f92672">.</span>delete()
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>query(
            sqlite_utils<span style="color:#f92672">.</span>Observation
        )<span style="color:#f92672">.</span>filter(
            sqlite_utils<span style="color:#f92672">.</span>Observation<span style="color:#f92672">.</span>action_instruction_id <span style="color:#f92672">&lt;</span>reset_action_id
        )<span style="color:#f92672">.</span>delete()
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>commit()
        <span style="color:#66d9ef">return</span> True
<span style="color:#f92672">...</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_del_old_data_if_reset_action_exists</span>(
            self, updated_action_instructions):
        <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">        A reset action is included in the completed actions
</span><span style="color:#e6db74">        In this case, delete the old data before the reset.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Parameters
</span><span style="color:#e6db74">        ----------
</span><span style="color:#e6db74">        updated_action_instructions: list of ActionInstruction
</span><span style="color:#e6db74">            A list of completed action settings.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Returns
</span><span style="color:#e6db74">        ----------
</span><span style="color:#e6db74">        deleted :bool
</span><span style="color:#e6db74">            True is set when the deletion process is executed.
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> updated_action_instructions:
            <span style="color:#66d9ef">return</span> False
        updated_action_instruction: sqlite_utils<span style="color:#f92672">.</span>ActionInstruction
        reset_action_id <span style="color:#f92672">=</span> None
        <span style="color:#66d9ef">for</span> updated_action_instruction <span style="color:#f92672">in</span> updated_action_instructions:
            <span style="color:#66d9ef">if</span> updated_action_instruction<span style="color:#f92672">.</span>action <span style="color:#f92672">!=</span> action_utils<span style="color:#f92672">.</span>ACTION_RESET:
                <span style="color:#66d9ef">continue</span>
            reset_action_id <span style="color:#f92672">=</span> updated_action_instruction<span style="color:#f92672">.</span>id
        <span style="color:#66d9ef">if</span> reset_action_id <span style="color:#f92672">is</span> None:
            <span style="color:#66d9ef">return</span> False
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>query(
            sqlite_utils<span style="color:#f92672">.</span>ActionInstruction
        )<span style="color:#f92672">.</span>filter(
            sqlite_utils<span style="color:#f92672">.</span>ActionInstruction<span style="color:#f92672">.</span>id <span style="color:#f92672">&lt;</span>reset_action_id
        )<span style="color:#f92672">.</span>delete()
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>query(
            sqlite_utils<span style="color:#f92672">.</span>Observation
        )<span style="color:#f92672">.</span>filter(
            sqlite_utils<span style="color:#f92672">.</span>Observation<span style="color:#f92672">.</span>action_instruction_id <span style="color:#f92672">&lt;</span>reset_action_id
        )<span style="color:#f92672">.</span>delete()
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>commit()
        <span style="color:#66d9ef">return</span> True
</code></pre></div><p>With the return value of the process that sets the completion status (_set_ended_status_to_animation_ended_action) for the completed action, it is adjusted to return the list of updated action data.
Referring to that list, if there is reset action data, the function that executes the deletion process is executed.</p>
<p>I will also add a simple test.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py:Scripts\action.py" data-lang="py:Scripts\action.py">    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test__del_old_data_if_reset_action_exists</span>(self):
        <span style="color:#75715e"># Make sure processing stops when you specify an empty list.</span>
        deleted <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_del_old_data_if_reset_action_exists(
            updated_action_instructions<span style="color:#f92672">=</span>[])
        assert_false(deleted)

        <span style="color:#75715e">#Processing stops if reset action is not included in the list</span>
        <span style="color:#75715e"># Make sure.</span>
        action_instruction_normal_rot <span style="color:#f92672">=</span> sqlite_utils<span style="color:#f92672">.</span>ActionInstruction()
        action_instruction_normal_rot<span style="color:#f92672">.</span>action <span style="color:#f92672">=</span> \
            action_utils<span style="color:#f92672">.</span>ACTION_ROTATE_X_LEFT_1
        action_instruction_normal_rot<span style="color:#f92672">.</span>current_status <span style="color:#f92672">=</span> \
            sqlite_utils<span style="color:#f92672">.</span>ACTION_INSTRUCTION_STATUS_ENDED
        action_instruction_normal_rot<span style="color:#f92672">.</span>skip_animation <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>add(
            instance<span style="color:#f92672">=</span>action_instruction_normal_rot)
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>commit()
        updated <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_del_old_data_if_reset_action_exists(
            updated_action_instructions<span style="color:#f92672">=</span>[action_instruction_normal_rot])assert_false(updated)

        <span style="color:#75715e"># リセットのアクションを含む場合に、リセット前のデータが削除</span>
        <span style="color:#75715e"># されることを確認する。</span>
        action_instruction_reset <span style="color:#f92672">=</span> sqlite_utils<span style="color:#f92672">.</span>ActionInstruction()
        action_instruction_reset<span style="color:#f92672">.</span>action <span style="color:#f92672">=</span> action_utils<span style="color:#f92672">.</span>ACTION_RESET
        action_instruction_reset<span style="color:#f92672">.</span>current_status <span style="color:#f92672">=</span> \
            sqlite_utils<span style="color:#f92672">.</span>ACTION_INSTRUCTION_STATUS_ENDED
        action_instruction_reset<span style="color:#f92672">.</span>skip_animation <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>add(action_instruction_reset)

        observation_normal_rot <span style="color:#f92672">=</span> sqlite_utils<span style="color:#f92672">.</span>Observation()
        observation_normal_rot<span style="color:#f92672">.</span>action_instruction_id <span style="color:#f92672">=</span> \
            action_instruction_normal_rot<span style="color:#f92672">.</span>id
        observation_normal_rot<span style="color:#f92672">.</span>position_num <span style="color:#f92672">=</span> \
            sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_1_1
        observation_normal_rot<span style="color:#f92672">.</span>color_type <span style="color:#f92672">=</span> \
            sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_ORANGE
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>add(observation_normal_rot)

        observation_reset <span style="color:#f92672">=</span> sqlite_utils<span style="color:#f92672">.</span>Observation()
        observation_reset<span style="color:#f92672">.</span>action_instruction_id <span style="color:#f92672">=</span> action_instruction_reset<span style="color:#f92672">.</span>id
        observation_reset<span style="color:#f92672">.</span>position_num <span style="color:#f92672">=</span> sqlite_utils<span style="color:#f92672">.</span>POSITION_NUM_FRONT_1_1
        observation_reset<span style="color:#f92672">.</span>color_type <span style="color:#f92672">=</span> sqlite_utils<span style="color:#f92672">.</span>COLOR_TYPE_ORANGE
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>add(observation_reset)

        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>commit()
        updated <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_del_old_data_if_reset_action_exists(
            updated_action_instructions<span style="color:#f92672">=</span>[
                action_instruction_normal_rot,
                action_instruction_reset,
            ])
        assert_true(updated)

        <span style="color:#75715e"># リセット以降のアクションデータのみ残っていることを確認する。</span>
        min_action_instruction <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>query(
            func<span style="color:#f92672">.</span>min(sqlite_utils<span style="color:#f92672">.</span>ActionInstruction<span style="color:#f92672">.</span>id)<span style="color:#f92672">.</span>label(<span style="color:#e6db74">&#39;min_id&#39;</span>)
        )<span style="color:#f92672">.</span>one()
        assert_equal(
            min_action_instruction<span style="color:#f92672">.</span>min_id,
            action_instruction_reset<span style="color:#f92672">.</span>id)

        <span style="color:#75715e"># リセット以降の観測値のデータのみ残っていることを確認する。</span>
        min_observation <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>query(
            func<span style="color:#f92672">.</span>min(sqlite_utils<span style="color:#f92672">.</span>Observation<span style="color:#f92672">.</span>id)<span style="color:#f92672">.</span>label(<span style="color:#e6db74">&#39;min_id&#39;</span>)
        )<span style="color:#f92672">.</span>one()
        assert_equal(
            min_observation<span style="color:#f92672">.</span>min_id,
            observation_reset<span style="color:#f92672">.</span>id)

        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>delete(action_instruction_reset)
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>delete(observation_reset)
        self<span style="color:#f92672">.</span>action_data_db_session<span style="color:#f92672">.</span>commit()
</code></pre></div><p>手動でSQLiteに値を入れてみて、実際に動作を確認してみます。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/f501da21-6c9f-3395-462f-0aecaf6b6188.png" alt="image.png"></p>
<p>2つアクションの指示（2回転分）のデータを入れました。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/32b48896-158e-6b2a-2e15-fdf3a19e787e.png" alt="image.png"></p>
<p>観測値もそれぞれのアクションの値が入っています。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/c9b299d2-53e1-9e69-28e4-ed608df52444.png" alt="image.png"></p>
<p>リセットのアクション（action=19）を入れてみます。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/c86f9561-c368-774d-6e0c-313ba4b04fbb.png" alt="image.png"></p>
<p>キューブの回転がシャッフルされます。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/d93a35b8-d4f9-8d5a-4c27-43a6f5061bc2.png" alt="image.png"></p>
<p>アクションの値を確認すると、正しくリセットのもののみになっています。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/1b404d08-cb9a-b9a2-48ef-72476fa0cf38.png" alt="image.png"></p>
<p>観測値の方もリセットのアクションのデータのみになっています。大丈夫そうですね。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/31f37f2c-cc15-62dc-a9fb-d19c91cdd632.png" alt="image.png"></p>
<h1 id="リワード回りの対応は">リワード回りの対応は・・・</h1>
<p>リワード関係は観測値が取得できれば後は如何様にもできる気がするため、
実装はUE4プロジェクト内では行わずにPyPI（pip）登録用のライブラリ側で対応します。</p>
<p>これは、Pythonスクリプトで細かく調整が必要になった際にいちいちUE4でリリース用にパッケージして・・・となるとしんどそうなためです（Pythonで完結するライブラリ側のアップデートのみで対応できるようにしておきたい）。</p>
<p>ということで一旦後回しにします。</p>
<h1 id="ゲーム終了のアクションを追加しておく">ゲーム終了のアクションを追加しておく</h1>
<p>何かとテストするときなども便利な気がするため、アクションの指定でゲーム終了（Playの終了）ができるようにしておきます。</p>
<p>検索してみたら、Quit GameというBPのノードが存在するようです。</p>
<p>参考 : <a href="https://docs.unrealengine.com/en-US/BlueprintAPI/Game/QuitGame/index.html">Quit Game</a></p>
<p>BP_ActionにquitGameという関数を追加します。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/2b76304b-76cf-fe2a-711e-8ebfa9d740b5.png" alt="image.png"></p>
<p>Python側で、ACTION_QUIT_GAMEという定数や関数名とのマッピングの定義などを追加していきます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py:Win64\common\action_utils.py" data-lang="py:Win64\common\action_utils.py"><span style="color:#f92672">...</span>
ACTION_ROTATE_Z_DOWN_3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">18</span>
ACTION_RESET <span style="color:#f92672">=</span> <span style="color:#ae81ff">19</span>
ACTION_QUIT_GAME <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
<span style="color:#f92672">...</span>
ACTION_LIST <span style="color:#f92672">=</span> [
   <span style="color:#f92672">...</span>
    ACTION_ROTATE_Z_DOWN_3,
    ACTION_RESET,
    ACTION_QUIT_GAME,
]

ACTION_KEY_FUNC_NAME_DICT <span style="color:#f92672">=</span> {
    <span style="color:#f92672">...</span>
    ACTION_ROTATE_Z_DOWN_3: <span style="color:#e6db74">&#39;rotateZDown3&#39;</span>,
    ACTION_RESET: <span style="color:#e6db74">&#39;reset&#39;</span>,
    ACTION_QUIT_GAME: <span style="color:#e6db74">&#39;quitGame&#39;</span>,
}
</code></pre></div><p>SQLiteに値を入れて試してみます。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/ece686d1-0181-983e-1779-87a15f183cc4.png" alt="image.png"></p>
<p>Play画面を見ていると、ちゃんとPlayしていない状態になりました。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/9015ebe9-c3be-bcbb-d430-2ba83fa71c94.png" alt="image.png"></p>
<h1 id="余分なアセットを削除する">余分なアセットを削除する</h1>
<p>段々リリース用のパッケージングが近くなってきました。
不慣れなこともありとりあえずStarter Content有りでUE4プロジェクトを作っているので、現状余分なアセットが色々プロジェクトに入っています。</p>
<p>パッケージで余分にサイズがかさんでしまったり、ビルド時間が長くなりそうな気がするため、削除しておきます。</p>
<p>また、その時の名残りでMapsをStarter Content内のもので作業してしまっていたので、そちらのマップをContent直下にMapsというフォルダを作って移動させておきます。<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/e78521a4-660d-91e8-3ef1-530bb34903bc.png" alt="image.png"></p>
<p>I only left the Shapes folder.
Inside is Cube and Plane as below. Even if this is erased, it seems to be okay because it is in the Basic menu, but I think that there is no problem, but I will leave it for the time being.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/b40dc087-a80e-34cd-dac6-3657e999a152.png" alt="image.png"></p>
<p>The map in Starter Content was also moved and the name was changed to Default Map.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/3b2a82b6-389d-b4fe-198d-e4238eba3a70.png" alt="image.png"></p>
<p>However, in this case, the map will not be displayed when UE4 is restarted (double-clicking the content of the map will open it).</p>
<p>It seems that it is necessary to switch the specification of the default level, so it corresponds.</p>
<p>Reference: <a href="https://docs.unrealengine.com/en/Engine/Levels/HowTo/ChangeDefaultLevel/index.html">Change the default level</a></p>
<p>Open the project settings, display the menu of Maps &amp; Modes, and edit the Game Default Map.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/2d890e16-f1a1-ee4f-866c-0aeb98989464.png" alt="image.png"></p>
<p>Since we have removed the extra content, we now have only one option.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/02bd6799-375e-5b7c-c679-809cfb7b85fb.png" alt="image.png"></p>
<p>Similarly, switch the Dditor Startup Map as well (it seems that if you do not adjust this when restarting UE4, you will not open the level first).</p>
<p>After setting, try restarting UE4.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/51484c56-7649-2df0-3770-15912cacdd4b.png" alt="image.png"></p>
<p>It seems that the expected level is open. Play it and make sure it doesn&rsquo;t catch any errors or tests, then commit the deleted or moved parts.</p>
<p>#Try packaging</p>
<p>I haven&rsquo;t tried packaging of UE4 or release build, so I will try it.</p>
<p>For the time being, I tried to select Windows 64bit in the Packaging menu.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/5b7a6074-f8fe-5a4b-d07e-6801f21dc29d.png" alt="image.png"></p>
<p>I got a message saying that Visual Studio Community should be installed, so I will install it.
When I clicked the link, the installer was downloaded all at once. You don&rsquo;t have to hesitate.</p>
<p>However, when I installed it via that installer, the message Community 2015 was displayed&hellip;
The message says 2017, but I&rsquo;m wondering if it&rsquo;s okay, but I&rsquo;ll proceed as it is.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/2a9cdeb1-aef4-91f9-97bd-0b521c1a81a0.png" alt="image.png"></p>
<p>It takes a long time to install, so you can relax while drinking tea for a while.</p>
<p>Now that the installation is complete, try Win64 packaging again.</p>
<pre><code>UATHelper: Packaging (Windows (64-bit)): BUILD SUCCESSFUL
UATHelper: Packaging (Windows (64-bit)): AutomationTool exiting with ExitCode=0 (Success)
</code></pre><p>Did it take a minute? It ended quickly at that level.
Try to launch the packaged exe file.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/86e623ed-3002-339d-e630-149cd06d69a3.png" alt="image.png"></p>
<p>Somehow an error.
I have investigated variously, but I am having a tough time with little information.</p>
<p>If you often read the README of the plugin,</p>
<blockquote>
<p>Binary releases are mainly useful for editor scripting, if you want to package your project for distribution and you need the python runtime, you need a source release (see below).
<a href="https://github.com/20tab/UnrealEnginePython#binary-installation-on-windows-64-bit">https://github.com/20tab/UnrealEnginePython#binary-installation-on-windows-64-bit</a></p>
</blockquote>
<p>Description.
Ah, isn&rsquo;t Binary releases Python usable in distribution packaging&hellip;
There is a description that the issue was solved by another issue.</p>
<blockquote>
<p>Packaged Application Crashes #791
&hellip;
Hello, the Python an UE4 integration works fine in the editor.When I package the project and run it, I get the following error:
&hellip;
Source installation of the same Python version resolved this issue.
<a href="https://github.com/20tab/UnrealEnginePython/issues/791">https://github.com/20tab/UnrealEnginePython/issues/791</a></p>
</blockquote>
<p>I was completely overlooked&hellip;
It&rsquo;s a hassle, but since it can&rsquo;t be helped, let&rsquo;s proceed while reading the document of &ldquo;Installation from sources on Windows (64 bit)&rdquo;.</p>
<p>For the time being, we have cloned the following repositories.</p>
<pre><code>https://github.com/20tab/UnrealEnginePython
</code></pre><p>After that, put this UnrealEnginePython folder in the Plugins folder directly under the project folder (This one may not need Binaries and Config folders of the existing binary version, so you may need to delete it later. But then install NumPy etc. What should I do?).</p>
<blockquote>
<p>-from the file explorer right click on the project main file and choose&rsquo;generate visual studio project files&rsquo;</p>
</blockquote>
<ul>
<li>open visual studio, you should now see Plugins/UnrealEnginePython in your solution explorer</li>
<li>run the compilation from visual studio</li>
</ul>
<blockquote>
<p><a href="https://github.com/20tab/UnrealEnginePython#installation-from-sources-on-windows-64-bit">https://github.com/20tab/UnrealEnginePython#installation-from-sources-on-windows-64-bit</a></p>
</blockquote>
<p>I don&rsquo;t understand a little here. I&rsquo;ve never used Visual Studio, but&hellip;
Is File Explorer a regular Explorer? Especially → There is no such menu as <code>generate visual studio project files</code> by clicking&hellip;</p>
<p>However, can it be supported on UE4Editor? Since it looks like that, I will proceed with that.
Open the plugin screen and click Package..</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/f56fb2cb-f7ce-9063-4288-56e89d29ae57.png" alt="image.png"></p>
<pre><code>UATHelper: Package Plugin Task (Windows): ERROR: Unable to instantiate module'UnrealEnginePython': System.Exception: Unable to find Python installation
</code></pre><p>I was angry.
I can&rsquo;t find Python.</p>
<blockquote>
<p>Currently python3.6, python3.5 and python2.7 are supported.</p>
</blockquote>
<p>It seems that Python 3.6 or 3.5 is required.
It seems that you need Python 3.6 or something specified in the following C# code for build.</p>
<p><a href="https://github.com/20tab/UnrealEnginePython/blob/fbc97f27861aac456022756c9fdaf7e3a3fe33c1/Source/UnrealEnginePython/UnrealEnginePython.Build.cs#L19">https://github.com/20tab/UnrealEnginePython/blob/fbc97f27861aac456022756c9fdaf7e3a3fe33c1/Source/UnrealEnginePython/UnrealEnginePython.Build.cs#L19</a></p>
<p>Download and install &ldquo;Windows x86-64 executable installer&rdquo; on the following Python official page.
<a href="https://www.python.org/downloads/release/python-361/">https://www.python.org/downloads/release/python-361/</a></p>
<p>After installation, add the path to windowsKnownPaths in Build.cs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">string</span>[] windowsKnownPaths =
    {
       <span style="color:#75715e">// &#34;C:/Program Files/Python37&#34;,
</span><span style="color:#75715e"></span>        <span style="color:#e6db74">&#34;C:/Program Files/Python36&#34;</span>,
        <span style="color:#e6db74">&#34;C:/Program Files/Python35&#34;</span>,
        <span style="color:#e6db74">&#34;C:/Python27&#34;</span>,
        <span style="color:#e6db74">&#34;C:/IntelPython35&#34;</span>,<span style="color:#e6db74">&#34;C:/Users/*******/AppData/Local/Programs/Python/Python36&#34;</span>,
    };
</code></pre></div><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/e464e1c0-0d48-dbce-c132-bf1a3fa9c1d2.png" alt="image.png"></p>
<p>This time, the packaging of the plugin proceeded properly without any error.
But this time another error occurred.</p>
<pre><code>ERROR: UBT ERROR: Failed to produce item: ...\Plugins\UnrealEnginePython\Binaries\Win64\UE4Editor-PythonAutomation.pdb
</code></pre><p>It seems that the creation of files under Binaries is failing. This is&hellip; Is the existing Binaries file wrong?
After that, I wonder if I should restore the description from Git or Qiita to the original, so I will delete the Binaries folder as a trial (I will temporarily drop UE4 in advance).</p>
<p>When UE4 is started after the deletion, there is something that has not been built with the plug-in, and it has become the flow of building.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/228778/016d7402-b210-4a4c-3e50-b6ea1e61e00e.png" alt="image.png"></p>
<p>Wait a while for the build to finish.</p>
<p>After the build was completed, it managed to move (aside from the fact that NumPy etc. do not work).
But when I try to package it, the exe file gives a similar error again.</p>
<p>I tried many other things but it didn&rsquo;t work.
Hmmm&hellip; It&rsquo;s pretty difficult to package a Python plugin&hellip;
(Including issues that are not closed due to similar errors&hellip;)</p>
<p>It would be useless if you didn&rsquo;t check the build for packaging in an early stage&hellip; (Self-care)</p>
<p>Although I was tenacious for a while, it seems to be strict, so in the future I will not use the Python plug-in in the UE4 project, and once I have taken the observation values directly in the UE Editor, I can try it personally there. I will use it.</p>
<h1 id="reference-page-summary">Reference page summary</h1>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/BlueprintAPI/Game/QuitGame/index.html">Quit Game</a></li>
<li><a href="https://docs.unrealengine.com/en/Engine/Levels/HowTo/ChangeDefaultLevel/index.html">Change the default level</a></li>
<li><a href="https://github.com/20tab/UnrealEnginePython#binary-installation-on-windows-64-bit">UnrealEnginePython</a></li>
<li><a href="https://github.com/20tab/UnrealEnginePython/issues/791">Packaged Application Crashes #791</a></li>
</ul>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
