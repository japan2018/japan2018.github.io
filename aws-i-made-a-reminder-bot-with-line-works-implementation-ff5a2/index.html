<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://japan2018.github.io/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://japan2018.github.io/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://japan2018.github.io/favicon-16x16.png">

  
  <link rel="manifest" href="https://japan2018.github.io/site.webmanifest">

  
  <link rel="mask-icon" href="https://japan2018.github.io/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://japan2018.github.io/css/bootstrap.min.css" />

  
  <title>[AWS] I made a reminder BOT with LINE WORKS (implementation) | Some Title</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[AWS] I made a reminder BOT with LINE WORKS (implementation)</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 14, 2019
  </small>
  

<small><code><a href="https://japan2018.github.io/tags/python">Python</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/aws">AWS</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/serverless">serverless</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/lineworks">LINEWORKS</a></code></small>

</p>
<pre><code>It is the 14th day of LINEWORKS Advent Calendar.
</code></pre>
<p>This time, we will introduce the implementation of the reminder BOT introduced in <a href="https://qiita.com/peyryo/items/05c1b7e6c7e1ebdb550e">LINEWORKS Advent Calendar Day 7</a>.</p>
<h2 id="repost-bot-screen-and-overall-structure">[Repost] BOT screen and overall structure</h2>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/504215/8cca5293-2d9c-248c-030b-562bf8fcb00e.png" alt="review.png"></p>
<p>The reminder BOT consists of three Lambda, and is implemented with Python3.7.</p>
<p>①. Processing of messages sent from LINE WORKS and notification to SQS
②. Poll the events stored in the table and notify SQS
③. Notify the LINEWORKS server of the message received from SQS</p>
<p>This time, I will focus on ①.</p>
<h2 id="state-transition-table-and-message-list">State transition table and message list</h2>
<p>The BOT interaction with the user is represented by a state transition table. The reminder BOT handles the following four events.</p>
<ul>
<li>User participation
-Occurs when the user adds a BOT</li>
<li>Text input
-User can input arbitrary text to BOT</li>
<li>Press event input button
-Press &ldquo;Event Registration&rdquo; displayed on the BOT menu</li>
<li>Press event output button
-Press &ldquo;Event Reference&rdquo; displayed on the BOT menu</li>
</ul>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/504215/f0c32e43-db6a-496e-4bb3-ab19fcdbe462.png" alt="table.png"></p>
<p>It manages four states for each user event.
The BOT responds to the user with messages corresponding to user events and BOT status.
The content of the message is defined as a message list.</p>
<h2 id="lambda-implementation">Lambda implementation</h2>
<p>Then, it is the implementation of Lambda of the main subject.</p>
<p>First, the whole process of the Lambda function.
Call your own <code>on_event function</code> which is responsible for request body validation and message main processing.
Request body verification is processed based on the value of the header <code>x-works-signature</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">index.py
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> json
<span style="color:#f92672">from</span> base64 <span style="color:#f92672">import</span> b64encode, b64decode
<span style="color:#f92672">import</span> hashlib
<span style="color:#f92672">import</span> hmac

<span style="color:#f92672">import</span> reminderbot

API_ID <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;API_ID&#34;</span>)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate</span>(payload, signature):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    x-works-signature verification
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>

    key <span style="color:#f92672">=</span> API_ID<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)
    payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)

    encoded_body <span style="color:#f92672">=</span> hmac<span style="color:#f92672">.</span>new(key, payload, hashlib<span style="color:#f92672">.</span>sha256)<span style="color:#f92672">.</span>digest()
    encoded_base64_body <span style="color:#f92672">=</span> b64encode(encoded_body)<span style="color:#f92672">.</span>decode()

    <span style="color:#66d9ef">return</span> encoded_base64_body <span style="color:#f92672">==</span> signature


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handler</span>(event, context):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    main function
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>

    <span style="color:#75715e"># Validate request body</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> validate(event[<span style="color:#e6db74">&#34;body&#34;</span>], event[<span style="color:#e6db74">&#34;headers&#34;</span>]<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;x-works-signature&#34;</span>)):
        <span style="color:#66d9ef">return</span> {
            <span style="color:#e6db74">&#34;statusCode&#34;</span>: <span style="color:#ae81ff">400</span>,
            <span style="color:#e6db74">&#34;body&#34;</span>: <span style="color:#e6db74">&#34;Bad Request&#34;</span>,
            <span style="color:#e6db74">&#34;headers&#34;</span>: {
                <span style="color:#e6db74">&#34;Content-Type&#34;</span>: <span style="color:#e6db74">&#34;application/json&#34;</span>
            }
        }

    body <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(event[<span style="color:#e6db74">&#34;body&#34;</span>])

    <span style="color:#75715e"># Main processing of messages</span>
    reminderbot<span style="color:#f92672">.</span>on_event(body)

    <span style="color:#66d9ef">return</span> {
        <span style="color:#e6db74">&#34;statusCode&#34;</span>: <span style="color:#ae81ff">200</span>,
        <span style="color:#e6db74">&#34;body&#34;</span>: <span style="color:#e6db74">&#34;OK&#34;</span>,
        <span style="color:#e6db74">&#34;headers&#34;</span>: {<span style="color:#e6db74">&#34;Content-Type&#34;</span>: <span style="color:#e6db74">&#34;application/json&#34;</span>}
    }
</code></pre></div><p>Next is the on_event function.
The 4 states, 4 user events, and the message list that have been set in advance this time are defined with constants.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">reminderbot.py
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>

<span style="color:#f92672">import</span> os

<span style="color:#f92672">import</span> json
<span style="color:#f92672">import</span> datetime
<span style="color:#f92672">import</span> dateutil.parser
<span style="color:#f92672">from</span> dateutil.relativedelta <span style="color:#f92672">import</span> relativedelta

<span style="color:#f92672">import</span> boto3
<span style="color:#f92672">from</span> boto3.dynamodb.conditions <span style="color:#f92672">import</span> Key, Attr

<span style="color:#75715e"># Four states are defined based on the state transition table</span>
STATUS_NO_USER <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;no_user&#34;</span>
STATUS_WATING_FOR_BUTTON_PUSH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;status_waiting_for_button_push&#34;</span>
STATUS_WATING_FOR_NAME_INPUT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;status_waiting_for_name_input&#34;</span>
STATUS_WATING_FOR_TIME_INPUT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;status_waiting_for_time_input&#34;</span>

<span style="color:#75715e"># Defined based on message list</span>
MESSAGE_LIST <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#34;Hello, I&#39;m remind bot. I press the menu button.&#34;</span>
    <span style="color:#e6db74">&#34;Enter the event name&#34;</span>,
    <span style="color:#e6db74">&#34;Press the menu button.&#34;</span>,
    <span style="color:#e6db74">&#34;Click here for event details!&#34;</span>,
    <span style="color:#e6db74">&#34;Enter the event time.&#34;</span>,
    <span style="color:#e6db74">&#34;Completion of registration!&#34;</span>,
    <span style="color:#e6db74">&#34;It&#39;s an error. Please try again.&#34;</span>,
]

<span style="color:#75715e"># Define user event as postback event</span>
<span style="color:#75715e"># When registering a BOT menu, use the same value as the postback event below.</span>
POSTBACK_START <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;start&#34;</span>
POSTBACK_MESSAGE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;message&#34;</span>
POSTBACK_PUSH_PUT_EVENT_BUTTON <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;push_put_event_button&#34;</span>
POSTBACK_PUSH_GET_EVENT_BUTTON <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;push_get_event_button&#34;</span>

<span style="color:#75715e"># Table to manage status</span>
dynamodb <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>resource(<span style="color:#e6db74">&#34;dynamodb&#34;</span>)
table <span style="color:#f92672">=</span> dynamodb<span style="color:#f92672">.</span>Table(<span style="color:#e6db74">&#34;lineworks-sample-table&#34;</span>)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_event</span>(event):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Handling the entire event of the bot
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>

    account_id <span style="color:#f92672">=</span> event[<span style="color:#e6db74">&#34;source&#34;</span>][<span style="color:#e6db74">&#34;accountId&#34;</span>]
    content <span style="color:#f92672">=</span> event[<span style="color:#e6db74">&#34;content&#34;</span>]

    postback <span style="color:#f92672">=</span> content<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;postback&#34;</span>) <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;message&#34;</span>

    <span style="color:#75715e"># Check the current status of the user</span>
    response <span style="color:#f92672">=</span> table<span style="color:#f92672">.</span>get_item(
        Key<span style="color:#f92672">=</span>{
            <span style="color:#e6db74">&#34;Hash&#34;</span>: <span style="color:#e6db74">&#34;status_&#34;</span> <span style="color:#f92672">+</span> account_id,
            <span style="color:#e6db74">&#34;Range&#34;</span>: <span style="color:#e6db74">&#34;-&#34;</span>
        }
    )

    status <span style="color:#f92672">=</span> STATUS_NO_USER
    message <span style="color:#f92672">=</span> None
    
    <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;Item&#34;</span>) <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
        status <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;Item&#34;</span>)[<span style="color:#e6db74">&#34;Status&#34;</span>]
    
    <span style="color:#75715e"># Branch process for each user event (postback)</span>
    <span style="color:#66d9ef">try</span>:
    
        <span style="color:#66d9ef">if</span> postback <span style="color:#f92672">==</span> POSTBACK_START:
            message <span style="color:#f92672">=</span> on_join(account_id, status)

        <span style="color:#66d9ef">elif</span> postback <span style="color:#f92672">==</span> POSTBACK_MESSAGE:
            text <span style="color:#f92672">=</span> content[<span style="color:#e6db74">&#34;text&#34;</span>]
            message <span style="color:#f92672">=</span> on_message(account_id, status, text)

        <span style="color:#66d9ef">elif</span> postback <span style="color:#f92672">==</span> POSTBACK_PUSH_PUT_EVENT_BUTTON:
            message <span style="color:#f92672">=</span> on_pushed_put_event_button(account_id, status)

        <span style="color:#66d9ef">elif</span> postback <span style="color:#f92672">==</span> POSTBACK_PUSH_GET_EVENT_BUTTON:
            message <span style="color:#f92672">=</span> on_pushed_get_event_button(account_id, status)

    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
        <span style="color:#66d9ef">print</span>(e)
        message <span style="color:#f92672">=</span> MESSAGE_LIST[<span style="color:#ae81ff">6</span>]
    
    <span style="color:#75715e"># Notify SQS of message contents</span>
    sqs <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>resource(<span style="color:#e6db74">&#34;sqs&#34;</span>)
    queue <span style="color:#f92672">=</span> sqs<span style="color:#f92672">.</span>get_queue_by_name(QueueName<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;lineworks-message-queue&#34;</span>)
    
    queue<span style="color:#f92672">.</span>send_message(
        MessageBody<span style="color:#f92672">=</span>json<span style="color:#f92672">.</span>dumps(
            {
                <span style="color:#e6db74">&#34;content&#34;</span>: {
                    <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;text&#34;</span>,
                    <span style="color:#e6db74">&#34;text&#34;</span>: message,
                },
                <span style="color:#e6db74">&#34;account_id&#34;</span>: account_id,
            }
        ),
    )

    <span style="color:#66d9ef">return</span> True
</code></pre></div><p>Finally, it is the implementation of processing for each event.
In each event, branch processing for each state is implemented based on the state transition table.
The overlapping processes are summarized.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_join</span>(account_id, status):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Handling events when adding a bot
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>

    <span style="color:#75715e"># Branch processing according to status</span>
    <span style="color:#66d9ef">if</span> status <span style="color:#f92672">==</span> STATUS_NO_USER:

        table<span style="color:#f92672">.</span>put_item(
            Item<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;Hash&#34;</span>: <span style="color:#e6db74">&#34;status_&#34;</span> <span style="color:#f92672">+</span> account_id,
                <span style="color:#e6db74">&#34;Range&#34;</span>: <span style="color:#e6db74">&#34;-&#34;</span>,
                <span style="color:#e6db74">&#34;Status&#34;</span>: STATUS_WATING_FOR_BUTTON_PUSH,
            }
        )
        <span style="color:#66d9ef">return</span> MESSAGE_LIST[<span style="color:#ae81ff">0</span>]
    
    <span style="color:#66d9ef">else</span>:

        table<span style="color:#f92672">.</span>delete_item(
            Key<span style="color:#f92672">=</span>{
                <span style="color:#e6db74">&#34;Hash&#34;</span>: <span style="color:#e6db74">&#34;status_&#34;</span> <span style="color:#f92672">+</span> account_id,
                <span style="color:#e6db74">&#34;Range&#34;</span>: <span style="color:#e6db74">&#34;-&#34;</span>
            }
        )
        
        table<span style="color:#f92672">.</span>put_item(
            Item<span style="color:#f92672">=</span>{
                <span style="color:#e6db74">&#34;Hash&#34;</span>: <span style="color:#e6db74">&#34;status_&#34;</span> <span style="color:#f92672">+</span> account_id,
                <span style="color:#e6db74">&#34;Range&#34;</span>: <span style="color:#e6db74">&#34;-&#34;</span>,
                <span style="color:#e6db74">&#34;Status&#34;</span>: STATUS_WATING_FOR_BUTTON_PUSH,
            }
        )
        
        <span style="color:#66d9ef">return</span> MESSAGE_LIST[<span style="color:#ae81ff">0</span>]

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_message</span>(account_id, status, text):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    テキスト入力時のイベントの処理
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>

    <span style="color:#66d9ef">if</span> status <span style="color:#f92672">==</span> STATUS_WATING_FOR_BUTTON_PUSH:

        table<span style="color:#f92672">.</span>put_item(
            Item<span style="color:#f92672">=</span>{
                <span style="color:#e6db74">&#34;Hash&#34;</span>: <span style="color:#e6db74">&#34;status_&#34;</span> <span style="color:#f92672">+</span> account_id,
                <span style="color:#e6db74">&#34;Range&#34;</span>: <span style="color:#e6db74">&#34;-&#34;</span>,
                <span style="color:#e6db74">&#34;Status&#34;</span>: STATUS_WATING_FOR_BUTTON_PUSH,
            }
        )
        <span style="color:#66d9ef">return</span> MESSAGE_LIST[<span style="color:#ae81ff">2</span>]

    <span style="color:#66d9ef">elif</span> status <span style="color:#f92672">==</span> STATUS_WATING_FOR_NAME_INPUT:

        table<span style="color:#f92672">.</span>update_item(
            Key<span style="color:#f92672">=</span>{
                <span style="color:#e6db74">&#34;Hash&#34;</span>: <span style="color:#e6db74">&#34;status_&#34;</span> <span style="color:#f92672">+</span> account_id,
                <span style="color:#e6db74">&#34;Range&#34;</span>: <span style="color:#e6db74">&#34;-&#34;</span>,
            },
            UpdateExpression<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;set #st = :s, Title = :t&#34;</span>,
            ExpressionAttributeNames <span style="color:#f92672">=</span> {
                <span style="color:#e6db74">&#34;#st&#34;</span>: <span style="color:#e6db74">&#34;Status&#34;</span> <span style="color:#75715e"># Statusは予約語なので#stに置き換える</span>
            },
            ExpressionAttributeValues<span style="color:#f92672">=</span>{
                <span style="color:#e6db74">&#34;:s&#34;</span>: STATUS_WATING_FOR_TIME_INPUT,
                <span style="color:#e6db74">&#34;:t&#34;</span>: text,
            },
        )
        <span style="color:#66d9ef">return</span> MESSAGE_LIST[<span style="color:#ae81ff">4</span>]

    <span style="color:#66d9ef">elif</span> status <span style="color:#f92672">==</span> STATUS_WATING_FOR_TIME_INPUT:

        <span style="color:#75715e"># dateutil.parserで日付は変換</span>
        time_dt <span style="color:#f92672">=</span> dateutil<span style="color:#f92672">.</span>parser<span style="color:#f92672">.</span>parse(text)
        time <span style="color:#f92672">=</span> time_dt<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#34;%Y/%m/</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#34;</span>)

        response <span style="color:#f92672">=</span> table<span style="color:#f92672">.</span>get_item(
            Key<span style="color:#f92672">=</span>{
                <span style="color:#e6db74">&#34;Hash&#34;</span>: <span style="color:#e6db74">&#34;status_&#34;</span> <span style="color:#f92672">+</span> account_id,
                <span style="color:#e6db74">&#34;Range&#34;</span>: <span style="color:#e6db74">&#34;-&#34;</span>,
            }
        )

        table<span style="color:#f92672">.</span>put_item(
            Item<span style="color:#f92672">=</span>{
                <span style="color:#e6db74">&#34;Hash&#34;</span>: <span style="color:#e6db74">&#34;event_&#34;</span> <span style="color:#f92672">+</span> account_id,
                <span style="color:#e6db74">&#34;Range&#34;</span>: time,
                <span style="color:#e6db74">&#34;Title&#34;</span>: response[<span style="color:#e6db74">&#34;Item&#34;</span>][<span style="color:#e6db74">&#34;Title&#34;</span>],
                <span style="color:#75715e"># utc -&gt; 日本時間変換のため、9時間の差分をとる</span>
                <span style="color:#75715e"># utc -&gt; 当初の予定 + 1h後に削除するように設定</span>
                <span style="color:#e6db74">&#34;ExpireTime&#34;</span>: int((time_dt <span style="color:#f92672">-</span> relativedelta(hours<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span>) <span style="color:#f92672">+</span> relativedelta(hours<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))<span style="color:#f92672">.</span>timestamp()),
                <span style="color:#e6db74">&#34;SentFlag&#34;</span>: False
            }
        ),

        table<span style="color:#f92672">.</span>put_item(
            Item<span style="color:#f92672">=</span>{
                <span style="color:#e6db74">&#34;Hash&#34;</span>: <span style="color:#e6db74">&#34;status_&#34;</span> <span style="color:#f92672">+</span> account_id,
                <span style="color:#e6db74">&#34;Range&#34;</span>: <span style="color:#e6db74">&#34;-&#34;</span>,
                <span style="color:#e6db74">&#34;Status&#34;</span>: STATUS_WATING_FOR_BUTTON_PUSH,
            }
        )

        <span style="color:#66d9ef">return</span> MESSAGE_LIST[<span style="color:#ae81ff">5</span>]

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_pushed_put_event_button</span>(account_id, status):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    「イベント登録」ボタン押下時のイベントの処理
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>

    <span style="color:#66d9ef">if</span> status <span style="color:#f92672">==</span> STATUS_WATING_FOR_BUTTON_PUSH:
    
        table<span style="color:#f92672">.</span>put_item(
            Item<span style="color:#f92672">=</span>{
                <span style="color:#e6db74">&#34;Hash&#34;</span>: <span style="color:#e6db74">&#34;status_&#34;</span> <span style="color:#f92672">+</span> account_id,
                <span style="color:#e6db74">&#34;Range&#34;</span>: <span style="color:#e6db74">&#34;-&#34;</span>,
                <span style="color:#e6db74">&#34;Status&#34;</span>: STATUS_WATING_FOR_NAME_INPUT,
            }
        )
        <span style="color:#66d9ef">return</span> MESSAGE_LIST[<span style="color:#ae81ff">1</span>]
    
    <span style="color:#66d9ef">elif</span> status <span style="color:#f92672">==</span> STATUS_WATING_FOR_NAME_INPUT:

        <span style="color:#66d9ef">return</span> MESSAGE_LIST[<span style="color:#ae81ff">1</span>]
    
    <span style="color:#66d9ef">elif</span> status <span style="color:#f92672">==</span> STATUS_WATING_FOR_TIME_INPUT:

        table<span style="color:#f92672">.</span>put_item(
            Item<span style="color:#f92672">=</span>{
                <span style="color:#e6db74">&#34;Hash&#34;</span>: <span style="color:#e6db74">&#34;status_&#34;</span> <span style="color:#f92672">+</span> account_id,
                <span style="color:#e6db74">&#34;Range&#34;</span>: <span style="color:#e6db74">&#34;-&#34;</span>,
                <span style="color:#e6db74">&#34;Status&#34;</span>: STATUS_WATING_FOR_NAME_INPUT,
            }
        )
        <span style="color:#66d9ef">return</span> MESSAGE_LIST[<span style="color:#ae81ff">1</span>]

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_pushed_get_event_button</span>(account_id, status):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    「イベント参照」ボタン押下時のイベントの処理
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>

    current_jst_time <span style="color:#f92672">=</span> (datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>utcnow() <span style="color:#f92672">+</span> relativedelta(hours<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span>))<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#34;%Y/%m/</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#34;</span>)

    <span style="color:#75715e"># event取得処理 </span>
    response <span style="color:#f92672">=</span> table<span style="color:#f92672">.</span>query(
        KeyConditionExpression<span style="color:#f92672">=</span>Key(<span style="color:#e6db74">&#34;Hash&#34;</span>)<span style="color:#f92672">.</span>eq(<span style="color:#e6db74">&#34;event_&#34;</span> <span style="color:#f92672">+</span> account_id) <span style="color:#f92672">&amp;</span> Key(<span style="color:#e6db74">&#34;Range&#34;</span>)<span style="color:#f92672">.</span>gt(current_jst_time)
    )

    items <span style="color:#f92672">=</span> response[<span style="color:#e6db74">&#34;Items&#34;</span>] <span style="color:#f92672">or</span> []
    
    message <span style="color:#f92672">=</span> MESSAGE_LIST[<span style="color:#ae81ff">3</span>]

    <span style="color:#66d9ef">if</span> len(items) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        message <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">-----&#34;</span>
        message <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">なし&#34;</span>
        message <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">-----&#34;</span>

    <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> items:

        message <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">-----&#34;</span>
        message <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> タイトル: {title}&#34;</span><span style="color:#f92672">.</span>format(title<span style="color:#f92672">=</span>item[<span style="color:#e6db74">&#34;Title&#34;</span>]) 
        message <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> 日時: {time}&#34;</span><span style="color:#f92672">.</span>format(time<span style="color:#f92672">=</span>item[<span style="color:#e6db74">&#34;Range&#34;</span>]) 
        message <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">-----&#34;</span>
    
    <span style="color:#66d9ef">return</span> message
</code></pre></div><h2 id="まとめ">まとめ</h2>
<p>状態遷移表を作成することで、各イベント時にどのような処理を実装すべきか、
どのメッセージを返すべきか、が明確になるので迷いなく実装することができました。</p>
<p>今回は、シンプルなアプリだったので状態やイベントの数も少ないですが、
より複雑な処理をBOTにさせようとすると状態遷移表がより役に立ってくるかと思います。</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
