<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>I tried Learning-to-Rank with Elasticsearch! | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>I tried Learning-to-Rank with Elasticsearch!</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 22, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/elasticsearch">Elasticsearch</a></code></small>

</p>
<pre><code>This article is the 21st day article of [Just Collective AdventCalendar 2019](https://adventar.org/calendars/4054).
</code></pre>
<h2 id="introduction">Introduction</h2>
<p>The day before my charge, I was asked &ldquo;I want to do Learning-to-rank with Elasticsearch, so please summarize the procedure of environment construction and how to use it. Yoropico!&rdquo;, so this time it is the procedure for building Elasticsearch with learning-to-rank. I will show you how to use it.</p>
<p>The one created this time is <a href="https://github.com/wararaki/sample-learning-to-rank">here</a></p>
<h2 id="what-is-learning-to-rank">What is Learning-to-rank</h2>
<p>Learning-to-rank in search engines is a technique that uses machine learning and the data to be searched to improve the order of ranking of search results. It is also called order learning or ranking learning.</p>
<p>This time, I use Elasticsearch&rsquo;s <a href="https://github.com/o19s/elasticsearch-learning-to-rank">learning-to-rank plugin</a>. I would like to try improving the ranking by using the demo in the learning-to-rank repository.</p>
<h2 id="environment">Environment</h2>
<p>To try out the demo, build the following environment in advance.</p>
<ul>
<li>Java execution environment</li>
<li>Python3 execution environment</li>
<li>Introduced learning-to-rank plugin to Elasticsearch
-https://github.com/elastic/elasticsearch
-https://github.com/o19s/elasticsearch-learning-to-rank</li>
</ul>
<p>Building a Elasticsearch plugin with a docker image is easy.</p>
<ul>
<li><a href="https://hub.docker.com/_/elasticsearch">https://hub.docker.com/_/elasticsearch</a></li>
</ul>
<p>Below is a sample of Elasticsearch with Learning-to-Rank docker image</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> elasticsearch:7.4.1</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> bin/elasticsearch-plugin install -b http://es-learn-to-rank.labs.o19s.com/ltr-1.1.2-es7.4.1.zip<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>After building the environment, clone the Learning-to-Rank repository and move it to the demo directory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ git clone https://github.com/o19s/elasticsearch-learning-to-rank.git
$ cd elasticsearch-learning-to-rank/demo
</code></pre></div><p>After moving to the demo directory, execute the scripts in order and experience Learning-to-Rank!</p>
<h2 id="data-and-library-preparation">Data and library preparation</h2>
<p>Execute prepare.py to download the search data and the library (Ranklib) that creates the learning model.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$python prepare.py
</code></pre></div><p>When executed, downloads movie data (tmdb.json) and ranking learning library (RankLibPlus-0.1.0.jar). (Because tmdb.json is large, it takes time to download it.)
After downloading is complete, prepare the Elasticsearch environment.</p>
<h2 id="prepare-elasticsearch-environment">Prepare Elasticsearch environment</h2>
<p>Launch Elasticsearch with the Learning-to-Rank plugin installed and enter data. After Elasticsearch starts, execute index_ml_tmdb.py to set the index and insert the data. Run the following script to insert tmdb.json into Elasticsearch.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$python index_ml_tmdb.py
</code></pre></div><p>After setting the index and inserting the data, the next step is to set up a query for the feature transformation used for training. Execute the following script to set the field used for learning. (Refer to demo/1.json and demo/2.json for the fields to be set. In demo, the search score of title and overview is set as feature.)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ python load_features.py
</code></pre></div><p>When the field to convert the data to the feature is ready, create the model.</p>
<h2 id="deploy-the-model-to-elasticsearch">Deploy the model to Elasticsearch</h2>
<p>Run train.py to create a model and deploy it to Elasticsearch.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$python train.py
</code></pre></div><p>In train.py, the following processing is executed.</p>
<ul>
<li>Preprocessing
-Parse sample_judgements.txt and convert to ranklib format.</li>
<li>Model generation
-Run Ranklib to create a model.</li>
<li>Model deployment
-Introduce the model to Easticsearch.</li>
</ul>
<h3 id="preprocessing">Preprocessing</h3>
<p>In the demo, learn <a href="https://github.com/o19s/elasticsearch-learning-to-rank/blob/master/demo/sample_judgments.txt">sample_judgements.txt</a> to improve the ranking of search results. ..
sample_judgements.txt represents the search results (#7555 Rambo, #1370 Rambo III, &hellip;) for the search query (qid), and the evaluation value (grade) is set for each search query and search result pair. I will. In demo, there are three types of queries:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"># qid:1: rambo
# qid:2: rocky
# qid:3: bullwinkle
</code></pre></div><p>Set grade for the search results of each query. (The larger the number, the better.)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"># grade (0-4) queryid docId title
4 qid: 1 # 7555 Rambo
3 qid: 1 # 1370 Rambo III
3 qid:1 # 1369 Rambo: First Blood Part II
3 qid: 1 # 1368 First Blood
0 qid:1 # 136278 Blood
0 qid:1 # 102947 First Daughter
0 qid:1 # 13969 First Daughter
0 qid:1 # 61645 First Love
0 qid:1 # 14423 First Sunday
0 qid:1 # 54156 First Desires
4 qid:2 # 1366 Rocky
3 qid:2 #1246 Rocky Balboa
3 qid:2 # 60375 Rocky VI
3 qid:2 # 1371 Rocky III
3 qid:2 # 1375 Rocky V
3 qid:2 # 1374 Rocky IV
0 qid:2 # 110123 Incredible Rocky Mountain Race
0 qid:2 # 17711 The Adventures of Rocky &amp; Bullwinkle
0 qid:2 # 36685 The Rocky Horror Picture Show
4 qid:3 # 17711 The Adventures of Rocky &amp; Bullwinkle
0 qid:3 #1246 Rocky Balboa
0 qid:3 # 60375 Rocky VI
0 qid:3 #1371 Rocky III
0 qid:3 # 1375 Rocky V
0 qid:3 # 1374 Rocky IV
</code></pre></div><p>When this data is converted to <a href="https://sourceforge.net/p/lemur/wiki/RankLib%20File%20Format/">Ranklib Format</a>, the following data will be obtained.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">4 qid:1 1:12.318474 2:10.573917 # 7555 rambo
3 qid:1 1:10.357875 2:11.950391 # 1370 rambo
3 qid:1 1:7.010513 2:11.220095 # 1369 rambo
3 qid:1 1:0.0 2:11.220095 # 1368 rambo
0 qid:1 1:0.0 2:0.0 # 136278 rambo
0 qid:1 1:0.0 2:0.0 # 102947 rambo
0 qid:1 1:0.0 2:0.0 # 13969 rambo
0 qid:1 1:0.0 2:0.0 # 61645 rambo
0 qid:1 1:0.0 2:0.0 # 14423 rambo
0 qid:1 1:0.0 2:0.0 # 54156 rambo
4 qid:2 1:10.686391 2:8.814846 # 1366 rocky
3 qid:2 1:8.985554 2:9.984511 # 1246 rocky
3 qid:2 1:8.985554 2:8.067703 # 60375 rocky
3 qid:2 1:8.985554 2:5.660549 # 1371 rocky
3 qid:2 1:8.985554 2:7.300772 # 1375 rocky
3 qid:2 1:8.985554 2:8.814846 # 1374 rocky
0 qid:2 1:6.815921 2:0.0 # 110123 rocky
0 qid:2 1:6.0816855 2:8.725066 # 17711 rocky
0 qid:2 1:6.0816855 2:5.9764795 # 36685 rocky
4 qid:3 1:7.6720834 2:12.722421 # 17711 bullwinkle
0 qid:3 1:0.0 2:0.0 # 1246 bullwinkle
0 qid:3 1:0.0 2:0.0 # 60375 bullwinkle0 qid:3 1:0.0 2:0.0 # 1371 bullwinkle
0 qid:3 1:0.0 2:0.0 # 1375 bullwinkle
0 qid:3 1:0.0 2:0.0 # 1374 bullwinkle
</code></pre></div><p>Use this data to create a model.</p>
<h3 id="model-generation">model generation</h3>
<p>Create a model. The demo produces the following model.</p>
<ul>
<li>MART</li>
<li>RankNet</li>
<li>RankBoost</li>
<li>AdaRank</li>
<li>coord Ascent</li>
<li>LambdaMART</li>
<li>ListNET</li>
<li>Random Forest</li>
<li>Linear Regression</li>
</ul>
<p>(Details of each model are omitted here.)</p>
<h3 id="model-upload">model upload</h3>
<p>Upload your model to Elasticsearch. Upload the model generated by Post request. Below sample.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">POST _ltr/_featureset/movie_features/_createmodel
<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;model&#34;</span>: <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;test_9&#34;</span>,
        <span style="color:#e6db74">&#34;model&#34;</span>: <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;model/ranklib&#34;</span>,
            <span style="color:#e6db74">&#34;definition&#34;</span>: <span style="color:#e6db74">&#34;## Linear Regression\n## Lambda = 1.0E-10\n0:0.2943936467995844 1:0.2943936467995844 2:0.12167703031808977&#34;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Specify model.name to search using the uploaded model.</p>
<h2 id="search-for">Search for</h2>
<p>Do a real search and experience the improved search results with Learning-to-Rank! When you run search.py, you will get the following search results.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ python search.py Rambo
<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;query&#34;</span>: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;multi_match&#34;</span>: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;query&#34;</span>: <span style="color:#e6db74">&#34;Rambo&#34;</span>, <span style="color:#e6db74">&#34;fields&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;title&#34;</span>, <span style="color:#e6db74">&#34;overview&#34;</span><span style="color:#f92672">]}}</span>, <span style="color:#e6db74">&#34;rescore&#34;</span>: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;query&#34;</span>: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;rescore_query&#34;</span>: <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;sltr&#34;</span>: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;params&#34;</span>: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;keywords&#34;</span>: <span style="color:#e6db74">&#34;Rambo&#34;</span><span style="color:#f92672">}</span>, <span style="color:#e6db74">&#34;model&#34;</span>: <span style="color:#e6db74">&#34;test_6&#34;</span><span style="color:#f92672">}}}}}</span>
Rambo
Rambo III
Rambo: First Blood Part II
First Blood
In the Line of Duty: The F.B.I.Murders
Son of Rambow
Spud
$
</code></pre></div><p>Since it is difficult to understand, I prepared the result of comparing learning-to-rank with/without Learning-to-Rank. The following results are obtained respectively.</p>
<pre><code>## search with learning-to-rank
1 Rambo
2 Rambo III
3 Rambo: First Blood Part II
4 First Blood
5 In the Line of Duty: The F.B.I.Murders
6 Son of Rambow
7 Spud

## search without learning-to-rank
1 Rambo
2 Rambo III
3 First Blood
4 Rambo: First Blood Part II
5 In the Line of Duty: The F.B.I.Murders
6 Son of Rambow
7 Spud
</code></pre><p>The learning result is reflected! !</p>
<h2 id="summary">Summary</h2>
<p>This time, I introduced the procedure to try Learning-to-rank in Elasticsearch and reflected Learning-to-Rank in the search engine. We have compiled it in the <a href="https://github.com/wararaki/sample-learning-to-rank">repository</a> so that you can easily try the libraries used this time, so I hope you can use it.
Also, this article introduced the execution procedure, but if there is an opportunity, I would like to introduce the details of each logic of Learning-to-Rank and the mechanism of the library used this time.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
