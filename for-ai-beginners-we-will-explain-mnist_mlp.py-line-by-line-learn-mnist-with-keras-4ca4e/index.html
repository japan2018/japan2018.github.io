<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[For AI beginners] We will explain mnist_mlp.py line by line (learn MNIST with Keras) | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[For AI beginners] We will explain mnist_mlp.py line by line (learn MNIST with Keras)</h1>
<p>
  <small class="text-secondary">
  
  
  Nov 30, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/deeplearning">DeepLearning</a></code></small>


<small><code><a href="https://memotut.com/tags/keras">Keras</a></code></small>


<small><code><a href="https://memotut.com/tags/tensorflow">TensorFlow</a></code></small>


<small><code><a href="https://memotut.com/tags/mnist">MNIST</a></code></small>

</p>
<pre><code>#Introduction
</code></pre>
<p>Nice to meet you all.
This article is just an article that explains <a href="https://github.com/keras-team/keras/blob/master/examples/mnist_mlp.py">mnist_mlp.py</a> line by line.
It is for people who are interested in AI but haven&rsquo;t touched it yet. I think that if you read this, you should understand the basic learning flow of deep learning, so I will write. (Originally, it was created in-house with the intention of using it for training)</p>
<p>All three times.</p>
<ol>
<li>[For AI beginners] We will explain mnist_mlp.py line by line (learn MNIST with Keras)</li>
<li><a href="https://qiita.com/nashineko/items/69cc529117c92ecb1190">[For AI beginners] Explaining mnist_cnn.py line by line (Learning MNIST with Keras)</a></li>
<li><a href="https://qiita.com/nashineko/items/129835aa606f5e2042c0">[For beginners of AI] Explaining mnist_transfer_cnn.py line by line (Keras learns MNIST)</a></li>
</ol>
<h2 id="operation-check-method">Operation check method</h2>
<p>Since MNIST is an image, it is better to have a GPU to run this code (CPU is a bit painful).
The recommended method is to use <a href="https://colab.research.google.com/notebooks/welcome.ipynb?hl=ja">Google Colaboratory</a>.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/351213/87ea5af7-1fa3-22a8-d520-427d53695f4b.gif" alt="colab.gif">
There are only two things to do.
Â· Open a new notebook in Python3</p>
<ul>
<li>Enable GPU from runtime
Now you can use the GPU.
Just paste the code in a cell and execute (shortcut is CTRL+ENTER) to move.</li>
</ul>
<p>About #mnist
A handwritten image data set, often used in machine learning tutorials.
Contents: 0-9 handwritten characters
Image size: 28pix*28pix
Color: black and white
Data size: 70,000 sheets (60,000 training data and 10,000 test data images and labels are available)</p>
<p>What is #mlp
Multilayer perceptron.
mnist is image data, but it can be learned as mlp by changing the form of image data from (28, 28) to (784,). (The accuracy is higher with CNN in the second session.)</p>
<p>About #mnist_mlp.py
It is a code that creates a model that determines handwritten characters of mnist using Keras and TensorFlow.
Create a model that receives 10 types of handwritten characters 0 to 9 as input and classifies them into 0 to 9 types.</p>
<p>#Code explanation</p>
<h2 id="preparation">Preparation</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74">&#39;&#39;&#39;Trains a simple deep NN on the MNIST dataset.
</span><span style="color:#e6db74">Gets to 98.40% test accuracy after 20 epochs
</span><span style="color:#e6db74">(there is *a lot* of margin for parameter tuning).
</span><span style="color:#e6db74">2 seconds per epoch on a K520 GPU.
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>

<span style="color:#75715e"># Code not specifically required (needed if the Python version is 3, but the code is written in Python 2)</span>
<span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> print_function

<span style="color:#75715e"># Import the required libraries</span>
<span style="color:#f92672">import</span> keras
<span style="color:#f92672">from</span> keras.datasets <span style="color:#f92672">import</span> mnist
<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> Sequential
<span style="color:#f92672">from</span> keras.layers <span style="color:#f92672">import</span> Dense, Dropout
<span style="color:#f92672">from</span> keras.optimizers <span style="color:#f92672">import</span> RMSprop

<span style="color:#75715e"># Specify constants all together</span>
batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span> <span style="color:#75715e"># Batch size. Data size to learn at once</span>
num_classes <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#75715e"># Number of labels to classify. This time, we classify handwritten images into 10 types from 0 to 9.</span>
epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span> <span style="color:#75715e"># number of epochs. How many times to learn all data</span>
</code></pre></div><h2 id="data-preprocessing">Data preprocessing</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Load <span style="color:#75715e">#mnist data and divide into training data (60,000) and test data (10,000)</span>
(x_train, y_train), (x_test, y_test) <span style="color:#f92672">=</span> mnist<span style="color:#f92672">.</span>load_data()

<span style="color:#e6db74">&#39;&#39;&#39; Reshape and format the data so that it can be used as input data in mlp
</span><span style="color:#e6db74">x_train: (60000, 28, 28) -&gt; (60000, 784) 28pix* Make 28pix images into one column
</span><span style="color:#e6db74">x_test: (10000, 28, 28) -&gt;(10000, 784) 28pix* Make 28pix images into one column&#39;&#39;&#39;</span>
x_train <span style="color:#f92672">=</span> x_train<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">60000</span>, <span style="color:#ae81ff">784</span>)
x_test <span style="color:#f92672">=</span> x_test<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">10000</span>, <span style="color:#ae81ff">784</span>)

<span style="color:#75715e"># Image data takes a value from 0 to 255, so divide it by 255 to standardize the data.</span>
Convert the data type <span style="color:#66d9ef">with</span> <span style="color:#75715e"># .astype(&#39;float32&#39;). (If you don&#39;t, you&#39;ll get an error when you break)</span>
x_train <span style="color:#f92672">=</span> x_train<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float32&#39;</span>)
x_test <span style="color:#f92672">=</span> x_test<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float32&#39;</span>)
x_train <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255</span>
x_test <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255</span>

<span style="color:#75715e"># Output and check the number of data</span>
<span style="color:#66d9ef">print</span>(x_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>],<span style="color:#e6db74">&#39;train samples&#39;</span>)
<span style="color:#66d9ef">print</span>(x_test<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>],<span style="color:#e6db74">&#39;test samples&#39;</span>)

<span style="color:#75715e"># Make label data one-hot-vector</span>
<span style="color:#e6db74">&#39;&#39;&#39;One-hot-vector image looks like this
</span><span style="color:#e6db74">label 0 1 2 3 4 5 6 7 8 9
</span><span style="color:#e6db74">0: [1,0,0,0,0,0,0,0,0,0]
</span><span style="color:#e6db74">8: [0,0,0,0,0,0,0,0,1,0]&#39;&#39;&#39;</span>
y_train <span style="color:#f92672">=</span> keras<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>to_categorical(y_train, num_classes)
y_test <span style="color:#f92672">=</span> keras<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>to_categorical(y_test, num_classes)
</code></pre></div><p>Regarding standardization: The value of each pixel in the image is 0 to 255. It is an image to convert this to 0~1. When performing machine learning with images, roughly divide by 255 to standardize the values.</p>
<p>About one-hot-vector: This time, there are 10 types of labels, 0-9, each of which is represented by a number of 0-9. However, the numbers themselves on the label have no meaning because we only want to classify them into 10 types. Therefore, by making one-hot-vector, it is converted so that it can express which label is only 0 and 1.</p>
<h2 id="model-definition">Model definition</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Instantiate the Sequential class</span>
model <span style="color:#f92672">=</span> Sequential()

<span style="color:#75715e"># Middle layer</span>
<span style="color:#75715e"># Add a fully connected layer (512 units, activation function: Relu, received input size: 784)</span>
model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">512</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>, input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">784</span>,)))
<span style="color:#75715e"># 0.2 dropout</span>
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.2</span>))
<span style="color:#75715e"># Add a fully connected layer (512 units, activation function: Relu, input size received automatically)</span>
model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">512</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>))
<span style="color:#75715e"># 0.2 dropout</span>
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.2</span>))

<span style="color:#75715e"># Output layer</span>
<span style="color:#75715e"># Add a fully connected layer (10 units, activation function: SoftMax, input size received automatically)</span>
model<span style="color:#f92672">.</span>add(Dense(num_classes, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;softmax&#39;</span>))

<span style="color:#75715e"># Visualize model structure</span>
model<span style="color:#f92672">.</span>summary()
</code></pre></div><p>The Sequential model is a model created by stacking layers of DNN. You need to specify the input_shape only for the very first layer.
For the activation function of the output layer, softmax is used because it is a model for multilevel classification this time.</p>
<h2 id="learning">learning</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Set up the learning process</span>
model<span style="color:#f92672">.</span>compile(
              <span style="color:#75715e"># Set loss function. This time it&#39;s categorical_crossentropy</span>
              loss<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;categorical_crossentropy&#39;</span>,
              <span style="color:#75715e"># Specify optimization algorithm. You can tamper with the learning rate</span>
              optimizer<span style="color:#f92672">=</span>RMSprop(),
              <span style="color:#75715e"># Specify evaluation function</span>
              metrics<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;accuracy&#39;</span>])

<span style="color:#75715e"># Let them learn</span>
history <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>fit(
                    <span style="color:#75715e"># Learning data, label</span>
                    x_train, y_train,
                    <span style="color:#75715e"># Batch size (128)</span>
                    batch_size<span style="color:#f92672">=</span>batch_size,
                    <span style="color:#75715e"># Epoch number (20)</span>
                    epochs<span style="color:#f92672">=</span>epochs,
                    <span style="color:#75715e"># Show progress of learning in real time as a bar graph (0 is hidden)</span>
                    verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
                    <span style="color:#75715e">#Test data (to test for each epoch and calculate the error)</span>
                    validation_data<span style="color:#f92672">=</span>(x_test, y_test))
</code></pre></div><p>After defining the model, specify the loss function and optimization algorithm and compile. Then pass the data to the model for training. In order to make a better model, it is necessary to try various optimization algorithms, batch size, number of epochs, etc.</p>
<h2 id="evaluation">Evaluation</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Pass test data (verbose=0, no progress message)</span>
score <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>evaluate(x_test, y_test, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
<span style="color:#75715e"># Output generalization error</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Test loss:&#39;</span>, score[<span style="color:#ae81ff">0</span>])
<span style="color:#75715e"># Output generalization performance</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Test accuracy:&#39;</span>, score[<span style="color:#ae81ff">1</span>])
</code></pre></div><p>After learning, use the test data to evaluate how well the performance has improved. The lower the loss and the higher the accuracy, the better the model.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
