<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://japan2018.github.io/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://japan2018.github.io/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://japan2018.github.io/favicon-16x16.png">

  
  <link rel="manifest" href="https://japan2018.github.io/site.webmanifest">

  
  <link rel="mask-icon" href="https://japan2018.github.io/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://japan2018.github.io/css/bootstrap.min.css" />

  
  <title>Learn while making! Deep reinforcement learning_1 | Some Title</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Learn while making! Deep reinforcement learning_1</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 18, 2019
  </small>
  

<small><code><a href="https://japan2018.github.io/tags/python">Python</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/reinforcement-learning"> Reinforcement Learning</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/pytorch"> PyTorch</a></code></small>

</p>
<pre><code># Deep Reinforcement Learning-Practical Programming with Pytorch-
</code></pre>
<p>I am Harima, a 1st year master of science graduate student.
I will summarize my learning contents in a memo. I&rsquo;m sorry it&rsquo;s hard to see.
I would like to know what you do not understand.</p>
<hr>
<p>Implementation code (GitHub)
<a href="https://github.com/YutaroOgawa/Deep-Reinforcement-Learning-Book">https://github.com/YutaroOgawa/Deep-Reinforcement-Learning-Book</a></p>
<hr>
<h2 id="chap2-lets-implement-reinforcement-learning-for-maze-tasks">Chap.2 Let&rsquo;s implement reinforcement learning for maze tasks</h2>
<h3 id="21-how-to-use-python">2.1 How to use Python</h3>
<h3 id="22-implement-mazes-and-agents">2.2 Implement mazes and agents</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">import numpy as np
import matplotlib<span style="color:#f92672">.</span>pyplot as plt
<span style="color:#f92672">%</span>matplotlib inline
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">fig<span style="color:#f92672">=</span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">5</span>))
ax<span style="color:#f92672">=</span>plt<span style="color:#f92672">.</span>gca()


plt<span style="color:#f92672">.</span>plot(<span style="color:#f92672">[</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span><span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span><span style="color:#f92672">]</span>,color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;red&#39;</span>,linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
plt<span style="color:#f92672">.</span>plot(<span style="color:#f92672">[</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span><span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">2</span><span style="color:#f92672">]</span>,color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;red&#39;</span>,linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
plt<span style="color:#f92672">.</span>plot(<span style="color:#f92672">[</span><span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">2</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span><span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span><span style="color:#f92672">]</span>,color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;red&#39;</span>,linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
plt<span style="color:#f92672">.</span>plot(<span style="color:#f92672">[</span><span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span><span style="color:#f92672">]</span>,color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;red&#39;</span>,linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)


plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">2</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#e6db74">&#39;S0&#39;</span>,size<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>,ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>)
plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">2</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#e6db74">&#39;S1&#39;</span>,size<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>,ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>)
plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">2</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">2</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#e6db74">&#39;S2&#39;</span>,size<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>,ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>)
plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#e6db74">&#39;S3&#39;</span>,size<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>,ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>)
plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#e6db74">&#39;S4&#39;</span>,size<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>,ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>)
plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">2</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#e6db74">&#39;S5&#39;</span>,size<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>,ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>)
plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#e6db74">&#39;S6&#39;</span>,size<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>,ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>)
plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#e6db74">&#39;S7&#39;</span>,size<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>,ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>)
plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">2</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#e6db74">&#39;S8&#39;</span>,size<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>,ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>)
plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">2</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span>,<span style="color:#e6db74">&#39;START&#39;</span>,ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>)

plt<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">2</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3</span>,<span style="color:#e6db74">&#39;GOAL&#39;</span>,ha<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>)


ax<span style="color:#f92672">.</span>set_xlim(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>)
ax<span style="color:#f92672">.</span>set_ylim(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>)
plt<span style="color:#f92672">.</span>tick_params(axis<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;both&#39;</span>,which<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;both&#39;</span>,bottom<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;off&#39;</span>,top<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;off&#39;</span>,
                labelbottom<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;off&#39;</span>,right<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;off&#39;</span>,left<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;off&#39;</span>,labelleft<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;off&#39;</span>)


line, <span style="color:#f92672">=</span>ax<span style="color:#f92672">.</span>plot(<span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span><span style="color:#f92672">]</span>,<span style="color:#f92672">[</span><span style="color:#ae81ff">2</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span><span style="color:#f92672">]</span>,marker<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;o&#34;</span>,color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;g&#39;</span>,markersize<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span>)

</code></pre></div><p>![Screenshot from 2019-12-18 17-42-22.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/ef31f47c-c2b5-97c8-(855c-ab8849402cdf.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/ef31f47c-c2b5-97c8-(855c-ab8849402cdf.png)</a></p>
<blockquote>
<p>It&rsquo;s an overview of the maze.</p>
</blockquote>
<p>・The rules that define how agents behave are called <strong>policy</strong>.</p>
<p>・ Expressed as $\pi_\theta(s,a)$</p>
<p>・The probability of adopting the action $a$ in the state $s$ follows the policy $\pi$ determined by the parameter $\theta$</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">theta_0 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(<span style="color:#f92672">[[</span>np<span style="color:#f92672">.</span>nan, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, np<span style="color:#f92672">.</span>nan<span style="color:#f92672">]</span>,
                    <span style="color:#f92672">[</span>np<span style="color:#f92672">.</span>nan, <span style="color:#ae81ff">1</span>, np<span style="color:#f92672">.</span>nan, <span style="color:#ae81ff">1</span><span style="color:#f92672">]</span>,
                    <span style="color:#f92672">[</span>np<span style="color:#f92672">.</span>nan, np<span style="color:#f92672">.</span>nan, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span><span style="color:#f92672">]</span>,
                    <span style="color:#f92672">[</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, np<span style="color:#f92672">.</span>nan<span style="color:#f92672">]</span>,
                    <span style="color:#f92672">[</span>np<span style="color:#f92672">.</span>nan, np<span style="color:#f92672">.</span>nan, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span><span style="color:#f92672">]</span>,
                    <span style="color:#f92672">[</span><span style="color:#ae81ff">1</span>, np<span style="color:#f92672">.</span>nan, np<span style="color:#f92672">.</span>nan, np<span style="color:#f92672">.</span>nan<span style="color:#f92672">]</span>,
                    <span style="color:#f92672">[</span><span style="color:#ae81ff">1</span>, np<span style="color:#f92672">.</span>nan, np<span style="color:#f92672">.</span>nan, np<span style="color:#f92672">.</span>nan<span style="color:#f92672">]</span>,
                    <span style="color:#f92672">[</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, np<span style="color:#f92672">.</span>nan, np<span style="color:#f92672">.</span>nan<span style="color:#f92672">]</span>
                    <span style="color:#f92672">]</span>)
</code></pre></div><p>・The parameter $\theta_0$ is converted to obtain the policy $\pi_\theta(s,a)$</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">simple_convert_into_pi_fron_theta</span>(theta):

     <span style="color:#f92672">[</span>m,n<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> theta<span style="color:#f92672">.</span>shape
     pi <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((m,n))
     <span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> range(<span style="color:#ae81ff">0</span>,m):
         pi<span style="color:#f92672">[</span>i, :<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> theta<span style="color:#f92672">[</span>i, :<span style="color:#f92672">]</span> <span style="color:#f92672">/</span> np<span style="color:#f92672">.</span>nansum(theta<span style="color:#f92672">[</span>i, :<span style="color:#f92672">]</span>)

     pi <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nan_to_num(pi)

     <span style="color:#66d9ef">return</span> pi
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">pi_0 <span style="color:#f92672">=</span> simple_convert_into_pi_fron_theta(theta_0)
</code></pre></div><p>・Probability of going to the wall is 0</p>
<p>・Move to other directions with equal probability</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">pi_0
</code></pre></div><p>![Screenshot from 2019-12-18 17-43-53.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/49035677-530e-b02f-(51f5-a7b9e666b398.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/49035677-530e-b02f-(51f5-a7b9e666b398.png)</a></p>
<p>・Since the initial policy is completed, move the agent according to the policy $\pi_{\theta_{0}}(s,a)$</p>
<p>・ Keep moving agents until you reach the goal</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_next_s</span>(pi, s):
    direction <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;up&#34;</span>, <span style="color:#e6db74">&#34;right&#34;</span>, <span style="color:#e6db74">&#34;down&#34;</span>, <span style="color:#e6db74">&#34;left&#34;</span><span style="color:#f92672">]</span>

    next_direction <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>choice(direction, p<span style="color:#f92672">=</span>pi<span style="color:#f92672">[</span>s, :<span style="color:#f92672">]</span>)

    <span style="color:#66d9ef">if</span> next_direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;up&#34;</span>:
        s_next <span style="color:#f92672">=</span> s<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>
    elif next_direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;right&#34;</span>:
        s_next <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
    elif next_direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;down&#34;</span>:
        s_next <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>
    elif next_direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;left&#34;</span>:
        s_next <span style="color:#f92672">=</span> s<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>

    <span style="color:#66d9ef">return</span> s_next
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">goal_maze</span>(pi):
    s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    state_history <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">]</span>

    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>):
        next_s <span style="color:#f92672">=</span> get_next_s(pi, s)
        state_history<span style="color:#f92672">.</span>append(next_s)

        <span style="color:#66d9ef">if</span> next_s <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span>:
            <span style="color:#66d9ef">break</span>
        <span style="color:#66d9ef">else</span>:
            s <span style="color:#f92672">=</span> next_s

    <span style="color:#66d9ef">return</span> state_history
</code></pre></div><p>・Check what kind of trajectory and how many steps you have taken in total to reach the goal</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">state_history <span style="color:#f92672">=</span> goal_maze(pi_0)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">print(state_history)
print( <span style="color:#e6db74">&#34;The number of steps taken to solve the maze is &#34;</span><span style="color:#f92672">+</span> str(len(state_history)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#34;</span>)
</code></pre></div><p>![Screenshot from 2019-12-18 17-45-49.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/825b32ec-f801-3cbd-(0ef5-109d154e53bf.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/825b32ec-f801-3cbd-(0ef5-109d154e53bf.png)</a></p>
<p>・Visualize the trajectory of state transition</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">from matplotlib import animation
from <span style="color:#66d9ef">IPython</span><span style="color:#f92672">.</span>display import <span style="color:#66d9ef">HTML</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init</span>():
    line<span style="color:#f92672">.</span>set_data(<span style="color:#f92672">[]</span>, <span style="color:#f92672">[]</span>)
    <span style="color:#66d9ef">return</span> (line,)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">animate</span>(i):
    state <span style="color:#f92672">=</span> state_history<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>
    x <span style="color:#f92672">=</span> (state <span style="color:#f92672">%</span><span style="color:#ae81ff">3</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>
    y <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span><span style="color:#f92672">-</span>int(state <span style="color:#f92672">/</span> <span style="color:#ae81ff">3</span>)
    line<span style="color:#f92672">.</span>set_data(x, y)
    <span style="color:#66d9ef">return</span> (line,)


anim <span style="color:#f92672">=</span> animation<span style="color:#f92672">.</span>FuncAnimation(fig, animate, init_func<span style="color:#f92672">=</span>init, frames<span style="color:#f92672">=</span>len(
    state_history), interval<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>, repeat<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)

<span style="color:#66d9ef">HTML</span>(anim<span style="color:#f92672">.</span>to_jshtml())
</code></pre></div><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/3613414f-acdc-9b19-ffce-f145876d9f6a.gif" alt="2_2_maze_random.gif"></p>
<h3 id="23-implementation-of-policy-iteration">2.3 Implementation of policy iteration</h3>
<p>・Consider a method for agents to learn strategies so that they can go straight to the goal</p>
<h4 id="1-policy-iteration-method">(1) Policy iteration method</h4>
<p>Strategies that emphasize the behavior of successful cases</p>
<h4 id="2-value-iteration-method">(2) Value iteration method</h4>
<p>A strategy that adds value (priority) to positions (states) other than goals</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">softmax_convert_into_pi_from_theta</span>(theta):

    beta <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>
    <span style="color:#f92672">[</span>m, n<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> theta<span style="color:#f92672">.</span>shape
    pi <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((m, n))

    exp_theta <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>exp(beta <span style="color:#f92672">*</span> theta)

    <span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> range(<span style="color:#ae81ff">0</span>, m):

        pi<span style="color:#f92672">[</span>i, :<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> exp_theta<span style="color:#f92672">[</span>i, :<span style="color:#f92672">]</span> <span style="color:#f92672">/</span> np<span style="color:#f92672">.</span>nansum(exp_theta<span style="color:#f92672">[</span>i, :<span style="color:#f92672">]</span>)

    pi <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nan_to_num(pi)

    <span style="color:#66d9ef">return</span> pi
</code></pre></div><p>・Purchase $\pi_{{\theta_0}}$</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">pi_0 <span style="color:#f92672">=</span> softmax_convert_into_pi_from_theta(theta_0)
print(pi_0)
</code></pre></div><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/725d9bbd-87b8-f295-6bf3-340eb8467beb.png" alt="Screenshot from 2019-12-18 18-14-44.png"></p>
<ul>
<li>Fixed &ldquo;get_next_s&rdquo; function handled in 2.2.</li>
</ul>
<p>・Not only the state but also the action taken</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_action_and_next_s</span>(pi, s)<span style="color:#e6db74">:direction</span> <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;up&#34;</span>, <span style="color:#e6db74">&#34;right&#34;</span>, <span style="color:#e6db74">&#34;down&#34;</span>, <span style="color:#e6db74">&#34;left&#34;</span><span style="color:#f92672">]</span>
    next_direction <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>choice(direction, p<span style="color:#f92672">=</span>pi<span style="color:#f92672">[</span>s, :<span style="color:#f92672">]</span>)

    <span style="color:#66d9ef">if</span> next_direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;up&#34;</span>:
        action <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        s_next <span style="color:#f92672">=</span> s<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>
    elif next_direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;right&#34;</span>:
        action <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        s_next <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
    elif next_direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;down&#34;</span>:
        action <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
        s_next <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>
    elif next_direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;left&#34;</span>:
        action <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
        s_next <span style="color:#f92672">=</span> s<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>

    <span style="color:#66d9ef">return</span> <span style="color:#f92672">[</span>action, s_next<span style="color:#f92672">]</span>
</code></pre></div><ul>
<li>Fixed &ldquo;goal_maze&rdquo; function that moves agents until they reach the goal.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">goal_maze_ret_s_a</span>(pi):
    s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    s_a_history <span style="color:#f92672">=</span> <span style="color:#f92672">[[</span><span style="color:#ae81ff">0</span>, np<span style="color:#f92672">.</span>nan<span style="color:#f92672">]]</span>

    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>):
        <span style="color:#f92672">[</span>action, next_s<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> get_action_and_next_s(pi, s)
        s_a_history<span style="color:#f92672">[-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">][</span><span style="color:#ae81ff">1</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> action

        s_a_history<span style="color:#f92672">.</span>append(<span style="color:#f92672">[</span>next_s, np<span style="color:#f92672">.</span>nan<span style="color:#f92672">]</span>)

        <span style="color:#66d9ef">if</span> next_s <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span>:
            <span style="color:#66d9ef">break</span>
        <span style="color:#66d9ef">else</span>:
            s <span style="color:#f92672">=</span> next_s

    <span style="color:#66d9ef">return</span> s_a_history
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">s_a_history <span style="color:#f92672">=</span> goal_maze_ret_s_a(pi_0)
print(s_a_history)
print( <span style="color:#e6db74">&#34;The number of steps taken to solve the maze is &#34;</span><span style="color:#f92672">+</span> str(len(s_a_history)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#34;</span>)
</code></pre></div><p>![Screenshot from 2019-12-18 18-15-43.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/890febde-6bfe-0066-(d8ff-f3c4dbd8b545.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/890febde-6bfe-0066-(d8ff-f3c4dbd8b545.png)</a></p>
<blockquote>
<p>Omitted because it is long&hellip;</p>
</blockquote>
<h4 id="update-policy-according-to-policy-gradient-method">Update policy according to policy gradient method</h4>
<p>・The policy gradient method updates the parameter $\theta$ according to the following formula</p>
<pre><code class="language-math" data-lang="math">
\theta_{s_i,a_j}=\theta_{s_i,a_j}+\eta*\Delta\theta_{s,a_j} \\
\Delta\theta{s,a_j}=\{ N(s_i,a_j)-P(s_i,a_j)N(s_i,a) \}/T


</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update_theta</span>(theta, pi, s_a_history):
    eta <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span>
    T <span style="color:#f92672">=</span> len(s_a_history)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>

    <span style="color:#f92672">[</span>m, n<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> theta<span style="color:#f92672">.</span>shape
    delta_theta <span style="color:#f92672">=</span> theta<span style="color:#f92672">.</span>copy()

    <span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> range(<span style="color:#ae81ff">0</span>, m):
        <span style="color:#66d9ef">for</span> j <span style="color:#66d9ef">in</span> range(<span style="color:#ae81ff">0</span>, n):
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span>(np<span style="color:#f92672">.</span>isnan(theta<span style="color:#f92672">[</span>i, j<span style="color:#f92672">]</span>)):

                <span style="color:#66d9ef">SA_i</span> <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#66d9ef">SA</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">SA</span> <span style="color:#66d9ef">in</span> s_a_history <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">SA</span><span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">]</span> <span style="color:#f92672">==</span> i<span style="color:#f92672">]</span>

                <span style="color:#66d9ef">SA_ij</span> <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#66d9ef">SA</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">SA</span> <span style="color:#66d9ef">in</span> s_a_history <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">SA</span> <span style="color:#f92672">==</span> <span style="color:#f92672">[</span>i, j<span style="color:#f92672">]]</span>

                <span style="color:#66d9ef">N_i</span> <span style="color:#f92672">=</span> len(<span style="color:#66d9ef">SA_i</span>)
                <span style="color:#66d9ef">N_ij</span> <span style="color:#f92672">=</span> len(<span style="color:#66d9ef">SA_ij</span>)

                delta_theta<span style="color:#f92672">[</span>i, j<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">N_ij</span><span style="color:#f92672">-</span>pi<span style="color:#f92672">[</span>i, j<span style="color:#f92672">]</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">N_i</span>) <span style="color:#f92672">/</span> T

    new_theta <span style="color:#f92672">=</span> theta <span style="color:#f92672">+</span> eta <span style="color:#f92672">*</span> delta_theta

    <span style="color:#66d9ef">return</span> new_theta
</code></pre></div><blockquote>
<p>-I really don&rsquo;t know here! ! ! !</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">new_theta <span style="color:#f92672">=</span> theta <span style="color:#f92672">+</span> eta <span style="color:#f92672">*</span> delta_theta
</code></pre></div><p>-Why add! ?
-Shouldn&rsquo;t the one with the largest number of trials (which is unlikely to be the shortest route) drawn?
-Please tell me&hellip;</p>
</blockquote>
<p>・Update the parameter $\theta$ and observe the change of policy $\pi_{\theta}$</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">new_theta <span style="color:#f92672">=</span> update_theta(theta_0, pi_0, s_a_history)
pi <span style="color:#f92672">=</span> softmax_convert_into_pi_from_theta(new_theta)
print(pi)
</code></pre></div><p>![Screenshot from 2019-12-18 18-16-52.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/d5b0786f-d83f-972e-(3342-016063993ea1.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/d5b0786f-d83f-972e-(3342-016063993ea1.png)</a></p>
<p>・Repeat the search inside the maze and update the parameter $\theta$ until the maze can be cleared in a straight line.</p>
<p>・Measures End when the absolute sum of changes in $\pi$ is less than $10^{-4}$</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">stop_epsilon <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">**-</span><span style="color:#ae81ff">4</span>

theta <span style="color:#f92672">=</span> theta_0
pi <span style="color:#f92672">=</span> pi_0

is_continue <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
count <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">while</span> <span style="color:#e6db74">is_continue</span>:
    s_a_history <span style="color:#f92672">=</span> goal_maze_ret_s_a(pi)
    new_theta <span style="color:#f92672">=</span> update_theta(theta, pi, s_a_history)
    new_pi <span style="color:#f92672">=</span> softmax_convert_into_pi_from_theta(new_theta)

    <span style="color:#66d9ef">if</span> np<span style="color:#f92672">.</span>sum(np<span style="color:#f92672">.</span>abs(new_pi<span style="color:#f92672">-</span>pi)) <span style="color:#f92672">&lt;</span><span style="color:#e6db74">stop_epsilon</span>:
        is_continue <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
    <span style="color:#66d9ef">else</span>:
        theta <span style="color:#f92672">=</span> new_theta
        pi <span style="color:#f92672">=</span> new_pi
</code></pre></div><blockquote>
<p>Actually there was a &ldquo;print&rdquo; in the function, but it&rsquo;s a pain to cut&hellip;</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">np<span style="color:#f92672">.</span>set_printoptions(precision<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, suppress<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
print(pi)
</code></pre></div><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/da9b70ff-d314-e0ef-5f6b-61efb589c236.png" alt="Screenshot from 2019-12-18 18-18-08.png"></p>
<p>・Try to visualize</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">from matplotlib import animation
from <span style="color:#66d9ef">IPython</span><span style="color:#f92672">.</span>display import <span style="color:#66d9ef">HTML</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init</span>():
    line<span style="color:#f92672">.</span>set_data(<span style="color:#f92672">[]</span>, <span style="color:#f92672">[]</span>)
    <span style="color:#66d9ef">return</span> (line,)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">animate</span>(i):
    state <span style="color:#f92672">=</span> s_a_history<span style="color:#f92672">[</span>i<span style="color:#f92672">][</span><span style="color:#ae81ff">0</span><span style="color:#f92672">]</span>
    x <span style="color:#f92672">=</span> (state <span style="color:#f92672">%</span><span style="color:#ae81ff">3</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span>
    y <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">.</span><span style="color:#ae81ff">5</span><span style="color:#f92672">-</span>int(state <span style="color:#f92672">/</span> <span style="color:#ae81ff">3</span>)
    line<span style="color:#f92672">.</span>set_data(x, y)
    <span style="color:#66d9ef">return</span> (line,)

anim <span style="color:#f92672">=</span> animation<span style="color:#f92672">.</span>FuncAnimation(fig, animate, init_func<span style="color:#f92672">=</span>init, frames<span style="color:#f92672">=</span>len(
    s_a_history), interval<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>, repeat<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)

<span style="color:#66d9ef">HTML</span>(anim<span style="color:#f92672">.</span>to_jshtml())
</code></pre></div><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/546118/702eb022-5383-452b-c420-35b13fd65147.gif" alt="2_3_maze_reinforce.gif"></p>
<p>・The softmax function can derive a policy even if the parameter $\theta$ becomes a negative value.</p>
<p>・Using the policy gradient theorem, the method of updating the parameter $\theta$ can be solved by the policy gradient method.</p>
<p>・There is an algorithm REINFORCE that approximately implements the policy gradient theorem.</p>
<hr>
<p>-This time there are some points that I do not understand.
-I would appreciate if anyone could tell me.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
