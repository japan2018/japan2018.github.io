<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>A simple system that automatically shoots and sends LINE by detecting objects | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>A simple system that automatically shoots and sends LINE by detecting objects</h1>
<p>
  <small class="text-secondary">
  
  
  Nov 4, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/raspberrypi"> RaspberryPi</a></code></small>


<small><code><a href="https://memotut.com/tags/line"> Line</a></code></small>


<small><code><a href="https://memotut.com/tags/automation"> Automation</a></code></small>


<small><code><a href="https://memotut.com/tags/image"> Image</a></code></small>

</p>
<pre><code>#Introduction
</code></pre>
<p>Automatically shoot when an object crosses it! Introducing a system that sends images to LINE.</p>
<p>**Are your cats eating food properly during a one-night, two-day excursion?
I was worried if I was drinking water so I made it. **</p>
<p>It will be a simple system using Raspai,
It is recommended that you can check the camera image on LINE while you are out, such as people who have pets.</p>
<p>####reference
Book &ldquo;<a href="https://amzn.to/36fTfRT">Raspberry Pi Begins Softly</a>&rdquo;
It&rsquo;s very easy to understand for beginners to Raspberry Pi and is a highly recommended book.
About 80% of the system this time, I borrowed the idea from this book m(_ _)m</p>
<h2 id="system-description">System description</h2>
<p>This is the GitHub repository.
<a href="https://github.com/akiraseto/security_cam">https://github.com/akiraseto/security_cam</a></p>
<h4 id="rough-flow">Rough flow</h4>
<ol>
<li>Start a Python program and stand by</li>
<li>Automatic detection when a cat passes by the sensor</li>
<li>When the signal is received, capture and save the image with the webcam connected via USB.</li>
<li>Notify the latest saved image via LINE notify</li>
<li>You can see images on LINE even when you are out!</li>
</ol>
<h4 id="raspberry-pi">Raspberry Pi</h4>
<p>Raspberry Pi (hereinafter: Rasppy) is used to connect the sensor and the camera.</p>
<p>Connect a motion sensor with GPIO
It uses infrared rays to detect when something hotter than people, such as people or animals, moves.
I used the unmarked parts of the human sensor as a set product, but there is no problem in using it in <a href="http://akizukidenshi.com/catalog/g/gM-02471/">SE-10</a> sold in Akizuki I think. ――
Connect the OUTPUT of the sensor to GPIO:23 on the Raspberry Pi
Raspai GPIO: Connect LED Anode to No. 18
<em>Please insert the necessary resistor as needed</em></p>
<p>webcam and USB connection
Just insert it into the USB terminal as you would with a PC, and you don&rsquo;t have to do anything special.</p>
<p>Like this ↓↓
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/215645/a02e9a2c-22ee-5949-9330-e117f56255bd.jpeg" alt="photo.jpeg"></p>
<p>####LINEnotify
With the API provided by LINE, you can freely send various notifications to LINE by incorporating it in the program.
It&rsquo;s quite convenient and seems to have various uses.
<a href="https://notify-bot.line.me/ja/">https://notify-bot.line.me/ja/</a></p>
<p>This page is detailed.
<a href="https://qiita.com/iitenkida7/items/576a8226ba6584864d95">https://qiita.com/iitenkida7/items/576a8226ba6584864d95</a></p>
<p>Register and link to issue an access token.
The access token is displayed only once, so be careful not to forget to copy and paste.</p>
<p>####overall structure</p>
<pre><code>security_cam/
├── README.md
├── config.py #LINENotify token
└── security_cam.py

# Image storage directory
/media/pi/rasUSB/security_cam/img

</code></pre><p><em>Account name: pi External storage (USB memory) name: rasUSB</em></p>
<p>As for images, I don&rsquo;t want to press the capacity of the startup disk, so I save them separately in a USB memory.
As I said to the overall structure, I have to say that the actual program file is only <code>security_cam.py</code>.</p>
<h4 id="main-code">Main code</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py:security_cam.py" data-lang="py:security_cam.py"><span style="color:#f92672">import</span> RPi.GPIO <span style="color:#f92672">as</span> GPIO
<span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep
<span style="color:#f92672">import</span> datetime<span style="color:#f92672">,</span> requests<span style="color:#f92672">,</span> cv2<span style="color:#f92672">,</span> os<span style="color:#f92672">,</span> glob<span style="color:#f92672">,</span> config

<span style="color:#75715e">#LINE Notify token</span>
TOKEN <span style="color:#f92672">=</span> config<span style="color:#f92672">.</span>TOKEN
API <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://notify-api.line.me/api/notify&#39;</span>

<span style="color:#75715e"># Set GPIO port</span>
SENSOR_PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">23</span>
LED_PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">18</span>
GPIO<span style="color:#f92672">.</span>setmode(GPIO<span style="color:#f92672">.</span>BCM)
GPIO<span style="color:#f92672">.</span>setup(SENSOR_PORT, GPIO<span style="color:#f92672">.</span>IN)
GPIO<span style="color:#f92672">.</span>setup(LED_PORT, GPIO<span style="color:#f92672">.</span>OUT)

<span style="color:#75715e"># CV2 preparation</span>
camera <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>VideoCapture(<span style="color:#ae81ff">0</span>)
IMG_SIZE <span style="color:#f92672">=</span> (<span style="color:#ae81ff">600</span>,<span style="color:#ae81ff">400</span>)

<span style="color:#75715e"># Execute command to take photo (file name is date and time)</span>
last_post <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime(<span style="color:#ae81ff">2000</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>) <span style="color:#75715e"># properly initialized</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">take_photo</span>():
    <span style="color:#66d9ef">global</span> last_post
    <span style="color:#75715e">#Take a photo</span>
    now <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>now()
    fname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/media/pi/rasUSB/security_cam/img/&#34;</span> <span style="color:#f92672">+</span> now<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">_%H-%M-%S&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.jpg&#34;</span>

    <span style="color:#75715e">#Delete old image</span>
    file_list <span style="color:#f92672">=</span> glob<span style="color:#f92672">.</span>glob(<span style="color:#e6db74">&#34;/media/pi/rasUSB/security_cam/img/*jpg&#34;</span>)
    dif_time <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>timedelta(days<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
    <span style="color:#66d9ef">for</span> file <span style="color:#f92672">in</span> file_list:
        file_time <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>fromtimestamp(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>getatime(file))
        <span style="color:#66d9ef">if</span> (file_time <span style="color:#f92672">&lt;</span>now<span style="color:#f92672">-</span>dif_time):
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;remove: {0}&#34;</span><span style="color:#f92672">.</span>format(file))
            os<span style="color:#f92672">.</span>remove(file)

    <span style="color:#75715e"># photograph</span>
    _, frame <span style="color:#f92672">=</span> camera<span style="color:#f92672">.</span>read()
    img <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>resize(frame, IMG_SIZE)
    ret <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imwrite(fname, img)
    <span style="color:#66d9ef">if</span> ret:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Photo:&#39;</span> <span style="color:#f92672">+</span> fname)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Failed to write image.&#39;</span>)

    Notify <span style="color:#75715e">#LINE</span>
    <span style="color:#75715e"># However, do not notify for 10 minutes --- (*1)</span>
    sec <span style="color:#f92672">=</span> (now<span style="color:#f92672">-</span>last_post)<span style="color:#f92672">.</span>seconds
    <span style="color:#66d9ef">if</span> sec <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>: <span style="color:#66d9ef">return</span>
    last_post <span style="color:#f92672">=</span> now
    <span style="color:#75715e"># Insert notification to LINE --- (*2)</span>
    post_data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;message&#39;</span>:<span style="color:#e6db74">&#39;Nyans&#39;</span>}
    headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;Authorization&#39;</span>:<span style="color:#e6db74">&#39;Bearer&#39;</span> <span style="color:#f92672">+</span> TOKEN}
    files<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;imageFile&#39;</span>: open(fname,<span style="color:#e6db74">&#39;rb&#39;</span>)}
    res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(API, data<span style="color:#f92672">=</span>post_data,
        headers<span style="color:#f92672">=</span>headers,files<span style="color:#f92672">=</span>files)
    <span style="color:#66d9ef">print</span>(res<span style="color:#f92672">.</span>text)

<span style="color:#66d9ef">try</span>:
    sw <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#75715e"># Prevent continuous shooting</span>
    <span style="color:#75715e">#Repeat get sensor value</span>
    <span style="color:#66d9ef">while</span> True:
        v <span style="color:#f92672">=</span> GPIO<span style="color:#f92672">.</span>input(SENSOR_PORT)
        <span style="color:#66d9ef">if</span> v <span style="color:#f92672">==</span> GPIO<span style="color:#f92672">.</span>HIGH:
            GPIO<span style="color:#f92672">.</span>output(LED_PORT, GPIO<span style="color:#f92672">.</span>HIGH)
            take_photo()
            sw <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">else</span>:
            GPIO<span style="color:#f92672">.</span>output(LED_PORT, GPIO<span style="color:#f92672">.</span>LOW)
            sw <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        sleep(<span style="color:#ae81ff">10.0</span>)
<span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
        <span style="color:#66d9ef">pass</span>
GPIO<span style="color:#f92672">.</span>cleanup()
</code></pre></div><ul>
<li>I am using the <code>opencv</code> library for camera photography.
There are several ways to install opencv on Raspberry Pi, but this is the easiest and quick one.
<a href="https://karaage.hatenadiary.jp/entry/2018/10/05/073000">https://karaage.hatenadiary.jp/entry/2018/10/05/073000</a></li>
<li>Saved images are deleted more than 3 days ago.
If you want to increase the number of days, please change it to an appropriate number of days with L30:<code>dif_time = datetime.timedelta(days=3)</code>.</li>
</ul>
<p>The above is a simple program.</p>
<p>##in conclusion
To be honest, I use it only occasionally.
Not only cats, but LINE notifications came every time the family crossed. .. (&lsquo;Д`)
As a recommended usage,
When you leave your house for a while, such as an excursion of 2 days and 1 night, or going out with your family from morning to evening
It feels good to play an active part in checking the condition of a cat.</p>
<p>If you are worried about your pet&rsquo;s food and drinking while out, how about you?
Of course, it&rsquo;s also fun to get rid of dust through LINE, such as &ldquo;Did you come to drink?&rdquo;</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
