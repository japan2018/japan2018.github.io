<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://japan2018.github.io/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://japan2018.github.io/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://japan2018.github.io/favicon-16x16.png">

  
  <link rel="manifest" href="https://japan2018.github.io/site.webmanifest">

  
  <link rel="mask-icon" href="https://japan2018.github.io/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://japan2018.github.io/css/bootstrap.min.css" />

  
  <title>Notify LINE of TV appearance information of your favorite entertainer | Some Title</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Notify LINE of TV appearance information of your favorite entertainer</h1>
<p>
  <small class="text-secondary">
  
  
  May 15, 2020
  </small>
  

<small><code><a href="https://japan2018.github.io/tags/python">Python</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/scraping"> scraping</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/raspberrypi"> RaspberryPi</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/line"> Line</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/linenotify"> LineNotify</a></code></small>

</p>
<pre><code>#Purpose
</code></pre>
<p>I miss watching my favorite idol and comedians appear on TV, so I decided to notify them via LINE.
<img width="258" alt="2020-05-15 (9).png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/420361/e63012ab-3d3f-2aea-1ad7-00eee656eb52.png"></p>
<p>#Overview
<a href="https://tv.yahoo.co.jp/search/?q=%E7%9C%89%E6%9D%91%E3%81%A1%E3%81%82%E3%81%8D&amp;g=&amp;a=23&amp;oa=1&amp;s=1%22">Yahoo! TV G Guide</a> was used to obtain information on TV programs, and to notify using LINE Notify. I set the program to run on Raspberrypi every morning at 9am.</p>
<h2 id="acquisition-of-program-information">Acquisition of program information</h2>
<p>For example, in the case of a terrestrial program of &ldquo;Chiaki Bimura&rdquo; (Regional setting Tokyo), such a URL is used.
<a href="https://tv.yahoo.co.jp/search/?q=Chiaki">https://tv.yahoo.co.jp/search/?q=Chiaki</a> Meimura&amp;g=0&amp;a=23&amp;oa=1&amp;s=1</p>
<p>Define a function called tv_information(query,romaji,jenre) and receive as input the name of the entertainer you want to be notified of, the name of the text file that records the appearing program, and the genre of the tv program you want to be notified of. I got the information from the URL according to the input. This time it&rsquo;s limited to terrestrial TV programs in Tokyo.
I wanted to give you information about the comedy duo, New York, but in the New York word, many programs related to New York in the United States will be notified, so I am able to specify the genre of the program and notify it. Enter jenre=0 for all genres and genre=5 for variety.</p>
<p>##LINE
<a href="https://notify-bot.line.me/ja/">LINE Notify</a>
I got a token from here.
Enter the obtained token in <code>line_notify_token = &quot;obtained LINE API&quot;</code>.</p>
<h2 id="code-used">Code used</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:tv_line.py" data-lang="python:tv_line.py"><span style="color:#f92672">import</span> requests
<span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
<span style="color:#f92672">import</span> sys
<span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep

<span style="color:#75715e">#Get information about TV (argument: performer&#39;s name, Roman letters (file name), genre)</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tv_information</span>(query,romaji,jenre):
<span style="color:#75715e">#0 for all genres, 5 for variety</span>
    <span style="color:#66d9ef">if</span> jenre<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>:
        no<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
    <span style="color:#66d9ef">elif</span> jenre<span style="color:#f92672">==</span><span style="color:#ae81ff">5</span>:
        no<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;05&#39;</span>
    url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://tv.yahoo.co.jp/search/?q=&#34;</span><span style="color:#f92672">+</span>query<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&amp;g=&#34;</span><span style="color:#f92672">+</span>no<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&amp;a=23&amp;oa=1&amp;s=1&#34;</span>
    res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
    status <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span>status_code

    If the <span style="color:#75715e">#Requests status code is not 200, notify LINE and exit</span>
    <span style="color:#66d9ef">if</span> status <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>:
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">LineNotify</span>(message):
            line_notify_token <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Obtained LINE API&#34;</span>
            line_notify_api <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://notify-api.line.me/api/notify&#34;</span>
            payload <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;message&#34;</span>: message}
            headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Authorization&#34;</span>: <span style="color:#e6db74">&#34;Bearer &#34;</span><span style="color:#f92672">+</span> line_notify_token}
            requests<span style="color:#f92672">.</span>post(line_notify_api, data<span style="color:#f92672">=</span>payload, headers<span style="color:#f92672">=</span>headers)
        message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Requests failed&#34;</span>
        LineNotify(message)
        sys<span style="color:#f92672">.</span>exit()
    

    <span style="color:#75715e">#If the status code is 200, continue processing</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">pass</span>
    
    <span style="color:#75715e">#Get number of keyword searches</span>
    soup <span style="color:#f92672">=</span> BeautifulSoup(res<span style="color:#f92672">.</span>text,<span style="color:#e6db74">&#34;html.parser&#34;</span>)
    p <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#34;p&#34;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;floatl pt5p&#34;</span>)

    <span style="color:#75715e">#If the number of searches is 0, processing ends</span>
    <span style="color:#66d9ef">if</span> p <span style="color:#f92672">==</span> None:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;0&#39;</span>)
        non<span style="color:#f92672">=</span>{}
        <span style="color:#66d9ef">return</span> non

    <span style="color:#75715e"># Continue processing if the number of searches is 1 or more</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">pass</span>
    
    answer <span style="color:#f92672">=</span> int(p<span style="color:#f92672">.</span>em<span style="color:#f92672">.</span>text) <span style="color:#75715e"># number of searches</span>
    page <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    list1 <span style="color:#f92672">=</span> [] <span style="color:#75715e"># Broadcast date and time</span>
    list2 <span style="color:#f92672">=</span> [] <span style="color:#75715e"># broadcast station</span>
    list3 <span style="color:#f92672">=</span> [] <span style="color:#75715e"># program title</span>

    <span style="color:#75715e">#Get information for each page</span>
    <span style="color:#66d9ef">while</span> answer<span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
        url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://tv.yahoo.co.jp/search/?q=&#34;</span><span style="color:#f92672">+</span>query<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&amp;g=&#34;</span><span style="color:#f92672">+</span>no<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;&amp;a=23&amp;oa=1&amp;s=&#34;</span><span style="color:#f92672">+</span>str(page)
        res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
        soup <span style="color:#f92672">=</span> BeautifulSoup(res<span style="color:#f92672">.</span>text, <span style="color:#e6db74">&#34;html.parser&#34;</span>)

        dates <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#34;div&#34;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;leftarea&#34;</span>)
        <span style="color:#66d9ef">for</span> date <span style="color:#f92672">in</span> dates:
            d <span style="color:#f92672">=</span> date<span style="color:#f92672">.</span>text
            d <span style="color:#f92672">=</span> <span style="color:#e6db74">``</span><span style="color:#f92672">.</span>join(d<span style="color:#f92672">.</span>splitlines())
            list1<span style="color:#f92672">.</span>append(d)

        <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> soup(<span style="color:#e6db74">&#34;span&#34;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;floatl&#34;</span>):
            s<span style="color:#f92672">.</span>decompose()
        tvs <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#34;span&#34;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;pr35&#34;</span>)
        <span style="color:#66d9ef">for</span> tv <span style="color:#f92672">in</span> tvs:
            list2<span style="color:#f92672">.</span>append(tv<span style="color:#f92672">.</span>text)

        titles <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#34;div&#34;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rightarea&#34;</span>)
        <span style="color:#66d9ef">for</span> title <span style="color:#f92672">in</span> titles:
            t <span style="color:#f92672">=</span> title<span style="color:#f92672">.</span>a<span style="color:#f92672">.</span>text
            list3<span style="color:#f92672">.</span>append(t)

        page <span style="color:#f92672">=</span> page <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span>
        answer <span style="color:#f92672">=</span> answer<span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>

        sleep(<span style="color:#ae81ff">3</span>)

    Create list_new that summarizes the broadcast date <span style="color:#f92672">+</span> broadcast station <span style="color:#f92672">+</span> program title <span style="color:#f92672">from</span> <span style="color:#75715e">#list1 to list3</span>
    list_new <span style="color:#f92672">=</span> [x <span style="color:#f92672">+</span><span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">+</span> y <span style="color:#66d9ef">for</span> (x ,y) <span style="color:#f92672">in</span> zip(list1,list2)]
    list_new <span style="color:#f92672">=</span> [x <span style="color:#f92672">+</span><span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">+</span> y <span style="color:#66d9ef">for</span> (x ,y) <span style="color:#f92672">in</span> zip(list_new,list3)]
    filename<span style="color:#f92672">=</span>romaji<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;.txt&#39;</span>
    <span style="color:#75715e">#Expand the previous data as a set from the text file</span>
    f <span style="color:#f92672">=</span> open(filename,<span style="color:#e6db74">&#39;r&#39;</span>)
    f_old <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
    list_old <span style="color:#f92672">=</span> f_old<span style="color:#f92672">.</span>splitlines()
    set_old <span style="color:#f92672">=</span> set(list_old)
    f<span style="color:#f92672">.</span>close()
    
    f <span style="color:#f92672">=</span> open(filename,<span style="color:#e6db74">&#39;w&#39;</span>)
    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> list_new:
        f<span style="color:#f92672">.</span>write(str(x)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>) <span style="color:#75715e"># write file</span>
    f<span style="color:#f92672">.</span>close()

    <span style="color:#75715e"># Take the difference set of the previous data and this data</span>
    set_new <span style="color:#f92672">=</span> set(list_new)
    set_dif <span style="color:#f92672">=</span> set_new<span style="color:#f92672">-</span>set_old
    <span style="color:#66d9ef">return</span> set_dif

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">LINE_notify</span>(set_dif,query,romaji):

    <span style="color:#75715e"># Processing ends if there is no difference set</span>
    <span style="color:#66d9ef">if</span> len(set_dif) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#66d9ef">return</span>

    <span style="color:#75715e">#If there is a difference set, take it out as a list and notify LINE</span>
    <span style="color:#66d9ef">else</span>:
        list_now <span style="color:#f92672">=</span> list(set_dif)
        list_now<span style="color:#f92672">.</span>sort()

        <span style="color:#66d9ef">for</span> L <span style="color:#f92672">in</span> list_now:
            <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">LineNotify</span>(message):
                line_notify_token <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Obtained LINE API&#34;</span>
                line_notify_api <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://notify-api.line.me/api/notify&#34;</span>
                payload <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;message&#34;</span>: message}
                headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Authorization&#34;</span>: <span style="color:#e6db74">&#34;Bearer &#34;</span><span style="color:#f92672">+</span> line_notify_token}
                requests<span style="color:#f92672">.</span>post(line_notify_api, data<span style="color:#f92672">=</span>payload, headers<span style="color:#f92672">=</span>headers)
            message <span style="color:#f92672">=</span> query<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;Cast program information</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> L
            LineNotify(message)
            sleep(<span style="color:#ae81ff">2</span>)
        <span style="color:#66d9ef">return</span>

<span style="color:#75715e"># Notify the appearance program of Chiaki Bimura in all genres</span>
set_dif1<span style="color:#f92672">=</span>tv_information(<span style="color:#e6db74">&#39;Chiaki Bimura&#39;</span>,<span style="color:#e6db74">&#39;mayumura&#39;</span>,<span style="color:#ae81ff">0</span>)
LINE_notify(set_dif1,<span style="color:#e6db74">&#39;Chiaki Meimura&#39;</span>,<span style="color:#e6db74">&#39;mayumura&#39;</span>)

<span style="color:#75715e"># Notify the appearance programs of air stairs of all genres</span>
set_dif2<span style="color:#f92672">=</span>tv_information(<span style="color:#e6db74">&#39;air stair&#39;</span>,<span style="color:#e6db74">&#39;kuuki&#39;</span>,<span style="color:#ae81ff">0</span>)
LINE_notify(set_dif2,<span style="color:#e6db74">&#39;air stairs&#39;</span>,<span style="color:#e6db74">&#39;kuuki&#39;</span>)

<span style="color:#75715e"># Notify New York programs in a variety genre</span>
set_dif3<span style="color:#f92672">=</span>tv_information(<span style="color:#e6db74">&#39;New York&#39;</span>,<span style="color:#e6db74">&#39;newy&#39;</span>,<span style="color:#ae81ff">5</span>)
LINE_notify(set_dif3,<span style="color:#e6db74">&#39;New York&#39;</span>,<span style="color:#e6db74">&#39;newy&#39;</span>)

</code></pre></div><h2 id="execute">execute</h2>
<p>I made this program run on Raspberrypi every day at 9am.
I wrote the following statement to the file with <code>crontab -e</code>.</p>
<pre><code>00 09 * * * python3 /home/pi/tv_line.py
</code></pre><p>Write the job after the run time. The execution time is written in the order of minutes, hours, days, months, and days of the week.</p>
<p>#reference
<a href="https://non-programmer.com/web_scraping_yahootv01/">Get information from Yahoo TV listings (Beginner of Web Scraping)</a><a href="https://qiita.com/str416yb/items/7126625cf89909cca066">ObtainingaprogramfeaturingMinamiHamabebyscraping</a>
[Summary of crontab commands [Linux command collection]]
(<a href="https://eng-entrance.com/linux-command-crontab">https://eng-entrance.com/linux-command-crontab</a>)</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
