<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] Fast automated test creation using pyATS|Genie&#39;s hidden move Blitz | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] Fast automated test creation using pyATS|Genie&rsquo;s hidden move Blitz</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 11, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/automation">automation</a></code></small>


<small><code><a href="https://memotut.com/tags/cisco">Cisco</a></code></small>


<small><code><a href="https://memotut.com/tags/pyats">pyATS</a></code></small>


<small><code><a href="https://memotut.com/tags/genie">Genie</a></code></small>

</p>
<pre><code>This article was posted as the 11th day of Cisco Systems Japan Advent Calendar 2019 by volunteers from Cisco.
</code></pre>
<p>2017 version: <a href="https://qiita.com/advent-calendar/2017/cisco">https://qiita.com/advent-calendar/2017/cisco</a>
2018 version: <a href="https://qiita.com/advent-calendar/2018/cisco">https://qiita.com/advent-calendar/2018/cisco</a>
2019 version: <a href="https://qiita.com/advent-calendar/2019/cisco">https://qiita.com/advent-calendar/2019/cisco</a></p>
<p>#Introduction</p>
<p>Hello. <a href="https://developer.cisco.com/pyats/">pyATS|Genie</a><a href="mailto:I'm@tahigash3fromthedevelopmentteam.Inthisarticle">I'm@tahigash3fromthedevelopmentteam.Inthisarticle</a>,I&rsquo;llshowyouaneasywaytocreateanetworktestusing<a href="https://developer.cisco.com/pyats/">pyATS|Genie</a>.</p>
<p>Please refer to the previous article for a brief introduction and installation of <a href="https://developer.cisco.com/pyats/">pyATS|Genie</a>.
<a href="https://qiita.com/tahigash/items/ceb0809a4a9464c521b3">Easily check multi-vendor networks with pyATS/Genie and Robot Framework</a></p>
<h1 id="worries-about-network-automation">Worries about network automation</h1>
<p>I have enumerated the worries of those who have not done network automation yet.</p>
<ol>
<li>Always requires knowledge of python</li>
<li>You have to remember the module for each vendor of automation tools</li>
<li>I want to make the most of the CLI-based knowledge I learned</li>
<li>Want to automate old equipment and configurations</li>
</ol>
<p>This time, I will introduce Blitz, a hidden technique of <a href="https://developer.cisco.com/pyats/">pyATS|Genie</a> to eliminate such troubles.
** An easy way to automate your network for network engineers. **</p>
<h1 id="pyatsgenie-installation">pyATS|Genie installation</h1>
<p>I wrote in the above <a href="https://qiita.com/tahigash/items/ceb0809a4a9464c521b3">Past article</a>, but it is an installation method. Below is an example of using pyenv/virtualenv on MacOS.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">
$ pyenv install 3.7.3
$ pyenv virtualenv 3.7.3 genie_env
$ pyenv activate genie_env
<span style="color:#f92672">(</span>genie_env<span style="color:#f92672">)</span>$ python -V
Python 3.7.3
<span style="color:#f92672">(</span>genie_env<span style="color:#f92672">)</span>$ pip install genie
</code></pre></div><p>The following description is based on the assumption that you are in this python virtualenv environment.</p>
<h1 id="network-configuration">Network configuration</h1>
<p>This time we will use the following configuration similar to the last time. The equipment is the one started up in <a href="http://virl.cisco.com/">VIRL</a>.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/b68d69b9-e71c-e9e3-a6f8-35b3cbed1f9e.png" alt="image.png"></p>
<table>
<thead>
<tr>
<th align="left">Hostname</th>
<th align="left">Os</th>
<th align="left">Version</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">iosv-1</td>
<td align="left">IOS</td>
<td align="left">15.7(3)M3</td>
</tr>
<tr>
<td align="left">iosv-2</td>
<td align="left">IOS</td>
<td align="left">15.7(3)M3</td>
</tr>
<tr>
<td align="left">iosv-3</td>
<td align="left">IOS</td>
<td align="left">15.7(3)M3</td>
</tr>
<tr>
<td align="left">csr1000v-1</td>
<td align="left">IOSXE</td>
<td align="left">16.9.1</td>
</tr>
<tr>
<td align="left">iosxr9000-1</td>
<td align="left">IOSXR</td>
<td align="left">6.5.1</td>
</tr>
<tr>
<td align="left">nx-osv9000-1</td>
<td align="left">NXOS</td>
<td align="left">9.2.1</td>
</tr>
</tbody>
</table>
<h1 id="what-to-automate">What to automate?</h1>
<p>This time, I would like to introduce a relatively simple one so that Blitz can be understood.</p>
<ol>
<li>Add snmp community settings
2.Establishing iBGP neighbor (iosv-1/iosv-2 is RR, iosv-3/csr1000v-1/iosxr9000-1,nx-osv9000-1 is RR client)</li>
</ol>
<h1 id="pyatsgenie-blitz-only-needs-2-files">pyATS|Genie Blitz only needs 2 files!!!</h1>
<p>The files created this time are the following two.</p>
<h2 id="network-configuration-file-testbedyaml-abbreviated-as-tbyaml-this-time">Network configuration file (testbed.yaml, abbreviated as tb.yaml this time)</h2>
<p>The network configuration file is written in YAML that everyone loves. The network device information is described in a fixed format, but if you look at the items, I think that a network engineer can create it without problems.</p>
<p>Topologically visible iosvl2-1 and ioslv2-2 are not included in the following tb.yaml as they are not the targets of this work.</p>
<p>All devices are network configuration files that are SSH-connected via jump_host.
Although it is casually included, you can specify options of ssh command with <code>ssh_options</code> **.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:tb.yaml" data-lang="yaml:tb.yaml"><span style="color:#66d9ef">devices</span>:
  <span style="color:#66d9ef">csr1000v-1</span>:
    <span style="color:#66d9ef">alias</span>: uut
    <span style="color:#66d9ef">connections</span>:
      <span style="color:#66d9ef">ssh</span>:
        <span style="color:#66d9ef">ip</span>: <span style="color:#ae81ff">172.16.1.234</span>
        <span style="color:#66d9ef">protocol</span>: ssh
        <span style="color:#66d9ef">proxy</span>: jump_host
    <span style="color:#66d9ef">credentials</span>:
      <span style="color:#66d9ef">default</span>:
        <span style="color:#66d9ef">password</span>: Cisc0123
        <span style="color:#66d9ef">username</span>: admin
      <span style="color:#66d9ef">enable</span>:
        <span style="color:#66d9ef">password</span>: Cisc0123
    <span style="color:#66d9ef">os</span>: iosxe
    <span style="color:#66d9ef">platform</span>: iosxe
    <span style="color:#66d9ef">type</span>: CSR1000v
  <span style="color:#66d9ef">iosv-1</span>:
    <span style="color:#66d9ef">alias</span>: iosv<span style="color:#ae81ff">-1</span>
    <span style="color:#66d9ef">connections</span>:
      <span style="color:#66d9ef">ssh</span>:
        <span style="color:#66d9ef">ip</span>: <span style="color:#ae81ff">172.16.1.235</span>
        <span style="color:#66d9ef">protocol</span>: ssh
        <span style="color:#66d9ef">proxy</span>: jump_host
    <span style="color:#66d9ef">credentials</span>:
      <span style="color:#66d9ef">default</span>:
        <span style="color:#66d9ef">password</span>: Cisc0123
        <span style="color:#66d9ef">username</span>: admin
      <span style="color:#66d9ef">enable</span>:
        <span style="color:#66d9ef">password</span>: Cisc0123
    <span style="color:#66d9ef">os</span>: ios
    <span style="color:#66d9ef">platform</span>: ios
    <span style="color:#66d9ef">type</span>: IOSv
  <span style="color:#66d9ef">iosv-2</span>:
    <span style="color:#66d9ef">alias</span>: iosv<span style="color:#ae81ff">-2</span>
    <span style="color:#66d9ef">connections</span>:
      <span style="color:#66d9ef">ssh</span>:
        <span style="color:#66d9ef">ip</span>: <span style="color:#ae81ff">172.16.1.236</span>
        <span style="color:#66d9ef">protocol</span>: ssh
        <span style="color:#66d9ef">proxy</span>: jump_host
    <span style="color:#66d9ef">credentials</span>:
      <span style="color:#66d9ef">default</span>:
        <span style="color:#66d9ef">password</span>: Cisc0123
        <span style="color:#66d9ef">username</span>: admin
      <span style="color:#66d9ef">enable</span>:
        <span style="color:#66d9ef">password</span>: Cisc0123
    <span style="color:#66d9ef">os</span>: ios
    <span style="color:#66d9ef">platform</span>: ios
    <span style="color:#66d9ef">type</span>: IOSv
  <span style="color:#66d9ef">iosv-3</span>:
    <span style="color:#66d9ef">alias</span>: iosv<span style="color:#ae81ff">-3</span>
    <span style="color:#66d9ef">connections</span>:
      <span style="color:#66d9ef">ssh</span>:
        <span style="color:#66d9ef">ip</span>: <span style="color:#ae81ff">172.16.1.237</span>
        <span style="color:#66d9ef">protocol</span>: ssh
        <span style="color:#66d9ef">proxy</span>: jump_host
    <span style="color:#66d9ef">credentials</span>:
      <span style="color:#66d9ef">default</span>:
        <span style="color:#66d9ef">password</span>: Cisc0123
        <span style="color:#66d9ef">username</span>: admin
      <span style="color:#66d9ef">enable</span>:
        <span style="color:#66d9ef">password</span>: Cisc0123
    <span style="color:#66d9ef">os</span>: ios
    <span style="color:#66d9ef">platform</span>: ios
    <span style="color:#66d9ef">type</span>: IOSv
  <span style="color:#66d9ef">iosxrv9000-1</span>:
    <span style="color:#66d9ef">alias</span>: iosxrv9000<span style="color:#ae81ff">-1</span>
    <span style="color:#66d9ef">connections</span>:
      <span style="color:#66d9ef">ssh</span>:
        <span style="color:#66d9ef">ip</span>: <span style="color:#ae81ff">172.16.1.240</span>
        <span style="color:#66d9ef">protocol</span>: ssh
        <span style="color:#66d9ef">proxy</span>: jump_host
        <span style="color:#66d9ef">ssh_options</span>: -o HostKeyAlgorithms=+ssh-dss
    <span style="color:#66d9ef">credentials</span>:
      <span style="color:#66d9ef">default</span>:
        <span style="color:#66d9ef">password</span>: Cisc0123
        <span style="color:#66d9ef">username</span>: admin
      <span style="color:#66d9ef">enable</span>:
        <span style="color:#66d9ef">password</span>: Cisc0123
    <span style="color:#66d9ef">os</span>: iosxr
    <span style="color:#66d9ef">platform</span>: iosxrv9k
    <span style="color:#66d9ef">type</span>: IOS XRv <span style="color:#ae81ff">9000</span>
  <span style="color:#66d9ef">nx-osv9000-1</span>:
    <span style="color:#66d9ef">alias</span>: nx-osv9000<span style="color:#ae81ff">-1</span>
    <span style="color:#66d9ef">connections</span>:
      <span style="color:#66d9ef">ssh</span>:
        <span style="color:#66d9ef">ip</span>: <span style="color:#ae81ff">172.16.1.51</span>
        <span style="color:#66d9ef">protocol</span>: ssh
        <span style="color:#66d9ef">proxy</span>: jump_host
    <span style="color:#66d9ef">credentials</span>:
      <span style="color:#66d9ef">default</span>:
        <span style="color:#66d9ef">password</span>: Cisc0123
        <span style="color:#66d9ef">username</span>: admin
      <span style="color:#66d9ef">enable</span>:
        <span style="color:#66d9ef">password</span>: Cisc0123
    <span style="color:#66d9ef">os</span>: nxos
    <span style="color:#66d9ef">platform</span>: n9kv
    <span style="color:#66d9ef">type</span>: NX-OSv <span style="color:#ae81ff">9000</span>
  <span style="color:#66d9ef">jump_host</span>:
    <span style="color:#66d9ef">connections</span>:
      <span style="color:#66d9ef">cli</span>:
        <span style="color:#66d9ef">ip</span>: <span style="color:#ae81ff">172.25.192.134</span>
        <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">22</span>
        <span style="color:#66d9ef">protocol</span>: ssh
    <span style="color:#66d9ef">credentials</span>:
      <span style="color:#66d9ef">default</span>:
        <span style="color:#66d9ef">password</span>: VIRL
        <span style="color:#66d9ef">username</span>: virl
    <span style="color:#66d9ef">os</span>: linux
    <span style="color:#66d9ef">type</span>: linux
</code></pre></div><h2 id="trigger-data-file-trigger_datafileyaml-that-writes-the-items-you-want-to-automate">Trigger data file (trigger_datafile.yaml) that writes the items you want to automate</h2>
<p>Describe the test contents to be automated in the <code>trigger datafile</code>. The file name can be anything, but this time it is set to <code>trigger_datafile.yaml</code> so that you can see the trigger datafile.</p>
<p>Then, it is trigger_datafile.yaml for setting the snmp community and confirming the setting, deleting the setting, and confirming the setting deletion.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:trigger_datafile.yaml" data-lang="yaml:trigger_datafile.yaml"><span style="color:#66d9ef">TriggerBlitzConfigureSnmpCommunity</span>:
  <span style="color:#66d9ef">groups</span>: [<span style="color:#e6db74">&#39;blitz&#39;</span>,<span style="color:#e6db74">&#39;snmp&#39;</span>]
  <span style="color:#66d9ef">source</span>:
    <span style="color:#66d9ef">pkg</span>: genie.libs.sdk
    <span style="color:#66d9ef">class</span>: triggers.blitz.blitz.Blitz
  <span style="color:#66d9ef">devices</span>: [<span style="color:#e6db74">&#39;csr1000v-1&#39;</span>]
  <span style="color:#66d9ef">configure</span>:
    <span style="color:#66d9ef">devices</span>:
      <span style="color:#66d9ef">csr1000v-1</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        snmp-server community blitz</span>
    <span style="color:#66d9ef">sleep</span>: <span style="color:#66d9ef">10validate_configure</span>:
    <span style="color:#66d9ef">devices</span>:
      <span style="color:#66d9ef">csr1000v-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show running-config
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;snmp-server community blitz&#39;</span>
  <span style="color:#66d9ef">unconfigure</span>:
    <span style="color:#66d9ef">devices</span>:
      <span style="color:#66d9ef">csr1000v-1</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        no snmp-server community blitz</span>
  <span style="color:#66d9ef">validate_unconfigure</span>:
    <span style="color:#66d9ef">devices</span>:
      <span style="color:#66d9ef">csr1000v-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show running-config
          <span style="color:#66d9ef">exclude</span>:
           -<span style="color:#e6db74">&#39;snmp-server community blitz&#39;</span>
</code></pre></div><p>The above is for the copy and paste, and the explanation for each item is given below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:trigger_datafile.yaml" data-lang="yaml:trigger_datafile.yaml"><span style="color:#66d9ef">TriggerBlitzConfigureSnmpCommunity</span>: <span style="color:#75715e"># Test item name. Especially what</span>
  <span style="color:#66d9ef">groups</span>: [<span style="color:#e6db74">&#39;blitz&#39;</span>,<span style="color:#e6db74">&#39;snmp&#39;</span>] <span style="color:#75715e"># specify groups. I can write in a list. Used by genie run command</span>
  <span style="color:#66d9ef">source</span>: specify the location of Blitz code to use <span style="color:#75715e"># Blitz. Remember as a spell</span>
    <span style="color:#66d9ef">pkg</span>: genie.libs.sdk
    <span style="color:#66d9ef">class</span>: triggers.blitz.blitz.Blitz
  <span style="color:#66d9ef">devices</span>: [<span style="color:#e6db74">&#39;csr1000v-1&#39;</span>] <span style="color:#75715e"># specify the device. Note that if you specify multiple units, the same content will be repeated for each unit.</span>
  <span style="color:#66d9ef">configure</span>: <span style="color:#75715e"># additional configuration section</span>
    <span style="color:#66d9ef">devices</span>:
      <span style="color:#66d9ef">csr1000v-1</span>: | <span style="color:#75715e"># device host name</span>
        snmp-server community blitz <span style="color:#75715e"># Write the settings that match the specified device. Multiple lines are OK</span>
    <span style="color:#66d9ef">sleep</span>: <span style="color:#ae81ff">10</span> <span style="color:#75715e"># add wait time (seconds) after setting</span>
  <span style="color:#66d9ef">validate_configure</span>: <span style="color:#75715e"># Verify additional configuration section</span>
    <span style="color:#66d9ef">devices</span>:
      <span style="color:#66d9ef">csr1000v-1</span>: <span style="color:#75715e"># device host name</span>
        <span style="color:#66d9ef">1</span>: <span style="color:#75715e"># Confirm 1. It is possible to write multiple 2 or 3 in the same way</span>
          <span style="color:#66d9ef">command</span>: show running-config <span style="color:#75715e"># show command</span>
          <span style="color:#66d9ef">include</span>: <span style="color:#75715e"># include confirms that the show command includes the following output</span>
           -<span style="color:#e6db74">&#39;snmp-server community blitz&#39;</span>
  <span style="color:#66d9ef">unconfigure</span>: <span style="color:#75715e"># section for configuration removal</span>
    <span style="color:#66d9ef">devices</span>:
      <span style="color:#66d9ef">csr1000v-1</span>: | <span style="color:#75715e"># device host name</span>
        no snmp-server community blitz <span style="color:#75715e"># Write the settings suitable for the specified device. Multiple lines are OK</span>
  <span style="color:#66d9ef">validate_unconfigure</span>: <span style="color:#75715e"># Confirm unconfigure section</span>
    <span style="color:#66d9ef">devices</span>:
      <span style="color:#66d9ef">csr1000v-1</span>: <span style="color:#75715e"># device host name</span>
        <span style="color:#66d9ef">1</span>: <span style="color:#75715e"># Confirm 1. It is possible to write multiple 2 or 3 in the same way</span>
          <span style="color:#66d9ef">command</span>: show running-config <span style="color:#75715e"># show command</span>
          <span style="color:#66d9ef">exclude</span>: <span style="color:#75715e"># exclude confirms that the show command does not include the following output</span>
           -<span style="color:#e6db74">&#39;snmp-server community blitz&#39;</span>
</code></pre></div><p>Blitz&rsquo;s automation items can be specified simply as follows.</p>
<ol>
<li>configure: add settings</li>
<li>validate_configure: Confirm addition of configuration</li>
<li>unconfigure: Delete configuration</li>
<li>validate_unconfigure: Confirm deletion of configuration</li>
</ol>
<p>** Also, all of the above does not have to exist, you can write only what you need. **</p>
<p>Run with # genie run</p>
<p>Now run the genie run command on the above trigger_datafile.yaml.
genie run &ndash;testbed-file tb.yaml &ndash;trigger-file trigger_datafile.yaml &ndash;trigger-groups &ldquo;And(&lsquo;blitz&rsquo;)&rdquo;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">(</span>genie_env<span style="color:#f92672">)</span>$ genie run --testbed-file tb.yaml --trigger-file trigger_datafile.yaml --trigger-groups <span style="color:#e6db74">&#34;And(&#39;blitz&#39;)&#34;</span>
<span style="color:#f92672">(</span>snip<span style="color:#f92672">)</span>
2019-12-09T21:20:50: %EASYPY-INFO: +---------------------------------- --------------------------------------------+
2019-12-09T21:20:50: %EASYPY-INFO: | Easypy Report |
2019-12-09T21:20:50: %EASYPY-INFO: +---------------------------------- --------------------------------------------+
2019-12-09T21:20:50: %EASYPY-INFO: pyATS Instance :/Users/tahigash/.pyenv/versions/3.7.3/envs/genie_env
2019-12-09T21:20:50: %EASYPY-INFO: Python Version :cpython-3.7.3 <span style="color:#f92672">(</span>64bit<span style="color:#f92672">)</span>
2019-12-09T21:20:50: %EASYPY-INFO: CLI Arguments :/Users/tahigash/.pyenv/versions/genie_env/bin/genie run --testbed-file tb.yaml --trigger-file trigger_datafile.yaml --trigger-groups And<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;blitz&#39;</span><span style="color:#f92672">)</span>
2019-12-09T21:20:50: %EASYPY-INFO: User :tahigash
2019-12-09T21:20:50: %EASYPY-INFO: Host Server :TAHIGASH-M-K2AT
2019-12-09T21:20:50: %EASYPY-INFO: Host OS Version: Mac OSX 10.14.6 <span style="color:#f92672">(</span>x86_64<span style="color:#f92672">)</span>
2019-12-09T21:20:50: %EASYPY-INFO:
2019-12-09T21:20:50: %EASYPY-INFO: Job Information
2019-12-09T21:20:50: %EASYPY-INFO: Name :job
2019-12-09T21:20:50: %EASYPY-INFO: Start time: 2019-12-09 21:19:45.983371
2019-12-09T21:20:50: %EASYPY-INFO: Stop time: 2019-12-09 21:20:49.931930
2019-12-09T21:20:50: %EASYPY-INFO: Elapsed time: 0:01:03.948559
2019-12-09T21:20:50: %EASYPY-INFO: Archive :/Users/tahigash/.pyats/archive/19-Dec/job.2019Dec09_21:19:44.951298.zip
2019-12-09T21:20:50: %EASYPY-INFO:
2019-12-09T21:20:50: %EASYPY-INFO: Total Tasks :1
2019-12-09T21:20:50: %EASYPY-INFO:
2019-12-09T21:20:50: %EASYPY-INFO: Overall Stats
2019-12-09T21:20:50: %EASYPY-INFO: Passed :2
2019-12-09T21:20:50: %EASYPY-INFO: Passx :1
2019-12-09T21:20:50: %EASYPY-INFO: Failed :0
2019-12-09T21:20:50: %EASYPY-INFO: Aborted :0
2019-12-09T21:20:50: %EASYPY-INFO: Blocked :0
2019-12-09T21:20:50: %EASYPY-INFO: Skipped :0
2019-12-09T21:20:50: %EASYPY-INFO: Errored :0
2019-12-09T21:20:50: %EASYPY-INFO:
2019-12-09T21:20:50: %EASYPY-INFO: TOTAL :3
2019-12-09T21:20:50: %EASYPY-INFO:
2019-12-09T21:20:50: %EASYPY-INFO: Success Rate: 100.00%
2019-12-09T21:20:50: %EASYPY-INFO:
2019-12-09T21:20:50: %EASYPY-INFO: +---------------------------------- --------------------------------------------+2019-12-09T21:20:50: %EASYPY-INFO: |                             Task Result Summary                              |
2019-12-09T21:20:50: %EASYPY-INFO: +------------------------------------------------------------------------------+
2019-12-09T21:20:50: %EASYPY-INFO: Task-1: genie_testscript.common_setup                                      PASSX
2019-12-09T21:20:50: %EASYPY-INFO: Task-1: genie_testscript.TriggerBlitzConfigureSnmpCommunity.csr1000v-1    PASSED
2019-12-09T21:20:50: %EASYPY-INFO: Task-1: genie_testscript.common_cleanup                                   PASSED
2019-12-09T21:20:50: %EASYPY-INFO:
2019-12-09T21:20:50: %EASYPY-INFO: +------------------------------------------------------------------------------+
2019-12-09T21:20:50: %EASYPY-INFO: |                             Task Result Details                              |
2019-12-09T21:20:50: %EASYPY-INFO: +------------------------------------------------------------------------------+
2019-12-09T21:20:50: %EASYPY-INFO: Task-1: genie_testscript
2019-12-09T21:20:50: %EASYPY-INFO: |-- common_setup                                                           PASSX
2019-12-09T21:20:50: %EASYPY-INFO: |   |-- connect                                                           PASSED
2019-12-09T21:20:50: %EASYPY-INFO: |   |-- configure                                                        SKIPPED
2019-12-09T21:20:50: %EASYPY-INFO: |   |-- configuration_snapshot                                            PASSED
2019-12-09T21:20:50: %EASYPY-INFO: |   |-- save_bootvar                                                       PASSX
2019-12-09T21:20:50: %EASYPY-INFO: |   |-- learn_system_defaults                                             PASSED
2019-12-09T21:20:50: %EASYPY-INFO: |   <span style="color:#e6db74">`</span>-- initialize_traffic                                               SKIPPED
2019-12-09T21:20:50: %EASYPY-INFO: |-- TriggerBlitzConfigureSnmpCommunity.csr1000v-1                         PASSED
2019-12-09T21:20:50: %EASYPY-INFO: |   |-- apply_configuration                                               PASSED
2019-12-09T21:20:50: %EASYPY-INFO: |   |-- validate_configuration                                            PASSED
2019-12-09T21:20:50: %EASYPY-INFO: |   |   |-- STEP 1: Verify the output of <span style="color:#e6db74">&#39;show running-config&#39;</span>            PASSED
2019-12-09T21:20:50: %EASYPY-INFO: |   |   <span style="color:#e6db74">`</span>-- STEP 1.1: Verify that <span style="color:#e6db74">&#39;snmp-server community blitz&#39;</span> is ...    PASSED
2019-12-09T21:20:50: %EASYPY-INFO: |   |-- remove_configuration                                              PASSED
2019-12-09T21:20:50: %EASYPY-INFO: |   <span style="color:#e6db74">`</span>-- validate_unconfiguration                                          PASSED
2019-12-09T21:20:50: %EASYPY-INFO: |       |-- STEP 1: Verify the output of <span style="color:#e6db74">&#39;show running-config&#39;</span>            PASSED
2019-12-09T21:20:50: %EASYPY-INFO: |       <span style="color:#e6db74">`</span>-- STEP 1.1: Verify that <span style="color:#e6db74">&#39;snmp-server community blitz&#39;</span> is ...    PASSED
2019-12-09T21:20:50: %EASYPY-INFO: <span style="color:#e6db74">`</span>-- common_cleanup                                                        PASSED
2019-12-09T21:20:50: %EASYPY-INFO:     |-- verify_configuration_snapshot                                     PASSED
2019-12-09T21:20:50: %EASYPY-INFO:     <span style="color:#e6db74">`</span>-- stop_traffic                                                     SKIPPED
2019-12-09T21:20:50: %EASYPY-INFO: Sending report email...
2019-12-09T21:20:50: %EASYPY-INFO: Missing SMTP server configuration, or failed to reach/authenticate/send mail. Result notification email failed to send.
2019-12-09T21:20:50: %EASYPY-INFO: Done!

Pro Tip
- ------
   Use the following command to view your logs locally:
       pyats logs view
</code></pre></div><p>genie run コマンドを実行すると一連のログがターミナル画面上に表示され、上記のように CLI 上で結果のサマリーを最後に見ることできます。</p>
<h1 id="gui-で綺麗にログを見よう">GUI で綺麗にログを見よう</h1>
<p>前述の CLI 上の結果の後に Pro Tip として表示されていますが、<code>pyats logs view</code> と入力することで、一番最新のログを Webブラウザ で開くことができます。</p>
<pre><code>(genie_env)$ pyats logs view
</code></pre><p>まず開くと見えるのは <code>Overview</code> 画面です。何個の項目が実行されたか、実行結果のサマリー(Passed/Failed)が表示されます。
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/3b1cc5c2-449a-4448-89bb-6261043a9283.png" alt="image.png"></p>
<p>上のタブから <code>Task-1</code> をクリックするとテストされた項目がリスト表示され、こちらでも各項目毎に PASSED/FAILED といった結果を見ることができます。
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/5e14e58a-ce3b-61c1-b0e5-4ab2d9fe30dc.png" alt="image.png"></p>
<p><code>commonSetup</code>や<code>commonCleanup</code>は<code>genie run</code>を実行した際にデフォルトで実行される項目となりますが、機器への接続やコンフィグの確認などの基本的な情報取得、確認がメインとなりますが、今回は詳細は割愛します。</p>
<p>各項目をクリックすると、実行されたログが確認できます。試しに<code>TriggerBlitzConfigureSnmpCommunicy</code>の<code>apply_configuration</code>を開いてみます。
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/d2f9b7e9-90a1-a223-f2fd-ee8c5eebaf68.png" alt="image.png">
すると上記のように<code>trigger_datafile.yaml</code>で指定した設定内容が設定されているのが確認できます。</p>
<p>次は<code>validate_configuration</code>をクリックしてみます。
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/f2c4c37e-490b-68b3-4bd2-c16ae57c4dc8.png" alt="image.png">
こちらも<code>trigger_datafile.yaml</code>に記載した通り、<code>show run</code>を実行して<code>snmp-server community</code>のラインが含まれることがチェックされています。</p>
<p>割愛しますが、<code>remote_configuration</code>及び<code>validate_unconfiguration</code>も同じ要領です。** This is a function called <code>Logviewer</code>, but it is very convenient to check the log easily. You don&rsquo;t need to install any GUI tools to see the logs in your web browser. **</p>
<p>*NOTE: The pyATS|Genie team is also developing a multi-functional GUI tool, and we are planning to release it outside, so please look forward to it. We have already introduced demos at events such as Cisco Live US 2019. *</p>
<h1 id="set-snmp-community-to-all-devices">Set SNMP community to all devices</h1>
<p>The story is a little off the GUI. Let&rsquo;s get back to network automation. Let&rsquo;s change the settings of all devices based on the example of adding and deleting settings earlier.
Since the details of each item are described above, I will put the trigger_datafile.yaml that sets all devices quickly.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:trigger_datafile.yaml" data-lang="yaml:trigger_datafile.yaml"><span style="color:#66d9ef">TriggerBlitzConfigureSnmpCommunity</span>:
  <span style="color:#66d9ef">groups</span>: [<span style="color:#e6db74">&#39;blitz&#39;</span>,<span style="color:#e6db74">&#39;snmp&#39;</span>]
  <span style="color:#66d9ef">source</span>:
    <span style="color:#66d9ef">pkg</span>: genie.libs.sdk
    <span style="color:#66d9ef">class</span>: triggers.blitz.blitz.Blitz
  <span style="color:#66d9ef">devices</span>: [<span style="color:#e6db74">&#39;csr1000v-1&#39;</span>]
  <span style="color:#66d9ef">configure</span>:
    <span style="color:#66d9ef">devices</span>:
      <span style="color:#66d9ef">csr1000v-1</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        snmp-server community blitz</span>
      <span style="color:#66d9ef">iosv-1</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        snmp-server community blitz</span>
      <span style="color:#66d9ef">iosv-2</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        snmp-server community blitz</span>
      <span style="color:#66d9ef">iosv-3</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        snmp-server community blitz</span>
      <span style="color:#66d9ef">iosxrv9000-1</span>:
        snmp-server community blitz
      <span style="color:#66d9ef">nx-osv9000-1</span>:
        snmp-server community blitz
  <span style="color:#66d9ef">validate_configure</span>:
    <span style="color:#66d9ef">devices</span>:
      <span style="color:#66d9ef">csr1000v-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show running-config
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;snmp-server community blitz&#39;</span>
      <span style="color:#66d9ef">iosv-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show running-config
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;snmp-server community blitz&#39;</span>
      <span style="color:#66d9ef">iosv-2</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show running-config
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;snmp-server community blitz&#39;</span>
      <span style="color:#66d9ef">iosv-3</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show running-config
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;snmp-server community blitz&#39;</span>
      <span style="color:#66d9ef">iosxrv9000-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show running-config
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;snmp-server community blitz&#39;</span>
      <span style="color:#66d9ef">nx-osv9000-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show running-config
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;snmp-server community blitz&#39;</span>
</code></pre></div><p>The points are as follows.</p>
<p>1.Specify <strong>only one device</strong> to devices
2. Since I only want to add settings, remove <code>unconfigure</code>/<code>validate_unconfigure</code>.
3. Specify the setting contents, confirmation command, and <code>include</code> that match each router.</p>
<p>As I&rsquo;ve written so far, I noticed that the settings and confirmation methods were the same for all environments with mixed IOSXE, IOSXR, and NXOS. .. .. Please be assured that the contents will be different in the iBGP settings described below.</p>
<p>Try running the same <code>genie run</code> command. The appearance of the summary of results has changed a little.</p>
<pre><code>(genie_dev)$ genie run --testbed-file tb.yaml --trigger-file trigger_datafile.yaml --trigger-groups &quot;And('blitz')&quot;
(snip)
2019-12-09T22:02:29: %EASYPY-INFO: |-- TriggerBlitzConfigureSnmpCommunity.csr1000v-1 PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | |-- apply_configuration PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | |---- validate_configuration PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | | |---- STEP 1: Verify the output of'show running-config' PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | | |-- STEP 1.1: Verify that'snmp-server community blitz' is ... PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | | |-- STEP 2: Verify the output of'show running-config' PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | | |---- STEP 2.1: Verify that'snmp-server community blitz' is ... PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | | |-- STEP 3: Verify the output of'show running-config' PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | | |---- STEP 3.1: Verify that'snmp-server community blitz' is ... PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | | |-- STEP 4: Verify the output of'show running-config' PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | | |---- STEP 4.1: Verify that'snmp-server community blitz' is ... PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | | |-- STEP 5: Verify the output of'show running-config' PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | | |---- STEP 5.1: Verify that'snmp-server community blitz' is ... PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | | |---- STEP 6: Verify the output of'show running-config' PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | | `-- STEP 6.1: Verify that'snmp-server community blitz' is ... PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | |-- remove_configuration PASSED
2019-12-09T22:02:29: %EASYPY-INFO: | `-- validate_unconfiguration PASSED
(snip)
</code></pre><p>Check <code>apply_configuration</code> with <code>Logviewer</code> (pyats logs view command).
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/c09f6c1e-05f6-46cb-da63-a98d14b04d07.png" alt="image.png">
If you look at the above, you can confirm that it is properly set for each device. You can see that the <code>commit</code> is done properly in the <code>IOSXR</code>.</p>
<p>Looking at <code>validate_configuration</code>, <code>STEP</code> is executed separately for each confirmation.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/a0b1beae-6e36-a28a-c9c3-b73ec5178664.png" alt="image.png"></p>
<p>STEP is in the order described in <code>trigger_datafile.yaml</code>, so when you open the one of <code>iosxrv9000-1</code> (the second from the end, STEP5), the log is properly confirmed in <code>IOSXR</code>.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/8fcca15b-fb8f-edd2-1f7e-f0cbbd899691.png" alt="image.png"></p>
<p>Also, <code>remove_configuration</code>/<code>validate_unconfiguration</code> is displayed, but since it is deleted from <code>trigger_datafile.yaml</code>, nothing is executed as shown below.<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/863ccd5b-d68f-ef0f-f8de-803b621627ea.png" alt="image.png"></p>
<p>How about here? No programming is required, and the setting input and confirmation can be automated with the known <code>CLI</code> command.</p>
<p>It&rsquo;s getting a little longer, but next is the application.</p>
<h1 id="set-ibgp-on-all-devices">Set iBGP on all devices</h1>
<p>As I wrote at the beginning, set iBGP with <code>iosv-1</code>/<code>iosv-2</code> in the network configuration as the RR.</p>
<p>The loopback address of each router for iBGP settings is as follows. The BGP AS is 65000.</p>
<table>
<thead>
<tr>
<th align="left">Hostname</th>
<th align="left">Interface</th>
<th align="left">Address</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">iosv-1</td>
<td align="left">Loopback0</td>
<td align="left">10.11.11.11/32</td>
</tr>
<tr>
<td align="left">iosv-2</td>
<td align="left">Loopback0</td>
<td align="left">10.22.22.22/32</td>
</tr>
<tr>
<td align="left">iosv-3</td>
<td align="left">Loopback0</td>
<td align="left">10.33.33.33/32</td>
</tr>
<tr>
<td align="left">csr1000v-1</td>
<td align="left">Loopback0</td>
<td align="left">10.44.44.44/32</td>
</tr>
<tr>
<td align="left">iosxr9000-1</td>
<td align="left">Loopback0</td>
<td align="left">10.55.55.55/32</td>
</tr>
<tr>
<td align="left">nx-osv9000-1</td>
<td align="left">Loopback0</td>
<td align="left">10.66.66.66/32</td>
</tr>
</tbody>
</table>
<p>Since the explanation of <code>trigger_datafile.yaml</code> was given above, the contents will be posted suddenly. I named it <code>TriggerBlitzConfigureIBGP</code> as a new item because of the IBGP settings.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:trigger_datafile.yaml" data-lang="yaml:trigger_datafile.yaml"><span style="color:#66d9ef">TriggerBlitzConfigureIBGP</span>:
  <span style="color:#66d9ef">groups</span>: [<span style="color:#e6db74">&#39;blitz&#39;</span>,<span style="color:#e6db74">&#39;bgp&#39;</span>]
  <span style="color:#66d9ef">source</span>:
    <span style="color:#66d9ef">pkg</span>: genie.libs.sdk
    <span style="color:#66d9ef">class</span>: triggers.blitz.blitz.Blitz
  <span style="color:#66d9ef">devices</span>: [<span style="color:#e6db74">&#39;csr1000v-1&#39;</span>]
  <span style="color:#66d9ef">configure</span>:
    <span style="color:#66d9ef">devices</span>:
      <span style="color:#66d9ef">iosv-1</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        router bgp 65000</span>
         neighbor IBGP peer-group
         neighbor IBGP remote-as <span style="color:#ae81ff">65000</span>
         neighbor IBGP update-source lo0
         neighbor IBGP route-reflector-client
         neighbor <span style="color:#ae81ff">10.33.33.33</span> peer-group IBGP
         neighbor <span style="color:#ae81ff">10.44.44.44</span> peer-group IBGP
         neighbor <span style="color:#ae81ff">10.55.55.55</span> peer-group IBGP
         neighbor <span style="color:#ae81ff">10.66.66.66</span> peer-group IBGP
      <span style="color:#66d9ef">iosv-2</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        router bgp 65000</span>
         neighbor IBGP peer-group
         neighbor IBGP remote-as <span style="color:#ae81ff">65000</span>
         neighbor IBGP update-source lo0
         neighbor IBGP route-reflector-client
         neighbor <span style="color:#ae81ff">10.33.33.33</span> peer-group IBGP
         neighbor <span style="color:#ae81ff">10.44.44.44</span> peer-group IBGP
         neighbor <span style="color:#ae81ff">10.55.55.55</span> peer-group IBGP
         neighbor <span style="color:#ae81ff">10.66.66.66</span> peer-group IBGP
      <span style="color:#66d9ef">iosv-3</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        router bgp 65000</span>
         neighbor RR peer-group
         neighbor RR remote-as <span style="color:#ae81ff">65000</span>
         neighbor RR update-source lo0
         neighbor <span style="color:#ae81ff">10.11.11.11</span> peer-group RR
         neighbor <span style="color:#ae81ff">10.22.22.22</span> peer-group RR
      <span style="color:#66d9ef">csr1000v-1</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        router bgp 65000</span>
         neighbor RR peer-group
         neighbor RR remote-as <span style="color:#ae81ff">65000</span>
         neighbor RR update-source lo0
         neighbor <span style="color:#ae81ff">10.11.11.11</span> peer-group RR
         neighbor <span style="color:#ae81ff">10.22.22.22</span> peer-group RR
      <span style="color:#66d9ef">iosxrv9000-1</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        router bgp 65000</span>
         address-family ipv4 unicast
         neighbor <span style="color:#ae81ff">10.11.11.11</span>
          remote-as <span style="color:#ae81ff">65000</span>
          update-source lo0
          address-family ipv4 unicast
         neighbor <span style="color:#ae81ff">10.22.22.22</span>
          remote-as <span style="color:#ae81ff">65000</span>
          update-source lo0
          address-family ipv4 unicast
      <span style="color:#66d9ef">nx-osv9000-1</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        feature bgp</span>
        router bgp <span style="color:#ae81ff">65000</span>
         address-family ipv4 unicast
         neighbor <span style="color:#ae81ff">10.11.11.11</span>
          remote-as <span style="color:#ae81ff">65000</span>
          update-source lo0
          address-family ipv4 unicast
         neighbor <span style="color:#ae81ff">10.22.22.22</span>
          remote-as <span style="color:#ae81ff">65000</span>
          update-source lo0
          address-family ipv4 unicast
    <span style="color:#66d9ef">sleep</span>: <span style="color:#ae81ff">60</span>
  <span style="color:#66d9ef">validate_configure</span>:
    <span style="color:#66d9ef">devices</span>:
      <span style="color:#66d9ef">iosv-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.33.33.33</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
        <span style="color:#66d9ef">2</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.44.44.44</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
        <span style="color:#66d9ef">3</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.55.55.55</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
        <span style="color:#66d9ef">Four</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.66.66.66</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
      <span style="color:#66d9ef">iosv-2</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.33.33.33</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
        <span style="color:#66d9ef">2</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.44.44.44</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
        <span style="color:#66d9ef">3</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.55.55.55</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
        <span style="color:#66d9ef">Four</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.66.66.66</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
      <span style="color:#66d9ef">iosv-3</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.11.11.11</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
        <span style="color:#66d9ef">2</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.22.22.22</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
      <span style="color:#66d9ef">csr1000v-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.11.11.11</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
           -<span style="color:#e6db74">&#39;max data segment is 1460 bytes&#39;</span>
        <span style="color:#66d9ef">2</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.22.22.22</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
           -<span style="color:#e6db74">&#39;max data segment is 1500 bytes&#39;</span>
      <span style="color:#66d9ef">iosxrv9000-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show bgp instance all sessions
          <span style="color:#66d9ef">parsed</span>:
           -<span style="color:#e6db74">&#34;[instance][default][vrf][default][neighbors][10.11.11.11][nbr_state][Established]&#34;</span>
           -<span style="color:#e6db74">&#34;[instance][default][vrf][default][neighbors][10.22.22.22][nbr_state][Established]&#34;</span>
      <span style="color:#66d9ef">nx-osv9000-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: <span style="color:#66d9ef">show bgp vrf all all summaryparsed</span>:
           -<span style="color:#e6db74">&#34;[vrf][default][neighbor][10.11.11.11][address_family][ipv4 unicast][state][(?!Idle)]&#34;</span>
           -<span style="color:#e6db74">&#34;[vrf][default][neighbor][10.22.22.22][address_family][ipv4 unicast][state][(?!Idle)]&#34;</span>
           -<span style="color:#e6db74">&#34;[vrf][default][neighbor][10.22.22.22][address_family][ipv4 unicast][as][65000]&#34;</span>
</code></pre></div><p>Let&rsquo;s see what I have tried this time.</p>
<h2 id="configure-multiple-lines-and-insert-wait-time-sleep">Configure multiple lines and insert wait time (sleep)</h2>
<p>The configuration is set over multiple lines as shown below, and <code>sleep: 60</code> is put at the end of <code>configure</code> to insert a waiting time of 60 seconds to wait for the BGP Neighbor to come up.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">(snip)
      <span style="color:#66d9ef">nx-osv9000-1</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        feature bgp</span>
        router bgp <span style="color:#ae81ff">65000</span>
         address-family ipv4 unicast
         neighbor <span style="color:#ae81ff">10.11.11.11</span>
          remote-as <span style="color:#ae81ff">65000</span>
          update-source lo0
          address-family ipv4 unicast
         neighbor <span style="color:#ae81ff">10.22.22.22</span>
          remote-as <span style="color:#ae81ff">65000</span>
          update-source lo0
          address-family ipv4 unicast
    <span style="color:#66d9ef">sleep</span>: <span style="color:#ae81ff">60</span>
(snip)
</code></pre></div><p>If you look at the <code>apply_configuration</code> in the <code>Logviewer</code>, you can see that the settings are the same as the console of the device as shown below, and you can see that it is sleeping for 60 seconds.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/9c21f874-ca45-655a-7564-2cdfc897f945.png" alt="image.png"></p>
<h2 id="check-bgp-neighbor-up-in-multiple-ways">Check BGP Neighbor Up in multiple ways</h2>
<p>In the previous example of the SNMP community, it was only confirmed from <code>show run</code>, but this time, it was confirmed with 3 patterns using the <code>show</code> command.</p>
<h3 id="1-include-combination">1. include combination</h3>
<p>Check with <code>include</code> using multiple commands for one device as shown below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">      <span style="color:#66d9ef">iosv-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.33.33.33</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
        <span style="color:#66d9ef">2</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.44.44.44</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
        <span style="color:#66d9ef">3</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.55.55.55</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
        <span style="color:#66d9ef">Four</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.66.66.66</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
</code></pre></div><p>Check by setting multiple keywords in <code>inxclude</code> as shown below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">      <span style="color:#66d9ef">csr1000v-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.11.11.11</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
           -<span style="color:#e6db74">&#39;max data segment is 1460 bytes&#39;</span>
        <span style="color:#66d9ef">2</span>:
          <span style="color:#66d9ef">command</span>: show ip bgp neighbors <span style="color:#ae81ff">10.22.22.22</span>
          <span style="color:#66d9ef">include</span>:
           -<span style="color:#e6db74">&#39;BGP state = Established&#39;</span>
           -<span style="color:#e6db74">&#39;max data segment is 1500 bytes&#39;</span>
</code></pre></div><p>By the way, in the confirmation of <code>MSS(max data segment)</code>, No. 2 is actually 1460 bytes by default, so it becomes <code>FAILED</code>. Although it becomes <code>FAILED</code> as the item STEP12, you can see that you can confirm <code>Established</code> of STEP 12.1 properly.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/f4f6de84-9861-06ea-d072-a5f2cc94db58.png" alt="image.png"></p>
<h3 id="2-use-parsed">2. Use parsed</h3>
<p>The following example is my first time using <code>parsed</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">      <span style="color:#66d9ef">iosxrv9000-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show bgp instance all sessions
          <span style="color:#66d9ef">parsed</span>:
           -<span style="color:#e6db74">&#34;[instance][default][vrf][default][neighbors][10.11.11.11][nbr_state][Established]&#34;</span>
           -<span style="color:#e6db74">&#34;[instance][default][vrf][default][neighbors][10.22.22.22][nbr_state][Established]&#34;</span>
</code></pre></div><p>This is because <code>include</code> checks whether the specified string is included in the output of the show command, but <code>parsed</code> checks according to the Genei Parser Schema.</p>
<p>Schema of IOS XR <code>show bgp instance all sessions</code> is as follows.</p>
<p><a href="https://pubhub.devnetcloud.com/media/genie-feature-browser/docs/#/parsers/show%20bgp%20instance%20all%20sessions">https://pubhub.devnetcloud.com/media/genie-feature-browser/docs/#/parsers/show%20bgp%20instance%20all%20sessions</a></p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/416265f3-f306-077c-f0c6-9a96a0924645.png" alt="image.png"></p>
<p>In the log on <code>Logviewer</code>, you can check as follows.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/381f2b40-f8f4-88a9-890c-a5cc142e784e.png" alt="image.png"></p>
<h3 id="3-negative-check-and-multiple-key-check-with-parsed">3. Negative check and multiple key check with parsed</h3>
<p>The following also uses <code>parsed</code>, but it is checked ** by using **(?!) as not corresponding to the one specified in the negative expression. Therefore, if the <code>state</code> is not <code>Idle</code>, it becomes <code>PASSED</code>.
Since it is <code>Parsed</code>, the specified hierarchy is the one that matches the Schema of Genie Parser.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">      <span style="color:#66d9ef">nx-osv9000-1</span>:
        <span style="color:#66d9ef">1</span>:
          <span style="color:#66d9ef">command</span>: show bgp vrf all all summary
          <span style="color:#66d9ef">parsed</span>:
           -<span style="color:#e6db74">&#34;[vrf][default][neighbor][10.11.11.11][address_family][ipv4 unicast][state][(?!Idle)]&#34;</span>
           -<span style="color:#e6db74">&#34;[vrf][default][neighbor][10.22.22.22][address_family][ipv4 unicast][state][(?!Idle)]&#34;</span>
           -<span style="color:#e6db74">&#34;[vrf][default][neighbor][10.22.22.22][address_family][ipv4 unicast][as][65000]&#34;</span>
</code></pre></div><p>Also, by adding a condition, we have also confirmed that the AS number for the neighbor of <code>10.22.22.22</code> is 65000.</p>
<p>It looks like this when viewed with <code>Logviewer</code>.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/649ae1a4-1c16-bcdd-9099-45b793603bf6.png" alt="image.png"></p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/309712/7fe16bb6-6028-a27a-d622-3a5afa0e0421.png" alt="image.png"></p>
<h2 id="how-to-run-genie-run">How to run genie run</h2>
<p>Finally, I would like to briefly introduce how to use genie run.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:trigger_datafile.yaml" data-lang="yaml:trigger_datafile.yaml"><span style="color:#66d9ef">TriggerBlitzConfigureSnmpCommunity</span>:
  <span style="color:#66d9ef">groups</span>: [<span style="color:#e6db74">&#39;blitz&#39;</span>,<span style="color:#e6db74">&#39;snmp&#39;</span>]
(snip)

<span style="color:#66d9ef">TriggerBlitzConfigureIBGP</span>:
  <span style="color:#66d9ef">groups</span>: [<span style="color:#e6db74">&#39;blitz&#39;</span>,<span style="color:#e6db74">&#39;bgp&#39;</span>]
(snip)
</code></pre></div><p>This time, create two test cases as above and set the <code>groups</code>. As the name implies, <code>groups</code> are grouped, so you can select the execution target with <code>groups</code>.</p>
<h3 id="i-want-to-execute-both-triggerblitzconfiguresnmpcommunity-and-triggerblitzconfigureibgp">I want to execute both TriggerBlitzConfigureSnmpCommunity and TriggerBlitzConfigureIBGP</h3>
<p>Specify <code>blitz</code> included in both as And as shown below. (Or can be used if only one is specified)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">(</span>genie_env<span style="color:#f92672">)</span>$ genie run --testbed-file tb.yaml --trigger-file trigger_datafile.yaml --trigger-groups <span style="color:#e6db74">&#34;And(&#39;blitz&#39;)&#34;</span>
Or
<span style="color:#f92672">(</span>genie_env<span style="color:#f92672">)</span>$ genie run --testbed-file tb.yaml --trigger-file trigger_datafile.yaml --trigger-groups <span style="color:#e6db74">&#34;Or(&#39;blitz&#39;)&#34;</span>
<span style="color:#e6db74">```</span>As you may have already understood, you can write both in And/Or, so you can <span style="color:#66d9ef">do</span> both below.

<span style="color:#e6db74">```</span>bash
<span style="color:#f92672">(</span>genie_env<span style="color:#f92672">)</span>$ genie run --testbed-file tb.yaml --trigger-file trigger_datafile.yaml --trigger-groups <span style="color:#e6db74">&#34;Or(&#39;snmp&#39;,&#39;bgp&#39;)&#34;</span>
</code></pre></div><p>In this example, it doesn&rsquo;t have much meaning, but since you can also write as follows, you can flexibly control the execution target using <code>groups</code> even if there are many triggers (test cases). Both of the following are also executed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">(</span>genie_env<span style="color:#f92672">)</span>$ genie run --testbed-file tb.yaml --trigger-file trigger_datafile.yaml --trigger-groups <span style="color:#e6db74">&#34;And(&#39;blitz&#39;, Or(&#39;snmp&#39;,&#39;bgp&#39;))&#34;</span>
</code></pre></div><h3 id="i-want-to-execute-with-the-name-of-the-trigger-test-case">I want to execute with the name of the trigger (test case)</h3>
<p>If you want to run with the name of the trigger (test case), use <code>--trigger-uids</code> instead of <code>--trigger-groups</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">(</span>genie_env<span style="color:#f92672">)</span>$ genie run --testbed-file tb.yaml --trigger-file trigger_datafile.yaml --trigger-uids <span style="color:#e6db74">&#34;TriggerBlitsConfigureSnmpCommunity&#34;</span>
</code></pre></div><p>#Summary</p>
<p>You mentioned network automation in Blitz on pyATS|Genie, but what about?</p>
<p>I put in the answer of <code>Blitz</code> for the trouble I wrote at the beginning.</p>
<ol>
<li>Always requires python knowledge **-&gt; Can be written only in YAML **</li>
<li>I have to remember each vendor&rsquo;s module of automation tool **-&gt; pyATS|Genie Especially Blitz only 4 items usage **</li>
<li>I want to make use of the CLI-based knowledge that I learned a lot -&gt; <strong>PyATS|Genie Blitz can utilize the existing CLI knowledge! Parsed makes it easy to check in detail!</strong></li>
<li>I want to automate old devices and configurations as well -&gt; **pyATS|Genie can handle a wide range of old devices and new ones using telnet/serial console, access via bastion, CLI/Netconf/REST as well as SSH **</li>
</ol>
<p>The reason why <code>Blitz</code> is <strong>hidden special move</strong> is that <strong>pyATS|Genie&rsquo;s real charm is that flexible network automation is possible by writing code in python</strong>. As you can see, in the method introduced above, there is no confirmation item such as whether the config already exists before the test, and it is necessary to consider it when using it.</p>
<p>However, as the usage until learning the knowledge of python, you can master usage such as <code>Blitz</code>, touch how to use pyATS|Genie, and accelerate advanced network automation using python with pyATS|Genie. I think so.</p>
<p>pyATS|Genie is evolving more and more, so please look forward to it. If you have ideas for features or feedback/improvements, please feel free to contact us at pyats-support-ext(at)cisco.com (in English) or my @tahigash3 (also in Japanese). (Twitter has the same account name @tahigash3)</p>
<h1 id="reference-link">Reference link</h1>
<ul>
<li><a href="https://developer.cisco.com/docs/pyats/api/">pyATS Document</a></li>
<li><a href="https://developer.cisco.com/docs/genie-docs/">Genie Document</a>
-<a href="https://pubhub.devnetcloud.com/media/genie-docs/docs/cli/genie_run.html">Genie CLI-Genie Run</a></li>
<li><a href="https://pubhub.devnetcloud.com/media/genie-feature-browser/docs/#/">Genie API Browser</a></li>
</ul>
<h1 id="disclaimer">Disclaimer</h1>
<p>The opinions expressed on this site and the corresponding comments are the personal opinions of the contributor and not Cisco. The content on this site is provided for information purposes only and is not intended as a recommendation or representation by Cisco or any other party. Each user is solely responsible for the content of all information posted, linked or otherwise uploaded to this website by disclaiming Cisco from any and all liability for the use of this website. I agree.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
