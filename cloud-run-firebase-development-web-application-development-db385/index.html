<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Cloud run&#43;Firebase development [Web application development] | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Cloud run+Firebase development [Web application development]</h1>
<p>
  <small class="text-secondary">
  
  
  Mar 24, 2020
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/flask">Flask</a></code></small>


<small><code><a href="https://memotut.com/tags/vue.js">Vue.js</a></code></small>


<small><code><a href="https://memotut.com/tags/gcp">gcp</a></code></small>

</p>
<pre><code># Overview
</code></pre>
<p>I am actively using GCP, but I thought that Cloud run + Firebase would be good if I wanted to make a service cheaply and easily, so I summarized it. As for maintainability, I think Cloud run is better when comparing Cloud run and Cloud Functions.</p>
<h1 id="development-environment-list">Development environment list</h1>
<ul>
<li>Source Repository</li>
<li>Cloud build</li>
<li>Cloud run</li>
<li>Firebase(hosting)</li>
</ul>
<p>#Introduction
First, enable the service in the above environment.
The minimum required IAM for gcloud is as follows.</p>
<ul>
<li>Firebase admin</li>
<li>Cloud run admin</li>
</ul>
<p>Since Cloud build is used this time, grant the following permissions to &ldquo;~~@cloudbuild.gserviceaccount.com&rdquo; in IAM.</p>
<ul>
<li>Cloud Run administrator</li>
<li>Cloud Run Service Agent</li>
<li>Storage Object Administrator</li>
</ul>
<h1 id="constitution">Constitution</h1>
<p>The configuration assumes the following: Back-end developers only need to push to the repository, Front-end developers don&rsquo;t care about Back-end and use Cloud run as API server in mind.</p>
<p>The Firestore is now in the configuration, but I won&rsquo;t cover it in this article (maybe in another article).
Also, if you simply think about processing based on Firestore, you can use &ldquo;Cloud Functions&rdquo;, but considering the use of your own library and the maintainability of the source code, &ldquo;Cloud Functions&rdquo; was inconvenient, so &quot; &ldquo;Cloud run&rdquo; is selected.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/159492/ef4f3069-adab-df9b-125d-3c0fb69fd948.jpeg" alt="gcp.jpg"></p>
<h1 id="back-end-side">Back-end side</h1>
<h2 id="bask-end-development-side-directory-structure">Bask-end Development side directory structure</h2>
<p>The directory structure on the back-end side should be at least as follows. You can increase the number of files as needed, but be aware that it is necessary to add processing to the dockerfile described later**.</p>
<pre><code class="language-directory" data-lang="directory">/root
  |-app.py
  |-requirements.txt
  |-cloudbuild.yaml
  '-dockerfile
</code></pre><h2 id="source-repository-settings">Source Repository settings</h2>
<p>As shown in the image below, there is a &ldquo;Create repository&rdquo;. Click it to create it. Also, if you press the three marks, select &ldquo;Manage SSH Keys&rdquo;, and then select &ldquo;Register SSH authentication key&rdquo;, an SSH authentication key will be generated. This will be used when pushing to the repository.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/159492/7004f4fe-6a36-960d-da0e-74c6ea22a46a.jpeg" alt="SSH.jpg"></p>
<h2 id="cloud-build-settings">Cloud Build settings</h2>
<p>If you have Cloud Build enabled, you can create a trigger by selecting the Cloud Build tab -&gt; Triggers tab. The settings are as follows.</p>
<ul>
<li>Event: Push to the branch</li>
<li>Source: created repository</li>
<li>Branch: You don&rsquo;t need to set it up, but you can do &ldquo;production&rdquo;/&ldquo;test&rdquo; for each branch.</li>
<li>Build configuration: /cloudbuild.yaml</li>
</ul>
<p>&ldquo;Cloudbuild.yaml&rdquo; should look like the following. I am trying to change the settings by changing the substitutions.</p>
<ul>
<li>_PLATFORM: Service type setting for Cloud run</li>
<li>_REGION: Location setting</li>
<li>_SERVICE_NAME: Service name</li>
<li>_AUTHENTICATION: Access authority setting</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:cloudbuild.yaml" data-lang="yaml:cloudbuild.yaml"><span style="color:#66d9ef">steps</span>:
  -name:<span style="color:#e6db74">&#39;gcr.io/cloud-builders/docker&#39;</span>
    id:<span style="color:#e6db74">&#39;build-docker-image&#39;</span>
    <span style="color:#66d9ef">args</span>: [<span style="color:#e6db74">&#39;build&#39;</span>,<span style="color:#e6db74">&#39;-t&#39;</span>,<span style="color:#e6db74">&#39;gcr.io/$PROJECT_ID/${_SERVICE_NAME}&#39;</span>,<span style="color:#e6db74">&#39;.&#39;</span>]
  -name:<span style="color:#e6db74">&#39;gcr.io/cloud-builders/docker&#39;</span>
    id:<span style="color:#e6db74">&#39;push-docker-image&#39;</span>
    <span style="color:#66d9ef">args</span>: [<span style="color:#e6db74">&#39;push&#39;</span>,<span style="color:#e6db74">&#39;gcr.io/$PROJECT_ID/${_SERVICE_NAME}&#39;</span>]
  -name:<span style="color:#e6db74">&#39;gcr.io/cloud-builders/gcloud&#39;</span>
    id:<span style="color:#e6db74">&#39;deploy-cloud-run&#39;</span>
    <span style="color:#66d9ef">args</span>: [<span style="color:#e6db74">&#39;beta&#39;</span>,<span style="color:#e6db74">&#39;run&#39;</span>,<span style="color:#e6db74">&#39;deploy&#39;</span>,<span style="color:#e6db74">&#39;${_SERVICE_NAME}&#39;</span>,<span style="color:#e6db74">&#39;--image&#39;</span>,<span style="color:#e6db74">&#39;gcr.io/$PROJECT_ID/${_SERVICE_NAME}&#39;</span>,<span style="color:#e6db74">&#39;--platform=${_PLATFORM }&#39;</span>,<span style="color:#e6db74">&#39;--region&#39;</span>,<span style="color:#e6db74">&#39;${_REGION}&#39;</span>]
  -name:<span style="color:#e6db74">&#39;gcr.io/cloud-builders/gcloud&#39;</span>
    id:<span style="color:#e6db74">&#39;apply-member-role-cloud-run&#39;</span>
    <span style="color:#66d9ef">args</span>: [<span style="color:#e6db74">&#39;beta&#39;</span>,<span style="color:#e6db74">&#39;run&#39;</span>,<span style="color:#e6db74">&#39;services&#39;</span>,<span style="color:#e6db74">&#39;add-iam-policy-binding&#39;</span>,<span style="color:#e6db74">&#39;${_SERVICE_NAME}&#39;</span>,<span style="color:#e6db74">&#39;--region&#39;</span>,<span style="color:#e6db74">&#39;${_REGION}&#39;</span>,<span style="color:#e6db74">&#39;--platform= ${_PLATFORM}&#39;</span>,<span style="color:#e6db74">&#39;--member&#39;</span>,<span style="color:#e6db74">&#39;${_AUTHENTICATION}&#39;</span>,<span style="color:#e6db74">&#39;--role&#39;</span>,<span style="color:#e6db74">&#39;roles/run.invoker&#39;</span>]
<span style="color:#66d9ef">substitutions</span>:
  <span style="color:#66d9ef">_PLATFORM</span>: managed <span style="color:#75715e"># full manage</span>
  <span style="color:#66d9ef">_REGION</span>: asia-northeast1 <span style="color:#75715e"># tokyo</span>
  <span style="color:#66d9ef">_SERVICE_NAME</span>: &lt;_SERVICE_NAME&gt; <span style="color:#75715e"># service name</span>
  <span style="color:#66d9ef">_AUTHENTICATION</span>: allUsers <span style="color:#75715e"># See Google IAM document overview</span>
<span style="color:#66d9ef">images</span>:
  -gcr.io/$PROJECT_ID/${_SERVICE_NAME}
</code></pre></div><h2 id="cloud-run">Cloud run</h2>
<p>The content of the image file to be deployed to Cloud run is generated by the docker file as shown below. The contents will be changed appropriately.</p>
<pre><code class="language-dockerfile:dockerfile" data-lang="dockerfile:dockerfile"># Use the official Python image.
# https://hub.docker.com/_/python
FROM python:3.7

# Copy local code to the container image.
ENV APP_HOME /app
WORKDIR $APP_HOME

# Install production dependencies.
COPY requirements.txt ./
COPY app.py ./
RUN pip install --no-cache-dir -r requirements.txt

# Service must listen to $PORT environment variable.
# This default value facilitates local development.
ENV PORT 8080

# Run the web service on container startup. Here we use the gunicorn
# webserver, with one worker process and 8 threads.
# For environments with multiple CPU cores, increase the number of workers
# to be equal to the cores available.
CMD exec gunicorn --bind :$PORT --workers 1 --threads 8 app:app
</code></pre><p>If you do so far, the rest will be deployed to &ldquo;Cloud run&rdquo; when you push it to the repository. In the Build state, you can check it on the Cloud console.</p>
<h1 id="front-end-side">Front-end side</h1>
<h2 id="firebasehosting">Firebase(hosting)</h2>
<p>This is the environment on the Front-end side, but the directory structure is not particularly described. Basically, Vue cli automatically creates a file. I have also written an article about Vue, but if you want to know it somehow, please refer to the following article.</p>
<ul>
<li>Treat Vue.js without thinking as much as possible: <a href="https://qiita.com/StrayDog/items/eceb96f14e5647428942">https://qiita.com/StrayDog/items/eceb96f14e5647428942</a></li>
</ul>
<h2 id="development-environment">Development environment</h2>
<p>Javascirpt framework is as follows.</p>
<ul>
<li>Vue.js</li>
<li>Bootstrap-vue</li>
</ul>
<p>I also checked React and Angular.js, but personally, Vue.js was the easiest to get to.</p>
<p>If you don&rsquo;t care much about the design, it is better to reduce the CSS description in Bootstrap.</p>
<h2 id="send-a-request-from-firebase-to-the-cloud-run-container">Send a request from Firebase to the Cloud run container</h2>
<p>Add &ldquo;rewrites&rdquo; to &ldquo;hosting&rdquo; of &ldquo;firebase.json&rdquo;. Requests can be made from &ldquo;projectID.web.app/&rdquo;, &ldquo;projectID.firebaseapp.com/&rdquo; and &ldquo;custom domain/&rdquo; (eg get). The project ID can be confirmed from the GCP project home screen.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json:firebase.json" data-lang="json:firebase.json"><span style="color:#e6db74">&#34;hosting&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> {
 <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">...</span>

 <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">Add</span> <span style="color:#960050;background-color:#1e0010">the</span> <span style="color:#f92672">&#34;rewrites&#34;</span> <span style="color:#960050;background-color:#1e0010">attribute</span> <span style="color:#960050;background-color:#1e0010">within</span> <span style="color:#e6db74">&#34;hosting&#34;</span>
 <span style="color:#e6db74">&#34;rewrites&#34;</span>: [{
   <span style="color:#f92672">&#34;source&#34;</span>: <span style="color:#e6db74">&#34;**&#34;</span>, <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">allow</span> <span style="color:#960050;background-color:#1e0010">all</span> <span style="color:#960050;background-color:#1e0010">client</span> <span style="color:#960050;background-color:#1e0010">side</span> <span style="color:#960050;background-color:#1e0010">requests</span>
   <span style="color:#f92672">&#34;run&#34;</span>: {
     <span style="color:#f92672">&#34;serviceId&#34;</span>: <span style="color:#e6db74">&#34;&lt;service name&gt;&#34;</span>, <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">service</span> <span style="color:#960050;background-color:#1e0010">name</span> <span style="color:#960050;background-color:#1e0010">(Cloud</span> <span style="color:#960050;background-color:#1e0010">run</span> <span style="color:#960050;background-color:#1e0010">container</span> <span style="color:#960050;background-color:#1e0010">name)</span>
     <span style="color:#f92672">&#34;region&#34;</span>: <span style="color:#e6db74">&#34;us-central1&#34;</span> <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">location</span> <span style="color:#960050;background-color:#1e0010">settings</span>
   }
 }]
}
</code></pre></div><p>#Reference</p>
<ul>
<li>Delivering dynamic content and hosting microservices using Cloud Run: <a href="https://firebase.google.com/docs/hosting/cloud-run?hl=ja#direct_requests_to_container">https://firebase.google.com/docs/hosting/cloud-run?hl=ja#direct_requests_to_container</a>-Configurehostingbehavior:<a href="https://firebase.google.com/docs/hosting/full-config#direct_requests_to_a_cloud_run_container">https://firebase.google.com/docs/hosting/full-config#direct_requests_to_a_cloud_run_container</a></li>
<li>Google IAM Document Summary: <a href="https://cloud.google.com/iam/docs/overview?hl=en#concepts_related_identity">https://cloud.google.com/iam/docs/overview?hl=en#concepts_related_identity</a></li>
<li>Super easy. Automatically deploy the Go app to GCP&rsquo;s serverless environment Cloud Run! : <a href="https://www.apps-gcp.com/deploy-go-app-to-cloud-run-by-cloud-build/">Https://www.apps-gcp.com/deploy-go-app-to-cloud-run-by-cloud-build/</a></li>
</ul>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
