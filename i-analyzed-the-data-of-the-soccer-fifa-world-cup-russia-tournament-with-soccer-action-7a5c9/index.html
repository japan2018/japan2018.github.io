<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] I analyzed the data of the soccer FIFA World Cup Russia tournament with soccer action | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] I analyzed the data of the soccer FIFA World Cup Russia tournament with soccer action</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 18, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/data-analysis"> data analysis</a></code></small>


<small><code><a href="https://memotut.com/tags/soccer"> soccer</a></code></small>


<small><code><a href="https://memotut.com/tags/kdd2019">kdd2019</a></code></small>


<small><code><a href="https://memotut.com/tags/socceraction">socceraction</a></code></small>

</p>
<pre><code>**This is the 18th day article of ADVENT CALENDER of NTT DOCOMO Service Innovation Department. **
</code></pre>
<p>Hello! This is Osugi from NTT DoCoMo.</p>
<p>I spent soccer and futsal when I was a student, and now I am doing marketing related data analysis.</p>
<p>Today, I&rsquo;d like to introduce socceraction, a python package for soccer, by analyzing the game data from the 2018 FIFA World Cup Russia tournament.</p>
<p>#Introduction
socceraction is featured in the KDD2019 Appried Data Sciense Track Best Paper Award <strong>”Actions Speak Louder than Goals: Valuing Player Actions in Soccer”</strong> [^1].</p>
<p>In this paper, we propose a new index to evaluate the behavior of soccer players during the game. Specifically, the contents are as follows.</p>
<ul>
<li>Definition of <strong>SPADL (Soccer Player Action Description Language)</strong> that represents the behavior of the player during the match</li>
<li>Definition of <strong>VAEP (Valuing Actions by Estimating Probabilities)</strong>, a framework for player evaluation</li>
<li>Prediction of score/goal probability during attack/defense</li>
<li>Results and consideration by analysis using data of major European leagues from 2012/2013 to 2017/2018</li>
</ul>
<p>And about the soccer action, you can do the following with this package.</p>
<ol>
<li><strong>Conversion of match data to SPADL</strong></li>
<li><strong>Calculation of success probability during attack/defense of each action</strong></li>
<li><strong>Calculation of VAEP using probability of success in each action</strong></li>
</ol>
<p>In other words, socceraction makes it easy to try the analytical methods described in the paper.
You can also perform a series of analysis by proceeding with reference to public-notebooks published on <a href="https://github.com/ML-KULeuven/socceraction">github</a>.
This time I would like to touch the data based on this public-notebook.</p>
<p>The code used in this article is posted at the end of this article, so I hope everyone can try it out.</p>
<p>Let&rsquo;s actually analyze with # soccer action
You can install socceraction with pip as follows.</p>
<pre><code>pip install socceraction
</code></pre><h2 id="1-download-the-data">1. Download the data</h2>
<ul>
<li>Reference
-<a href="https://github.com/ML-KULeuven/socceraction/blob/master/public-notebooks/1-download-statsbomb-data.ipynb">1-download-statsbomb-data.ipynb</a></li>
</ul>
<h3 id="11-about-the-data-used-this-time">1.1 About the data used this time</h3>
<p>In the paper, data from <a href="https://wyscout.com/">Wyscout</a>isused,butinpublic-notebookofsocceraction,dataacquisitionfrom<a href="https://statsbomb.com/">StatsBomb</a>Iamdoing.Withsocceraction,youcanalsoprocess<a href="https://www.optasports.com/">Opta</a> data into SPADL.</p>
<p>This time, I also use StatsBomb data.</p>
<p>[<img src="https://github.com/statsbomb/open-data/raw/master/stats-bomb-logo.png" alt="StatsBomb Logo">][https://github.com/statsbomb/open-data/blob/master/README.md)
[Image source]: https://github.com/statsbomb/open-data/blob/master/README.md</p>
<p>StatsBomb has released open data <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, and as of December 17, 2019, the following tournament data is open to the public.</p>
<ul>
<li>FIFA World Cup (2018)</li>
<li>Women&rsquo;s World Cup(2019)</li>
<li>La Liga (2004/2005~2015/2016)</li>
<li>NWSL (2018)</li>
<li>FA Women&rsquo;s Super League(2018/2019,2019/2020)</li>
</ul>
<p>If you look at this, you can see that there is a wealth of data for La Liga (Liga Espanola: Spain).
This time, we will use the data from the 2018 Russian World Cup, in which the Japanese national team also participated.</p>
<h3 id="12-how-to-get-data">1.2 How to get data</h3>
<p>A zip file as found in <a href="https://github.com/ML-KULeuven/socceraction/blob/master/public-notebooks/1-download-statsbomb-data.ipynb">1-download-statsbomb-data.ipynb</a> Data can be acquired by acquiring/decompressing.
This time, I also acquired it by referring to the above notebook in order to perform the conversion to SPADL and the calculation of VAEP accurately.</p>
<p>By the way, as another way to get StatsBomb data, there is a method to get it using python package called <a href="https://pypi.org/project/statsbomb/">statsbomb</a>.</p>
<p>You can actually get StatsBomb data with the code below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># https://pypi.org/project/statsbomb/</span>
<span style="color:#f92672">import</span> statsbomb <span style="color:#f92672">as</span> sb

<span style="color:#75715e"># Competitions</span>
comps <span style="color:#f92672">=</span> sb<span style="color:#f92672">.</span>Competitions()
comps_df <span style="color:#f92672">=</span> comps<span style="color:#f92672">.</span>get_dataframe() <span style="color:#75715e"># Tournament list</span>

<span style="color:#75715e"># Matches(FIFA World Cup :competition_id(event_id) = 43, session_id = 3)</span>
matches <span style="color:#f92672">=</span> sb<span style="color:#f92672">.</span>Matches(event_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;43&#39;</span>, season_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;3&#39;</span>)
matches_df <span style="color:#f92672">=</span> matches<span style="color:#f92672">.</span>get_dataframe() <span style="color:#75715e"># Match list</span>

<span style="color:#75715e"># Events(Japan VS Belgium: event_id = &#39;7584&#39;)</span>
The details of <span style="color:#75715e">#event_type are the following links</span>
<span style="color:#75715e"># https://github.com/imrankhan17/statsbomb-parser/blob/master/statsbomb/events.yaml</span>
events <span style="color:#f92672">=</span> sb<span style="color:#f92672">.</span>Events(event_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;7584&#39;</span>)
events<span style="color:#f92672">.</span>get_dataframe(event_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;substitution&#39;</span>) <span style="color:#75715e"># Data for player substitution</span>
</code></pre></div><h2 id="2-convert-the-data-to-spadl">2. Convert the data to SPADL</h2>
<ul>
<li>Reference
-<a href="https://github.com/ML-KULeuven/socceraction/blob/master/public-notebooks/2-convert-statsbomb-to-spadl.ipynb">2-convert-statsbomb-to-spadl.ipynb</a></li>
</ul>
<h3 id="21-spadl-format">2.1 SPADL format</h3>
<p>The format of SPADL (Soccer Player Action Description Language) is as follows.</p>
<ul>
<li><strong>StartTime</strong>: Start time of action</li>
<li><strong>EndTime</strong>: End time of the action</li>
<li><strong>StartLoc</strong>: Location information at the start of action</li>
<li><strong>EndLoc</strong>: Position information at the end of the action</li>
<li><strong>Player</strong>: The player who acted</li>
<li><strong>Team</strong>: Team to which the player belongs</li>
<li><strong>ActionType</strong>: Action type (21 types such as pass/shoot/dribble/intercept/slow-in)</li>
<li><strong>BodyPart</strong>: Body part used by the athlete during the action</li>
<li><strong>Result</strong>: Result of action (success or failure)</li>
</ul>
<p>In the reference notebook, the code to change the StatsBomb data into the above SPADL format is written, and you can easily convert it to SPADL by referring to this code.
Here, the procedure is as follows.</p>
<ol>
<li>Convert StatsBomb JSON to HDF5 format file with <code>socceraction.spadl.api.statsbombjson_to_statsbombh5(statsbomb_json,statsbomb_h5)</code></li>
<li>Convert the StatsBomb file to SPADL format with <code>statsbombh5_to_spadlh5(statsbomb_h5,spadl_h5)</code>.</li>
</ol>
<p>Also, by using <code>matplotsoccer.actions</code> of the python package called <strong>matplotsoccer</strong>, you can plot the data in SPADL format as follows.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/525981/85f76def-aa61-4db6-c514-dac8cee2b747.png" alt="image.png"></p>
<p>Here, I tried plotting a scene [^9] between Japan and Belgium that would be very impressive to all Japanese soccer fans.
I think it&rsquo;s easy to see in the figure and table who plays what and when.</p>
<h2 id="3-model-based-prediction-of-probabilities">3. Model-based prediction of probabilities</h2>
<ul>
<li>Reference
-<a href="https://github.com/ML-KULeuven/socceraction/blob/master/public-notebooks/3-compute-features-and-labels.ipynb">3-compute-features-and-labels.ipynb</a>
-<a href="https://github.com/ML-KULeuven/socceraction/blob/master/public-notebooks/4-estimate-scoring-and-conceding-probabilities.ipynb">4-estimate-scoring-and-conceding-probabilities.ipynb</a></li>
</ul>
<h3 id="31-creating-a-prediction-modelnext-create-a-feature-amount-based-on-spadl-and-calculate-the-scoregoal-probabilities-in-attackdefense">3.1 Creating a prediction modelNext, create a feature amount based on SPADL and calculate the score/goal probabilities in attack/defense.</h3>
<p>This time, I tried to create a predictive model by including the previous play in the feature quantity.
The features used are as follows. There are two types, the latest play and the previous play.</p>
<ul>
<li>actiontype(onehot)</li>
<li>bodypart(onehot)</li>
<li>result</li>
<li>goalscore</li>
<li>startlocation</li>
<li>endlocation</li>
<li>movement</li>
<li>space_delta</li>
<li>startpolar</li>
<li>endpolar</li>
<li>team</li>
<li>time_delta</li>
</ul>
<p>This feature and the objective variable can be derived by using <code>socceraction.classification.features</code> and <code>socceraction.classification.labels</code>.</p>
<p>Prediction accuracy was confirmed by executing a prediction model with xgboost using these features.
Then, the prediction accuracy of the prediction model created this time is as follows.</p>
<table>
<thead>
<tr>
<th></th>
<th>Scores</th>
<th>Concedes</th>
</tr>
</thead>
<tbody>
<tr>
<td>brier_score_loss</td>
<td>0.0092</td>
<td>0.0025</td>
</tr>
<tr>
<td>AUC</td>
<td>0.8512</td>
<td>0.8865</td>
</tr>
</tbody>
</table>
<h3 id="32-confirmation-of-important-features-by-shap">3.2 Confirmation of important features by SHAP</h3>
<p>Also, using <a href="https://github.com/slundberg/shap">SHAP</a>[^5][^6], we confirmed how the features contribute to the prediction model.
Let&rsquo;s look at the features that contribute to the score probability with summary_plot.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/525981/a3e0111a-0f17-b6c2-53ac-b26d32f2d47d.png" alt="image.png"></p>
<p>SHAP allows you to visually check how the feature amount affects the objective variable.</p>
<p>You can also take a closer look at each variable if you find one that interests you.
The dependency_plot below looks at how the distance to the goal during action contributes to the score probability.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/525981/2cb39d9d-6384-0e7c-75a8-5a8971cf88c8.png" alt="image.png">
Since the horizontal axis is the distance from the goal when the action is completed and the vertical axis is the SHAP value, here it can be seen that the shorter the distance after the action, the higher the score probability.</p>
<h2 id="4-calculation-of-vaep">4. Calculation of VAEP</h2>
<p>VAEP (Valuing Actions by Estimating Probabilities) will be calculated based on the score probabilities/goals probabilities by the prediction model calculated in 3.
The VAEP for team $x$ in action $a_i$ is calculated as follows:</p>
<pre><code class="language-math" data-lang="math">V(a_i,x) = \Delta P_{scores}(a_i,x) + (- \Delta P_{concedes}(a_i,x))
</code></pre><p>At this time,
$\Delta P_{scores}(a_i,x)$ means the increase in the score probability due to the action, and $\Delta P_{concedes}(a_i,x)$ means the increase in the probability of the goal due to the action. I will.</p>
<p>In other words, VAEP is higher in the case of actions that ① increase the score probability and ② decrease the goal probability.</p>
<p>Actually calculate VAEP using soccer action.
Here, it can be calculated by using <code>socceraction.vaep.value()</code>.
As a result of arranging the VAEPs in descending order, the results are as follows.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/525981/c5edab83-fa91-6949-93dd-c1401b6850fe.png" alt="image.png"></p>
<p>The winning French national team Mbappé player has the highest VAEP total.</p>
<p>I tried to put out the total of VAEP above, but the play time is not considered in this result alone.
Therefore, as is done in the paper, we average the play times to calculate the VAEP per 90 minutes.
Also, as a condition, we are narrowing down to players who participated for 180 minutes or more.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/525981/aa090b2b-6541-1b39-10cd-554d51c931dc.png" alt="image.png"></p>
<p>Looking at VAEP around 90 minutes, Russian national team player Dennis Cheryshev took first place.
Cheryshev played an active part in deciding 4 points in 5 games, but he often participated in the game and changed his career.
By looking at the VAEP per 90 minutes, it is thought that the rank has risen to 1st place.
Another interesting result was that Toni Klaus, the German national team player who had been eliminated from the group league at this tournament, is ranked higher.</p>
<p>In addition to this, by issuing the average VAEP per play, it may be possible to extract players who do a good job but have few plays.</p>
<h2 id="5-visualization-of-results-for-each-scene">5. Visualization of results for each scene</h2>
<p>I will add the calculated VAEP to the plot by matplotsoccer that I introduced earlier.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/525981/50ad364a-6790-0ff3-417b-84a3a9f8c165.png" alt="image.png">
This allows you to quantify and evaluate the behavior of each player in the target scene.
Looking at this diagram, De Bruyne&rsquo;s pass is most highly evaluated except for shooting and assisting.</p>
<p>#Summary
This time, I introduced socceraction using actual data from the Soccer World Cup Russia tournament held in 2018.
To be frank, I found it very convenient to be able to convert multiple data sources such as StatsBomb and Wyscout to SPADL.
Also, I felt that the data of StatsBomb is very detailed and that various analyzes can be performed by using it. (Thanks for being available for free&hellip;)
As for public-notebook in github of soccer action, data processing etc. in HDF5 format are done, and I don&rsquo;t use it so much so I learned it.
And above all, I find it really interesting to be able to analyze real game data in this way!
If you&rsquo;re interested in sports and soccer analysis, like me, I highly recommend socceraction.</p>
<p>#Reference: Code used this time</p>
<h2 id="1-data-acquisition--visualization-of-score-scene">1. Data acquisition &amp; visualization of score scene</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ----</span>
<span style="color:#75715e"># Referenced public-notebook MIT license</span>
<span style="color:#75715e"># (c) 2019 KU Leuven Machine Learning Research Group</span>
<span style="color:#75715e"># Released under the MIT license.</span>
<span style="color:#75715e"># see https://github.com/ML-KULeuven/socceraction/blob/master/LICENSE</span>
<span style="color:#75715e"># ----</span>

<span style="color:#75715e"># package</span>
<span style="color:#f92672">%</span>load_ext autoreload
<span style="color:#f92672">%</span>autoreload <span style="color:#ae81ff">2</span>
<span style="color:#f92672">import</span> os; <span style="color:#f92672">import</span> sys;
<span style="color:#f92672">import</span> tqdm
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> math
<span style="color:#f92672">import</span> zipfile
<span style="color:#f92672">import</span> warnings
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
warnings<span style="color:#f92672">.</span>simplefilter(action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ignore&#39;</span>, category<span style="color:#f92672">=</span>pd<span style="color:#f92672">.</span>errors<span style="color:#f92672">.</span>PerformanceWarning)
<span style="color:#f92672">import</span> socceraction.spadl.api <span style="color:#f92672">as</span> spadl
<span style="color:#f92672">import</span> matplotsoccer
<span style="color:#f92672">import</span> matplotlib

<span style="color:#75715e">#Specify folder name/file name</span>
datafolder <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hogehoge&#34;</span> <span style="color:#75715e"># specify folder name</span>
statsbombzip <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datafolder, <span style="color:#e6db74">&#34;open-data-master.zip&#34;</span>)
statsbombroot <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datafolder, <span style="color:#e6db74">&#34;statsbomb-root&#34;</span>)
statsbombdata <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datafolder, <span style="color:#e6db74">&#34;statsbomb-root&#34;</span>, <span style="color:#e6db74">&#34;open-data-master&#34;</span>, <span style="color:#e6db74">&#34;data&#34;</span>)
<span style="color:#75715e"># Extract zip file</span>
<span style="color:#66d9ef">with</span> zipfile<span style="color:#f92672">.</span>ZipFile(statsbombzip,<span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> zipObj:
    zipObj<span style="color:#f92672">.</span>extractall(statsbombroot)

Convert <span style="color:#75715e">#StatsBomb(json) data to SPADL(HDF5)</span>
<span style="color:#75715e">## StatsBomb(Raw Data): json -&gt; StatsBomb(Raw Data): h5</span>
statsbomb_json <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datafolder,<span style="color:#e6db74">&#34;statsbomb-root&#34;</span>,<span style="color:#e6db74">&#34;open-data-master&#34;</span>,<span style="color:#e6db74">&#34;data&#34;</span>)
statsbomb_h5 <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datafolder,<span style="color:#e6db74">&#34;statsbomb.h5&#34;</span>)
spadl_h5 <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datafolder,<span style="color:#e6db74">&#34;spadl-statsbomb.h5&#34;</span>)
spadl<span style="color:#f92672">.</span>statsbombjson_to_statsbombh5(statsbomb_json,statsbomb_h5)
tablenames <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;matches&#34;</span>,<span style="color:#e6db74">&#34;players&#34;</span>,<span style="color:#e6db74">&#34;teams&#34;</span>,<span style="color:#e6db74">&#34;competitions&#34;</span>]
tables <span style="color:#f92672">=</span> {name :pd<span style="color:#f92672">.</span>read_hdf(statsbomb_h5,key<span style="color:#f92672">=</span>name) <span style="color:#66d9ef">for</span> name <span style="color:#f92672">in</span> tablenames}
match_id <span style="color:#f92672">=</span> tables[<span style="color:#e6db74">&#34;matches&#34;</span>]<span style="color:#f92672">.</span>match_id[<span style="color:#ae81ff">0</span>]tables[<span style="color:#e6db74">&#34;events&#34;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(statsbomb_h5,f<span style="color:#e6db74">&#34;events/match_{match_id}&#34;</span>)
<span style="color:#66d9ef">for</span> k,df <span style="color:#f92672">in</span> tables<span style="color:#f92672">.</span>items():
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;#&#34;</span>,k)
    <span style="color:#66d9ef">print</span>(df<span style="color:#f92672">.</span>columns,<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
<span style="color:#75715e">## StatsBomb(Raw Data) : h5 -&gt; SPADL : h5</span>
spadl<span style="color:#f92672">.</span>statsbombh5_to_spadlh5(statsbomb_h5,spadl_h5)
tablenames <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;games&#34;</span>,<span style="color:#e6db74">&#34;players&#34;</span>,<span style="color:#e6db74">&#34;teams&#34;</span>,<span style="color:#e6db74">&#34;competitions&#34;</span>,<span style="color:#e6db74">&#34;actiontypes&#34;</span>,<span style="color:#e6db74">&#34;bodyparts&#34;</span>,<span style="color:#e6db74">&#34;results&#34;</span>]
tables <span style="color:#f92672">=</span> {name : pd<span style="color:#f92672">.</span>read_hdf(spadl_h5,key<span style="color:#f92672">=</span>name) <span style="color:#66d9ef">for</span> name <span style="color:#f92672">in</span> tablenames}
game_id <span style="color:#f92672">=</span> tables[<span style="color:#e6db74">&#34;games&#34;</span>]<span style="color:#f92672">.</span>game_id[<span style="color:#ae81ff">0</span>]
tables[<span style="color:#e6db74">&#34;actions&#34;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5,f<span style="color:#e6db74">&#34;actions/game_{game_id}&#34;</span>)
<span style="color:#66d9ef">for</span> k,df <span style="color:#f92672">in</span> tables<span style="color:#f92672">.</span>items():
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;#&#34;</span>,k)
    <span style="color:#66d9ef">print</span>(df<span style="color:#f92672">.</span>columns,<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)

<span style="color:#75715e"># FIFA W杯:日本対ベルギーの試合を可視化</span>

<span style="color:#75715e">## game_idの抽出</span>
tablenames <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;games&#34;</span>,<span style="color:#e6db74">&#34;players&#34;</span>,<span style="color:#e6db74">&#34;teams&#34;</span>,<span style="color:#e6db74">&#34;competitions&#34;</span>,<span style="color:#e6db74">&#34;actiontypes&#34;</span>,<span style="color:#e6db74">&#34;bodyparts&#34;</span>,<span style="color:#e6db74">&#34;results&#34;</span>]
tables <span style="color:#f92672">=</span> {name: pd<span style="color:#f92672">.</span>read_hdf(spadl_h5, key<span style="color:#f92672">=</span>name) <span style="color:#66d9ef">for</span> name <span style="color:#f92672">in</span> tablenames}
games <span style="color:#f92672">=</span> tables[<span style="color:#e6db74">&#34;games&#34;</span>]<span style="color:#f92672">.</span>merge(tables[<span style="color:#e6db74">&#34;competitions&#34;</span>])
game_id <span style="color:#f92672">=</span> games[(games<span style="color:#f92672">.</span>competition_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;FIFA World Cup&#34;</span>) 
              <span style="color:#f92672">&amp;</span> (games<span style="color:#f92672">.</span>away_team_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Japan&#34;</span>)
              <span style="color:#f92672">&amp;</span> (games<span style="color:#f92672">.</span>home_team_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Belgium&#34;</span>)]<span style="color:#f92672">.</span>game_id<span style="color:#f92672">.</span>values[<span style="color:#ae81ff">0</span>]
game_id <span style="color:#75715e"># 7584</span>

<span style="color:#75715e">## 得点に関係するaction_idの抽出</span>
actions <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5, f<span style="color:#e6db74">&#34;actions/game_{game_id}&#34;</span>)
actions <span style="color:#f92672">=</span> (
    actions<span style="color:#f92672">.</span>merge(tables[<span style="color:#e6db74">&#34;actiontypes&#34;</span>])
    <span style="color:#f92672">.</span>merge(tables[<span style="color:#e6db74">&#34;results&#34;</span>])
    <span style="color:#f92672">.</span>merge(tables[<span style="color:#e6db74">&#34;bodyparts&#34;</span>])
    <span style="color:#f92672">.</span>merge(tables[<span style="color:#e6db74">&#34;players&#34;</span>],<span style="color:#e6db74">&#34;left&#34;</span>,on<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;player_id&#34;</span>)
    <span style="color:#f92672">.</span>merge(tables[<span style="color:#e6db74">&#34;teams&#34;</span>],<span style="color:#e6db74">&#34;left&#34;</span>,on<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;team_id&#34;</span>)
    <span style="color:#f92672">.</span>sort_values([<span style="color:#e6db74">&#34;period_id&#34;</span>, <span style="color:#e6db74">&#34;time_seconds&#34;</span>, <span style="color:#e6db74">&#34;timestamp&#34;</span>])
    <span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span>True))
actions[<span style="color:#e6db74">&#34;player&#34;</span>] <span style="color:#f92672">=</span> actions[[<span style="color:#e6db74">&#34;player_nickname&#34;</span>,
                             <span style="color:#e6db74">&#34;player_name&#34;</span>]]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: x[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">if</span> x[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">else</span> x[<span style="color:#ae81ff">1</span>],axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
list(actions[(actions<span style="color:#f92672">.</span>type_name<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;shot&#39;</span>)<span style="color:#f92672">&amp;</span>(actions<span style="color:#f92672">.</span>result_name<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;success&#39;</span>)]<span style="color:#f92672">.</span>index)
<span style="color:#75715e"># [1215, 1334, 1658, 1742, 2153]</span>

<span style="color:#75715e">## ベルギー3点目</span>
shot <span style="color:#f92672">=</span> <span style="color:#ae81ff">2153</span>
a <span style="color:#f92672">=</span> actions[shot<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>:shot<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]
games <span style="color:#f92672">=</span> tables[<span style="color:#e6db74">&#34;games&#34;</span>]
g <span style="color:#f92672">=</span> list(games[games<span style="color:#f92672">.</span>game_id <span style="color:#f92672">==</span> a<span style="color:#f92672">.</span>game_id<span style="color:#f92672">.</span>values[<span style="color:#ae81ff">0</span>]]<span style="color:#f92672">.</span>itertuples())[<span style="color:#ae81ff">0</span>]
minute <span style="color:#f92672">=</span> int((a<span style="color:#f92672">.</span>period_id<span style="color:#f92672">.</span>values[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">45</span> <span style="color:#f92672">+</span>a<span style="color:#f92672">.</span>time_seconds<span style="color:#f92672">.</span>values[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">//</span> <span style="color:#ae81ff">60</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
game_info <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#34;{g.match_date} {g.home_team_name} {g.home_score}-{g.away_score} {g.away_team_name} {minute}&#39;&#34;</span>
<span style="color:#66d9ef">print</span>(game_info)
labels <span style="color:#f92672">=</span> a[[<span style="color:#e6db74">&#34;time_seconds&#34;</span>, <span style="color:#e6db74">&#34;type_name&#34;</span>, <span style="color:#e6db74">&#34;player&#34;</span>, <span style="color:#e6db74">&#34;team_name&#34;</span>]]
matplotsoccer<span style="color:#f92672">.</span>actions(
    location<span style="color:#f92672">=</span>a[[<span style="color:#e6db74">&#34;start_x&#34;</span>, <span style="color:#e6db74">&#34;start_y&#34;</span>, <span style="color:#e6db74">&#34;end_x&#34;</span>, <span style="color:#e6db74">&#34;end_y&#34;</span>]],
    action_type<span style="color:#f92672">=</span>a<span style="color:#f92672">.</span>type_name,
    team<span style="color:#f92672">=</span> a<span style="color:#f92672">.</span>team_name,
    result<span style="color:#f92672">=</span> a<span style="color:#f92672">.</span>result_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;success&#34;</span>,
    label<span style="color:#f92672">=</span>labels,
    labeltitle<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;time&#34;</span>,<span style="color:#e6db74">&#34;actiontype&#34;</span>,<span style="color:#e6db74">&#34;player&#34;</span>,<span style="color:#e6db74">&#34;team&#34;</span>],
    zoom<span style="color:#f92672">=</span>False,
    figsize<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>)
</code></pre></div><h2 id="2特徴量の作成予測モデル作成shap算出">2.特徴量の作成,予測モデル作成,SHAP算出</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ----</span>
<span style="color:#75715e"># 参考にしたpublic-notebookのMIT license</span>
<span style="color:#75715e"># (c) 2019 KU Leuven Machine Learning Research Group</span>
<span style="color:#75715e"># Released under the MIT license.</span>
<span style="color:#75715e"># see https://github.com/ML-KULeuven/socceraction/blob/master/LICENSE</span>
<span style="color:#75715e"># ----</span>

<span style="color:#75715e"># package</span>
<span style="color:#f92672">%</span>load_ext autoreload
<span style="color:#f92672">%</span>autoreload <span style="color:#ae81ff">2</span>
<span style="color:#f92672">import</span> os; <span style="color:#f92672">import</span> sys; sys<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>insert(<span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#39;hogehoge&#39;</span>)<span style="color:#75715e">#フォルダ名</span>
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">import</span> tqdm
<span style="color:#f92672">import</span> warnings
warnings<span style="color:#f92672">.</span>simplefilter(action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ignore&#39;</span>, category<span style="color:#f92672">=</span>pd<span style="color:#f92672">.</span>errors<span style="color:#f92672">.</span>PerformanceWarning)
<span style="color:#f92672">import</span> socceraction.classification.features <span style="color:#f92672">as</span> fs
<span style="color:#f92672">import</span> socceraction.classification.labels <span style="color:#f92672">as</span> lab
<span style="color:#f92672">import</span> xgboost
<span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> roc_auc_score,brier_score_loss
<span style="color:#f92672">import</span> shap
shap<span style="color:#f92672">.</span>initjs()

<span style="color:#75715e"># ファイル名とフォルダ名の定義</span>
datafolder <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hogehoge&#34;</span> <span style="color:#75715e">#フォルダ名を指定</span>
spadl_h5 <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datafolder,<span style="color:#e6db74">&#34;spadl-statsbomb.h5&#34;</span>)
features_h5 <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datafolder,<span style="color:#e6db74">&#34;features.h5&#34;</span>)
labels_h5 <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datafolder,<span style="color:#e6db74">&#34;labels.h5&#34;</span>)
predictions_h5 <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datafolder,<span style="color:#e6db74">&#34;predictions.h5&#34;</span>)

<span style="color:#75715e"># データ読込 </span>
games <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5,<span style="color:#e6db74">&#34;games&#34;</span>)
games <span style="color:#f92672">=</span> games[games<span style="color:#f92672">.</span>competition_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;FIFA World Cup&#34;</span>]
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;nb of games:&#34;</span>, len(games))

actiontypes <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5, <span style="color:#e6db74">&#34;actiontypes&#34;</span>)
bodyparts <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5, <span style="color:#e6db74">&#34;bodyparts&#34;</span>)
results <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5, <span style="color:#e6db74">&#34;results&#34;</span>)

<span style="color:#75715e"># ラベルの作成</span>
yfns <span style="color:#f92672">=</span> [lab<span style="color:#f92672">.</span>scores,lab<span style="color:#f92672">.</span>concedes,lab<span style="color:#f92672">.</span>goal_from_shot]
<span style="color:#66d9ef">for</span> game <span style="color:#f92672">in</span> tqdm<span style="color:#f92672">.</span>tqdm(list(games<span style="color:#f92672">.</span>itertuples()),
                      desc<span style="color:#f92672">=</span>f<span style="color:#e6db74">&#34;Computing and storing labels in {labels_h5}&#34;</span>):
    actions <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5,f<span style="color:#e6db74">&#34;actions/game_{game.game_id}&#34;</span>)
    actions <span style="color:#f92672">=</span> (
        actions<span style="color:#f92672">.</span>merge(actiontypes,how<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;left&#34;</span>)
        <span style="color:#f92672">.</span>merge(results,how<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;left&#34;</span>)
        <span style="color:#f92672">.</span>merge(bodyparts,how<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;left&#34;</span>)
        <span style="color:#f92672">.</span>sort_values([<span style="color:#e6db74">&#34;period_id&#34;</span>, <span style="color:#e6db74">&#34;time_seconds&#34;</span>, <span style="color:#e6db74">&#34;timestamp&#34;</span>,<span style="color:#e6db74">&#39;action_id&#39;</span>])
        <span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span>True))
    Y <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([fn(actions) <span style="color:#66d9ef">for</span> fn <span style="color:#f92672">in</span> yfns],axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
    Y<span style="color:#f92672">.</span>to_hdf(labels_h5,f<span style="color:#e6db74">&#34;game_{game.game_id}&#34;</span>)

<span style="color:#75715e"># 特徴量の作成</span>

xfns <span style="color:#f92672">=</span> [fs<span style="color:#f92672">.</span>actiontype,
       fs<span style="color:#f92672">.</span>actiontype_onehot,
       fs<span style="color:#f92672">.</span>bodypart,
       fs<span style="color:#f92672">.</span>bodypart_onehot,
       fs<span style="color:#f92672">.</span>result,
       fs<span style="color:#f92672">.</span>result_onehot,
       fs<span style="color:#f92672">.</span>goalscore,
       fs<span style="color:#f92672">.</span>startlocation,
       fs<span style="color:#f92672">.</span>endlocation,
       fs<span style="color:#f92672">.</span>movement,
       fs<span style="color:#f92672">.</span>space_delta,
       fs<span style="color:#f92672">.</span>startpolar,
       fs<span style="color:#f92672">.</span>endpolar,
       fs<span style="color:#f92672">.</span>team,
       fs<span style="color:#f92672">.</span>time,
       fs<span style="color:#f92672">.</span>time_delta]

<span style="color:#66d9ef">for</span> game <span style="color:#f92672">in</span> tqdm<span style="color:#f92672">.</span>tqdm(list(games<span style="color:#f92672">.</span>itertuples()),
                      desc<span style="color:#f92672">=</span>f<span style="color:#e6db74">&#34;Generating and storing features in {features_h5}&#34;</span>):
    actions <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5,f<span style="color:#e6db74">&#34;actions/game_{game.game_id}&#34;</span>)
    actions <span style="color:#f92672">=</span> (
        actions<span style="color:#f92672">.</span>merge(actiontypes,how<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;left&#34;</span>)
        <span style="color:#f92672">.</span>merge(results,how<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;left&#34;</span>)
        <span style="color:#f92672">.</span>merge(bodyparts,how<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;left&#34;</span>)
        <span style="color:#f92672">.</span>sort_values([<span style="color:#e6db74">&#34;period_id&#34;</span>, <span style="color:#e6db74">&#34;time_seconds&#34;</span>, <span style="color:#e6db74">&#34;timestamp&#34;</span>,<span style="color:#e6db74">&#39;action_id&#39;</span>])<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span>True))
    gamestates <span style="color:#f92672">=</span> fs<span style="color:#f92672">.</span>gamestates(actions,<span style="color:#ae81ff">2</span>)
    gamestates <span style="color:#f92672">=</span> fs<span style="color:#f92672">.</span>play_left_to_right(gamestates,game<span style="color:#f92672">.</span>home_team_id)
    
    X <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([fn(gamestates) <span style="color:#66d9ef">for</span> fn <span style="color:#f92672">in</span> xfns],axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
    X<span style="color:#f92672">.</span>to_hdf(features_h5,f<span style="color:#e6db74">&#34;game_{game.game_id}&#34;</span>)

xfns <span style="color:#f92672">=</span> [fs<span style="color:#f92672">.</span>actiontype_onehot,
       fs<span style="color:#f92672">.</span>bodypart_onehot,
       fs<span style="color:#f92672">.</span>result,
       fs<span style="color:#f92672">.</span>goalscore,
       fs<span style="color:#f92672">.</span>startlocation,
       fs<span style="color:#f92672">.</span>endlocation,
       fs<span style="color:#f92672">.</span>movement,
       fs<span style="color:#f92672">.</span>space_delta,
       fs<span style="color:#f92672">.</span>startpolar,
       fs<span style="color:#f92672">.</span>endpolar,
       fs<span style="color:#f92672">.</span>team,
       fs<span style="color:#f92672">.</span>time_delta]
nb_prev_actions <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>

Xcols <span style="color:#f92672">=</span> fs<span style="color:#f92672">.</span>feature_column_names(xfns,nb_prev_actions)
X <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span> game_id <span style="color:#f92672">in</span> tqdm<span style="color:#f92672">.</span>tqdm(games<span style="color:#f92672">.</span>game_id,desc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;selecting features&#34;</span>):
    Xi <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(features_h5,f<span style="color:#e6db74">&#34;game_{game_id}&#34;</span>)
    X<span style="color:#f92672">.</span>append(Xi[Xcols])
X <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat(X)

Ycols <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;scores&#34;</span>,<span style="color:#e6db74">&#34;concedes&#34;</span>]
Y <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span> game_id <span style="color:#f92672">in</span> tqdm<span style="color:#f92672">.</span>tqdm(games<span style="color:#f92672">.</span>game_id,desc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;selecting label&#34;</span>):
    Yi <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(labels_h5,f<span style="color:#e6db74">&#34;game_{game_id}&#34;</span>)
    Y<span style="color:#f92672">.</span>append(Yi[Ycols])
Y <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat(Y)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;X:&#34;</span>, list(X<span style="color:#f92672">.</span>columns))
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Y:&#34;</span>, list(Y<span style="color:#f92672">.</span>columns))

<span style="color:#75715e"># xgboostによる予測モデル構築</span>

<span style="color:#f92672">%%</span>time
<span style="color:#75715e"># scores</span>
model_scores <span style="color:#f92672">=</span> xgboost<span style="color:#f92672">.</span>XGBClassifier()
model_scores<span style="color:#f92672">.</span>fit(X,Y[<span style="color:#e6db74">&#39;scores&#39;</span>])
<span style="color:#75715e"># concedes</span>
model_concedes <span style="color:#f92672">=</span> xgboost<span style="color:#f92672">.</span>XGBClassifier()
model_concedes<span style="color:#f92672">.</span>fit(X,Y[<span style="color:#e6db74">&#39;concedes&#39;</span>])

Y_hat <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
Y_hat[<span style="color:#e6db74">&#39;scores&#39;</span>] <span style="color:#f92672">=</span> model_scores<span style="color:#f92672">.</span>predict_proba(X)[:,<span style="color:#ae81ff">1</span>]
Y_hat[<span style="color:#e6db74">&#39;concedes&#39;</span>] <span style="color:#f92672">=</span> model_concedes<span style="color:#f92672">.</span>predict_proba(X)[:,<span style="color:#ae81ff">1</span>]

<span style="color:#75715e"># 予測精度</span>
<span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;scores_brier : </span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">{brier_score_loss(Y[&#39;scores&#39;],Y_hat[&#39;scores&#39;]).round(4)}&#34;</span>)
<span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;concedes_brier : </span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">{brier_score_loss(Y[&#39;concedes&#39;],Y_hat[&#39;concedes&#39;]).round(4)}&#34;</span>)

<span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;scores_auc : </span><span style="color:#ae81ff">\t\t</span><span style="color:#e6db74">{roc_auc_score(Y[&#39;scores&#39;],Y_hat[&#39;scores&#39;]).round(4)}&#34;</span>)
<span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;concedes_auc : </span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">{roc_auc_score(Y[&#39;concedes&#39;],Y_hat[&#39;concedes&#39;]).round(4)}&#34;</span>)

<span style="color:#75715e"># SHAPを用いた予兆要因の特定(scores)</span>
explainer_scores <span style="color:#f92672">=</span> shap<span style="color:#f92672">.</span>TreeExplainer(model_scores)
shap_scores <span style="color:#f92672">=</span> explainer_scores<span style="color:#f92672">.</span>shap_values(X)
<span style="color:#75715e">## summary_plot</span>
shap<span style="color:#f92672">.</span>summary_plot(shap_scores,features<span style="color:#f92672">=</span>X,feature_names<span style="color:#f92672">=</span>X<span style="color:#f92672">.</span>columns)
<span style="color:#75715e">## dependence_plot</span>
shap<span style="color:#f92672">.</span>dependence_plot(<span style="color:#e6db74">&#39;end_dist_to_goal_a0&#39;</span>,
                     shap_scores,
                     features<span style="color:#f92672">=</span>X,
                     feature_names<span style="color:#f92672">=</span>X<span style="color:#f92672">.</span>columns,
                     interaction_index<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;end_dist_to_goal_a0&#39;</span>)

<span style="color:#75715e"># 予測結果の保存</span>
A <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span> game_id <span style="color:#f92672">in</span> tqdm<span style="color:#f92672">.</span>tqdm(games<span style="color:#f92672">.</span>game_id,<span style="color:#e6db74">&#34;loading game ids&#34;</span>):
    Ai <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5,f<span style="color:#e6db74">&#34;actions/game_{game_id}&#34;</span>)
    A<span style="color:#f92672">.</span>append(Ai[[<span style="color:#e6db74">&#34;game_id&#34;</span>]])
A <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat(A)
A <span style="color:#f92672">=</span> A<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span>True)

grouped_predictions <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([A,Y_hat],axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#34;game_id&#34;</span>)
<span style="color:#66d9ef">for</span> k,df <span style="color:#f92672">in</span> tqdm<span style="color:#f92672">.</span>tqdm(grouped_predictions,desc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;saving predictions per game&#34;</span>):
    df <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span>True)
    df[Y_hat<span style="color:#f92672">.</span>columns]<span style="color:#f92672">.</span>to_hdf(predictions_h5,f<span style="color:#e6db74">&#34;game_{int(k)}&#34;</span>)
</code></pre></div><h2 id="3vaepの算出">3.VAEPの算出</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># ----</span>
<span style="color:#75715e"># 参考にしたpublic-notebookのMIT license</span>
<span style="color:#75715e"># (c) 2019 KU Leuven Machine Learning Research Group</span>
<span style="color:#75715e"># Released under the MIT license.</span>
<span style="color:#75715e"># see https://github.com/ML-KULeuven/socceraction/blob/master/LICENSE</span>
<span style="color:#75715e"># ----</span>

<span style="color:#75715e"># package</span>
<span style="color:#f92672">%</span>load_ext autoreload
<span style="color:#f92672">%</span>autoreload <span style="color:#ae81ff">2</span>
<span style="color:#f92672">import</span> os; <span style="color:#f92672">import</span> sys; sys<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>insert(<span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#39;hogehoge&#39;</span>) <span style="color:#75715e">#フォルダ名</span>
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">import</span> tqdm
<span style="color:#f92672">import</span> warnings
warnings<span style="color:#f92672">.</span>simplefilter(action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ignore&#39;</span>, category<span style="color:#f92672">=</span>pd<span style="color:#f92672">.</span>errors<span style="color:#f92672">.</span>PerformanceWarning)
<span style="color:#f92672">import</span> socceraction.vaep <span style="color:#f92672">as</span> vaep
<span style="color:#f92672">import</span> matplotsoccer
<span style="color:#f92672">import</span> matplotlib

<span style="color:#75715e"># ファイル名とフォルダ名の定義</span>
datafolder <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hogehoge&#34;</span> <span style="color:#75715e">#フォルダ名</span>
spadl_h5 <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datafolder,<span style="color:#e6db74">&#34;spadl-statsbomb.h5&#34;</span>)
predictions_h5 <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datafolder,<span style="color:#e6db74">&#34;predictions.h5&#34;</span>)

<span style="color:#75715e"># データの取得</span>
games <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5,<span style="color:#e6db74">&#34;games&#34;</span>)
games <span style="color:#f92672">=</span> games[games<span style="color:#f92672">.</span>competition_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;FIFA World Cup&#34;</span>]
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;nb of games:&#34;</span>, len(games))

players <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5,<span style="color:#e6db74">&#34;players&#34;</span>)
teams <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5,<span style="color:#e6db74">&#34;teams&#34;</span>)
actiontypes <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5, <span style="color:#e6db74">&#34;actiontypes&#34;</span>)
bodyparts <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5, <span style="color:#e6db74">&#34;bodyparts&#34;</span>)
results <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5, <span style="color:#e6db74">&#34;results&#34;</span>)

<span style="color:#75715e"># VAEPの算出</span>
A <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span> game <span style="color:#f92672">in</span> tqdm<span style="color:#f92672">.</span>tqdm(list(games<span style="color:#f92672">.</span>itertuples())):
    actions <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5,f<span style="color:#e6db74">&#34;actions/game_{game.game_id}&#34;</span>)
    actions <span style="color:#f92672">=</span> (
        actions<span style="color:#f92672">.</span>merge(actiontypes)
        <span style="color:#f92672">.</span>merge(results)
        <span style="color:#f92672">.</span>merge(bodyparts)
        <span style="color:#f92672">.</span>merge(players,<span style="color:#e6db74">&#34;left&#34;</span>,on<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;player_id&#34;</span>)
        <span style="color:#f92672">.</span>merge(teams,<span style="color:#e6db74">&#34;left&#34;</span>,on<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;team_id&#34;</span>)
        <span style="color:#f92672">.</span>sort_values([<span style="color:#e6db74">&#34;period_id&#34;</span>, <span style="color:#e6db74">&#34;time_seconds&#34;</span>, <span style="color:#e6db74">&#34;timestamp&#34;</span>])
        <span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span>True)
    )
    preds <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(predictions_h5,f<span style="color:#e6db74">&#34;game_{game.game_id}&#34;</span>)
    values <span style="color:#f92672">=</span> vaep<span style="color:#f92672">.</span>value(actions,preds<span style="color:#f92672">.</span>scores,preds<span style="color:#f92672">.</span>concedes)
    A<span style="color:#f92672">.</span>append(pd<span style="color:#f92672">.</span>concat([actions,preds,values],axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
A <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat(A)<span style="color:#f92672">.</span>sort_values([<span style="color:#e6db74">&#34;game_id&#34;</span>,<span style="color:#e6db74">&#34;period_id&#34;</span>, <span style="color:#e6db74">&#34;time_seconds&#34;</span>, <span style="color:#e6db74">&#34;timestamp&#34;</span>])<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span>True)
A<span style="color:#f92672">.</span>columns
A[<span style="color:#e6db74">&#34;player&#34;</span>] <span style="color:#f92672">=</span> A[[<span style="color:#e6db74">&#34;player_nickname&#34;</span>,
                 <span style="color:#e6db74">&#34;player_name&#34;</span>]]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: x[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">if</span> x[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">else</span> x[<span style="color:#ae81ff">1</span>],axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

<span style="color:#75715e"># 各プレーヤーのVAEPの合計を算出し、降順で確認</span>
summary <span style="color:#f92672">=</span> A<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;player&#39;</span>,
                     <span style="color:#e6db74">&#39;team_name&#39;</span>,
                     <span style="color:#e6db74">&#39;player&#39;</span>])[[<span style="color:#e6db74">&#39;offensive_value&#39;</span>,
                                 <span style="color:#e6db74">&#39;defensive_value&#39;</span>,
                                 <span style="color:#e6db74">&#39;vaep_value&#39;</span>]]<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>reset_index()

summary<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;vaep_value&#39;</span>,ascending <span style="color:#f92672">=</span> False)<span style="color:#f92672">.</span>head(<span style="color:#ae81ff">10</span>)

<span style="color:#75715e"># 90分あたりの平均VAEPを算出し、降順で確認</span>
players <span style="color:#f92672">=</span> A_[[<span style="color:#e6db74">&#34;player_id&#34;</span>,
              <span style="color:#e6db74">&#34;team_name&#34;</span>,
              <span style="color:#e6db74">&#34;player&#34;</span>,
              <span style="color:#e6db74">&#34;vaep_value&#34;</span>,<span style="color:#e6db74">&#34;count&#34;</span>]]<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#34;player_id&#34;</span>,
                                <span style="color:#e6db74">&#34;team_name&#34;</span>,
                                <span style="color:#e6db74">&#34;player&#34;</span>])<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>reset_index()
players <span style="color:#f92672">=</span> players<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#34;vaep_value&#34;</span>,ascending<span style="color:#f92672">=</span>False)

pg <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_hdf(spadl_h5,<span style="color:#e6db74">&#34;player_games&#34;</span>)
pg <span style="color:#f92672">=</span> pg[pg<span style="color:#f92672">.</span>game_id<span style="color:#f92672">.</span>isin(games<span style="color:#f92672">.</span>game_id)]
mp <span style="color:#f92672">=</span> pg[[<span style="color:#e6db74">&#34;player_id&#34;</span>,<span style="color:#e6db74">&#34;minutes_played&#34;</span>]]<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#34;player_id&#34;</span>)<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>reset_index()
stats <span style="color:#f92672">=</span> players<span style="color:#f92672">.</span>merge(mp)
stats <span style="color:#f92672">=</span> stats[stats<span style="color:#f92672">.</span>minutes_played <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">180</span>]
stats[<span style="color:#e6db74">&#34;vaep_rating&#34;</span>] <span style="color:#f92672">=</span> stats<span style="color:#f92672">.</span>vaep_value <span style="color:#f92672">*</span> <span style="color:#ae81ff">90</span> <span style="color:#f92672">/</span> stats<span style="color:#f92672">.</span>minutes_played

stats<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#34;vaep_rating&#34;</span>,ascending<span style="color:#f92672">=</span>False)<span style="color:#f92672">.</span>head(<span style="color:#ae81ff">10</span>)

<span style="color:#75715e"># matplotsoccerによる可視化</span>

<span style="color:#75715e">## ゴールが入った場面の抽出</span>
shot_goal_index <span style="color:#f92672">=</span> A[(A<span style="color:#f92672">.</span>game_id <span style="color:#f92672">==</span> <span style="color:#ae81ff">7584</span>)<span style="color:#f92672">&amp;</span>A<span style="color:#f92672">.</span>type_name<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(<span style="color:#e6db74">&#34;shot&#34;</span>)<span style="color:#f92672">&amp;</span>(A<span style="color:#f92672">.</span>result_name<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;success&#39;</span>)]

<span style="color:#75715e">## ベルギー3点目の可視化</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_time</span>(period_id,time_seconds):
    m <span style="color:#f92672">=</span> int((period_id<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">45</span> <span style="color:#f92672">+</span> time_seconds <span style="color:#f92672">//</span> <span style="color:#ae81ff">60</span>)
    s <span style="color:#f92672">=</span> time_seconds <span style="color:#f92672">%</span> <span style="color:#ae81ff">60</span>
    <span style="color:#66d9ef">if</span> s <span style="color:#f92672">==</span> int(s):
        s <span style="color:#f92672">=</span> int(s)
    <span style="color:#66d9ef">return</span> f<span style="color:#e6db74">&#34;{m}m{s}s&#34;</span>

<span style="color:#75715e">### 場面の抽出</span>
a <span style="color:#f92672">=</span> A<span style="color:#f92672">.</span>iloc[shot_goal_index<span style="color:#f92672">.</span>index[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>:shot_goal_index<span style="color:#f92672">.</span>index[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,:]<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;action_id&#39;</span>)
a[<span style="color:#e6db74">&#34;player&#34;</span>] <span style="color:#f92672">=</span> a[[<span style="color:#e6db74">&#34;player_nickname&#34;</span>,
                 <span style="color:#e6db74">&#34;player_name&#34;</span>]]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: x[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">if</span> x[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">else</span> x[<span style="color:#ae81ff">1</span>],axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

<span style="color:#75715e">###試合情報</span>
g <span style="color:#f92672">=</span> list(games[games<span style="color:#f92672">.</span>game_id <span style="color:#f92672">==</span> a<span style="color:#f92672">.</span>game_id<span style="color:#f92672">.</span>values[<span style="color:#ae81ff">0</span>]]<span style="color:#f92672">.</span>itertuples())[<span style="color:#ae81ff">0</span>]
game_info <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#34;{g.match_date} {g.home_team_name} {g.home_score}-{g.away_score} {g.away_team_name}&#34;</span>
minute <span style="color:#f92672">=</span> get_time(int(a[a<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> a<span style="color:#f92672">.</span>index[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>period_id),int(a[a<span style="color:#f92672">.</span>index <span style="color:#f92672">==</span> a<span style="color:#f92672">.</span>index[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]]<span style="color:#f92672">.</span>time_seconds))
<span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#34;{game_info} {minute}&#39; {a[a.index == a.index[-1]].type_name.values[0]} {a[a.index == a.index[-1]].player_name.values[0]}&#34;</span>)

<span style="color:#75715e">### データ整形</span>
a[<span style="color:#e6db74">&#34;scores&#34;</span>] <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span>scores<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%.3f</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> x )
a[<span style="color:#e6db74">&#34;vaep_value&#34;</span>] <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span>vaep_value<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x : <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%.3f</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> x )
a[<span style="color:#e6db74">&#34;time&#34;</span>] <span style="color:#f92672">=</span> a[[<span style="color:#e6db74">&#34;period_id&#34;</span>,<span style="color:#e6db74">&#34;time_seconds&#34;</span>]]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: get_time(<span style="color:#f92672">*</span>x),axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
cols <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;time&#34;</span>,<span style="color:#e6db74">&#34;type_name&#34;</span>,<span style="color:#e6db74">&#34;player&#34;</span>,<span style="color:#e6db74">&#34;team_name&#34;</span>,<span style="color:#e6db74">&#34;scores&#34;</span>,<span style="color:#e6db74">&#34;vaep_value&#34;</span>]

<span style="color:#75715e">### プロット</span>
matplotsoccer<span style="color:#f92672">.</span>actions(a[[<span style="color:#e6db74">&#34;start_x&#34;</span>,<span style="color:#e6db74">&#34;start_y&#34;</span>,<span style="color:#e6db74">&#34;end_x&#34;</span>,<span style="color:#e6db74">&#34;end_y&#34;</span>]],
                      a<span style="color:#f92672">.</span>type_name,
                      team<span style="color:#f92672">=</span>a<span style="color:#f92672">.</span>team_name,
                      result <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span>result_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;success&#34;</span>,
                      label<span style="color:#f92672">=</span>a[cols],
                      labeltitle <span style="color:#f92672">=</span> cols,
                      zoom<span style="color:#f92672">=</span>False)
</code></pre></div><section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://github.com/statsbomb/open-data">https://github.com/statsbomb/open-data</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
