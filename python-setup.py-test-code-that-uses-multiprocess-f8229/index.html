<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://japan2018.github.io/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://japan2018.github.io/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://japan2018.github.io/favicon-16x16.png">

  
  <link rel="manifest" href="https://japan2018.github.io/site.webmanifest">

  
  <link rel="mask-icon" href="https://japan2018.github.io/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://japan2018.github.io/css/bootstrap.min.css" />

  
  <title>python setup.py test code that uses multiprocess | Some Title</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>python setup.py test code that uses multiprocess</h1>
<p>
  <small class="text-secondary">
  
  
  Apr 26, 2020
  </small>
  

<small><code><a href="https://japan2018.github.io/tags/python">Python</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/unittest">unittest</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/python3">Python3</a></code></small>

</p>
<pre><code># wrap up
</code></pre>
<ul>
<li>Running unittest including multiprocess module in setup.py results in infinite loop</li>
<li>Apparently it is a specification of the multiprocess module</li>
<li>Temporarily rewrite &ldquo;__main__&rdquo; as a workaround</li>
</ul>
<h1 id="premise">Premise</h1>
<p>In python it uses the &ldquo;multiprocess&rdquo; module to run functions in multiprocess.</p>
<p>The formula is easy to understand how to use and sample code.
<a href="https://docs.python.org/ja/3/library/multiprocessing.html">https://docs.python.org/ja/3/library/multiprocessing.html</a></p>
<p>Now look at the following code</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#f92672">from</span> multiprocessing <span style="color:#f92672">import</span> Pool

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">f</span>(x):
    <span style="color:#66d9ef">return</span> x<span style="color:#f92672">*</span>x
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    <span style="color:#66d9ef">with</span> Pool(<span style="color:#ae81ff">5</span>) <span style="color:#66d9ef">as</span> p:
        <span style="color:#66d9ef">print</span>(p<span style="color:#f92672">.</span>map(f, [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>]))
main()
    
</code></pre></div><p>&ldquo;If __name__ ==&rsquo;__main__':&rdquo; has been omitted from the official sample code.
Doing this would be terrible.
(It is necessary to enter an infinite loop and process kill)</p>
<p>This seems to be a specification as it is also stated in the official
<a href="https://docs.python.org/ja/3/library/multiprocessing.html#the-spawn-and-forkserver-start-methods">https://docs.python.org/ja/3/library/multiprocessing.html#the-spawn-and-forkserver-start-methods</a></p>
<p>For the time being
<strong>Do not omit &ldquo;if __name__ ==&rsquo;__main__':&rdquo; in code using multiprocess</strong>
It means that.</p>
<h1 id="main-subject">Main subject</h1>
<p>Now, suppose you create a module that uses multi-process and run unittest.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mp_test.py" data-lang="mp_test.py">
<span style="color:#f92672">from</span> multiprocessing <span style="color:#f92672">import</span> Pool

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">f</span>(x):
    <span style="color:#66d9ef">return</span> x<span style="color:#f92672">*</span>x
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    <span style="color:#66d9ef">with</span> Pool(<span style="color:#ae81ff">5</span>) <span style="color:#66d9ef">as</span> p:
        <span style="color:#66d9ef">print</span>(p<span style="color:#f92672">.</span>map(f, [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>]))
<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span><span style="color:#e6db74">&#39;__main__&#39;</span>:
    <span style="color:#66d9ef">pass</span>
    
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-test_mp_test.py" data-lang="test_mp_test.py"><span style="color:#e6db74">&#34;&#34;&#34;Tests for `multiprocess_test` package.&#34;&#34;&#34;</span>


<span style="color:#f92672">import</span> unittest

<span style="color:#f92672">from</span> mp_test <span style="color:#f92672">import</span> mp_test

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestMultiprocess_test</span>(unittest<span style="color:#f92672">.</span>TestCase):
    <span style="color:#e6db74">&#34;&#34;&#34;Tests for `multiprocess_test` package.&#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setUp</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;Set up test fixtures, if any.&#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tearDown</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;Tear down test fixtures, if any.&#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_000_something</span>(self):

        mp_test<span style="color:#f92672">.</span>main()

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    unittest<span style="color:#f92672">.</span>main()
</code></pre></div><p>Let&rsquo;s test.</p>
<pre><code>$python test_mp_test.py
</code></pre><p>You can do this.</p>
<p>So what happens when you run this test <strong>via setup.py</strong>?</p>
<pre><code class="language-Directory" data-lang="Directory">mp_test
  |-mp_test.py
tests
  |-test_mp_test.py
setup.py
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-setup.py" data-lang="setup.py"><span style="color:#75715e">#!/usr/bin/env python</span>

<span style="color:#e6db74">&#34;&#34;&#34;The setup script.&#34;&#34;&#34;</span>

<span style="color:#f92672">from</span> setuptools <span style="color:#f92672">import</span> setup, find_packages

setup(
    author<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;rr28&#34;</span>,
    author_email<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rr28_yosizumi@hotmail.com&#39;</span>,
    python_requires<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&gt;=3.5&#39;</span>,
    description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;multiprocess test.&#34;</span>,
    entry_points<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#39;console_scripts&#39;</span>: [
            <span style="color:#e6db74">&#39;mp_test=mp_test.mp_test:main&#39;</span>,
        ],
    },
    name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mp_test&#39;</span>,
    packages<span style="color:#f92672">=</span>find_packages(include<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;mp_test&#39;</span>,<span style="color:#e6db74">&#39;mp_test.*&#39;</span>]),
    test_suite<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;tests&#39;</span>,
    version<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0.1.0&#39;</span>,
)
</code></pre></div><p>Execution</p>
<pre><code>$python setup.py test
</code></pre><p>**That&rsquo;s right. It becomes an infinite loop even though &ldquo;if <strong>name</strong> ==&rsquo;<strong>main</strong>':&rdquo; is not omitted. **</p>
<p>Execution result</p>
<pre><code>=================================================== ====================
ERROR: test_000_something (tests.test_mp_test.TestMp_test)
Test something.
- ------------------------------------------------- --------------------
Traceback (most recent call last):
  -Omitted-
RuntimeError:
        An attempt has been made to start a new process before the
        current process has finished its bootstrapping phase.

        This probably means that you are not using fork to start your
        child processes and you have forgotten to use the proper idiom
        in the main module:

            if __name__ =='__main__':
                freeze_support()
                ...

        The &quot;freeze_support()&quot; line can be omitted if the program
        is not going to be frozen to produce an executable.

- ------------------------------------------------- --------------------
Ran 1 test in 0.007s

FAILED (errors=1)
Test failed: &lt;unittest.runner.TextTestResult run=1 errors=1 failures=0&gt;
test_000_something (tests.test_mp_test.TestMp_test)
Test something.... ERROR

Loop below
・
・
・
</code></pre><h2 id="workaround">Workaround</h2>
<p>I think that the test execution process of setup.py does not meet the specification of multiprocess,
The workaround that ended up was something like this</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-test_mp_test.py" data-lang="test_mp_test.py"><span style="color:#e6db74">&#34;&#34;&#34;Tests for `multiprocess_test` package.&#34;&#34;&#34;</span>


<span style="color:#f92672">import</span> unittest
<span style="color:#f92672">import</span> sys

<span style="color:#f92672">from</span> mp_test <span style="color:#f92672">import</span> mp_test

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestMp_test</span>(unittest<span style="color:#f92672">.</span>TestCase):
    <span style="color:#e6db74">&#34;&#34;&#34;Tests for `mp_test` package.&#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setUp</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;Set up test fixtures, if any.&#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tearDown</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;Tear down test fixtures, if any.&#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_000_something</span>(self):
        old_main <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;__main__&#34;</span>]
        old_main_file <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;__main__&#34;</span>]<span style="color:#f92672">.</span>__file__
        sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;__main__&#34;</span>] <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;mp_test.mp_test&#34;</span>]
        sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;__main__&#34;</span>]<span style="color:#f92672">.</span>__file__ <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;mp_test.mp_test&#34;</span>]<span style="color:#f92672">.</span>__file__
        
        mp_test<span style="color:#f92672">.</span>main()

        sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;__main__&#34;</span>] <span style="color:#f92672">=</span> old_main
        sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;__main__&#34;</span>]<span style="color:#f92672">.</span>__file__ <span style="color:#f92672">=</span> old_main_file

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    unittest<span style="color:#f92672">.</span>main()
</code></pre></div><p><a href="https://stackoverflow.com/questions/33128681/how-to-unit-test-code-that-uses-python-multiprocessing">https://stackoverflow.com/questions/33128681/how-to-unit-test-code-that-uses-python-multiprocessing</a></p>
<p>Rewrite the running &ldquo;__main__&rdquo;.
By doing this, unittest from setup.py can also be executed.</p>
<p>Also, if you want to execute multi-process processing in multiple test cases,
You may write it in setUp and tearDown as a dedicated test class.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-test_mp_test.py" data-lang="test_mp_test.py"><span style="color:#f92672">import</span> unittest
<span style="color:#f92672">import</span> sys

<span style="color:#f92672">from</span> mp_test <span style="color:#f92672">import</span> mp_test

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestMp_test</span>(unittest<span style="color:#f92672">.</span>TestCase):
    <span style="color:#e6db74">&#34;&#34;&#34;Tests for `mp_test` package.&#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setUp</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34;Set up test fixtures, if any.&#34;&#34;&#34;</span>
        self<span style="color:#f92672">.</span>_old_main <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;__main__&#34;</span>]
        self<span style="color:#f92672">.</span>_old_main_file <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;__main__&#34;</span>]<span style="color:#f92672">.</span>__file__
        sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;__main__&#34;</span>] <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;mp_test.mp_test&#34;</span>]sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;__main__&#34;</span>]<span style="color:#f92672">.</span>__file__ <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;mp_test.mp_test&#34;</span>]<span style="color:#f92672">.</span>__file__

     <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tearDown</span>(self):
         <span style="color:#e6db74">&#34;&#34;&#34;Tear down test fixtures, if any.&#34;&#34;&#34;</span>
         sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;__main__&#34;</span>] <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_old_main
         sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#34;__main__&#34;</span>]<span style="color:#f92672">.</span>__file__ <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_old_main_file

     <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_000_something</span>(self):
         <span style="color:#e6db74">&#34;&#34;&#34;Test something.&#34;&#34;&#34;</span>
         mp_test<span style="color:#f92672">.</span>main()

<span style="color:#66d9ef">if</span> __name__<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;__main__&#34;</span>:
     unittest<span style="color:#f92672">.</span>main()

</code></pre></div><h1 id="in-conclusion">in conclusion</h1>
<p>When I was building a test environment with tox, I noticed and investigated.
I don&rsquo;t notice it with VSC or a unit test by itself, so I think it may be &ldquo;Waaaaaaaaa&rdquo; at the end of development.
However, there seems to be a smarter workaround, but I would appreciate it if anyone knows it.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
