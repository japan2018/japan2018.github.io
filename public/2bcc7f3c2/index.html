<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] [Introduction to SIR Model] COVID-19 data fitting to predict the end of life in each country ♬ | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] [Introduction to SIR Model] COVID-19 data fitting to predict the end of life in each country ♬</h1>
<p>
  <small class="text-secondary">
  
  
  Mar 29, 2020
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/differential-equations"> Differential Equations</a></code></small>


<small><code><a href="https://memotut.com/tags/infectious-diseases"> Infectious Diseases</a></code></small>


<small><code><a href="https://memotut.com/tags/columbine"> Columbine</a></code></small>


<small><code><a href="https://memotut.com/tags/covid-19"> COVID-19</a></code></small>

</p>
<pre><code>In the previous SEIR model, values such as $lp \fallingdotseq 1e^{-23}$ were obtained among the obtained parameters. In such a case, be careful because the digit cancellation or the differential equation may not work in the first place.
</code></pre>
<p>So, this time, I will change this part and try fitting with the simplest model.</p>
<h3 id="what-you-did">what you did</h3>
<p>・A little theory
・Code explanation
・End of Japan
・End of each country
・A little discussion</p>
<h3 id="-a-little-theory">· A little theory</h3>
<p>The SIR model is the following simple time evolution equation.</p>
<pre><code class="language-math" data-lang="math">{\begin{align}
\frac{dS}{dt} &amp;= -\beta \frac{SI}{N} \\
\frac{dI}{dt} &amp;= \beta \frac{SI}{N} -\gamma I \\
\frac{dR}{dt} &amp;= \gamma I \\
\end{align}
}
</code></pre><p>The first equation is that the decrease in uninfected people is proportional to the number of infected people and uninfected people, and inversely proportional to the total number of target people, so the coefficient β is the infection rate, and the ratio of uninfected people is Decrease.
It is also possible to think of the infection rate per person as β/N.
The second equation is the equation for the increase in infected people. The increase is the difference between the influx from uninfected and the healer.
The third equation is an expression that a certain proportion of infected persons is cured, and this coefficient γ is a cure rate called a removal rate.
【reference】
・<a href="https://rad-it21.com/%E3%82%B5%E3%82%A4%E3%82%A8%E3%83%B3%E3%82%B9/kado-shinichiro_20200327/">Is this infection spread or converged: Determine the physical meaning of the number R of reproductions</a></p>
<p>Here, the second equation can be transformed as follows.</p>
<pre><code class="language-math" data-lang="math">\frac{dI}{dt} = \gamma (\frac{\beta}{\gamma} \frac{S}{N}-1)I\\
</code></pre><p>That is, if $S/N$ is considered to be constant, the following solution is formally obtained.
*It may be considered as time development within a sufficiently small time</p>
<pre><code class="language-math" data-lang="math">I = I_0\exp(\gamma (\frac{\beta}{\gamma} \frac{S}{N}-1)t)\\
</code></pre><p>At the start of infection, it is $S_0\fallingdotseq N$, in which case the following solution is obtained.</p>
<pre><code class="language-math" data-lang="math">{\begin{align}
I &amp;= I_0\exp(\gamma (R_0-1)t)\\
 here\\ 
R_0 &amp;= \frac{\beta}{\gamma}
\end{align}
}
</code></pre><p>Here, in the formula of $I$, the number of infected persons decreases exponentially when $R_0&lt;1$, and conversely increases when $R_0&gt;1$.
Therefore, <strong>$R_0$ is called the basic reproduction number</strong>, and is a standard for determining whether or not infection transmission occurs.
Furthermore, in the above reference,</p>
<pre><code class="language-math" data-lang="math">R = R_0\frac{S}{N}
</code></pre><p>Is defined as the <strong>effective reproduction number</strong>.
This $R$ becomes smaller as the infection progresses and $\frac{S}{N}$ becomes smaller. That is, as can be seen from the formal solution above, when $R_0&gt;1$, the infection is still spreading even at the initial stage of spreading, and the infection spreads, but eventually $\frac{S}{N}$ becomes small. And becomes an indicator that the end will start when $R&lt;1$ is realized.
On the other hand, the infection peak starts from the left side of $\frac{dI}{dt}=0$=0, and the number of uninfected persons at this time is $S_p$.</p>
<pre><code class="language-math" data-lang="math">{\begin{align}
R_0 &amp;= \frac{\beta}{\gamma}\\
&amp; = \frac{N}{S_p}\\
\end{align}
}
</code></pre><p>Holds, and at this time</p>
<pre><code class="language-math" data-lang="math">{\begin{align}
R &amp;= R_0\frac{S_p}{N}\\
&amp;= 1
\end{align}
}
</code></pre><p>It can be seen that In other words, **the number of effective reproductions is R=1 at the peak of infection, and the transmission of infection will be terminated thereafter. **
This time, let&rsquo;s see the end prediction by plotting this <strong>effective reproduction number</strong>.</p>
<h3 id="code-explanation">・Code explanation</h3>
<p>The entire code is below.
・<a href="https://github.com/MuAuan/collective_particles/blob/master/fitting_SIR_COVID2.py">Collective_particles/fitting_SIR_COVID2.py</a>
The usage Lib is <a href="https://qiita.com/MuAuan/items/0da669d5354c4c225cf6">same as last time</a> as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">from</span> scipy.integrate <span style="color:#f92672">import</span> odeint
<span style="color:#f92672">from</span> scipy.optimize <span style="color:#f92672">import</span> minimize
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
</code></pre></div><p>From <a href="https://github.com/CSSEGISandData/COVID-19">COVID-19 site</a>inadvance<a href="https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series">Data</a> I am downloading.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">Read CSV data <span style="color:#66d9ef">with</span> <span style="color:#75715e">#pandas.</span>
data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv&#39;</span>)
data_r <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv&#39;</span>)
data_d <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv&#39;</span>)
    
confirmed <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> (len(data<span style="color:#f92672">.</span>columns)<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>)
confirmed_r <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> (len(data_r<span style="color:#f92672">.</span>columns)<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>)
confirmed_d <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> (len(data_d<span style="color:#f92672">.</span>columns)<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>)
days_from_22_Jan_20 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>, len(data<span style="color:#f92672">.</span>columns)<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span>)
</code></pre></div><p>The record order of the data was correct in the previous time, but this time the country or region of the three data is not in the same order, so each is acquired as follows, and the infection count data calculates the existing infection count. In order to do so, I am trying to obtain it after obtaining the healing data.
In addition, if statements are used interchangeably in each country and region.
Also, the total number of cures and total number of deaths required for mortality and cure rates are not calculated this time, so I commented out.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#City</span>
city <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Japan&#34;</span>
<span style="color:#75715e">#Process data</span>
t_cases <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(data_r), <span style="color:#ae81ff">1</span>):
    <span style="color:#66d9ef">if</span> (data_r<span style="color:#f92672">.</span>iloc[i][<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> city): <span style="color:#75715e">#for country/region</span>
    <span style="color:#75715e">#if (data_r.iloc[i][0] == city): #for province:/state</span>
        <span style="color:#66d9ef">print</span>(str(data_r<span style="color:#f92672">.</span>iloc[i][<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;of &#34;</span><span style="color:#f92672">+</span> data_r<span style="color:#f92672">.</span>iloc[i][<span style="color:#ae81ff">1</span>])
        <span style="color:#66d9ef">for</span> day <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">4</span>, len(data<span style="color:#f92672">.</span>columns), <span style="color:#ae81ff">1</span>):
            confirmed_r[day<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>] <span style="color:#f92672">+=</span> data_r<span style="color:#f92672">.</span>iloc[i][day]
            <span style="color:#75715e">#t_recover += data_r.iloc[i][day]</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(data), <span style="color:#ae81ff">1</span>):
    <span style="color:#66d9ef">if</span> (data<span style="color:#f92672">.</span>iloc[i][<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> city): <span style="color:#75715e">#for country/region</span>
    <span style="color:#75715e">#if (data.iloc[i][0] == city): #for province:/state</span>
        <span style="color:#66d9ef">print</span>(str(data<span style="color:#f92672">.</span>iloc[i][<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;of &#34;</span><span style="color:#f92672">+</span> data<span style="color:#f92672">.</span>iloc[i][<span style="color:#ae81ff">1</span>])
        <span style="color:#66d9ef">for</span> day <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">4</span>, len(data<span style="color:#f92672">.</span>columns), <span style="color:#ae81ff">1</span>):
            confirmed[day<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>] <span style="color:#f92672">+=</span> data<span style="color:#f92672">.</span>iloc[i][day]<span style="color:#f92672">-</span>confirmed_r[day<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>]
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(data_d), <span style="color:#ae81ff">1</span>):
    <span style="color:#66d9ef">if</span> (data_d<span style="color:#f92672">.</span>iloc[i][<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> city): <span style="color:#75715e">#for country/region</span>
    <span style="color:#75715e">#if (data_d.iloc[i][0] == city): #for province:/state</span>
        <span style="color:#66d9ef">print</span>(str(data_d<span style="color:#f92672">.</span>iloc[i][<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;of &#34;</span><span style="color:#f92672">+</span> data_d<span style="color:#f92672">.</span>iloc[i][<span style="color:#ae81ff">1</span>])
        <span style="color:#66d9ef">for</span> day <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">4</span>, len(data<span style="color:#f92672">.</span>columns), <span style="color:#ae81ff">1</span>):
            confirmed_d[day<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>] <span style="color:#f92672">+=</span> data_d<span style="color:#f92672">.</span>iloc[i][day] <span style="color:#75715e">#fro drawings</span>
            <span style="color:#75715e">#t_deaths += data_d.iloc[i][day]</span>
</code></pre></div><p>This time we will use the SIR model.
The evaluation function also returns the number of uninfected S, the number of infected I, and the number of cured R.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#define differencial equation of sir model</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sir_eq</span>(v,t,beta,gamma):
    a <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>beta<span style="color:#f92672">*</span>v[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">*</span>v[<span style="color:#ae81ff">1</span>]
    b <span style="color:#f92672">=</span> beta<span style="color:#f92672">*</span>v[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">*</span>v[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">-</span>gamma<span style="color:#f92672">*</span>v[<span style="color:#ae81ff">1</span>]
    c <span style="color:#f92672">=</span> gamma<span style="color:#f92672">*</span>v[<span style="color:#ae81ff">1</span>]
    <span style="color:#66d9ef">return</span> [a,b,c]
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">estimate_i</span>(ini_state,beta,gamma):
    v<span style="color:#f92672">=</span>odeint(sir_eq,ini_state,t,args<span style="color:#f92672">=</span>(beta,gamma))
    est<span style="color:#f92672">=</span>v[<span style="color:#ae81ff">0</span>:int(t_max<span style="color:#f92672">/</span>dt):int(<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>dt)]
    <span style="color:#66d9ef">return</span> est[:,<span style="color:#ae81ff">0</span>],est[:,<span style="color:#ae81ff">1</span>],est[:,<span style="color:#ae81ff">2</span>] <span style="color:#75715e">#v0-S,v1-I,v2-R</span>
</code></pre></div><p>The objective function is normal variance.
Here, the linear sum is added so that the infection number I and the healing number R can be fitted simultaneously.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#define logscale likelihood function</span>
defy(params):
    est_i_0,est_i_1,est_i_2<span style="color:#f92672">=</span>estimate_i(ini_state,params[<span style="color:#ae81ff">0</span>],params[<span style="color:#ae81ff">1</span>])<span style="color:#66d9ef">return</span> np<span style="color:#f92672">.</span>sum(f1<span style="color:#f92672">*</span>(est_i_1<span style="color:#f92672">-</span>obs_i_1)<span style="color:#f92672">*</span>(est_i_1<span style="color:#f92672">-</span>obs_i_1)<span style="color:#f92672">+</span>f2<span style="color:#f92672">*</span>(est_i_2<span style="color:#f92672">-</span>obs_i_2)<span style="color:#f92672">*</span>(est_i_2<span style="color:#f92672">-</span>obs_i_2))
</code></pre></div><p>Put the total number of infections in the country (or region) selected above in N0.
In addition, f1 and f2 determine which curve the fitting will be performed on.
N,S0,I0,R0 are the initial values of each, but this is also a constant that should be adjusted according to the fitting condition.
The initial values of beta and gamma are almost the same in most countries, but it seems better to enter the values once and recalculate them.
*This initial value fitting should be done, but not this time</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#solve seir model</span>
N0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1517</span>
f1,f2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span> <span style="color:#75715e">#data &amp; data_r fitting factor</span>
N,S0,I0,R0<span style="color:#f92672">=</span>int(N0<span style="color:#f92672">*</span><span style="color:#ae81ff">1.5</span>),int(N0<span style="color:#f92672">*</span><span style="color:#ae81ff">1.5</span>),int(<span style="color:#ae81ff">10</span>),int(<span style="color:#ae81ff">0</span>)
ini_state<span style="color:#f92672">=</span>[S0,I0,R0]
beta,gamma <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.6e-6</span>, <span style="color:#ae81ff">1e-3</span> <span style="color:#75715e"># The initial value will not converge unless it is close to some extent</span>

t_max<span style="color:#f92672">=</span>len(days_from_22_Jan_20) <span style="color:#75715e"># Fitting within a certain range of data</span>
dt<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>
t<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,t_max,dt)
</code></pre></div><p>Including the initial value confirmation, try to display it below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">plt<span style="color:#f92672">.</span>plot(t,odeint(sir_eq,ini_state,t,args<span style="color:#f92672">=</span>(beta,gamma)))
plt<span style="color:#f92672">.</span>legend([<span style="color:#e6db74">&#39;Susceptible&#39;</span>,<span style="color:#e6db74">&#39;Infected&#39;</span>,<span style="color:#e6db74">&#39;Recovered&#39;</span>])

obs_i_1 <span style="color:#f92672">=</span> confirmed
obs_i_2 <span style="color:#f92672">=</span> confirmed_r

plt<span style="color:#f92672">.</span>plot(obs_i_1,<span style="color:#e6db74">&#34;o&#34;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;red&#34;</span>,label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;data_1&#34;</span>)
plt<span style="color:#f92672">.</span>plot(obs_i_2,<span style="color:#e6db74">&#34;o&#34;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;green&#34;</span>,label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;data_2&#34;</span>)
plt<span style="color:#f92672">.</span>legend()
plt<span style="color:#f92672">.</span>pause(<span style="color:#ae81ff">1</span>)
plt<span style="color:#f92672">.</span>close()
</code></pre></div><p>Fit it. I used minimize@scipy again this time.
Calculate the basic reproduction number R0.
Since the variable name is the initial value of the healing number, it is in lower case.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#optimize logscale likelihood function</span>
mnmz<span style="color:#f92672">=</span>minimize(y,[beta,gamma],method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nelder-mead&#34;</span>)
<span style="color:#66d9ef">print</span>(mnmz)
<span style="color:#75715e">#R0</span>
<span style="color:#75715e">#N_total = S_0+I_0+R_0</span>
<span style="color:#75715e">#R0 = N_total*beta_const *(1/gamma_const)</span>
beta_const,gamma <span style="color:#f92672">=</span> mnmz<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">0</span>],mnmz<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">1</span>] <span style="color:#75715e"># Infection rate, removal rate (healing rate)</span>
<span style="color:#66d9ef">print</span>(beta_const,gamma)
r0 <span style="color:#f92672">=</span> N<span style="color:#f92672">*</span>beta_const<span style="color:#f92672">*</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>gamma)
<span style="color:#66d9ef">print</span>(r0)
</code></pre></div><p>The graph is shown below.
Secondary axes of ax3 and ax4 are added to plot the effective reproduction number.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#plot reult with observed data</span>
fig, (ax1,ax2) <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>,figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1.6180</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">4</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>))
ax3 <span style="color:#f92672">=</span> ax1<span style="color:#f92672">.</span>twinx()
ax4 <span style="color:#f92672">=</span> ax2<span style="color:#f92672">.</span>twinx()

lns1<span style="color:#f92672">=</span>ax1<span style="color:#f92672">.</span>plot(confirmed,<span style="color:#e6db74">&#34;o&#34;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;red&#34;</span>,label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;data_I&#34;</span>)
lns2<span style="color:#f92672">=</span>ax1<span style="color:#f92672">.</span>plot(confirmed_r,<span style="color:#e6db74">&#34;o&#34;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;green&#34;</span>,label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;data_R&#34;</span>)
est_i_0,est_i_1,est_i_2<span style="color:#f92672">=</span>estimate_i(ini_state,mnmz<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">0</span>],mnmz<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">1</span>])
lns3<span style="color:#f92672">=</span>ax1<span style="color:#f92672">.</span>plot(est_i_1, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;estimation_I&#34;</span>)
lns0<span style="color:#f92672">=</span>ax1<span style="color:#f92672">.</span>plot(est_i_2, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;estimation_R&#34;</span>)
lns_1<span style="color:#f92672">=</span>ax3<span style="color:#f92672">.</span>plot((S0<span style="color:#f92672">-</span>est_i_1<span style="color:#f92672">-</span>est_i_2)<span style="color:#f92672">*</span>r0<span style="color:#f92672">/</span>N,<span style="color:#e6db74">&#34;.&#34;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;black&#34;</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;effective_R0&#34;</span>)
ax3<span style="color:#f92672">.</span>set_ylim(<span style="color:#ae81ff">0</span>,r0<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)

lns_ax1 <span style="color:#f92672">=</span> lns1<span style="color:#f92672">+</span>lns2 <span style="color:#f92672">+</span> lns3 <span style="color:#f92672">+</span> lns0 <span style="color:#f92672">+</span>lns_1
labs_ax1 <span style="color:#f92672">=</span> [l<span style="color:#f92672">.</span>get_label() <span style="color:#66d9ef">for</span> l <span style="color:#f92672">in</span> lns_ax1]
ax1<span style="color:#f92672">.</span>legend(lns_ax1, labs_ax1, loc<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
ax1<span style="color:#f92672">.</span>set_ylim(<span style="color:#ae81ff">0</span>,N0)
ax1<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;SIR_{} f1_{:,d} f2_{:,d};N={:.0f} S0={:.0f} I0={:.0f} R0={:.0f} R ={:.2f}&#39;</span><span style="color:#f92672">.</span>format(city,f1,f2,N,S0,I0,R0,(S0<span style="color:#f92672">-</span>est_i_1[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">-</span>est_i_2[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])<span style="color:#f92672">*</span>r0<span style="color:#f92672">/</span>N))
ax1<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#34;Susceptible, Infected, recovered &#34;</span>)
ax3<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#34;effective_R0&#34;</span>)
</code></pre></div><p>The following is a graph of the future forecast.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">t_max<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span> <span style="color:#75715e">#len(days_from_22_Jan_20)</span>
t<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>,t_max,dt)

lns4<span style="color:#f92672">=</span>ax2<span style="color:#f92672">.</span>plot(confirmed,<span style="color:#e6db74">&#34;o&#34;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;red&#34;</span>,label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;data&#34;</span>)
lns5<span style="color:#f92672">=</span>ax2<span style="color:#f92672">.</span>plot(confirmed_r,<span style="color:#e6db74">&#34;o&#34;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;green&#34;</span>,label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;data_r&#34;</span>)
est_i_0,est_i_1,est_i_2<span style="color:#f92672">=</span>estimate_i(ini_state,mnmz<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">0</span>],mnmz<span style="color:#f92672">.</span>x[<span style="color:#ae81ff">1</span>])
lns6<span style="color:#f92672">=</span>ax2<span style="color:#f92672">.</span>plot(est_i_0, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;estimation_S&#34;</span>)
lns7<span style="color:#f92672">=</span>ax2<span style="color:#f92672">.</span>plot(est_i_1, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;estimation_I&#34;</span>)
lns8<span style="color:#f92672">=</span>ax2<span style="color:#f92672">.</span>plot(est_i_2, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;estimation_R&#34;</span>)
lns_6<span style="color:#f92672">=</span>ax4<span style="color:#f92672">.</span>plot((S0<span style="color:#f92672">-</span>est_i_1<span style="color:#f92672">-</span>est_i_2)<span style="color:#f92672">*</span>r0<span style="color:#f92672">/</span>N,<span style="color:#e6db74">&#34;.&#34;</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;black&#34;</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;effective_R0&#34;</span>)

lns_ax2 <span style="color:#f92672">=</span> lns4<span style="color:#f92672">+</span>lns5 <span style="color:#f92672">+</span> lns6 <span style="color:#f92672">+</span> lns7<span style="color:#f92672">+</span> lns8 <span style="color:#f92672">+</span>lns_6
labs_ax2 <span style="color:#f92672">=</span> [l<span style="color:#f92672">.</span>get_label() <span style="color:#66d9ef">for</span> l <span style="color:#f92672">in</span> lns_ax2]
ax2<span style="color:#f92672">.</span>legend(lns_ax2, labs_ax2, loc<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
ax4<span style="color:#f92672">.</span>set_ylim(<span style="color:#ae81ff">0</span>,r0<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
ax2<span style="color:#f92672">.</span>set_ylim(<span style="color:#ae81ff">0</span>,S0)
ax2<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;SIR_{};b={:.2e} g={:.2e} r0={:.2f}&#39;</span><span style="color:#f92672">.</span>format(city,beta_const,gamma,r0))
ax2<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#34;Susceptible, Infected, recovered &#34;</span>)
ax4<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#34;effective_R0&#34;</span>)

ax1<span style="color:#f92672">.</span>grid()
ax2<span style="color:#f92672">.</span>grid()
plt<span style="color:#f92672">.</span>savefig(<span style="color:#e6db74">&#39;./fig/SIR_{}f1_{:,d}f2_{:,d};b_{:.2e}g_{:.2e}r0_{:.2f}N_{:.0f}S0_ (:.0f}I0_{:.0f}R0_{:.0f}.png&#39;</span><span style="color:#f92672">.</span>format(city,f1,f2,beta_const,gamma,r0,N,S0,I0,R0))
plt<span style="color:#f92672">.</span>show()
plt<span style="color:#f92672">.</span>close()
</code></pre></div><h3 id="end-of-japan">・End of Japan</h3>
<p><strong>Data is as of March 27, 2020</strong>.
The data is as follows.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/40fb19b0-14ce-9628-8a4a-cbbd92bc7cf5.png" alt="fig_Japan_.png">
The results are as follows.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/d12bfdda-4d31-3cb1-6824-b13e4774c221.png" alt="SIR_Japanf1_1f2_1;b_4.53e-05g_1.58e-02r0_6.52N_2275S0_2275I0_10R0_0.png">
This result seems to be fitting for the time being, but in today&rsquo;s report, it says that 200 people were infected on March 28 yesterday, so it is above the graph and it does not match ..
I posted this as a bonus.
The various amounts obtained are as follows.</p>
<pre><code class="language-math" data-lang="math">{\begin{align}
\beta &amp;= 4.53e^{-5}\\
\gamma &amp;= 1.58e^{-2}\\
N &amp;= 2275\\
R0 &amp;= 6.52\\
R(27.3.2020) &amp;= 2.71\\
\end{align}
}
</code></pre><h3 id="end-of-each-country">・End of each country</h3>
<h4 id="status-of-hubei-wuhan">Status of Hubei (Wuhan)</h4>
<p>The latest data (27.3.2020) is as follows.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/7c683c8d-5d76-ba17-cad5-cbb567481ca8.png" alt="fig_Hubei_.png">
Wuhan&rsquo;s data cannot be matched as below when trying to fit both infection and cure data.
However, as you can see from the graph, it can be said that the number of effective reproductions ended at R=0.01, 0.08.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/4c201377-c517-64ca-908c-a33b44e3acda.png" alt="SIR_Hubeif1_1f2_0;b_3.19e-06g_6.53e-02r0_5.20N_106462S0_106462I0_318R0_389.png"></p>
<pre><code class="language-math" data-lang="math">{\begin{align}
\beta &amp;= 3.19e^{-6}\\
\gamma &amp;= 6.53e^{-2}\\
N &amp;= 106462\\
R0 &amp;= 5.20\\
R(27.3.2020) &amp;= 0.01\\
\end{align}
}
</code></pre><p>The following shows the result of fitting both at the same time, and the peak number of infections has shifted significantly.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/96ebc5a1-5946-f" alt="SIR_Hubeif1_1f2_1;b_2.34e-06g_5.33e-02r0_4.67N_106462S0_106462I0_318R0_389.png">-c3bf-28d0e31b03ec.png)</p>
<pre><code class="language-math" data-lang="math">{\begin{align}
\beta &amp;= 2.34e^{-6}\\
\gamma &amp;= 5.33e^{-2}\\
N &amp;= 106462\\
R0 &amp;= 4.67\\
R(27.3.2020) &amp;= 0.08\\
\end{align}
}
</code></pre><h4 id="status-of-korea-south-korea">Status of Korea, South (Korea)</h4>
<p>The latest data (27.3.2020) is as follows.<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/8f59423a-b285-d89a-9368-4ae28ea17750.png" alt="fig_Korea, South_.png"></p>
<p>The data in South Korea is not as bad as in Wuhan, but it is almost the same, and even if we try to fit the data of both the number of infections and the number of cures, we cannot match them as follows.
However, as you can see from the graph, the number of effective reproductions is ending at R=0.13.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/1462127f-0b75-18f8-a128-ef34910115c0.png" alt="SIR_Korea, Southf1_1f2_0;b_2.25e-05g_2.94e-02r0_8.68N_11365S0_11365I0_1R0_0.png"></p>
<pre><code class="language-math" data-lang="math">{\begin{align}
\beta &amp;= 2.25e^{-5}\\
\gamma &amp;= 2.94e^{-2}\\
N &amp;= 11365\\
R0 &amp;= 8.68\\
R(27.3.2020) &amp;= 0.13\\
\end{align}
}
</code></pre><p>If you try to fit both, the fitting of the infection count data will be weakened and the infection peak will also shift to the right. It may be possible to fit it with more proper fitting, but this time we will not pursue further.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/d8de2700-b868-129c-c101-99f61fca50e1.png" alt="SIR_Korea, Southf1_1f2_1;b_2.11e-05g_2.14e-02r0_11.17N_11365S0_11365I0_1R0_0.png"></p>
<pre><code class="language-math" data-lang="math">{\begin{align}
\beta &amp;= 2.11e^{-5}\\
\gamma &amp;= 2.14e^{-2}\\
N &amp;= 11365\\
R0 &amp;= 11.17\\
R(27.3.2020) &amp;= 0.18\\
\end{align}
}
</code></pre><h4 id="-status-of-iran">· Status of Iran</h4>
<p>The next country that is likely to end is Iran.
The latest data (27.3.2020) is as follows.
However, when I come here and the cure rate exceeds 30%, it seems to be stagnant.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/3046e87f-bce4-2792-67e0-e112a7b3ed8d.png" alt="fig_Iran_.png">
Even so, the effective number of reproductions is 1.81, and it will be 1 soon, so it can be said that the peak number of infections is near.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/df9d4acc-b131-0a-29a2-d1d785b24ba8.png" alt="SIR_Iranf1_1f2_1;b_2.92e-06g_4.94e-02r0_3.70N_62478S0_62478I0_10R0_0.png"></p>
<pre><code class="language-math" data-lang="math">{\begin{align}
\beta &amp;= 2.92e^{-6}\\
\gamma &amp;= 4.94e^{-2}\\
N &amp;= 62478\\
R0 &amp;= 3.70\\
R(27.3.2020) &amp;= 1.81\\
\end{align}
}
</code></pre><h4 id="-italy-italy-status">· Italy (Italy) status</h4>
<p>The next worrying country is Italy.
The latest data (27.3.2020) is as follows.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/afd0f69d-1ad0-6b11-438e-709c61dc86eb.png" alt="fig_Italy_.png">
The data in this country is very solid, and it feels good to be able to fit both curves of infection and cure. The results are shown below. The effective number of reproductions is 4.07, but it has dropped sharply and it seems that it will be finished in about 10 days.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/82ab930f-ffa7-1555-ac8c-b444036cd442.png" alt="SIR_Italyf1_1f2_1;b_1.46e-06g_1.91e-02r0_10.99N_143448S0_143448I0_1R0_0.png"></p>
<pre><code class="language-math" data-lang="math">{\begin{align}
\beta &amp;= 1.46e^{-6}\\
\gamma &amp;= 1.91e^{-2}\\
N &amp;= 143448\\
R0 &amp;= 10.99\\
R(27.3.2020) &amp;= 4.07\\
\end{align}
}
</code></pre><p>As far as we can see from this data, it seems that there is no medical disruption and that the effects of the city blockade are well managed. (Comments have no scientific basis other than graphs. It is an individual impression.)</p>
<h4 id="spain-spain-status">・Spain (Spain) status</h4>
<p>Next is the situation in Spain, where deaths are increasing rapidly.
Conclusion When I write it, it seems that it is still in an early stage of expansion, and the fitting is uncertain.
*The current situation is undecidable for this model
The latest data (27.3.2020) is as follows.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/eca3eea7-0b96-7736-0e66-c58ac1ac69b2.png" alt="fig_Spain_.png">
The following shows the cases where N is small and large.
N and so on are indefinite, but the effective reproduction numbers are still 7.81 and 8.09 respectively, but the termination period (peak infection) is around 80-90 days (2 weeks to 1 month later), so if you ignore the peak value It can be said that there are similar places.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/a813bba7-4992-109d-27e1-ef8acb25de2b.png" alt="SIR_Spainf1_1f2_1;b_1.49e-06g_1.37e-02r0_13.85N_127542S0_127542I0_1R0_0.png"></p>
<pre><code class="language-math" data-lang="math">{\begin{align}
\beta &amp;= 1.49e^{-6}\\
\gamma &amp;= 1.37e^{-2}\\
N &amp;= 127542\\
R0 &amp;= 13.85\\
R(27.3.2020) &amp;= 7.81\\
\end{align}
}
</code></pre><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/2f6ce6b0-c613-b8f0.-4e49-16baa8139c4d.png" alt="SIR_Spainf1_1f2_1;b_5.39e-07g_1.94e-02r0_9.86N_354285S0_354285I0_1R0_0.png"></p>
<pre><code class="language-math" data-lang="math">{\begin{align}
\beta &amp;= 5.39e^{-7}\\
\gamma &amp;= 1.94e^{-2}\\
N &amp;= 354285\\
R0 &amp;= 9.86\\
R(27.3.2020) &amp;= 8.09\\
\end{align}
}
</code></pre><p>Actually, Germany, France, and Switzerland are similar, but I tried to fit it, but this time it was (parameter undefined) due to the rapid increase, so I will write again.</p>
<h3 id="a-little-discussion">・A little discussion</h3>
<p>I&rsquo;m afraid I can&rsquo;t really accept it, so I&rsquo;ll just write it.
The biggest drawback of this fitting is that it is N-fixed. It seems that it is possible to properly simulate the situation in which the transmission is spread naturally in a closed subject.
However, many countries in the world did not have a complete lockdown, at least up to this point there was migration of people, and among them were the infected people themselves (as a percentage).
In Japan, the number of such outpatients is increasing right now, and there is a situation where clusters are forming from there.
Therefore, what I wrote here is a fitting of the transition so far, and I can not tell the future situation. In order for these predictions to be valid, it is premised that the same situation will continue in the future, and it is necessary to control the proportion of outpatients extremely.
In fact, although we can write a model that considers these effects, it is impossible to predict this number because it is difficult to predict the number of outpatients who change randomly from moment to moment.
So, I think that it will be possible to fit in Europe and the United States if we can see the whole thing, and we can discuss the obtained parameters.</p>
<h3 id="summary">Summary</h3>
<p>・I tried fitting COVID-19 data with the SIR model
・It was found that Wuhan is nearing the end, and South Korea has also reached the peak of infection toward the end.
・Iran and Italy can be expected to reach an infection peak relatively early in about 10 days
・In Japan, the peak of infection is relatively slow because it is sluggish, and it can be expected that the peak of infection will come in 20 days depending on the outpatient.
・If the current situation advances, it is thought that the peak of infection will begin to appear in a month in many countries.</p>
<p>・I want to monitor daily to see changes in the situation
・I want to evaluate the obtained parameters
###bonus
Now, when I look at the data ** Until March 28, 2020 ** It was reflected, so I tried fitting.
However, yesterday&rsquo;s data shows abnormal values, and the peak infection period does not change much.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/dfbe1537-18cc-ff3a-90d1-582662d34cc0.png" alt="fig_Japan_.png">
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/233744/fe7d6433-2fd0-5a0a-f1f0-221e70833392.png" alt="SIR_Japanf1_1f2_1;b_3.91e-05g_1.65e-02r0_6.22N_2617S0_2617I0_10R0_0.png">
The parameters obtained are as follows, which have not changed much compared to the above.
However, <strong>the effective number of reproductions R is a little, but it is increasing, so be careful</strong>.</p>
<pre><code class="language-math" data-lang="math">{\begin{align}
\beta &amp;= 3.91e^{-5}\\
\gamma &amp;= 1.65e^{-2}\\
N &amp;= 2617\\
R0 &amp;= 6.22\\
R(28.3.2020) &amp;= 2.79\\
\end{align}
}
</code></pre><p>I would like to see future trends.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
