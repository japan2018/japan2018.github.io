<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Automatically access the flow in enebular and pull the trigger | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Automatically access the flow in enebular and pull the trigger</h1>
<p>
  <small class="text-secondary">
  
  
  Nov 26, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/googlecloudplatform">GoogleCloudPlatform</a></code></small>


<small><code><a href="https://memotut.com/tags/node-red">node-red</a></code></small>


<small><code><a href="https://memotut.com/tags/enebular">enebular</a></code></small>

</p>
<pre><code>My name is Nyamugi and I am in charge of the second day of [enebular Advent Calendar 2019](https://qiita.com/advent-calendar/2019/enebular).
</code></pre>
<p>This time I would like to introduce how to automatically access <a href="http://enebular.com/app">http://enebular.com/app</a> and pull the trigger of the flow.</p>
<h1 id="way">Way</h1>
<p>Scraping</p>
<h1 id="trigger">Trigger</h1>
<p>The Node-RED flow created with enebular is finally deployed to some device or service.
There is a flow on enebular, but it&rsquo;s a waste to not use it&hellip;
So, if the flow can be automatically opened and executed, can it be used? I thought, I tried.</p>
<h1 id="try-out">Try out</h1>
<h2 id="write-a-node-red-flow-for-testing">Write a Node-RED flow for testing</h2>
<p>Clicking the button of the &ldquo;inject&rdquo; node &ldquo;start&rdquo; is a flow of executing Cloud Functions of GCP by http request.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/237144/e4df1993-76c2-b096-cc8b-a52d75327091.png" alt="enebular_node_red.PNG"></p>
<p>*It doesn&rsquo;t matter what the flow is, so I made it easy for you to check.
*For details, please refer to <a href="https://qiita.com/NearMugi/items/dcaa5a0fcaf33ae48cd4">Running Python with Node-RED+Cloud Functions</a>.</p>
<h2 id="scraping-httpenebularcomapp">Scraping <a href="http://enebular.com/app">http://enebular.com/app</a></h2>
<p>From the point where the web page is opened, we will investigate it step by step.
The program is written in python which is easy to scrape.</p>
<h3 id="log-in">log in</h3>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/237144/4332061f-866f-7f63-8e63-f41a62b0e656.png" width="500">
Open http://enebular.com/app and wait until you can enter your email address.
<pre><code>WebDriverWait(driver, 5).until(ec.element_to_be_clickable((By.NAME, &quot;email&quot;)))
</code></pre><p>When it opens, enter your email address and password and press Enter.</p>
<pre><code>id = driver.find_element_by_name(&quot;email&quot;)
id.send_keys(un)
password = driver.find_element_by_name(&quot;password&quot;)
password.send_keys(pw)
password.send_keys(Keys.ENTER)
</code></pre><h3 id="select-assets">Select assets</h3>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/237144/c5795eb7-8801-40a9-3843-63023c58eb78.png" width="500">
Wait until you see the asset you want to select. This time is "test scraping".
<pre><code>assetNm = &quot;testscraping&quot;
assetPath ='//span[@data-testid=&quot;' + assetNm +'&quot;]'
WebDriverWait(driver, 5).until(ec.element_to_be_clickable((By.XPATH, assetPath)))
</code></pre><p>Click the asset when it appears.</p>
<pre><code>driver.find_element_by_xpath(assetPath).click()
</code></pre><p>Press the &ldquo;edit&rdquo; button in ### Overview
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/237144/8dcb16c9-6f15-e8ca-361f-3ca8abfcadd8.png" width="500">
Wait for the asset overview to appear.
It is judged that the time when the Edit button on the right side can be clicked is displayed.</p>
<pre><code>editBtn ='//button[@data-testid=&quot;btn-edit-flow&quot;]'
WebDriverWait(driver, 5).until(ec.element_to_be_clickable((By.XPATH, editBtn)))
</code></pre><p>Click the Edit button when it appears.</p>
<pre><code>driver.find_element_by_xpath(editBtn).click()
</code></pre><h3 id="switch-tabs">switch tabs</h3>
<p>Click the Edit button to display the flow on another tab. Therefore, you need to switch tabs.</p>
<pre><code>handle_array = driver.window_handles
driver.switch_to.window(handle_array[1])
</code></pre><h3 id="wait-for-the-flow-to-appear">wait for the flow to appear</h3>
<p>**This is the biggest challenge. **
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/237144/3b8e09ff-92b8-761e-5e39-cb1fd4a39a84.png" width="500">
First, &ldquo;Loading&hellip;&rdquo; is displayed.</p>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/237144/8324cdb2-0904-69d8-de95-6db6df95dbfb.png" width="500">
Next, the frame for editing the flow is displayed. **At this time, the flow tab is not displayed yet. **
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/237144/5cc5caa9-79e1-6794-b599-54e9c4306f31.png" width="500">
After a while, the flow tabs (dummy and input this time) are displayed.
<p>It is necessary to devise because the display timing of the frame is different from the display timing of the tab.
It was solved by repeating the frame loading until the flow is displayed correctly (= tab is displayed). (It&rsquo;s not good to wait with &ldquo;while True&rdquo;&hellip; There should be a time limit&hellip;)</p>
<pre><code>flowNm ='input'
frame ='//div[@id=&quot;iframeBlock&quot;]/iframe'
flowPath ='//a[@title=&quot;' + flowNm +'&quot;]'

Wait for # Loading... to finish
WebDriverWait(driver, 30).until(ec.frame_to_be_available_and_switch_to_it((By.XPATH, frame)))

#Wait until the flow is fully displayed
while True:
    # Undo the frame
    driver.switch_to.default_content()
    # Switch frame
    iframe = driver.find_element_by_xpath(frame)
    driver.switch_to_frame(iframe)

    try:
        #Exception if the flow is not displayed correctly
        WebDriverWait(driver, 1).until(ec.visibility_of_element_located((By.XPATH, flowPath)))
        break
    except:
        pass
</code></pre><p>Click the tab when it appears.</p>
<pre><code>driver.find_element_by_xpath(flowPath).click()
</code></pre><h3 id="press-the-trigger">Press the trigger</h3>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/237144/b24ee6f3-2f6e-7835-4457-500154ef3d2c.png" width="500">
This time execute the flow by clicking the button of the inject node "start".
Getting to the node can be a hassle.
<pre><code>triggerNodeNm ='start'
try:
    # move to canvas
    workspace = driver.find_element_by_id('workspace')
    chart = workspace.find_element_by_id('chart')
    canvas = chart.find_element_by_class_name('innerCanvas')
    
    Find # class = &quot;node nodegroup&quot;
    nodes = canvas.find_elements_by_css_selector('.node.nodegroup')
    # Check if the node name matches the one specified
    #If they match, press the trigger
    for node in nodes:
        nodeNm = node.find_element_by_tag_name('text').text
        if nodeNm == triggerNodeNm:
            node.find_element_by_class_name('node_button_button').click()
            break
        
except Exception as e:
    driver.quit()
</code></pre><p>Since I was able to press the trigger, I closed the screen and finished.</p>
<pre><code>driver.quit()
</code></pre><h2 id="test-result">Test result</h2>
<p>When you run the program&hellip;
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/237144/e8a58d0a-aa22-fba2-b526-3b965e93deef.png" width="500">
The CloudFunctions function has been executed!
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/237144/133d4670-4a2d-628d-e0ba-bc724faafb85.png" width="500"></p>
<h2 id="summary">Summary</h2>
<p>I was able to take advantage of the enebular flow by scraping.If the flow does not depend on the system or interface of the deployment destination, this method may be fine.
(There is a problem that it will not work if the tag or class name of the web page changes&hellip;)</p>
<p>I hope it gives you some hints. See you soon.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
