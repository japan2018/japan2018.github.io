<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>How to easily draw the structure of neural network on Google Colaboratory using convnet-drawer | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>How to easily draw the structure of neural network on Google Colaboratory using convnet-drawer</h1>
<p>
  <small class="text-secondary">
  
  
  May 23, 2020
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/deeplearning"> DeepLearning</a></code></small>


<small><code><a href="https://memotut.com/tags/hard"> Hard</a></code></small>


<small><code><a href="https://memotut.com/tags/googlecolaboratory"> GoogleColaboratory</a></code></small>

</p>
<pre><code>&lt;img width=&quot;498&quot; alt=&quot;nn-draw.png&quot; src=&quot;https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/81919/087786b6-8954-4811-b377-f781f3fe7881.png&quot;&gt;
</code></pre>
<h1 id="what-is-convnet-drawer">What is &ldquo;convnet-drawer&rdquo;?</h1>
<p>It is a software that visualizes the structure of the neural network created by @yu4u. I knew it existed before, but I hadn&rsquo;t tried it yet, so I tried it. It felt good to run on Google Colaboratory (Google Colab), so I also created a notebook that you can try easily.</p>
<p>Please refer to the following blog article for explanations about Google Colab.</p>
<p><a href="https://karaage.hatenadiary.jp/entry/2018/03/21/073000">Use of Google Colaboratory does not require environment construction and is the best to do Python machine learning for free</a></p>
<h1 id="how-to-draw-the-structure-of-a-neural-network">How to draw the structure of a neural network</h1>
<p>From here, I will introduce how to draw a neural network using &ldquo;convnet-drawer&rdquo; on Google Colab.</p>
<p>The referenced information is @yu4u&rsquo;s software code and the following article.</p>
<p><a href="https://qiita.com/yu4u/items/75ea0e5e1587f10bc014">Defining a convolutional neural network like Keras made a tool that saves architecture diagrams in PowerPoint</a></p>
<p>The link of the created Google Colab Notebook is as follows.
<a href="https://colab.research.google.com/drive/1FEsWfwMz4sYFpWJX8RoSQKpK4fNMR1q2?usp=sharing">convnet_drawer_on_google_colab.ipynb</a></p>
<p>I think that if you do the above, you can understand it, but I will briefly explain it. After that, it is a prerequisite to run on Google Colab.</p>
<p>There are two ways to draw a neural network: 2 or less.</p>
<ul>
<li>How to create a model from scratch</li>
<li>How to load a model made with Keras</li>
</ul>
<p>I will explain each.
‥</p>
<h2 id="preparation">Preparation</h2>
<p>Clone “convnet-drawer”. I&rsquo;m using the one I forked, not the original. This is because when we load a Keras model, we&rsquo;re doing a little custom to skip layers that can&rsquo;t be drawn (other than when using a Keras model that contains layers that can&rsquo;t be drawn, the original repository is OK).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">!cd /content
!git clone https://github.com/karaage0703/convnet-drawer
%cd convnet-drawer
!git checkout -b custom_keras_util origin/custom_keras_util
</code></pre></div><h2 id="how-to-make-a-model-from-0-and-visualize-it">How to make a model from 0 and visualize it</h2>
<p>First, create a model from 0 and visualize it.</p>
<p>Import the library.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> convnet_drawer <span style="color:#f92672">import</span> Model, Conv2D, MaxPooling2D, Flatten, Dense
</code></pre></div><p>Create the model. Create a model in the same way as Keras.</p>
<p>However, an unsupported layer such as an activation layer (Divout layer) or an activation layer will cause an error, so delete it or comment it out. I commented out this time.</p>
<p>The model is a small model of image recognition like used in MNIST.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">model <span style="color:#f92672">=</span> Model(input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">3</span>))

model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">32</span>, (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>))
<span style="color:#75715e"># model.add(Activation(&#39;relu&#39;))</span>
model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">64</span>, (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>)))
<span style="color:#75715e"># model.add(Activation(&#39;relu&#39;))</span>
model<span style="color:#f92672">.</span>add(MaxPooling2D(pool_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>)))
<span style="color:#75715e"># model.add(Dropout(0.25))</span>

model<span style="color:#f92672">.</span>add(Flatten())
model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">128</span>))
<span style="color:#75715e"># model.add(Activation(&#39;relu&#39;))</span>
<span style="color:#75715e"># model.add(Dropout(0.5))</span>
model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">10</span>))
<span style="color:#75715e"># model.add(Activation(&#39;softmax&#39;))</span>
</code></pre></div><p>Save the model in svg format and draw it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">model<span style="color:#f92672">.</span>save_fig(<span style="color:#e6db74">&#34;example.svg&#34;</span>)
<span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
display_svg(SVG(<span style="color:#e6db74">&#39;example.svg&#39;</span>))
</code></pre></div><p>With this, you can draw with a good feeling. It&rsquo;s the best.</p>
<img width="498" alt="nn-draw.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/81919/087786b6-8954-4811-b377-f781f3fe7881.png">
<p>If you want to draw with Matplotlib, execute the following.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">from</span> convnet_drawer <span style="color:#f92672">import</span> Line, Text

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">plot_model</span>(model):
    model<span style="color:#f92672">.</span>build()
    fig1 <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">5</span>),dpi<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>)
    ax1 <span style="color:#f92672">=</span> fig1<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">111</span>, aspect<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;equal&#39;</span>)
    ax1<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
    plt<span style="color:#f92672">.</span>xlim(model<span style="color:#f92672">.</span>x, model<span style="color:#f92672">.</span>x <span style="color:#f92672">+</span> model<span style="color:#f92672">.</span>width)
    plt<span style="color:#f92672">.</span>ylim(model<span style="color:#f92672">.</span>y <span style="color:#f92672">+</span> model<span style="color:#f92672">.</span>height, model<span style="color:#f92672">.</span>y)

    <span style="color:#66d9ef">for</span> feature_map <span style="color:#f92672">in</span> model<span style="color:#f92672">.</span>feature_maps <span style="color:#f92672">+</span> model<span style="color:#f92672">.</span>layers:
        <span style="color:#66d9ef">for</span> obj <span style="color:#f92672">in</span> feature_map<span style="color:#f92672">.</span>objects:
            <span style="color:#66d9ef">if</span> isinstance(obj, Line):
                <span style="color:#66d9ef">if</span> obj<span style="color:#f92672">.</span>dasharray <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
                    linestyle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;:&#34;</span>
                <span style="color:#66d9ef">elif</span> obj<span style="color:#f92672">.</span>dasharray <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
                    linestyle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;--&#34;</span>
                <span style="color:#66d9ef">else</span>:
                    linestyle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;-&#34;</span>
                plt<span style="color:#f92672">.</span>plot([obj<span style="color:#f92672">.</span>x1, obj<span style="color:#f92672">.</span>x2], [obj<span style="color:#f92672">.</span>y1, obj<span style="color:#f92672">.</span>y2], color<span style="color:#f92672">=</span>[c <span style="color:#f92672">/</span> <span style="color:#ae81ff">255</span> <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> obj<span style="color:#f92672">.</span>color], lw<span style="color:#f92672">=</span>obj<span style="color:#f92672">.</span>width,
                         linestyle<span style="color:#f92672">=</span>linestyle)
            <span style="color:#66d9ef">elif</span> isinstance(obj, Text):
                ax1<span style="color:#f92672">.</span>text(obj<span style="color:#f92672">.</span>x, obj<span style="color:#f92672">.</span>y, obj<span style="color:#f92672">.</span>body, horizontalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;center&#34;</span>, verticalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bottom&#34;</span>,
                         size<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> obj<span style="color:#f92672">.</span>size <span style="color:#f92672">/</span> <span style="color:#ae81ff">3</span>, color<span style="color:#f92672">=</span>[c <span style="color:#f92672">/</span> <span style="color:#ae81ff">255</span> <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> obj<span style="color:#f92672">.</span>color])
</code></pre></div><p>Draw is as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plot_model(model)
</code></pre></div><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/81919/028908a6-53f7-4c49-da6a-d9f6d062aefb.png" alt="matplotlib.png"></p>
<p>It was displayed. Adjust the size yourself.</p>
<p>If you want a manga-like style, do the following.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">with</span> plt<span style="color:#f92672">.</span>xkcd():
  plot_model(model)
</code></pre></div><p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/81919/7047b9d3-3607-18d3-ac63-77c11fa64e6e.png" alt="manga.png"></p>
<p>This is cute, isn&rsquo;t it?</p>
<h2 id="how-to-load-a-model-created-with-keras-using-keras-util">How to load a model created with Keras (using keras-util)</h2>
<p>In the comment of <a href="https://qiita.com/yu4u/items/75ea0e5e1587f10bc014">Qiita&rsquo;s article</a>, @wakame1367 discovered that PR that can read Keras model was issued in &ldquo;convnet-drawer&rdquo;. I tried.</p>
<p>Import Keras, the software that reads Keras (keras_util).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> keras_util
<span style="color:#f92672">from</span> tensorflow.python.keras.layers.convolutional <span style="color:#f92672">import</span> Conv2D, MaxPooling2D
<span style="color:#f92672">from</span> tensorflow.python.keras.models <span style="color:#f92672">import</span> Sequential
<span style="color:#f92672">from</span> tensorflow.python.keras.layers.core <span style="color:#f92672">import</span> Dense, Dropout, Activation, Flatten
</code></pre></div><p>Let&rsquo;s create a model with Keras.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">model <span style="color:#f92672">=</span> Sequential()

model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">32</span>, (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>, input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">3</span>)))
model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">64</span>, (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>)))
model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(MaxPooling2D(pool_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>)))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.25</span>))

model<span style="color:#f92672">.</span>add(Flatten())
model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">128</span>))
model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.5</span>))
model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">10</span>))
model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;softmax&#39;</span>))

model<span style="color:#f92672">.</span>compile(optimizer<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;adam&#39;</span>,
              loss<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;categorical_crossentropy&#39;</span>,
              metrics<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;accuracy&#39;</span>])
<span style="color:#e6db74">``</span><span style="color:#960050;background-color:#1e0010">`</span>Convert the model <span style="color:#66d9ef">with</span> convnet<span style="color:#f92672">-</span>drawer <span style="color:#f92672">and</span> draw<span style="color:#f92672">.</span>

<span style="color:#e6db74">``</span><span style="color:#960050;background-color:#1e0010">`</span>python
net <span style="color:#f92672">=</span> keras_util<span style="color:#f92672">.</span>convert_drawer_model(model)
net<span style="color:#f92672">.</span>save_fig(<span style="color:#e6db74">&#34;sample.svg&#34;</span>)
<span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
display_svg(SVG(<span style="color:#e6db74">&#39;sample.svg&#39;</span>))
</code></pre></div><p>I was able to draw even with the Keras model. Unsupported activation layers and Dropout layers are skipped arbitrarily.</p>
<img width="498" alt="nn-draw.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/81919/087786b6-8954-4811-b377-f781f3fe7881.png">
<p>#Summary
I briefly introduced how to move &ldquo;convnet-drawer&rdquo; with Google Colab. I&rsquo;m glad that you can visualize your small network with a good feeling.</p>
<p>However, it is difficult to visualize with the latest huge neural network, and I think that you may not understand well after visualization. I think that it is better to use it for drawing points.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
