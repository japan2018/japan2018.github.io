<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] About the shortest path to create an image recognition model by machine learning and implement an Android application | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] About the shortest path to create an image recognition model by machine learning and implement an Android application</h1>
<p>
  <small class="text-secondary">
  
  
  Nov 27, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/androidstudio">AndroidStudio</a></code></small>


<small><code><a href="https://memotut.com/tags/tensorflow">TensorFlow</a></code></small>


<small><code><a href="https://memotut.com/tags/tensorflowlite">TensorflowLite</a></code></small>


<small><code><a href="https://memotut.com/tags/googlecolaboratory">GoogleColaboratory</a></code></small>

</p>
<pre><code># Purpose of this article
</code></pre>
<ul>
<li>How to easily create an image recognition model and share it as an application</li>
</ul>
<h2 id="execution-environment">Execution environment</h2>
<ul>
<li>google colaboratory (Runtime: GPU)(tensorflow 2.0)(Google Chrome)</li>
<li>win 10</li>
<li>Android Studio (3.5.2)</li>
<li>android 9.0(Huawei mate 10 pro)</li>
</ul>
<h2 id="what-to-write-in-this-article">What to write in this article</h2>
<ul>
<li><a href="#Datasetcreationmethodforimagerecognitionmodel">Dataset creation method for image recognition model</a></li>
<li><a href="#Howtocreateimagerecognitionmodel">How to create image recognition model</a></li>
<li><a href="#Howtoloadthecreatedimagerecognitionmodelinandroid-studio">How to load the created image recognition model in Android Studio</a></li>
<li><a href="#Myfailurestory">My failure (?) story</a></li>
</ul>
<h1 id="how-to-create-dataset-for-image-recognition-model">How to create dataset for image recognition model</h1>
<p>Take the following steps</p>
<ol>
<li>Create multiple classes you want to recognize. (Here, class A, B, C)</li>
<li>Collect images of Class A, B, C</li>
<li>Class A, B, C images are divided for training and testing</li>
</ol>
<h2 id="collect-images-of-class-a-b-c">Collect images of Class A, B, C</h2>
<p>Skip if you have already collected images
If you have not collected it yet, google_image_download <a href="https://co.bsnws.net/article/295">(reference URL)</a> is convenient.
It downloads images by specifying keywords, extensions, size, number of images, etc.</p>
<ul>
<li>If you want to learn properly, cut out only the part you want to recognize the downloaded image. (It takes a lot of time, but I think it is often necessary. Please let me know if there is a good method&hellip;)</li>
</ul>
<h2 id="separate-images-of-class-a-b-c-for-training-and-testing">Separate images of class A, B, C for training and testing</h2>
<p>Divide images into good images for training and testing (training 80%: test 20%?)
Specifically, create a folder with the following structure
images
├ train
│└A
│ └a01.jpg
│ └aslfdjk.png
│&hellip;
│└B
│ └ba.jpg
│ └dskrup.png
│&hellip;
│└C
│ └ba.jpg
│ └sdddrrd.png
│&hellip;
│
├ validation
│└A
│ └fwwqd.jpg
│ └qiita.png
│&hellip;
│└B
│ └sddd.jpg
│ └reag.png
│&hellip;
│└C
│ └vtet.jpg
│ └fhyr.png
│&hellip;</p>
<h1 id="how-to-create-an-image-recognition-model">How to create an image recognition model</h1>
<p>Create the model in the following steps</p>
<ol>
<li>Use tensorflow tutorial
2.1. Train the model in to replace the data with your own</li>
<li>Tweak the model shape by considering the implementation in Android Studio and training the model</li>
<li>How to save the trained model</li>
</ol>
<h2 id="use-tutorial-of-transfer-learning-of-tensorflow">Use tutorial of transfer learning of tensorflow</h2>
<p>A code that uses the tutorial provided by tensorflow with emphasis on simplicity <a href="https://colab.research.google.com/drive/1p-MY8C_H238TWffWrRjC8cc20alZACSD">(reference URL) * When you press the URL, google colaboratory will open suddenly</a>
Please refer to <a href="https://colab.research.google.com/notebooks/welcome.ipynb?hl=ja">Official HP</a> for how to use google colaboratory.</p>
<h2 id="replace-model-training-data-with-your-own">Replace model training data with your own</h2>
<p>This part of the source code</p>
<pre><code>from google.colab import drive
drive.mount('/content/drive')
PATH ='/content/drive/'+'path to location of your dataset on google drive'
</code></pre><p>Enter this to allow access to google drive? Authentication to that effect is required. I personally don&rsquo;t mind it, so I authenticate without thinking about it, but those who are interested should stop reading their dataset with google colaborao try.</p>
<h2 id="train-the-model-by-slightly-modifying-the-model-shape-considering-the-implementation-in-android-studio">Train the model by slightly modifying the model shape considering the implementation in Android Studio</h2>
<p>This part of the source code</p>
<p>After that, the model can be trained by executing the following code cells in sequence.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
history <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>fit_generator(
    train_data_gen,
    steps_per_epoch<span style="color:#f92672">=</span>total_train <span style="color:#f92672">//</span> batch_size,
    epochs<span style="color:#f92672">=</span>epochs,
    validation_data<span style="color:#f92672">=</span>val_data_gen,
    validation_steps<span style="color:#f92672">=</span>total_val <span style="color:#f92672">//</span> batch_size
)
</code></pre></div><h2 id="how-to-save-the-trained-model">How to save the trained model</h2>
<p>only this</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">saved_model_dir <span style="color:#f92672">=</span> base_dir<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;where you want to save&#39;</span>
tf<span style="color:#f92672">.</span>saved_model<span style="color:#f92672">.</span>save(model, saved_model_dir)
</code></pre></div><h1 id="how-to-load-and-move-the-created-image-recognition-model-in-android-studio">How to load and move the created image recognition model in Android Studio</h1>
<p>Take the following steps</p>
<ol>
<li>Convert saved model to TensorFlow Lite model and save</li>
<li>Create an Android studio project</li>
<li>Load the model saved in Android studio and run the application</li>
</ol>
<h2 id="convert-saved-model-to-tensorflow-lite-model-and-save">Convert saved model to TensorFlow Lite model and save</h2>
<p>only this</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">converter <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>lite<span style="color:#f92672">.</span>TFLiteConverter<span style="color:#f92672">.</span>from_saved_model(saved_model_dir)
tflite_model <span style="color:#f92672">=</span> converter<span style="color:#f92672">.</span>convert()

<span style="color:#66d9ef">with</span> open(base_dir<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;model name.tflite&#39;</span>,<span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> f:
  f<span style="color:#f92672">.</span>write(tflite_model)
</code></pre></div><p>Download the saved model and save it locally.</p>
<h2 id="make-a-project-for-android-studio">Make a project for Android studio</h2>
<p>First, install Android studio <a href="https://developer.android.com/studio/install?hl=ja">(reference URL)</a>,
The quick start provided by tensorflow is used as an example. <a href="https://github.com/tensorflow/examples/tree/master/lite/examples/image_classification/android">Reference URL</a>
As you follow, a folder named example will be created in the local environment, so open the android project in the following path.
\examples\lite\examples\image_classification\android</p>
<h2 id="load-the-model-saved-in-android-studio-and-run-the-application">Load the model saved in Android studio and run the application</h2>
<p>Do the following steps</p>
<ol>
<li>Place the .tflite file saved locally in the asset folder</li>
<li>Put the .txt file that describes the class in the asset folder</li>
<li>Rewrite part of .ja file</li>
</ol>
<h3 id="put-tflite-file-saved-locally-in-asset-folder">Put .tflite file saved locally in asset folder</h3>
<p>Put it in the following folder.
\examples\lite\examples\image_classification\android\app\src\main\assets
There are some .tflite files in the same place.</p>
<h3 id="put-the-txt-file-that-describes-the-class-in-the-asset-folder">Put the .txt file that describes the class in the asset folder</h3>
<p>In this case, write classes A, B, and C as follows and save them in the same location as the .tflite file.</p>
<pre><code class="language-mylabel.text" data-lang="mylabel.text">A
B
C
</code></pre><h3 id="rewrite-some-java-files">Rewrite some .java files</h3>
<p>First,
\examples\lite\examples\image_classification\android\app\src\main\java\org\tensorflow\lite\examples\classification\tflite\ClassifierFloatMobileNet.java
Line 56 of</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;mobilenet_v1_1.0_224.tflite&#34;</span><span style="color:#f92672">;</span>
</code></pre></div><p>Is rewritten as</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;model name.tflite&#34;</span><span style="color:#f92672">;</span>
</code></pre></div><p>next,
\examples\lite\examples\image_classification\android\app\src\main\java\org\tensorflow\lite\examples\classification\tflite\Classifier.java
Line 110</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Classifier <span style="color:#a6e22e">create</span><span style="color:#f92672">(</span>Activity activity<span style="color:#f92672">,</span> Model model<span style="color:#f92672">,</span> Device device<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> numThreads<span style="color:#f92672">)</span>
      <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>model <span style="color:#f92672">==</span> Model<span style="color:#f92672">.</span><span style="color:#a6e22e">QUANTIZED</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ClassifierQuantizedMobileNet<span style="color:#f92672">(</span>activity<span style="color:#f92672">,</span> device<span style="color:#f92672">,</span> numThreads<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ClassifierFloatMobileNet<span style="color:#f92672">(</span>activity<span style="color:#f92672">,</span> device<span style="color:#f92672">,</span> numThreads<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
</code></pre></div><p>Is rewritten as</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Classifier <span style="color:#a6e22e">create</span><span style="color:#f92672">(</span>Activity activity<span style="color:#f92672">,</span> Model model<span style="color:#f92672">,</span> Device device<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> numThreads<span style="color:#f92672">)</span>
      <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
    <span style="color:#75715e">//if (model == Model.QUANTIZED) {
</span><span style="color:#75715e"></span>      <span style="color:#75715e">//return new ClassifierQuantizedMobileNet(activity, device, numThreads);
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//} else {
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ClassifierFloatMobileNet<span style="color:#f92672">(</span>activity<span style="color:#f92672">,</span> device<span style="color:#f92672">,</span> numThreads<span style="color:#f92672">);</span>
    <span style="color:#75715e">//}
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
</code></pre></div><p>Finally, do a make project in Android Studio.
After that, connect your smartphone to your PC and run Run&rsquo;app&rsquo;. Then, the application named TFL Classify will be installed and run on your smartphone.
At the bottom of the screen, the confidences of A, B, and C are displayed (% of how likely they are to be in that class).</p>
<p>#Myfailurestory
Of the mistakes (?) I stumbled upon, I share some that may be helpful.</p>
<h2 id="failure--1">Failure (?) 1</h2>
<p>I tried to convert the pytorch model into a tensorflow LITE model, and eventually failed.Mainly referring to these two websites, <a href="https://qiita.com/lain21/items/9f9f9707ebad4bbc627d">URL1</a>,<a href="https://heartbeat.fritz.ai/deploying-pytorch-and-keras-models-to-android-with-tensorflow-mobile-a16a1fb83f2">URL2</a>
I quit because I got an error that I didn&rsquo;t understand. I think it was because keras and tf.keras both existed. Shall I verify next time?</p>
<p>This time, anyway, I wanted to move my own model with the android application, so I created a model using the tensorflow tutorial and converted the keras model into a tensorflow LITE model as described above.</p>
<p>As described in <a href="https://qiita.com/lain21/items/9f9f9707ebad4bbc627d">URL 1</a> above</p>
<blockquote>
<p>Meanwhile, TensorFlow clearly has the following advantages over PyTorch.</p>
</blockquote>
<blockquote>
<p>Can learn using TPU
Rich APIs such as TFLite and TensorFlow.js to facilitate front-end deployment</p>
</blockquote>
<p>Currently, tensorflow seems to have more support for facilitating conversion to applications.</p>
<h2 id="failure--2">Failure (?) 2</h2>
<p>While collecting various codes, keras and tf.keras were mixed. I rewrote it to tf.keras as a man to erase keras from the middle.</p>
<h2 id="failure--3">Failure (?) 3</h2>
<p>I do not notice that the model output is one in the default tutorial code, and there is not enough output in android studio! I made a lot of errors.
I thought that the cause of the error was to make a .tflite file from keras using TFLiteConverter, so I spent a lot of time there&hellip;
After all, in <a href="https://www.tensorflow.org/lite/convert/python_api?hl=ja">this URL</a>, while trying to evaluate my own model, it became &ldquo;something wrong with the shape of the output?&rdquo; Noticed that the shape of</p>
<h2 id="failure--4">Failure (?) 4</h2>
<p>I tried to quantize the model, but gave up because it could not be read in android studio. After all, the float model was used.
I tried to quantize because the size of the model was smaller and the processing was likely to be faster, but I could not.
The cause of this is unknown.</p>
<h2 id="failure--5">Failure (?) 5</h2>
<p>In the first place, I did not decide what to use for object recognition in the first place, I was thinking about using yolo with darknet, but I did not know how to divert my own model, so I did not know how to do it and gave up. I know pytorch is easy and good! I was taught, and led to failure 1. Thinking this way, I&rsquo;m giving up right away. ． ．</p>
<h2 id="failure--6">Failure (?) 6</h2>
<p><a href="#CollectimagesofclassesA,B,C">Collect images of classes A, B, C</a> can be used to easily collect images using google_image_download! I wrote, but this is quite tough. Of course, inappropriate images are also downloaded, so it is difficult to throw them away and trim them from there, and after that, classification work is waiting.
I understand why annotations are a job in the world, but I don&rsquo;t want to do it because real MPs are likely to decrease. ． ．
There is something related to active learning as a related word, and it seems to be a method of automatically selecting an image with a higher recognition rate. It would be convenient if possible. I wonder?</p>
<h2 id="failure--7">Failure (?) 7</h2>
<p>After starting to write this article, I notice that the content of the tensorflow tutorial has changed.
Actually, the writer used the tutorial of transfer learning, but it was troublesome to publish my code, so I used the tutorial of image classification for explanation.
I think that transfer learning, which is said to improve accuracy with a small number of data, is more convenient than creating a model by yourself.
Since the current transfer learning tutorial is designed to read the data from tf, it is complicated to change and write it, so abandon it for the explanation.
I want to use my data for transfer learning! If you have a request, you may be motivated to do your best. ． ．</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
