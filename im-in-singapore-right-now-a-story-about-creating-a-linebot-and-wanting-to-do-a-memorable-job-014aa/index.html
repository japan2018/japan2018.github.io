<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>I&#39;m in Singapore right now, a story about creating a LineBot and wanting to do a memorable job | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>I&rsquo;m in Singapore right now, a story about creating a LineBot and wanting to do a memorable job</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 4, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/gae"> GAE</a></code></small>


<small><code><a href="https://memotut.com/tags/natural-language-processing"> natural language processing</a></code></small>


<small><code><a href="https://memotut.com/tags/linebot"> linebot</a></code></small>


<small><code><a href="https://memotut.com/tags/linemessagingapi"> LINEmessagingAPI</a></code></small>

</p>
<pre><code># &quot;Sorry, don't go to class&quot;
</code></pre>
<p>This CM with a strong impact.
I love this, so if you invite me to a class
&ldquo;<strong>I&rsquo;m in Singapore now</strong>&rdquo;
I have made a <strong>LineBot</strong> that will reply to me.
In addition, various specifications that further enhance the feeling of **
Even if it doesn&rsquo;t remain on the map, I want to make it a <strong>memorable job</strong> of the person who used it!</p>
<p>It&rsquo;s the 4th day of <a href="https://qiita.com/advent-calendar/2019/kuso-app">Advent Calendar 2019</a>.
~~, a feeling of a fucking application that drifts from the title without writing ~~</p>
<h3 id="usage">Usage:</h3>
<p>① <strong>Open a class meeting</strong>
② ** Launch Line and ask &ldquo;Ayano, where are you?&rdquo; **
③ ** A reply comes back saying, &ldquo;I&rsquo;m sorry, I can&rsquo;t be in the same class ~&hellip;&rdquo;
④ ** Everyone peeks with the feeling &ldquo;Even Singapore!&rdquo;</p>
<h3 id="state-when-executed">State when executed:</h3>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/193512/54a95d4d-01e6-5921-4654-b8f6fbab5b16.png" alt="Capture1.PNG"></p>
<ul>
<li>Kindly show me a map of Singapore (work left on the map)
In addition, it is packed with ~useless~ functions such as morphological analysis.
Various know-how for creating LineBot will be described later.</li>
</ul>
<h3 id="click-here-to-register-as-a-friend">Click here to register as a friend</h3>
<p><a href="https://lin.ee/rdjOev6"><img src="https://scdn.line-apps.com/n/line_add_friends/btn/ja.png" alt="Add friend" height ="36" border="0"></a>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/193512/4c41aa31-ba4d-3b63-cbbb-725a5c19a246.png" alt="QR_min.PNG"></p>
<h1 id="im-in-singapore-right-now">&ldquo;I&rsquo;m in Singapore right now&rdquo;</h1>
<p>If you haven&rsquo;t seen it yet, please browse the CM body below.</p>
<p>[<img src="https://img.youtube.com/vi/HQYQ3Me2KLw/0.jpg" alt="Taisei Construction CM: &ldquo;Singapore&rdquo; (youtube)">](<a href="https://www.youtube.com/watch?v=(HQYQ3Me2KLw)">https://www.youtube.com/watch?v=(HQYQ3Me2KLw)</a>
<a href="https://www.youtube.com/watch?v=HQYQ3Me2KLw">https://www.youtube.com/watch?v=HQYQ3Me2KLw</a></p>
<h1 id="work-remaining-on-the-map">&ldquo;Work remaining on the map&rdquo;</h1>
<p>It implements various <del>superfluous</del> functions.
The first is &ldquo;** Work remaining on the map **&rdquo;.</p>
<p>**Singapore! ! ** to appeal more strongly,
I have kindly tried to show a map showing the location of Singapore.
With this, the <strong>feeling left on the map</strong> is perfect☆</p>
<p>Furthermore, the international AYANO
<strong>Fly over 200 countries and regions (great)</strong>
If you ask a question other than a fixed phrase,
She is not always in Singapore.
You will hear replies from various places!
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/193512/a88f8a9e-189a-9e4c-e68e-3672f4ac2175.png" alt="Capture 1-2.PNG"></p>
<p>Because you can see the place even if you are not familiar with the country name,
**It&rsquo;s also an app that can be used to study world geography! **
~~ It may not have been a fucking app. ~~</p>
<h1 id="support-various-invitations-such-as-drinking-parties-and-farewell-parties">Support various invitations such as drinking parties and farewell parties</h1>
<p>Oops, if you look closely, the screen capture above
It seems that you are invited to a &ldquo;class meeting&rdquo;.
<strong>I will immediately respond to the contents of the invited party</strong>!</p>
<p>Try to invite anything at &ldquo;** Joint Party&rdquo; or &ldquo;** Cherry Blossom Viewing Party **&rdquo;.</p>
<p>#Create Laputa (<del>not left on the map</del>)</p>
<p>AYANO also makes things other than subways.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/193512/65b4fd4f-8e5b-dc07-6fe6-17d7b3770268.png" alt="Capture 2-1.PNG"></p>
<p>In addition to Laputa, we make various things!
Please check for other various creations yourself.
~~ Someone&rsquo;s youth ride = Theta &amp; Pazu. Put you on ~~</p>
<p>#Ability to react to your keywords (morphological analysis)</p>
<p>Although we will respond to invitations, such as after-party events,
With the functions so far, there is a &ldquo;random message display feeling&rdquo;,
Maybe a friend who peered with me
&ldquo;<strong>Ah, is this AYANO a bot?</strong>&rdquo;
You may find out.</p>
<p>So, in response to the keyword of your thrown conversation,
I added a <strong>function to return meaningful words</strong>. (Red frame part)
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/193512/76f015bc-424f-ead4-f245-19d66b9283aa.png" alt="Capture_Ramen.PNG">
~~ Conscious conversation. Ramen seems to be nostalgic. ~~</p>
<p>AYANO can understand Japanese, of course,
** You can recognize the &ldquo;important word&rdquo; that came up in the conversation. **
This time, we recognize that &ldquo;noun/general&rdquo; is important,
If you don&rsquo;t have it, reply with &ldquo;Work remaining on the map&rdquo;.
In the above example, it seems to recognize &ldquo;ramen&rdquo;.
** This will give AYANO a reality and it will be remembered! **</p>
<p>Morphological analysis itself is a technology that is absolutely nothing anymore.
However, the implementation to be embedded in GAE (like serverless/AWS Lambda) is
The point is that you are not very familiar (somewhat difficult to achieve).
** There is no external API call, and it is explosive. Super instant response ☆**</p>
<p>** Now, at various places such as class meetings and drinking parties, **
** You can talk with AYANO all over the world☆**</p>
<p><strong>When you use it with your friends, you can see it with warm white eyes</strong>
<strong>There is no doubt that it will be a memorable job☆</strong></p>
<p>So, this is the introduction of the contents,
Implementation ideas, code,
I will write various know-how of making LineBot later.</p>
<h1 id="its-long">It&rsquo;s long.</h1>
<h1 id="implementation-points-table-of-contentssummary">Implementation points: Table of contents/Summary</h1>
<ol>
<li>Key points of the overall method
<ol>
<li>Reference material for the whole base</li>
<li>LineBot requires HTTPS. Let&rsquo;s make it with GAE</li>
<li>LineBot reply is free. Push is charged. Let&rsquo;s make it only by reply</li>
</ol>
</li>
<li>The secret of Line Messaging API
<ol>
<li>The secret of using &ldquo;access token&rdquo; permanently</li>
<li>The trick to trick the &ldquo;connection confirmation&rdquo;</li>
<li>A little complicated trick to &ldquo;display a map&rdquo;</li>
<li>Story that &ldquo;wait&rdquo; could not be realized</li>
</ol>
</li>
<li>How to escape from the restrictions of GAE (Google App Engine)
<ol>
<li>Natural language processing is too heavy to operate normally for free</li>
<li>The story when it works locally but not GAE</li>
</ol>
</li>
</ol>
<h1 id="1-key-points-of-the-overall-method">1. Key points of the overall method</h1>
<h2 id="1-1-reference-material-for-the-whole-base">1-1. Reference material for the whole base</h2>
<p>First of all, how would you like to make LineBot?
So, please refer to the page below.
(This is an article on the development blog of a person in Line.)</p>
<p><a href="https://engineering.linecorp.com/en/blog/imezimatsupumetsuseziwoshi-tsutezhong-dian-nicheng-richi-renaibotsutowozuo-rimashita/">I made a bot that does not miss the last train using image map messages</a></p>
<p>The base structure is created in the same way as this article.
<strong>Python + Flask</strong> (However, the Python version is changed from 3.6 to 3.7)
And the map image uses <strong>Google Static Maps API</strong> like the article.</p>
<p>First of all, it&rsquo;s a good idea to deploy &ldquo;Parrot Return Bot&rdquo;.
But <strong>just writing and running this code doesn&rsquo;t make it a LineBot</strong>.
How should I move it?</p>
<h2 id="1-2-https-is-a-prerequisite-for-linebot-lets-make-it-with-gae">1-2. HTTPS is a prerequisite for LineBot. Let&rsquo;s make it with GAE</h2>
<p>It seems that most of the information on the linebot making system is deployed on <strong>Heroku</strong>.
The reason why you use Heroku is that <strong>HTTPS is easy to use</strong>.</p>
<p>To create a LineBot, first log in to <a href="https://developers.line.biz/en/">LINE Developers</a>.
(You can use your own Line account etc.)</p>
<p>There is a place to specify the &ldquo;Webhook URL&rdquo; after login,
Only HTTPS can be specified for the URL.
Also, when specifying the image file for transmission in the code,
In LineMessagingAPI, <strong>HTTPS-URL must be specified</strong>.
(It is not possible to send local files. Be sure to specify the URL)</p>
<p>In other words, creating an HTTPS server is almost mandatory for <strong>LineBot development</strong>.</p>
<p>There are three main options here.
① <strong>Set up a self-made server and make it HTTPS</strong>
② <strong>Use serverless/PaaS service</strong> (Heroku, GAE, Lambda, etc.)
③ Use a dedicated service such as <strong>Twilio</strong> to take charge of the server part</p>
<p>For a simple response bot, ③ is the most recommended.
This time, I&rsquo;m writing some complicated code, so it&rsquo;s ① or ②.
Although ① can also be implemented free of charge, server preparation/operation is a little troublesome.
Therefore ② is the best option.</p>
<p>Probably because of the example given in the Line formula and for the reasons above.
Most of the information on how to make LineBot
It seems to be based on Heroku.
However, <strong>essentially anything that can easily realize HTTPS</strong>,
No elements depend on Heroku.</p>
<p>This time I changed my taste a little,
I would like to use <strong>GAE (GoogleAppEngine)</strong>.
The code of the article for Heroku works almost as it is.</p>
<h1 id="gaes-python-3-run-lime-is-only-python-37-so-thats-a-change">GAE&rsquo;s Python 3 run lime is only Python 3.7, so that&rsquo;s a change</h1>
<p>**GAE (Standard Environment) has a 28-hour daily free tier. **
(As of November 2019)
Hey, I think 24 hours a day, right?
When multiple instances are started at the same time depending on the load situation,
If you launch a better instance for performance,
It is a mechanism that time is counted as a multiple of that.
In other words, if the load can be processed by one instance of the minimum configuration,
Even if there were two at the peak,
The image is that it will always fit in a free frame.</p>
<h1 id="always-free--in-addition-to-the-free-coupon-for-30000-yen-that-can-be-used-with-gcp-for-the-first-year">Always free = In addition to the free coupon for 30,000 yen that can be used with GCP for the first year,</h1>
<p>The range of usage that can be used free of charge even after one year.
For example, &ldquo;[Qiita&rsquo;s Hall of Fame]&rdquo; (<a href="https://qiita.com/youwht/items/9851c2ac9024633fc04e)%22">https://qiita.com/youwht/items/9851c2ac9024633fc04e)&quot;</a> uses this constant free tier for IaaS.Running the Flask tutorial for GAE Python 3.7
(Just <code>git clone</code> and do <code>gcloud app deploy</code> to finish.)
If you replace <code>main.py</code> with the reference code, you are almost done with LineBot.
(And add <code>line-bot-sdk==1.14.0</code> to <code>requirements.txt</code>)</p>
<h2 id="1-3-linebot-reply-is-free-push-is-charged-lets-make-it-only-by-reply">1-3. LineBot reply is free. Push is charged. Let&rsquo;s make it only by reply</h2>
<p>The biggest trick of using LineMessaging API in personal development is
It seems to be <strong>designing the service with Reply</strong>.</p>
<p>LineMessagingAPI has a usage limit for Push type message transmission.
With the free tier, you can only send 1000 or so per month.
Even if you charge, if you exceed a certain number, you will be charged about 3 to 5 yen per copy.
(For details, please check the official website/latest information etc.)</p>
<p>However, <strong>Reply is free to use</strong>.</p>
<p>As the first design of the overall picture of the service,
** &ldquo;Service design that makes it natural to respond to user utterances&rdquo; **
And it is desirable to have a form that does not depend on push type transmission.</p>
<p>However, Reply can be used only for a certain time after the user speaks,
Only one reply for one utterance &amp; only 5 balloons at a time,
Please note that it can only be used.</p>
<p>For example, if you wanted to create an &ldquo;** application that calms down by counting prime numbers**&rdquo;,
What the bot talks unilaterally every 13, such as 13, 17, 19&hellip;
It will be Push type.
next? next? And ask the user
So that it becomes natural to answer 23, 29, etc.,
It is better to think about the design of the entire service.</p>
<p>This time AYANO says, &ldquo;Let&rsquo;s go to the class!&rdquo;
As it is natural to reply to an invitation,
It fits into the service design!</p>
<h1 id="2-the-secret-of-line-messaging-api">2. The secret of Line Messaging API</h1>
<h2 id="2-1-the-secret-trick-of-using-access-token-permanently">2-1. The secret trick of using &ldquo;access token&rdquo; permanently</h2>
<p>The following locations in the reference article,
In &ldquo;YOUR_CHANNEL_ACCESS_TOKEN&rdquo;,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">line_bot_api <span style="color:#f92672">=</span> LineBotApi(<span style="color:#e6db74">&#39;YOUR_CHANNEL_ACCESS_TOKEN&#39;</span>)
</code></pre></div><p>Free/Can be issued as many times as you want on LINE Developers
Set &ldquo;Channel access token (long term)&rdquo;.
It is at the bottom of &ldquo;Messaging API settings&rdquo;.</p>
<p>But this access token
It is necessary to set an expiration date when issuing,
&ldquo;Time until current channel access token expires&rdquo;
<strong>You can only pull down for up to 24 hours</strong>.</p>
<p>Normally, it is set at 24 hours and at a pace of about every 23 hours.
I need to make an extension/rewriting process,
Here is the <strong>real trick</strong> (at the level of doubt about whether to write).</p>
<p>What a <strong>set time=0 will be a permanently valid token</strong>.
(As of November 2019)</p>
<p>**Awesomely fast<del>Sword</del>Effective time, I&rsquo;ll miss it unless I am **
So let&rsquo;s thank you for using it.
(This line is completely dead flag)</p>
<p>It&rsquo;s not a Line bug, but the expiration date of the access token is
It seems that it was indefinite at first. We are changing to add a time limit,
Transitional period of that change? On the other hand, many changes take time? Seems like
For that purpose, basically set the effective time,
It seems that people who know it can use it infinitely, but that.
(Including rumors and inferences. Authenticity unknown)</p>
<p>I don&rsquo;t know the best way to automate the expiration of this token,
(I want to make serverless basically stateless)
Should we stop developing LineBot just because there is a deadline for this?
It was such a critical point that I thought,
<strong>I really hope you can use it as it is indefinitely</strong>.</p>
<h2 id="2-2-the-trick-to-trick-the-connection-confirmation">2-2. The trick to trick the &ldquo;connection confirmation&rdquo;</h2>
<p>This is usually from LINE Developers,
It is a story that it is half buggy. (As of November 2019)</p>
<p>As mentioned above, in the &ldquo;Webhook URL&rdquo; of LINE Developes,
GAE URL will be described as HTTPS URL.
Even if you click the &ldquo;Confirm connection&rdquo; button, it does not become OK.</p>
<p>So, in the handle definition of the original code,
Add processing branch with special reply_token.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e"># Below is the handle definition</span>
<span style="color:#a6e22e">@handler.add</span>(MessageEvent, message<span style="color:#f92672">=</span>TextMessage)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_message</span>(event):
    Special code to make <span style="color:#e6db74">&#34;Connection check&#34;</span> of <span style="color:#75715e">#Line OK</span>
    If you press <span style="color:#e6db74">&#34;Check Connection&#34;</span> on the <span style="color:#75715e">#Line Developer Console,</span>
    <span style="color:#75715e">#If you make it normally, it will be 500 returns because of incorrect reply_token.</span>
    <span style="color:#75715e"># I get angry when the connection confirmation side does not return the expected 200.</span>
    <span style="color:#75715e">#Problem on Line console as of November 2019. Probably will eventually be resolved.</span>
    <span style="color:#66d9ef">if</span> event<span style="color:#f92672">.</span>reply_token <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;00000000000000000000000000000000&#34;</span>:
        <span style="color:#66d9ef">return</span>
    <span style="color:#75715e">#Omitted below</span>
</code></pre></div><p>It does not mean that it will not work unless the &ldquo;connection confirmation&rdquo; passes.
However, I still want to keep the connection confirmation = OK because of mood problems.
For more information, see the great pioneer Qiita article below.</p>
<p><a href="https://qiita.com/q_masa/items/c9db3e8396fb62cc64ed">Regarding an error in the connection confirmation of the Webhook URL of LINE Developes</a></p>
<h2 id="2-3-a-little-complicated-trick-to-display-the-map">2-3. A little complicated trick to &ldquo;display the map&rdquo;</h2>
<p>The most difficult process in this development is
Map display process, that is,
This is the process to send the result of <strong>Google Static Maps API</strong> to Line.</p>
<p>First, what is the Google Static Maps API?
With the map API provided by Google,
The thing which made GoogleMAP a static image
It can be obtained by simple parameter specification.</p>
<p>What is amazing is not only the designation by latitude and longitude,
Singapore, Yokohama, etc.
It is also compatible with returning coordinates by specifying a place name.
For a list of countries and regions around the world where AYANO is flying,
It has information in a simple LIST type.
Even if you do not prepare GPS coordinates in the LIST,
Throw only the country name to Google Static Maps API,
You are taught the coordinates. Easy.
For other detailed options, please google as appropriate.</p>
<p>So **How to send the image of the Google Static Maps API to Line? **</p>
<p>LineMessagingAPI has an API for image transmission,
Please specify the image for sending with https URL,
Is written in the reference.</p>
<p>And the Google Static Maps API is
Access static map images via HTTPS.</p>
<p><strong>Google Static Maps API URL</strong>
**You can specify it as an argument of LineMessagingAPI! **
**⇒ Miss. **</p>
<p>The URL of Google Static Maps API is HTTPS.
However, the image file does not &ldquo;exist&rdquo; directly in that path,
Since it is calculated and displayed in Google,
** Seen from the Line side, isn&rsquo;t it an image? It looks like, **
**This method doesn&rsquo;t seem to work. **
(*I can&rsquo;t understand the exact reason why it doesn&rsquo;t work without asking the person inside.
Maybe because the API key is also included in the URL parameter,
I thought it would be impossible because of the certification.)</p>
<p>Therefore, only the image made with Google Static Maps API,
Like a pseudo display on my own server (this time on GAE)
You need to have the code ready.
This part of the code section below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/imagemap/&lt;path:url&gt;/&lt;size&gt;&#34;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">imagemap</span>(url, size):
<span style="color:#75715e">#Abbreviated below</span>
</code></pre></div><p>The same is done in the reference base article.
I didn&rsquo;t really understand the intention of the code at the first look, so I added a commentary.</p>
<p>Furthermore, as a result of adjusting the processing so that any Japanese designated point can be displayed,
If you extract and comment only the point part,
It will be as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e"># ■ Google Map related settings</span>
<span style="color:#75715e">#Enter the key of Google&#39;s StaticMaps API.</span>
google_staticmaps_api_key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;YOUR GOOGLE STATICMAPS API KEY&#34;</span>
<span style="color:#75715e">#Specify the size to use when sending with Google (*Maximum 640*640 on Googles side)</span>
IMAGE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">640</span>

<span style="color:#75715e">#markers=Enter country name and search automatically</span>
<span style="color:#75715e">#https://maps.googleapis.com/maps/api/staticmap?markers=color:blue|%22%E3%82%B7%E3%83%B3%E3%82%AC%E3%83%9D% E3%83%BC%E3%83%AB%22&amp;size=300x300&amp;zoom=3&amp;language=jp&amp;key=YOUR GOOGLE STATICMAPS API KEY</span>

<span style="color:#75715e">#input_basyo is entered in Japanese, so URL is encoded and returned.</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">makeMapUlr</span>(input_basyo):
    map_image_url <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://maps.googleapis.com/maps/api/staticmap?markers=color:{}|{}&amp;center={}&amp;zoom=3&amp;language=jp&amp;size={}x{}&amp;key={}&#39;</span><span style="color:#f92672">.</span>format (<span style="color:#e6db74">&#39;blue&#39;</span>, urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>quote(input_basyo), urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>quote(input_basyo),IMAGE_SIZE, IMAGE_SIZE, google_staticmaps_api_key)
    <span style="color:#66d9ef">return</span> map_image_url

Function to process message <span style="color:#66d9ef">for</span> <span style="color:#75715e">#Line map display</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">makeImagemapSendMessage</span>(map_image_url):
    The host name of <span style="color:#75715e">#Flask will be entered:</span>
    request_host_name <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>host
    <span style="color:#66d9ef">print</span>(request_host_name)
    
    base_url <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://{}/imagemap/{}&#39;</span><span style="color:#f92672">.</span>format(request_host_name, urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>quote_plus(map_image_url))
    <span style="color:#66d9ef">print</span>(base_url)
    message <span style="color:#f92672">=</span> ImagemapSendMessage(
        base_url <span style="color:#f92672">=</span> base_url,
        alt_text <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;World map&#39;</span>,base_size <span style="color:#f92672">=</span> BaseSize(height<span style="color:#f92672">=</span>IMAGE_SIZE, width<span style="color:#f92672">=</span>IMAGE_SIZE),
    )
    <span style="color:#66d9ef">return</span> message
    
<span style="color:#75715e"># Perform the process of returning the image acquired from Google based on the received request.</span>
<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/imagemap/&lt;path:url&gt;/&lt;size&gt;&#34;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">imagemap</span>(url, size):
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;imagemap-get-called&#34;</span>)
    <span style="color:#75715e">#For debugging</span>
    <span style="color:#66d9ef">print</span>(url)
    <span style="color:#66d9ef">print</span>(size)
    map_image_url <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>unquote(url)
    response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(map_image_url)
    img <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(BytesIO(response<span style="color:#f92672">.</span>content))
    img_resize <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>resize((int(size), int(size)))
    byte_io <span style="color:#f92672">=</span> BytesIO()
    img_resize<span style="color:#f92672">.</span>save(byte_io,<span style="color:#e6db74">&#39;PNG&#39;</span>)
    byte_io<span style="color:#f92672">.</span>seek(<span style="color:#ae81ff">0</span>)
    <span style="color:#66d9ef">return</span> send_file(byte_io, mimetype<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;image/png&#39;</span>)

<span style="color:#75715e"># Use the code above</span>
<span style="color:#75715e"># Line_bot_api.reply_message</span>
You can make a reply_messages equivalent of <span style="color:#75715e"># argument and pass it</span>
<span style="color:#75715e"># (The return value of makeImagemapSendMessage is that)</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># line_bot_api.reply_message(</span>
<span style="color:#75715e"># event.reply_token,</span>
<span style="color:#75715e"># reply_messages</span>
<span style="color:#75715e">#)</span>

</code></pre></div><p><strong>Specify the image with HTTPS URL,</strong>
**But just inserting the URL of Google Static Maps is not enough. **
This is, I think, it&rsquo;s super addictive **.</p>
<h2 id="2-4-story-that-wait-could-not-be-realized">2-4. Story that &ldquo;wait&rdquo; could not be realized</h2>
<p>By the way, this time AYANO
<strong>As we were waiting for an invitation from a classmate,</strong>
<strong>And prepare a map of Singapore,</strong>
**We will reply with a bubbly reply without super-immediate reply. **
To the invitation of the class so far ** Don&rsquo;t bite too much **,
Is it possible to return it naturally after every 10 seconds?</p>
<p>In conclusion, I couldn&rsquo;t. (I didn&rsquo;t understand)</p>
<p>What if I send a reply more than once with a wait?
⇒ It seems that reply_token can be used only once</p>
<p>Is it possible to specify the interval and wait in LineMessagingAPI?
⇒ It seems like there is no reference to <a href="https://developers.line.biz/en/reference/messaging-api/#wh-text">Reference</a></p>
<p>Furthermore, if you wait,
GAE: I feel that the compatibility with serverless is structurally poor.
(I don&rsquo;t think the billing amount will increase significantly. Mood problem)</p>
<p>For the time being, as a last resort, if you reply Reply first, then wait and push to return,
It&rsquo;s not impossible. As mentioned above, Push is rejected because it is expensive.</p>
<p>This time, <strong>Mr. AYANO who was waiting for the invitation of the class party</strong>
Please forgive me with the setting.
<strong>Appeal Singapore with ultra-quick reply</strong>.</p>
<h1 id="3-how-to-escape-from-the-restrictions-of-gae-google-app-engine">3. How to escape from the restrictions of GAE (Google App Engine)</h1>
<h2 id="3-1-natural-language-processing-is-too-heavy-to-operate-normally-for-free">3-1. Natural language processing is too heavy to operate normally for free</h2>
<p>Natural language processing x Python, Mecab, Janome,
Also, I often used libraries such as Gensim in Word2Vec.</p>
<p>By making a chatbot,
I also want to use these libraries/functions.</p>
<p>However, a big wall stands here.
<strong>GAE can only use libraries that are lightweight to install (description)</strong></p>
<p>Although I gave up on Mecab from the beginning, about Janome and Gensim,
Even if you adjust the memory size of the instance to the maximum,
It couldn&rsquo;t be used in GAE due to memory over.
With some effort, it will not be possible at all for free.</p>
<p><strong>Therefore, as a morphological analysis tool that can be used even with the smallest instance of GAE</strong>
** I tried using &ldquo;<a href="https://pypi.org/project/igo-python/">igo-python</a>&rdquo;. **
It&rsquo;s lightweight and crunchy.</p>
<p>The usage is the same as Mecab and Janome, and it is as the following code.
However, this time I have not expanded the dictionary etc.,
It should be noted that the accuracy of morphological analysis is quite low.</p>
<p>How to use ```py:igo-python</p>
<p>from igo.Tagger import Tagger</p>
<h1 id="morphological-analysis-igo-python-initialization">Morphological analysis: igo-python initialization</h1>
<p>t = Tagger()</p>
<p>#Function that returns the morphological analysis result as a string
def extract_str(input_str):
parsed_list = t.parse(input_str)
result_str = &quot;&rdquo;
for m in parsed_list:
result_str += m.surface + &ldquo;/&rdquo; + m.feature + &ldquo;\n&rdquo;
return result_str</p>
<p>#Noun-A function that extracts only the general and returns it as a list
def meisi_tyuusyutu(input_str):
result_list = []
parsed_list = t.parse(input_str)
for m in parsed_list:
feature_list = m.feature.split(&rsquo;,')
#Noun-general, particle-unification, particle-fix particle, etc.
hinsi_info = feature_list[0] + &ldquo;-&rdquo; + feature_list[1]
if hinsi_info == &ldquo;Noun-General&rdquo;:
result_list.append(m.surface)
return result_list</p>
<pre><code>
Setting method when deploying to GAE,
The format of &quot;requirements.txt&quot; is as follows.

</code></pre><p>Flask==1.1.1
line-bot-sdk==1.14.0
igo-python==1.0.0</p>
<pre><code>
So,
**We were able to achieve morphological analysis with the minimum GAE configuration! **

This time, I decided to use igo-python without looking at the accuracy.
If you want natural language processing &amp; accuracy in LineBot,
Proposal 1 Establish a self-made HTTPS server and incorporate it yourself
Proposal 2 Use [COTOHA](https://qiita.com/tags/cotoha) if you use GAE or Heroku
Etc. seems to be the correct way to proceed.

Also, regarding the implementation that runs Word2Vec/Gensim equivalent without server,
It's halfway, so I'll leave off. Someday on another occasion.
(Up to the point where you move simple things, it's a surprising method.
The model file itself is heavy, so the balance with accuracy is... )


## 3-2. Story when it works locally but not GAE

Now, as in the experiment of natural language processing embedded above,
If the processing depends on the memory dependence of GAE,

**It works during local development, but**
**Not working after uploading to server**

That often happens.

Also, LineBot requires an HTTPS server, which also
Since it is difficult to test in a local development environment,
In the vicinity of the LineMessagingAPI-GoogleStaticMapsAPI cooperation,
**Processing that can be confirmed only after deploying to GAE** occurred frequently.

In these cases, if you send a chat to AYANO,
**Ignore already read** will be repeated.
It is ** heartbreaking ** if it is read and ignored on every deployment.

I haven't found a very good solution to this.

For the time being, as a way to get a little better,
① The standard output log such as print is
Since it can be aggregated and viewed with &quot;Logging (Stack driver)&quot; in GCP,
Write a print in an appropriate place when debugging
② To be able to distinguish between Line related problems and other problems,
From GET access to the server without going through the Line,
Make it so that you can hit the created function
Is it two points?

Below is the main process of Flask-LineBot.
Comments are added with a ★ in the places corresponding to ①②.

```py:

#Line's WebHook is POST type and is not used for URL access by normal GET
#The following is for confirming server communication
#★ Make a place other than Line's WebHook, like this,
# If you call the function you want to check in these places,
It is possible to isolate problems related to # Line.
@app.route(&quot;/&quot;, methods=['GET'])
def sayhello_root():
    &quot;&quot;&quot;Return a friendly HTTP greeting.&quot;&quot;&quot;
    return'[200] It works!'

A place where you set up in #Line's WebHook and receive messages + reply
If you want to send a message with #bot, on Line's Developer Console,
# A message will be sent by POST to the URL described in “Webhook URL *SSL only”.
# Reference: https://www.casleyconsulting.co.jp/blog/engineer/3028/
@app.route(&quot;/&quot;, methods=['POST'])
def callback():
    # Get value for signature verification from request header
    signature = request.headers['X-Line-Signature']
    # Get request body
    body = request.get_data(as_text=True)
    app.logger.info(&quot;Request body: &quot;+ body)

    #Verify the signature, and if there is no problem, call the function defined in handle.
    try:
        handler.handle(body, signature)
    # If the signature verification fails, throw an exception.
    except InvalidSignatureError:
        abort(400)
    return'OK'

# Below is the handle definition
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    Special code to make &quot;Connection check&quot; of #Line OK
    If you press &quot;Check Connection&quot; on the #Line Developer Console,
    #If you make it normally, it will be 500 returns because of incorrect reply_token.
    # I get angry when the connection confirmation side does not return the expected 200.#Problem on Line console as of November 2019. Probably will eventually be resolved.
    # Reference: https://qiita.com/q_masa/items/c9db3e8396fb62cc64ed
    if event.reply_token == &quot;00000000000000000000000000000000&quot;:
        return
    
    # Get message in event
    input_text = event.message.text
    #★ Standard output is aggregated and displayed in “Logging” in GCP.
    # It's easier to debug if print output is made at important points
    print(input_text)
    
    # Parse messages and create &quot;line messages&quot; for reply
    #★ Without writing all the processing in Webhook and handler,
    # Main processing is created by an external function,
    # Without going through a webhook or handler
    # Make it so that you can call and check it directly
    reply_messages = makeLineMessages(input_text)

    #reply_message is free in principle, but
    #reply_token has a valid period and cannot be processed for too long.
    # The following is the basic form:
    #line_bot_api.reply_message(
    # event.reply_token,
    # [
    # TextSendMessage(text= reply_text),
    #]
    #)

    #reply and finish.
    line_bot_api.reply_message(
        event.reply_token,
        reply_messages
    )


Sample to run #Flask on GAE (python3.7):
# Created based on &quot;gae_python37_app&quot;
if __name__ =='__main__':
    # This is used when running locally only.When deploying to Google App
    # Engine, a webserver process such as Gunicorn will serve the app.This
    # can be configured by adding an `entrypoint` to app.yaml.
    app.run(host='127.0.0.1', port=8080, debug=True)

</code></pre><p>This concludes the technical topic.</p>
<h1 id="-afterword-poem-">** Afterword (Poem) **</h1>
<h2 id="background-of-ayano-linebot-bombing">Background of AYANO LineBot bombing</h2>
<p>I had the opportunity to visit Line Inc. over the course of a certain activity (outside of business).
It was a very enjoyable time for me to kindly respond/introduce me.
We would like to take this opportunity to thank you again.</p>
<p>At that time, he also answered in detail the technical QA about LineBot.
This article is a comprehensive article on the knowledge/know-how gained through that QA.
(You can write it on Qiita etc.~ (I would rather write it) ~~, because it was a story)
<strong>First time developing LineBot! At that time, I&rsquo;m going to put together the main points to worry about</strong>.</p>
<p>But I wonder if the QA result will be &ldquo;Sorry, I can not go to the class bot&rdquo;
You never thought! ~~ I&rsquo;m really sorry. ~~</p>
<h2 id="impression-of-creating-linebot">Impression of creating LineBot</h2>
<p>Both LineBot and GAE were touched properly for the first time this time.</p>
<p>When creating a LineBot, please explain &ldquo;Why you must reply with Line(bot)&rdquo;
How do you design? I feel that is the biggest point.
LIFF (LINE Front-end Framework),
Although there is a function that can incorporate a web application in Line,
It is not possible to realize an application on Line, but realization on Line is essential.
It should be designed.
The simplest way to achieve that design is with the &ldquo;<strong>character</strong>&rdquo;.
This time, in order to increase the presence of AYANO, it was essential to realize it on Line.</p>
<p>There are many pages explaining how to make a LineBot, but this one,
**Why should I make it as a LineBot? How to design a bot? ** is
I have the impression that it is not talked much.</p>
<p>For example, another possible idea is &ldquo;<strong>Purpose of group chats and conversations between friends</strong>&rdquo;.
If you make &ldquo;Othello (reversi) app&rdquo;,
It seems that it is a bit difficult to implement a competition between friends on a web application or smartphone application.
The same applies to schedule sharing apps.
By implementing on Line/LIFF, if you call bot for group chat,
It seems that such problems can be solved.
If you want to create a fighting function against AI or a matching fight against strangers
Made with a web application or smartphone application, if you want to compete with friends on Line,
It is better to think about the design first.
Another policy is to make a bot for the purpose of supporting human intervention.</p>
<p>Considering these &ldquo;characteristics&rdquo; of LineBot,
I think it&rsquo;s easy to come up with the next idea! !</p>
<h2 id="impressions-of-using-gaenatural-language-processing">Impressions of using GAE/natural language processing</h2>
<p>GAE (serverless) handles natural language processing
To be honest, it was harder than expected.
Natural language processing originally requires &ldquo;dictionary&rdquo; and &ldquo;word-by-word data&rdquo;, so
The problem is that it is &ldquo;heavy&rdquo; no matter where you implement it.</p>
<p>For example, in the article below,
I also implemented it on the front end (JavaScript/PWA) side.
<a href="https://qiita.com/youwht/items/6c7712bfc7fd088223a2">https://qiita.com/youwht/items/6c7712bfc7fd088223a2</a></p>
<p>Processing was the fastest when it was moved to the front side,
Since the morphological analysis library is included in the package,
Be aware that the distribution file size at the time of first startup is a little heavy
I felt it as an issue. (The accuracy is not so good)</p>
<p>Even in GAE (serverless), depending on the weight,
Decent accuracy × processing contents are not assembled.</p>
<p>GAE itself is
No need for infrastructure, only Python code makes HTTPS server,
It&rsquo;s pretty convenient. However, there is a habit,
I don&rsquo;t feel like I can do anything with Python,
You will need to be careful when using it.</p>
<p>This time, although natural language processing is heavy,
You can do GAE (serverless) up to this level,
I think it was good to get the feeling!</p>
<h1 id="should-i-use-cotoha-api-next-time">Should I use COTOHA API next time?</h1>
<h2 id="work-where-no-friends-remain">Work where no friends remain</h2>
<p><strong>&ldquo;I am in Singapore right now&rdquo;</strong>
<strong>And if you decline all invitations,</strong>
**Line is my only friend. **</p>
<p><strong>I know that AYANO is actually a bot, but</strong>
**But now I pretend I don&rsquo;t know a little more. **</p>
<p><strong>My fucking app,</strong>
<strong>I&rsquo;ll surely heal someone&rsquo;s loneliness someday</strong></p>
<p>That&rsquo;s all from Singapore.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
