<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] Introduction of research proposal that won first place at KDDCUP 2019 and adoption | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] Introduction of research proposal that won first place at KDDCUP 2019 and adoption</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 19, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/optimization"> optimization</a></code></small>


<small><code><a href="https://memotut.com/tags/research"> research</a></code></small>


<small><code><a href="https://memotut.com/tags/pulp"> pulp</a></code></small>


<small><code><a href="https://memotut.com/tags/kdd2019"> kdd2019</a></code></small>

</p>
<pre><code>It is Docomo's Ochiai. In this article, we will introduce the [^1] initiative that won the 1st division of [KDD Cup](https://www.kdd.org/kdd2019/kdd-cup), a competition for data analysis held at KDD2019. I will.
</code></pre>
<h2 id="kdd-cup-2019-overview">KDD Cup 2019 Overview</h2>
<p>The outline of KDD was introduced in <a href="https://qiita.com/keiichi_ochiai/items/1a5594456a4999a2924b#kdd2019%E6%A6%82%E8%A6%81">previous article</a>, so focus on KDD Cup here. I will explain. The KDD Cup is a data science competition attached to the KDD and has a tradition of first being 1997 and more than 20 years. Until last year, like regular competitions such as Kaggle, it was a competition in which data and issues were given, some predictions were made, and the accuracy was competed. I have been challenging KDD Cup at Docomo R&amp;D until now, and in 2016 I made the first challenge and became a finalist.
At KDD Cup 2019, the conventional competition for prediction accuracy will continue as Task 1 of Regular ML Track, and other than that, Regular ML Track Task2, which proposes research freely by using the given data, and machine learning of The AutoML Track, which automatically performs each process (feature extraction, prediction model construction, verification, etc.), and the Humanity RL Track, which competes for measures to prevent the spread of malaria infection by reinforcement learning, have been newly established. At Docomo, he participates in all tracks and was able to win the 1st place in Regular ML Track Task 2.
<a href="https://www.kdd.org/kdd2019/docs/Winners_Regular_Baidu.pdf">https://www.kdd.org/kdd2019/docs/Winners_Regular_Baidu.pdf</a></p>
<p><strong>Proposal Title: Simulating the Eects of Eco-Friendly Transportation Selections for Air Pollution Reduction</strong>
Keiichi Ochiai, Tsukasa Demizu, Shin Ishiguro, Shohei Maruyama, Akihiro Kawana
Research movie: <a href="https://www.powtoon.com/online-presentation/bugFjP07kIK/eco-friendly-transportation-selections">https://www.powtoon.com/online-presentation/bugFjP07kIK/eco-friendly-transportation-selections</a></p>
<h2 id="details-of-regular-ml-track">Details of Regular ML Track</h2>
<p>Regular ML Track was sponsored by Baidu of China, and the transfer search log of Baidu Maps was provided. There are four types of logs, but here we will explain only the three types used in Task2.</p>
<h3 id="log-description-provided">Log description provided</h3>
<h4 id="search-query-log-quoted-from-official-pagehttpsdianshibaiducomcompetition29question">Search query log (<a href="https://dianshi.baidu.com/competition/29/question">quoted from official page</a>)</h4>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/320464/277f392b-a65f-06e5-cfb5-fbf79e447211.png" alt="Search Query"></p>
<p>In the search query log, sid is the session ID, pid is the user ID (actually, it is rounded by a person with a similar profile for privacy protection), req_time is the time when the search request is made, o is the latitude and longitude of the departure place, d Is the latitude and longitude of the destination.</p>
<h4 id="route-candidate-log">Route candidate log</h4>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/320464/bc33b594-161e-4b2d-d0d1-b5389da831c6.png" alt="Route candidate log"></p>
<p>This is also a quote from the official page. Multiple routes (transportation mode, transportation mode) are presented for one search query. The transport mode is an ID that indicates transportation, for example, 1 is a bus, 2 is a subway, and so on. However, which ID actually corresponds to which transportation system was not disclosed, so it was estimated from various information. After that, Distance is the distance, ETA is the travel time, and estimated price is the usage fee. There is more than one such data per query.</p>
<h4 id="click-log">Click log</h4>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/320464/2ea3ff81-9df6-9812-6166-e338bd959e13.png" alt="Click log"></p>
<p>This is also a quote from the official page. The click log records the session ID and the selected transportation mode. By using sid as a key, you can link the above three logs.</p>
<p>Regular ML Track Task1 was a task that predicts the traffic mode used by the user based on the logs described so far. Task2 uses the above logs to freely set tasks and make research proposals. Task1 can be evaluated with predictive accuracy, but Task2 does not have such an index, so it was evaluated in the form of a regular paper submission in which a four-page paper is written in English and committee members evaluate the content. ..</p>
<h2 id="suggestions">Suggestions</h2>
<p>Our team made a proposal by linking the environmental issues of selecting transportation modes and reducing air pollution. I will explain the details from here.</p>
<h3 id="research-background">Research background</h3>
<p>Environmental problems are one of the important social problems, and efforts to reduce CO2 are being made on a global scale. On the other hand, according to the <a href="https://www.unenvironment.org/resources/emissions-gap-report-2018">UN announcement</a>,theCO2emissionsin2017begantoincreaseforthefirsttimeinfouryears,and2Thereisalsoanopinionthatitmaybedifficulttoachievethe℃target(holdingthetemperatureriseaftertheIndustrialRevolutionwithin2℃).</p>
<p>Based on this situation, I think that it is important not only for efforts at the national and corporate levels, but also for individual efforts. One possible approach for individuals to tackle environmental problems is to choose eco-friendly transportation in their daily lives. However, simply avoiding transportation that emits CO2 would hinder people&rsquo;s lives, and such actions would not be selected. On the other hand, as long as it does not interfere with your daily life, you may be able to select a transportation method that leads to CO2 reduction. It may be motivated for users to understand how much they can contribute to CO2 reduction when they change their transportation. However, in order to quantify the effect, we need a log of people&rsquo;s transportation.</p>
<p>Therefore, in this research, we simulate the CO2 emission reduction amount when the eco-friendly transportation method is selected by using the log of the transit search service and assuming that the transportation method is actually clicked. .. In addition, it is considered that the increase in walking and biking will have a positive effect on health, so we will quantitatively evaluate the effect on health.</p>
<h3 id="approach">approach</h3>
<h4 id="basic-ideas">Basic ideas</h4>
<p>From the route candidate log presented to a user, the CO2 emissions when using each traffic mode can be calculated by the following formula.</p>
<p>CO2 emissions = distance traveled (km) x unit distance-CO2 emissions per person (g/person-km)</p>
<p>Since the travel distance is in the route candidate log, CO2 emissions can be calculated if the unit distance and CO2 emissions per person are known. Some of the data is <a href="http://www.ecomo.or.jp/environment/unyukotsutokankyou/data/unyu_koutuu_to_kankyou_2018_all.pdf">public</a>, which the Public Interest Incorporated Foundation uses. .. For example, if the logs below are Bus and Cycling route candidates, you can calculate as shown in the following red frame.</p>
<img width="869" alt="CO2_calc.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/320464/695aca53-02a8-9e09-dc57-620c7cfd98e6.png">
<p>You can also see from the click log that this user was clicking Bus. Here, it is defined that the alternative transportation modes can be accepted as follows.</p>
<p><strong>Alternative route travel time (ETA) ≤ Travel time of clicked route</strong>
<strong>CO2 emissions from alternative routes &lt;CO2 emissions from clicked routes</strong></p>
<p>The first condition is that the travel time is less than or equal to the travel time originally selected by the user. The eco-friendly mode of transportation is walking or bicycling, but it is thought that even if there is a candidate to walk far, it will not be selected. On the other hand, it is assumed that you will be accepted if the travel time of the originally selected transportation mode is not exceeded. The second condition is that CO2 emissions will be reduced. According to this acceptable definition, Cycling is acceptable in the example above. Apply this to all search logs. In the actual log, since hundreds of thousands of search queries are searched for means of transportation that satisfy the above conditions, it can be formulated as a <strong>combinatorial optimization problem</strong>.</p>
<h4 id="formulation-as-an-integer-optimization-problem">Formulation as an integer optimization problem</h4>
<p>We formulate the traffic mode selection as a 0-1 integer optimization problem with constrained travel times and CO2 emissions. The objective function and constraints to minimize are</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/320464/2632a88f-dea7-7639-5cd8-09b2b4c81fba.png" alt="Formulation"></p>
<p>Here, $P_{i,j}$ is the CO2 emission when the user $i$ selects the transportation mode $j$, and $Q_{i,j}$ is the user $i$ the transportation mode $j$. The travel time when selected, $Q\prime_{i,j}$ is the travel time of the traffic mode clicked by user $i$ (assuming that the user actually moved), and $X_{i,j}$ is the selection It is a value such as a one-hot vector in which only one traffic mode is 1 and the others are 0. Also, $m$ indicates the number of session IDs and $n$ indicates the number of traffic modes. When mounting, the unit is different for CO2 emission and moving time, so both are normalized.</p>
<p>The tutorial by Prof. Umeya of Osaka University was very helpful for the formulation as an optimization problem.</p>
<p>Introduction to combinatorial optimization: From linear programming to integer programming
<a href="https://www.slideshare.net/shunjiumetani/ss-17197023">https://www.slideshare.net/shunjiumetani/ss-17197023</a></p>
<p>If it can be formulated, it will use the existing solver. This time, I used the library <a href="https://coin-or.github.io/pulp/">PuLP</a>.</p>
<h4 id="result">result</h4>
<p>We compared the results after optimization with the user click log as the baseline. The results are shown in the table below. Optimized the search log of about 400,000 queries.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/320464/18876eff-54d4-07d7-ca54-e79dd9e0f53b.png" alt="Result">It seems that CO2 emissions can be reduced by approximately 9.23%. Surprisingly, the result was a reduction in travel time of 9.96%. The user may not necessarily be clicking the fastest route.</p>
<p>Next, let&rsquo;s look at how transportation has changed due to optimization. In the table below, the left parentheses are the traffic modes clicked by the user, and the right is the traffic mode selected by optimization.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/320464/53d56a51-77f2-b4cf-7bfa-68e8f8d41692.png" alt="Qualitative Results"></p>
<p>Since the released log is in central Beijing, it seems that there were many cases of traveling a short distance by bus or subway, and there were many changes to change it to a bicycle (red frame in the table). On the other hand, in the case of private cars (Driving), there are few cases where they are changed to bicycles, and there are many private cars (blue frame in the table). It may be that the place to move by car is far away and there is no alternative.</p>
<p>Only the outline of the effects on health will be explained. There is a study at Oxford University that analyzed the effect of cycling on mortality reduction (Paper <a href="https://www.ncbi.nlm.nih.gov/pubmed/25344355">this</a>).Accordingtothisstudy,WHOrecommendedactivitylevels(11.25METh/weekofphysicalactivity,150minutesofmoderateaerobicactivity)reducedtotalmortalityby10%.Fromthissimulation,userscanaverageanaverageof23.04minutesaday(13.63%recommendedbyWHO) to ride a bicycle. We considered that the combination of the two could reduce the total mortality rate by $10% \times 13.63% = 1.36%$.</p>
<p>As you can see by looking at the results of changes in transportation, this research shows that bicycles can be used instead of bicycles. However, if you actually try to do this, there will be a problem with the bicycle parking space, the accepted transportation will change depending on the weather (you do not want to move by bicycle if it is raining), how do you ask the user to choose a transportation with low CO2 There is still a problem in practical use, such as UI/UX. It is also assumed that you have moved to the transportation/route you clicked in the transfer search, but there is a fundamental restriction that you do not know how you actually moved.</p>
<h4 id="implementation">Implementation</h4>
<p>Finally, I will introduce a little about the implementation. I implemented it by referring to the following articles.
<a href="https://qiita.com/samuelladoco/items/703bf78ea66e8369c455">https://qiita.com/samuelladoco/items/703bf78ea66e8369c455</a>
<a href="https://qiita.com/mzmttks/items/82ea3a51e4dbea8fbc17">https://qiita.com/mzmttks/items/82ea3a51e4dbea8fbc17</a></p>
<p>Create a dictionary with CO2 emissions in c_co2[i,j] and travel time (user i, transportation mode j) in c_eta[i,j] in advance. For example,
c_eta[2,1] = 1976.0, c_eta[2,3] = 1146.0, c_eta[2,4] = 1446.0, c_eta[2,5] = 2246.0, c_eta[2,6] = 818.0
In this example, it is assumed that the user with user ID 2 is presented with transportation modes 1, 3, 4, 5, and 6 as candidates, and the travel time in each transportation mode is as described above.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pulp
problem <span style="color:#f92672">=</span> pulp<span style="color:#f92672">.</span>LpProblem(<span style="color:#e6db74">&#34;ETA-CO2 minimize&#34;</span>, pulp<span style="color:#f92672">.</span>LpMinimize)
x <span style="color:#f92672">=</span> {}

<span style="color:#75715e">#0-1 variable is defined (corresponding to the constraint that X_{i,j} of constraint condition 3 is 0, 1 is binary)</span>
<span style="color:#75715e"># define 0-1 variable</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> I:
    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> J:
        x[i,j] <span style="color:#f92672">=</span> pulp<span style="color:#f92672">.</span>LpVariable(<span style="color:#e6db74">&#34;x({:},{:})&#34;</span><span style="color:#f92672">.</span>format(i,j), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, pulp<span style="color:#f92672">.</span>LpBinary)

<span style="color:#75715e">#Define the objective function. Normalize by dividing travel time and CO2 emissions by the maximum value.</span>
<span style="color:#75715e"># define objective function.ETA and CO2 emission are normalized by dividing max</span>
max_co2 <span style="color:#f92672">=</span> max(c_co2<span style="color:#f92672">.</span>values())
max_eta <span style="color:#f92672">=</span> max(c_eta<span style="color:#f92672">.</span>values())
problem <span style="color:#f92672">+=</span> pulp<span style="color:#f92672">.</span>lpSum( ((c_co2[i,j]<span style="color:#f92672">/</span>max_co2) <span style="color:#f92672">*</span> x[i,j]) <span style="color:#f92672">+</span> ((c_eta[i,j]<span style="color:#f92672">/</span>max_eta) <span style="color:#f92672">*</span> x[i,j]) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> I <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> J <span style="color:#66d9ef">if</span> (i,j) <span style="color:#f92672">in</span> c_co2), <span style="color:#e6db74">&#34;TotalCost&#34;</span>

<span style="color:#75715e">#Constraint 1: For user i, only one mode can be assigned</span>
<span style="color:#75715e"># constraint 1: each user can be assigned one mode</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> I:
    problem <span style="color:#f92672">+=</span> sum(x[i,j] <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> J <span style="color:#66d9ef">if</span> (i,j) <span style="color:#f92672">in</span> c_co2) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;Constraint_leq_{:}&#34;</span><span style="color:#f92672">.</span>format(i)

<span style="color:#75715e">#Constraint 2: Shorter than the travel time of the traffic mode clicked by user i</span>
<span style="color:#75715e">#Click_log_df contains click log as pandas dataframe</span>
<span style="color:#75715e"># constraint 2: set &#34;acceptable&#34; condition</span>
<span style="color:#66d9ef">for</span> n, t <span style="color:#f92672">in</span> click_log_df<span style="color:#f92672">.</span>iterrows():
    i <span style="color:#f92672">=</span> int(t[<span style="color:#e6db74">&#34;sid&#34;</span>])
    <span style="color:#66d9ef">if</span> (i,int(t[<span style="color:#e6db74">&#34;transport_mode&#34;</span>])) <span style="color:#f92672">in</span> c_co2:
        baseline <span style="color:#f92672">=</span> int(c_eta[i, int(t[<span style="color:#e6db74">&#34;transport_mode&#34;</span>])]<span style="color:#f92672">*</span><span style="color:#ae81ff">1.0</span>)

    problem <span style="color:#f92672">+=</span> sum(c_eta[i,j]<span style="color:#f92672">*</span>x[i,j] <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> J <span style="color:#66d9ef">if</span> (i,j) <span style="color:#f92672">in</span> c_co2) <span style="color:#f92672">&lt;=</span> baseline, <span style="color:#e6db74">&#34;Constraint_co2eq_{:}&#34;</span><span style="color:#f92672">.</span>format(i)

<span style="color:#75715e"># Specify solver</span>
<span style="color:#75715e"># set solver</span>
solver <span style="color:#f92672">=</span> pulp<span style="color:#f92672">.</span>solvers<span style="color:#f92672">.</span>PULP_CBC_CMD()
result <span style="color:#f92672">=</span> problem<span style="color:#f92672">.</span>solve(solver)
<span style="color:#75715e"># Output whether or not optimization was performed and the evaluation value at that time</span>
<span style="color:#75715e"># output</span>
<span style="color:#66d9ef">print</span>(pulp<span style="color:#f92672">.</span>LpStatus[result], pulp<span style="color:#f92672">.</span>value(problem<span style="color:#f92672">.</span>objective))

</code></pre></div><h2 id="timeline">Timeline</h2>
<p>The issue of Regular ML Track of KDD Cup 2019 was released around April 13th. After that, I submitted the paper according to the following schedule.</p>
<p>4/19 First meeting (developing data utilization method)
5/8 Meeting #2 (Development of data utilization method and policy decision)
5/15 Meeting #3 (optimization program implemented, optimization did not converge at this point)
5/31 Meeting #4 (optimization implementation completed)
June 3-10 Writing thesis (4 pages in English)
6/11-12 English proofreading
Posted on June 13
6/15 Submission deadline (The deadline will be extended at a later date by the end of June)</p>
<p>In 2019, we had 10 consecutive holidays during Golden Week, and in a month and a half, we decided the research theme, implemented, and wrote thesis.</p>
<h2 id="finally">Finally</h2>
<p>I was not familiar with optimization problems myself, but a colleague who was studying with me gave detailed explanations, and taught me about the formulation, implementation of Pulp, and what to do when optimization fails. In addition, another member proposed to apply it to environmental problems, and where each transportation mode is provided with ID only, which ID is which transportation mode? This is a research that each team member contributed by identifying it while looking at the statistics. I would like to continue to do interesting research and improve awareness of DoCoMo&rsquo;s data analysis and AI fields through external activities such as conference presentations, and I will continue to challenge top conferences such as KDD.</p>
<p>Let&rsquo;s have a Merry Christmas and a Happy New Year!</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
