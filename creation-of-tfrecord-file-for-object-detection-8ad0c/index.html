<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Creation of TFRecord file for object detection | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Creation of TFRecord file for object detection</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 25, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/json">JSON</a></code></small>


<small><code><a href="https://memotut.com/tags/tensorflow">TensorFlow</a></code></small>


<small><code><a href="https://memotut.com/tags/tfrecords">TFRecords</a></code></small>


<small><code><a href="https://memotut.com/tags/vott">VoTT</a></code></small>

</p>
<pre><code>## Introduction
</code></pre>
<p><a href="https://qiita.com/IchiLab/items/fd99bcd92670607f8f9b">Last article</a> summarized how to use the Object Detection API provided by TensorFlow.
To use this API to teach &ldquo;This object is ○○&rdquo; from images and videos,
Annotate and convert to TFRecord format,
It will be used as teacher data and verification data,
I feel that there are still few articles that mention the specific contents of this TFRecord format.</p>
<p>In this article, from the method that can be created without programming at the beginning,
We will put together various angles to write and create Python code.
Of course, it&rsquo;s just a summary of the findings I&rsquo;ve learned through trial and error,
Please understand that there may be parts that do not reach it.</p>
<h2 id="content-to-introduce">Content to introduce</h2>
<ul>
<li>Microsoft&rsquo;s <a href="https://github.com/Microsoft/VoTT/releases">VoTT</a> TFRecord file creation procedure</li>
<li>What kind of file is TFRecord?</li>
<li>Method to cut out the annotation part from the annotated data</li>
<li>Try to create a TFRecord for object detection with Python</li>
</ul>
<h2 id="vott-tfrecord-file-creation-procedure">VoTT TFRecord file creation procedure</h2>
<h3 id="vott-installation">VoTT installation</h3>
<p>Let&rsquo;s download from the following site. If the OS is Windows, select &ldquo;.exe&rdquo;, and if it is Mac, select &ldquo;.dmg&rdquo;.
<a href="https://github.com/Microsoft/VoTT/releases">VoTT</a></p>
<h3 id="initial-setting">Initial setting</h3>
<p>First, create a new project with &ldquo;New Project&rdquo;.
<img width="919" alt="q01.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/499855/50d1f5fc-99dc-61a9-ee1c-519e68fcdb31.png"></p>
<p>Make project settings.</p>
<ul>
<li><code>Display Name</code>: Choose a name you like.</li>
<li><code>Security Token</code>: OK by default.</li>
<li><code>Source Connection</code>: Setting name of the place to read the image</li>
<li><code>Target Connection</code>: Setting name of the location to save the project. <br><code>.vott</code>, <code>.json</code> and TFRecord folders are saved in the directory specified here.</li>
</ul>
<p>VoTT names and stores setting information such as the folder location with &ldquo;Add Connection&rdquo; when specifying each directory,
In the &ldquo;~ Connection&rdquo; item, the setting name is specified.
Therefore, when using it for the first time, start by creating the setting with &ldquo;Add Connection&rdquo; on the right side.
<img width="1098" alt="q02.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/499855/6aff2dda-390b-228d-ee81-cda6bb60f810.png"></p>
<p>Set the directory.</p>
<ul>
<li>Display Name: The name of the setting. Anything, such as a folder name, is OK.</li>
<li>Provider: Since we are going to specify a local directory this time, select &ldquo;Local File System&rdquo;.</li>
<li>Folder Path: Provider can be set by specifying the above. Select a folder.</li>
</ul>
<p>Finally, select &ldquo;Save Connection&rdquo;.
<img width="852" alt="q03.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/499855/7dd281d1-36e6-dd46-9b84-dab5c88cd625.png"></p>
<p>If you can set &ldquo;Source Connection&rdquo; and &ldquo;Target Connection&rdquo; respectively in this way, the next step is annotation work.
<img width="1102" alt="q04.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/499855/ca186ca8-00c7-6e24-fa6e-ae65717584b1.png"></p>
<h3 id="annotation">annotation</h3>
<p>You can annotate the second from the top left (below the house mark).
(The picture is of my cat Mimi and Kitty)
<img width="1589" alt="q05.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/499855/4b86494b-d573-1d70-065d-e2c73da317f7.png"></p>
<p>First, set the tag.
It says TAGS on the right side, and there is a + icon next to it.
If you select this, you can set a new tag.
This time, I chose &ldquo;Mimmy&rdquo; and &ldquo;Kitty&rdquo; as my cat&rsquo;s name.</p>
<p>Then select the second square icon from the top left.
Then drag the area you want to annotate and enclose it.
<img width="1375" alt="q06.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/499855/0e36fd02-6002-17a8-9f04-cb333ba78c21.png"></p>
<p>It may be a gray square when enclosed.
If you want to give an arbitrary tag name at the moment of enclosing, select the tag name on the right side,
If you select an icon like a lock mark and set it as &ldquo;I will attach it with this tag fixed&rdquo;,
When you annotate, it will automatically give the tag name.
(Or, on a Mac, you can do the same operation by holding down the Command key and clicking the tag name.
CTRL key on Windows&hellip;? Unconfirmed)</p>
<p>You can also press the Shift key at the time of annotation to fix it to a square and annotate.
It&rsquo;s a good idea to touch and get used to this area.</p>
<h3 id="export-tfrecord-and-json">Export TFRecord and json</h3>
<p>To generate a TFRecord, it is necessary to set it in the export settings beforehand.
Select the 4th arrow icon from the top in the menu icon on the left.</p>
<ul>
<li>Provider: Select &ldquo;Tensorflow Records&rdquo;.</li>
<li>Asset State: Select &ldquo;Only tagged Assets&rdquo;. <br>If you mistakenly set it to &ldquo;Only Visited Assets&rdquo;, the image will be exported even if you check the image but do not annotate it. <br>Please note that this will affect the learning results.</li>
</ul>
<p>After completing the settings, select &ldquo;Save Export Settings&rdquo; to save the settings.</p>
<img width="604" alt="q07.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/499855/5ed574e1-1572-604e-e2b7-de8a4a92c569.png">
<p>After that, return to the annotation screen, save the project with the floppy icon on the upper right side, and export the format (TFRecord this time) set with the icon on the upper right arrow.
By the way, the json file is created by itself when you save it without setting anything.</p>
<img width="552" alt="q08.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/499855/7991eb0f-1ed3-7e52-2218-80731fe4c6e6.png">
<p>The above is the procedure for creating a TFRecord file using VoTT.</p>
<p>Next is the main topic of this article.</p>
<h2 id="what-kind-of-file-is-tfrecord">What kind of file is TFRecord?</h2>
<h3 id="what-is-tf-record">What is TF Record</h3>
<p>What is TFRecord in the first place?</p>
<p>An excerpt from the official TensorFlow tutorial states:</p>
<blockquote>
<p>TFRecord format is a simple format for storing a series of binary records.
Protocol buffers are platform- and language-independent libraries that efficiently serialize structured data.</p>
</blockquote>
<p>Reference) <a href="https://www.tensorflow.org/tutorials/load_data/tfrecord?hl=ja">How to use TFRecords and tf.Example</a></p>
<p>Just reading this doesn&rsquo;t help.
Now let&rsquo;s take a look at the contents of the TFRecord that was exported using VoTT.</p>
<h3 id="read-the-tfrecord-file-and-visualize-it">Read the TFRecord file and visualize it</h3>
<p>The contents of TFRecord can be visualized with the following sources.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> absolute_import, division, print_function, unicode_literals
<span style="color:#f92672">import</span> tensorflow <span style="color:#f92672">as</span> tf
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> IPython.display <span style="color:#f92672">as</span> display

<span style="color:#75715e"># Specify the TFRecord path</span>
filenames <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;VoTT/Cat/Cat-TFRecords-export/Mimmy_and_Kitty.tfrecord&#39;</span>
raw_dataset <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>TFRecordDataset(filenames)

<span style="color:#75715e"># Export the read content to another format</span>
<span style="color:#75715e"># (Also .txt is good. It is recommended that it is better than txt because json will be colored and easier to see depending on the editor)</span>
tfr_data <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;tfr.json&#39;</span>

<span style="color:#66d9ef">for</span> raw_record <span style="color:#f92672">in</span> raw_dataset<span style="color:#f92672">.</span>take(<span style="color:#ae81ff">1</span>):
    example <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>Example()
    example<span style="color:#f92672">.</span>ParseFromString(raw_record<span style="color:#f92672">.</span>numpy())
    <span style="color:#66d9ef">print</span>(example)

    <span style="color:#75715e"># Export to a file. It is not mandatory as it can be viewed on the console without exporting it.</span>
    <span style="color:#66d9ef">with</span> open(tfr_data,<span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f:
        <span style="color:#66d9ef">print</span>(example, file<span style="color:#f92672">=</span>f)
</code></pre></div><p>Let&rsquo;s take a quick look at the file exported with the above source.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">features</span> {
  <span style="color:#960050;background-color:#1e0010">feature</span> <span style="color:#960050;background-color:#1e0010">{</span>
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/encoded&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">bytes_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#f92672">&#34;\377\330\377...
</span><span style="color:#f92672">        ..... (because of the large amount, omitted)...&#34;</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/filename&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {<span style="color:#960050;background-color:#1e0010">bytes_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#f92672">&#34;Mimmy_and_Kitty.jpg&#34;</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/format&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">bytes_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#f92672">&#34;jpg&#34;</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/height&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">int64_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">1440</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/key/sha256&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">bytes_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#f92672">&#34;TqXFCKZWbnYkBUP4/rBv1Fd3e+OVScQBZDav2mXSMw4=&#34;</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/object/bbox/xmax&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">float_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0.48301976919174194</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0.7260425686836243</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/object/bbox/xmin&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">float_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0.3009025752544403</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0.5285395383834839</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/object/bbox/ymax&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">float_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0.6981713175773621</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0.8886410593986511</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/object/bbox/ymin&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">float_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0.3555919826030731</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0.5664308667182922</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/object/class/label&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">int64_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">1</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/object/class/text&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">bytes_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#f92672">&#34;Mimmy&#34;</span>
        <span style="color:#960050;background-color:#1e0010">value</span>: <span style="color:#e6db74">&#34;Kitty&#34;</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/width&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">int64_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">2560</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
<span style="color:#960050;background-color:#1e0010">}</span>
</code></pre></div><p>他にも<code>difficult</code>、<code>truncated</code>、<code>view</code>、<code>source_id</code>といったkeyが含まれていますが、
ここでは必要だと思われる内容のみ抜粋しました。
中身を確認すれば、以下のような構成であることが分かります。</p>
<ul>
<li><code>image/encoded</code> : 画像のバイナリデータ</li>
<li><code>image/width</code>, <code>image/height</code> : 画像のサイズ</li>
<li><code>xmin</code>,　<code>xmax</code>,　<code>ymin</code>,　<code>ymax</code> : アノテーションした座標情報。アノテーションした数だけ値が含まれる。</li>
<li><code>class/text</code>, <code>class/label</code> : タグ情報。textはタグの名前で、labelの数字はタグ名に付与された番号と考えて良い。今回の場合は、「Mimmy」が0で、「Kitty」 が1となっている。</li>
</ul>
<p>ここまで来ると、だいぶTFRecordがどんな構成で出来ているデータなのか、きっと分かってきたことでしょう。</p>
<h2 id="アノテーションしたデータからアノテーション部分を切り出す方法">アノテーションしたデータから、アノテーション部分を切り出す方法</h2>
<p>次は、VoTTでアノテーションした部分をプログラムで切り出す方法です。
もしこの作業が出来たら、自分でプログラムを書いてTFRecordファイルを作る際に、
次で紹介するような<strong>検出したい物体と背景を合成する</strong>、なんてアイデアに必要になるかもしれません。
または画像分類の機械学習にもきっと役立つでしょう。</p>
<p>また、これは試して気がついたことですが、
<strong>VoTTで見える画像の向きと実際に切り出すときの画像の向きが違うことがある</strong>
ということが分かりました。</p>
<p>つまり、VoTT内でアノテーションしたときに画面で見ている画像と、
json情報で切り出すときの元データの画像の向きが180度違うことがあったということです。</p>
<p>おかげで1枚だけ全然意図しない場所の画像が切り出されてしまっていました。
これがTFRecordでは正しい向きでアノテーションされているのかは定かではないので、
一度目視しておくと安心かもしれません。</p>
<p>さて、前置きが長くなりましたが、早速画像切り出しのためのjsonを確認してみましょう。
VoTTでアノテーション作業を終えて書き出す際、jsonも自動で書き出されることについては先述しましたね。</p>
<p>例で挙げた猫のデータは、以下のように書き出されました。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;asset&#34;</span>: {
        <span style="color:#f92672">&#34;format&#34;</span>: <span style="color:#e6db74">&#34;jpg&#34;</span>,
        <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;1da8e6914e4ec2e2c2e82694f19d03d5&#34;</span>,
        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Mimmy_and_Kitty.jpg&#34;</span>,
        <span style="color:#f92672">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;【フォルダ名】/VoTT/Cat/IMAGES/Mimmy_and_Kitty.jpg&#34;</span>,
        <span style="color:#f92672">&#34;size&#34;</span>: {
            <span style="color:#f92672">&#34;width&#34;</span>: <span style="color:#ae81ff">2560</span>,
            <span style="color:#f92672">&#34;height&#34;</span>: <span style="color:#ae81ff">1440</span>
        },
        <span style="color:#f92672">&#34;state&#34;</span>: <span style="color:#ae81ff">2</span>,
        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#ae81ff">1</span>
    },
    <span style="color:#f92672">&#34;regions&#34;</span>: [
        {
            <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;kFskTbQ6Z&#34;</span>,
            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;RECTANGLE&#34;</span>,
            <span style="color:#f92672">&#34;tags&#34;</span>: [
                <span style="color:#e6db74">&#34;Mimmy&#34;</span>
            ],
            <span style="color:#f92672">&#34;boundingBox&#34;</span>: {
                <span style="color:#f92672">&#34;height&#34;</span>: <span style="color:#ae81ff">493.3142744479496</span>,
                <span style="color:#f92672">&#34;width&#34;</span>: <span style="color:#ae81ff">466.2200532386868</span>,
                <span style="color:#f92672">&#34;left&#34;</span>: <span style="color:#ae81ff">770.3105590062112</span>,
                <span style="color:#f92672">&#34;top&#34;</span>: <span style="color:#ae81ff">512.0524447949527</span>
            },
            <span style="color:#f92672">&#34;points&#34;</span>: [
                {
                    <span style="color:#f92672">&#34;x&#34;</span>: <span style="color:#ae81ff">770.3105590062112</span>,
                    <span style="color:#f92672">&#34;y&#34;</span>: <span style="color:#ae81ff">512.0524447949527</span>
                },
                {
                    <span style="color:#f92672">&#34;x&#34;</span>: <span style="color:#ae81ff">1236.5306122448978</span>,
                    <span style="color:#f92672">&#34;y&#34;</span>: <span style="color:#ae81ff">512.0524447949527</span>
                },
                {
                    <span style="color:#f92672">&#34;x&#34;</span>: <span style="color:#ae81ff">1236.5306122448978</span>,
                    <span style="color:#f92672">&#34;y&#34;</span>: <span style="color:#ae81ff">1005.3667192429023</span>
                },
                {
                    <span style="color:#f92672">&#34;x&#34;</span>: <span style="color:#ae81ff">770.3105590062112</span>,
                    <span style="color:#f92672">&#34;y&#34;</span>: <span style="color:#ae81ff">1005.3667192429023</span>
                }
            ]
        },
    ],
    <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#e6db74">&#34;2.1.0&#34;</span>
}
</code></pre></div><p>（載せると長くなるため、もう1匹のKittyタグの情報は割愛しました。）</p>
<p>ご覧の通り、ファイル名と画像サイズ、さらにはアノテーションした座標情報が入っています。
これらの情報だけで画像を切り出すことは十分可能ですね。</p>
<p>アノテーションされた座標情報は<code>boundingBox</code>と<code>points</code>の2種類がご丁寧に含まれています。
色々やり方はありそうですが、今回は<code>boundingBox</code>を見に行って、切り出す方法を取ってみました。
以下、そのソースコードです。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> json
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> fnmatch
<span style="color:#f92672">import</span> cv2 <span style="color:#f92672">as</span> cv

JSON_DIR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;VoTT/Cat/&#39;</span>
IMG_DIR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;VoTT/Cat/&#39;</span>
CUT_IMAGE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cut_images/&#39;</span>
CUT_IMAGE_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cat&#39;</span>
IMAGE_FORMAT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.jpg&#39;</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Check</span>():

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">filepath_checker</span>(self, dir):
        
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> (os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(dir)):
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;No such directory &gt; &#39;</span> <span style="color:#f92672">+</span> dir)
            exit()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">directory_init</span>(self, dir):

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span>(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(dir)) :
            os<span style="color:#f92672">.</span>makedirs(dir, exist_ok<span style="color:#f92672">=</span>True)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    
    check <span style="color:#f92672">=</span> Check()

    <span style="color:#75715e">#jsonファイルを格納したディレクトリが存在するかチェック</span>
    check<span style="color:#f92672">.</span>filepath_checker(JSON_DIR)
    
    <span style="color:#75715e">#&#39;CUTした画像の格納場所を準備&#39;</span>
    check<span style="color:#f92672">.</span>directory_init(CUT_IMAGE)

    <span style="color:#75715e">#jsonを解析し、画像とアノテーション座標から切り出しをしていく</span>
    count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">for</span> jsonName <span style="color:#f92672">in</span> fnmatch<span style="color:#f92672">.</span>filter(os<span style="color:#f92672">.</span>listdir(JSON_DIR), <span style="color:#e6db74">&#39;*.json&#39;</span>):

        <span style="color:#75715e">#jsonを開く  </span>
        <span style="color:#66d9ef">with</span> open(JSON_DIR <span style="color:#f92672">+</span> jsonName) <span style="color:#66d9ef">as</span> f :
            result <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>load(f)

            <span style="color:#75715e">#画像のファイル名の取得</span>
            imgName <span style="color:#f92672">=</span> result[<span style="color:#e6db74">&#39;asset&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>]<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;jsonName = {}, imgName = {}&#39;</span><span style="color:#f92672">.</span>format(jsonName, imgName))
            
            img <span style="color:#f92672">=</span> cv<span style="color:#f92672">.</span>imread(IMG_DIR <span style="color:#f92672">+</span> imgName)
            <span style="color:#66d9ef">if</span> img <span style="color:#f92672">is</span> None:
                <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;cv.imread Error&#39;</span>)
                exit()

            <span style="color:#75715e"># Loop as many as the number of annotations</span>
            <span style="color:#66d9ef">for</span> region <span style="color:#f92672">in</span> result[<span style="color:#e6db74">&#39;regions&#39;</span>]:
                
                height <span style="color:#f92672">=</span> int(region[<span style="color:#e6db74">&#39;boundingBox&#39;</span>][<span style="color:#e6db74">&#39;height&#39;</span>])
                width <span style="color:#f92672">=</span> int(region[<span style="color:#e6db74">&#39;boundingBox&#39;</span>][<span style="color:#e6db74">&#39;width&#39;</span>])
                left <span style="color:#f92672">=</span> int(region[<span style="color:#e6db74">&#39;boundingBox&#39;</span>][<span style="color:#e6db74">&#39;left&#39;</span>])
                top <span style="color:#f92672">=</span> int(region[<span style="color:#e6db74">&#39;boundingBox&#39;</span>][<span style="color:#e6db74">&#39;top&#39;</span>])

                cutImage <span style="color:#f92672">=</span> img[top: top <span style="color:#f92672">+</span> height, left: left <span style="color:#f92672">+</span> width]
                <span style="color:#75715e">#Avoid information that you accidentally clicked one point during annotation</span>
                <span style="color:#66d9ef">if</span> height <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">or</span> width <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
                    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;&lt;height or width is 0&gt; imgName =&#39;</span>, imgName)
                    <span style="color:#66d9ef">continue</span>
                
                <span style="color:#75715e">#If you want to resize before exporting, remove the comment out</span>
                <span style="color:#75715e">#cutImage = cv.resize(cutImage, (300,300))</span>

                <span style="color:#75715e"># Export files with serial numbers such as &#34;cut_images/cat0000.jpg&#34;</span>
                cv<span style="color:#f92672">.</span>imwrite(CUT_IMAGE <span style="color:#f92672">+</span> CUT_IMAGE_NAME <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;{0:04d}&#34;</span><span style="color:#f92672">.</span>format(count <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> IMAGE_FORMAT, cutImage)
                <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;{0:04d}&#34;</span><span style="color:#f92672">.</span>format(count<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>))
                count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    main()
    
</code></pre></div><p>In the source code, there is a conditional branch such as <code>if height == 0 or width == 0</code>,
The part clicked by mistake during VoTT annotation remains as data,
Since there was an error because there was no area to cut out,
I tried incorporating it to avoid that human error.
<img width="607" alt="q09.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/499855/e8498534-b51b-bd76-8bc7-96b305411ea4.png"></p>
<p>In my case, it was necessary to annotate a lot on one page, so
It was more difficult to notice it. And especially when there is a large amount of image data.</p>
<p>Now that it&rsquo;s long, let&rsquo;s finally write a program to create a TFRecord.</p>
<h2 id="create-a-tfrecord-for-object-detection-with-python">Create a TFRecord for object detection with Python</h2>
<p>Now that you have a general understanding of the structure of the contents of TFRecord,
Finally, let&rsquo;s write the source code and create a TFRecord.</p>
<h3 id="source-code-description">Source code description</h3>
<p>Here&rsquo;s what I&rsquo;m doing with the sources I posted.</p>
<ol>
<li>Prepare an image of the object (cat) to be combined with the background image in advance</li>
<li>Synthesize background image and object image (this time fixed to arbitrary position)</li>
<li>Organize information required for TFRecord such as synthesized coordinate position information</li>
<li>Generate TFRecord file</li>
</ol>
<p>First, I borrowed the background image from the material site.
Here it is.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/499855/90758012-ef8b-118d-9b69-a1dbf0737f2e.jpeg" alt="bg.jpg"></p>
<p>And here is the object image to be combined.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/499855/98e30da1-610a-303e-0d38-5a69915a051f.png" alt="Mimmy_image.png"></p>
<h3 id="source-code-sample">Source code sample</h3>
<p>Below is the source code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> tensorflow <span style="color:#f92672">as</span> tf
<span style="color:#f92672">import</span> cv2 <span style="color:#f92672">as</span> cv
<span style="color:#f92672">import</span> utils.dataset_util <span style="color:#f92672">as</span> dataset_util


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">img_composition</span>(bg, obj, left, top):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Function that synthesizes background and object
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    bg: numpy.ndarray ~ background image
</span><span style="color:#e6db74">    obj: numpy.ndarray ~ object image
</span><span style="color:#e6db74">    left: int ~ coordinate to be combined (left)
</span><span style="color:#e6db74">    top: int ~ coordinates to combine (top)
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    bg_img <span style="color:#f92672">=</span> bg<span style="color:#f92672">.</span>copy()
    obj_img <span style="color:#f92672">=</span> obj<span style="color:#f92672">.</span>copy()

    bg_h, bg_w <span style="color:#f92672">=</span> bg_img<span style="color:#f92672">.</span>shape[:<span style="color:#ae81ff">2</span>]
    obj_h, obj_w <span style="color:#f92672">=</span> obj_img<span style="color:#f92672">.</span>shape[:<span style="color:#ae81ff">2</span>]
 
    roi <span style="color:#f92672">=</span> bg_img[top:top <span style="color:#f92672">+</span> obj_h, left:left <span style="color:#f92672">+</span> obj_w]
    mask <span style="color:#f92672">=</span> obj_img[:, :, <span style="color:#ae81ff">3</span>]

    ret, mask_inv <span style="color:#f92672">=</span> cv<span style="color:#f92672">.</span>threshold(cv<span style="color:#f92672">.</span>bitwise_not(mask), <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">255</span>, cv<span style="color:#f92672">.</span>THRESH_BINARY)

    img1_bg <span style="color:#f92672">=</span> cv<span style="color:#f92672">.</span>bitwise_and(roi, roi, mask<span style="color:#f92672">=</span>mask_inv)
    img2_obj <span style="color:#f92672">=</span> cv<span style="color:#f92672">.</span>bitwise_and(obj_img, obj_img, mask<span style="color:#f92672">=</span>mask)
    dst <span style="color:#f92672">=</span> cv<span style="color:#f92672">.</span>add(img1_bg, img2_obj)

    bg_img[top: obj_h <span style="color:#f92672">+</span> top, left: obj_w <span style="color:#f92672">+</span> left] <span style="color:#f92672">=</span> dst
    
    <span style="color:#66d9ef">return</span> bg_img


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_feature</span>(image_string, label, label_txt, xmins, xmaxs, ymins, ymaxs):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Function that sets the information to write to TFRecord
</span><span style="color:#e6db74">    To use this function, go to the &#34;object detection&#34; directory of the TensorFlow Object Detection API.
</span><span style="color:#e6db74">    You need to bring the &#34;util&#34; library
</span><span style="color:#e6db74">    ----------
</span><span style="color:#e6db74">    image_string: bytes ~ Information about the combined image
</span><span style="color:#e6db74">    label: list-the number of the annotated tag
</span><span style="color:#e6db74">    label_txt: list ~ the annotated tag name
</span><span style="color:#e6db74">    xmins, xmaxs, ymins, ymaxs: list 〜 A value expressed by 0.0 to 1.0 for the annotated coordinates
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    image_shape <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>decode_jpeg(image_string)<span style="color:#f92672">.</span>shape

    feature <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;image/encoded&#39;</span>: dataset_util<span style="color:#f92672">.</span>bytes_feature(image_string),
        <span style="color:#e6db74">&#39;image/format&#39;</span>: dataset_util<span style="color:#f92672">.</span>bytes_feature(<span style="color:#e6db74">&#39;jpg&#39;</span><span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf8&#39;</span>)),
        <span style="color:#e6db74">&#39;image/height&#39;</span>: dataset_util<span style="color:#f92672">.</span>int64_feature(image_shape[<span style="color:#ae81ff">0</span>]),
        <span style="color:#e6db74">&#39;image/width&#39;</span>: dataset_util<span style="color:#f92672">.</span>int64_feature(image_shape[<span style="color:#ae81ff">1</span>]),
        <span style="color:#e6db74">&#39;image/object/bbox/xmin&#39;</span>: dataset_util<span style="color:#f92672">.</span>float_list_feature(xmins),
        <span style="color:#e6db74">&#39;image/object/bbox/xmax&#39;</span>: dataset_util<span style="color:#f92672">.</span>float_list_feature(xmaxs),
        <span style="color:#e6db74">&#39;image/object/bbox/ymin&#39;</span>: dataset_util<span style="color:#f92672">.</span>float_list_feature(ymins),
        <span style="color:#e6db74">&#39;image/object/bbox/ymax&#39;</span>: dataset_util<span style="color:#f92672">.</span>float_list_feature(ymaxs),

        <span style="color:#75715e">#If you add only one information, you can use this commented out function (type is also matched)</span>
        <span style="color:#75715e">#&#39;image/object/class/label&#39;: dataset_util.int64_feature(label),</span>
        <span style="color:#75715e">#&#39;image/object/class/text&#39;: dataset_util.bytes_feature(LABEL.encode(&#39;utf8&#39;)),</span>
        
        <span style="color:#75715e"># If you want to tag more than one tag, use the function with &#34;_list_&#34; below.</span>
        <span style="color:#75715e"># Of course you can use even if there is only one, so it is recommended to use this after all</span>
        <span style="color:#e6db74">&#39;image/object/class/label&#39;</span>: dataset_util<span style="color:#f92672">.</span>int64_list_feature(label),
        <span style="color:#e6db74">&#39;image/object/class/text&#39;</span>: dataset_util<span style="color:#f92672">.</span>bytes_list_feature(label_txt),
    }
    <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>Example(features<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>Features(feature<span style="color:#f92672">=</span>feature))

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():

    <span style="color:#75715e"># Each file path name</span>
    bg_image_path <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;./comp/bg.jpg&#39;</span>
    obj_img_path <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;./comp/Mimmy_image.png&#39;</span>
    comp_img_path <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;./comp/img_comp.jpg&#39;</span>
    tfr_filename <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;./mimmy.tfrecord&#39;</span>

    <span style="color:#75715e">#For TF Record</span>
    tag <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;Mimmy&#39;</span>: <span style="color:#ae81ff">0</span>,<span style="color:#e6db74">&#39;Kitty&#39;</span>: <span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;Mimelo&#39;</span>: <span style="color:#ae81ff">2</span>}
    xmins <span style="color:#f92672">=</span> []
    xmaxs <span style="color:#f92672">=</span> []
    ymins <span style="color:#f92672">=</span> []ymaxs <span style="color:#f92672">=</span> []
    class_label_list <span style="color:#f92672">=</span> []
    class_text_list <span style="color:#f92672">=</span> []
    datas <span style="color:#f92672">=</span> {}

    <span style="color:#75715e">#Set label name</span>
    class_label <span style="color:#f92672">=</span> tag[<span style="color:#e6db74">&#39;Mimmy&#39;</span>]

    <span style="color:#75715e">#Load background</span>
    bg_img <span style="color:#f92672">=</span> cv<span style="color:#f92672">.</span>imread(bg_image_path, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
    bg_img <span style="color:#f92672">=</span> cv<span style="color:#f92672">.</span>cvtColor(bg_img, cv<span style="color:#f92672">.</span>COLOR_RGB2RGBA)
    bg_h, bg_w <span style="color:#f92672">=</span> bg_img<span style="color:#f92672">.</span>shape[:<span style="color:#ae81ff">2</span>]

    <span style="color:#75715e"># Object loading</span>
    obj_img <span style="color:#f92672">=</span> cv<span style="color:#f92672">.</span>imread(obj_img_path, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
    obj_img <span style="color:#f92672">=</span> cv<span style="color:#f92672">.</span>cvtColor(obj_img, cv<span style="color:#f92672">.</span>COLOR_RGB2RGBA)
    scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">250</span> <span style="color:#f92672">/</span> obj_img<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]
    obj_img <span style="color:#f92672">=</span> cv<span style="color:#f92672">.</span>resize(obj_img, dsize<span style="color:#f92672">=</span>None, fx<span style="color:#f92672">=</span>scale, fy<span style="color:#f92672">=</span>scale)
    obj_h, obj_w <span style="color:#f92672">=</span> obj_img<span style="color:#f92672">.</span>shape[:<span style="color:#ae81ff">2</span>]

    <span style="color:#75715e"># Combine background and object</span>
    x <span style="color:#f92672">=</span> int(bg_w <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.45</span>)<span style="color:#f92672">-</span>int(obj_w <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>)
    y <span style="color:#f92672">=</span> int(bg_h <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.89</span>)<span style="color:#f92672">-</span>int(obj_h <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>)
    comp_img <span style="color:#f92672">=</span> img_composition(bg_img, obj_img, x, y)
    
    <span style="color:#75715e"># Export the combined image</span>
    cv<span style="color:#f92672">.</span>imwrite(comp_img_path, comp_img)

    <span style="color:#75715e"># Add to coordinate information list of TFRecord</span>
    xmins<span style="color:#f92672">.</span>append(x <span style="color:#f92672">/</span> bg_w)
    xmaxs<span style="color:#f92672">.</span>append((x <span style="color:#f92672">+</span> obj_w) <span style="color:#f92672">/</span> bg_w)
    ymins<span style="color:#f92672">.</span>append(y <span style="color:#f92672">/</span> bg_h)
    ymaxs<span style="color:#f92672">.</span>append((y <span style="color:#f92672">+</span> obj_h) <span style="color:#f92672">/</span> bg_h)

    <span style="color:#75715e"># Add label information of TFRecord</span>
    class_label_list<span style="color:#f92672">.</span>append(class_label)
    class_text_list<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;Mimmy&#39;</span><span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf8&#39;</span>))
    datas[comp_img_path] <span style="color:#f92672">=</span> class_label

    <span style="color:#75715e">#Process to create TFRecord</span>
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>TFRecordWriter(tfr_filename) <span style="color:#66d9ef">as</span> writer:
        <span style="color:#66d9ef">for</span> data <span style="color:#f92672">in</span> datas<span style="color:#f92672">.</span>keys():
            image_string <span style="color:#f92672">=</span> open(data,<span style="color:#e6db74">&#39;rb&#39;</span>)<span style="color:#f92672">.</span>read()
            tf_example <span style="color:#f92672">=</span> set_feature(image_string, class_label_list, class_text_list, xmins, xmaxs, ymins, ymaxs)
            writer<span style="color:#f92672">.</span>write(tf_example<span style="color:#f92672">.</span>SerializeToString())

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    main()
</code></pre></div><p>Here is the image created after running the program.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/499855/6129dd1c-17e0-66b9-bcfb-36baeb82fe78.jpeg" alt="img_comp.jpg"></p>
<h3 id="source-code-supplement">Source code supplement</h3>
<p>As mentioned in the comment in the source code, please note that the library included in the TensorFlow Object Detection API is required.</p>
<ul>
<li>Required libraries
<ul>
<li><a href="https://github.com/tensorflow/models/tree/master/research/object_detection/utils">utils</a></li>
</ul>
</li>
<li>Sources that are very helpful in generating TFRecord (Calculation of coordinate information such as <code>xmin</code>, <code>ymin</code> etc. was learned here)
<ul>
<li><a href="https://github.com/tensorflow/models/tree/master/research/object_detection/dataset_tools">dataset tools</a></li>
</ul>
</li>
</ul>
<p>This time, for the purpose of explanation, we introduced one image for compositing and the source code to generate one TFRecord file.
But in reality, I think we need to generate a large number of TFRecord files from many more images.</p>
<p>In my case, how to randomly select images from specified folders and combine them,
I tried the method of mass production by making the coordinates to be synthesized a little random.</p>
<p>I hope everyone can tell me if the tips for mass-production of teacher data are understood in the light of this article.</p>
<h3 id="check-the-contents-of-the-created-tfrecord">Check the contents of the created TFRecord</h3>
<p>Finally, just in case, just make sure to copy the contents of the TFRecord file you just created.
Let&rsquo;s check using the method introduced in the first half.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">features</span> {
  <span style="color:#960050;background-color:#1e0010">feature</span> <span style="color:#960050;background-color:#1e0010">{</span>
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/encoded&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">bytes_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#f92672">&#34;\377\330\377...
</span><span style="color:#f92672">        ..... (because of the large amount, omitted)...&#34;</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/format&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">bytes_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#f92672">&#34;jpg&#34;</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/height&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">int64_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">1397</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/object/bbox/xmax&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">float_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0.5151041746139526</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/object/bbox/xmin&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">float_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0.38489583134651184</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/object/bbox/ymax&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">float_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0.9878310561180115</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/object/bbox/ymin&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">float_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0.7916964888572693</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/object/class/label&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">int64_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">0</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/object/class/text&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">bytes_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#f92672">&#34;Mimmy&#34;</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
  <span style="color:#960050;background-color:#1e0010">feature</span> {
    <span style="color:#960050;background-color:#1e0010">key:</span> <span style="color:#f92672">&#34;image/width&#34;</span>
    <span style="color:#960050;background-color:#1e0010">value</span> {
      <span style="color:#960050;background-color:#1e0010">int64_list</span> <span style="color:#960050;background-color:#1e0010">{</span>
        <span style="color:#960050;background-color:#1e0010">value:</span> <span style="color:#960050;background-color:#1e0010">1920</span>
      }
    }
  <span style="color:#960050;background-color:#1e0010">}</span>
<span style="color:#960050;background-color:#1e0010">}</span>
</code></pre></div><p>As mentioned above, it&rsquo;s good only once, so check the contents properly,
If it is the intended value, there will be no problem!</p>
<h2 id="at-the-end">at the end</h2>
<p>For TFRecord format data that is useful for object detection with TensorFlow,
It&rsquo;s a long article, but I&rsquo;ve summarized it to the extent that I can understand.</p>
<p>We hope this article has expanded the scope of teacher data creation.
Thank you for reading through to the end.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
