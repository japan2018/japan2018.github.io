<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Fluid visualization BOS method at home to see invisible things | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Fluid visualization BOS method at home to see invisible things</h1>
<p>
  <small class="text-secondary">
  
  
  Apr 14, 2020
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/physics"> physics</a></code></small>

</p>
<pre><code>#Introduction
</code></pre>
<p>Transparent gas is invisible to the naked eye. Still, there are times when I want to see.
Fluid visualization technologies such as the schlieren method and shadowgraph method are useful in this regard.
This time I will try to visualize this fluid at home.
Basically, you only have to prepare the camera.</p>
<h1 id="references">References</h1>
<p>I experimented with this as a reference.
We recommend reading this page for detailed theory.
<a href="https://www.jstage.jst.go.jp/article/kikaib/77/784/77_784_2391/_article/-char/ja/">Improvement of visualization method of density gradient based on BOS method</a></p>
<h1 id="introduction-of-fluid-visualization-technology">Introduction of fluid visualization technology</h1>
<h2 id="schlieren-method">Schlieren method</h2>
<p>If the density gradient is large, such as the heat haze seen in summer and lighter gas, something may be visible to the naked eye.
The shadowgraph method visualizes these with the same principle that they are visible to the naked eye.
The Schlieren method is a method to further increase the sensitivity of this method.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/455608/96f3788f-0a86-777a-4c98-2ef9fcc8d129.jpeg" alt="schlierens_sam13.jpg">
<a href="https://www.nobby-tech.co.jp/measure/lighting/schlierens.html">NOBBY TECH Schlieren device</a></p>
<p>This optical system has such a configuration.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/455608/cdce9501-c71e-ca3a-68c5-223dd7a5a69c.png" alt="Schlieren principle diagram.png"></p>
<p>The light emitted from the point light source is gathered at one point by the lens. In fact, the focus has some extent. Install the knife edge to block this light by half.
If there is a density gradient (uneven density) on the optical path, the light will be refracted and will not converge at one point. If it is refracted toward the knife edge, it will be blocked and the image on the sensor will be dark, and if it is refracted in the opposite direction, it will be bright. In this way the density gradient can be recorded as brightness information.</p>
<p>This method has high sensitivity and can take beautiful pictures, but it is a little difficult to reproduce at home.
What is difficult is that there are many things that must be prepared first.</p>
<ul>
<li>Point light source (A point light source is created by blocking it with a pinhole. The smaller the diameter of the hole, the smaller the spot diameter of the focal point and the higher the sensitivity. On the other hand, the amount of light also decreases. (A light source is desirable)</li>
<li>Lens (at least 1 because it does not need to be parallel light)</li>
<li>Knife edge</li>
<li>Camera</li>
</ul>
<p>Next is the difficulty of installing the optical system. It takes some effort to match the optical axis.
In particular, the knife edge must be exactly in focus. It would be nice if there was a micro-movement stage, but if not, it needs some kind of ingenuity.</p>
<h2 id="spbos-method-stripe-patterned-background-oriented-schlieren">SPBOS method (Stripe-patterned Background Oriented Schlieren)</h2>
<p>This BOS method is a method that can visualize the density gradient in the same way as the Schlieren method.
This does not require a knife edge.</p>
<p>The optical system is also very simple.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/455608/8edb0bc7-9a1f-a472-6736-5ffc96d61e22.png" alt="BOS Law Principle Diagram.png"></p>
<p>Take two images, a background only image and a photo with a density gradient, and calculate the density gradient from the difference.
There is also a BOS method that uses a random pattern in the background, but that makes the program troublesome because it calculates the cross-correlation like PIV and calculates the deviation.
This time, I will use the SPBOS method that uses a striped pattern to make the program easier.</p>
<p>#Experiment</p>
<h2 id="things-to-prepare">Things to prepare</h2>
<ol>
<li>striped screen</li>
<li>Camera</li>
<li>What you want to measure</li>
</ol>
<p>The one used this time is as follows.</p>
<ol>
<li>iphone8</li>
<li>D5100, AF-S DX NIKKOR 55-300mm f/4.5-5.6G ED VR</li>
<li>Monotaro Air Duster</li>
</ol>
<p>I think the screen can be printed on paper with a smartphone or a printer.</p>
<p>A camera that can save in RAW is preferable.
The D5100 has a bit depth of 14 bits (16383 gradations), but when saved as a jpg, it has only 8 bits (255 gradations) to match the gradation of the display.
And since gamma correction works, it gets worse if it is returned to linear.
A tripod is fine, but I think it&rsquo;s okay to put it on the floor. Be careful not to shake the camera when pressing the shutter.</p>
<h2 id="photograph">photograph</h2>
<p>This time I installed it like this. The focal length is 300 mm, the exposure time is 1/60, the F value is 20, and the ISO sensitivity is 400.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/455608/444ab4bb-0dac-b2c3-6082-0997003a2162.png" alt="BOS Optics Setup.png"></p>
<p>Focus the camera on the screen.</p>
<p>You need to be careful about the distance between the screen and the object to be measured.
If it is too close, the sensitivity will not come out.
Even if there is a density gradient in the immediate vicinity of the screen and the light is bent, the bent light will be imaged at the same position as when it was not bent.
On the contrary, if it is too far, the measured object will be blurred. It corresponds by increasing the F value and increasing the depth of field.</p>
<p>The background image was created with the following program.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np

<span style="color:#75715e"># display</span>
ppi <span style="color:#f92672">=</span> <span style="color:#ae81ff">326</span> <span style="color:#75715e"># pixels per 1inch (25.4mm)</span>
x_pix <span style="color:#f92672">=</span> <span style="color:#ae81ff">750</span> <span style="color:#75715e"># horizontal resolution</span>
y_pix <span style="color:#f92672">=</span> <span style="color:#ae81ff">1334</span> <span style="color:#75715e"># vertical resolution</span>
pix_per_mm <span style="color:#f92672">=</span> ppi <span style="color:#f92672">/</span> <span style="color:#ae81ff">25.4</span>
x_mm <span style="color:#f92672">=</span> x_pix <span style="color:#f92672">/</span> pix_per_mm
y_mm <span style="color:#f92672">=</span> y_pix <span style="color:#f92672">/</span> pix_per_mm
lam <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span> <span style="color:#75715e"># mm</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sin_img</span>(direction<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;x&#34;</span>,bit<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>):
    <span style="color:#66d9ef">if</span> direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;x&#34;</span>:
        x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#ae81ff">0.0</span>,x_mm,x_pix)
        sin <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>sin(<span style="color:#ae81ff">2.0</span><span style="color:#f92672">*</span>np<span style="color:#f92672">.</span>pi<span style="color:#f92672">*</span>x<span style="color:#f92672">/</span>lam)
        img <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>tile(sin,(y_pix,<span style="color:#ae81ff">1</span>))<span style="color:#f92672">.</span>T
        img <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> (img <span style="color:#f92672">+</span> <span style="color:#ae81ff">1.0</span>) <span style="color:#f92672">*</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>bit<span style="color:#f92672">-</span><span style="color:#ae81ff">1.0</span>)
    <span style="color:#66d9ef">elif</span> direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;y&#34;</span>:
        y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#ae81ff">0.0</span>,y_mm,y_pix)
        sin <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>np<span style="color:#f92672">.</span>sin(<span style="color:#ae81ff">2.0</span><span style="color:#f92672">*</span>np<span style="color:#f92672">.</span>pi<span style="color:#f92672">*</span>y<span style="color:#f92672">/</span>lam)
        img <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>tile(sin,(x_pix,<span style="color:#ae81ff">1</span>))
        img <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> (img <span style="color:#f92672">+</span> <span style="color:#ae81ff">1.0</span>) <span style="color:#f92672">*</span> (<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>bit<span style="color:#f92672">-</span><span style="color:#ae81ff">1.0</span>)
        
    <span style="color:#66d9ef">if</span> bit <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span>:
        img <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>uint8)
    <span style="color:#66d9ef">elif</span> bit <span style="color:#f92672">==</span> <span style="color:#ae81ff">16</span>:
        img <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>uint16)
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">print</span> (<span style="color:#e6db74">&#34;bit number is 8 or 16&#34;</span>)
    <span style="color:#66d9ef">return</span> img
</code></pre></div><p>Background taken
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/455608/21cff5bb-17c8-d42c-f8f9-395678480e30.png" alt="ref.png"></p>
<p>There is a measurement object
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/455608/4d446d64-4e94-be2d-ba63-4827232fc011.png" alt="jet.png"></p>
<h2 id="analysis">Analysis</h2>
<p>First, paste the program used for analysis.</p>
<p>RAW images are developed using rawpy. Uses linear scale luminance values without gamma correction.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> rawpy
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">from</span> scipy <span style="color:#f92672">import</span> signal
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> cv2
<span style="color:#f92672">from</span> pathlib <span style="color:#f92672">import</span> Path

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">postproccesing</span>(path):
    raw <span style="color:#f92672">=</span> rawpy<span style="color:#f92672">.</span>imread(str(path))
    <span style="color:#66d9ef">return</span> raw<span style="color:#f92672">.</span>postprocess(gamma<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1.0</span>,<span style="color:#ae81ff">1.0</span>],
                               no_auto_bright<span style="color:#f92672">=</span>True,
                               output_color<span style="color:#f92672">=</span>rawpy<span style="color:#f92672">.</span>ColorSpace<span style="color:#f92672">.</span>raw,
                               use_camera_wb<span style="color:#f92672">=</span>True,
                               use_auto_wb<span style="color:#f92672">=</span>False,
                               output_bps<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>,
                                no_auto_scale<span style="color:#f92672">=</span>True
                              )

ref_path <span style="color:#f92672">=</span> Path(<span style="color:#e6db74">&#34;data/ref2.NEF&#34;</span>)
jet_path <span style="color:#f92672">=</span> Path(<span style="color:#e6db74">&#34;data/jet2.NEF&#34;</span>)

ref_img <span style="color:#f92672">=</span> postproccesing(ref_path)
jet_img <span style="color:#f92672">=</span> postproccesing(jet_path)

ref_gray <span style="color:#f92672">=</span> ref_img[:,:,<span style="color:#ae81ff">1</span>] <span style="color:#75715e"># grayscale</span>
jet_gray <span style="color:#f92672">=</span> jet_img[:,:,<span style="color:#ae81ff">1</span>]
</code></pre></div><p>Visualization simply takes the difference and multiplies the space.
By taking the difference, you can see the part refracted by the density gradient.
Even if the light is bent in the same direction, it will become darker or lighter depending on the background pattern, so it is necessary to multiply by the gradient.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">bos <span style="color:#f92672">=</span> (jet_gray<span style="color:#f92672">-</span>ref_gray) <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>gradient(<span style="color:#ae81ff">0.5</span><span style="color:#f92672">*</span>(jet_gray<span style="color:#f92672">+</span>ref_gray))[<span style="color:#ae81ff">1</span>]
</code></pre></div><p>Apply a low pass filter.
Determine the band while looking at the appearance.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fft_lpf</span>(img,r):
    <span style="color:#75715e">#Frequency space mask</span>
    mask <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros_like(img)
    X,Y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>meshgrid(np<span style="color:#f92672">.</span>arange(img<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>])<span style="color:#f92672">-</span>img<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span>,np<span style="color:#f92672">.</span>arange(img<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])<span style="color:#f92672">-</span>img<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span>)
    mask[np<span style="color:#f92672">.</span>sqrt(X<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> Y<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">&lt;</span>r] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>
    
    <span style="color:#75715e">#FFT</span>
    fft_img <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>fft<span style="color:#f92672">.</span>fftshift(np<span style="color:#f92672">.</span>fft<span style="color:#f92672">.</span>fft2(img))
    fft_img <span style="color:#f92672">*=</span> mask
    <span style="color:#66d9ef">return</span> np<span style="color:#f92672">.</span>abs(np<span style="color:#f92672">.</span>fft<span style="color:#f92672">.</span>fft2(np<span style="color:#f92672">.</span>fft<span style="color:#f92672">.</span>fftshift(fft_img)))
</code></pre></div><p>After applying the low pass filter, save the image and finish.<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/455608/74ab621e-97e2-cc48-3a36-f4dcb599e67c.png" alt="Adjustment.png"></p>
<p>There is a lot of noise, but the jet is well visualized.
It seems that noise can be reduced with a little more effort.</p>
<p>2020/04/14 Addendum
I fixed the camera properly and took a picture again, and adjusted the brightness later to reduce noise.
You can take this beautiful picture.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/455608/329be164-27e6-0a64-35cc-2f275b490a4c.png" alt="Paper implementation.png"></p>
<p>#Summary
I showed that it is possible to visualize fluid as it is with only the ones in the home.
Please, try it.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
