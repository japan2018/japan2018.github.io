<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Django-SES and Amazon SES got stuck when trying to operate mail (introducing the fastest operation procedure) | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Django-SES and Amazon SES got stuck when trying to operate mail (introducing the fastest operation procedure)</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 23, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/django">Django</a></code></small>


<small><code><a href="https://memotut.com/tags/docker">Docker</a></code></small>


<small><code><a href="https://memotut.com/tags/amazonses">amazonses</a></code></small>


<small><code><a href="https://memotut.com/tags/django3.0">Django3.0</a></code></small>

</p>
<pre><code>## Introduction
</code></pre>
<p>This is the 24th day article of <a href="https://qiita.com/advent-calendar/2019/django">Django Advent Calendar 2019</a>.
I wrote this article on Christmas Eve proud of myself thinking about Django. Lol</p>
<p>Even though I&rsquo;m still a beginner, I&rsquo;ve been studying Django, and I&rsquo;ve been stuck for hours at some point (a little new way to do it?). Even if the reference was in English, there were no articles that were just right, so I decided to write this article with the feeling that &ldquo;I do not want other people to stumbl here.&rdquo;</p>
<h2 id="structure-of-this-article">Structure of this article</h2>
<p>First of all, I will introduce the fastest procedure for mail delivery using Django-ses and Amazon-SES to broaden the readership (.･_･.).
Next, I would like to introduce the main part of this issue, the jammed part!</p>
<h2 id="target-audience">Target audience</h2>
<p>As the title says, this is an article for those who are thinking of using &ldquo;<strong>django-ses</strong> and <strong>Amazon SES</strong> (Amazon Simple Email Service) to deliver emails.&rdquo;</p>
<h2 id="development-environment">Development environment</h2>
<ul>
<li>Python: 3.8.0</li>
<li>Django:2.2.9 (*If you build environment with Django:3.0, it will be stuck. <a href="#Themainstoryofthisarticleisajammedstory">Jump to the bottom of the article</a>)</li>
<li>Django-ses:0.8.13</li>
<li>boto3:1.10.44</li>
</ul>
<h2 id="confirm-this-goal">Confirm this goal</h2>
<p>This time, &ldquo;If you can send_mail using Amazon SES and Django-SES, you can achieve your goal! 』I will be.</p>
<ul>
<li>Since it is too difficult to build the environment before the goal, please use Docker to build the environment.</li>
</ul>
<p>The complete form of the program (you need to revise the settings with KEY setting of Amazon SES) is given in <a href="https://github.com/Hirochon/django-ses-sample">Here&rsquo;s GitHub</a>.</p>
<h2 id="create-a-program">Create a program</h2>
<h3 id="docker-file">Docker file</h3>
<p>First, let&rsquo;s put some Docker files on it.
Create the following files under the docker-ses-sample directory.</p>
<pre><code class="language-docker:dockerfile" data-lang="docker:dockerfile">FROM python:3

ENV PYTHONUNBUFFERED 1

RUN mkdir /code
WORKDIR /code

COPY requirements.txt /code/
RUN pip install -r requirements.txt
COPY ./code/
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker-compose:docker-compose.yml" data-lang="docker-compose:docker-compose.yml"><span style="color:#66d9ef">version</span>: <span style="color:#e6db74">&#34;3&#34;</span>
<span style="color:#66d9ef">services</span>:
    <span style="color:#66d9ef">django-ses-sample</span>:
        build:.
        <span style="color:#66d9ef">volumes</span>:
            -.:/code
        <span style="color:#66d9ef">ports</span>:
            -<span style="color:#e6db74">&#34;8000:8000&#34;</span>
        <span style="color:#66d9ef">command</span>: python manage.py runserver <span style="color:#ae81ff">0.0.0.0</span>:<span style="color:#ae81ff">8000</span>
</code></pre></div><p>This is a list of packages to be installed next.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text:requirements.txt" data-lang="text:requirements.txt">Django==2.2.9
boto3==1.10.44
django-ses==0.8.13
</code></pre></div><p>↓ Current directory like this ↓</p>
<pre><code class="language-directly:" data-lang="directly:">django-ses-sample
├ dockerfile
├ docker-compose.yml
└ requirements.txt
</code></pre><p>From here we will start project at once.
First, open the CLI that allows you to play with docker. (I use Ubuntu 18.04 LTS CLI)</p>
<p>Then change to your working directory.</p>
<pre><code class="language-CLI:" data-lang="CLI:">~/$ cd django-ses-sample
~/django-ses-sample$ docker-compose run --rm django-ses-sample django-admin startproject config.
</code></pre><p>By doing this, you can go to startproject while building, so it is easy.
And when such a display comes, it is successful.</p>
<pre><code class="language-cli:docker's" data-lang="cli:docker's">Successfully tagged djangosessample_django-ses-sample:latest
</code></pre><p>And if you can see startproject under django-ses-sample, let&rsquo;s move on to the next one!</p>
<h3 id="django-files">Django files</h3>
<p>Next, you will play around with settings.py in the config created by startproject.
There is a field called INSTALLED_APPS in settings.py, so I will add django_ses here.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:settings.py" data-lang="python:settings.py">     :
INSTALLED_APPS <span style="color:#f92672">=</span> [
         :
    <span style="color:#e6db74">&#39;django_ses&#39;</span>, <span style="color:#75715e"># added</span>
]
</code></pre></div><p>Then scroll to the bottom and add the following program.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:settings.py" data-lang="python:settings.py">    :
<span style="color:#75715e"># AWS settings</span>
AWS_ACCESS_KEY_ID <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;AKI***********&#39;</span> <span style="color:#75715e"># Access key ID</span>
AWS_SECRET_ACCESS_KEY <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;****************************&#39;</span> <span style="color:#75715e"># Secret access key</span>

<span style="color:#75715e"># Email settings</span>
EMAIL_BACKEND <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;django_ses.SESBackend&#39;</span> <span style="color:#75715e"># This is required</span>
DEFAULT_FROM_EMAIL <span style="color:#f92672">=</span> SERVER_EMAIL <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;**** &lt;****@******&gt;&#39;</span> <span style="color:#75715e"># Username and email address of sender (eg:&#39;Asuka &lt;asuka@nogi.com&gt;&#39;)</span>
</code></pre></div><p>You need to set the access key ID and secret access key in this way. This will be created in AWS in the next chapter, so you can leave it blank for now.
Also, EMAIL_BACKEND is set to send mail. Here I declare to use Django-SES.
The last line leaves the sender information.</p>
<p>The program at this point is <a href="https://github.com/Hirochon/django-ses-sample">GitHub here</a>.</p>
<h2 id="go-to-aws-for-various-settings">Go to AWS for various settings</h2>
<h3 id="amazon-ses-registration-procedure">Amazon SES registration procedure</h3>
<p>*In order to use Amazon SES with an account that has not been released from restrictions, it is necessary to register the email address to send and the email address to receive.
<a href="https://docs.aws.amazon.com/ja_jp/ses/latest/DeveloperGuide/limits.html">*1 Amazon SES Documentaition</a></p>
<ol>
<li>
<p>First, prepare an AWS account.</p>
</li>
<li>
<p>After signing in, enter SES (Simple Email Service) at the service and jump to that page.</p>
</li>
<li>
<p>If you used to select Tokyo as the standard region, you should be able to select a region, so be sure to select US East (N. Virginia): us-east-1**. (*I&rsquo;m stuck here. <a href="#Thisarticle'smainsubjectisajammedstory">Jump to the bottom of the article</a>)</p>
</li>
<li>
<p>In the left column, Email Addresses will appear. Select it.</p>
</li>
<li>
<p>Select [Varify a New mail adress] to register an e-mail address that can be received.</p>
</li>
<li>
<p>Here, register another email address that can be received by [Varify a New mail address].</p>
</li>
<li>
<p>Next, an email will come from AWS to the email address you registered in steps 5 and 6. Please access the URL and authenticate your email address.</p>
</li>
<li>
<p>Done</p>
</li>
</ol>
<h3 id="iam-registration">IAM registration</h3>
<p>To use Amazon SES, you need to generate the access key ID and secret access key introduced earlier.</p>
<ol>
<li>Search the IAM page in the service and fly</li>
<li>Select a user in the left column</li>
<li>Select Add User</li>
<li>Enter the user name as you like</li>
<li>Check access by program</li>
<li>Select [Next step] below</li>
<li>Select Attach existing policy directly</li>
<li>Search for SES and select AmazonSESFullAccess</li>
<li>Let&rsquo;s go through and create a user</li>
<li>csv can be downloaded when created, so download</li>
<li>Confirm the access key ID and secret access key with csv</li>
<li>Done</li>
</ol>
<p>Finally, enter your access key ID and secret access key in config/settings.py! !</p>
<h2 id="check-if-ses-works-with-django">Check if SES works with Django</h2>
<p>The confirmation method was the goal of this time &ldquo;If you can send_mail using Amazon SES and Django-SES, you can achieve the goal! ] Because it is use of send_mail, I will import it with a python shell and execute it.</p>
<pre><code class="language-cli:CLI" data-lang="cli:CLI">~/django-ses-sample$ docker-compose run --rm django-ses-sample python3 manage.py shell
&gt;&gt;&gt; from django.core.mail import send_mail
&gt;&gt;&gt; title ='I'm Saito Asuka. '
&gt;&gt;&gt; content ='Are you free for tomorrow's Christmas? '
&gt;&gt;&gt; host_email ='Email address registered with SES ①'# Example: asuka@nogi.com
&gt;&gt;&gt; rece_email = ['The email address registered with SES ②'] # Example: ['hirochon@bocchi.com']
&gt;&gt;&gt; send_mail(title,content,host_email,rece_email)
</code></pre><p>You should now receive an email (crying)</p>
<h2 id="enter-the-main-topic-of-this-article---clogged-story">Enter the main topic of this article! ! ! (Clogged story)</h2>
<p>Please take a look at it as you go. Lol</p>
<p>I will introduce you where you stumbled first!</p>
<ol>
<li><strong>Environment built with Django 3.0</strong></li>
<li><strong>Region set in Mumbai, Asia Pacific</strong></li>
</ol>
<h3 id="-about-the-environment-built-with-django-30">① About the environment built with Django 3.0</h3>
<p>When it&rsquo;s officially released, you&rsquo;ll want to use it&hellip; lol</p>
<p>However, when I build the environment with Django 3.0, I get the following error related to the files of boto or django-ses.</p>
<pre><code class="language-cli:CLI" data-lang="cli:CLI">ImportError: cannot import name'python_2_unicode_compatible' from'django.utils.encoding
</code></pre><p>It seems that Django 3.0 started throwing errors due to the Python 2 compatibility API being abolished.<a href="https://docs.djangoproject.com/en/dev/releases/3.0/#removed-private-python-2-compatibility-apis">*2 Django Official Documentation</a>
<a href="https://github.com/treyhunner/django-simple-history/issues/598">*3 GitHub issue</a></p>
<p>Apparently it seems to be cured if you mess with the file, but the file is not found in the DB in the Docker container (originally developed with PostgreSQL), and the error is no longer emitted by using Django 2.2 series.</p>
<h3 id="region-is-set-in-mumbai-asia-pacific">②Region is set in Mumbai, Asia Pacific</h3>
<p>I was frustrated by the information that I could see, &ldquo;The region closer to your region will have a faster response.&rdquo;</p>
<p>I searched the literature for various problems, but none came to me.
So I decided to write this time.</p>
<p>However, it is likely that experts will point out, so I will write here first.</p>
<p>It was impossible to write the settings in #### settings.py
By setting AWS_SES_REGION_NAME and AWS_SES_REGION_ENDPOINT, region setting other than &ldquo;US East (N. Virginia)&rdquo; (us-east-1) is possible.</p>
<p>For example, &ldquo;US West (Oregon)&rdquo; (us-west-2) can be sent by setting this in settings.py after verifying the email address with Amazon SES.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:settings.py" data-lang="python:settings.py">AWS_ACCESS_KEY_ID <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;AKI***********&#39;</span> <span style="color:#75715e"># Access key ID</span>
AWS_SECRET_ACCESS_KEY <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;**************************&#39;</span> <span style="color:#75715e"># Secret access key</span>
AWS_SES_REGION_NAME <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;us-west-2&#39;</span> <span style="color:#75715e"># Added</span>
AWS_SES_REGION_ENDPOINT <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;email.us-west-2.amazonaws.com&#39;</span> <span style="color:#75715e"># Added</span>
</code></pre></div><p>but! ! ! ** If you use &ldquo;Asia Pacific (Mumbai)&rdquo; (ap-south-1), you will not be able to send email even with this setting! ! **</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:settings.py" data-lang="python:settings.py">AWS_ACCESS_KEY_ID <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;AKI***********&#39;</span> <span style="color:#75715e"># Access key ID</span>
AWS_SECRET_ACCESS_KEY <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;**************************&#39;</span> <span style="color:#75715e"># Secret access key</span>
AWS_SES_REGION_NAME <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ap-south-1&#39;</span> <span style="color:#75715e"># Added</span>
AWS_SES_REGION_ENDPOINT <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;email.ap-south-1.amazonaws.com&#39;</span> <span style="color:#75715e"># Added</span>
</code></pre></div><h4 id="so-what-went-wrong-after-all-">So what went wrong after all? ?</h4>
<p>My conclusion is that there is a service that is implemented in each region and one that is not in AWS, so ** that service was not yet implemented in Asia Pacific (Oregon) ** I&rsquo;m guessing there is.</p>
<p>In fact, it seems that Oregon was recently added to the SES service, and I think that &ldquo;I think it will probably be usable in future updates ~&rdquo; (/･ω･)/</p>
<h2 id="at-the-end">at the end</h2>
<p>Thank you for reading until the end.
By adding the allauth package etc. to the program I made this time, you will be able to implement a solid mail function, so please use the fastest procedure by all means.
If you have any mistakes or impressions, please feel free to comment! !</p>
<p>I&rsquo;m happy if you follow me on Twitter, who is studying backends such as Django, AWS, Docker, etc., and sending out his appearance in making machine learning a little! <img src="https://twitter.com/heacet43" alt="@heacet43"></p>
<h2 id="references">References</h2>
<p>*1 Limits in Amazon SES (Amazon SES Doccumentation Developer Guide) [https://docs.aws.amazon.com/ja_jp/ses/latest/DeveloperGuide/limits.html]
*2 Django 3.0 release notes (Django documentation) [https://docs.djangoproject.com/en/dev/releases/3.0/#removed-private-python-2-compatibility-apis]
*3 Django3 support・Issue #598</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
