<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>I tried to predict horse racing by doing everything from data collection to deep learning | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>I tried to predict horse racing by doing everything from data collection to deep learning</h1>
<p>
  <small class="text-secondary">
  
  
  Nov 18, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/selenium">Selenium</a></code></small>


<small><code><a href="https://memotut.com/tags/deeplearning">DeepLearning</a></code></small>


<small><code><a href="https://memotut.com/tags/beautifulsoup">BeautifulSoup</a></code></small>


<small><code><a href="https://memotut.com/tags/%E7%AB%B6%E9%A6%AC">競馬</a></code></small>

</p>
<pre><code># Overview
</code></pre>
<p>A student majoring in information systems at a certain T university. While looking at various articles of Qiita, I found such an article.</p>
<ul>
<li><a href="https://qiita.com/yossymura/items/334a8f3ef85bff081913">If you have deep learning, you can exceed 100% recovery rate in horse racing</a></li>
</ul>
<p>Regarding the 100% recovery rate in this article, it is unclear whether it will be valid in other periods because the number of betting tickets that were simulated for purchase is small. I don&rsquo;t know the details of how to do it because the source code is paid. However, I thought it would be interesting to try a horse racing prediction myself, so I decided to study and actually tried it.</p>
<p>It will be a lot of learning because you will do all the data collection, analysis and prediction.</p>
<h2 id="why-horse-racing">Why horse racing?</h2>
<p>There was a desire that it might be money, but horse racing seems to have a high deduction rate, so I can not expect much.
The main reason is that it&rsquo;s been a hot topic recently, and I wanted to try deep learning, right?</p>
<p>Other reasons for choosing horse racing include:</p>
<ul>
<li>Race results are less influenced by spectators</li>
<li>If there are enough explanatory variables, it can be predicted with reasonable accuracy</li>
</ul>
<p>Can be mentioned.</p>
<p>It seems to be good to use the theme of stocks, but since the price fluctuates due to the decision-making of many people, it is difficult to predict with good accuracy unless information such as the news that traders often see is incorporated. That&rsquo;s right.
Furthermore, many institutional investors place orders automatically according to an algorithm, which is likely to be influenced by this.</p>
<p>From the above, I thought that it would not be easy to do with the current technology, so I thought horse racing was more suitable for deep learning.</p>
<p>In horse racing, the number of runners varies from race to race, but it seems that the number of competitors in a boat race is constant. It seems that machine learning is easy if detailed data can be obtained.</p>
<h2 id="explanation-to-people-who-are-new-to-horse-racing">Explanation to people who are new to horse racing</h2>
<blockquote>
<p>&ldquo;Horse racing (Keiba, UK: horse racing) is a race competition in which horses are ridden by jockeys and betting that predicts the order of arrival&rdquo; (quoted: <a href="https://ja.wikipedia.org/wiki/horseracing">horse racing-Wikipedia</a>).</p>
</blockquote>
<p>I also had little knowledge of horse racing before doing this data analysis, so I&rsquo;ll summarize what I thought was necessary to read this article.</p>
<p>First of all, let&rsquo;s know about betting ticket types as basic knowledge. All you need to do is lick a single win or a double win.
Reference: [Type of betting ticket: For beginners JRA](<a href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;ved=2ahUKEwjj9cC71eHlAhXgy4sBHXKtA0QQFjAAegQIAhAB&amp;url=http%3F2%2F%3A(jra.go.jp%2Fkouza%2Fbeginner%2Fbaken%2F&amp;usg=AOvVaw12f8T5GSlozZG9tnRspGtC)">https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;ved=2ahUKEwjj9cC71eHlAhXgy4sBHXKtA0QQFjAAegQIAhAB&amp;url=http%3F2%2F%3A(jra.go.jp%2Fkouza%2Fbeginner%2Fbaken%2F&amp;usg=AOvVaw12f8T5GSlozZG9tnRspGtC)</a></p>
<p>Refer to the following for other terms</p>
<ul>
<li>Odds: Multiplier that shows how many times the money you get when you win a win</li>
<li>Rise: the end of the race or training</li>
<li>Horse number: A number that is uniquely assigned to a running horse</li>
<li>Frame number: There are 1 to 8. One number for two gates when starting</li>
<li>Finishing order: Ranking to reach the goal</li>
<li>Central Horse Racing: A horse race held by the Japan Central Horse Racing Association. There are 10 locations in Sapporo, Hakodate, Fukushima, Niigata, Nakayama, Tokyo, Chukyo, Kyoto, Hanshin, and Kokura.</li>
<li>Local Horse Race Track: Unlike the central horse race, a horse race sponsored by a local government</li>
</ul>
<p>Reference: <a href="http://www.jra.go.jp/kouza/yougo/index.html">Horse Racing Dictionary JRA</a></p>
<p>I&rsquo;m not so familiar with it, so please let me know if you are wrong&hellip;</p>
<p>In machine learning, domain knowledge is said to be important, so in order to improve prediction accuracy, it will be necessary to become familiar with horse racing.</p>
<h2 id="general-steps">General steps</h2>
<p>Even if you predict horse racing, there are many things to think and do. Is the procedure roughly divided as follows?</p>
<ol>
<li>Data collection (crawling and scraping)</li>
<li>Data shaping (pandas, SQL, etc.)</li>
<li>Model creation (machine learning)</li>
</ol>
<p>The first major issue for those who want to predict horse racing is the data collection and shaping. In a competition such as Kaggle, it is quite easy because the dataset is given from the beginning, but this time we need to start with data collection.</p>
<p>Also, it is difficult to create a model because various methods can be considered. Recently, you can easily use gradient boosting, deep learning, etc. in the library, but it will be necessary to try various methods to improve prediction accuracy.</p>
<h2 id="prerequisite-knowledge">Prerequisite knowledge</h2>
<ul>
<li>Basic knowledge of HTML, CSS, etc.</li>
<li>Basic usage of Selenium</li>
<li>Basic usage of Beautifulsoup</li>
<li>Basic usage of pandas</li>
<li>Basic usage of keras</li>
</ul>
<h2 id="summary-of-results">Summary of results</h2>
<p>Usage data</p>
<ul>
<li>Learning data: January 2008-July 23, 2017</li>
<li>Verification data: July 23, 2017-November 2019</li>
</ul>
<p>result</p>
<ul>
<li>Win accuracy rate: 0.2450</li>
<li>Correct win rate: 0.5434</li>
</ul>
<p>A model with higher accuracy than myself who was a horse racing beginner was made</p>
<h1 id="lets-start-with-data-collection">Let&rsquo;s start with data collection</h1>
<p>Machine learning is not possible suddenly even if there is no data. Let&rsquo;s do crawling and scraping.</p>
<p>First, get past race results and horse information from the target site.</p>
<p>The data obtained here should be as close as possible to the raw data, and the data will be shaped later for learning.</p>
<h2 id="target-site">Target site</h2>
<ul>
<li><a href="https://db.netkeiba.com">netkeiba.com</a></li>
</ul>
<p>It is the largest horse racing information site in Japan. From past race data to horse pedigree information, you can get pretty detailed data for free.</p>
<p>It seems that you can get more detailed data by becoming a paid member. This is effective when you want to improve the accuracy of the model.</p>
<h2 id="collected-data">Collected data</h2>
<p>This time, we decided to collect data centering on the race results at the Central Racecourse, which has a large amount of information and a unified structure.</p>
<p>We have a lot of data, so you can make a good model by collecting and using various data. However, collecting pedigree information and data such as owners and trainers is quite time-consuming, so I left off this time.
It seems that the prediction accuracy will be improved by adding the data around here.</p>
<h2 id="first-get-the-urls-to-all-races">First, get the URLs to all races</h2>
<p>From the <a href="https://db.netkeiba.com/?pid=race_search_detail">Race Details Search Screen</a> on the site, use Selenium to get all URLs to the race results.</p>
<p>The reason why we do not use requests and BeautifulSoup that are often used when crawling and scraping in Python is that both the search URL and the search result URL are <a href="https:Thisisbecauseithasnotchangedwith//db.netkeiba.com/?pid=race_search_detail">https://db.netkeiba.com/?pid=race_search_detail</a>.</p>
<p>When the screen is dynamically generated by JavaScript or PHP, you cannot get the desired data even if you simply download the html.</p>
<p>With Selenium, you can perform screen transitions with actual browser operations, so you can also perform web crawling on sites whose display changes by clicking such buttons, or sites that require login.
(Please note that crawling is often prohibited by the membership agreement etc. for sites that require login).</p>
<h3 id="first-prepare-what-you-need">First, prepare what you need</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">import</span> time

<span style="color:#f92672">from</span> selenium <span style="color:#f92672">import</span> webdriver
<span style="color:#f92672">from</span> selenium.webdriver.support.ui <span style="color:#f92672">import</span> Select,WebDriverWait
<span style="color:#f92672">from</span> selenium.webdriver.support <span style="color:#f92672">import</span> expected_conditions <span style="color:#66d9ef">as</span> EC
<span style="color:#f92672">from</span> selenium.webdriver.chrome.options <span style="color:#f92672">import</span> Options

options <span style="color:#f92672">=</span> Options()
options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--headless&#39;</span>) <span style="color:#75715e"># go to headless mode</span>
driver <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Chrome(chrome_options<span style="color:#f92672">=</span>options)
wait <span style="color:#f92672">=</span> WebDriverWait(driver,<span style="color:#ae81ff">10</span>)
</code></pre></div><h3 id="fill-the-form-input">Fill the form input</h3>
<p>Fill in the required fields on the form. After sending, wait until the search results are displayed.
<img width="755" alt="Screenshots 2019-11-18 18.09.14.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/288564/aa0f3448-cb2f-1673-5519-9e9d4fd4cec5.png"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://db.netkeiba.com/?pid=race_search_detail&#34;</span>
driver<span style="color:#f92672">.</span>get(URL)
time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
wait<span style="color:#f92672">.</span>until(EC<span style="color:#f92672">.</span>presence_of_all_elements_located)

<span style="color:#75715e">#Search by month</span>
year <span style="color:#f92672">=</span> <span style="color:#ae81ff">2019</span>
month <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>

<span style="color:#75715e"># Choose a period</span>
start_year_element <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element_by_name(<span style="color:#e6db74">&#39;start_year&#39;</span>)
start_year_select <span style="color:#f92672">=</span> Select(start_year_element)
start_year_select<span style="color:#f92672">.</span>select_by_value(str(year))
start_mon_element <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element_by_name(<span style="color:#e6db74">&#39;start_mon&#39;</span>)
start_mon_select <span style="color:#f92672">=</span> Select(start_mon_element)
start_mon_select<span style="color:#f92672">.</span>select_by_value(str(month))
end_year_element <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element_by_name(<span style="color:#e6db74">&#39;end_year&#39;</span>)
end_year_select <span style="color:#f92672">=</span> Select(end_year_element)
end_year_select<span style="color:#f92672">.</span>select_by_value(str(year))
end_mon_element <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element_by_name(<span style="color:#e6db74">&#39;end_mon&#39;</span>)
end_mon_select <span style="color:#f92672">=</span> Select(end_mon_element)
end_mon_select<span style="color:#f92672">.</span>select_by_value(str(month))

<span style="color:#75715e">#Check out the Central Racecourse</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">11</span>):
    terms <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element_by_id(<span style="color:#e6db74">&#34;check_Jyo_&#34;</span><span style="color:#f92672">+</span> str(i)<span style="color:#f92672">.</span>zfill(<span style="color:#ae81ff">2</span>))
    terms<span style="color:#f92672">.</span>click()
        
<span style="color:#75715e"># Select the number of items to display (from 20,50,100 to the maximum 100)list_element = driver.find_element_by_name(&#39;list&#39;)</span>
list_select <span style="color:#f92672">=</span> Select(list_element)
list_select<span style="color:#f92672">.</span>select_by_value(<span style="color:#e6db74">&#34;100&#34;</span>)

<span style="color:#75715e"># Submit form</span>
frm <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element_by_css_selector(<span style="color:#e6db74">&#34;#db_search_detail_form &gt;form&#34;</span>)
frm<span style="color:#f92672">.</span>submit()
time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">5</span>)
wait<span style="color:#f92672">.</span>until(EC<span style="color:#f92672">.</span>presence_of_all_elements_located)
</code></pre></div><p>For the sake of simplicity, I am trying to get the URL for January 2019. If you want more extensive data, do one of the following:</p>
<ul>
<li>Do not fill in the year/month form</li>
<li>Get URL for each year in a loop</li>
<li>Change the range of selected year/month</li>
</ul>
<p>(The code on github collects race data that has not been acquired since 2008.)</p>
<p>If you do not fully fill in the selection of racetracks, data on races held overseas will also be included. Let&rsquo;s properly check 10 central racetracks.</p>
<p>The data other than the Central Racetrack may not be used this time because there may be few run horses or the data may be incomplete.</p>
<h3 id="save-url-while-paging">Save URL while paging</h3>
<p>Click the button on Selenium and save the URLs displayed 100 by 100.
<img width="1074" alt="Screenshots 2019-11-18 18.11.48.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/288564/22c16d3a-597d-7a7d-963a-b2e3ea12c4a9.png"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#66d9ef">with</span> open(str(year)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;-&#34;</span><span style="color:#f92672">+</span>str(month)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.txt&#34;</span>, mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f:
    <span style="color:#66d9ef">while</span> True:
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">5</span>)
        wait<span style="color:#f92672">.</span>until(EC<span style="color:#f92672">.</span>presence_of_all_elements_located)
        all_rows <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element_by_class_name(<span style="color:#e6db74">&#39;race_table_01&#39;</span>)<span style="color:#f92672">.</span>find_elements_by_tag_name(<span style="color:#e6db74">&#34;tr&#34;</span>)
        <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, len(all_rows)):
            race_href<span style="color:#f92672">=</span>all_rows[row]<span style="color:#f92672">.</span>find_elements_by_tag_name(<span style="color:#e6db74">&#34;td&#34;</span>)[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">.</span>find_element_by_tag_name(<span style="color:#e6db74">&#34;a&#34;</span>)<span style="color:#f92672">.</span>get_attribute(<span style="color:#e6db74">&#34;href&#34;</span>)
            f<span style="color:#f92672">.</span>write(race_href<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
        <span style="color:#66d9ef">try</span>:
            target <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_elements_by_link_text(<span style="color:#e6db74">&#34;Next&#34;</span>)[<span style="color:#ae81ff">0</span>]
            driver<span style="color:#f92672">.</span>execute_script(<span style="color:#e6db74">&#34;arguments[0].click();&#34;</span>, target) <span style="color:#75715e">#click processing with javascript</span>
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">IndexError</span>:
            <span style="color:#66d9ef">break</span>
</code></pre></div><p>Open the file and write the obtained URL line by line. The race URL is in the fifth column of the table, so in Python where the elements of the array are 0-based, select <code>find_elements_by_tag_name(&quot;td&quot;)[4]</code> etc.</p>
<p>We will go through the pages in a while loop. I can&rsquo;t click on the last page, so I&rsquo;m using <code>try</code> to catch the exception.</p>
<p>It is the part of <code>driver.execute_script(&quot;arguments[0].click();&quot;, target)</code> in try, but when this is made simple <code>target.click()</code>, <code>ElementClickInterceptedException</code> in headless mode is generated. Has occurred.
Apparently, it seems that the elements were overlapped and I could not click it well. There was a solution on <a href="https://qiita.com/snowp/items/d5892708bc41fa7c4e39#staleelementreferenceexception">here</a>, but I was able to get it to work when I clicked with JavaScript as above.</p>
<h2 id="get-html-based-on-the-obtained-url">Get html based on the obtained URL</h2>
<p>The html obtained earlier doesn&rsquo;t seem to use PHP or JavaScript to display the page, so I&rsquo;ll finally use requests here.
I get the html based on the URL information and save it, but it takes quite a while because it waits a few seconds for each page.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> requests

save_dir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;html&#34;</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">+</span>str(year)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">+</span>str(month)
<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(save_dir):
    os<span style="color:#f92672">.</span>makedirs(save_dir)
        
<span style="color:#66d9ef">with</span> open(str(year)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;-&#34;</span><span style="color:#f92672">+</span>str(month)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> f:
    urls <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>splitlines()
    <span style="color:#66d9ef">for</span> url <span style="color:#f92672">in</span> urls:
        list <span style="color:#f92672">=</span> url<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;/&#34;</span>)
        race_id <span style="color:#f92672">=</span> list[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>]
        save_file_path <span style="color:#f92672">=</span> save_dir<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">+</span>race_id<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;.html&#39;</span>
        response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
        response<span style="color:#f92672">.</span>encoding <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>apparent_encoding
        html <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>text
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">5</span>)
        <span style="color:#66d9ef">with</span> open(save_file_path,<span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> file:
            file<span style="color:#f92672">.</span>write(html)
</code></pre></div><p>Due to the character code, if you obediently acquire it, the characters may be garbled. It worked if I did as <code>response.encoding = response.apparent_encoding</code>.
Reference: <a href="https://qiita.com/nittyan/items/d3f49a7699296a58605b">Correct garbled characters when handling Japanese in Requests</a></p>
<h2 id="parse-html-and-create-csv">Parse html and create csv</h2>
<p>The details of the race and the information of each racehorse will be written in csv. I decided to create a csv with the following format.</p>
<ul>
<li>
<p>Race details
-Race ID
-How many rounds
-Race title
-About the course</p>
<ul>
<li>the weather
-Soil condition
-Date and time</li>
<li>Stadium
-1st to 3rd horse/frame number
-Odds for each betting ticket</li>
</ul>
</li>
<li>
<p>Horse details
-Race ID
-Rank
-Horse ID
-Horse turn
-Frame number
-Gender age
-Burden weight
-Weight and weight difference
-Time
-Wear difference
-Rising time
-Odds
-Popularity</p>
</li>
</ul>
<p>There is other information that can be obtained. It seems that paid members can also get what is called the speed index.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup

CSV_DIR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;csv&#34;</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(CSV_DIR):
    os<span style="color:#f92672">.</span>makedirs(CSV_DIR)
save_race_csv <span style="color:#f92672">=</span> CSV_DIR<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/race-&#34;</span><span style="color:#f92672">+</span>str(year)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;-&#34;</span><span style="color:#f92672">+</span>str(month)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.csv&#34;</span>
horse_race_csv <span style="color:#f92672">=</span> CSV_DIR<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/horse-&#34;</span><span style="color:#f92672">+</span>str(year)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;-&#34;</span><span style="color:#f92672">+</span>str(month)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.csv&#34;</span>

Omitted because <span style="color:#75715e">#race_data_columns, horse_data_columns will be long</span>
race_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(columns<span style="color:#f92672">=</span>race_data_columns )<span style="color:#f92672">.</span>
horse_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(columns<span style="color:#f92672">=</span>horse_data_columns )<span style="color:#f92672">.</span>

html_dir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;html&#34;</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">+</span>str(year)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">+</span>str(month)
<span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(html_dir):
    file_list <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(html_dir)
    <span style="color:#66d9ef">for</span> file_name <span style="color:#f92672">in</span> file_list:
        <span style="color:#66d9ef">with</span> open(html_dir<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">+</span>file_name, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> f:
            html <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
            list <span style="color:#f92672">=</span> file_name<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;.&#34;</span>)
            race_id <span style="color:#f92672">=</span> list[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>]
            race_list, horse_list_list <span style="color:#f92672">=</span> get_rade_and_horse_data_by_html(race_id, html) <span style="color:#75715e"># omitted because it gets longer</span>
            <span style="color:#66d9ef">for</span> horse_list <span style="color:#f92672">in</span> horse_list_list:
                horse_se <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series( horse_list, index<span style="color:#f92672">=</span>horse_df<span style="color:#f92672">.</span>columns)
                horse_df <span style="color:#f92672">=</span> horse_df<span style="color:#f92672">.</span>append(horse_se, ignore_index<span style="color:#f92672">=</span>True)
            race_se <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(race_list, index<span style="color:#f92672">=</span>race_df<span style="color:#f92672">.</span>columns )<span style="color:#f92672">.</span>
            race_df <span style="color:#f92672">=</span> race_df<span style="color:#f92672">.</span>append(race_se, ignore_index<span style="color:#f92672">=</span>True )<span style="color:#f92672">.</span>
            
race_df<span style="color:#f92672">.</span>to_csv(save_race_csv, header<span style="color:#f92672">=</span>True, index<span style="color:#f92672">=</span>False)
horse_df<span style="color:#f92672">.</span>to_csv(horse_race_csv, header<span style="color:#f92672">=</span>True, index<span style="color:#f92672">=</span>False)
</code></pre></div><p>For each race, add details about the race, information about each horse, etc. to the list and add one line to the pandas data frame.</p>
<p>The <code>get_rade_and_horse_data_by_html</code> function, <code>race_data_columns</code>, and <code>horse_data_columns</code> are not included here because they are complicated.
To explain briefly, the <code>get_rade_and_horse_data_by_html</code> function is a function that returns the desired data from html as a list using BeautifulSoup.<code>race_data_columns</code>, <code>horse_data_columns</code> are the column names of the data to retrieve.</p>
<h2 id="other-notes">Other notes</h2>
<p>When crawling, be sure to open it in a timely manner so as not to attack the server.</p>
<p>There are other people who have collected detailed legal notes, so if you want to actually do it, <a href="https://qiita.com/nezuq/items/c5e827e1827e7cb29011">Web scraping notes list-Qiita</a>, etc. for reference.</p>
<h1 id="once-data-is-obtained-we-will-perform-shaping-and-analysis">Once data is obtained, we will perform shaping and analysis</h1>
<p>We were able to get the data in csv format, so let&rsquo;s clean the data so that it can be handled easily.</p>
<p>Next, think about what kind of model to make while looking at the state of the data. After that, let&rsquo;s create the train data according to the model you want to create.</p>
<h2 id="format-the-data-so-that-it-is-easy-to-handle">Format the data so that it is easy to handle</h2>
<p>Let&rsquo;s format the data so that it can be handled easily.</p>
<p>For example, convert date data or numerical value of character string to datetime object or int. Also, since it is easier for the data in one column to be as simple as possible in the future, we will divide gender and age into two columns.
There are many things to do.</p>
<p>It might have been better to do it at the same time when scraping, but since the scraping code seems to be complicated, I decided to do it separately this time.</p>
<p>Below are some of them.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#75715e"># Extract time information and combine with date information. datetime type</span>
race_df[<span style="color:#e6db74">&#34;time&#34;</span>] <span style="color:#f92672">=</span> race_df[<span style="color:#e6db74">&#34;time&#34;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;Start: (\d\d):(\d\d)(.|</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">)*&#39;</span>, <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\1 hour\2 Minutes&#39;</span>)
race_df[<span style="color:#e6db74">&#34;date&#34;</span>] <span style="color:#f92672">=</span> race_df[<span style="color:#e6db74">&#34;date&#34;</span>] <span style="color:#f92672">+</span> race_df[<span style="color:#e6db74">&#34;time&#34;</span>]
race_df[<span style="color:#e6db74">&#34;date&#34;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(race_df[<span style="color:#e6db74">&#39;date&#39;</span>], format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;%Y year %m month </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> day %H hour %M minute&#39;</span>)
<span style="color:#75715e"># Delete the original time because it is unnecessary</span>
race_df<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#39;time&#39;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, inplace<span style="color:#f92672">=</span>True)

<span style="color:#75715e">#Remove some extra rounds, blanks, and newlines in some round columns</span>
race_df[<span style="color:#e6db74">&#39;race_round&#39;</span>] <span style="color:#f92672">=</span> race_df[<span style="color:#e6db74">&#39;race_round&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>strip(<span style="color:#e6db74">&#39;R </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</code></pre></div><h2 id="data-analysis">Data analysis</h2>
<p>We will analyze the shaped data and roughly check what kind of distribution it has. When creating a model, it is important to train so that there is no bias in the data as much as possible, so it is important for problem setting of the model.</p>
<p>In addition, data analysis is also important when considering how to use the feature amount.
In the case of deep learning, it seems that it is not necessary to be particular about feature quantity engineering, but when performing ordinary machine learning that is not deep such as gradient boosting such as LightGBM, it is necessary to carefully consider how to set the feature quantity. there is.</p>
<p>Even with Kaggle, it seems that if you can find a good feature amount, you will be able to get into the higher ranks.</p>
<h2 id="creating-train-data">Creating train data</h2>
<p>Let&rsquo;s create the train data after deciding what kind of model to make while referring to the data analysis etc.</p>
<p>The input data is as follows.</p>
<ul>
<li>Information on the race you want to predict
-Horse turn
-Frame number
-Age
-Burden weight
-Weight
-Weight change from last time
-Burden weight/weight</li>
<li>sex
-Distance
-Number of horses participating in the race
-Whether it is an obstacle race
-Ground condition
-Grass or dirt
-Whether the course is clockwise, counterclockwise or straight
-Weather</li>
<li>venue
-Whether the jockey or owner has changed from the last time
-Time difference from the last race</li>
<li>Information on the last 5 races
-Same content as the race information you want to predict
-Rank
-Goal time
-Average of middle rank
-Rising time
-Average speed</li>
</ul>
<p>The odds of the race you want to predict will change until just before the match, so we will not include it in the data.</p>
<h1 id="finally-create-a-model-deep-learning">Finally create a model (deep learning)</h1>
<p>First of all, I would like to give you an overview. This time, we will perform deep learning with keras.
With the data of a certain horse as input,</p>
<ul>
<li>Model that predicts the probability of becoming first place</li>
<li>A model that predicts the probability of being in the third place</li>
</ul>
<p>I made two.</p>
<h2 id="how-did-you-decide-on-the-model">How did you decide on the model</h2>
<p>It is necessary to consider whether to solve the classification problem or the regression problem.</p>
<p>In the case of a regression problem, I think that it will predict how many horses will be (for example 1.2 will be allowed) and time.</p>
<p>In the case of a classification problem, it will be possible to predict how many horses will be ranked (this is classified by a natural number from 1 to 16), whether it will be ranked first, whether it will rank high, etc. ..</p>
<p>Times and speeds vary greatly depending on the racetrack and course, so it would be difficult to predict them separately. This time, simply let us predict &ldquo;whether it will be in the top&rdquo; as a classification problem.</p>
<h2 id="what-you-did-in-creating-the-model-and-how-to-deal-with-over-learning">What you did in creating the model and how to deal with over-learning</h2>
<p>In creating the model, I will write about the various trials.</p>
<p>Even if a model is created, it is essential to make sure that it does not overlearn and verify whether or not overlearning.
Even if you use machine learning to obtain good results with your data, that model does not always predict other data with good accuracy.</p>
<h3 id="split-dataset-for-learning-and-testing">Split dataset for learning and testing</h3>
<p>First, from the basics.
There&rsquo;s no point in making a model if you can&rsquo;t evaluate whether it&rsquo;s good or not.</p>
<p>80% of the collected and shaped data was used as learning data and 20% was used as test data. That is,</p>
<ul>
<li>Learning data: January 2008-July 23, 2017</li>
<li>Test data: July 23, 2017-November 2019</li>
</ul>
<p>Is the form. The correct answer rate I wrote at the beginning uses this test data.</p>
<p>At the time of learning, the learning data was further divided into a training data and a validation data.</p>
<h3 id="weight-regularization-and-dropouts">Weight regularization and dropouts</h3>
<p>Regularization of weights and dropouts are methods to suppress overfitting, and keras can easily use them.</p>
<p>Weighting is the regularization of weights to add the cost according to the weight to the loss function of the network, and the dropout is to make the feature quantity from the layer at the time of training randomly (drop).</p>
<p>L2 regularization was used for regularization of weights.</p>
<p>Reference: <a href="https://www.tensorflow.org/tutorials/keras/overfit_and_underfit?hl=ja">Learn about over-learning and under-learning | TensorFlow Core</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
model <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>Sequential((
        tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">300</span>, kernel_regularizer<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>regularizers<span style="color:#f92672">.</span>l2(<span style="color:#ae81ff">0.001</span>), activation<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>relu, input_dim<span style="color:#f92672">=</span>df_columns_len), <span style="color:#75715e"># l2 Regularized layer</span>
        tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dropout(<span style="color:#ae81ff">0.2</span>), <span style="color:#75715e">#Dropout</span>
        tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">100</span>, kernel_regularizer<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>regularizers<span style="color:#f92672">.</span>l2(<span style="color:#ae81ff">0.001</span>), activation<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>relu), <span style="color:#75715e"># l2 Layer with regularization added</span>
        tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dropout(<span style="color:#ae81ff">0.2</span>), <span style="color:#75715e">#Dropout</span>
        tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">1</span>, activation<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>sigmoid)
    ])
</code></pre></div><h3 id="cross-validation">Cross validation</h3>
<p>A simple holdout verification using only a specific time period may happen to overlearn to give good results in that time period.</p>
<p>As with cross-validation performed in competitions such as Kaggle, let&rsquo;s verify with the data at hand whether it is a good model.</p>
<p>The problem is that it is time series data, so KFold, which simply divides the data, should not be used.
When inputting time-series data, if the future information is train and the past information is validation, the result may be better than it should be. Actually, I made a mistake by first inputting future data and learning it, but the prediction probability of multiple wins exceeded 70%.</p>
<p>So, this time, I tried to use the splitting method used in cross-validation of time series data (sklearn&rsquo;s <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.TimeSeriesSplit.html">TimeSeriesSplit</a>).</p>
<p>Roughly speaking, as shown in the figure below, the data set is divided in consideration of the time series, and part of it is used as verification data.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/288564/e59fd819-383c-a3cd-713d-0cabed777406.png" alt="Copy of Presentation 1 .png"></p>
<p>In this figure, you will learn 3 times.
However, some learning data will be small, so if the number of data is small, simple holdout may be better.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tscv <span style="color:#f92672">=</span> TimeSeriesSplit(n_splits<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
<span style="color:#66d9ef">for</span> train_index, val_index <span style="color:#f92672">in</span> tscv<span style="color:#f92672">.</span>split(X_train,Y_train):
    train_data<span style="color:#f92672">=</span>X_train[train_index]
    train_label<span style="color:#f92672">=</span>Y_train[train_index]
    val_data<span style="color:#f92672">=</span>X_train[val_index]
    val_label<span style="color:#f92672">=</span>Y_train[val_index]
    model <span style="color:#f92672">=</span> train_model(train_data,train_label,val_data,val_label,target_name)
</code></pre></div><h3 id="hyper-parameter-tuning">Hyper Parameter Tuning</h3>
<p>Hyperparameters are important in machine learning.
For example, in deep learning, the larger the intervening layer, the more intermediate variables, and the less training data, the easier it is to overfoot. On the other hand, if it is small, it may not be able to learn correctly due to lack of flexibility even if the data amount is sufficient.</p>
<p>There will be various discussions about the method. This seems to vary from person to person.</p>
<p>This time, there was a library called hyperas that automatically adjusted the parameter tuning of keras, so I decided to use it. It was relatively intuitive and easy to understand.</p>
<p>As a simple usage, just pass two of the data preparation function and the function that returns the value you want to minimize by train to <code>optim.minimize</code>.</p>
<p>The width to be adjusted is specified by <code>choice</code> for integer values and <code>uniform</code> for real numbers.詳しくはこちらを参考に：<a href="https://github.com/maxpumperla/hyperas">https://github.com/maxpumperla/hyperas</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> keras
<span style="color:#f92672">from</span> keras.callbacks <span style="color:#f92672">import</span> EarlyStopping
<span style="color:#f92672">from</span> keras.callbacks <span style="color:#f92672">import</span> CSVLogger
<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> Sequential
<span style="color:#f92672">from</span> keras.layers.core <span style="color:#f92672">import</span> Dense, Dropout, Activation

<span style="color:#f92672">from</span> hyperopt <span style="color:#f92672">import</span> Trials, STATUS_OK, tpe
<span style="color:#f92672">from</span> hyperas <span style="color:#f92672">import</span> optim
<span style="color:#f92672">from</span> hyperas.distributions <span style="color:#f92672">import</span> choice, uniform
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">prepare_data_is_hukusyo</span>():
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    ここでデータの準備を色々やる
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">return</span> X_train, Y_train, X_test, Y_test

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_model_is_hukusyo</span>(X_train, Y_train, X_test, Y_test):
    train_size <span style="color:#f92672">=</span> int(len(Y_train) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.8</span>)
    train_data <span style="color:#f92672">=</span> X_train[<span style="color:#ae81ff">0</span>:train_size]
    train_label <span style="color:#f92672">=</span> Y_train[<span style="color:#ae81ff">0</span>:train_size]
    val_data <span style="color:#f92672">=</span> X_train[train_size:len(Y_train)]
    val_label <span style="color:#f92672">=</span> Y_train[train_size:len(Y_train)]

    callbacks <span style="color:#f92672">=</span> []
    callbacks<span style="color:#f92672">.</span>append(EarlyStopping(monitor<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;val_loss&#39;</span>, patience<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>))

    model <span style="color:#f92672">=</span> Sequential()
    model<span style="color:#f92672">.</span>add(Dense({{choice([<span style="color:#ae81ff">512</span>,<span style="color:#ae81ff">1024</span>])}}, kernel_regularizer<span style="color:#f92672">=</span>keras<span style="color:#f92672">.</span>regularizers<span style="color:#f92672">.</span>l2(<span style="color:#ae81ff">0.001</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;relu&#34;</span>, input_dim<span style="color:#f92672">=</span>train_data<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]))
    model<span style="color:#f92672">.</span>add(Dropout({{uniform(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.3</span>)}}))
    model<span style="color:#f92672">.</span>add(Dense({{choice([<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">512</span>])}}, kernel_regularizer<span style="color:#f92672">=</span>keras<span style="color:#f92672">.</span>regularizers<span style="color:#f92672">.</span>l2(<span style="color:#ae81ff">0.001</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;relu&#34;</span>))
    model<span style="color:#f92672">.</span>add(Dropout({{uniform(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.5</span>)}}))

    <span style="color:#66d9ef">if</span> {{choice([<span style="color:#e6db74">&#39;three&#39;</span>, <span style="color:#e6db74">&#39;four&#39;</span>])}} <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;three&#39;</span>:
        <span style="color:#66d9ef">pass</span>
    <span style="color:#66d9ef">elif</span> {{choice([<span style="color:#e6db74">&#39;three&#39;</span>, <span style="color:#e6db74">&#39;four&#39;</span>])}} <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;four&#39;</span>:
        model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">8</span>, kernel_regularizer<span style="color:#f92672">=</span>keras<span style="color:#f92672">.</span>regularizers<span style="color:#f92672">.</span>l2(<span style="color:#ae81ff">0.001</span>), activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;relu&#34;</span>))
        model<span style="color:#f92672">.</span>add(Dropout({{uniform(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.5</span>)}}))

    model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">1</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sigmoid&#34;</span>))

    model<span style="color:#f92672">.</span>compile(
        loss<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;binary_crossentropy&#39;</span>,
        optimizer<span style="color:#f92672">=</span>keras<span style="color:#f92672">.</span>optimizers<span style="color:#f92672">.</span>Adam(),
        metrics<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;accuracy&#39;</span>])

    history <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>fit(train_data,
        train_label,
        validation_data<span style="color:#f92672">=</span>(val_data, val_label),
        epochs<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>,
        batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">256</span>,
        callbacks<span style="color:#f92672">=</span>callbacks)

    val_loss, val_acc <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>evaluate(X_test, Y_test, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Best validation loss of epoch:&#39;</span>, val_loss)
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;loss&#39;</span>: val_loss, <span style="color:#e6db74">&#39;status&#39;</span>: STATUS_OK, <span style="color:#e6db74">&#39;model&#39;</span>: model}

<span style="color:#75715e"># 実際にhyperasで調整する</span>
best_run, best_model <span style="color:#f92672">=</span> optim<span style="color:#f92672">.</span>minimize(model<span style="color:#f92672">=</span>create_model_is_hukusyo,
                                     data<span style="color:#f92672">=</span>prepare_data_is_hukusyo,
                                     algo<span style="color:#f92672">=</span>tpe<span style="color:#f92672">.</span>suggest,
                                     max_evals<span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>,
                                     trials<span style="color:#f92672">=</span>Trials())
</code></pre></div><h3 id="結果をblendする">結果をblendする</h3>
<p>様々なモデルから得られた出力を混ぜることで、より良い精度の予測ができることがあります。</p>
<p>1位の予測と、3位以上の予測を平均することで、もともとの予測値よりも若干高い値を得ることができました。</p>
<p>1位になりやすそうな馬の特徴と、上位に入りそうな馬の特徴というのは微妙に異なる可能性があり、両者を混ぜることでより精度の高い予測が可能になっていると考えられます。</p>
<p>例えば、1位になる可能性はあるがレース途中でだめそうだったら無理をしない（させない）馬と、安定して上位に入る馬というのは特徴が少し異なりそうです。</p>
<h1 id="結果">結果</h1>
<p>最終的に競馬初心者の自分よりも精度が高いモデルができました。</p>
<ul>
<li>単勝正解率: 0.2450</li>
<li>複勝正解率: 0.5434</li>
</ul>
<p>競馬で重要そうな情報はまだまだあるので、改善の余地がありそうですね。</p>
<p>単勝で1位のものを買い続けた時の収支は以下の通り。pandasを使って適当にプロットしました。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/288564/e59ad2fc-ffab-3353-e2ac-289471f80cfe.png" alt="image.png"></p>
<p>複勝では以下のようになりました。</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/288564/bd77b7ca-aae4-0734-5ed8-7cdb96012913.png" alt="image.png"></p>
<p>大赤字ですね。
予測値の高いものだけを買うようにしたり、低いオッズのものを買わないようにすればもう少しマシになるでしょう。</p>
<h1 id="その他のtips">その他のtips</h1>
<p>今回の競馬予測をするにあたって、やってみたことのうち、本筋とは関係の無いことをいくつか残しておきます。</p>
<h2 id="gcpを使う">GCPを使う</h2>
<p>GCPの無料クレジットの期限が11月末辺りに切れそうだったので、それを消費するのが2つ目の目的でした。</p>
<p>寝る前にプログラムを投げて朝起きたら確認、ということができます。</p>
<p>無料インスタンスではCSVの作成やディープラーニングのためのメモリが足りないので、GCPを使うかたは気をつけて下さい。</p>
<h2 id="line-notifyで通知">LINE Notifyで通知</h2>
<p>GCPに関連してですが、プログラムが終了したかや、エラーが起きたかどうかをLINE Notifyで送るようにしていました。</p>
<p>終わったらすぐに結果を確認して、次のプログラムを実行することができるので、かなり捗りました。</p>
<h1 id="終わりにいくつか">終わりにいくつか</h1>
<p>学生の適当な余興なので、詳しい方から見ると色々と突っ込みどころがあると思います。間違いなどあれば、勉強になるので、コメントなりツイッターなりで優しくご指摘頂けると嬉しいです。</p>
<p>ツイッターID(あまりつぶやきません)：<a href="https://mobile.twitter.com/634kami">@634kami</a></p>
<h2 id="ソースコード">ソースコード</h2>
<p>github上で公開しています。とりあえず動くものを作りたかったので、あまり人に見せられるものではないのですが、それでも良いとおっしゃる方だけ御覧ください。</p>
<ul>
<li><a href="https://github.com/unonao/race-predict">https://github.com/unonao/race-predict</a></li>
</ul>
<p>Qiita上のコードは見やすくするため一部を変更しています。</p>
<h2 id="改善できそうなところやってみたいこと">改善できそうなところ・やってみたいこと</h2>
<ul>
<li>入力値の欠損データは0埋めしたので、完全なデータだけを予測するようにする</li>
<li>血統データを入れる</li>
<li>騎手データを入れる</li>
<li>LightGBMなどの勾配ブースティングを使ってみる</li>
<li>同着レースのスクレイピングに失敗していたので、完全なデータにする</li>
<li>etc</li>
</ul>
<h2 id="その他参考にしたorなりそうなリンク">その他参考にしたorなりそうなリンク</h2>
<ul>
<li><a href="https://qiita.com/yossymura/items/334a8f3ef85bff081913">ディープラーニングさえあれば、競馬で回収率100%を超えられる</a></li>
<li><a href="https://qiita.com/shinmura0/items/50af5483b6dfda677b32">ディープラーニングで競馬予想</a></li>
<li><a href="https://qiita.com/ishizakiiii/items/3b894b6e987fdf87093e">大井競馬で帝王賞を機械学習で当てた話</a></li>
<li><a href="http://stockedge.hatenablog.com/entry/2016/01/03/103428">競馬の予測をガチでやってみた</a></li>
<li><a href="https://alphaimpact.jp/2017/03/02/classification-and-regression/">第7回 競馬予測を機械学習で解くための方法と評価方法</a></li>
<li><a href="https://upura.hatenablog.com/entry/2018/12/04/224436">validationの切り方いろいろ（sklearnの関数まとめ）【kaggle Advent Calendar 4日目】</a></li>
</ul>
<h1 id="追記">追記</h1>
<p>以下のことを行ったので追記です。</p>
<ul>
<li>trainデータに7頭以下レースの情報が含まれているので削除</li>
<li>trianデータから障害レースを削除</li>
<li>レース頭数ごとの正解率を算出</li>
</ul>
<p>以下結果です。</p>
<pre><code>total: 8, random tansyo accuracy:0.125, hukusyo accuracy:0.375
tansyo accuracy: 0.3497536945812808
hukusyo accuracy: 0.7044334975369458

total: 9, random tansyo accuracy:0.1111111111111111, hukusyo accuracy:0.3333333333333333
tansyo accuracy: 0.2693726937269373
hukusyo accuracy: 0.6568265682656826total: 10, random tansyo accuracy:0.1, hukusyo accuracy:0.3
tansyo accuracy: 0.30563002680965146
hukusyo accuracy: 0.6407506702412868

total: 11, random tansyo accuracy:0.09090909090909091, hukusyo accuracy:0.2727272727272727
tansyo accuracy: 0.2582278481012658
hukusyo accuracy: 0.5468354430379747

total: 12, random tansyo accuracy:0.08333333333333333, hukusyo accuracy:0.25
tansyo accuracy: 0.2600806451612903
hukusyo accuracy: 0.5826612903225806

total: 13, random tansyo accuracy:0.07692307692307693, hukusyo accuracy:0.23076923076923078
tansyo accuracy: 0.2894736842105263
hukusyo accuracy: 0.5855263157894737

total: 14, random tansyo accuracy:0.07142857142857142, hukusyo accuracy:0.21428571428571427
tansyo accuracy: 0.23014586709886548
hukusyo accuracy: 0.5380875202593193

total: 15, random tansyo accuracy:0.06666666666666667, hukusyo accuracy:0.2
tansyo accuracy: 0.2525399129172714
hukusyo accuracy: 0.532656023222061
</code></pre><p>どの場合でも、完全なランダムな選び方よりも優れた正解率がでました。</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
