<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] [Introduction to TensorBoard: image] Visualize TensorFlow image processing to deepen understanding | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] [Introduction to TensorBoard: image] Visualize TensorFlow image processing to deepen understanding</h1>
<p>
  <small class="text-secondary">
  
  
  Jul 27, 2017
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/deeplearning">DeepLearning</a></code></small>


<small><code><a href="https://memotut.com/tags/image">image</a></code></small>


<small><code><a href="https://memotut.com/tags/tensorflow">TensorFlow</a></code></small>


<small><code><a href="https://memotut.com/tags/tensorboard">Tensorboard</a></code></small>

</p>
<pre><code>#TensorBoard accelerates understanding of TensorFlow
</code></pre>
<p>I output to TensorBoard in order to check the process of convolution processing and pooling processing of TensorFlow. It is a memo of the image confirmation method at that time. As a premise, please refer to <a href="http://qiita.com/FukuharaYohei/items/7ea120005f73cf882146">[[Introduction to TensorBoard] Visualize TensorFlow process to deepen understanding]</a> for basic usage.
Environment: python3.5 tensorflow1.21</p>
<h6 id="reference-link">Reference link</h6>
<blockquote>
<p>-<a href="http://qiita.com/FukuharaYohei/items/d8f82c827e0bae70096a">Installing TensorFlow on Windows It was easy even for beginners of Python</a>
-<a href="http://qiita.com/FukuharaYohei/items/0825c3518d8596c09396">[Explanatory commentary] TensorFlow basic syntax and concept</a>
-<a href="http://qiita.com/FukuharaYohei/items/10b89275efda2a22e9c5">[Commentary for beginners] TensorFlow tutorial MNIST (for beginners)</a>
-<a href="http://qiita.com/FukuharaYohei/items/7ea120005f73cf882146">[Introduction to TensorBoard] Visualize TensorFlow processing to deepen understanding</a>
-<a href="https://qiita.com/FukuharaYohei/items/70f702ee85e23b5b1e26">[Introduction to TensorBoard: Projector] Making TensorFlow processing look cool</a>
-[TensorFlow tutorial MNIST (for beginners) visualized with TensorBoard]
(<a href="http://qiita.com/FukuharaYohei/items/2834cc054a8b8884e150">http://qiita.com/FukuharaYohei/items/2834cc054a8b8884e150</a>)
-<a href="http://qiita.com/FukuharaYohei/items/0aef74a0411273705512">[Commentary for Beginners] TensorFlow Tutorial Deep MNIST</a>
-<a href="http://qiita.com/FukuharaYohei/items/f9bb9a0afd47be9ecef8">TensorFlow API memo</a>
-<a href="http://qiita.com/FukuharaYohei/items/c3fb29fc8b42e0dfad0f">In order to understand TensorFlow, I checked the facial features of Yuki Kashiwagi [Part 1]</a></p>
</blockquote>
<p>Simple logic of #TensorBoard(Image)</p>
<h2 id="view-handwritten-numeric-characters-mnist">View handwritten numeric characters (MNIST)</h2>
<p>Let&rsquo;s just write the code to see the handwritten numeric characters (MNIST).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#f92672">import</span> tensorflow <span style="color:#66d9ef">as</span> tf
sess <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>InteractiveSession()
<span style="color:#75715e"># Read MNIST data</span>
<span style="color:#f92672">from</span> tensorflow.examples.tutorials.mnist <span style="color:#66d9ef">import</span> input_data
mnist <span style="color:#f92672">=</span> input_data<span style="color:#f92672">.</span>read_data_sets(<span style="color:#e6db74">&#39;MNIST_data&#39;</span>, one_hot<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)

<span style="color:#75715e"># TensorBoard information output directory</span>
log_dir <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/tmp/tensorflow/test/tensorboard_image01&#39;</span>

<span style="color:#75715e">#Delete and recreate the specified directory</span>
<span style="color:#66d9ef">if</span> tf<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>Exists(log_dir):
    tf<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>DeleteRecursively(log_dir)
tf<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>MakeDirs(log_dir)

<span style="color:#75715e">#Placeholder for image data</span>
x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>placeholder(tf<span style="color:#f92672">.</span>float32, shape<span style="color:#f92672">=</span>[<span style="color:#66d9ef">None</span>, <span style="color:#ae81ff">784</span>])

<span style="color:#75715e"># Convert images to 28 x 28 and output 10 to Tensorboard</span>
_ <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>image(<span style="color:#e6db74">&#39;image&#39;</span>, tf<span style="color:#f92672">.</span>reshape(x, [<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">1</span>]), <span style="color:#ae81ff">10</span>)
merged <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>merge_all()

<span style="color:#75715e"># minst image acquisition</span>
batch <span style="color:#f92672">=</span> mnist<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>next_batch(<span style="color:#ae81ff">10</span>)

<span style="color:#75715e"># Execute</span>
summary <span style="color:#f92672">=</span> sess<span style="color:#f92672">.</span>run(merged, feed_dict<span style="color:#f92672">=</span>{x: batch[<span style="color:#ae81ff">0</span>]})

<span style="color:#75715e">#Writer processing</span>
summary_writer <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>FileWriter(log_dir, sess<span style="color:#f92672">.</span>graph)
summary_writer<span style="color:#f92672">.</span>add_summary(summary)
summary_writer<span style="color:#f92672">.</span>close()
</code></pre></div><p>Then start Tensorboard. Since my environment is built with Anaconda, I first start Terminal from Anaconda Navigator.
<img src="https://qiita-image-store.s3.amazonaws.com/0/134273/f9d2c32d-708c-1878-e6c7-fe6b0b74cfa7.jpeg" alt="30.TensorFlow_Install01.JPG"></p>
<p>Then, start Tensorbaord from Terminal by specifying the directory (the directory is stored in the variable log_dir in the Python program).</p>
<pre><code class="language-none" data-lang="none">tensorboard --logdir=/tmp/tensorflow/mnist/logs/simple01
</code></pre><p>After launching, open http://localhost:6006/ in your browser and the TensorBoard screen will appear.</p>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/134273/ce162beb-3bed-6cd5-6f98-35cc94fc43f3.jpeg" alt="TensorBoardBasic00.JPG"></p>
<p>I am angry that &ldquo;No scalar data was found&rdquo;, but this time, there is no problem because scalar is not output and only Graph is output. You can see the image by selecting &ldquo;Images&rdquo; from the menu on the screen.
<img src="https://qiita-image-store.s3.amazonaws.com/0/134273/377860d3-1cb9-1e0d-6f34-656c8037e9e3.jpeg" alt="10.MNIST_Images01.JPG"></p>
<h2 id="view-images-in-local-file">View images in local file</h2>
<p>###Explanation
Reads and outputs a local file. For the local file reading method, I referred to the article <a href="http://qiita.com/mine820/items/f33bd93ed1b9f79a11e5">&ldquo;Preparation for reading the original data set&rdquo;</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#f92672">import</span> tensorflow <span style="color:#66d9ef">as</span> tf
sess <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>InteractiveSession()

<span style="color:#75715e"># TensorBoard information output directory</span>
log_dir <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/tmp/tensorflow/test/tensorboard_image02&#39;</span>

<span style="color:#75715e">#Delete and recreate the specified directory</span>
<span style="color:#66d9ef">if</span> tf<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>Exists(log_dir):
    tf<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>DeleteRecursively(log_dir)
tf<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>MakeDirs(log_dir)

<span style="color:#75715e">#File location (Note that there are two &#34;\&#34; because &#34;C:\\&#34; part is escape processing)</span>
jpg <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>read_file(<span style="color:#e6db74">&#39;C:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Users\yohei.fukuhara\Pictures\Saved Pictures\Sample Pictures\Koala.jpg&#39;</span>)

<span style="color:#75715e"># JPEG file decoding (there is also tf.image.decode_png and the versatile tf.image.decode_image)</span>
img_raw <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>image<span style="color:#f92672">.</span>decode_jpeg(jpg, channels<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)

<span style="color:#75715e"># Get image size (can also be checked from image file properties)</span>
img_shape <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>shape(img_raw)

<span style="color:#75715e"># Output image to Tensorboard</span>
_ <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>image(<span style="color:#e6db74">&#39;local&#39;</span>, tf<span style="color:#f92672">.</span>reshape(img_raw, [<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, img_shape[<span style="color:#ae81ff">0</span>], img_shape[<span style="color:#ae81ff">1</span>], img_shape[<span style="color:#ae81ff">2</span>]]), <span style="color:#ae81ff">1</span>)
merged <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>merge_all()

<span style="color:#75715e"># Execute</span>
summary <span style="color:#f92672">=</span> sess<span style="color:#f92672">.</span>run(merged)

<span style="color:#75715e">#Writer processing</span>
summary_writer <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>FileWriter(log_dir, sess<span style="color:#f92672">.</span>graph)
summary_writer<span style="color:#f92672">.</span>add_summary(summary)
summary_writer<span style="color:#f92672">.</span>close()
</code></pre></div><p>The result will come out.</p>
<blockquote>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/134273/d11d0b0c-c85c-6a49-51be-89778f8bbfee.jpeg" alt="20.Local_Images01.JPG"></p>
</blockquote>
<h2 id="tutorial-for-experts-deep-mnist-for-expertshttpswwwtensorfloworgget_startedmnistpros"><a href="https://www.tensorflow.org/get_started/mnist/pros">Tutorial for Experts Deep MNIST for Experts</a></h2>
<p>It is finally the main subject. We will take a look at the process of convolution and pooling in an expert tutorial. The code is:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#f92672">import</span> tensorflow <span style="color:#66d9ef">as</span> tf
sess <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>InteractiveSession()
<span style="color:#75715e"># Read MNIST data</span>
<span style="color:#f92672">from</span> tensorflow.examples.tutorials.mnist <span style="color:#66d9ef">import</span> input_data
mnist <span style="color:#f92672">=</span> input_data<span style="color:#f92672">.</span>read_data_sets(<span style="color:#e6db74">&#39;MNIST_data&#39;</span>, one_hot<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)

<span style="color:#75715e"># TensorBoard information output directory</span>
log_dir <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/tmp/tensorflow/mnist/logs/mnist_expert_images&#39;</span>

<span style="color:#75715e">#Delete and recreate the specified directory</span>
<span style="color:#66d9ef">if</span> tf<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>Exists(log_dir):
    tf<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>DeleteRecursively(log_dir)
tf<span style="color:#f92672">.</span>gfile<span style="color:#f92672">.</span>MakeDirs(log_dir)

<span style="color:#75715e"># Input placeholders &amp; image conversion</span>
<span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;input&#39;</span>):
    x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>placeholder(tf<span style="color:#f92672">.</span>float32, shape<span style="color:#f92672">=</span>[<span style="color:#66d9ef">None</span>, <span style="color:#ae81ff">784</span>], name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;x-input&#39;</span>)
    y_ <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>placeholder(tf<span style="color:#f92672">.</span>float32, shape<span style="color:#f92672">=</span>[<span style="color:#66d9ef">None</span>, <span style="color:#ae81ff">10</span>], name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;y-input&#39;</span>)

    <span style="color:#75715e"># Convert image to 28x28</span>
    x_image <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>reshape(x, [<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">1</span>])
    tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>image(<span style="color:#e6db74">&#39;preprocess&#39;</span>, x_image, <span style="color:#ae81ff">10</span>)Function that processes <span style="color:#75715e"># variables and outputs TensorBoard</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">variable_summaries</span>(var):

    <span style="color:#75715e"># Variable Summaries</span>
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;summaries&#39;</span>):
        mean <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>reduce_mean(var) <span style="color:#75715e">#Scalar output (average)</span>
        tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>scalar(<span style="color:#e6db74">&#39;mean&#39;</span>, mean)
        <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;stddev&#39;</span>):
            stddev <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>sqrt(tf<span style="color:#f92672">.</span>reduce_mean(tf<span style="color:#f92672">.</span>square(var<span style="color:#f92672">-</span>mean)))
        tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>scalar(<span style="color:#e6db74">&#39;stddev&#39;</span>, stddev) <span style="color:#75715e">#Scalar output (standard deviation)</span>
        tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>scalar(<span style="color:#e6db74">&#39;max&#39;</span>, tf<span style="color:#f92672">.</span>reduce_max(var)) <span style="color:#75715e">#Scalar output (maximum value)</span>
        tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>scalar(<span style="color:#e6db74">&#39;min&#39;</span>, tf<span style="color:#f92672">.</span>reduce_min(var)) <span style="color:#75715e">#Scalar output (minimum value)</span>
        tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>histogram(<span style="color:#e6db74">&#39;histogram&#39;</span>, var) <span style="color:#75715e"># histogram output</span>

<span style="color:#75715e">#Weighting value</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">weight_variable</span>(shape):
    initial <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>truncated_normal(shape, stddev<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>) <span style="color:#75715e"># normally distributed random number with standard deviation 0.1</span>
    <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>Variable(initial)

<span style="color:#75715e"># Bias value</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bias_variable</span>(shape):
    initial <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>constant(<span style="color:#ae81ff">0.1</span>, shape<span style="color:#f92672">=</span>shape) <span style="color:#75715e"># initial value 0.1 constant</span>
    <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>Variable(initial)

<span style="color:#75715e"># Convolution processing</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">conv2d</span>(x, W):
    <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>conv2d(x, W, strides<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>], padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;SAME&#39;</span>)

<span style="color:#75715e"># Max Pooling</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">max_pool_2x2</span>(x):
    <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>max_pool(x, ksize<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>], strides<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>], padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;SAME&#39;</span>)

<span style="color:#75715e"># Tier 1</span>
<span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;1st_layer&#39;</span>):

    <span style="color:#75715e"># 1st convolutional layer</span>
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;conv1_layer&#39;</span>):
        <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;weight&#39;</span>):
            W_conv1 <span style="color:#f92672">=</span> weight_variable([<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">32</span>])
            variable_summaries(W_conv1)
            
            <span style="color:#75715e">#Tensor is permuted from [5,5,1,32] to [32,5,5,1] and image output</span>
            tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>image(<span style="color:#e6db74">&#39;filter&#39;</span>, tf<span style="color:#f92672">.</span>transpose(W_conv1,perm<span style="color:#f92672">=</span>[<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>]), <span style="color:#ae81ff">10</span>)

        <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;bias&#39;</span>):
            b_conv1 <span style="color:#f92672">=</span> bias_variable([<span style="color:#ae81ff">32</span>])
            variable_summaries(b_conv1)
        <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;activations&#39;</span>):
            h_conv1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>relu(conv2d(x_image, W_conv1) <span style="color:#f92672">+</span> b_conv1)
            tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>histogram(<span style="color:#e6db74">&#39;activations&#39;</span>, h_conv1)

            Permuting <span style="color:#75715e">#Tensor from [-1,28,28,32] to [-1,32,28,28] and merging [-1] and [-32] to output image</span>
            tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>image(<span style="color:#e6db74">&#39;convolved&#39;</span>, tf<span style="color:#f92672">.</span>reshape(tf<span style="color:#f92672">.</span>transpose(h_conv1,perm<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>]),[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">1</span>]), <span style="color:#ae81ff">10</span>)

<span style="color:#75715e"># 1st pooling layer</span>
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;pool1_layer&#39;</span>):
        h_pool1 <span style="color:#f92672">=</span> max_pool_2x2(h_conv1)

        <span style="color:#75715e">#Tensor is permuted from [-1,14,14,32] to [-1,32,14,14], and [-1] and [32] are merged to output image</span>
        tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>image(<span style="color:#e6db74">&#39;pooled&#39;</span>, tf<span style="color:#f92672">.</span>reshape(tf<span style="color:#f92672">.</span>transpose(h_pool1,perm<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>]),[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">1</span>]), <span style="color:#ae81ff">10</span>)

<span style="color:#75715e"># Second layer</span>
<span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;2nd_layer&#39;</span>):
    
    <span style="color:#75715e"># Second convolutional layer</span>
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;conv2_layer&#39;</span>):
        <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;weight&#39;</span>):
            W_conv2 <span style="color:#f92672">=</span> weight_variable([<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">64</span>])
            variable_summaries(W_conv2)

            <span style="color:#75715e">#Tensor is permuted from [5,5,32,64] to [32*64,5,5,1] and image output</span>
            tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>image(<span style="color:#e6db74">&#39;filter&#39;</span>, tf<span style="color:#f92672">.</span>reshape(tf<span style="color:#f92672">.</span>transpose(W_conv2,perm<span style="color:#f92672">=</span>[<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>]),[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">1</span>]), <span style="color:#ae81ff">20</span>)
        <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;bias&#39;</span>):
            b_conv2 <span style="color:#f92672">=</span> bias_variable([<span style="color:#ae81ff">64</span>])
            variable_summaries(b_conv2)
        <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;activations&#39;</span>):
            h_conv2 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>relu(conv2d(h_pool1, W_conv2) <span style="color:#f92672">+</span> b_conv2)
            tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>histogram(<span style="color:#e6db74">&#39;activations&#39;</span>, h_conv2)
            Permuting <span style="color:#75715e">#Tensor from [-1,14,14,64] to [-1,64,14,14] and merging [-1] and [64] to output image</span>
            tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>image(<span style="color:#e6db74">&#39;convolved&#39;</span>, tf<span style="color:#f92672">.</span>reshape(tf<span style="color:#f92672">.</span>transpose(h_conv2,perm<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>]),[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">1</span>]), <span style="color:#ae81ff">10</span>)
    
<span style="color:#75715e"># Second pooling layer</span>
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;pool2_layer&#39;</span>):
        h_pool2 <span style="color:#f92672">=</span> max_pool_2x2(h_conv2)
        
        Permuting <span style="color:#75715e">#Tensor from [-1,7,7,64] to [-1,64,7,7] and merging [-1] and [64] to output image</span>
        tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>image(<span style="color:#e6db74">&#39;pooled&#39;</span>, tf<span style="color:#f92672">.</span>reshape(tf<span style="color:#f92672">.</span>transpose(h_pool2,perm<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>]),[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">1</span>]), <span style="color:#ae81ff">10</span>)

<span style="color:#75715e"># Tightly coupled layer</span>
<span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;fc1_layer&#39;</span>):
    h_pool2_flat <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>reshape(h_pool2, [<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">7</span><span style="color:#f92672">*</span><span style="color:#ae81ff">7</span><span style="color:#f92672">*</span><span style="color:#ae81ff">64</span>])
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;weight&#39;</span>):
        W_fc1 <span style="color:#f92672">=</span> weight_variable([<span style="color:#ae81ff">7</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">7</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">1024</span>])
        variable_summaries(W_fc1)
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;bias&#39;</span>):
        b_fc1 <span style="color:#f92672">=</span> bias_variable([<span style="color:#ae81ff">1024</span>])
        variable_summaries(b_fc1)
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;activations&#39;</span>):
        h_fc1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>relu(tf<span style="color:#f92672">.</span>matmul(h_pool2_flat, W_fc1) <span style="color:#f92672">+</span> b_fc1)
        tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>histogram(<span style="color:#e6db74">&#39;activations&#39;</span>, h_fc1)

    <span style="color:#75715e">#Drop out</span>
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;dropout&#39;</span>):
        keep_prob <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>placeholder(tf<span style="color:#f92672">.</span>float32)
        tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>scalar(<span style="color:#e6db74">&#39;dropout_keep_probability&#39;</span>, keep_prob)
        h_fc1_drop <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>dropout(h_fc1, keep_prob)

<span style="color:#75715e"># Read layer</span>
<span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;fc2_layer&#39;</span>):
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;weight&#39;</span>):
        W_fc2 <span style="color:#f92672">=</span> weight_variable([<span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">10</span>])
        variable_summaries(W_fc2)
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;bias&#39;</span>):
        b_fc2 <span style="color:#f92672">=</span> bias_variable([<span style="color:#ae81ff">10</span>])
        variable_summaries(b_fc2)
    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;preactivations&#39;</span>):
        y_conv <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>matmul(h_fc1_drop, W_fc2) <span style="color:#f92672">+</span> b_fc2
        tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>histogram(<span style="color:#e6db74">&#39;preactivations&#39;</span>, y_conv)

<span style="color:#75715e">#Cross entropy calculation</span>
<span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;cross_entropy&#39;</span>):
    cross_entropy <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>reduce_mean(tf<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>softmax_cross_entropy_with_logits(labels<span style="color:#f92672">=</span>y_, logits<span style="color:#f92672">=</span>y_conv))
    tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>scalar(<span style="color:#e6db74">&#34;cross_entropy&#34;</span>, cross_entropy)

<span style="color:#75715e"># Training</span>
<span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;train&#39;</span>):
    train_step <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>AdamOptimizer(<span style="color:#ae81ff">1e-4</span>)<span style="color:#f92672">.</span>minimize(cross_entropy)

<span style="color:#75715e"># Correct answer rate calculation</span>
<span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#39;accuracy&#39;</span>):
    correct_prediction <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>equal(tf<span style="color:#f92672">.</span>argmax(y_conv, <span style="color:#ae81ff">1</span>), tf<span style="color:#f92672">.</span>argmax(y_, <span style="color:#ae81ff">1</span>))accuracy <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>reduce_mean(tf<span style="color:#f92672">.</span>cast(correct_prediction, tf<span style="color:#f92672">.</span>float32))
    tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>scalar(<span style="color:#e6db74">&#39;accuracy&#39;</span>, accuracy)

<span style="color:#75715e"># Output all Summaries</span>
merged <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>merge_all()
train_writer <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>FileWriter(log_dir <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;/train&#39;</span>, sess<span style="color:#f92672">.</span>graph) <span style="color:#75715e"># training data</span>
test_writer <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>summary<span style="color:#f92672">.</span>FileWriter(log_dir <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;/test&#39;</span>) <span style="color:#75715e"># test data</span>

<span style="color:#75715e"># Initialization</span>
tf<span style="color:#f92672">.</span>global_variables_initializer()<span style="color:#f92672">.</span>run()

<span style="color:#75715e"># Training/test repetition</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">3000</span>):
    batch <span style="color:#f92672">=</span> mnist<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>next_batch(<span style="color:#ae81ff">50</span>)
    
    <span style="color:#75715e">#Training details every 100 times</span>
    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">%</span><span style="color:#ae81ff">100</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        run_options <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>RunOptions(trace_level<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>RunOptions<span style="color:#f92672">.</span>FULL_TRACE)
        run_metadata <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>RunMetadata()
        summary, train_accuracy, _ <span style="color:#f92672">=</span> sess<span style="color:#f92672">.</span>run([merged, accuracy ,train_step],
                                                feed_dict<span style="color:#f92672">=</span>{x: batch[<span style="color:#ae81ff">0</span>], y_:batch[<span style="color:#ae81ff">1</span>], keep_prob: <span style="color:#ae81ff">1.0</span>},
                                                options<span style="color:#f92672">=</span>run_options,
                                                run_metadata<span style="color:#f92672">=</span>run_metadata)
        train_writer<span style="color:#f92672">.</span>add_run_metadata(run_metadata,<span style="color:#e6db74">&#39;step</span><span style="color:#e6db74">%03d</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span>i)
        train_writer<span style="color:#f92672">.</span>add_summary(summary, i)
        print(<span style="color:#e6db74">&#39;step </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">, training accuracy </span><span style="color:#e6db74">%g</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span>(i, train_accuracy))
    <span style="color:#75715e">#Test every 100 times</span>
    <span style="color:#66d9ef">elif</span> i <span style="color:#f92672">%</span><span style="color:#ae81ff">100</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">99</span>:
        summary_test, train_accuracy <span style="color:#f92672">=</span> sess<span style="color:#f92672">.</span>run([merged, accuracy], feed_dict<span style="color:#f92672">=</span>{x: mnist<span style="color:#f92672">.</span>test<span style="color:#f92672">.</span>images, y_:mnist<span style="color:#f92672">.</span>test<span style="color:#f92672">.</span>labels, keep_prob: <span style="color:#ae81ff">1.0</span>})
        test_writer<span style="color:#f92672">.</span>add_summary(summary_test, i)
        
    <span style="color:#75715e">#Write training results</span>
    summary, _ <span style="color:#f92672">=</span> sess<span style="color:#f92672">.</span>run([merged, train_step], feed_dict<span style="color:#f92672">=</span>{x: batch[<span style="color:#ae81ff">0</span>], y_: batch[<span style="color:#ae81ff">1</span>], keep_prob: <span style="color:#ae81ff">0.5</span>})
    train_writer<span style="color:#f92672">.</span>add_summary(summary, i)

<span style="color:#75715e">#Final test result output</span>
print(<span style="color:#e6db74">&#39;test accuracy </span><span style="color:#e6db74">%g</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">%</span> accuracy<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{x: mnist<span style="color:#f92672">.</span>test<span style="color:#f92672">.</span>images, y_: mnist<span style="color:#f92672">.</span>test<span style="color:#f92672">.</span>labels, keep_prob: <span style="color:#ae81ff">1.0</span>}))

<span style="color:#75715e">#Writer close</span>
train_writer<span style="color:#f92672">.</span>close()
test_writer<span style="color:#f92672">.</span>close()
</code></pre></div><p>result
Grouped by name (input, 1st_layer, 2nd_layer). See also the article [[Commentary for beginners] TensorFlow Tutorial Deep MNIST]](<a href="http://qiita.com/drafts/0aef74a0411273705512/edit)">http://qiita.com/drafts/0aef74a0411273705512/edit)</a>.</p>
<blockquote>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/134273/d913fb74-7834-757b-d346-ca5036371b52.jpeg" alt="30.DeepMNISTImanges01.JPG"></p>
</blockquote>
<p>It is good that images can be output according to the training steps.</p>
<blockquote>
<p><img src="https://qiita-image-store.s3.amazonaws.com/0/134273/d4a4fa6b-8f16-b612-0341-0dfd7834e722.jpeg" alt="30.DeepMNISTImanges02.JPG"></p>
</blockquote>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
