<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Extract only Python for preprocessing | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Extract only Python for preprocessing</h1>
<p>
  <small class="text-secondary">
  
  
  May 9, 2020
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/pandas"> pandas</a></code></small>


<small><code><a href="https://memotut.com/tags/data-analysis"> data analysis</a></code></small>


<small><code><a href="https://memotut.com/tags/preprocessing"> preprocessing</a></code></small>

</p>
<pre><code>I've been wandering around the code on the author's github each time, so I'll put it together for immediate use.
</code></pre>
<h1 id="original-story">Original story</h1>
<p><a href="https://www.amazon.co.jp/%E5%89%8D%E5%87%A6%E7%90%86%E5%A4%A7%E5%85%A8%EF%BC%BB%E3%83%87%E3%83%BC%E3%82%BF%E5%88%86%E6%9E%90%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AESQL-R-Python%E5%AE%9F%E8%B7%B5%E3%83%86%E3%82%AF%E3%83%8B%E3%83%83%E3%82%AF%EF%BC%BD-%E6%9C%AC%E6%A9%8B-%E6%99%BA%E5%85%89-ebook/dp/B07C3JFK3V">Pre-processing Daizen [SQL/R/Python practice technique for data analysis]</a></p>
<p><a href="https://github.com/ghmagazine/awesomebook">https://github.com/ghmagazine/awesomebook</a></p>
<p>Extract the Python part from github below. See the book for detailed explanation.</p>
<p>Also, these source codes are <a href="https://github.com/ghmagazine/awesomebook/blob/master/LICENSE">licensed</a> under the BSD 3 terms.</p>
<blockquote>
<p>BSD 3-Clause License</p>
<p>Copyright (c) 2018, Tomomitsu Motohashi
All rights reserved.</p>
</blockquote>
<h1 id="data-read">Data read</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e"># Read from library</span>
<span style="color:#f92672">from</span> preprocess.load_data.data_loader <span style="color:#f92672">import</span> load_hotel_reserve
customer_tb, hotel_tb, reserve_tb <span style="color:#f92672">=</span> load_hotel_reserve()

<span style="color:#75715e"># Read from CSV</span>
reserve_tb <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;./data/reserve.csv&#39;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;UTF-8&#39;</span>)
</code></pre></div><p>#Type confirmation/conversion</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e"># Confirmation</span>
reserve_tb<span style="color:#f92672">.</span>dtypes
<span style="color:#66d9ef">print</span>(type(reserve_tb))

<span style="color:#75715e"># conversion</span>
reserve_tb[<span style="color:#e6db74">&#39;people_num&#39;</span>] <span style="color:#f92672">=</span> reserve_tb[<span style="color:#e6db74">&#39;people_num&#39;</span>]<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float64&#39;</span>)
</code></pre></div><p>#Column extraction</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">Avoid specifying the row<span style="color:#f92672">/</span>column <span style="color:#e6db74">&#34;number&#34;</span> by the <span style="color:#75715e"># iloc function as it is a hotbed of bugs.</span>
<span style="color:#75715e"># However, iloc is used in KFold.</span>
reserve_tb[[<span style="color:#e6db74">&#39;reserve_id&#39;</span>,<span style="color:#e6db74">&#39;hotel_id&#39;</span>,<span style="color:#e6db74">&#39;customer_id&#39;</span>,<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>,<span style="color:#e6db74">&#39;checkin_date&#39;</span>,<span style="color:#e6db74">&#39;checkin_time&#39;</span>,<span style="color:#e6db74">&#39;checkout_date&#39;</span>]]
reserve_tb<span style="color:#f92672">.</span>loc[:, [<span style="color:#e6db74">&#39;reserve_id&#39;</span>,<span style="color:#e6db74">&#39;hotel_id&#39;</span>,<span style="color:#e6db74">&#39;customer_id&#39;</span>,<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>,<span style="color:#e6db74">&#39;checkin_date&#39;</span>,<span style="color:#e6db74">&#39;checkin_time&#39;</span>,<span style="color:#e6db74">&#39;checkout_date&#39;</span>]]
</code></pre></div><p>#Delete column</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">Specify column deletion by setting <span style="color:#75715e">#axis to 1.</span>
Specify reserve_tb rewrite by specifying <span style="color:#75715e">#inplace to True</span>
reserve_tb<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#39;people_num&#39;</span>,<span style="color:#e6db74">&#39;total_price&#39;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, inplace<span style="color:#f92672">=</span>True)
</code></pre></div><h1 id="extract-rows-by-specifying-conditions">Extract rows by specifying conditions</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">reserve_tb<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;&#34;2016-10-13&#34; &lt;= checkout_date &lt;= &#34;2016-10-14&#34;&#39;</span>)

<span style="color:#75715e"># To connect conditions with and, use &amp;</span>
<span style="color:#75715e"># When connecting conditions with or</span>
You can use variables <span style="color:#f92672">in</span> Python memory by writing the variable name you want to refer to after <span style="color:#960050;background-color:#1e0010">@</span>, such <span style="color:#66d9ef">as</span> <span style="color:#75715e"># @var_name.</span>
<span style="color:#75715e">#query function does not support in.</span>

<span style="color:#75715e"># Sample the customer ID and extract the transaction (reservation) corresponding to the extracted customer ID</span>

<span style="color:#75715e"># reserve_tb[&#39;customer_id&#39;].unique() returns customer_id with deduplication</span>
Convert to pandas<span style="color:#f92672">.</span>Series (pandas list object) to use <span style="color:#75715e"># sample function</span>
Sample customer ID by <span style="color:#75715e">#sample function</span>
target <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(reserve_tb[<span style="color:#e6db74">&#39;customer_id&#39;</span>]<span style="color:#f92672">.</span>unique())<span style="color:#f92672">.</span>sample(frac<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)

Extract the row that matches one of the customer IDs sampled by customer_id by <span style="color:#75715e">#isin function</span>
reserve_tb[reserve_tb[<span style="color:#e6db74">&#39;customer_id&#39;</span>]<span style="color:#f92672">.</span>isin(target)]
</code></pre></div><p>#Sampling</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#ae81ff">50</span><span style="color:#f92672">%</span> sampling <span style="color:#f92672">from</span> <span style="color:#75715e"># reserve_tb</span>
reserve_tb<span style="color:#f92672">.</span>sample(frac<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>)
</code></pre></div><h1 id="aggregate">Aggregate</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"> When you want to perform aggregation processing <span style="color:#66d9ef">for</span> each hotel_id<span style="color:#f92672">.</span> When you want to perform unique count processing <span style="color:#66d9ef">for</span> each customer_id

Specify aggregation processing collectively using <span style="color:#75715e">#agg function</span>
Apply count function to <span style="color:#75715e"># reserve_id</span>
Apply the unique function to <span style="color:#75715e">#customer_id</span>
result <span style="color:#f92672">=</span> reserve_tb \
  <span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;hotel_id&#39;</span>) \
  <span style="color:#f92672">.</span>agg({<span style="color:#e6db74">&#39;reserve_id&#39;</span>:<span style="color:#e6db74">&#39;count&#39;</span>,<span style="color:#e6db74">&#39;customer_id&#39;</span>:<span style="color:#e6db74">&#39;nunique&#39;</span>})

Reassign the column numbers by <span style="color:#75715e">#reset_index function (since inplace=True, update result directly)</span>
result<span style="color:#f92672">.</span>reset_index(inplace<span style="color:#f92672">=</span>True)
result<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;hotel_id&#39;</span>,<span style="color:#e6db74">&#39;rsv_cnt&#39;</span>,<span style="color:#e6db74">&#39;cus_cnt&#39;</span>]

<span style="color:#75715e">#Reference</span>
<span style="color:#75715e">#What to do: Store the number of records with duplicate reserve_id and customer_id in the [&#39;dup&#39;] column.</span>
<span style="color:#75715e">#When you want to add the duplicate row count to the end of the data frame. use transform(&#39;count&#39;)</span>

reserve_tb[<span style="color:#e6db74">&#39;dup&#39;</span>] <span style="color:#f92672">=</span> reserve_tb<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;reserve_id&#39;</span>,<span style="color:#e6db74">&#39;customer_id&#39;</span>])<span style="color:#f92672">.</span>transform(<span style="color:#e6db74">&#39;count&#39;</span>)

<span style="color:#75715e">#If there is only one aggregation process, it is easier to write without using the agg function.</span>

<span style="color:#75715e"># Specify the combination of hotel_id and people_num as the aggregation unit</span>
<span style="color:#75715e"># Total_price is extracted from the aggregated data and applied to the sum function to calculate the total sales amount</span>
result <span style="color:#f92672">=</span> reserve_tb \
  <span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;hotel_id&#39;</span>,<span style="color:#e6db74">&#39;people_num&#39;</span>])[<span style="color:#e6db74">&#39;total_price&#39;</span>] \
  <span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>reset_index()

<span style="color:#75715e"># Since the column name of total sales amount is total_price, change it to price_sum</span>
result<span style="color:#f92672">.</span>rename(columns<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;total_price&#39;</span>:<span style="color:#e6db74">&#39;price_sum&#39;</span>}, inplace<span style="color:#f92672">=</span>True)
</code></pre></div><p>groupby -&gt; agg combo</p>
<h1 id="apply-aggregate-function-maxminmeanmedianpercentile">Apply aggregate function [max/min/mean/median/percentile]</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">In the <span style="color:#75715e"># agg function, the aggregation process of percent tile values cannot be specified by a character string (q=20), so it is specified using a lambda expression.</span>

Apply max<span style="color:#f92672">/</span>min<span style="color:#f92672">/</span>mean<span style="color:#f92672">/</span>median functions to <span style="color:#75715e">#total_price</span>
<span style="color:#75715e">#Specify Python lambda expression for agg function aggregation processing</span>
<span style="color:#75715e">#Specify numpy.percentile for the lambda expression to calculate the percent tile value (20 for percent)</span>
result <span style="color:#f92672">=</span> reserve_tb \
  <span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;hotel_id&#39;</span>) \
  <span style="color:#f92672">.</span>agg({<span style="color:#e6db74">&#39;total_price&#39;</span>: [<span style="color:#e6db74">&#39;max&#39;</span>,<span style="color:#e6db74">&#39;min&#39;</span>,<span style="color:#e6db74">&#39;mean&#39;</span>,<span style="color:#e6db74">&#39;median&#39;</span>,
                        <span style="color:#66d9ef">lambda</span> x: np<span style="color:#f92672">.</span>percentile(x, q<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>)]}) \
  <span style="color:#f92672">.</span>reset_index()
result<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;hotel_id&#39;</span>,<span style="color:#e6db74">&#39;price_max&#39;</span>,<span style="color:#e6db74">&#39;price_min&#39;</span>,<span style="color:#e6db74">&#39;price_mean&#39;</span>,
                  <span style="color:#e6db74">&#39;price_median&#39;</span>,<span style="color:#e6db74">&#39;price_20per&#39;</span>]
</code></pre></div><h1 id="variance-standard-deviation">Variance, standard deviation</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">var function <span style="color:#f92672">and</span> std function are applied to <span style="color:#75715e"># total_price to calculate variance and standard deviation</span>
result <span style="color:#f92672">=</span> reserve_tb \
  <span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;hotel_id&#39;</span>) \
  <span style="color:#f92672">.</span>agg({<span style="color:#e6db74">&#39;total_price&#39;</span>: [<span style="color:#e6db74">&#39;var&#39;</span>,<span style="color:#e6db74">&#39;std&#39;</span>]})<span style="color:#f92672">.</span>reset_index()
result<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;hotel_id&#39;</span>,<span style="color:#e6db74">&#39;price_var&#39;</span>,<span style="color:#e6db74">&#39;price_std&#39;</span>]

<span style="color:#75715e">#When the number of data is 1, the variance value and standard deviation value are na, so replace it with 0.</span>
<span style="color:#75715e">#The range to replace is all NAs in the DataFrame, so be careful not to replace values that are not relevant</span>
result<span style="color:#f92672">.</span>fillna(<span style="color:#ae81ff">0</span>, inplace<span style="color:#f92672">=</span>True)
</code></pre></div><p>#Calculation of mode (mode function)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">Calculate the mode value <span style="color:#66d9ef">with</span> the mode function after rounding <span style="color:#66d9ef">with</span> the <span style="color:#75715e"># round function</span>
reserve_tb[<span style="color:#e6db74">&#39;total_price&#39;</span>]<span style="color:#f92672">.</span>round(<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>)<span style="color:#f92672">.</span>mode()
</code></pre></div><h1 id="rank-function">rank function</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">Convert data type <span style="color:#f92672">from</span> string to timestamp to sort by <span style="color:#75715e">#rank function</span>
<span style="color:#75715e"># (Explanation in &#34;Chapter 10 Date Type&#34;)</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(
  reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>], format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#39;</span>
)

<span style="color:#75715e">#log_no added as a new column</span>
<span style="color:#75715e"># Use group_by to specify the aggregation unit</span>
<span style="color:#75715e"># Generate reserve_datetime for each customer and generate rank by rank function</span>
Set ascending to True by setting <span style="color:#75715e">#ascending to True (if False, set to descending order)</span>
reserve_tb[<span style="color:#e6db74">&#39;log_no&#39;</span>] <span style="color:#f92672">=</span> reserve_tb \
  <span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;customer_id&#39;</span>)[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>] \
  <span style="color:#f92672">.</span>rank(ascending<span style="color:#f92672">=</span>True, method<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;first&#39;</span>)
</code></pre></div><h1 id="merge-merge">Merge: merge</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#Be as small as possible before joining</span>
pd<span style="color:#f92672">.</span>merge(reserve_tb<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;people_num == 1&#39;</span>),
         hotel_tb<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#39;is_business&#39;</span>),
         on<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;hotel_id&#39;</span>, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;inner&#39;</span>)
</code></pre></div><h2 id="how-to-rewrite-the-value-that-matches-the-condition-of-a-certain-column-in-pandas-dataframe">How to rewrite the value that matches the condition of a certain column in Pandas DataFrame</h2>
<ol>
<li>Use the loc function. df.loc[df[&lsquo;A&rsquo;]&lt;0,&lsquo;A&rsquo;] = -100</li>
<li>Use the where function. Note that it is different from the Numpy where function! It will be replaced if it does not match.</li>
<li>Use the replae function. When only one condition is required (continuous value range cannot be specified)</li>
</ol>
<h1 id="time-series-shift-combination-shift">Time series shift combination: shift</h1>
<pre><code class="language-py#" data-lang="py#">#shift function: A function that can shift data up and down n lines

# Sort by reserve_datetime for each customer
Sort by group by applying the apply function after the # groupby function
Sort data by #sort_values function, sort rows if axis is 0, and sort columns if axis is 1.
result = reserve_tb \
  .groupby('customer_id') \
  .apply(lambda group:
         group.sort_values(by='reserve_datetime', axis=0, inplace=False))

# result is already grouped by customer_id
Save the previous total_price for each #customer as before_price
#shift function is a function that shifts the data row down by the number of arguments of periods
result['before_price'] = \
  pd.Series(result['total_price'].shift(periods=2))
</code></pre><h2 id="note-python-is-not-suitable-for-window-function">Note: Python is not suitable for Window function</h2>
<ul>
<li>Python has a longer code than SQL, so it is better to use SQL when the Window function performs the necessary processing.
・SQL is overwhelmingly recommended when performing processing that combines past data for a certain period.</li>
<li>The rolling function can only make selections based on its own data row.</li>
</ul>
<p>#Data division for model verification in time series data</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#f92672">from</span> preprocess.load_data.data_loader <span style="color:#f92672">import</span> load_monthly_index
monthly_index_tb <span style="color:#f92672">=</span> load_monthly_index()

<span style="color:#75715e"># Start this book from the line below</span>
Specify the starting row number of the first learning data <span style="color:#f92672">in</span> <span style="color:#75715e"># train_window_start</span>
train_window_start <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
Specify the ending line number of the first learning data <span style="color:#f92672">in</span> <span style="color:#75715e"># train_window_end</span>
train_window_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">24</span>
Specify the number of verification data <span style="color:#f92672">in</span> <span style="color:#75715e"># horizon</span>
horizon <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>
<span style="color:#75715e"># Set the number of data to slide to skip</span>
skip <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>

<span style="color:#75715e"># Sort data by year and month</span>
monthly_index_tb<span style="color:#f92672">.</span>sort_values(by<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;year_month&#39;</span>)

<span style="color:#66d9ef">while</span> True:
  <span style="color:#75715e">#Calculate end line number of verification data</span>
  test_window_end <span style="color:#f92672">=</span> train_window_end <span style="color:#f92672">+</span> horizon

  <span style="color:#75715e">#Specify the row number to get the training data from the original data</span>
  If you fix the <span style="color:#75715e"># train_window_start part to 1, it can be changed to verification that increases the learning data</span>
  train <span style="color:#f92672">=</span> monthly_index_tb[train_window_start:train_window_end]

  <span style="color:#75715e">#Specify line number to get verification data from original data</span>
  test <span style="color:#f92672">=</span> monthly_index_tb[(train_window_end <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>):test_window_end]

  <span style="color:#75715e"># Determine if the end line number of the verification data is greater than or equal to the number of lines in the original data</span>
  <span style="color:#66d9ef">if</span> test_window_end <span style="color:#f92672">&gt;=</span> len(monthly_index_tb<span style="color:#f92672">.</span>index):
    <span style="color:#75715e">#End when all data is targeted</span>
    <span style="color:#66d9ef">break</span>

  <span style="color:#75715e"># Slide data</span>
  train_window_start <span style="color:#f92672">+=</span> skip
  train_window_end <span style="color:#f92672">+=</span> skip

<span style="color:#75715e"># Summarize the results of cross-validation</span>
</code></pre></div><p>#Number conversion</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e"># apply function</span>
reserve_tb[<span style="color:#e6db74">&#39;total_price_log&#39;</span>] <span style="color:#f92672">=</span> \
  reserve_tb[<span style="color:#e6db74">&#39;total_price&#39;</span>]<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: np<span style="color:#f92672">.</span>log(x <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>))
</code></pre></div><p>#Remove outliers</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e"># There is no package that summarizes the major methods, you have to implement it yourself</span>
reserve_tb <span style="color:#f92672">=</span> reserve_tb[
  (abs(reserve_tb[<span style="color:#e6db74">&#39;total_price&#39;</span>]<span style="color:#f92672">-</span>np<span style="color:#f92672">.</span>mean(reserve_tb[<span style="color:#e6db74">&#39;total_price&#39;</span>])) <span style="color:#f92672">/</span>
   np<span style="color:#f92672">.</span>std(reserve_tb[<span style="color:#e6db74">&#39;total_price&#39;</span>]) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">3</span>)
]<span style="color:#f92672">.</span>reset_index()
</code></pre></div><h1 id="date-type-unavoidable-for-time-series-analysis">Date type (unavoidable for time series analysis)</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e"># You can also specify a datetime64[D] type as the date type, but it is often inconvenient because it cannot be converted from datetime64[ns] to datetime64[D].</span>
It <span style="color:#f92672">is</span> more convenient to extract the datetime element after converting to <span style="color:#75715e">#datetime64[ns] type.</span>

Convert to datetime64[ns] type <span style="color:#66d9ef">with</span> <span style="color:#75715e">#to_datetime function</span>
pd<span style="color:#f92672">.</span>to_datetime(reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>], format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#39;</span>)
pd<span style="color:#f92672">.</span>to_datetime(reserve_tb[<span style="color:#e6db74">&#39;checkin_date&#39;</span>] <span style="color:#f92672">+</span> reserve_tb[<span style="color:#e6db74">&#39;checkin_time&#39;</span>],
               format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">%H:%M:%S&#39;</span>)

Get date information <span style="color:#f92672">from</span> <span style="color:#75715e">#datetime64[ns] type</span>
pd<span style="color:#f92672">.</span>to_datetime(reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>],
               format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#39;</span>)<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>date
pd<span style="color:#f92672">.</span>to_datetime(reserve_tb[<span style="color:#e6db74">&#39;checkin_date&#39;</span>], format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>)<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>date
</code></pre></div><p>#Convert to year/month/day/hour/minute/second/day of the week</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">Convert <span style="color:#75715e">#reserve_datetime to datetime64[ns] type</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>] <span style="color:#f92672">=</span> \
  pd<span style="color:#f92672">.</span>to_datetime(reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>], format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#39;</span>)

<span style="color:#75715e">#Get year</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>year

<span style="color:#75715e">#Get the moon</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>month

<span style="color:#75715e">#Get the day</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>day

<span style="color:#75715e"># Gets the day of the week (0=Sunday, 1=Monday) as a number</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>dayofweek

<span style="color:#75715e"># Get time of day</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>hour

<span style="color:#75715e"># Get minute of time</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>minute

<span style="color:#75715e"># Get seconds of time</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>second

<span style="color:#75715e"># Convert to a string in the specified format</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#39;</span>)
</code></pre></div><p>#Get date and time difference</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">Subtraction between <span style="color:#75715e"># datetime64[ns] types</span>

Convert <span style="color:#75715e">#reserve_datetime to datetime64[ns] type</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>] <span style="color:#f92672">=</span> \
  pd<span style="color:#f92672">.</span>to_datetime(reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>], format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#39;</span>)

<span style="color:#75715e"># convert checkin_datetime to datetime64[ns] type</span>
reserve_tb[<span style="color:#e6db74">&#39;checkin_datetime&#39;</span>] <span style="color:#f92672">=</span> \
  pd<span style="color:#f92672">.</span>to_datetime(reserve_tb[<span style="color:#e6db74">&#39;checkin_date&#39;</span>] <span style="color:#f92672">+</span> reserve_tb[<span style="color:#e6db74">&#39;checkin_time&#39;</span>],
                 format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">%H:%M:%S&#39;</span>)

<span style="color:#75715e"># Calculate year difference (do not consider date and time elements less than month)</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>year<span style="color:#f92672">-</span>\
reserve_tb[<span style="color:#e6db74">&#39;checkin_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>year

<span style="color:#75715e">#Get month difference (do not consider date and time elements less than a day)</span>
(reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>year <span style="color:#f92672">*</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">+</span>
 reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>month) \
 <span style="color:#f92672">-</span>(reserve_tb[<span style="color:#e6db74">&#39;checkin_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>year <span style="color:#f92672">*</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">+</span>
    reserve_tb[<span style="color:#e6db74">&#39;checkin_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>month)

<span style="color:#75715e"># Calculate difference by day</span>
(reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">-</span>reserve_tb[<span style="color:#e6db74">&#39;checkin_datetime&#39;</span>]) \
  <span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;timedelta64[D]&#39;</span>)

<span style="color:#75715e"># Calculate the difference by the hour</span>
(reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">-</span>reserve_tb[<span style="color:#e6db74">&#39;checkin_datetime&#39;</span>]) \
  <span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;timedelta64[h]&#39;</span>)

<span style="color:#75715e"># Calculate difference in minutes</span>
(reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">-</span>reserve_tb[<span style="color:#e6db74">&#39;checkin_datetime&#39;</span>]) \
  <span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;timedelta64[m]&#39;</span>)

<span style="color:#75715e">#Calculate the difference in seconds</span>
(reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">-</span>reserve_tb[<span style="color:#e6db74">&#39;checkin_datetime&#39;</span>]) \
  <span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;timedelta64[s]&#39;</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#Note</span>
When the difference <span style="color:#f92672">is</span> converted to day<span style="color:#f92672">/</span>hour<span style="color:#f92672">/</span>minute<span style="color:#f92672">/</span>second unit by <span style="color:#75715e">#timedelta64[D/h/m/s] type, the result rounded up after the decimal point is returned (different from SQL and R)</span>
<span style="color:#75715e"># For example, if the difference is 2 days and 3 hours and converted to day unit, 3 (day) will be returned</span>

<span style="color:#75715e">#???</span>
Looking at the <span style="color:#75715e">#pandas site, it looks like it&#39;s been truncated.</span>
<span style="color:#75715e"># https://pandas.pydata.org/docs/user_guide/timedeltas.html</span>
</code></pre></div><h1 id="increase-or-decrease-date-type">Increase or decrease date type</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e"># load datetime library for timedelta</span>
<span style="color:#f92672">import</span> datetime

Convert <span style="color:#75715e">#reserve_datetime to datetime64[ns] type</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>] <span style="color:#f92672">=</span> \
  pd<span style="color:#f92672">.</span>to_datetime(reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>], format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#39;</span>)

<span style="color:#75715e"># extract date from reserve_datetime</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_date&#39;</span>] <span style="color:#f92672">=</span> reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>date

Add <span style="color:#ae81ff">1</span> day to <span style="color:#75715e"># reserve_datetime</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>] <span style="color:#f92672">+</span> datetime<span style="color:#f92672">.</span>timedelta(days<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)Add <span style="color:#ae81ff">1</span> day to <span style="color:#75715e"># reserve_date</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_date&#39;</span>] <span style="color:#f92672">+</span> datetime<span style="color:#f92672">.</span>timedelta(days<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

Add <span style="color:#ae81ff">1</span> hour to <span style="color:#75715e"># reserve_datetime</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>] <span style="color:#f92672">+</span> datetime<span style="color:#f92672">.</span>timedelta(hours<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

Add <span style="color:#ae81ff">1</span> minute to <span style="color:#75715e"># reserve_datetime</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>] <span style="color:#f92672">+</span> datetime<span style="color:#f92672">.</span>timedelta(minutes<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

<span style="color:#75715e"># add 1 second to reserve_datetime</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>] <span style="color:#f92672">+</span> datetime<span style="color:#f92672">.</span>timedelta(seconds<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</code></pre></div><p>#Conversion to season: Define conversion function and apply.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">Convert <span style="color:#75715e">#reserve_datetime to datetime64[ns] type</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(
  reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>], format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#39;</span>
)

<span style="color:#75715e">#Function to convert month numbers to seasons</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">to_season</span>(month_num):
  season <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;winter&#39;</span>
  <span style="color:#66d9ef">if</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">&lt;=</span> month_num <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">5</span>:
    season <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;spring&#39;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">&lt;=</span> month_num <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">8</span>:
    season <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;summer&#39;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#ae81ff">9</span> <span style="color:#f92672">&lt;=</span> month_num <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">11</span>:
    season <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;autumn&#39;</span>
  
  <span style="color:#66d9ef">return</span> season

<span style="color:#75715e">#Convert to season</span>
reserve_tb[<span style="color:#e6db74">&#39;reserve_season&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Categorical(
  reserve_tb[<span style="color:#e6db74">&#39;reserve_datetime&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>month<span style="color:#f92672">.</span>apply(to_season),
  categories<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;spring&#39;</span>,<span style="color:#e6db74">&#39;summer&#39;</span>,<span style="color:#e6db74">&#39;autumn&#39;</span>,<span style="color:#e6db74">&#39;winter&#39;</span>]
)
</code></pre></div><p>#Reference
<a href="https://pandas.pydata.org/docs/user_guide/timedeltas.html">https://pandas.pydata.org/docs/user_guide/timedeltas.html</a></p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
