<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Measure WiFi speed with Python | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Measure WiFi speed with Python</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 23, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/speedtest">speedtest</a></code></small>

</p>
<pre><code>This article is the 13th day of [JSL \ (Japan System Giken \) Advent Calendar 2019](https://qiita.com/advent-calendar/2019/jsl).
</code></pre>
<hr>
<p>Recently, I felt that there was a timing when internal WiFi became slower, but I could not quantitatively know how slow it was, so I wrote a script that periodically executes a speed test.</p>
<h2 id="first-summary">First summary</h2>
<ul>
<li>I wrote a program in Python to measure the speed of in-house WiFi using <a href="https://www.speedtest.net/apps/cli">Speedtest CLI - Internet connection measurement for developers</a></li>
<li>It is convenient to be able to execute speed test from CUI</li>
</ul>
<h2 id="speed-test-from-cui">Speed test from CUI</h2>
<p>First of all, I thought about running a speed test with CUI because I wanted to run it regularly with cron etc.</p>
<p>In my image, the speed test was measured as follows: search→execute&hellip;</p>
<p>![Screenshot 2019-12-23 15.54.09.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/67790/56eb06ed-3ae9-c779-a0ab-(b0cd42fab504.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/67790/56eb06ed-3ae9-c779-a0ab-(b0cd42fab504.png)</a></p>
<p><a href="https://dev.classmethod.jp/server-side/network/measuring-network-speedtest-on-linux/">I tried to arrange the network line speed measurement method on Linux ｜ Developers.IO</a>), I found that <code>speedtest.net</code> provided CLI.</p>
<ul>
<li><a href="https://www.speedtest.net/apps/cli">Speedtest CLI - Internet connection measurement for developers</a></li>
</ul>
<p>Speedtest CLI also provides a Python package,</p>
<ul>
<li>It is possible to install binary with pip
-Speedtest command can be used in virtual environment without managing with brew</li>
<li>It can be imported on Python</li>
</ul>
<p>I found out</p>
<h2 id="build-speedtest-execution-environment">Build speedtest execution environment</h2>
<p>I built an environment using pipenv</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ mkdir wifi_speedtest
$ cd $_
<span style="color:#75715e"># If pipenv is not installed</span>
<span style="color:#75715e"># brew install pipenv</span>

<span style="color:#75715e"># Create virtual environment</span>
$ pipenv --python 3.7

<span style="color:#75715e"># Package installation</span>
$ pipenv install speedtest-cli

<span style="color:#75715e"># Enable virtual environment</span>
$ pipenv shell

<span style="color:#75715e"># speedtest command test</span>
<span style="color:#f92672">(</span>.venv<span style="color:#f92672">)</span> $ speedtest --version
speedtest-cli 2.1.2
Python 3.7.4 <span style="color:#f92672">(</span>default, Oct <span style="color:#ae81ff">12</span> 2019, 18:55:28<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Clang 11.0.0 <span style="color:#f92672">(</span>clang-1100.0.33.8<span style="color:#f92672">)]</span>
</code></pre></div><h2 id="run-speedtest-on-cui">Run Speedtest on CUI</h2>
<p>Since <code>speedtest --list</code> can get a list of connection destination servers provided by volunteers, decide one and make a note of the number.</p>
<pre><code>(.venv) $ speedtest --list | grep Tokyo
15047) OPEN Project (via 20G SINET) (Tokyo, Japan) [6.34 km]
24333) Rakuten Mobile ,Inc (Tokyo, Japan) [6.34 km]
28910) fdcservers.net (Tokyo, Japan) [6.34 km]
18516) GIAM PING VIETPN.COM (Tokyo, Japan) [6.34 km]
22247) Tokyonet (Castro, Brazil) [18486.74 km]
</code></pre><p>The following will always run the speed test on the specified server. For example, in the case of the server provided by <code>Rakuten Mobile ,Inc</code>, the number is <code>24333</code>.</p>
<pre><code># Run speed test
(.venv) $ speedtest --server 24333
Retrieving speedtest.net configuration...
Testing from XXX (xx.xx.xx.xx)...
Retrieving speedtest.net server list...
Retrieving information for the selected server...
Hosted by Rakuten Mobile ,Inc (Tokyo) [6.34 km]: 200.123 ms
Testing download speed................................................... .................................
Download: 16.08 Mbit/s
Testing upload speed................................................... ................................................. .....
Upload: 31.96 Mbit/s
</code></pre><p>I was able to measure it safely (some client information is hidden)</p>
<ul>
<li>Download: 16.08 Mbit/s</li>
<li>Upload: 31.96 Mbit/s</li>
</ul>
<p>However, it is difficult to handle in a program with this, so add <code>--json</code> and get the result in json format</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#f92672">(</span>.venv<span style="color:#f92672">)</span> $ speedtest --server <span style="color:#ae81ff">24333</span> --json
</code></pre></div><pre><code class="language-json:" data-lang="json:">{&quot;download&quot;: 20208058.464686207, &quot;upload&quot;: 54426180.687909536, &quot;ping&quot;: 48.215, &quot;server&quot;: {&quot;url&quot;: &quot;http://ookla.mbspeed.net:8080/speedtest/upload.php&quot;, &quot;lat &quot;: &quot;35.6833&quot;, &quot;lon&quot;: &quot;139.6833&quot;, &quot;name&quot;: &quot;Tokyo&quot;, &quot;country&quot;: &quot;Japan&quot;, &quot;cc&quot;: &quot;JP&quot;, &quot;sponsor&quot;: &quot;Rakuten Mobile, Inc&quot;, &quot; id&quot;: &quot;24333&quot;, &quot;host&quot;: &quot;ookla.mbspeed.net:8080&quot;, &quot;d&quot;: 6.336536019993832, &quot;latency&quot;: 48.215}, &quot;timestamp&quot;: &quot;2019-12-23T07:23:16.316637Z&quot; , &quot;bytes_sent&quot;: 68534272, &quot;bytes_received&quot;: 25353712, &quot;share&quot;: null, &quot;client&quot;: {&quot;ip&quot;: &quot;xx.xx.xx.xx&quot;, &quot;lat&quot;: &quot;xx.xxxx&quot;, &quot;lon &quot;: &quot;xxx.xxxx&quot;, &quot;isp&quot;: &quot;XXX&quot;, &quot;isprating&quot;: &quot;3.7&quot;, &quot;rating&quot;: &quot;0&quot;, &quot;ispdlavg&quot;: &quot;0&quot;, &quot;ispulavg&quot;: &quot;0&quot;, &quot;loggedin &quot;: &quot;0&quot;, &quot;country&quot;: &quot;JP&quot;}}
</code></pre><p>Consider handling this on Python</p>
<h2 id="run-speedtest-in-python">Run Speedtest in Python</h2>
<p>Since it is provided as a Python Package, I thought about executing a speed test pluggably in Python, but this time I thought about handling the execution result in CUI as it is, so I used speedtest with the <code>subprocess module</code>. Decided to execute the command</p>
<p><a href="https://docs.python.org/ja/3/library/subprocess.html">subprocess --- Subprocess management — Python 3.8.1 documentation</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py:wifi_speedtest.py" data-lang="py:wifi_speedtest.py"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_speedtest_result</span>():
    process <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>run([<span style="color:#e6db74">&#39;speedtest&#39;</span>,<span style="color:#e6db74">&#39;--server&#39;</span>, <span style="color:#e6db74">&#39;24333&#39;</span>,<span style="color:#e6db74">&#39;--json&#39;</span>], capture_output<span style="color:#f92672">=</span>True)
    <span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>loads(process<span style="color:#f92672">.</span>stdout)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bit_to_mbit</span>(bit):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Making a feeling that you do not care about errors
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">return</span> bit <span style="color:#f92672">/</span> <span style="color:#ae81ff">1024</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1024</span>


result <span style="color:#f92672">=</span> get_speedtest_result()
<span style="color:#66d9ef">print</span>(bit_to_mbit(result[<span style="color:#e6db74">&#34;download&#34;</span>]), bit_to_mbit(result[<span style="color:#e6db74">&#34;upload&#34;</span>]))
</code></pre></div><pre><code class="language-sh:" data-lang="sh:">13.46394215 50.48002296
</code></pre><p>There are several ways to execute commands with <code>subprocess</code>, but this time, the standard output was obtained with <code>run()</code> + <code>capture_output=True</code> which is shown in the official usage example.</p>
<p>This time, I hit the SpreadSheet&rsquo;s API to record it (details are omitted below, so I refer to it below).</p>
<ul>
<li><a href="https://qiita.com/akabei/items/0eac37cb852ad476c6b9">Edit Google Spreadsheet with Python - Qiita</a></li>
</ul>
<p>It&rsquo;s a good idea to record it in the way you like as soon as you skip it to Slack.</p>
<hr>
<p>As an aside, using the scripts of Pipenv is convenient because it is not necessary to activate the virtual environment when running from cron (processes executed via pipenv run are treated the same as execution in virtual environment)</p>
<pre><code class="language-toml:Pipfile" data-lang="toml:Pipfile">[scripts]
dev ='python wifi_speedtest.py'
</code></pre>
    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
