<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] [FastAPI] Getting started with ASAPI Web framework FastAPI made in Python | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] [FastAPI] Getting started with ASAPI Web framework FastAPI made in Python</h1>
<p>
  <small class="text-secondary">
  
  
  Jan 3, 2020
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/fastapi">FastAPI</a></code></small>

</p>
<pre><code># FastAPI
</code></pre>
<p>The Python web framework, which is a micro-framework like Flask.
Its strengths are high performance, ease of writing, design with a strong focus on production operations, and modern functions.</p>
<p>FastAPI is written on the shoulder of <a href="https://github.com/encode/starlette">Starlette</a>, and asynchronous processing is easy to handle.
In particular, it has the following features.</p>
<ul>
<li>ASGI</li>
<li>websocket support</li>
<li>GraphQL support</li>
<li>Background process is easy to handle</li>
<li>Automatic document generation with python type hint (Swagger UI)</li>
<li>pydantic based data validation</li>
</ul>
<p>Frankly, it&rsquo;s very similar to <a href="https://github.com/taoufik07/responder">responder</a>.(It&rsquo;scomingsoon,andtheresponderisalsobasedonStarlette)
However, the two below are designed so that FastAPI is much easier to use.
From the following viewpoints, I think that FastAPI is only for production use when viewed comprehensively. (I personally think that responder is easier to use if you want to write it freely.)</p>
<ul>
<li>Polite documentation (Introducing cooperation with DB, authentication, https conversion etc.)</li>
<li>Since the automatic document generation function is generous, cooperation with front-end developers will improve.</li>
<li>There is even a docker image for production operation</li>
</ul>
<p>I also compared the performance with some Python frameworks, and it seemed that FastAPI was certainly performant. (Reference: <a href="https://qiita.com/bee2/items/0ad260ab9835a2087dae">Performance comparison of Python Web framework (Django, Flask, responder, FastAPI, japronto)</a>)</p>
<h1 id="purpose-of-this-article">Purpose of this article</h1>
<p>If you want to feel the value of FastAPI, I think the official tutorial is appropriate. It is very easy to understand because the content is substantial. However, on the other hand, it&rsquo;s a bit heavy to refer to just to get started.
Therefore, I would like to re-introduce the contents so that FastAPI can be used at the minimum necessary.</p>
<p>In addition, this article is written assuming the following.</p>
<ul>
<li>Understand the basic notation of some microframework in python</li>
<li>Learn basic python type hint (mypy) notation</li>
</ul>
<p>A code example corresponding to the contents introduced here is summarized in <a href="https://github.com/tokusumi/fastapi-minimum-tutorial">here</a>. Please use when you want to touch only Swagger.</p>
<h1 id="table-of-contents">table of contents</h1>
<ul>
<li>intro</li>
<li>Request handling</li>
<li>Response handling</li>
<li>Error handling &amp; status code management</li>
<li>background process</li>
<li>unittest</li>
<li>deployment</li>
<li>Other (CORS problem handling, certification)</li>
</ul>
<h1 id="intro">intro</h1>
<h2 id="install-fastapi">install FastAPI</h2>
<p>Install fastapi and uvicorn which will be its ASGI server.</p>
<pre><code>$ pip install fastapi uvicorn
</code></pre><h2 id="intro-code">intro code</h2>
<p>When GET, try making an API that returns <code>{&quot;text&quot;: &quot;hello world!&quot;}</code> with json.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:intro.py" data-lang="python:intro.py"><span style="color:#f92672">from</span> fastapi <span style="color:#f92672">import</span> FastAPI

app <span style="color:#f92672">=</span> FastAPI()

<span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#39;/&#39;</span>) <span style="color:#75715e"># method and endpoint specification</span>
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>():
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;hello world!&#34;</span>}
</code></pre></div><p>I think that it is the one that can be written concisely in the Python micro framework.</p>
<h2 id="run-server">run server</h2>
<p>The following will start the server. (&ndash;Reload will update the server every time the file is changed, so it is convenient during development.) The <code>intro:app</code> part is <code>file name:FastAPI() instance name</code>. is. Please replace as appropriate.</p>
<pre><code>$ uvicorn intro:app --reload
</code></pre><h2 id="check-auto-generated-document-swagger-ui">Check auto-generated document (Swagger UI)</h2>
<p>Go to http://127.0.0.1:8000/docs. This will open the Swagger UI. You can tap the API here.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/246552/6dc498e6-2844-7099-f3ac-36cca2d648f9.gif" alt="f895d438c0b57a8272939ee4e3521af3.gif"></p>
<p>You can also check the request and response schemas using the method described below. One of the great strengths of FastAPI is that this document is automatically generated. If you are developing normally, documentation will be generated arbitrarily.</p>
<h1 id="request-handling">request handling</h1>
<p>The following items are handled.</p>
<ul>
<li>GET method:
-Get path parameter
-Get query parameter
-validation</li>
<li>POST method:
-Get request body
-validation</li>
</ul>
<h2 id="get-method">GET method</h2>
<h3 id="get-path-parameter--query-parameter">Get path parameter &amp; query parameter</h3>
<p>You can get the parameter by putting the parameter name in the argument.
Once</p>
<ul>
<li>The parameter name declared as <code>/{param}</code> at endpoint is <strong>path parameter</strong></li>
<li>Other points to <strong>query parameter</strong></li>
</ul>
<p>Please understand. Also, the order of the arguments does not matter. Then, depending on whether or not to declare the default value, the processing when the parameter included in the argument is not entered during GET changes.</p>
<ul>
<li><strong>not required</strong>: If you declare a default value, the default value will be used if the parameter is missing.</li>
<li><strong>required</strong>: On the other hand, if there is no parameter that does not declare a default value, <code>{&quot;detail&quot;: &quot;Not Found&quot;}</code> is returned.</li>
</ul>
<p>And, it is a feature of FastAPI to add python&rsquo;s type hint ** to the argument as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#39;/get/{path}&#39;</span>)
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">path_and_query_params</span>(
        path: str,
        query: int,
        default_none: Optional[str] <span style="color:#f92672">=</span> None):
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: f<span style="color:#e6db74">&#34;hello, {path}, {query} and {default_none}&#34;</span>}
</code></pre></div><p>By doing this, when getting the parameter, FastAPI will consider the python type hint and</p>
<ul>
<li><strong>Conversion</strong>: Enter the argument after converting the data to the specified type</li>
<li><strong>Verification</strong>: Returns <code>{&quot;detail&quot;: &quot;Not Found&quot;}</code> if the specified type cannot be converted.</li>
<li>** Automatic document generation **: Add type information to swagger UI</li>
</ul>
<p>to hold. If you actually check Swagger, you can check the type information of parameter as follows. ‥
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/246552/076d9b05-5389-9e08-79a7-9411177c930e.png" alt="5136078ab0a27e2f274d116438395bc2.png"></p>
<h3 id="validation">validation</h3>
<p>In addition to the above, the following Query, Path can be used to do some advanced things. Query is for query parameter and Path is for path parameter.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> fastapi <span style="color:#f92672">import</span> Query, Path
</code></pre></div><p>Use as follows. Basically the same arguments can be used for Query and Path,</p>
<ul>
<li>The first argument specifies the default value. If you want to have no default value (required), pass <code>...</code></li>
<li>alias: Specify the parameter name. It is used when you want to separate the argument name from the parameter name. For cases where the python naming convention is violated</li>
<li>Other: You can limit the value received by specifying the character length, regular expression, and range of values</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#39;/validation/{path}&#39;</span>)
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validation</span>(
        string: str <span style="color:#f92672">=</span> Query(None, min_length<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, regex<span style="color:#f92672">=</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;[a-c]+.&#39;</span>),
        integer: int <span style="color:#f92672">=</span> Query(<span style="color:#f92672">...</span>, gt<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, le<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>), <span style="color:#75715e"># required</span>
        alias_query: str <span style="color:#f92672">=</span> Query(<span style="color:#e6db74">&#39;default&#39;</span>, alias<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;alias-query&#39;</span>),
        path: int <span style="color:#f92672">=</span> Path(<span style="color:#ae81ff">10</span>)):

    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;string&#34;</span>: string, <span style="color:#e6db74">&#34;integer&#34;</span>: integer, <span style="color:#e6db74">&#34;alias-query&#34;</span>: alias_query, <span style="color:#e6db74">&#34;path&#34;</span>: path}
</code></pre></div><p>You can also check the restrictions from Swagger. Since the API can be hit, try changing the value variously and check if the validation is correctly done.</p>
<h2 id="post-method">POST method</h2>
<h3 id="get-request-body">Get request body</h3>
<h4 id="basic-form">Basic form</h4>
<p>I will explain how to receive post data. First, the basic is as follows, after inheriting <code>pydantic.BaseModel</code>, prepare a class with attribute type hint separately and use it as the type of request body and add type hint with argument. You should</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pydantic <span style="color:#f92672">import</span> BaseModel
<span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Optional, List

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Data</span>(BaseModel):
    <span style="color:#e6db74">&#34;&#34;&#34; A type-hinted class for request data &#34;&#34;&#34;</span>
    string: str
    default_none: Optional[int] <span style="color:#f92672">=</span> None
    lists: List[int]

<span style="color:#a6e22e">@app.post</span>(<span style="color:#e6db74">&#39;/post&#39;</span>)
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">declare_request_body</span>(data: Data):
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: f<span style="color:#e6db74">&#34;hello, {data.string}, {data.default_none}, {data.lists}&#34;</span>}
</code></pre></div><p>Here, the above code assumes that the following json will be posted.```json:requestBody
{
&ldquo;string&rdquo;: &ldquo;string&rdquo;,
&ldquo;default_none&rdquo;: 0,
&ldquo;lists&rdquo;: [1, 2]
}</p>
<pre><code>If there are not enough fields, status code 422 will be returned. (It seems to work normally if there are extra fields)
Also, if you perform the processing up to this point, the expected data structure of the request body can be confirmed from Swagger UI.
![c21c87c01835cab42629eb3e88e30201.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/246552/f516880f-f6bf-8a32-35f3-a7aa75a1635d.png)


#### embed request body
The notation for the case of the following data structure will be explained, a little different from the previous example.

```json:requestBody
{
    &quot;data&quot;: {
        &quot;string&quot;: &quot;string&quot;,
        &quot;default_none&quot;: 0,
        &quot;lists&quot;: [1, 2]
    }
}
</code></pre><p>For such a structure, use the same Data class as above. Only structure can be changed by using <code>fastapi.Body</code>. <code>fastapi.Body</code> is a member of <code>pydantic.Query</code> introduced in the validation of GET method. Similarly, the first argument is the default value. Uses an argument called embed that was not found in <code>pydantic.Query</code>. The structure can be changed with the following minor changes.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> fastapi <span style="color:#f92672">import</span> Body

<span style="color:#a6e22e">@app.post</span>(<span style="color:#e6db74">&#39;/post/embed&#39;</span>)
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">declare_embedded_request_body</span>(data: Data <span style="color:#f92672">=</span> Body(<span style="color:#f92672">...</span>, embed<span style="color:#f92672">=</span>True)):
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: f<span style="color:#e6db74">&#34;hello, {data.string}, {data.default_none}, {data.lists}&#34;</span>}
</code></pre></div><h4 id="nested-request-body">nested request body</h4>
<p>Next, I will explain how to handle the structure in which lists and dictionaries are nested as follows.
The structure of subData is the form of the embed request body described earlier, but we will introduce a different way to write it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;subData&#34;</span>: {
        <span style="color:#f92672">&#34;strings&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>,
        <span style="color:#f92672">&#34;integer&#34;</span>: <span style="color:#ae81ff">0</span>
    },
    <span style="color:#f92672">&#34;subDataList&#34;</span>: [
        {<span style="color:#f92672">&#34;strings&#34;</span>: <span style="color:#e6db74">&#34;string0&#34;</span>, <span style="color:#f92672">&#34;integer&#34;</span>: <span style="color:#ae81ff">0</span>},
        {<span style="color:#f92672">&#34;strings&#34;</span>: <span style="color:#e6db74">&#34;string1&#34;</span>, <span style="color:#f92672">&#34;integer&#34;</span>: <span style="color:#ae81ff">1</span>},
        {<span style="color:#f92672">&#34;strings&#34;</span>: <span style="color:#e6db74">&#34;string2&#34;</span>, <span style="color:#f92672">&#34;integer&#34;</span>: <span style="color:#ae81ff">2</span>}
    ]
}
</code></pre></div><p>With python type hints, nested type declarations can often only be done very roughly. (If rough, it is enough to add subtypes such as <code>List[Any]</code> and <code>List[Dict[str, Any]</code> to the subDataList below)
On the other hand, FastAPI (or rather pydantic) can handle complicated nested structures.
It is recommended to faithfully define subclasses along the nest structure and add type hints as shown below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">subDict</span>(BaseModel):
    strings: str
    integer: int

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NestedData</span>(BaseModel):
    subData: subDict
    subDataList: List[subDict]

<span style="color:#a6e22e">@app.post</span>(<span style="color:#e6db74">&#39;/post/nested&#39;</span>)
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">declare_nested_request_body</span>(data: NestedData):
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: f<span style="color:#e6db74">&#34;hello, {data.subData}, {data.subDataList}&#34;</span>}
</code></pre></div><h3 id="validation-1">validation</h3>
<p>What you can do with GET method is almost the same. The difference is that you use <code>pydantic.Field</code> instead of <code>fastapi.Query</code>. But the arguments are not different.
I just introduced <code>pydantic.Field</code> into each class I used in the nested request body. You can also use it with <code>fastapi.Query</code>, but it uses the example argument. The data passed to this parameter will be the default value when hitting the API from Swagger.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pydantic <span style="color:#f92672">import</span> Field

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ValidatedSubData</span>(BaseModel):
    strings: str <span style="color:#f92672">=</span> Field(None, min_length<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, regex<span style="color:#f92672">=</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;[a-b]+.&#39;</span>)
    integer: int <span style="color:#f92672">=</span> Field(<span style="color:#f92672">...</span>, gt<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, le<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>) <span style="color:#75715e"># required</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ValidatedNestedData</span>(BaseModel):
    subData: ValidatedSubData <span style="color:#f92672">=</span> Field(<span style="color:#f92672">...</span>, example<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;strings&#34;</span>: <span style="color:#e6db74">&#34;aaa&#34;</span>, <span style="color:#e6db74">&#34;integer&#34;</span>: <span style="color:#ae81ff">2</span>})
    subDataList: List[ValidatedSubData] <span style="color:#f92672">=</span> Field(<span style="color:#f92672">...</span>)

<span style="color:#a6e22e">@app.post</span>(<span style="color:#e6db74">&#39;/validation&#39;</span>)
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validation</span>(data: ValidatedNestedData):
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: f<span style="color:#e6db74">&#34;hello, {data.subData}, {data.subDataList}&#34;</span>}
</code></pre></div><p>Handling of # response
Validation can be performed by defining a class defined in request body for response as well.</p>
<h2 id="basic-form-1">Basic form</h2>
<p>If you pass in response_model, by default,</p>
<ul>
<li>For the returned dictionary, the key that does not have a name matching attributes is discarded</li>
<li>Although it is not included in the returned dictionary, if there is a default value in attributes, that value will be filled in</li>
</ul>
<p>Here, if you write as follows, <code>integer</code> of the returning dictionary will be discarded and <code>aux</code> will be supplemented and json will be returned. (A very simple example is given, but if it is nested or a slightly complicated validation is required, the notation for the type hint mentioned in &ldquo;Handling of request&rdquo; can be used as it is.)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ItemOut</span>(BaseModel):
    strings: str
    aux: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    text: str

<span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#39;/&#39;</span>, response_model<span style="color:#f92672">=</span>ItemOut)
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">response</span>(strings: str, integer: int):
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;hello world!&#34;</span>, <span style="color:#e6db74">&#34;strings&#34;</span>: strings, <span style="color:#e6db74">&#34;integer&#34;</span>: integer}
</code></pre></div><p>At this stage, you can check the response data schema from Swagger.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/246552/62822fea-f84c-b23c-6b42-507e51e3287e.png" alt="bb16c30d6110d5ec387b8e8edca89fc8.png"></p>
<h2 id="derivative">Derivative</h2>
<p>There are several options for using response_model.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Don&#39;t put default value for response_model attributes if it doesn&#39;t exist in dictionary</span>
<span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#39;/unset&#39;</span>, response_model<span style="color:#f92672">=</span>ItemOut, response_model_exclude_unset<span style="color:#f92672">=</span>True)
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">response_exclude_unset</span>(strings: str, integer: int):
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;hello world!&#34;</span>, <span style="color:#e6db74">&#34;strings&#34;</span>: strings, <span style="color:#e6db74">&#34;integer&#34;</span>: integer}

Ignore <span style="color:#e6db74">&#34;strings&#34;</span> <span style="color:#f92672">and</span> <span style="color:#e6db74">&#34;aux&#34;</span> <span style="color:#f92672">in</span> <span style="color:#75715e"># response_model -&gt; return only &#34;text&#34;</span>
<span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#39;/exclude&#39;</span>, response_model<span style="color:#f92672">=</span>ItemOut, response_model_exclude<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;strings&#34;</span>, <span style="color:#e6db74">&#34;aux&#34;</span>})
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">response_exclude</span>(strings: str, integer: int):
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;hello world!&#34;</span>, <span style="color:#e6db74">&#34;strings&#34;</span>: strings, <span style="color:#e6db74">&#34;integer&#34;</span>: integer}

Only consider <span style="color:#e6db74">&#34;text&#34;</span> <span style="color:#f92672">in</span> <span style="color:#75715e"># response_model -&gt; return only &#34;text&#34;</span>
<span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#39;/include&#39;</span>, response_model<span style="color:#f92672">=</span>ItemOut, response_model_include<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;text&#34;</span>})
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">response_include</span>(strings: str, integer: int):
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;hello world!&#34;</span>, <span style="color:#e6db74">&#34;strings&#34;</span>: strings, <span style="color:#e6db74">&#34;integer&#34;</span>: integer}

</code></pre></div><h1 id="error-handling--status-code-management">error handling &amp; status code management</h1>
<p>There are three levels of status code management.</p>
<ul>
<li>Declare default status code: declare in decorator</li>
<li>Return 400s with error handling: Raise <code>fastapi.HTTPException</code> at the right place</li>
<li>Flexible change of status code and return: touch the starlette directly
-Add <code>starlette.responses.Response</code> type as an argument
-You can change the output status code by rewriting <code>response.status_code</code>
-Return the data you want to return as usual</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> fastapi <span style="color:#f92672">import</span> HTTPException
<span style="color:#f92672">from</span> starlette.responses <span style="color:#f92672">import</span> Response
<span style="color:#f92672">from</span> starlette.status <span style="color:#f92672">import</span> HTTP_201_CREATED

<span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#39;/status&#39;</span>, status_code<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>) <span style="color:#75715e"># default status code specificationasync def response_status_code(integer: int, response: Response):</span>
    <span style="color:#66d9ef">if</span> integer <span style="color:#f92672">&gt;</span><span style="color:#ae81ff">5</span>:
        <span style="color:#75715e"># error handling</span>
        <span style="color:#66d9ef">raise</span> HTTPException(status_code<span style="color:#f92672">=</span><span style="color:#ae81ff">404</span>, detail<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;this is error messages&#34;</span>)
    <span style="color:#66d9ef">elif</span> integer <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
        <span style="color:#75715e"># set manually</span>
        response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">=</span> HTTP_201_CREATED
        <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;hello world, created!&#34;</span>}
    <span style="color:#66d9ef">else</span>:
        <span style="color:#75715e"># default status code</span>
        <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;hello world!&#34;</span>}
</code></pre></div><h1 id="background-process">background process</h1>
<p>If you use background process, you can return only the response before heavy processing is completed.
This process is quite difficult for WSGI (Django etc.) systems. However, with Starlette-based ASGI, this process can be handled very concisely.</p>
<p>The procedure is</p>
<ol>
<li>Declare an argument whose type is <code>fastapi.BackgroundTasks</code></li>
<li>Throw a task with <code>.add_task</code></li>
</ol>
<p>It&rsquo;s hard to predict what&rsquo;s going on, but I think the description itself is easy.</p>
<p>As an example of heavy processing, let&rsquo;s sleep the received path parameter seconds and then execute a background process that prints.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> fastapi <span style="color:#f92672">import</span> BackgroundTasks
<span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep
<span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">time_bomb</span>(count: int):
    sleep(count)
    <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#39;bomb!!! {datetime.utcnow()}&#39;</span>)

<span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#39;/{count}&#39;</span>)
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">back</span>(count: int, background_tasks: BackgroundTasks):
    background_tasks<span style="color:#f92672">.</span>add_task(time_bomb, count)
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;finish&#34;</span>} <span style="color:#75715e"># Returns a response without waiting for the end of time_bomb</span>
</code></pre></div><p>Results are processed in the following order</p>
<ol>
<li>Response headers date=17:37:14</li>
<li>Date output to print=17:37:25</li>
</ol>
<p>So it seems that it is being processed properly in the background.
<img width="981" alt="Screenshot 2020-01-03 2.39.19.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/246552/bff822ac-a6a9-5ddd-e63b-dd1df8855d56.png"></p>
<h1 id="unittest">unittest</h1>
<p>Starlet&rsquo;s TestClient is excellent, and you can easily hit api for unittest.
This time, I will run unittest with pytest as per the tutorial.</p>
<h2 id="install">install</h2>
<pre><code>$ pip install requests pytest
</code></pre><h2 id="directory-placement">directory placement</h2>
<pre><code>├── intro.py
└── tests
    ├── __init__.py
    └── test_intro.py
</code></pre><p>Now, let&rsquo;s do the following unittest.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:intro.py" data-lang="python:intro.py"><span style="color:#f92672">from</span> fastapi <span style="color:#f92672">import</span> FastAPI
<span style="color:#f92672">from</span> pydantic <span style="color:#f92672">import</span> BaseModel
<span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Optional, List
app <span style="color:#f92672">=</span> FastAPI()

<span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>():
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;hello world!&#34;</span>}

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Data</span>(BaseModel):
    string: str
    default_none: Optional[int] <span style="color:#f92672">=</span> None
    lists: List[int]

<span style="color:#a6e22e">@app.post</span>(<span style="color:#e6db74">&#39;/post&#39;</span>)
async <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">declare_request_body</span>(data: Data):
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;text&#34;</span>: f<span style="color:#e6db74">&#34;hello, {data.string}, {data.default_none}, {data.lists}&#34;</span>}
</code></pre></div><h2 id="unittest-1">unittest</h2>
<p>It is selling that you can easily hit GET and POST with <code>starlette.testclient.TestClient</code> and make a response <code>assert</code> as shown below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:test_intro.py" data-lang="python:test_intro.py"><span style="color:#f92672">from</span> starlette.testclient <span style="color:#f92672">import</span> TestClient
<span style="color:#f92672">from</span> intro <span style="color:#f92672">import</span> app

<span style="color:#75715e"># get and assign app to create test client</span>
client <span style="color:#f92672">=</span> TestClient(app)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_read_hello</span>():
    response <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/&#34;</span>)
    <span style="color:#66d9ef">assert</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>
    <span style="color:#66d9ef">assert</span> response<span style="color:#f92672">.</span>json() <span style="color:#f92672">==</span> {<span style="color:#e6db74">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;hello world!&#34;</span>}

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_read_declare_request_body</span>():
    response <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>post(
        <span style="color:#e6db74">&#34;/post&#34;</span>,
        json<span style="color:#f92672">=</span>{
            <span style="color:#e6db74">&#34;string&#34;</span>: <span style="color:#e6db74">&#34;foo&#34;</span>,
            <span style="color:#e6db74">&#34;lists&#34;</span>: [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>],
        }
    )
    <span style="color:#66d9ef">assert</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>
    <span style="color:#66d9ef">assert</span> response<span style="color:#f92672">.</span>json() <span style="color:#f92672">==</span> {
        <span style="color:#e6db74">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;hello, foo, None, [1, 2]&#34;</span>,
    }
</code></pre></div><h2 id="pytest-execution">pytest execution</h2>
<pre><code>$ pytest
========================= test session starts ====================== ===
platform darwin-Python 3.6.8, pytest-5.3.2, py-1.8.1, pluggy-0.13.1
rootdir: ***/***/***
collected 1 items

tests/test_intro.py .[100%]
========================== 1 passed in 0.44s =================== =======
</code></pre><h1 id="deployment">deployment</h1>
<p>You have the following options: Since it is a simple application, I think that there are few things to worry about with the infrastructure.</p>
<ul>
<li>If you can do pip install and even start uvicorn, it works for the same as local</li>
<li>Docker image (Official): It seems that performance is tuned. Above all, it is official, so there is a sense of trust.</li>
</ul>
<p>Basically, if docker can be used, the latter method is preferable, and in other cases (such as making a quick API with PaaS), the former method is preferable.</p>
<p>As for specific details, there is no processing specific to FastAPI, and this procedure is the same as other microframework, so I will omit it this time.
reference:</p>
<ul>
<li><a href="https://fastapi.tiangolo.com/deployment/">Official document (deployment)</a></li>
<li><a href="https://github.com/reud/fast-api-heroku-sample">Heroku Example</a></li>
</ul>
<p>#Other (CORS problem handling, certification)
There is no need to write any other tutorials, but I will summarize the frequently used settings and references for things that strongly depend on the context.</p>
<ul>
<li><a href="https://fastapi.tiangolo.com/tutorial/cors/">Addressing CORS (Cross-Origin Resource Sharing) problem</a>: This problem occurs when frontend is on a different server from backend.</li>
<li><a href="https://fastapi.tiangolo.com/tutorial/security/intro/">Authentication</a>: Contains examples of OAuth2 and HTTP basic authentication. Documentation is also automatically generated for authentication</li>
</ul>
<p>#Summary
This is the end of the minimum tutorial.
With this, I think that you can complete the development of API server -&gt; deployment.</p>
<p>In addition to the contents dealt with this time, if you want to handle linkage with database, html rendering, websocket, GraphQL, etc., I think it is sufficient to refer to the chapters related to it.</p>
<p>Anyway, it is convenient that Swagger is automatically generated, so I would like you to try it while moving your own hands!</p>
<p>Finally, I will introduce the most interesting chapter in the official documentation of FastAPI, although it has little to do with the content of this article. The history of development and the points of differentiation from other frameworks are mentioned.</p>
<ul>
<li><a href="https://fastapi.tiangolo.com/alternatives/">Alternatives, Inspiration and Comparisons</a></li>
</ul>
<h1 id="refs">Refs</h1>
<ul>
<li><a href="https://fastapi.tiangolo.com/">Official document</a></li>
</ul>
<h1 id="supplement">Supplement</h1>
<p>As for the miso, I tried to do Schema definition -&gt; swagger generation in the responder before, but the description amount was completely different. (Since there is no description of FastAPI only for Swagger) <a href="https://qiita.com/bee2/items/6ad572a7be053974ab7f">Here</a>, you can see how FastAPI is amazing and vice versa. I think you can</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
