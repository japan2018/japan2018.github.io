<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] With deep learning, you can exceed 100% recovery rate in horse racing | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] With deep learning, you can exceed 100% recovery rate in horse racing</h1>
<p>
  <small class="text-secondary">
  
  
  Nov 9, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/data-analysis"> data analysis</a></code></small>


<small><code><a href="https://memotut.com/tags/deep-learning"> deep learning</a></code></small>


<small><code><a href="https://memotut.com/tags/tensorflow"> TensorFlow</a></code></small>


<small><code><a href="https://memotut.com/tags/horse-racing"> horse racing</a></code></small>

</p>
<pre><code>![4370674310_b118d0f62a_c.jpg](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280076/a136d9bb-956d-2b10-6418-85302ddbbc07.jpeg)
</code></pre>
<p>pohotos by <a href="https://www.flickr.com/photos/ronmacphotos/4370674310/in/photolist-7EdRcC-5oHeUL-NtmbGV-RUTNAw-8Zumy8-UfnFzm-FCmoWq-UhX7ZF-5TvY7d-TfSQAP-7vr4 -5oCTJV-2672toE-FEGSNV-8ZukPF-TfTVPc-J2CYHc-8Zumd6-8ZxrJA-rXwqMB-5oCNFa-QS1gi5-7UeXsh-FLwkfH-brVocac-vdb7Sz-5TrDag-FCkN37-neRM-KnVMR-Kqevs -9BrAza-7E9RvT-UqPSNq-brVniM-8ZxrdC-ufRmrE-uVgVEd-FEP5PM-neQUZr-5mi6ZQ-brVmtK-27drMaf-ER5E9o">Ronnie Macdonald</a></p>
<p>It&rsquo;s been a while since I was told that &ldquo;AI takes away human work&rdquo; **, but now some people say that &ldquo;I&rsquo;m in a period of disillusionment&rdquo; **. Thanks to that, I was not robbed of my work, and I am swayed by a crowded train every day. The scams that rob you are also a good thing.</p>
<p>While the development of such AI seems to take a little longer, it is now easy to obtain an environment for learning. If you touch it, it feels like everyone is disillusioned. With that said, I decided to touch deep learning in order to know the power of AI. **</p>
<p>I tried various things, but here I will tell you that the main result is ** &ldquo;Even if you study from the state of ignorance, you can enjoy this much with deep learning&rdquo; **. The program isn&rsquo;t a model, so I&rsquo;ll publish it for a fee only to those who want to see it.</p>
<h1 id="kaggle-sees-how-deep-learning-works">Kaggle sees how deep learning works</h1>
<p>First, I studied a little math, which is the basis of deep learning. No&hellip; it&rsquo;s quite a pain. A formula following a formula. You can write code without knowing it, but **I understand that if you understand the mathematical meaning, it will be easier to understand, so I think that there is no loss in learning only with an outline **.</p>
<p>So, after studying lightly, first of all, in order to confirm the power of deep learning, I decided to try with the famous machine learning theme ** &ldquo;Predicting survivors of Titanic&rdquo; **. A guy who predicts who survived based on attributes such as age and gender of each passenger.</p>
<p>The environment is Google Colaboratory, and TensorFlow that seems to be the easiest to implement is used. It was easy to make just by referring to the Google tutorial. Upload your predictions and you&rsquo;ll get back a score.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280076/a692a94d-82e6-0a47-bb4f-b22fe5f44b3b.jpeg" alt="titanic.jpg"></p>
<p>** Correct answer rate 76.5% **. It is a model properly made by a beginner, and the correct answer is about 80%. Adjusting parameters and data will make it even better.</p>
<p>Originally, I thought about various things such as &ldquo;Is the woman or child given priority to be helped?&rdquo; and analyze it through trial and error, but <strong>the whole thing was done by deep learning</strong>. Certainly deep learning is quite amazing.</p>
<h2 id="great-but-not-fun">Great, but not fun</h2>
<p>While making this prediction, I felt a big problem while I wanted to touch it more.</p>
<p>Uninteresting…. Deep learning is not, but the theme is not interesting. Predicting the life or death of passengers of overseas ships that sank over 100 years ago is not interesting at all! **</p>
<p>** &ldquo;James&hellip; you thought you were dead&hellip; were you alive!&rdquo; ** or ** &ldquo;Reina&hellip; why did you die?!&rdquo; ** Isn&rsquo;t it? No one knows. I&rsquo;m all dead. In the first place Kaggle can&rsquo;t tell you the correct answer.</p>
<p>I want a more exciting theme&hellip; So, this is a theme that has something to do with money that I&rsquo;ve always wanted to try.</p>
<h1 id="try-to-exceed-100-recovery-rate-in-horse-racing-using-deep-learning">Try to exceed 100% recovery rate in horse racing using deep learning</h1>
<p>Since the deduction rate for horse racing seems to be around 20%, the average return is 80%. It should be relatively difficult to exceed 100% recovery rate. But there should be a lot of past data, and deep learning could do it? I will try with the expectation that.</p>
<p>The goal is &ldquo;to exceed 100% recovery rate for multi-horse betting tickets&rdquo;**.</p>
<p>Due to the nature of horse racing, it may be more efficient to aim for a betting ticket with a larger dividend than a multi-winning game, but since it seems to be interesting if it is not a betting ticket that is easy to hit, we focused on multi-winning.</p>
<h2 id="target-data">Target data</h2>
<p>For learning: 2010-2017
For verification: 2018-2019 (until early November)</p>
<p>We aim to exceed 100% with verification data. First of all, I scraped on the net and prepared such data.</p>
<table>
<thead>
<tr>
<th>Classification</th>
<th>Item</th>
</tr>
</thead>
<tbody>
<tr>
<td>Horse Information</td>
<td>Horse Number</td>
</tr>
<tr>
<td></td>
<td>Frame number</td>
</tr>
<tr>
<td></td>
<td>Age</td>
</tr>
<tr>
<td></td>
<td>Gender</td>
</tr>
<tr>
<td></td>
<td>Weight (current)</td>
</tr>
<tr>
<td></td>
<td>Weight (difference from previous run)</td>
</tr>
<tr>
<td></td>
<td>Burden Weight</td>
</tr>
<tr>
<td>Race information on the day</td>
<td>Race track</td>
</tr>
<tr>
<td></td>
<td>Number of Horses Entered</td>
</tr>
<tr>
<td></td>
<td>Course distance</td>
</tr>
<tr>
<td></td>
<td>Course Type</td>
</tr>
<tr>
<td></td>
<td>Course type (da/turf/obstacle)</td>
</tr>
<tr>
<td></td>
<td>Weather</td>
</tr>
<tr>
<td></td>
<td>Baba condition</td>
</tr>
<tr>
<td>Past race information for the same horse (×5 runs)</td>
<td>Odds</td>
</tr>
<tr>
<td></td>
<td>Popularity</td>
</tr>
<tr>
<td></td>
<td>Rank</td>
</tr>
<tr>
<td></td>
<td>Time (seconds)</td>
</tr>
<tr>
<td></td>
<td>Wear difference</td>
</tr>
<tr>
<td></td>
<td>Number of days elapsed since the previous race</td>
</tr>
<tr>
<td></td>
<td>Course distance</td>
</tr>
<tr>
<td></td>
<td>Course Type</td>
</tr>
<tr>
<td></td>
<td>Course type (da/turf/obstacle)</td>
</tr>
<tr>
<td></td>
<td>Weather</td>
</tr>
<tr>
<td></td>
<td>Baba condition</td>
</tr>
<tr>
<td>*We omit &ldquo;Odds&rdquo; and &ldquo;Popularity&rdquo; on the day because they are not directly related to winning or losing.</td>
<td></td>
</tr>
<tr>
<td>*&ldquo;Odds&rdquo; in this article refers to winning odds.</td>
<td></td>
</tr>
</tbody>
</table>
<p>#3 predict horses within</p>
<p>Using this data as input, deep learning predicts &ldquo;whether within 3 places&rdquo; **. <strong>The predicted value is a number from 0 to 100 (this is called &ldquo;3rd place index&rdquo;)</strong>. The higher this value, the more likely it is to finish within 3rd place.</p>
<p>By the way, the code of the prediction model creation part, which is the core of deep learning, is only this.</p>
<pre><code class="language-python:" data-lang="python:">import tensorflow as tf

model = tf.keras.Sequential((
    tf.keras.layers.Dense(300, kernel_regularizer=tf.keras.regularizers.l2(0.001), activation=tf.nn.relu, input_dim=len(train_df.columns)),
    tf.keras.layers.Dropout(0.2),
    tf.keras.layers.Dense(300, kernel_regularizer=tf.keras.regularizers.l2(0.001), activation=tf.nn.relu),
    tf.keras.layers.Dropout(0.2),
    tf.keras.layers.Dense(1, activation=tf.nn.sigmoid)
])

model.compile(
    loss='binary_crossentropy',
    optimizer=tf.keras.optimizers.Adam(),
    metrics=['accuracy'])

fit = model.fit(train_df,
    train_labels,
    validation_data=(valid_df, valid_labels),
    epochs=30,
    batch_size=32)

</code></pre><p>*The 100th multiplication of the output result of the sigmoid function is used as the third-place index.</p>
<h2 id="try-to-buy-in-all-races">Try to buy in all races</h2>
<p>I will purchase the betting ticket with the highest <strong>3rd place index</strong> for each race with the model I created. This is the result of simulation in all races after 2018.</p>
<table>
<thead>
<tr>
<th align="left">Item</th>
<th align="right">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Target number of races (*)</td>
<td align="right">3639</td>
</tr>
<tr>
<td align="left">Number of target records</td>
<td align="right">41871</td>
</tr>
<tr>
<td align="left">Purchases</td>
<td align="right">3639</td>
</tr>
<tr>
<td align="left">Hit number</td>
<td align="right">1976</td>
</tr>
<tr>
<td align="left">Hit rate</td>
<td align="right"><strong>54.3%</strong></td>
</tr>
<tr>
<td align="left">Recovery rate</td>
<td align="right"><strong>82.7%</strong></td>
</tr>
</tbody>
</table>
<ul>
<li>Only for races with 5 or more horses without missing values (including past race information).</li>
</ul>
<p>Although it is reasonably correct, ** Recovery rate does not increase. **In the first place, I am wondering what the relationship between the 3rd place index, the hit rate (the ratio that was actually within 3rd place), and the collection rate.</p>
<h2 id="3-relationship-between-arrival-index-and-hit-raterecovery-rate">3 Relationship between arrival index and hit rate/recovery rate</h2>
<p>The relationship between the third place index and the hit rate was like this.<img width="492" alt="Screenshots 2019-11-01 14.10.12.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280076/20fb7d10-1e27-0246-f112-18bbe3af5be7.png"></p>
<p><strong>The higher the 3rd place index, the higher the hit rate</strong>, so it seems to work as a model that hits within 3rd place. Then, ** Will the recovery rate exceed 100% if we buy only horses with a high index? **</p>
<p>Let&rsquo;s add the average recovery rate to the graph above.
<img width="492" alt="Screenshots 2019-11-01 14.05.30.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280076/d8658277-91a9-2040-885d-b36c34aff70e.png"></p>
<p>The recovery rate is around 80% to 90% regardless of the hit rate. In other words, the higher the **3 finish index (a horse that is likely to win), the smaller the return. **</p>
<p>Then, the relationship between this index and hit rate is similar to the relationship between ** odds and hit rate ** (the lower the odds, the smaller the return). So, if you look at the relationship between the third place index and the average odds&hellip;
<img width="389" alt="Screenshots 2019-11-01 18.58.38.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280076/d80715b1-4e77-e6e3-467f-58e4cdce1b40.png"></p>
<p>In inversely proportional graph. After all, horses with a high **3 finish index have low odds. ** Even if you predict without looking at the odds, it will end up like this. It&rsquo;s interesting, but this seems to be the difficulty of horse racing.</p>
<h2 id="to-exceed-100-recovery-rate">To exceed 100% recovery rate</h2>
<p>I found that the third place index and odds were almost inversely proportional. But that&rsquo;s the average odds. If you look at each one, there should be ** &ldquo;A horse with high odds despite a high third place index&rdquo; **. In order to increase the recovery rate, it seems good to poke such <strong>odd distortion</strong>.</p>
<p>However, if you buy all betting tickets with a third place index of 70 or more and odds of 100 or more, you will get such a dire result.</p>
<table>
<thead>
<tr>
<th align="left">Item</th>
<th align="right">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Purchases</td>
<td align="right">73</td>
</tr>
<tr>
<td align="left">Hit number</td>
<td align="right">1</td>
</tr>
<tr>
<td align="left">Hit rate</td>
<td align="right"><strong>1.37%</strong></td>
</tr>
<tr>
<td align="left">Recovery rate</td>
<td align="right"><strong>16.9%</strong></td>
</tr>
</tbody>
</table>
<p>Horses with very high odds seem to have a low hit rate, even if the index is high. There may be some reason for the high odds. Conversely, if the odds are too low, the dividend will naturally be small and the recovery rate will not increase. If so, ** the aim is intermediate. **
<img width="389" alt="sanpu.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280076/4f828d7f-5379-a21d-0d77-b99aad3eb195.png"></p>
<p>(Since then, others have pointed out the prediction target, so we have corrected it to the result of expanding the target)</p>
<p>According to the 2018 forecast, **3rd place index is 60 or more and odds are not too high. Next, it feels pretty good.</p>
<table>
<thead>
<tr>
<th align="left">Item</th>
<th align="right">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Purchases</td>
<td align="right">44</td>
</tr>
<tr>
<td align="left">Hit number</td>
<td align="right">10</td>
</tr>
<tr>
<td align="left">Hit rate</td>
<td align="right"><strong>22.7%</strong></td>
</tr>
<tr>
<td align="left">Recovery rate</td>
<td align="right"><strong>213.6%</strong></td>
</tr>
</tbody>
</table>
<p>However, this is a good take on 2018, so it&rsquo;s obvious with good results. However, using the same prediction method, when I simulated it in 2019, the recovery rate is also 194% **. This is what happened in the total of 2 years (about 22 months).</p>
<table>
<thead>
<tr>
<th align="left">Item</th>
<th align="right">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Purchases</td>
<td align="right">99</td>
</tr>
<tr>
<td align="left">Hit number</td>
<td align="right">19</td>
</tr>
<tr>
<td align="left">Hit rate</td>
<td align="right"><strong>19.2%</strong></td>
</tr>
<tr>
<td align="left">Recovery rate</td>
<td align="right"><strong>202.63%</strong></td>
</tr>
</tbody>
</table>
<p>With this, we have safely exceeded the goal of 100% recovery rate*. **By the way**, after 2018, if you buy 100 yen each time according to this prediction, the income and expenditure graph will be like this. It is rising steadily without a big drop.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280076/61a499f4-f42e-d694-045f-b86ebab38ddf.jpeg" alt="tmp.jpg"></p>
<p>It&rsquo;s possible that the last two years are doing well, but if it&rsquo;s a staircase up to this point, it&rsquo;s possible to trust it to some extent. Although there are not many purchases (about four times a month), <strong>Do not choose the enemy who can not win</strong> will be a prerequisite for winning.</p>
<h2 id="bonus-predict-horses-with-high-dividends">(Bonus) Predict horses with high dividends</h2>
<p>It&rsquo;s okay to end with this, but since it&rsquo;s a big deal, I will try a prediction of ** &ldquo;expected dividend value&rdquo; ** as a different pattern from the third place prediction.</p>
<p>Odds also gives the data included in the input to deep learning and predicts the result, and graphs it in the same way as before. <strong>A horse that is likely to win even with high odds</strong> appears to have higher expectations. (The horizontal axis of the graph still has a point, but it is omitted.)
<img width="386" alt="kitaichi_odds.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280076/54950bd1-3bda-d328-c1ca-7daf29da8cf5.png"></p>
<p>It is the relationship between the expected value and the collection rate / hit rate.
<img width="616" alt="kitaichi_return.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280076/84d3d676-5b5b-c07f-05b2-40798dbe9975.png"></p>
<p>As far as the recovery rate is rising, it seems that the recovery rate will increase if you buy a betting ticket with a high expected value forever **, but this too is a small number in 1-2 years and is not stable ** it seems like.</p>
<p>If you buy all the horses with good <strong>expected value of 390-450</strong> on the graph, it will exceed 100% for the time being, but it seems to be a local rise, so it seems unlikely that it will continue to stabilize.</p>
<table>
<thead>
<tr>
<th align="left">Item</th>
<th align="right">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Purchases</td>
<td align="right">275</td>
</tr>
<tr>
<td align="left">Hit number</td>
<td align="right">37</td>
</tr>
<tr>
<td align="left">Hit rate</td>
<td align="right"><strong>13.5%</strong></td>
</tr>
<tr>
<td align="left">Recovery rate</td>
<td align="right"><strong>131.1%</strong></td>
</tr>
</tbody>
</table>
<p>The balance of payments will also be more volatile than when the third place index. Since I aim for higher odds, the return when hit is large.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/280076/caec12ec-4e84-3aa7-c2de-7ef2ec034162.jpeg" alt="shushi2.jpg"></p>
<p>That&rsquo;s all you have done.</p>
<h2 id="click-here-for-program">Click here for program</h2>
<p>The program (Python) for creating and verifying the prediction model of the 3rd place index is experimentally released on the following page for a fee. It&rsquo;s not beautiful to use as a textbook, so only look at those who are curious and have plenty of money and money.</p>
<p><a href="https://note.mu/yossymura/n/n23bc79372664">If you have deep learning, you can exceed 100% recovery rate in horse racing (program)</a></p>
<p>[Click here for more details]
(<a href="https://note.mu/yossymura/n/na3d0a471193c">https://note.mu/yossymura/n/na3d0a471193c</a>)</p>
<p>#Postscript</p>
<p>Recently, mobile payments have finally become widespread due to the large amount of battles for QR payments. Seeing how rewards and coupons are irritated to make anything fashionable, other than payment, <strong>I feel that it is &ldquo;money&rdquo; that moves people</strong>, and then the money involved I was thinking of writing an article, so I&rsquo;m happy to write it this way.</p>
<p>The input of this forecast does not include &ldquo;horse name&rdquo; and &ldquo;jockey name&rdquo;. In other words, if you take into account <strong>horse pedigree, jockey battle history, compatibility</strong> etc., you will be able to make more accurate predictions. In addition to <strong>complementing missing data</strong> and <strong>batch normalization</strong>, I think that it can be improved simply by <strong>parameter adjustment</strong> as deep learning, and *<em>betting tickets other than wins</em> * Can also be expected. In short, there is still room for growth.</p>
<p>On the one hand, it was convenient, but on the other hand, the only thing I was worried about was that predicting horse racing with AI would impair &ldquo;the fun of predicting with my own head&rdquo;**. I feel that AI does not give me the joy of winning a horse that I choose with my own instincts, attachment to horses, and other feelings that overflow from me.</p>
<p>Whenever anyone uses AI to predict any future, will people still be able to get together at the racetrack, forget themselves and continue to be crazy? How long can I see that huge amount of betting tickets flying in the sky? I want to utilize it effectively so that not only my work but also my heart is not caught up in the coming AI wave.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
