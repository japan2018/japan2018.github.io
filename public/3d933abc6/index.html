<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] Wear Instagram | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] Wear Instagram</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 10, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/selenium">Selenium</a></code></small>


<small><code><a href="https://memotut.com/tags/opencv">OpenCV</a></code></small>


<small><code><a href="https://memotut.com/tags/googlecolaboratory">GoogleColaboratory</a></code></small>


<small><code><a href="https://memotut.com/tags/densepose">DensePose</a></code></small>

</p>
<pre><code>What kind of photos do you post when you post photos on instagram? [^1]
</code></pre>
<p>I think that SNS for showing to others, it is easy to unconsciously produce a fulfilling self **.
Maybe that&rsquo;s what your actions are tied to ** your SNS&rsquo;s past posts?</p>
<p>I would like to express such a situation.</p>
<blockquote>
<p>This article is Keio SFC Tokui Lab (Computational Creativity Lab.)
Also serves as a commentary on the summer camp 2019 hackathon</p>
</blockquote>
<h2 id="memorybody">MemoryBody</h2>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/198787/58fab805-bcc2-ff0c-fa3c-0629ab91e82f.png" alt="memory_body.png"></p>
<p>The name of the work is wearing memories: I left it as &ldquo;<strong>Memory Body</strong>&rdquo;.
As a model to wear my own instagram image, I borrowed Naomi Watanabe&rsquo;s instagram account <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.
When I tried it with Naomi Watanabe, <strong>it looks pretty cool</strong>.</p>
<p>In addition, this work is a team at the SFC Tokui Ken summer camp hackathon (I @jg43yr, @santa_sukitoku, <a href="https://hana-folio.tumblr.com/?fbclid=IwAR2Aq5YE_ENOYUi1o4FxrcLdeYSvQ-iP-fJNND">Hanagata-san</a>)Itisacollaborativeworkwith(mainlyinchargeofimplementation)</p>
<p>We will implement the above work on <strong>cloud</strong>.</p>
<h2 id="methods-about-technology">Methods: About technology</h2>
<p>Now let&rsquo;s talk about the technical side.</p>
<blockquote>
<p>We are looking forward to a gentle Masakari <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p>
</blockquote>
<h3 id="1-3d-coordinate-estimation-of-the-human-body-surface-by-densepose">1. 3D coordinate estimation of the human body surface by DensePose</h3>
<p>Paper: <a href="https://ieeexplore.ieee.org/document/8578860">DensePose: Dense Human Pose Estimation in the Wild</a></p>
<p><a href="https://github.com/facebookresearch/DensePose">DensePose</a> is a segmentation of the human body from a CNN-based 2D image announced at Facebook&rsquo;s CVPR in 2018 by Facebook Research. The deep model to estimate. The implementation and the trained model are published, so I&rsquo;ll use this.</p>
<p><img width="1408" alt="Screenshot 0001-12-07 12.15.42.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/198787/1dd21efb-5fc6-29a1-8bda-f9c696c69447.png"> <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
<p>However, since the official implementation has a restriction that it can only operate on Linux with Python 2 &amp; NVIDIA GPU **<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>, it will be implemented on Google Colaboratory, not on its own machine.</p>
<h3 id="2-change-the-texture-of-the-human-body-surface">2. Change the texture of the human body surface</h3>
<p>With DensePose, the texture of the estimated body surface can be changed by properly preparing the image for texture.</p>
<img width="100%" alt="Screenshot 0001-12-10 15.53.59.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/198787/cb5c34fa-d736-8e88-7872-386012e4f9e3.png">
<p>The group photo taken with the webcam is as follows.</p>
<img width="75%" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/198787/c83aa734-9f18-df59-ee62-e764d4de8cc4.png">
<details><summary>Text conversion script cell</summary><div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> cv2
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> display, Javascript
<span style="color:#f92672">from</span> google.colab.output <span style="color:#f92672">import</span> eval_js
<span style="color:#f92672">from</span> base64 <span style="color:#f92672">import</span> b64decode
<span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> Image


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">texture_transfer</span>(photo_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;image.jpg&#34;</span>,
    texture_img_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;DensePose/DensePoseData/demo_data/texture_from_SURREAL.png&#34;</span>):
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Executing pose detection...&#34;</span>)

    os<span style="color:#f92672">.</span>system(
<span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">cd {} &amp;&amp; python2 tools/infer_simple.py
</span><span style="color:#e6db74">- -cfg configs/DensePose_ResNet101_FPN_s1x-e2e.yaml
</span><span style="color:#e6db74">- -output-dir DensePoseData/infer_out/
</span><span style="color:#e6db74">- -image-ext jpg
</span><span style="color:#e6db74">- -wts https://dl.fbaipublicfiles.com/densepose/DensePose_ResNet101_FPN_s1x-e2e.pkl ../{}
</span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#f92672">.</span>format(project_name, photo_name))

    im <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imread(photo_name)
    IUV <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imread(join(project_name,<span style="color:#e6db74">&#39;DensePoseData/infer_out/{}_IUV.png&#39;</span><span style="color:#f92672">.</span>format(photo_name[:<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>])))
    INDS <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imread(join(project_name,<span style="color:#e6db74">&#39;DensePoseData/infer_out/{}_INDS.png&#39;</span><span style="color:#f92672">.</span>format(photo_name[:<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>])), <span style="color:#ae81ff">0</span>)

    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>[<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">8</span>])
    Tex_Atlas <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imread(texture_img_name)[:,:,::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">/</span><span style="color:#ae81ff">255.</span>
    <span style="color:#75715e"># plt.imshow(Tex_Atlas.transpose([1,0,2])); plt.axis(&#39;off&#39;); plt.show()</span>

    TextureIm <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros([<span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">200</span>,<span style="color:#ae81ff">200</span>,<span style="color:#ae81ff">3</span>]);

    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Synthesis...&#34;</span>)
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">4</span>):
        <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">6</span>):
            TextureIm[(<span style="color:#ae81ff">6</span><span style="color:#f92672">*</span>i<span style="color:#f92672">+</span>j), :,:,:] <span style="color:#f92672">=</span> Tex_Atlas[ (<span style="color:#ae81ff">200</span><span style="color:#f92672">*</span>j):(<span style="color:#ae81ff">200</span><span style="color:#f92672">*</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">200</span>) ,(<span style="color:#ae81ff">200</span><span style="color:#f92672">*</span>i):(<span style="color:#ae81ff">200</span><span style="color:#f92672">*</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">200</span>) ,:]

    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>[<span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">20</span>])
    plt<span style="color:#f92672">.</span>imshow( im[:,:,::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
    plt<span style="color:#f92672">.</span>contour( IUV[:,:,<span style="color:#ae81ff">1</span>]<span style="color:#f92672">/</span><span style="color:#ae81ff">256.</span>,<span style="color:#ae81ff">10</span>, linewidths <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> )<span style="color:#f92672">.</span>
    plt<span style="color:#f92672">.</span>contour( IUV[:,:,<span style="color:#ae81ff">2</span>]<span style="color:#f92672">/</span><span style="color:#ae81ff">256.</span>,<span style="color:#ae81ff">10</span>, linewidths <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> )<span style="color:#f92672">.</span>
    plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
    plt<span style="color:#f92672">.</span>show()

    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Transfering...&#34;</span>)
    image <span style="color:#f92672">=</span> TransferTexture(TextureIm,np<span style="color:#f92672">.</span>zeros(IUV<span style="color:#f92672">.</span>shape),IUV)
    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>[<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">14</span>])
    image <span style="color:#f92672">=</span> TransferTexture(TextureIm,im,IUV)
    fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>[<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">14</span>])
    plt<span style="color:#f92672">.</span>imshow(image[:,:,::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
    plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
    plt<span style="color:#f92672">.</span>show()

    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">in</span> texture_img_name:
        texture_img_name <span style="color:#f92672">=</span> texture_img_name<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;/&#34;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]

    output_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;texture_transfer_&#34;</span> <span style="color:#f92672">+</span> photo_name[:<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;_&#34;</span> <span style="color:#f92672">+</span> texture_img_name[:<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.png&#34;</span>
    plt<span style="color:#f92672">.</span>savefig(<span style="color:#e6db74">&#34;/content/&#34;</span> <span style="color:#f92672">+</span> output_file)
    <span style="color:#66d9ef">return</span> output_file
</code></pre></div></div></details>
<h3 id="3-getting-instagram-images-with-selenium">3. Getting instagram images with Selenium</h3>
<p>Since instagram is made by react and rendered by js, you cannot normally scrape html. Therefore, render the DOM with <code>Selenium</code> and then get the image. After that, read the image with OpenCV and save it as a texture image.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/198787/54e86521-71fe-40e8-6908-21bcf859e1ab.png" alt="image.png"><sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup></p>
<blockquote>
<p>Addendum: At present, scraping with Chrome Driver on Colab may not work well, so it may be better to acquire images from instagram locally. In that case, please execute get_instagram_images.py on github.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$python get_instagram_images.py
put your instagram user name:watanabenaomi703
Now downloading picture 0...
Now downloading picture 1...
Now downloading picture 2...
</code></pre></div><details><summary>Instagram image URL acquisition and texture image generation</summary><div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> cv2
<span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
<span style="color:#f92672">from</span> selenium <span style="color:#f92672">import</span> webdriver
<span style="color:#f92672">from</span> selenium.webdriver.chrome.options <span style="color:#f92672">import</span> Options


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">url_to_image</span>(url):
    <span style="color:#75715e"># download the image, convert it to a NumPy array, and then read</span>
    <span style="color:#75715e"># it into OpenCV format</span>
    resp <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
    image <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>asarray(bytearray(resp<span style="color:#f92672">.</span>content), dtype<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;uint8&#34;</span>)image <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imdecode(image, cv2<span style="color:#f92672">.</span>IMREAD_COLOR)
    <span style="color:#75715e"># return the image</span>
    <span style="color:#66d9ef">return</span> image


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_instagram</span>(user_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;atsuya_jg43yr&#34;</span>):

    url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://www.instagram.com/{}/&#34;</span><span style="color:#f92672">.</span>format(user_id)

    options <span style="color:#f92672">=</span> Options()
    options<span style="color:#f92672">.</span>set_headless(True)
    driver <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Chrome(chrome_options<span style="color:#f92672">=</span>options, executable_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;./chromedriver&#39;</span>)
    driver<span style="color:#f92672">.</span>get(url)
    html <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>page_source<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
    soup <span style="color:#f92672">=</span> BeautifulSoup(html, <span style="color:#e6db74">&#34;lxml&#34;</span>)
    res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)

    img_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
    tile <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros([<span style="color:#ae81ff">200</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">200</span><span style="color:#f92672">*</span><span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">3</span>])  <span style="color:#75715e"># 4 x 6</span>

    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range((<span style="color:#ae81ff">4</span><span style="color:#f92672">*</span><span style="color:#ae81ff">6</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>):  <span style="color:#75715e"># get 22 (2x2) shape images</span>
        row_idx <span style="color:#f92672">=</span> i <span style="color:#f92672">//</span> <span style="color:#ae81ff">6</span>
        col_idx <span style="color:#f92672">=</span> i <span style="color:#f92672">%</span> <span style="color:#ae81ff">6</span>
        img <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>resize(url_to_image(pathes[i]), (<span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">200</span>))
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Now downloading picture {}...&#34;</span><span style="color:#f92672">.</span>format(i))
        tile[<span style="color:#ae81ff">200</span><span style="color:#f92672">*</span>row_idx:<span style="color:#ae81ff">200</span><span style="color:#f92672">*</span>(row_idx<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>),
               <span style="color:#ae81ff">200</span><span style="color:#f92672">*</span>col_idx:<span style="color:#ae81ff">200</span><span style="color:#f92672">*</span>(col_idx<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>), :] <span style="color:#f92672">=</span> img

    tile <span style="color:#f92672">=</span> tile<span style="color:#f92672">.</span>transpose(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>)
    fname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sample_texture.png&#34;</span>
    cv2<span style="color:#f92672">.</span>imwrite(fname, tile)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Saved your img file for Texture: {}&#34;</span><span style="color:#f92672">.</span>format(fname))
    <span style="color:#66d9ef">return</span> fname
</code></pre></div></div></details>
<h3 id="4colab上での写真撮影">4.Colab上での写真撮影</h3>
<p>Colab上にDOMを生成することでWebカメラから写真撮影をします。</p>
<details><summary>Colab上でのWebカメラ利用</summary><div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">take_photo</span>(filename<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;image.jpg&#39;</span>, quality<span style="color:#f92672">=</span><span style="color:#ae81ff">0.9</span>):
    js <span style="color:#f92672">=</span> Javascript(
<span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">async function takePhoto(quality) {
</span><span style="color:#e6db74">    const div = document.createElement(&#39;div&#39;);
</span><span style="color:#e6db74">    const capture = document.createElement(&#39;button&#39;);
</span><span style="color:#e6db74">    capture.textContent = &#39;写真をとるよ！&#39;;
</span><span style="color:#e6db74">    div.appendChild(capture);
</span><span style="color:#e6db74">    const video = document.createElement(&#39;video&#39;);
</span><span style="color:#e6db74">    video.style.display = &#39;block&#39;;
</span><span style="color:#e6db74">    const stream = await navigator.mediaDevices.getUserMedia({video: true});
</span><span style="color:#e6db74">    document.body.appendChild(div);
</span><span style="color:#e6db74">    div.appendChild(video);
</span><span style="color:#e6db74">    video.srcObject = stream;
</span><span style="color:#e6db74">    await video.play();
</span><span style="color:#e6db74">    /*
</span><span style="color:#e6db74">    Resize the output to fit the video 
</span><span style="color:#e6db74">    element.google.colab.output.setIframeHeight(document.documentElement.scrollHeight, true);
</span><span style="color:#e6db74">    Wait for Capture to be 
</span><span style="color:#e6db74">      clicked.await new Promise((resolve) =&gt; capture.onclick = resolve);
</span><span style="color:#e6db74">      const canvas = document.createElement(&#39;canvas&#39;);
</span><span style="color:#e6db74">      canvas.width = video.videoWidth;
</span><span style="color:#e6db74">      canvas.height = video.videoHeight;
</span><span style="color:#e6db74">      canvas.getContext(&#39;2d&#39;).drawImage(video, 0, 0);
</span><span style="color:#e6db74">      stream.getVideoTracks()[0].stop();
</span><span style="color:#e6db74">      div.remove();
</span><span style="color:#e6db74">      return canvas.toDataURL(&#39;image/jpeg&#39;, quality);}
</span><span style="color:#e6db74">    */
</span><span style="color:#e6db74">  &#39;&#39;&#39;</span>)
    display(js)
    data <span style="color:#f92672">=</span> eval_js(<span style="color:#e6db74">&#39;takePhoto({})&#39;</span><span style="color:#f92672">.</span>format(quality))
    binary <span style="color:#f92672">=</span> b64decode(data<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;,&#39;</span>)[<span style="color:#ae81ff">1</span>])
    <span style="color:#66d9ef">with</span> open(filename, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> f:
        f<span style="color:#f92672">.</span>write(binary)
    <span style="color:#66d9ef">return</span> filename
</code></pre></div></div></details>
<h3 id="5開発環境-on-google-colab">5.開発環境 on Google Colab</h3>
<p><a href="https://colab.research.google.com/drive/1qPx3D2dXl_cpTk7Zr5AxyZkcMbeJxFEw"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a></p>
<p>以上で紹介したスクリプト（セル）は，下記のセルを事前に実行して環境を建てることで実行できます。</p>
<p>本作品は、すべてGoogle Colaboratory<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>で作られているので、誰でも試せます！是非、ご自身のPCでも遊んでみてください。</p>
<p>また私(@jg43yr)のGitHub上でソースコードを公開しています（<a href="https://github.com/atsukoba/MemoryBody">GitHub: atsukoba/MemoryBody</a>）ので、バグ報告や追加機能から感想まで、なんでもissueお待ちしています。</p>
<p><code>!</code>マジックコマンドを駆使しconda2環境から建てていきます。ちなみに，Colabは20年1月でPython2のカーネルのサポート終了とのことです。</p>
<details><summary>conda2環境のインストール用スクリプトセル</summary><div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> os
<span style="color:#f92672">from</span> os.path <span style="color:#f92672">import</span> exists, join, basename, splitext

<span style="color:#75715e"># install Anaconda Python 2.7 to control the dependencies</span>
<span style="color:#75715e"># see for more info: </span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> exists(<span style="color:#e6db74">&#39;anaconda2&#39;</span>):
  <span style="color:#960050;background-color:#1e0010">!</span>wget <span style="color:#f92672">-</span>q https:<span style="color:#f92672">//</span>repo<span style="color:#f92672">.</span>anaconda<span style="color:#f92672">.</span>com<span style="color:#f92672">/</span>archive<span style="color:#f92672">/</span>Anaconda2<span style="color:#f92672">-</span><span style="color:#ae81ff">2019.03</span><span style="color:#f92672">-</span>Linux<span style="color:#f92672">-</span>x86_64<span style="color:#f92672">.</span>sh
  <span style="color:#960050;background-color:#1e0010">!</span>chmod <span style="color:#f92672">+</span>x Anaconda2<span style="color:#f92672">-</span><span style="color:#ae81ff">2019.03</span><span style="color:#f92672">-</span>Linux<span style="color:#f92672">-</span>x86_64<span style="color:#f92672">.</span>sh
  <span style="color:#960050;background-color:#1e0010">!</span>bash <span style="color:#f92672">./</span>Anaconda2<span style="color:#f92672">-</span><span style="color:#ae81ff">2019.03</span><span style="color:#f92672">-</span>Linux<span style="color:#f92672">-</span>x86_64<span style="color:#f92672">.</span>sh <span style="color:#f92672">-</span>b <span style="color:#f92672">-</span>f <span style="color:#f92672">-</span>p <span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>anaconda2
  <span style="color:#75715e"># set PATH environment variable</span>
  os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;PATH&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/content/anaconda2/bin:&#34;</span> <span style="color:#f92672">+</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;PATH&#39;</span>]
  <span style="color:#75715e"># install PyTorch</span>
  <span style="color:#960050;background-color:#1e0010">!</span>conda install <span style="color:#f92672">-</span>y pyyaml<span style="color:#f92672">=</span><span style="color:#ae81ff">3.12</span>
  <span style="color:#960050;background-color:#1e0010">!</span>conda install <span style="color:#f92672">-</span>y mkl<span style="color:#f92672">-</span>include
  <span style="color:#960050;background-color:#1e0010">!</span>conda install <span style="color:#f92672">-</span>y pytorch<span style="color:#f92672">=</span><span style="color:#ae81ff">1.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span> torchvision cudatoolkit<span style="color:#f92672">=</span><span style="color:#ae81ff">10.0</span> <span style="color:#f92672">-</span>c pytorch
  <span style="color:#960050;background-color:#1e0010">!</span>ln <span style="color:#f92672">-</span>s <span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>anaconda2<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python2<span style="color:#f92672">.</span><span style="color:#ae81ff">7</span><span style="color:#f92672">/</span>site<span style="color:#f92672">-</span>packages<span style="color:#f92672">/</span>torch<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span> <span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>anaconda2<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python2<span style="color:#f92672">.</span><span style="color:#ae81ff">7</span><span style="color:#f92672">/</span>site<span style="color:#f92672">-</span>packages<span style="color:#f92672">/</span>
  <span style="color:#75715e"># install GCC 4.9</span>
  <span style="color:#960050;background-color:#1e0010">!</span>conda install <span style="color:#f92672">-</span>y <span style="color:#f92672">-</span>c serge<span style="color:#f92672">-</span>sans<span style="color:#f92672">-</span>paille gcc_49
  <span style="color:#960050;background-color:#1e0010">!</span>ln <span style="color:#f92672">-</span>fs <span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>anaconda2<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libmpfr<span style="color:#f92672">.</span>so <span style="color:#f92672">/</span>content<span style="color:#f92672">/</span>anaconda2<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>libmpfr<span style="color:#f92672">.</span>so<span style="color:#f92672">.</span><span style="color:#ae81ff">4</span>
  os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;CC&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/content/anaconda2/bin/gcc-4.9&#39;</span>
  os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;CXX&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/content/anaconda2/bin/g++-4.9&#39;</span>
  <span style="color:#75715e"># protobuf 3.5</span>
  <span style="color:#75715e">#!apt-get -qq remove -y protobuf-compiler</span>
  <span style="color:#960050;background-color:#1e0010">!</span>conda install <span style="color:#f92672">-</span>y protobuf<span style="color:#f92672">=</span><span style="color:#ae81ff">3.5</span>
  <span style="color:#75715e"># pycocotools</span>
  <span style="color:#960050;background-color:#1e0010">!</span>conda install <span style="color:#f92672">-</span>y <span style="color:#f92672">-</span>c conda<span style="color:#f92672">-</span>forge pycocotools

<span style="color:#960050;background-color:#1e0010">!</span>conda install <span style="color:#f92672">-</span>y <span style="color:#f92672">-</span>c conda<span style="color:#f92672">-</span>forge selenium
<span style="color:#960050;background-color:#1e0010">!</span>conda install <span style="color:#f92672">-</span>y <span style="color:#f92672">-</span>c conda<span style="color:#f92672">-</span>forge bs4
  
<span style="color:#75715e"># we need some headers from the pytorch source</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> exists(<span style="color:#e6db74">&#39;pytorch&#39;</span>):
  <span style="color:#960050;background-color:#1e0010">!</span>git clone <span style="color:#f92672">-</span>q <span style="color:#f92672">--</span>depth <span style="color:#ae81ff">1</span> <span style="color:#f92672">--</span>recursive <span style="color:#f92672">-</span>b v1<span style="color:#f92672">.</span><span style="color:#ae81ff">0.1</span> https:<span style="color:#f92672">//</span>github<span style="color:#f92672">.</span>com<span style="color:#f92672">/</span>pytorch<span style="color:#f92672">/</span>pytorch

git_repo_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://github.com/facebookresearch/DensePose.git&#39;</span>
project_name <span style="color:#f92672">=</span> splitext(basename(git_repo_url))[<span style="color:#ae81ff">0</span>]
<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> exists(project_name):
  <span style="color:#75715e"># clone project</span>
  <span style="color:#960050;background-color:#1e0010">!</span>git clone <span style="color:#f92672">-</span>q <span style="color:#f92672">--</span>depth <span style="color:#ae81ff">1</span> <span style="color:#960050;background-color:#1e0010">$</span>git_repo_url
  <span style="color:#75715e"># install dependencies</span>
  <span style="color:#960050;background-color:#1e0010">!</span>cd <span style="color:#960050;background-color:#1e0010">$</span>project_name <span style="color:#f92672">&amp;&amp;</span> pip install <span style="color:#f92672">-</span>q <span style="color:#f92672">-</span>r requirements<span style="color:#f92672">.</span>txt
  <span style="color:#75715e"># update CMakeLists.txt</span>
  cmakelists_txt_content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">cmake_minimum_required(VERSION 2.8.12 FATAL_ERROR)
</span><span style="color:#e6db74">set(Caffe2_DIR &#34;/content/anaconda2/lib/python2.7/site-packages/torch/share/cmake/Caffe2/&#34;)find_package(Caffe2 REQUIRED)
</span><span style="color:#e6db74">include_directories(&#34;/content/anaconda2/lib/python2.7/site-packages/torch/lib/include&#34;)
</span><span style="color:#e6db74">include_directories(&#34;/content/anaconda2/include&#34;)
</span><span style="color:#e6db74">include_directories(&#34;/content/pytorch&#34;)
</span><span style="color:#e6db74">add_library(libprotobuf STATIC IMPORTED)
</span><span style="color:#e6db74">set(PROTOBUF_LIB &#34;/content/anaconda2/lib/libprotobuf.a&#34;)
</span><span style="color:#e6db74">set_property(TARGET libprotobuf PROPERTY IMPORTED_LOCATION &#34;${PROTOBUF_LIB}&#34;)
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">if (${CAFFE2_VERSION} VERSION_LESS 0.8.2)
</span><span style="color:#e6db74">  # Pre-0.8.2 caffe2 does not have proper interface libraries set up, so we
</span><span style="color:#e6db74">  # will rely on the old path.
</span><span style="color:#e6db74">  message(WARNING
</span><span style="color:#e6db74">      &#34;You are using an older version of Caffe2 (version &#34; ${CAFFE2_VERSION}
</span><span style="color:#e6db74">      &#34;). Please consider moving to a newer version.&#34;)
</span><span style="color:#e6db74">  include(cmake/legacy/legacymake.cmake)
</span><span style="color:#e6db74">  return()
</span><span style="color:#e6db74">endif()
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"># Add compiler flags.
</span><span style="color:#e6db74">set(CMAKE_C_FLAGS &#34;${CMAKE_C_FLAGS} -std=c11&#34;)
</span><span style="color:#e6db74">set(CMAKE_CXX_FLAGS &#34;${CMAKE_CXX_FLAGS} -std=c++11 -O2 -fPIC -Wno-narrowing&#34;)
</span><span style="color:#e6db74"># Print configuration summary.
</span><span style="color:#e6db74">include(cmake/Summary.cmake)
</span><span style="color:#e6db74">detectron_print_config_summary()
</span><span style="color:#e6db74"># Collect custom ops sources.
</span><span style="color:#e6db74">file(GLOB CUSTOM_OPS_CPU_SRCS ${CMAKE_CURRENT_SOURCE_DIR}/detectron/ops/*.cc)
</span><span style="color:#e6db74">file(GLOB CUSTOM_OPS_GPU_SRCS ${CMAKE_CURRENT_SOURCE_DIR}/detectron/ops/*.cu)
</span><span style="color:#e6db74"># Install custom CPU ops lib.
</span><span style="color:#e6db74">add_library(
</span><span style="color:#e6db74">     caffe2_detectron_custom_ops SHARED
</span><span style="color:#e6db74">     ${CUSTOM_OPS_CPU_SRCS})
</span><span style="color:#e6db74">target_link_libraries(caffe2_detectron_custom_ops caffe2_library libprotobuf)
</span><span style="color:#e6db74">install(TARGETS caffe2_detectron_custom_ops DESTINATION lib)
</span><span style="color:#e6db74"># Install custom GPU ops lib, if gpu is present.
</span><span style="color:#e6db74">if (CAFFE2_USE_CUDA OR CAFFE2_FOUND_CUDA)
</span><span style="color:#e6db74">  # Additional -I prefix is required for CMake versions before commit (&lt; 3.7):
</span><span style="color:#e6db74">  # https://github.com/Kitware/CMake/commit/7ded655f7ba82ea72a82d0555449f2df5ef38594
</span><span style="color:#e6db74">  list(APPEND CUDA_INCLUDE_DIRS -I${CAFFE2_INCLUDE_DIRS})
</span><span style="color:#e6db74">  CUDA_ADD_LIBRARY(
</span><span style="color:#e6db74">      caffe2_detectron_custom_ops_gpu SHARED
</span><span style="color:#e6db74">      ${CUSTOM_OPS_CPU_SRCS}
</span><span style="color:#e6db74">      ${CUSTOM_OPS_GPU_SRCS})
</span><span style="color:#e6db74">  target_link_libraries(caffe2_detectron_custom_ops_gpu caffe2_gpu_library libprotobuf)
</span><span style="color:#e6db74">  install(TARGETS caffe2_detectron_custom_ops_gpu DESTINATION lib)
</span><span style="color:#e6db74">endif()
</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
  open(join(project_name, <span style="color:#e6db74">&#39;CMakeLists.txt&#39;</span>), <span style="color:#e6db74">&#39;w&#39;</span>)<span style="color:#f92672">.</span>write(cmakelists_txt_content)
  <span style="color:#75715e"># build</span>
  <span style="color:#960050;background-color:#1e0010">!</span>cd <span style="color:#960050;background-color:#1e0010">$</span>project_name <span style="color:#f92672">&amp;&amp;</span> make
  <span style="color:#960050;background-color:#1e0010">!</span>cd <span style="color:#960050;background-color:#1e0010">$</span>project_name <span style="color:#f92672">&amp;&amp;</span> make ops
  <span style="color:#75715e"># download dense pose data</span>
  <span style="color:#960050;background-color:#1e0010">!</span>cd <span style="color:#960050;background-color:#1e0010">$</span>project_name<span style="color:#f92672">/</span>DensePoseData <span style="color:#f92672">&amp;&amp;</span> bash get_densepose_uv<span style="color:#f92672">.</span>sh
 
<span style="color:#960050;background-color:#1e0010">!</span>python2 <span style="color:#960050;background-color:#1e0010">$</span>project_name<span style="color:#f92672">/</span>detectron<span style="color:#f92672">/</span>tests<span style="color:#f92672">/</span>test_spatial_narrow_as_op<span style="color:#f92672">.</span>py
<span style="color:#960050;background-color:#1e0010">!</span>python2 <span style="color:#960050;background-color:#1e0010">$</span>project_name<span style="color:#f92672">/</span>detectron<span style="color:#f92672">/</span>tests<span style="color:#f92672">/</span>test_zero_even_op<span style="color:#f92672">.</span>py
<span style="color:#960050;background-color:#1e0010">!</span>wget https:<span style="color:#f92672">//</span>chromedriver<span style="color:#f92672">.</span>storage<span style="color:#f92672">.</span>googleapis<span style="color:#f92672">.</span>com<span style="color:#f92672">/</span><span style="color:#ae81ff">77.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">3865.10</span><span style="color:#f92672">/</span>chromedriver_linux64<span style="color:#f92672">.</span>zip
<span style="color:#960050;background-color:#1e0010">!</span>unzip chromedriver_linux64<span style="color:#f92672">.</span>zip
<span style="color:#960050;background-color:#1e0010">!</span>apt install chromium<span style="color:#f92672">-</span>chromedriver
<span style="color:#960050;background-color:#1e0010">!</span>cp <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>chromium<span style="color:#f92672">-</span>browser<span style="color:#f92672">/</span>chromedriver <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>bin
</code></pre></div></div><details>
<h2 id="おわりに">おわりに</h2>
<p>みなさんも、このようにPythonとかを書いて自信が面白いと思えるものをつくっていけたら良いのではないでしょうか。SFC生のみなさん，何か一緒に作りましょう！是非連絡お待ちしています！</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://www.instagram.com/watanabenaomi703/">https://www.instagram.com/watanabenaomi703/</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>ハッカソンの1日で実装したのでお許しを <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>GitHub READMEより画像引用 <a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p>びっくりした <a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5" role="doc-endnote">
<p>2019年8月時点の@watanabenaomi703のinstagram新着画像をテクスチャの形に並び替えたもの <a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6" role="doc-endnote">
<p>Googleのjupyter notebook型クラウド開発環境です。 <a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
