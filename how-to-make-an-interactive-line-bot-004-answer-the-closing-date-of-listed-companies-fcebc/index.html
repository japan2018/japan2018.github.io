<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://japan2018.github.io/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://japan2018.github.io/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://japan2018.github.io/favicon-16x16.png">

  
  <link rel="manifest" href="https://japan2018.github.io/site.webmanifest">

  
  <link rel="mask-icon" href="https://japan2018.github.io/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://japan2018.github.io/css/bootstrap.min.css" />

  
  <title>How to make an interactive LINE BOT 004 (answer the closing date of listed companies) | Some Title</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>How to make an interactive LINE BOT 004 (answer the closing date of listed companies)</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 4, 2019
  </small>
  

<small><code><a href="https://japan2018.github.io/tags/python">Python</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/scraping"> scraping</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/beautifulsoup"> BeautifulSoup</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/requests">Requests</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/linebot">linebot</a></code></small>

</p>
<pre><code>#Overview
</code></pre>
<p><a href="https://qiita.com/mahiroaug/items/1b8ca9f5dd605f6134e4">Last time</a>, I implemented the function to acquire stock price information, but as a real problem, &ldquo;I did not bother to ask BOT, I used the stock application It&rsquo;s only a matter of time before I get the tsukumi saying, ``It&rsquo;s more convenient&rsquo;&rsquo;, and I&rsquo;m probably using a certain portfolio management app on a daily basis without fail, so I would like BOT to pinpoint the stock price now. There is no need to have such a need.
So I went back to the starting point and asked myself what kind of function I wanted, and tried to find a more practical function.</p>
<p>&ldquo;Yes, it would be convenient if we could grasp the settlement (scheduled) date at once.&rdquo;</p>
<p>If you have a lot of stocks, it can be quite a hassle to keep track of the schedules for individual stocks, semi-annual accounts, quarterly accounts, etc. on a daily basis. It would be convenient if there was a function to collect and visualize these in a centralized manner, and above all, I think it would be good if BOT should be what it should be.</p>
<p>So, this time, I&rsquo;d like to go to the scraping technique for the purpose of strengthening the skill of extracting and analyzing information from the website in pinpoints.</p>
<p>##System configuration</p>
<p>When the startup code including the issue code is input from the LINE app (1), the BOT accesses the website and investigates the latest financial announcement (planned) date and responds (2).
It is also assumed that individual issues will be designated or portfolios will be set in advance and multiple issues will be acquired collectively.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/484220/11302562-8f91-f429-db32-c00101bd0374.png" alt="System configuration 004.png"></p>
<p>#1. Selection of target website</p>
<p>We will use the site <a href="https://kabuyoho.ifis.co.jp/">Stock forecast</a>.
When you open the page for an individual issue, the latest earnings announcement (planned) date is displayed in the position shown in the figure below.
If the financial results have been announced, that fact will be displayed with the date,
If it is going to be announced, it will be displayed with the date as the scheduled announcement date.
The HTML source corresponding to this position is the <code>&quot;header_main&quot;</code> class starting on line 222.
You can see that all the information you want is included under this subordinate.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/484220/b97d893d-3dc8-1edf-1878-f0a9776c4bbf.png" alt="HTML BODY.png"></p>
<p>Therefore, this mission is likely to be realized by understanding the skills of the following three processes.</p>
<ol>
<li>Get the HTML source</li>
<li>Parsing and extracting the <code>&lt;div class=&quot;header_main&quot;&gt;</code> tag</li>
<li>String formatting</li>
</ol>
<p>So, if you write the conclusion first
About 1.<code>requests</code>
About 2. <code>BeautifulSoup</code>
About 3.<code>re</code>
By utilizing each, very smart coding is realized.</p>
<p>Acquiring HTML source by #2.requests</p>
<p>Requests are already packaged when the chatbot is implemented, so details are omitted.
The coding example is as follows</p>
<pre><code class="language-python:" data-lang="python:">(botenv2) [botenv2]$ python
Python 3.6.7 (default, Dec 5 2018, 15:02:16)
&gt;&gt;&gt; import requests

#Get HTML source
&gt;&gt;&gt; r = requests.get('https://kabuyoho.ifis.co.jp/index.php?action=tp1&amp;sa=report_top&amp;bcode=4689')

#Content confirmation
&gt;&gt;&gt; print(r.headers)
{'Cache-Control':'max-age=1','Content-Encoding':'gzip','Content-Type':'text/html; charset=UTF-8', (omitted)
&gt;&gt;&gt; print(r.encoding)
UTF-8
&gt;&gt;&gt; print(r.content)
(Omitted)
</code></pre><p>I don&rsquo;t need any special explanation.
Since the whole Body part is stored in r.content, it will be boiled or baked later,
You can pull the information using the target HTML tag as a key.</p>
<p>#3.Introduction of Beautiful Soup (Parser)</p>
<p>It seems that the famous package already implements various parsers.
When I introduced it, I was able to achieve 90% of the objectives this time. ..
Compared to the times when the C language was used to flirting, it feels like a distant world.</p>
<pre><code class="language-bash:BeautifulSoup" data-lang="bash:BeautifulSoup">(botenv2) [botenv2]$ pip install BeautifulSoup4
</code></pre><pre><code class="language-python:" data-lang="python:">&gt;&gt;&gt; from bs4 import BeautifulSoup

#Body part is analyzed by parser
&gt;&gt;&gt; soup = BeautifulSoup(r.content, &quot;html.parser&quot;)
</code></pre><p>Try to display the header_main class.</p>
<pre><code class="language-python:" data-lang="python:">&gt;&gt;&gt; print(soup.find(&quot;div&quot;, class_=&quot;header_main&quot;))
</code></pre><pre><code class="language-html:" data-lang="html:">
&lt;div class=&quot;header_main&quot;&gt;
&lt;div class=&quot;stock_code left&quot;&gt;4689&lt;/div&gt;
&lt;div class=&quot;stock_name left&quot;&gt;Z Holdings&lt;/div&gt;
&lt;div class=&quot;block_update right&quot;&gt;
&lt;div class=&quot;title left&quot;&gt;
                                                                        Financial results announced
                                                        &lt;/div&gt;
&lt;div class=&quot;settle left&quot;&gt;
                                                                        2Q
                                                        &lt;/div&gt;
&lt;div class=&quot;date left&quot;&gt;
                                                                                                   2019/11/01
                                                                                                &lt;/div&gt;
&lt;div class=&quot;float_end&quot;&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;float_end&quot;&gt;&lt;/div&gt;
&lt;/div&gt;
</code></pre><p>Wow. It&rsquo;s too convenient and the quiver doesn&rsquo;t stop.</p>
<p>#3. String formatting</p>
<p>All that remains is to delete unnecessary strings.
Use the text method because HTML tags are not required.</p>
<pre><code class="language-python:" data-lang="python:">&gt;&gt;&gt; s = soup.find(&quot;div&quot;, class_=&quot;header_main&quot;).text
&gt;&gt;&gt; print(s)
4689
Z Holdings


                                                                        Financial results announced
                                                 

                                                                        2Q
                                                 

                                                                                                   2019/11/01
                                                                                         




&gt;&gt;&gt;
</code></pre><p>The tags have been wiped out, but there are still many mysterious gaps.
I didn&rsquo;t know if this was a space or a metacharacter, so I was addicted to it for a moment.
In such a case, you can see the substance by displaying it as a byte type.</p>
<pre><code class="language-python:" data-lang="python:">&gt;&gt;&gt; s.encode()
b'\n4689\n\xef\xbc\xba\xe3\x83\x9b\xe3\x83\xbc\xe3\x83\xab\xe3\x83\x87\xe3\x82\xa3\xe3\x83\xb3\xe3 \x82\xb0\xe3\x82\xb9\n\n\n\t\t\t\t\t\t\t\t\t\xe6\xb1\xba\xe7\xae\x97\xe7\x99 \xba\xe8\xa1\xa8\xe6\xb8\x88\n\t\t\t\t\t\t\t\n\n\t\t\t\t\t\t\t\t \t2Q\n\t\t\t\t\t\t\t\n\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t \t2019/11/01\n\t\t\t\t\t\t\t\t\t\t\t\t\n\n\n\n'
</code></pre><p>The point is to remove /n and /t.
Replace it with a comma without mercy and bury it.</p>
<pre><code class="language-python:" data-lang="python:">&gt;&gt;&gt; import re
&gt;&gt;&gt; s = re.sub(r'[\n\t]+',',', s)
&gt;&gt;&gt; print(s)
,4689,Z Holdings,Financial results announced,2Q,2019/11/01,
</code></pre><p>If you remove the annoying commas before and after to finish</p>
<pre><code class="language-python:" data-lang="python:">&gt;&gt;&gt; s = re.sub(r'(^,)|(,$)','', s)
&gt;&gt;&gt; print(s)
4689, Z Holdings, Financial results announced, 2Q, 2019/11/01
</code></pre><p>It feels good. It seems that it can be converted to CSV or dataframe as it is.</p>
<p>By the way, when the stock code that does not exist is obtained, the following character code remains after the above processing.</p>
<pre><code class="language-python:" data-lang="python:">&gt;&gt;&gt; print(s)
b'\xc2\xa0'
</code></pre><p>This <code>\xc2\xa0</code> means NO-BREAK SPACE in Unicode, which is equivalent to <code>&amp;nbsp</code> in HTML.
If this character code is still included, it hinders subsequent processing, so it is desirable to remove it if possible.
(It seems to be a common problem when scraping web pages.)&gt; (Reference) <a href="https://tech-knygt51.com/python-xa0-deal/">[Python3] What to do when you encounter [\xa0] while scraping</a></p>
<pre><code class="language-Remove" data-lang="Remove">s = re.sub(r'[\xc2\xa0]','', s)
</code></pre><p>#4. Implemented in BOT app</p>
<p>Here is a functionalized version of the above process.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:getSettledata.py" data-lang="python:getSettledata.py"><span style="color:#f92672">import</span> requests
<span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
<span style="color:#f92672">import</span> re
<span style="color:#f92672">import</span> logging
logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#39;getSettledata&#39;</span>)

source <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://kabuyoho.ifis.co.jp/index.php?action=tp1&amp;sa=report_top&amp;bcode=&#39;</span>

<span style="color:#75715e"># Closing date acquisition function (If the argument is empty, refer to the data of 4689(ZHD))</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_settleInfo</span>(code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;4689&#34;</span>):

  <span style="color:#75715e">#Crawling</span>
  <span style="color:#66d9ef">try</span>:
    logger<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#39;read web data cord =&#39;</span><span style="color:#f92672">+</span> code) <span style="color:#75715e">#logging</span>
    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(source <span style="color:#f92672">+</span> code)
  <span style="color:#66d9ef">except</span>:
    logger<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#39;read web data ---&gt; Exception Error&#39;</span>) <span style="color:#75715e">#logging</span>
    <span style="color:#66d9ef">return</span> None,<span style="color:#e6db74">&#39;Exception error: access failed&#39;</span>

  <span style="color:#75715e">#Scraping</span>
  soup <span style="color:#f92672">=</span> BeautifulSoup(r<span style="color:#f92672">.</span>content, <span style="color:#e6db74">&#34;html.parser&#34;</span>)
  settleInfo <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#34;div&#34;</span>, class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;header_main&#34;</span>)<span style="color:#f92672">.</span>text
  settleInfo <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>sub(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;[\n\t]+&#39;</span>,<span style="color:#e6db74">&#39;,&#39;</span>, settleInfo) <span style="color:#75715e"># remove meta characters</span>
  settleInfo <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>sub(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;(^,)|(,$)&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>, settleInfo) <span style="color:#75715e"># Comma removal at beginning and end of line</span>
  settleInfo <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>sub(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;[\xc2\xa0]&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>, settleInfo) <span style="color:#75715e">#&amp;nbsp(\xc2\xa0) Corrective action</span>
  logger<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#39;settleInfo result =&#39;</span><span style="color:#f92672">+</span> settleInfo) <span style="color:#75715e">#logging</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> settleInfo:
    settleInfo <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;No such brand~&#34;</span>

  <span style="color:#66d9ef">return</span> settleInfo

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span><span style="color:#e6db74">&#39;__main__&#39;</span>:
  <span style="color:#66d9ef">print</span>(get_settleInfo())
</code></pre></div><p>For the main program, add conditional branch processing by identifying the activation code as usual.
By creating your own portfolio in <code>SETTLEVIEW_LIST_CORD</code> in advance, it will be the target of batch acquisition.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:chatbot.py" data-lang="python:chatbot.py"><span style="color:#75715e"># -*- Coding: utf-8 -*-</span>

<span style="color:#f92672">from</span> django.views.decorators.csrf <span style="color:#f92672">import</span> csrf_exempt
<span style="color:#f92672">from</span> django.http <span style="color:#f92672">import</span> HttpResponse
<span style="color:#f92672">from</span> django.shortcuts <span style="color:#f92672">import</span> render
<span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
<span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> json
<span style="color:#f92672">import</span> base64
<span style="color:#f92672">import</span> logging
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> random
<span style="color:#f92672">import</span> log.logconfig
<span style="color:#f92672">from</span> utils <span style="color:#f92672">import</span> tools
<span style="color:#f92672">import</span> re
<span style="color:#f92672">from</span> .getStockdata <span style="color:#f92672">import</span> get_chart
<span style="color:#f92672">from</span> .getSettledata <span style="color:#f92672">import</span> get_settleInfo

logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#39;commonLogging&#39;</span>)

LINE_ENDPOINT <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://api.line.me/v2/bot/message/reply&#39;</span>
LINE_ACCESS_TOKEN <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>

<span style="color:#75715e">###</span>
<span style="color:#75715e">###</span>
<span style="color:#75715e">###</span>

SETTLEVIEW_KEY <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;final settlement&#39;</span>,<span style="color:#e6db74">&#39;settle&#39;</span>] <span style="color:#75715e">#★ Added</span>
SETTLEVIEW_LIST_KEY <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;Financial Results List&#39;</span>] <span style="color:#75715e">#★ Added</span>
SETTLEVIEW_LIST_CORD <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;4689&#39;</span>,<span style="color:#e6db74">&#39;3938&#39;</span>,<span style="color:#e6db74">&#39;4755&#39;</span>,<span style="color:#e6db74">&#39;1435&#39;</span>,<span style="color:#e6db74">&#39;3244&#39;</span>,<span style="color:#e6db74">&#39;3048&#39;</span>] <span style="color:#75715e"># ★Added</span>

<span style="color:#a6e22e">@csrf_exempt</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">line_handler</span>(request):

    <span style="color:#75715e">#exception</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span><span style="color:#e6db74">&#39;POST&#39;</span>:
      <span style="color:#66d9ef">return</span> HttpResponse(status<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>)

    logger<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#39;line_handler message incoming&#39;</span>) <span style="color:#75715e">#logging</span>
    out_log <span style="color:#f92672">=</span> tools<span style="color:#f92672">.</span>outputLog_line_request(request) <span style="color:#75715e">#logging</span>
    request_json <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(request<span style="color:#f92672">.</span>body<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))

    <span style="color:#66d9ef">for</span> event <span style="color:#f92672">in</span> request_json[<span style="color:#e6db74">&#39;events&#39;</span>]:
      reply_token <span style="color:#f92672">=</span> event[<span style="color:#e6db74">&#39;replyToken&#39;</span>]
      message_type <span style="color:#f92672">=</span> event[<span style="color:#e6db74">&#39;message&#39;</span>][<span style="color:#e6db74">&#39;type&#39;</span>]
      user_id <span style="color:#f92672">=</span> event[<span style="color:#e6db74">&#39;source&#39;</span>][<span style="color:#e6db74">&#39;userId&#39;</span>]

      <span style="color:#75715e">#whitelist</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user_id <span style="color:#f92672">==</span> LINE_ALLOW_USER:
        logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">&#39;invalid userID:&#39;</span> <span style="color:#f92672">+</span> user_id) <span style="color:#75715e">#logging</span>
        <span style="color:#66d9ef">return</span> HttpResponse(status<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>)

      <span style="color:#75715e">#action</span>
      <span style="color:#66d9ef">if</span> message_type <span style="color:#f92672">==</span><span style="color:#e6db74">&#39;text&#39;</span>:
        <span style="color:#66d9ef">if</span>:
        <span style="color:#75715e">###</span>
        <span style="color:#75715e">###</span>
        <span style="color:#75715e">###</span>

        <span style="color:#66d9ef">elif</span> any(s <span style="color:#f92672">in</span> event[<span style="color:#e6db74">&#39;message&#39;</span>][<span style="color:#e6db74">&#39;text&#39;</span>] <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> SETTLEVIEW_KEY): <span style="color:#75715e">#★Added</span>
          action_data(reply_token,<span style="color:#e6db74">&#39;settleview&#39;</span>,event[<span style="color:#e6db74">&#39;message&#39;</span>][<span style="color:#e6db74">&#39;text&#39;</span>]) <span style="color:#75715e"># ★Added</span>

        <span style="color:#66d9ef">else</span>:
        <span style="color:#75715e">###</span>
        <span style="color:#75715e">###</span>
        <span style="color:#75715e">###</span>

    <span style="color:#66d9ef">return</span> HttpResponse(status<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">action_res</span>(reply_token,command,):
    <span style="color:#75715e">###</span>
    <span style="color:#75715e">###</span>
    <span style="color:#75715e">###</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">action_data</span>(reply_token,command,value):

    <span style="color:#75715e">#Stock chart</span>
    <span style="color:#75715e">###</span>
    <span style="color:#75715e">###</span>
    <span style="color:#75715e">###</span>

    <span style="color:#75715e">################################################## ##### ★Addition from here</span>
    <span style="color:#75715e">#Financial information</span>
    <span style="color:#66d9ef">elif</span> command <span style="color:#f92672">==</span><span style="color:#e6db74">&#39;settleview&#39;</span>:
      logger<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#39;get_settleInfo on&#39;</span>) <span style="color:#75715e">#logging</span>

      <span style="color:#75715e"># Collect all portfolio issues</span>
      <span style="color:#66d9ef">if</span> any(s <span style="color:#f92672">in</span> value <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> SETTLEVIEW_LIST_KEY):
        logger<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#39;get_settleInfo LIST&#39;</span>) <span style="color:#75715e">#logging</span>

        results <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> cord <span style="color:#f92672">in</span> SETTLEVIEW_LIST_CORD:
          results<span style="color:#f92672">.</span>append(get_settleInfo(cord))

        logger<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#39;get_settleInfo LIST ---&gt;&#39;</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(results)) <span style="color:#75715e">#logging</span>
        response_text(reply_token,<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(results))

      <span style="color:#75715e"># Individual issue acquisition</span>
      <span style="color:#66d9ef">else</span>:
        cord <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">&#39;[0-9]+$&#39;</span>, value)
        logger<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#39;get_settleInfo cord =&#39;</span><span style="color:#f92672">+</span> cord<span style="color:#f92672">.</span>group()) <span style="color:#75715e">#logging</span>

        result <span style="color:#f92672">=</span> get_settleInfo(cord<span style="color:#f92672">.</span>group())

        <span style="color:#66d9ef">if</span> result[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
          response_text(reply_token,result)
        <span style="color:#66d9ef">else</span>:
          response_text(reply_token,result[<span style="color:#ae81ff">1</span>])
    <span style="color:#75715e">################################################## ##### ★ Added here</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">response_image</span>(reply_token,orgUrl,preUrl,text):
    <span style="color:#75715e">###</span>
    <span style="color:#75715e">###</span>
    <span style="color:#75715e">###</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">response_text</span>(reply_token,text):
    payload <span style="color:#f92672">=</span> {
      <span style="color:#e6db74">&#34;replyToken&#34;</span>: reply_token,
      <span style="color:#e6db74">&#34;messages&#34;</span>:[
        {
          <span style="color:#e6db74">&#34;type&#34;</span>:<span style="color:#e6db74">&#39;text&#39;</span>,
          <span style="color:#e6db74">&#34;text&#34;</span>: text
        }
      ]
    }
    line_post(payload)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">line_post</span>(payload):
    url <span style="color:#f92672">=</span> LINE_ENDPOINT
    header <span style="color:#f92672">=</span> {
      <span style="color:#e6db74">&#34;Content-Type&#34;</span>: <span style="color:#e6db74">&#34;application/json&#34;</span>,
      <span style="color:#e6db74">&#34;Authorization&#34;</span>: <span style="color:#e6db74">&#34;Bearer &#34;</span><span style="color:#f92672">+</span> LINE_ACCESS_TOKEN
    }
    requests<span style="color:#f92672">.</span>post(url, headers<span style="color:#f92672">=</span>header, data<span style="color:#f92672">=</span>json<span style="color:#f92672">.</span>dumps(payload))
    out_log <span style="color:#f92672">=</span> tools<span style="color:#f92672">.</span>outputLog_line_response(payload) <span style="color:#75715e">#logging</span>
    logger<span style="color:#f92672">.</span>debug(<span style="color:#e6db74">&#39;line_handler message --&gt;reply&#39;</span>) <span style="color:#75715e">#logging</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ulocal_chatting</span>(event):
    <span style="color:#75715e">###</span>
    <span style="color:#75715e">###</span>
    <span style="color:#75715e">###</span>
</code></pre></div><p>Completed above.</p>
<pre><code class="language-start" data-lang="start">(botenv2) [line_bot]$ gunicorn --bind 127.0.0.1:8000 line_bot.wsgi:application
```If you drop a message according to the format from the LINE application, the result will be returned.

![sc003.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/484220/8450cc45-8d19-2f2e-f8b8-b94c7fcb153a.png)

If you want to get all at once, enter `final settlement list`.

![sc004.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/484220/a79003f7-c864-ca6d-bcde-1580a6453c4a.png)

Six brands are serially processed and measured in about 1 second. I was impressed that it was processed at a higher speed than I imagined, but I think that it will be annoying to the website so much, so I will use it moderately so as not to access it frequently.
Up to here for this time.</code></pre>
    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
