<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Christmas Classic (?) Lighting a Christmas Tree with Raspberry Pi and Philips Hue | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Christmas Classic (?) Lighting a Christmas Tree with Raspberry Pi and Philips Hue</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 24, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/raspberrypi">RaspberryPi</a></code></small>


<small><code><a href="https://memotut.com/tags/hue">Hue</a></code></small>


<small><code><a href="https://memotut.com/tags/philipshue">PhilipsHue</a></code></small>

</p>
<pre><code>&gt; This article is the 25th day article of [North Detail Advent Calendar 2019](https://qiita.com/advent-calendar/2019/northdetail).
</code></pre>
<blockquote>
<p>2020/04/02 Addendum
This article is also posted on the NorthDetail blog.
<a href="https://www.northdetail.co.jp/blog/455/">https://www.northdetail.co.jp/blog/455/</a></p>
</blockquote>
<p>Merry Christmas!
Advent Calendar is Christmas on the last day, and Speaking of Christmas, it&rsquo;s Razpai!</p>
<p>So, at the end of North Detail Advent Calendar 2019, I would like to make a mechanism to control the lights that illuminate the Christmas tree with Raspberry Pi.</p>
<ul>
<li>2018: <a href="https://www.indetail.co.jp/blog/181225/">https://www.indetail.co.jp/blog/181225/</a></li>
<li>2017: <a href="https://www.indetail.co.jp/blog/171225/">https://www.indetail.co.jp/blog/171225/</a></li>
</ul>
<h2 id="video">Video</h2>
<p><a href="https://youtu.be/3I9leFDmfEQ"><img src="http://img.youtube.com/vi/3I9leFDmfEQ/0.jpg" alt="Controlled Philips Hue by Raspberry Pi (with Gyroscope)"></a>
Click to watch the video on YouTube.</p>
<p>The sensor attached to the Raspberry Pi is shaken so that the light can be turned ON/OFF, and the brightness and hue can be adjusted by tilting.</p>
<h2 id="items">Items</h2>
<h3 id="raspberry-pi">Raspberry Pi</h3>
<ul>
<li><a href="https://www.switch-science.com/catalog/3646/">Raspberry Pi Zero WH</a>(linkisSwitchScience&rsquo;spage)</li>
</ul>
<h3 id="sensor">Sensor</h3>
<p>It is OK if you can prepare something that can detect tilt etc. I used this time.</p>
<ul>
<li><a href="https://bit-trade-one.co.jp/adrszgr/">ADRSZGR Zero One 9-axis sensor expansion board</a></li>
</ul>
<h3 id="hue">Hue</h3>
<h4 id="light">light</h4>
<p>This time, I used (finally) what I bought as a set before when I bought &ldquo;Echo Show&rdquo;.</p>
<ul>
<li><a href="https://www.amazon.co.jp/dp/B01MSITPT1">Philips Hue White Gradation Single Lamp (Light bulb color ~ Daylight color)</a>(linkisAmazon.co.jp&rsquo;spage)</li>
</ul>
<h4 id="bridge">bridge</h4>
<p>Use the bridge to connect Hue to your Raspberry Pi.</p>
<p>To be more precise, since the bridge is a web server, Hue can be controlled by making an HTTP request from the Raspberry Pi to the bridge.</p>
<ul>
<li><a href="https://www.amazon.co.jp/dp/B01C6S7DDA">Philips Hue Bridge</a>(linkisAmazon.co.jp&rsquo;spage)</li>
</ul>
<h3 id="other">Other</h3>
<ul>
<li>Light stand (can be equipped with an LED light)</li>
<li>Decoration for trees</li>
</ul>
<p>It is a common precaution for LED lights, but it differs from incandescent bulbs in that it mainly <em>heats</em>.</p>
<p>An incandescent light bulb has heat around the filament of the light emitting part, while an LED light has heat around the socket part.
Therefore, please use a stand with a structure that allows proper heat dissipation around the socket.</p>
<h2 id="hue-settings">Hue settings</h2>
<p>First, use the smartphone app to register the lights in the bridge.
Please work around here according to how to use the app.</p>
<p>After that, we will proceed on the assumption that the bridge, Raspberry Pi, and work PC are all on the same network.</p>
<h3 id="check-the-ip-address-of-the-bridge">Check the IP address of the bridge</h3>
<p>You will need to know the IP address as you will be making HTTP requests to the bridge.
This can be obtained by accessing the following address if the bridge is set correctly.</p>
<p><a href="https://discovery.meethue.com/">https://discovery.meethue.com/</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JSON" data-lang="JSON">[
  {
    <span style="color:#960050;background-color:#1e0010">id:</span> <span style="color:#f92672">&#34;XXXXXXXXXXXXXXXX&#34;</span>,
    <span style="color:#960050;background-color:#1e0010">internalipaddress:</span> <span style="color:#f92672">&#34;10.xxx.xxx.xxx&#34;</span>
  }
]
</code></pre></div><p>This <code>internalipaddress</code> will be the IP address of the currently connected network.
Make a note.</p>
<h3 id="user-registration-on-the-bridge">User registration on the bridge</h3>
<p>When operating from the Raspberry Pi, you need a unique user ID on the bridge.
After pressing the button (physical) on the bridge body, if you make an HTTP request in the following form, <code>username</code> is included in the response.
Make a note of this as it will be used in future HTTP requests.</p>
<p>By the way, <code>devicetype</code> can be freely set by yourself.</p>
<pre><code>POST http://`internalipaddress`/api

body: {&quot;devicetype&quot;:&quot;tacck_hue_app#raspi&quot;}
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-response.json" data-lang="response.json">[
  {
    <span style="color:#f92672">&#34;success&#34;</span>: {
      <span style="color:#f92672">&#34;username&#34;</span>: <span style="color:#e6db74">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
    }
  }
]
</code></pre></div><h3 id="get-light-id">Get Light ID</h3>
<p>Then, get the ID of the light registered in the bridge to operate the light.</p>
<pre><code>GET http://`internalipaddress`/api/`username`/lights
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-response.json" data-lang="response.json">{
  <span style="color:#f92672">&#34;1&#34;</span>:{<span style="color:#f92672">&#34;state&#34;</span>:{<span style="color:#f92672">&#34;on&#34;</span>:<span style="color:#66d9ef">false</span>,<span style="color:#f92672">&#34;bri&#34;</span>:<span style="color:#ae81ff">254</span>,<span style="color:#960050;background-color:#1e0010">...</span>}
}
</code></pre></div><p>A lot of information will be returned, but the first <code>&quot;1&quot;</code> will be the ID.</p>
<p>The light should come on when you make the HTTP request below.
(If you set <code>true</code> to <code>false</code>, it goes out.)</p>
<p>Replace <code>internalipaddress</code>, <code>username</code>, and <code>light_id</code> with your own.</p>
<pre><code>PUT http://`internalipaddress`/api/`username`/lights/`light_id`/state

body: {&quot;on&quot;:true}
</code></pre><h2 id="raspberry-pi-1">Raspberry Pi</h2>
<p>Next is the setting on the Raspberry Pi side.
For Raspberry Pi, it is assumed that Raspbian has already been started and WiFi can be used.
Also, it is assumed that the sensor (ADRSZGR) has already been connected to the Raspberry Pi body.</p>
<h3 id="sensor-1">Sensor</h3>
<p>First, check if the sensor value can be obtained.
The source code that is the base is provided here, so I will use it.</p>
<p>Base code
<a href="https://github.com/bit-trade-one/RasPi-Zero-One-Series/tree/master/3rd/ADRSZGR_9-Axis_Gyro">https://github.com/bit-trade-one/RasPi-Zero-One-Series/tree/master/3rd/ADRSZGR_9-Axis_Gyro</a></p>
<p>Let&rsquo;s run it on the Raspberry Pi.</p>
<pre><code>$ git clone https://github.com/bit-trade-one/RasPi-Zero-One-Series.git
$ cd RasPi-Zero-One-Series/3rd/ADRSZGR_9-Axis_Gyro
$python3 ADRSZGR_Sample.py
Do not move the sensor for 10 seconds
1 second left
Calibration completed
X:-0.045608688186813184 Y:0.7310804429945055 Z:-4.547119140625

2.7179718017578125e-05,0.01416015625,0.0185546875,1.0087890625,-0.045608688186813184,-0.12341174450549453,-0.152587890625,-14.843956043956045,6.447374847374848,-1.6493284493284492,
0.05398225784301758,0.0126953125,0.01513671875,1.00927734375,0.13749678056318682,0.059693724244505475,-0.213623046875,-16.193406593406593,6.297435897435897,-0.8996336996336997,
(Because the following continues, interrupt with Ctrl+C at an appropriate point.)
</code></pre><p>If the value comes out like this, it means that the sensor is working.</p>
<h3 id="implementation">Implementation</h3>
<p>Now, let&rsquo;s implement it by using the sensor value to operate the Hue light.
All the control of the sensor is done by <code>GYRO.py</code> in the base, so it&rsquo;s OK to consider only how to use the value.</p>
<p>This time, we will implement the design by turning the sensor on and off, and by tilting it, the brightness and color changes.</p>
<p>Copy the <code>ADRSZGR_Sample.py</code> used in the confirmation above as <code>index.py</code> and use it.
Also, I don&rsquo;t usually write Python, so I will implement it while paying attention to the valley of indentation <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</p>
<p>After adjusting variously, I calmed down with the following code.</p>
<pre><code>.
├── GYRO.py
└── index.py
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-index.py" data-lang="index.py"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>

<span style="color:#f92672">import</span> signal
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> GYRO

GYR_THRESHOLD <span style="color:#f92672">=</span> <span style="color:#ae81ff">200.0</span>

HUE_BRI_MIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
HUE_BRI_MAX <span style="color:#f92672">=</span> <span style="color:#ae81ff">254</span>
HUE_BRI_HALF <span style="color:#f92672">=</span> round((HUE_BRI_MAX<span style="color:#f92672">-</span>HUE_BRI_MIN <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>)
HUE_CT_MIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">153</span>
HUE_CT_MAX <span style="color:#f92672">=</span> <span style="color:#ae81ff">454</span>
HUE_CT_HALF <span style="color:#f92672">=</span> round((HUE_CT_MAX<span style="color:#f92672">-</span>HUE_CT_MIN <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>)

HUE_API <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;http://`internalipaddress`/api/`username`/lights&#39;</span>

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    signal<span style="color:#f92672">.</span>signal(signal<span style="color:#f92672">.</span>SIGINT, signal<span style="color:#f92672">.</span>SIG_DFL)
    gyro <span style="color:#f92672">=</span> GYRO<span style="color:#f92672">.</span>GYRO()
    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.1</span>)
    gyro<span style="color:#f92672">.</span>sensor_calib()

    <span style="color:#75715e"># Lighting status</span>
    light_on <span style="color:#f92672">=</span> False
    prev_light_on <span style="color:#f92672">=</span> light_on

    light_bri <span style="color:#f92672">=</span> HUE_BRI_MIN <span style="color:#f92672">+</span> HUE_BRI_HALFlight_ct <span style="color:#f92672">=</span> HUE_CT_MIN <span style="color:#f92672">+</span> HUE_CT_HALF


    <span style="color:#66d9ef">while</span> True:
        <span style="color:#75715e">#Read the sensor value and store it in the required variable</span>
        values <span style="color:#f92672">=</span> gyro<span style="color:#f92672">.</span>get_sense_value()
        axs_x <span style="color:#f92672">=</span> values[<span style="color:#ae81ff">0</span>]
        axs_y <span style="color:#f92672">=</span> values[<span style="color:#ae81ff">1</span>]
        <span style="color:#75715e">#axs_z = values[2]</span>
        <span style="color:#75715e"># print(&#39;{0:4.2f}&#39;.format(axs_x), end=&#34;,&#34;)</span>
        <span style="color:#75715e"># print(&#39;{0:4.2f}&#39;.format(axs_y), end=&#34;,&#34;)</span>
        <span style="color:#75715e"># print(&#39;{0:4.2f}&#39;.format(axs_z), end=&#34;,&#34;)</span>

        <span style="color:#75715e"># gyr_x = values[3]</span>
        <span style="color:#75715e"># gyr_y = values[4]</span>
        gyr_z <span style="color:#f92672">=</span> values[<span style="color:#ae81ff">5</span>]
        <span style="color:#75715e"># print(&#39;{0:4.2f}&#39;.format(gyr_x), end=&#34;,&#34;)</span>
        <span style="color:#75715e"># print(&#39;{0:4.2f}&#39;.format(gyr_y), end=&#34;,&#34;)</span>
        <span style="color:#75715e"># print(&#39;{0:4.2f}&#39;.format(gyr_z), end=&#34;,&#34;)</span>

        <span style="color:#75715e"># Change color tone from X-axis tilt</span>
        light_ct <span style="color:#f92672">+=</span> axs_x <span style="color:#f92672">*</span> HUE_CT_HALF
        <span style="color:#66d9ef">if</span> light_ct <span style="color:#f92672">&lt;</span>HUE_CT_MIN:
            light_ct <span style="color:#f92672">=</span> HUE_CT_MIN
        <span style="color:#66d9ef">if</span> light_ct <span style="color:#f92672">&gt;</span>HUE_CT_MAX:
            light_ct <span style="color:#f92672">=</span> HUE_CT_MAX

        <span style="color:#75715e"># Change brightness from Y-axis tilt</span>
        light_bri <span style="color:#f92672">+=</span> axs_y <span style="color:#f92672">*</span> HUE_CT_HALF
        <span style="color:#66d9ef">if</span> light_bri <span style="color:#f92672">&lt;</span>HUE_BRI_MIN:
            light_bri <span style="color:#f92672">=</span> HUE_BRI_MIN
        <span style="color:#66d9ef">if</span> light_bri <span style="color:#f92672">&gt;</span>HUE_BRI_MAX:
            light_bri <span style="color:#f92672">=</span> HUE_BRI_MAX

        Controls lighting ON<span style="color:#f92672">/</span>OFF when the angular velocity <span style="color:#f92672">in</span> the <span style="color:#75715e">#Z direction exceeds the threshold value</span>
        <span style="color:#66d9ef">if</span> gyr_z <span style="color:#f92672">&lt;-</span>GYR_THRESHOLD:
            light_on <span style="color:#f92672">=</span> <span style="color:#f92672">not</span> light_on

        <span style="color:#75715e">#Throw to Hue</span>
        <span style="color:#66d9ef">if</span> prev_light_on <span style="color:#f92672">!=</span> light_on <span style="color:#f92672">or</span> light_on:
            requests<span style="color:#f92672">.</span>put(HUE_API <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;/`light_id`/state&#39;</span>, json <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;on&#34;</span>: light_on, <span style="color:#e6db74">&#34;bri&#34;</span>: round(light_bri), <span style="color:#e6db74">&#34;ct&#34;</span>: round(light_ct)})
        
        <span style="color:#75715e"># ON/OFF confirmation log</span>
        <span style="color:#66d9ef">if</span> prev_light_on <span style="color:#f92672">!=</span> light_on:
            <span style="color:#66d9ef">print</span> (<span style="color:#e6db74">&#39;lignht_on:&#39;</span>, light_on)

        prev_light_on <span style="color:#f92672">=</span> light_on

        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.10</span>)
</code></pre></div><p>The result of the execution is the opening movie.
Please take a look at this again.</p>
<p><a href="https://youtu.be/3I9leFDmfEQ"><img src="http://img.youtube.com/vi/3I9leFDmfEQ/0.jpg" alt="Controlled Philips Hue by Raspberry Pi (with Gyroscope)"></a></p>
<h3 id="note">Note</h3>
<p>This time, I&rsquo;m throwing it every 0.1 seconds, but please take responsibility for network and bridge loads.</p>
<h2 id="summary">Summary</h2>
<p>By combining various things, you can control the lighting in the room freely.
If you line up your home lights with the Hue series, you can do a lot of fun.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>My coined word. <a href="https://speakerdeck.com/tacck/phpergawen-kitaipythonfalseikutukafalsekoto-pycon-mini-sapporo-2019-number-pyconsap?slide=18">https://speakerdeck.com/tacck/phpergawen-kitaipythonfalseikutukafalsekoto-pycon-mini-sapporo-2019-number-pyconsap?slide=18</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
