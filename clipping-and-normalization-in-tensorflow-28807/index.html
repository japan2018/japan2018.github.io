<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Clipping and normalization in TensorFlow | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Clipping and normalization in TensorFlow</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 17, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/machine-learning"> machine learning</a></code></small>


<small><code><a href="https://memotut.com/tags/tensorflow"> TensorFlow</a></code></small>

</p>
<pre><code># Overview
</code></pre>
<p>This is an article about clipping each value held by tensor handled by TensorFlow.
Specifically, it is an explanation and implementation example of the <code>tf.clip_by...</code> method.</p>
<h1 id="why-do-you-do-this-in-the-first-place">Why do you do this in the first place?</h1>
<p>I think there are various uses, but in machine learning related calculations (especially gradient calculation), which is the main purpose of TensorFlow, there are many cases where the sense of scale of the handled variables is different and it can not be calculated well.
Clipping and normalization are used at such times.</p>
<h1 id="tensorflow-terminology">TensorFlow terminology</h1>
<p>In TensorFlow, the conventional variables and constants, and the processing that represents various operations are called Op nodes (<a href="https://qiita.com/yanosen_jp/items/70e6d6afc36e1c0a3ef3">Reference article</a>).
By executing (run) in the session, the Op node holds the set (tensor) of the value of the operation result and transmits it to the next Op node.
In this article, the number set after some processing is called &ldquo;node&rdquo; in accordance with this.</p>
<h1 id="clip_by-system">clip_by system</h1>
<p>Image of suppressing the value of the node when the condition is met with respect to some fixed criteria</p>
<h2 id="tfclip_by_value">tf.clip_by_value</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
tf<span style="color:#f92672">.</span>clip_by_value(
    t,
    clip_value_min,
    clip_value_max,
    name<span style="color:#f92672">=</span>None
)
</code></pre></div><p>For each value held by the node, the value larger than the maximum value <code>clip_value_max</code> is corrected to <code>clip_value_max</code>, and the value smaller than the minimum value <code>clip_value_min</code> is corrected to <code>clip_value_min</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:example1.py" data-lang="python:example1.py">p1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>placeholder(tf<span style="color:#f92672">.</span>int32, <span style="color:#ae81ff">6</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;p1&#39;</span>)
p2 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>placeholder(tf<span style="color:#f92672">.</span>float32, <span style="color:#ae81ff">6</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;p2&#39;</span>)

clip_value1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>clip_by_value(p1, clip_value_max<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, clip_value_min<span style="color:#f92672">=-</span><span style="color:#ae81ff">2</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;clip_value1&#39;</span>)
clip_value2 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>clip_by_value(p2, clip_value_max<span style="color:#f92672">=</span><span style="color:#ae81ff">2.</span>, clip_value_min<span style="color:#f92672">=-</span><span style="color:#ae81ff">2.</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;clip_value2&#39;</span>)

num1 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">6</span>)

<span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>Session() <span style="color:#66d9ef">as</span> sess:
    <span style="color:#66d9ef">print</span>(p1<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{p1: num1}, session<span style="color:#f92672">=</span>sess))
    <span style="color:#66d9ef">print</span>(p2<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{p2: num1}, session<span style="color:#f92672">=</span>sess))

    <span style="color:#66d9ef">print</span>(clip_value1<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{p1: num1}, session<span style="color:#f92672">=</span>sess))
    <span style="color:#66d9ef">print</span>(clip_value2<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{p2: num1}, session<span style="color:#f92672">=</span>sess))
</code></pre></div><pre><code class="language-console:console" data-lang="console:console">[-4 -2 0 2 4 6]
[-4. -2. 0. 2. 4. 6.]

[-2 -2 0 2 2 2]
[-2. -2. 0. 2. 2. 2.]
</code></pre><p>** An error will be thrown if the node and <code>clip_value</code> types do not match. **</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:example1.py" data-lang="python:example1.py">    <span style="color:#66d9ef">print</span>(clip_error1<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{p1: num1}, session<span style="color:#f92672">=</span>sess))
</code></pre></div><pre><code class="language-console:console" data-lang="console:console">TypeError: Expected int32 passed to parameter'y' of op'Minimum', got 2.0 of type'float' instead.
</code></pre><h2 id="tfclip_by_norm">tf.clip_by_norm</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tf<span style="color:#f92672">.</span>clip_by_norm(
    t,
    clip_norm,
    axes<span style="color:#f92672">=</span>None,
    name<span style="color:#f92672">=</span>None
)
</code></pre></div><p>If the L2 norm of the node is larger than <code>clip_norm</code>, change each value to fix this norm. If it is smaller than <code>clip_norm</code>, it is not changed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:example2.py" data-lang="python:example2.py">p3 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>placeholder(tf<span style="color:#f92672">.</span>float32, [<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>], name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;p3&#39;</span>)

clip_norm1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>clip_by_norm(p3, clip_norm<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;clip_norm1&#39;</span>)
clip_norm2 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>clip_by_norm(p3, clip_norm<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;clip_norm2&#39;</span>)

num2 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">6</span>)<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>))

<span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>Session() <span style="color:#66d9ef">as</span> sess:
    <span style="color:#66d9ef">print</span>(p3<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{p3: num2}, session<span style="color:#f92672">=</span>sess))
    <span style="color:#66d9ef">print</span>(clip_norm1<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{p3: num2}, session<span style="color:#f92672">=</span>sess))
    <span style="color:#66d9ef">print</span>(clip_norm2<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{p3: num2}, session<span style="color:#f92672">=</span>sess))
</code></pre></div><pre><code class="language-console:console" data-lang="console:console">[[-2. -1. 0.]
 [1. 2. 3.]] # The overall L2 norm is 4.358 ...

[[-1.8353258 -0.9176629 0.]
 [0.9176629 1.8353258 2.7529888]]

[[-2. -1. 0.]
 [ one two Three.]]
</code></pre><p>You can specify axes in <code>tf.clip_by_norm</code>.
Normalizes the value with the L2 norm for each axis specified by axes.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:example3.py" data-lang="python:example3.py">clip_norm3 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>clip_by_norm(p3, clip_norm<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, axes<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;clip_norm3&#39;</span>)

<span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>Session() <span style="color:#66d9ef">as</span> sess:
    <span style="color:#66d9ef">print</span>(p3<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{p3: num2}, session<span style="color:#f92672">=</span>sess))
    <span style="color:#66d9ef">print</span>(clip_norm3<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{p3: num2}, session<span style="color:#f92672">=</span>sess))
</code></pre></div><pre><code class="language-console:console" data-lang="console:console">[[-2. -1. 0.] #2 column L2 norm is 2.236 ...
 [1. 2. 3.]] # L2 norm of the 1st column is 3.741 ...

[[-2. -1. 0.]
 [0.8017837 1.6035674 2.4053512]]
</code></pre><p>Note that <code>tf.clip_by_norm</code> raises a TypeError if the bite node cannot handle the decimal point.
Please use float ◯◯ or complex ◯◯ type.</p>
<h2 id="tfclip_by_global_norm">tf.clip_by_global_norm</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
tf<span style="color:#f92672">.</span>clip_by_global_norm(
    t_list,
    clip_norm,
    use_norm<span style="color:#f92672">=</span>None,
    name<span style="color:#f92672">=</span>None
)
</code></pre></div><p>Unlike tf.clip_by_norm, it passes a <strong>list of nodes</strong> instead of a node.
Passing the node itself will result in a TypeError.</p>
<p>Set the L2 norm for all nodes stored in the list to <code>global_norm</code>, and if this value is larger than <code>clip_norm</code>, change all values in the list so that the L2 norm becomes <code>clip_norm</code>. If it is smaller than <code>clip_norm</code>, it is not changed.</p>
<p>Also, the return value is a list containing the nodes after clipping **the <code>list_clipped</code> and the computed <code>global_norm</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:example4.py" data-lang="python:example4.py">c1 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>constant([[<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>], [<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>]], dtype<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>float32, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;c1&#39;</span>)
c2 <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>constant([[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>], [<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4</span>]], dtype<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>float32, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;c2&#39;</span>)
C <span style="color:#f92672">=</span> [c1, c2]

clip_global_norm, global_norm <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>clip_by_global_norm(C, clip_norm<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;clip_global_norm&#39;</span>)

<span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>Session() <span style="color:#66d9ef">as</span> sess:
    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> C:
        <span style="color:#66d9ef">print</span>(c<span style="color:#f92672">.</span>eval(session<span style="color:#f92672">=</span>sess))
    <span style="color:#66d9ef">print</span>(global_norm<span style="color:#f92672">.</span>eval(session<span style="color:#f92672">=</span>sess))
    <span style="color:#66d9ef">for</span> cgn <span style="color:#f92672">in</span> clip_global_norm1:
        <span style="color:#66d9ef">print</span>(cgn<span style="color:#f92672">.</span>eval(session<span style="color:#f92672">=</span>sess))
</code></pre></div><pre><code class="language-console:console" data-lang="console:console">[[0. 1. 2.]
 [3. 4. 5.]]
[[-twenty four.]
 [ twenty four.]]

9.746795
[[0. 0.9233805 1.846761]
 [2.7701416 3.693522 4.6169024]]
[[-1.846761 -3.693522]
 [1.846761 3.693522]]
</code></pre><hr>
<p>Although the <code>tf.clip_by_norm</code> and <code>tf.clip_by_global_norm</code> methods themselves are simple, they can be used, for example, to deal with the &ldquo;gradient clipping&rdquo; countermeasure against gradient explosion in RNN.</p>
<p>The following is helpful.</p>
<blockquote>
<p>-<a href="https://arxiv.org/pdf/1211.5063.pdf">Pascanu et al., (2012), On the difficulty of training Recurrent Neural Networks (pdf)</a>
-<a href="https://qiita.com/t_Signull/items/21b82be280b46f467d1b#rnn%E3%81%A8%E5%8B%BE%E9%85%8D%E3%81%AE%E3%82%AF%E3%83%AA%E3%83%83%E3%83%94%E3%83%B3%E3%82%B0gradient-cliping">Understanding LSTM-clipping of #rnn and gradient with recent trends gradient-cliping</a></p>
</blockquote>
<p>After constructing the model, if you want to train it, if you jump to inf by error propagation calculation etc., this method may solve it.</p>
<h1 id="bonus">bonus</h1>
<p>Clipping actually changed the holding value of the node, but you can only calculate the norm.</p>
<h2 id="tfnorm">tf.norm</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tf<span style="color:#f92672">.</span>norm(
    tensor,
    ord<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;euclidean&#39;</span>,
    axis<span style="color:#f92672">=</span>None,
    keepdims<span style="color:#f92672">=</span>None,
    name<span style="color:#f92672">=</span>None
)
</code></pre></div><p>The parameter <code>ord</code> determines the value of p in the Lp norm.
Specify np.inf for the L∞ norm.</p>
<pre><code class="language-example4.pyp4" data-lang="example4.pyp4">
normalize1 = tf.norm(p4, name='normalize1')
normalize2 = tf.norm(p4, ord=1.5, axis=0, name='normalize2')
normalize3 = tf.norm(p4, ord=np.inf, axis=1, name='normalize3')

num3 = np.linspace(-10, 8, 12).reshape((3, 4))

with tf.Session() as sess:
    print(p4.eval(feed_dict={p4: num3}, session=sess))
    print(normalize1.eval(feed_dict={p4: num3}, session=sess))
    print(normalize2.eval(feed_dict={p4: num3}, session=sess))
    print(normalize3.eval(feed_dict={p4: num3}, session=sess))
</code></pre><pre><code class="language-console:console" data-lang="console:console">[[-10.          -8.363636    -6.7272725   -5.090909  ]
 [ -3.4545455   -1.8181819   -0.18181819   1.4545455 ]
 [  3.090909     4.7272725    6.3636365    8.        ]]

19.87232

[12.364525  11.0871725 10.408293  10.876119 ]

[10.         3.4545455  8.       ]
</code></pre><h1 id="参考">参考</h1>
<p><a href="https://www.tensorflow.org/api_docs/python/tf/clip_by_value?version=stable">TensorFlow &gt; API &gt; TensorFlow Core r2.0 &gt; Python &gt; tf.cilp_by_value</a>
<a href="https://www.tensorflow.org/api_docs/python/tf/clip_by_norm?version=stable">TensorFlow &gt; API &gt; TensorFlow Core r2.0 &gt; Python &gt; tf.clip_by_norm</a>
<a href="https://www.tensorflow.org/api_docs/python/tf/clip_by_global_norm">TensorFlow &gt; API &gt; TensorFlow Core r2.0 &gt; Python &gt; tf.clip_by_global_norm</a>
<a href="https://www.tensorflow.org/api_docs/python/tf/norm?version=stable">TensorFlow &gt; API &gt; TensorFlow Core r2.0 &gt; Python &gt; tf.norm</a></p>
<hr>
<p>明日は、@yoshishinさんによる「Rubyを使って予約システムをハックする」です。
引き続き、<a href="https://qiita.com/advent-calendar/2019/gmo-am">GMOアドマーケティング Advent Calendar 2019</a>をお楽しみください！</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
