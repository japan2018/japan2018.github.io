<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>LINE notification from real-time video recognition with DeepStream SDK | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>LINE notification from real-time video recognition with DeepStream SDK</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 5, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/deeplearning"> DeepLearning</a></code></small>


<small><code><a href="https://memotut.com/tags/line"> Line</a></code></small>


<small><code><a href="https://memotut.com/tags/streaming"> Streaming</a></code></small>


<small><code><a href="https://memotut.com/tags/tensorrt"> TensorRT</a></code></small>

</p>
<pre><code>#LINE notification from high-speed video recognition with DeepStream SDK
</code></pre>
<p>This article is the 7th day of Docomo Advent Calendar 2019.</p>
<p>My name is Sakai from NTT Docomo Service Innovation Department. In my work, I am working on the research and development of image recognition engines that use Deep Learning and their commercialization. This time, we used the GPU-based video recognition acceleration tool &ldquo;DeepStream SDK&rdquo; to detect cars from the video at high speed and notify the result to LINE. It feels like it can be used to make things like AI cameras, detect people with surveillance cameras, and detect illegal parking from camera images.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/320406/ac5bcb47-2ee3-a11c-6c49-ce5405a6e45d.gif" alt="Video gif"></p>
<p>We also challenged messaging using the DeepStream SDK and AMQP, which we could not find many cases on the Web.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/320406/b972b1e7-af1c-757d-d45d-da514f90d85e.jpeg" alt="workflow.jpg"></p>
<h2 id="motivation">Motivation</h2>
<p>As the use of deep learning in image recognition technology has expanded in recent years, image recognition of video data has gradually become more exciting. However, video recognition using deep learning requires more machine specifications than ordinary image recognition, and processing time tends to be slow.</p>
<p>In such a case, if you use NVIDIA&rsquo;s <a href="https://developer.nvidia.com/deepstream-sdk">DeepSTtream SDK</a>, you can speed up video recognition and speed up video processing using GPU. I tried it because it can be used with docker and it is easier to install.</p>
<h2 id="deepstream-sdk">DeepStream SDK</h2>
<p>In deep learning inference (+ learning), GPU is often used for speeding up. DeepStream SDK is an SDK for high speed video processing using GPU. We provide various functions required for video processing in the form of Gstreamer plug-ins that are commonly used for stream processing.</p>
<ul>
<li>Accelerate video encoding/decoding using dedicated hardware for GPUs and edge GPU devices</li>
<li>Accelerate object detection and image classification using Deep Learning using GPU and TensorRT<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></li>
<li>Also provides tracking function</li>
<li>Image recognition results can be sent using Kafka, MQTT, AMQP, etc.</li>
</ul>
<h2 id="method">Method</h2>
<h3 id="environment">environment</h3>
<p>Prepared a GPU server that can use <a href="https://github.com/NVIDIA/nvidia-docker/wiki/Installation-(version-2.0)">NVIDIA docker 2.0</a>.</p>
<ul>
<li>OS: Ubuntu 18.04</li>
<li>nvidia-driver: 418.67</li>
<li>docker: 19.03.4</li>
<li>docker-compose: 1.24.1</li>
<li>nvidia-docker: 2.0.3</li>
</ul>
<p>gpu is <a href="https://github.com/NVIDIA/nvidia-docker/wiki/Installation-(Native-GPU-Support)">native support</a> in docker, but it seems that GPU cannot be specified with docker-compose. , Adopted the old runtime expression specification method.</p>
<h3 id="file-organization">file organization</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">deepstream-line
├── docker
│ ├── Dockerfile
│ ├── requirements.txt
│ └── src
│ └── receive.py
├── docker-compose-amqp.yml
├── docker-compose.yml
├── rabbitmq
├ ├── custom_definitions.json
├ └── rabbitmq.conf
└── videos
    └── test.h264
</code></pre></div><p>Video data can be downloaded from the free video material site <a href="https://mixkit.co/free-stock-video/">Mixkit</a>
I am using <a href="https://mixkit.co/videos/chinatown-street-at-night-2012/">Chinatown street at night</a>.</p>
<p>It is necessary to make it an h264 stream, so convert it using ffmpeg.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ffmpeg -i ./2012-1080.mp4 -vcodec copy -an -bsf:v h264_mp4toannexb videos/test.h264
</code></pre></div><h3 id="start-amqp-server">Start AMQP server</h3>
<p>DeepStream SDK can send the recognition result as a message to Kafka, MQTT, AMQP, etc.
This time, I decided to launch <a href="https://www.rabbitmq.com/">RabbitMQ</a> using docker.
RabbitMQ is a Pub/Sub type messaging service and consists of the following elements.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/320406/3cfb4900-6a9b-9763-4e86-ec3abfe5dbe4.jpeg" alt="rabbitmq.jpg"></p>
<ul>
<li>producer: The sender of the message. This time, DeepStream SDK is this</li>
<li>exchange: Allocates the sent message to an appropriate queue</li>
<li>queue: queue</li>
<li>consumer: Use by going to the queue for messages. This time, a python script that sends a notification to LINE</li>
</ul>
<p>Prepare the AMQP setting file. The user and password are both guest.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json:rabbitmq/custom_definitions.json" data-lang="json:rabbitmq/custom_definitions.json">{
    <span style="color:#f92672">&#34;rabbit_version&#34;</span>: <span style="color:#e6db74">&#34;3.8.0&#34;</span>,
    <span style="color:#f92672">&#34;users&#34;</span>: [{
        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;guest&#34;</span>,
        <span style="color:#f92672">&#34;password_hash&#34;</span>: <span style="color:#e6db74">&#34;CV/8dVC+gRd5cY08tFu4h/7YlGWEdE5lJo4sn4CfbCoRz8ez&#34;</span>,
        <span style="color:#f92672">&#34;hashing_algorithm&#34;</span>: <span style="color:#e6db74">&#34;rabbit_password_hashing_sha256&#34;</span>,
        <span style="color:#f92672">&#34;tags&#34;</span>: <span style="color:#e6db74">&#34;administrator&#34;</span>
    }],
    <span style="color:#f92672">&#34;vhosts&#34;</span>: [{
        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;/&#34;</span>
    }],
    <span style="color:#f92672">&#34;permissions&#34;</span>: [{
        <span style="color:#f92672">&#34;user&#34;</span>: <span style="color:#e6db74">&#34;guest&#34;</span>,
        <span style="color:#f92672">&#34;vhost&#34;</span>: <span style="color:#e6db74">&#34;/&#34;</span>,
        <span style="color:#f92672">&#34;configure&#34;</span>: <span style="color:#e6db74">&#34;.*&#34;</span>,
        <span style="color:#f92672">&#34;write&#34;</span>: <span style="color:#e6db74">&#34;.*&#34;</span>,
        <span style="color:#f92672">&#34;read&#34;</span>: <span style="color:#e6db74">&#34;.*&#34;</span>
    }],
    <span style="color:#f92672">&#34;topic_permissions&#34;</span>: [],
    <span style="color:#f92672">&#34;parameters&#34;</span>: [],
    <span style="color:#f92672">&#34;global_parameters&#34;</span>: [{
        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;cluster_name&#34;</span>,
        <span style="color:#f92672">&#34;value&#34;</span>: <span style="color:#e6db74">&#34;rabbit@rabbitmq&#34;</span>
    }],
    <span style="color:#f92672">&#34;policies&#34;</span>: [],
    <span style="color:#f92672">&#34;queues&#34;</span>: [{
        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;test&#34;</span>,
        <span style="color:#f92672">&#34;vhost&#34;</span>: <span style="color:#e6db74">&#34;/&#34;</span>,
        <span style="color:#f92672">&#34;durable&#34;</span>: <span style="color:#66d9ef">true</span>,
        <span style="color:#f92672">&#34;auto_delete&#34;</span>: <span style="color:#66d9ef">false</span>,
        <span style="color:#f92672">&#34;arguments&#34;</span>: {
            <span style="color:#f92672">&#34;x-queue-type&#34;</span>: <span style="color:#e6db74">&#34;classic&#34;</span>
        }
    }],
    <span style="color:#f92672">&#34;exchanges&#34;</span>: [],
    <span style="color:#f92672">&#34;bindings&#34;</span>: [{
        <span style="color:#f92672">&#34;source&#34;</span>: <span style="color:#e6db74">&#34;amq.topic&#34;</span>,
        <span style="color:#f92672">&#34;vhost&#34;</span>: <span style="color:#e6db74">&#34;/&#34;</span>,
        <span style="color:#f92672">&#34;destination&#34;</span>: <span style="color:#e6db74">&#34;test&#34;</span>,
        <span style="color:#f92672">&#34;destination_type&#34;</span>: <span style="color:#e6db74">&#34;queue&#34;</span>,
        <span style="color:#f92672">&#34;routing_key&#34;</span>: <span style="color:#e6db74">&#34;deepstream&#34;</span>,
        <span style="color:#f92672">&#34;arguments&#34;</span>: {}
    }]
}
</code></pre></div><p>In queues, the name of the queue is set to test. Also, exchange uses amq.topic which is set by default, and when bindings receives a message with the topic &ldquo;deep stream&rdquo;, it routes to the test queue.</p>
<p>Prepare a conf file to read the json.</p>
<pre><code class="language-conf:rabbitmq/rabbitmq.conf" data-lang="conf:rabbitmq/rabbitmq.conf">loopback_users.guest = false
listeners.tcp.default = 5672
management.tcp.port = 15672
management.load_definitions = /etc/rabbitmq/custom_definitions.json
</code></pre><p>With this, you can exchange messages on port 15672 while reading the json.</p>
<p>Start RabbitMQ using docker-compose. While taking the official base image of RabbitMQ, mount the conf/json from the inside of the container using the volumes option.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:docker-compose-amqp.yml" data-lang="yaml:docker-compose-amqp.yml"><span style="color:#66d9ef">version</span>: <span style="color:#e6db74">&#34;2.3&#34;</span>
<span style="color:#66d9ef">services</span>:
  <span style="color:#66d9ef">rabbitmq</span>:
    <span style="color:#66d9ef">image</span>: rabbitmq:<span style="color:#ae81ff">3.8</span>-management
    <span style="color:#66d9ef">hostname</span>: rabbitmq
    <span style="color:#66d9ef">container_name</span>: rabbitmq
    <span style="color:#66d9ef">expose</span>: <span style="color:#75715e"># Expose for other containers</span>
      -<span style="color:#e6db74">&#34;5672&#34;</span>
      -<span style="color:#e6db74">&#34;15672&#34;</span>
    <span style="color:#66d9ef">ports</span>: <span style="color:#75715e">#</span>
      -<span style="color:#e6db74">&#34;5672:5672&#34;</span>
      -<span style="color:#e6db74">&#34;15672:15672&#34;</span>
    <span style="color:#66d9ef">volumes</span>:
      -./rabbitmq:/etc/rabbitmq
<span style="color:#66d9ef">networks</span>:
  <span style="color:#66d9ef">default</span>:
</code></pre></div><p>Also, by defining the network, it is possible to connect from the DeepStream SDK and consumer containers later. Start with the following command.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker-compose -f docker-compose-amqp.yml up -d
</code></pre></div><h3 id="prepare-deepstream-sdk">Prepare DeepStream SDK</h3>
<p>DeepStream SDK will use the official image provided by <a href="https://ngc.nvidia.com/">NVIDIA GPU CLOUD</a>.Theimageusedis<a href="https://ngc.nvidia.com/catalog/containers/nvidia:deepstream/tags">nvcr.io/nvidia/deepstream:4.0.1-19.09-samples</a>.</p>
<p>Pull it beforehand.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker pull nvcr.io/nvidia/deepstream:4.0.1-19.09-samples
</code></pre></div><p>This image contains everything you need, including the compiled DeepStream SDK, samples, TensorRT, Gstreamer, and more. This time, I use <a href="https://developer.nvidia.com/deepstream-faq#sample_apps">DeepStream Test 4</a> among the sample apps included in this docker image. This is an application that can detect and recognize a car/person and then send the recognition result as a message every 30 frames.</p>
<blockquote>
<p>Directory: <DS installation dir>/sources/apps/sample_apps/deepstream-test4
Description: This builds on top of the deepstream-test1 sample for single H.264 stream-filesrc, decode, nvstreammux, nvinfer, nvosd, renderer to demonstrate the use of &ldquo;nvmsgconv&rdquo; and &ldquo;nvmsgbroker&rdquo; plugins in the pipeline for IOT connection For test4, user have to modify kafka broker connection string for successful connection.Need to setup analytics server docker before running test4.The DeepStream Analytics Documentation has more information on setting up analytics servers.</p>
</blockquote>
<p>You can check the README and Usage with the following command.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run --gpus <span style="color:#ae81ff">0</span> --rm -it <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    nvcr.io/nvidia/deepstream:4.0.1-19.09-samples<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    cat /root/deepstream_sdk_v4.0.1_x86_64/sources/apps/sample_apps/deepstream-test4/README
<span style="color:#75715e"># README is displayed</span>
docker run --gpus <span style="color:#ae81ff">0</span> --rm -it <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    nvcr.io/nvidia/deepstream:4.0.1-19.09-samples<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    /opt/nvidia/deepstream/deepstream-4.0/bin/deepstream-test4-app
<span style="color:#75715e"># /opt/nvidia/deepstream/deepstream-4.0/bin/deepstream-test4-app \</span>
<span style="color:#75715e"># -i &lt;H264 filename&gt; -p &lt;Proto adaptor library&gt; --conn-str=&lt;Connection string</span>
</code></pre></div><p>According to the README, you can use AMQP by setting the options <code>--proto-lib</code>, <code>--conn-str</code>, and <code>--topic </code>.</p>
<blockquote>
<p>1.Use &ndash;proto-lib or -p command line option to set the path of adaptor library.
Adapter library can be found at /opt/nvidia/deepstream/deepstream-<version>/lib</p>
<p>kafka lib-libnvds_kafka_proto.so
azure device client-libnvds_azure_proto.so
AMQP lib-libnvds_amqp_proto.so</p>
<p>2.Use &ndash;conn-str command line option as required to set connection to &gt;backend server.
For Azure-Full Azure connection string
For Kafka-Connection string of format: host;port;topic
For Amqp-Connection string of format: host;port;username.Password to be provided in cfg_amqp.txt</p>
<p>3.Use &ndash;topic or -t command line option to provide message topic (optional).
Kafka message adaptor also has the topic param embedded within the connection string format
In that case, &ldquo;topic&rdquo; from command line should match the topic within connection string</p>
</blockquote>
<p>In <a href="#StartAMQPserver">Start AMQP server</a>, host is rabbitmq, port is 15672, user is guest, so <code>-c rabbitmq;5672;guesttopic should be deepstream -c cfg_amqp.txt</code>. It will be.</p>
<p><code>libnvds_amqp_proto.so</code> is stored in <code>/opt/nvidia/deepstream/deepstream-4.0/lib/libnvds_amqp_proto.so</code> in the docker image.</p>
<h3 id="consumer-preparation">Consumer Preparation</h3>
<p>Get a message from AMQP server and prepare a container to send a notification to LINE.
Use LINE Notify to send notifications to LINE.
This means that if you link with the web service, you will receive notifications from the official account &ldquo;LINE Notify&rdquo; provided by LINE.
The one that corresponds to this &ldquo;Web service&rdquo; is written in python.
You can send a notification by obtaining a dedicated TOKEN and POSTing a message to a specific URL while authenticating using the TOKEN.
This time, I got TOKEN by referring to <a href="https://qiita.com/aoyahashizume/items/13848b013daa18f6461b">this article</a>.TheacquiredTOKENwillbeusedinthe<a href="#Run">Run</a> area, so write it down somewhere.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:docker/src/receive.py" data-lang="python:docker/src/receive.py"><span style="color:#f92672">import</span> pika
<span style="color:#f92672">import</span> json
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> os

LINE_URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://notify-api.line.me/api/notify&#34;</span>
line_token <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#39;LINE_TOKEN&#39;</span>] <span style="color:#75715e"># fetch TOKEN from environment variable</span>
message_format <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">Time: {time:s}
</span><span style="color:#e6db74">Location: {place:s}
</span><span style="color:#e6db74">Camera: {camera:s}
</span><span style="color:#e6db74">Objects detected: {object:s}
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    <span style="color:#75715e"># connect to mqtt</span>
    credentials <span style="color:#f92672">=</span> pika<span style="color:#f92672">.</span>PlainCredentials(<span style="color:#e6db74">&#39;guest&#39;</span>,<span style="color:#e6db74">&#39;guest&#39;</span>)
    connect_param <span style="color:#f92672">=</span> pika<span style="color:#f92672">.</span>ConnectionParameters(
        host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rabbitmq&#39;</span>, host name given to container <span style="color:#66d9ef">with</span> <span style="color:#75715e">#docker-compsoe-amqp</span>
        credentials<span style="color:#f92672">=</span>credentials
    )
    connection <span style="color:#f92672">=</span> pika<span style="color:#f92672">.</span>BlockingConnection(connect_param)
    channel <span style="color:#f92672">=</span> connection<span style="color:#f92672">.</span>channel()

    <span style="color:#75715e"># line token for authentication</span>
    line_headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Authorization&#34;</span>: <span style="color:#e6db74">&#34;Bearer {}&#34;</span><span style="color:#f92672">.</span>format(line_token)}

    <span style="color:#66d9ef">for</span> method_frame, properties, body <span style="color:#f92672">in</span> channel<span style="color:#f92672">.</span>consume(
        <span style="color:#e6db74">&#39;test&#39;</span>,
        inactivity_timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span> <span style="color:#75715e"># 30 seconds break if there is no new message</span>
    ):
        <span style="color:#66d9ef">if</span> method_frame <span style="color:#f92672">is</span> None:
            <span style="color:#66d9ef">break</span>

        message <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(body)
        <span style="color:#66d9ef">if</span><span style="color:#e6db74">&#39;vehicle&#39;</span> <span style="color:#f92672">in</span> message[<span style="color:#e6db74">&#39;object&#39;</span>]<span style="color:#f92672">.</span>keys():
            obj_data <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{} {} {}&#39;</span><span style="color:#f92672">.</span>format(
                message[<span style="color:#e6db74">&#39;object&#39;</span>][<span style="color:#e6db74">&#39;vehicle&#39;</span>][<span style="color:#e6db74">&#39;make&#39;</span>],
                message[<span style="color:#e6db74">&#39;object&#39;</span>][<span style="color:#e6db74">&#39;vehicle&#39;</span>][<span style="color:#e6db74">&#39;model&#39;</span>],
                message[<span style="color:#e6db74">&#39;object&#39;</span>][<span style="color:#e6db74">&#39;vehicle&#39;</span>][<span style="color:#e6db74">&#39;color&#39;</span>],
            )
        <span style="color:#66d9ef">elif</span><span style="color:#e6db74">&#39;person&#39;</span> <span style="color:#f92672">in</span> message[<span style="color:#e6db74">&#39;object&#39;</span>]<span style="color:#f92672">.</span>keys():
            obj_data <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Person {} {}&#39;</span><span style="color:#f92672">.</span>format(
                message[<span style="color:#e6db74">&#39;object&#39;</span>][<span style="color:#e6db74">&#39;person&#39;</span>][<span style="color:#e6db74">&#39;age&#39;</span>],
                message[<span style="color:#e6db74">&#39;object&#39;</span>][<span style="color:#e6db74">&#39;person&#39;</span>][<span style="color:#e6db74">&#39;gender&#39;</span>]
            )
        <span style="color:#66d9ef">else</span>:
            obj_data <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
        payload <span style="color:#f92672">=</span> {
            <span style="color:#e6db74">&#34;message&#34;</span>: message_format<span style="color:#f92672">.</span>format(
                time<span style="color:#f92672">=</span>message[<span style="color:#e6db74">&#39;@timestamp&#39;</span>],
                place<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{}_{}({})&#39;</span><span style="color:#f92672">.</span>format(
                    message[<span style="color:#e6db74">&#39;place&#39;</span>][<span style="color:#e6db74">&#39;id&#39;</span>],
                    message[<span style="color:#e6db74">&#39;place&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>],
                    message[<span style="color:#e6db74">&#39;place&#39;</span>][<span style="color:#e6db74">&#39;type&#39;</span>],
                ),camera<span style="color:#f92672">=</span>message[<span style="color:#e6db74">&#39;sensor&#39;</span>][<span style="color:#e6db74">&#39;id&#39;</span>],
                object<span style="color:#f92672">=</span>obj_data,
            )
        }
        r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(
            LINE_URL,
            headers<span style="color:#f92672">=</span>line_headers,
            params<span style="color:#f92672">=</span>payload
        )
        channel<span style="color:#f92672">.</span>basic_ack(method_frame<span style="color:#f92672">.</span>delivery_tag)

    <span style="color:#75715e"># cancel consumer and return if there is a pending message</span>
    requeued_messages <span style="color:#f92672">=</span> channel<span style="color:#f92672">.</span>cancel()
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Requeued </span><span style="color:#e6db74">%i</span><span style="color:#e6db74"> messages&#39;</span> <span style="color:#f92672">%</span>requeued_messages)
    connection<span style="color:#f92672">.</span>close()


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span><span style="color:#e6db74">&#39;__main__&#39;</span>:
    main()
</code></pre></div><p>At <code>payload =</code>, we are processing the message sent from DeepStream SDK via AMQP.
The message from DeepStream Test 4 is sent once every 30 frames in json format (the DeepStream Test 4 trail).
The message contains information for one of the found objects in the following format:
We decided to retrieve the shooting location information stored in place, camera information stored in camera, time, and object information.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;messageid&#34;</span>: <span style="color:#e6db74">&#34;a8c57c62-5e25-478d-a909-3ab064cbf11f&#34;</span>,
    <span style="color:#f92672">&#34;mdsversion&#34;</span>: <span style="color:#e6db74">&#34;1.0&#34;</span>,
    <span style="color:#f92672">&#34;@timestamp&#34;</span>: <span style="color:#e6db74">&#34;2019-11-17T13:42:39.807Z&#34;</span>,
    <span style="color:#f92672">&#34;place&#34;</span>: {
        <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>,
        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;XYZ&#34;</span>,
        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;garage&#34;</span>,
        <span style="color:#f92672">&#34;location&#34;</span>: {
            <span style="color:#f92672">&#34;lat&#34;</span>: <span style="color:#ae81ff">30.32</span>,
            <span style="color:#f92672">&#34;lon&#34;</span>: <span style="color:#ae81ff">-40.55</span>,
            <span style="color:#f92672">&#34;alt&#34;</span>: <span style="color:#ae81ff">100.0</span>
        },
        <span style="color:#f92672">&#34;aisle&#34;</span>: {
            <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;walsh&#34;</span>,
            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;lane1&#34;</span>,
            <span style="color:#f92672">&#34;level&#34;</span>: <span style="color:#e6db74">&#34;P2&#34;</span>,
            <span style="color:#f92672">&#34;coordinate&#34;</span>: {
                <span style="color:#f92672">&#34;x&#34;</span>: <span style="color:#ae81ff">1.0</span>,
                <span style="color:#f92672">&#34;y&#34;</span>: <span style="color:#ae81ff">2.0</span>,
                <span style="color:#f92672">&#34;z&#34;</span>: <span style="color:#ae81ff">3.0</span>
            }
        }
    },
    <span style="color:#f92672">&#34;sensor&#34;</span>: {
        <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;CAMERA_ID&#34;</span>,
        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;Camera&#34;</span>,
        <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;\&#34;Entrance of Garage Right Lane\&#34;&#34;</span>,
        <span style="color:#f92672">&#34;location&#34;</span>: {
            <span style="color:#f92672">&#34;lat&#34;</span>: <span style="color:#ae81ff">45.293701447</span>,
            <span style="color:#f92672">&#34;lon&#34;</span>: <span style="color:#ae81ff">-75.8303914499</span>,
            <span style="color:#f92672">&#34;alt&#34;</span>: <span style="color:#ae81ff">48.1557479338</span>
        },
        <span style="color:#f92672">&#34;coordinate&#34;</span>: {
            <span style="color:#f92672">&#34;x&#34;</span>: <span style="color:#ae81ff">5.2</span>,
            <span style="color:#f92672">&#34;y&#34;</span>: <span style="color:#ae81ff">10.1</span>,
            <span style="color:#f92672">&#34;z&#34;</span>: <span style="color:#ae81ff">11.2</span>
        }
    },
    <span style="color:#f92672">&#34;analyticsModule&#34;</span>: {
        <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;XYZ&#34;</span>,
        <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;\&#34;Vehicle Detection and License Plate Recognition\&#34;&#34;</span>,
        <span style="color:#f92672">&#34;source&#34;</span>: <span style="color:#e6db74">&#34;OpenALR&#34;</span>,
        <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#e6db74">&#34;1.0&#34;</span>,
        <span style="color:#f92672">&#34;confidence&#34;</span>: <span style="color:#ae81ff">0.0</span>
    },
    <span style="color:#f92672">&#34;object&#34;</span>: {
        <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;-1&#34;</span>,
        <span style="color:#f92672">&#34;speed&#34;</span>: <span style="color:#ae81ff">0.0</span>,
        <span style="color:#f92672">&#34;direction&#34;</span>: <span style="color:#ae81ff">0.0</span>,
        <span style="color:#f92672">&#34;orientation&#34;</span>: <span style="color:#ae81ff">0.0</span>,
        <span style="color:#f92672">&#34;vehicle&#34;</span>: {
            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;sedan&#34;</span>,
            <span style="color:#f92672">&#34;make&#34;</span>: <span style="color:#e6db74">&#34;Bugatti&#34;</span>,
            <span style="color:#f92672">&#34;model&#34;</span>: <span style="color:#e6db74">&#34;M&#34;</span>,
            <span style="color:#f92672">&#34;color&#34;</span>: <span style="color:#e6db74">&#34;blue&#34;</span>,
            <span style="color:#f92672">&#34;licenseState&#34;</span>: <span style="color:#e6db74">&#34;CA&#34;</span>,
            <span style="color:#f92672">&#34;license&#34;</span>: <span style="color:#e6db74">&#34;XX1234&#34;</span>,
            <span style="color:#f92672">&#34;confidence&#34;</span>: <span style="color:#ae81ff">0.0</span>
        },
        <span style="color:#f92672">&#34;bbox&#34;</span>: {
            <span style="color:#f92672">&#34;topleftx&#34;</span>: <span style="color:#ae81ff">585</span>,
            <span style="color:#f92672">&#34;toplefty&#34;</span>: <span style="color:#ae81ff">472</span>,
            <span style="color:#f92672">&#34;bottomrightx&#34;</span>: <span style="color:#ae81ff">642</span>,
            <span style="color:#f92672">&#34;bottomrighty&#34;</span>: <span style="color:#ae81ff">518</span>
        },
        <span style="color:#f92672">&#34;location&#34;</span>: {
            <span style="color:#f92672">&#34;lat&#34;</span>: <span style="color:#ae81ff">0.0</span>,
            <span style="color:#f92672">&#34;lon&#34;</span>: <span style="color:#ae81ff">0.0</span>,
            <span style="color:#f92672">&#34;alt&#34;</span>: <span style="color:#ae81ff">0.0</span>
        },
        <span style="color:#f92672">&#34;coordinate&#34;</span>: {
            <span style="color:#f92672">&#34;x&#34;</span>: <span style="color:#ae81ff">0.0</span>,
            <span style="color:#f92672">&#34;y&#34;</span>: <span style="color:#ae81ff">0.0</span>,
            <span style="color:#f92672">&#34;z&#34;</span>: <span style="color:#ae81ff">0.0</span>
        }
    },
    <span style="color:#f92672">&#34;event&#34;</span>: {
        <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;4f8436ab-c611-4257-8b83-b9134c6cab0d&#34;</span>,
        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;moving&#34;</span>
    },
    <span style="color:#f92672">&#34;videoPath&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
}
</code></pre></div><p>The container image that executes the above consumer is created using Dockerfile. After installing python3, the necessary python package is installed using pip. Finally, copy the source code to finish.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile:docker/Dockerfile" data-lang="Dockerfile:docker/Dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:18.04</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> apt-get install -y python3-pip python3-dev <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> cd /usr/local/bin <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> ln -s /usr/bin/python3 python <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> pip3 install --upgrade pip <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> apt-get clean <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#f92672">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> requirements.txt /tmp/requirements.txt<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip3 install -r /tmp/requirements.txt<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> src /opt/src<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /opt/src</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;python3&#34;</span>, <span style="color:#e6db74">&#34;./receive.py&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt:requirements.txt" data-lang="txt:requirements.txt">pika
requests
</code></pre></div><h3 id="run">run</h3>
<p>Launch DeepStream SDK and consumer using docker-compose.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:docker-compose.yml" data-lang="yaml:docker-compose.yml"><span style="color:#66d9ef">version</span>: <span style="color:#e6db74">&#34;2.3&#34;</span>
<span style="color:#66d9ef">services</span>:
  <span style="color:#66d9ef">deepstream</span>:
    <span style="color:#66d9ef">image</span>: nvcr.io/nvidia/deepstream:<span style="color:#ae81ff">4.0.1-19.09</span>-samples
    <span style="color:#66d9ef">runtime</span>: nvidia
    <span style="color:#66d9ef">hostname</span>: deepstream
    <span style="color:#66d9ef">container_name</span>: deepstream
    command:<span style="color:#e6db74">&gt;
</span><span style="color:#e6db74">      /opt/nvidia/deepstream/deepstream-4.0/bin/deepstream-test4-app</span>
      -i /root/videos/test.h264
      -p /opt/nvidia/deepstream/deepstream<span style="color:#ae81ff">-4.0</span>/lib/libnvds_amqp_proto.so
      -c cfg_amqp.txt
      -t deepstream
      --conn-str rabbitmq;<span style="color:#ae81ff">5672</span>;guest
    <span style="color:#66d9ef">cap_add</span>:
      -SYSLOG
    <span style="color:#66d9ef">working_dir</span>: /root/deepstream_sdk_v4<span style="color:#ae81ff">.0</span>.1_x86_64/sources/apps/sample_apps/deepstream-test4
    <span style="color:#66d9ef">networks</span>:
      -deepstream-line_default
    <span style="color:#66d9ef">volumes</span>:
      -./videos:/root/videos
      -/tmp/.X11-unix:/tmp/.X11-unix
    <span style="color:#66d9ef">environment</span>:
      -DISPLAY=$DISPLAY
  <span style="color:#66d9ef">consumer</span>:
    <span style="color:#66d9ef">build</span>: ./docker
    <span style="color:#66d9ef">hostname</span>: consumer
    <span style="color:#66d9ef">container_name</span>: consumer
    <span style="color:#66d9ef">environment</span>:
      <span style="color:#66d9ef">LINE_TOKEN</span>: <span style="color:#e6db74">&#34;XXX&#34;</span>
    <span style="color:#66d9ef">networks</span>:
      -deepstream-line_default
<span style="color:#66d9ef">networks</span>:
  <span style="color:#66d9ef">deepstream-line_default</span>:
    <span style="color:#66d9ef">external</span>: <span style="color:#66d9ef">true</span>
</code></pre></div><p>Paste the obtained TOKEN in place of <code>LINE_TOKEN: &quot;XXXXXXXX&quot;</code>. You will now receive notifications on your LINE.</p>
<p>The following process will start.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Added display of results from xhost + <span style="color:#75715e"># docker</span>
docker-compose build <span style="color:#75715e"># consumer build process</span>
docker-compose up -d
</code></pre></div><p>This assumes an environment with a display, so a slight modification <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> is required to run it on a server.</p>
<h2 id="result">result</h2>
<p>When docker-compose up, the recognition process of the video starts up in the following form and the notification can be sent to LINE.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/320406/4012ad49-10a5-76fa-45d2-6d1aa450d97f.gif" alt="result_all.gif"></p>
<p>The above is the PC version of LINE, but if you are on a smartphone you will receive a notification like the following.<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/320406/7cd843bd-bb95-48da-096e-213d74d8f8b5.jpeg" alt="Screenshot_20191206-212712_LINE.jpg"></p>
<h2 id="at-the-end">at the end</h2>
<p>Introduced a method to perform LINE notification by performing high-speed video recognition using DeepStream SDK. This time I used a normal server, but by using a <a href="https://ngc.nvidia.com/catalog/containers/nvidia:deepstream-l4t">deepstream-l4t</a> container, it can be used for edge GPUs such as jetson. The same processing should be possible on the machine. Dreams of making your own AI camera-like things will spread.</p>
<p>Also, this time, we could not use the recognition model of your choice in the application on the DeepStream SDK side or change the format of the output data. In addition, I would like to introduce if there is an opportunity.</p>
<p>Until the end Thank you for reading.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Library for speeding up Deep Learning inference processing on NVIDIA GPUs. Previously, <a href="https://qiita.com/dcm_sakai/items/0e13e2917adf55e92745">I tried using TensorRT 5.0</a>,<a href="https://qiita.com/104ki/Iwritearticlessuchasitems/17434efa7ce045f767dd">TensorRT5.0.6andJETSONNANOaccelerateinference</a>. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>If you want to run it on a server that does not have display, you can do it by removing <code>environment</code> from <code>deepstream</code> of docker-compose.yml and adding <code>--no-display</code> option to <code>command</code>. .. <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
