<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] [For beginners] Build a Python environment that you can enjoy by copying and copying, scraping, machine learning, and practical application [Look for affordable rental properties with SUUMO! ] | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] [For beginners] Build a Python environment that you can enjoy by copying and copying, scraping, machine learning, and practical application [Look for affordable rental properties with SUUMO! ]</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 18, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/scraping"> scraping</a></code></small>


<small><code><a href="https://memotut.com/tags/machine-learning"> machine learning</a></code></small>


<small><code><a href="https://memotut.com/tags/jupyter"> Jupyter</a></code></small>


<small><code><a href="https://memotut.com/tags/anaconda"> Anaconda</a></code></small>

</p>
<pre><code>#Introduction
</code></pre>
<p>Everyone, do you like data analysis __?</p>
<p>Nice to meet you! I&rsquo;m @haraso_1130 who is the mentor at DMM WEB CAMP</p>
<p>Suddenly, look at the image below.</p>
<img width="686" alt="Screenshots 2019-12-15 18.13.43.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/823992c5-e429-eb1d-27ab-2ffe4d34be76.png">
<h3 id="what-a-property-in-23-wards-of-tokyo-is-5dk-80000-yen-">What a property in 23 wards of Tokyo is 5DK 80,000 yen! ?</h3>
<p>If you are in the 23 wards, you can comfortably do 80,000 a room a month &hellip;</p>
<p>This property is
<strong>Using &ldquo;Python&rdquo;</strong>
Collecting data by <strong>&ldquo;scraping&rdquo;</strong>
Results of data analysis using <strong>&ldquo;machine learning&rdquo;</strong>
It is a property that we were able to discover.</p>
<p>This article is (basically) <strong>for actual data analysis only with copy and paste and to make you like data analysis</strong>.
In other words, the goal is to get the impression of &ldquo;I can do something amazing!&rdquo; **.</p>
<p>So, if you are reading and there is a &ldquo;I don&rsquo;t know what you are saying&rdquo; part, think that &ldquo;I&rsquo;m just not good at explaining the author&rdquo; and go ahead.</p>
<p>As a supposed reader, I think as follows.
<strong>・People who are interested in data analysis
・People who shy away from data analysis
・Others</strong></p>
<p>From the above, ** I will not explain the code in depth, but will focus on &ldquo;what and why I am doing now&rdquo; **.
‥
Also, it says &ldquo;move it with copy and paste&rdquo;, but I will devise it so that you can understand the fun of data analysis just by reading **!</p>
<p>It is just an advertisement, but if you read this article and think &ldquo;I would like to analyze data!&rdquo;, I am writing self-study methods etc. on <a href="https://haraso.hatenablog.com/">My blog</a> So please refer to it.</p>
<h2 id="what-to-do-in-this-article">What to do in this article</h2>
<p><strong>・From Python environment construction to scraping and machine learning implementation</strong>
<strong>・Creating a profitable property search table like the image below</strong>: Discover the profitable property using the created model.
<img width="1090" alt="Screenshots 2019-12-17 13.30.58.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/61f8e9ba-39ae-9d60-b7d2-838f9f0cdccd.png"></p>
<h2 id="things-not-to-do-in-this-article">Things not to do in this article</h2>
<p>*** Detailed explanation of the code**
・**Explanation of machine learning algorithm**</p>
<p>This article is just for getting people to like data analysis.
I will omit the small difficult stories as much as possible!
(I feel that &ldquo;practice → theory / foundation&rdquo; can be overwhelmingly more efficient to learn programming than &ldquo;theory / foundation → practice&rdquo; &hellip;)</p>
<h2 id="my-environment">My environment</h2>
<p>macOS High Sierra ver10.13.6 (<del>Adede without getting tired</del>)
python3.7.3
Jupyter lab</p>
<p>##Note
In the title of the article, I wrote <strong>&ldquo;Copy and paste&rdquo;&quot;</strong>, but when I got some acquaintances to try it, <strong>Jupyter Notebook or lab</strong> should work almost correctly! *As of December 17, 2019
If it doesn&rsquo;t work, please tell me&hellip;
If it doesn&rsquo;t work, the most likely reason is that the library is not included.
Please install with <code>conda install</code> each time.</p>
<p>#table of contents
| Table of Contents |
|:&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;|
| <a href="#Overallflow">Overall flow</a> |
| <a href="#Environmentconstruction">Environment construction</a> |
| <a href="#Scraping">Scraping</a> |
| <a href="#DataAnalysis">Data Analysis</a> |
| <a href="#DiscoverableProperty">Discoverable Property</a> |
| <a href="#actually">Actually&hellip;</a> |
| <a href="#End">End</a> |</p>
<h1 id="overall-flow">Overall flow</h1>
<p>First, let&rsquo;s check the overall flow.
In this article</p>
<ol>
<li><strong>Environment construction</strong> for executing code</li>
<li>Obtain large amount of information automatically using <strong>scraping</strong></li>
<li>Create a machine learning model** based on the acquired information</li>
<li>Predict the house price using the created model **</li>
<li>Compare the forecast with the actual price to find the best deal. **</li>
</ol>
<p>It is the flow.</p>
<p>Even though it is said to be the predicted value by the model, it does not come out very well, but that is okay because it will be explained in the machine learning part below!</p>
<p>#Environment</p>
<p>As I mentioned earlier, all the code in this article is intended to be implemented in Jupyter.
Here we will introduce how to install <strong>Jupyter lab</strong>.</p>
<p>First, install Anaconda from the link below.
[Https://www.anaconda.com/distribution/]</p>
<img width="996" alt="Screenshots 2019-12-18 3.48.04.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/f297ead1-ab34-fa9b-3258-bf2e44860e28.png">
<p>afterwards
windows
[Https://www.python.jp/install/anaconda/windows/install.html]
For mac
[Https://www.python.jp/install/anaconda/macos/install.html]</p>
<p>Refer to to complete the installation of Anaconda.</p>
<p>And recently Anaconda has jupyter lab originally.</p>
<pre><code>$ jupyter lab
</code></pre><p>For Windows, execute the above code from the command prompt, and for mac, execute the above code from the terminal.</p>
<p>Also, if you have Anaconda in the first place,</p>
<pre><code>$ conda install -c conda-forge jupyterlab
$ jupyter lab
</code></pre><p>Is all right.</p>
<p>This concludes the environment construction.
It&rsquo;s too easy&hellip;!</p>
<p>Create a folder on your desktop and create a notebook there.
<img width="566" alt="Screenshots 2019-12-18 3.52.26.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/4a3d3691-60a9-ba1b-c22b-d8f2f1180d2d.png"></p>
<p>#Scraping</p>
<p>What is &ldquo;scraping&rdquo; in the first place?
According to wikipedia</p>
<blockquote>
<p>Web scraping is the process of automatically collecting information from the WWW.</p>
</blockquote>
<p>In other words, <strong>&ldquo;Automatically collect information from the Internet&rdquo;</strong>. (<del>that is too good</del>)</p>
<p>In this analysis, we will use data for rented properties of thousands, and in some cases tens of thousands, but for one property</p>
<blockquote>
<p>・Property name
・Rent
・Area
Floor plan
Location (closest station, distance to the nearest station, detailed address)
etc&hellip;</p>
</blockquote>
<p>You can manually type this into Excel thousands or tens of thousands of times&hellip; just thinking about it makes you uncomfortable.
Therefore, gather data at once by programming.</p>
<p>There is one important note here.
**Be sure to check the site&rsquo;s terms of use before scraping. **
Scraping is prohibited by some sites due to issues such as copyright and inability to server.
Fortunately, <a href="https://suumo.jp/edit/kiyaku/">SUUMO Terms of Use</a></p>
<blockquote>
<p>&ldquo;Users must not use any content provided through this site beyond the personal use of the user specified by the copyright law without prior consent of the Company.&rdquo;</p>
</blockquote>
<p>It will be fine because it is private use this time.</p>
<p>open jupyter,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#url (Please enter the URL here)</span>
url <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
</code></pre></div><p>Please execute the code by inserting the url of your favorite ward in the 23 wards of Tokyo during the single quotation of.
You can jump to the screen to select 23 wards from the link below.
[Https://suumo.jp/chintai/tokyo/city/]
For example, in case of Bunkyo Ward, <a href="https://suumo.jp/jj/chintai/ichiran/FR301FC001/?ar=030&amp;bs=040&amp;ta=13&amp;sc=13101&amp;cb=0.0&amp;ct=9999999&amp;mb=0&amp;mt=9999999&amp;et=9999999&amp;cn=9999999&amp;shkr1=03&amp;shkr2=03&amp;shkr3=03&amp;shkr4">https://suumo.jp/jj/chintai/ichiran/FR301FC001/?ar=030&amp;bs=040&amp;ta=13&amp;sc=13101&amp;cb=0.0&amp;ct=9999999&amp;mb=0&amp;mt=9999999&amp;et=9999999&amp;cn=9999999&amp;shkr1=03&amp;shkr2=03&amp;shkr3=03&amp;shkr4</a> =03&amp;sngz=&amp;po1=09&amp;pc=50`
It takes a long time to collect data, so we recommend running it before going to sleep.</p>
<p>__ *Addition (2019/12/29) __
I&rsquo;m currently seeing cases that don&rsquo;t work if it&rsquo;s in &ldquo;recommended order&rdquo;. __
__It&rsquo;s a symptomatic measure, but it seems to work when sorted by &ldquo;newest first&rdquo;. __
I will update as soon as the root cause is known. __</p>
<p>It should be noted that this code can acquire information not only for the 23 wards of Tokyo but also for areas other than Tokyo. (When I tried it, I was able to obtain the data of Okayama Prefecture) However, in the data analysis part of the second half of this article, I coded assuming the data of the 23 wards of Tokyo, so it often does not work with just copy and paste. There is.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">
<span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
<span style="color:#f92672">import</span> urllib3
<span style="color:#f92672">import</span> re
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">from</span> pandas <span style="color:#f92672">import</span> Series, DataFrame

<span style="color:#75715e">#URL (Please enter the URL here)</span>
url <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>

result <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
c <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>content

soup <span style="color:#f92672">=</span> BeautifulSoup(c)

summary <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#34;div&#34;</span>,{<span style="color:#e6db74">&#39;id&#39;</span>:<span style="color:#e6db74">&#39;js-bukkenList&#39;</span>})
body <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#34;body&#34;</span>)
pages <span style="color:#f92672">=</span> body<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#34;div&#34;</span>,{<span style="color:#e6db74">&#39;class&#39;</span>:<span style="color:#e6db74">&#39;pagination pagination_set-nav&#39;</span>})
pages_text <span style="color:#f92672">=</span> str(pages)
pages_split <span style="color:#f92672">=</span> pages_text<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;&lt;/a&gt;&lt;/li&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&lt;/ol&gt;&#39;</span>)
pages_split0 <span style="color:#f92672">=</span> pages_split[<span style="color:#ae81ff">0</span>]
pages_split1 <span style="color:#f92672">=</span> pages_split0[<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>:]
pages_split2 <span style="color:#f92672">=</span> pages_split1<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;&gt;&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
pages_split3 <span style="color:#f92672">=</span> int(pages_split2)

urls <span style="color:#f92672">=</span> []

urls<span style="color:#f92672">.</span>append(url)

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(pages_split3<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>):pg <span style="color:#f92672">=</span> str(i<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)
    url_page <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&amp;page=&#39;</span> <span style="color:#f92672">+</span> pg
    urls<span style="color:#f92672">.</span>append(url_page)

names <span style="color:#f92672">=</span> [] 
addresses <span style="color:#f92672">=</span> [] 
locations0 <span style="color:#f92672">=</span> [] 
locations1 <span style="color:#f92672">=</span> [] 
locations2 <span style="color:#f92672">=</span> [] 
ages <span style="color:#f92672">=</span> [] 
heights <span style="color:#f92672">=</span> [] 
floors <span style="color:#f92672">=</span> []
rent <span style="color:#f92672">=</span> [] 
admin <span style="color:#f92672">=</span> []
others <span style="color:#f92672">=</span> [] 
floor_plans <span style="color:#f92672">=</span> [] 
areas <span style="color:#f92672">=</span> []
detail_urls <span style="color:#f92672">=</span> [] 

<span style="color:#66d9ef">for</span> url <span style="color:#f92672">in</span> urls:
    result <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
    c <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>content
    soup <span style="color:#f92672">=</span> BeautifulSoup(c)
    summary <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#34;div&#34;</span>,{<span style="color:#e6db74">&#39;id&#39;</span>:<span style="color:#e6db74">&#39;js-bukkenList&#39;</span>})
    apartments <span style="color:#f92672">=</span> summary<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#34;div&#34;</span>,{<span style="color:#e6db74">&#39;class&#39;</span>:<span style="color:#e6db74">&#39;cassetteitem&#39;</span>})

    <span style="color:#66d9ef">for</span> apartment <span style="color:#f92672">in</span> apartments:

        room_number <span style="color:#f92672">=</span> len(apartment<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;tbody&#39;</span>))

        name <span style="color:#f92672">=</span> apartment<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;div&#39;</span>, class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cassetteitem_content-title&#39;</span>)<span style="color:#f92672">.</span>text
        address <span style="color:#f92672">=</span> apartment<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;li&#39;</span>, class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cassetteitem_detail-col1&#39;</span>)<span style="color:#f92672">.</span>text

        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(room_number):
            names<span style="color:#f92672">.</span>append(name)
            addresses<span style="color:#f92672">.</span>append(address)

        sublocation <span style="color:#f92672">=</span> apartment<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;li&#39;</span>, class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cassetteitem_detail-col2&#39;</span>)
        cols <span style="color:#f92672">=</span> sublocation<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;div&#39;</span>)
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(cols)):
            text <span style="color:#f92672">=</span> cols[i]<span style="color:#f92672">.</span>find(text<span style="color:#f92672">=</span>True)
            <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(room_number):
                <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
                    locations0<span style="color:#f92672">.</span>append(text)
                <span style="color:#66d9ef">elif</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
                    locations1<span style="color:#f92672">.</span>append(text)
                <span style="color:#66d9ef">elif</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
                    locations2<span style="color:#f92672">.</span>append(text)

        age_and_height <span style="color:#f92672">=</span> apartment<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;li&#39;</span>, class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cassetteitem_detail-col3&#39;</span>)
        age <span style="color:#f92672">=</span> age_and_height(<span style="color:#e6db74">&#39;div&#39;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>text
        height <span style="color:#f92672">=</span> age_and_height(<span style="color:#e6db74">&#39;div&#39;</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>text

        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(room_number):
            ages<span style="color:#f92672">.</span>append(age)
            heights<span style="color:#f92672">.</span>append(height)

        table <span style="color:#f92672">=</span> apartment<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;table&#39;</span>)
        rows <span style="color:#f92672">=</span> []
        rows<span style="color:#f92672">.</span>append(table<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;tr&#39;</span>))

        data <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> rows:
            <span style="color:#66d9ef">for</span> tr <span style="color:#f92672">in</span> row:
                cols <span style="color:#f92672">=</span> tr<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;td&#39;</span>)
                <span style="color:#66d9ef">if</span> len(cols) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
                    _floor <span style="color:#f92672">=</span> cols[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>text
                    _floor <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>sub(<span style="color:#e6db74">&#39;[</span><span style="color:#ae81ff">\r\n\t</span><span style="color:#e6db74">]&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, _floor)

                    _rent_cell <span style="color:#f92672">=</span> cols[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;ul&#39;</span>)<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;li&#39;</span>)
                    _rent <span style="color:#f92672">=</span> _rent_cell[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;span&#39;</span>)<span style="color:#f92672">.</span>text
                    _admin <span style="color:#f92672">=</span> _rent_cell[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;span&#39;</span>)<span style="color:#f92672">.</span>text

                    _deposit_cell <span style="color:#f92672">=</span> cols[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;ul&#39;</span>)<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;li&#39;</span>)
                    _deposit <span style="color:#f92672">=</span> _deposit_cell[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;span&#39;</span>)<span style="color:#f92672">.</span>text
                    _reikin <span style="color:#f92672">=</span> _deposit_cell[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;span&#39;</span>)<span style="color:#f92672">.</span>text
                    _others <span style="color:#f92672">=</span> _deposit <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">+</span> _reikin

                    _floor_cell <span style="color:#f92672">=</span> cols[<span style="color:#ae81ff">5</span>]<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;ul&#39;</span>)<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;li&#39;</span>)
                    _floor_plan <span style="color:#f92672">=</span> _floor_cell[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;span&#39;</span>)<span style="color:#f92672">.</span>text
                    _area <span style="color:#f92672">=</span> _floor_cell[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;span&#39;</span>)<span style="color:#f92672">.</span>text

                    _detail_url <span style="color:#f92672">=</span> cols[<span style="color:#ae81ff">8</span>]<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;a&#39;</span>)[<span style="color:#e6db74">&#39;href&#39;</span>]
                    _detail_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://suumo.jp&#39;</span> <span style="color:#f92672">+</span> _detail_url

                    text <span style="color:#f92672">=</span> [_floor, _rent, _admin, _others, _floor_plan, _area, _detail_url]
                    data<span style="color:#f92672">.</span>append(text)

        <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> data:
            floors<span style="color:#f92672">.</span>append(row[<span style="color:#ae81ff">0</span>])
            rent<span style="color:#f92672">.</span>append(row[<span style="color:#ae81ff">1</span>])
            admin<span style="color:#f92672">.</span>append(row[<span style="color:#ae81ff">2</span>])
            others<span style="color:#f92672">.</span>append(row[<span style="color:#ae81ff">3</span>])
            floor_plans<span style="color:#f92672">.</span>append(row[<span style="color:#ae81ff">4</span>])
            areas<span style="color:#f92672">.</span>append(row[<span style="color:#ae81ff">5</span>])
            detail_urls<span style="color:#f92672">.</span>append(row[<span style="color:#ae81ff">6</span>])


        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">3</span>)

names <span style="color:#f92672">=</span> Series(names)
addresses <span style="color:#f92672">=</span> Series(addresses)
locations0 <span style="color:#f92672">=</span> Series(locations0)
locations1 <span style="color:#f92672">=</span> Series(locations1)
locations2 <span style="color:#f92672">=</span> Series(locations2)
ages <span style="color:#f92672">=</span> Series(ages)
heights <span style="color:#f92672">=</span> Series(heights)
floors <span style="color:#f92672">=</span> Series(floors)
rent <span style="color:#f92672">=</span> Series(rent)
admin <span style="color:#f92672">=</span> Series(admin)
others <span style="color:#f92672">=</span> Series(others)
floor_plans <span style="color:#f92672">=</span> Series(floor_plans)
areas <span style="color:#f92672">=</span> Series(areas)
detail_urls <span style="color:#f92672">=</span> Series(detail_urls)

suumo_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([names, addresses, locations0, locations1, locations2, ages, heights, floors, rent, admin, others, floor_plans, areas, detail_urls], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

suumo_df<span style="color:#f92672">.</span>columns<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;マンション名&#39;</span>,<span style="color:#e6db74">&#39;住所&#39;</span>,<span style="color:#e6db74">&#39;立地1&#39;</span>,<span style="color:#e6db74">&#39;立地2&#39;</span>,<span style="color:#e6db74">&#39;立地3&#39;</span>,<span style="color:#e6db74">&#39;築年数&#39;</span>,<span style="color:#e6db74">&#39;建物の高さ&#39;</span>,<span style="color:#e6db74">&#39;階層&#39;</span>,<span style="color:#e6db74">&#39;賃料料&#39;</span>,<span style="color:#e6db74">&#39;管理費&#39;</span>, <span style="color:#e6db74">&#39;敷/礼/保証/敷引,償却&#39;</span>,<span style="color:#e6db74">&#39;間取り&#39;</span>,<span style="color:#e6db74">&#39;専有面積&#39;</span>, <span style="color:#e6db74">&#39;詳細URL&#39;</span>]

suumo_df<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">&#39;suumo.csv&#39;</span>, sep <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf-16&#39;</span>, header<span style="color:#f92672">=</span>True, index<span style="color:#f92672">=</span>False)
</code></pre></div><p>10秒くらい経ってもエラーを吐かなければ成功しています。気長に待ちましょう。</p>
<p>このコードが何をやっているか、説明します。
ほとんどのWebページはHTMLという言語によって作成されています。
ではSUUMOのWebサイトの構造をChromeの検証ツールを利用して確認見てみましょう。
<img width="806" alt="スクリーンショット 2019-12-17 18.47.06.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/fda82167-e7af-1073-ee63-65a9a4b1e3e4.png"></p>
<p>以上を見てみると賃貸の名前には<code>cassetteitem_content-title</code>という目印が付いていることがわかります。
スクレイピングではこのようなHTMLに付いている目印の情報を利用してデータを取得しています。</p>
<p>なお、本当は東京の賃貸情報全てのデータを取得したいのですがとてつもない時間がかかってしまうため、今回は一区のみに絞って分析を行っていきます。</p>
<p>#データ分析編
おはようございます。
データが取得できていれば、スクレイピングを行ったノートブックと同じディレクトリに<code>suumo.csv</code>というファイルができているはずです。
<img width="1123" alt="スクリーンショット 2019-12-17 18.55.05.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/8f3e1cb8-03c4-96b7-4bff-33dcb5ce3cf2.png">
データは上のようになっています。
自分が初めて自分で大きなデータの取得に成功した時は**「おおおおおおお！！！すごい！！！」**と感動した記憶がありますが、皆さんはどうでしょうか。</p>
<p>このデータを用いてデータ分析を行っていくのですが、その前に機械学習モデルについて基礎的な概念を少し説明します。</p>
<p>###教師あり学習
今回行う学習は<strong>教師あり学習</strong>と言われる学習方法（データ分析方法）です。
Wikipediaによると</p>
<blockquote>
<p>事前に与えられたデータをいわば「例題（＝先生からの助言）」とみなして、それをガイドに学習（＝データへの何らかのフィッティング）を行うところからこの名がある。</p>
</blockquote>
<p>とのことです。いまいちピンとこないので具体例を考えてみましょう。This time, we will create a model that predicts the rental price from rental information.
We generally have the following knowledge about rent:</p>
<blockquote>
<p>The larger the area, the higher the rent
The closer to the station, the higher the rent
The smaller the building age, the higher the rent</p>
</blockquote>
<p>The reason I can have these knowledge is because I know such cases.
You can also predict the rent to some extent from this knowledge.</p>
<p>Machine learning is about letting machines do this.</p>
<p>The machine learns a lot of data, outputs the rent as a predicted value from the area, distance to the station, and age, and predicts the rent so that the difference between the predicted value and the actual rent (teacher data) becomes smaller. To do.</p>
<p>Also, as a term
The value output as a predicted value such as rent is the <em>objective variable</em>*
Information that characterizes the objective variable, such as area and building age
I call it.</p>
<h3 id="overlearning">Overlearning</h3>
<p>The biggest difficulty in machine learning is this <strong>over-learning</strong>.
Over-learning is &ldquo;to overfit to some data&rdquo;**.</p>
<p>Suppose you create a model that predicts rent by area. The image below is that image.
<img width="517" alt="Screenshots 2019-12-19 9.15.36.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/976399ca-27cf-bdfc-c748-2754ec3b2c40.png"></p>
<p>To make this error even smaller, let&rsquo;s complicate the model.
<img width="587" alt=" Screenshot 2019-12-19 9.15.42.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/58814839-e8c5-17e6-4c35-b41824e4ae00.png"></p>
<p>Wow! I can predict the rent perfectly with 100% accuracy!!!!&hellip; **I&rsquo;m not happy. **
Let&rsquo;s use this model to fit other data with similar distributions.
<img width="1066" alt="Screenshots 2019-12-19 9.18.26.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/9fccff9c-3737-b1ca-3600-28dd1b19a5e9.png"></p>
<p>The simple model on the left boasts about the same performance, while the complex model on the right clearly <strong>is failing to predict</strong>.</p>
<p>The goal of machine learning is generally to <strong>create the best-performing model for unknown datasets</strong>.
The model performance for this unknown data set is called <strong>generalization performance</strong>.</p>
<p>So how do you create a model with high generalization performance?
The easiest way is to <strong>split the data</strong> like the image below.
<img width="768" alt="Screenshots 2019-12-18 4.53.29.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/c7cce92b-a56c-1b52-7d86-eca17fba87a2.png">
Use the following procedure to measure generalization performance.</p>
<ol>
<li>Split the data into training and test data.</li>
<li>Create a model using <strong>learning data only</strong>.</li>
<li>Use the created model to fit <strong>test data</strong> and calculate the predicted value.</li>
<li>Measure the performance of the model using &ldquo;calculated predicted value&rdquo; and &ldquo;actual test data value (teacher data)&rdquo;</li>
</ol>
<p>In this machine learning part, 67% of the collected data is divided into learning data and the remaining 33% is divided into test data.</p>
<h2 id="pretreatment">Pretreatment</h2>
<p>This is, in fact, the part of most data analysis, which involves processing the data in a machine-readable manner.</p>
<p>For example, let&rsquo;s look at the age column (the name of the column).
<img width="150" alt="Screenshots 2019-12-17 19.15.41.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/6bf71566-95bc-ca70-1a79-03e9cdb2075d.png">
From this, we humans can recognize that &ldquo;the age of a building is `newly built &lt;7 years old &lt;21 years old&rdquo;**. You might take it for granted, but machines can&rsquo;t recognize this.
So
<strong>New construction → 0
7 years old → 7
21 years old → 21</strong>
It is necessary to process so that the machine can recognize [0&lt;7&lt;21].</p>
<p>In addition, the layout of 2LDK etc. is processed using <strong>one-hot encoding (dummy variable)</strong> and the nearest station etc. using <strong>Label encoding</strong>. (Please check if you are interested)</p>
<p>You may also need to deal with missing values. (I will not touch here because the missing value complement is swamp&hellip;)</p>
<p>The processing to be performed on the data before learning is generally called <strong>preprocessing</strong>.</p>
<p>Now let&rsquo;s actually execute the code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> OrdinalEncoder
<span style="color:#f92672">from</span> sklearn <span style="color:#f92672">import</span> preprocessing
<span style="color:#f92672">import</span> pandas_profiling <span style="color:#f92672">as</span> pdp

df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;suumo.csv&#39;</span>, sep<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf-16&#39;</span>)

splitted1 <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Location 1&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;Step&#39;</span>, expand<span style="color:#f92672">=</span>True)
splitted1<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;location 11&#39;</span>,<span style="color:#e6db74">&#39;location 12&#39;</span>]
splitted2 <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;location 2&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;step&#39;</span>, expand<span style="color:#f92672">=</span>True)
splitted2<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;location 21&#39;</span>,<span style="color:#e6db74">&#39;location 22&#39;</span>]
splitted3 <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;location 3&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;step&#39;</span>, expand<span style="color:#f92672">=</span>True)
splitted3<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;location 31&#39;</span>,<span style="color:#e6db74">&#39;location 32&#39;</span>]

splitted4 <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;layout/thanks/guarantee/layout, amortization&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;/&#39;</span>, expand<span style="color:#f92672">=</span>True)
splitted4<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;deposit&#39;</span>,<span style="color:#e6db74">&#39;key money&#39;</span>]

df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([df, splitted1, splitted2, splitted3, splitted4], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

df<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#39;location1&#39;</span>,<span style="color:#e6db74">&#39;location2&#39;</span>,<span style="color:#e6db74">&#39;location3&#39;</span>,<span style="color:#e6db74">&#39;layout/reliance/guarantee/layout, depreciation&#39;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, inplace<span style="color:#f92672">=</span>True)

df <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>dropna(subset<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;rent&#39;</span>]]

df[<span style="color:#e6db74">&#39;Rent&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Rent&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;10,000 Yen&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;security deposit&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;security deposit&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;10,000 yen&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;Key money&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Key money&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;10,000 yen&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;administration fee&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;administration fee&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;yen&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;age&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;age&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;new&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;0&#39;</span>)
df[<span style="color:#e6db74">&#39;age&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;age&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;99+&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;0&#39;</span>) <span style="color:#75715e">#</span>
df[<span style="color:#e6db74">&#39;age&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;age&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;build&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;age&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;age&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;year&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;Exclusive area&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Exclusive area&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;m&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;location12&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;location12&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;minute&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;location 22&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;location 22&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39; minutes&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;location32&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;location32&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;minute&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)

df[<span style="color:#e6db74">&#39;administration fee&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;administration fee&#39;</span>]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;-&#39;</span>,<span style="color:#ae81ff">0</span>)
df[<span style="color:#e6db74">&#39;deposit&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;deposit&#39;</span>]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;-&#39;</span>,<span style="color:#ae81ff">0</span>)
df[<span style="color:#e6db74">&#39;Key money&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Key money&#39;</span>]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;-&#39;</span>,<span style="color:#ae81ff">0</span>)

splitted5 <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;location 11&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;/&#39;</span>, expand<span style="color:#f92672">=</span>True)
splitted5<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;Route 1&#39;</span>,<span style="color:#e6db74">&#39;Station 1&#39;</span>]
splitted5[<span style="color:#e6db74">&#39;walk 1&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;location 12&#39;</span>]
splitted6 <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;location 21&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;/&#39;</span>, expand<span style="color:#f92672">=</span>True)
splitted6<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;Route 2&#39;</span>,<span style="color:#e6db74">&#39;Station 2&#39;</span>]
splitted6[<span style="color:#e6db74">&#39;Walk 2&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Location 22&#39;</span>]
splitted7 <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;location 31&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;/&#39;</span>, expand<span style="color:#f92672">=</span>True)
splitted7<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;Route 3&#39;</span>,<span style="color:#e6db74">&#39;Station 3&#39;</span>]
splitted7[<span style="color:#e6db74">&#39;Walk 3&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Location 32&#39;</span>]

df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([df, splitted5, splitted6, splitted7], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

df<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#39;location 11&#39;</span>,<span style="color:#e6db74">&#39;location 12&#39;</span>,<span style="color:#e6db74">&#39;location 21&#39;</span>,<span style="color:#e6db74">&#39;location 22&#39;</span>,<span style="color:#e6db74">&#39;location 31&#39;</span>,<span style="color:#e6db74">&#39;location 32&#39;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, inplace<span style="color:#f92672">=</span>True)

df[<span style="color:#e6db74">&#39;rental&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(df[<span style="color:#e6db74">&#39;rental&#39;</span>])
df[<span style="color:#e6db74">&#39;Administration fee&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(df[<span style="color:#e6db74">&#39;Administration fee&#39;</span>])
df[<span style="color:#e6db74">&#39;deposit&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(df[<span style="color:#e6db74">&#39;deposit&#39;</span>])
df[<span style="color:#e6db74">&#39;Key money&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(df[<span style="color:#e6db74">&#39;Key money&#39;</span>])
df[<span style="color:#e6db74">&#39;Age&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(df[<span style="color:#e6db74">&#39;Age&#39;</span>])
df[<span style="color:#e6db74">&#39;Exclusive area&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(df[<span style="color:#e6db74">&#39;Exclusive area&#39;</span>])

df[<span style="color:#e6db74">&#39;Rent&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Rent&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">10000</span>
df[<span style="color:#e6db74">&#39;deposit&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;deposit&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">10000</span>
df[<span style="color:#e6db74">&#39;Key money&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Key money&#39;</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">10000</span>

df[<span style="color:#e6db74">&#39;walk1&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(df[<span style="color:#e6db74">&#39;walk1&#39;</span>])
df[<span style="color:#e6db74">&#39;walk2&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(df[<span style="color:#e6db74">&#39;walk2&#39;</span>])
df[<span style="color:#e6db74">&#39;Walk 3&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(df[<span style="color:#e6db74">&#39;Walk 3&#39;</span>])

splitted8 <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;tier&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;-&#39;</span>, expand<span style="color:#f92672">=</span>True)
splitted8<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;Floor 1&#39;</span>,<span style="color:#e6db74">&#39;Floor 2&#39;</span>]
splitted8[<span style="color:#e6db74">&#39;floor 1&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;cp932&#39;</span>)
splitted8[<span style="color:#e6db74">&#39;floor1&#39;</span>] <span style="color:#f92672">=</span> splitted8[<span style="color:#e6db74">&#39;floor1&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;floor&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
splitted8[<span style="color:#e6db74">&#39;floor1&#39;</span>] <span style="color:#f92672">=</span> splitted8[<span style="color:#e6db74">&#39;floor1&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;B&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;-&#39;</span>)
splitted8[<span style="color:#e6db74">&#39;floor1&#39;</span>] <span style="color:#f92672">=</span> splitted8[<span style="color:#e6db74">&#39;floor1&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;M&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)splitted8[<span style="color:#e6db74">&#39;floor1&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(splitted8[<span style="color:#e6db74">&#39;floor1&#39;</span>])
df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([df, splitted8], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

df[<span style="color:#e6db74">&#39;building height&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;building height&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;underground 1 above ground&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;building height&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;building height&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;underground 2 above ground&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;building height&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;building height&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;underground 3 above ground&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;building height&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;building height&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;4 underground&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;building height&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;building height&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;5 underground&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;building height&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;building height&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;6 basements&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;building height&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;building height&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;underground 7 above ground&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;building height&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;building height&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;underground 8 above ground&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;building height&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;building height&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;underground 9 above ground&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;building height&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;building height&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;one-story&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;1&#39;</span>)
df[<span style="color:#e6db74">&#39;building height&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;building height&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;storey&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)
df[<span style="color:#e6db74">&#39;building height&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(df[<span style="color:#e6db74">&#39;building height&#39;</span>])

df <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span>True)
df[<span style="color:#e6db74">&#39;Floor DK&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
df[<span style="color:#e6db74">&#39;Floor K&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
df[<span style="color:#e6db74">&#39;Floor L&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
df[<span style="color:#e6db74">&#39;Floor S&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
df[<span style="color:#e6db74">&#39;floor&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;floor&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;room&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;1&#39;</span>)

<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(len(df)):
    <span style="color:#66d9ef">if</span><span style="color:#e6db74">&#39;DK&#39;</span> <span style="color:#f92672">in</span> df[<span style="color:#e6db74">&#39;Floor&#39;</span>][x]:
        df<span style="color:#f92672">.</span>loc[x,<span style="color:#e6db74">&#39;floor DK&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
df[<span style="color:#e6db74">&#39;floor&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;floor&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;DK&#39;</span>,<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)

<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(len(df)):
    <span style="color:#66d9ef">if</span><span style="color:#e6db74">&#39;K&#39;</span> <span style="color:#f92672">in</span> df [<span style="color:#e6db74">&#39;Floor&#39;</span>][x]:
        df<span style="color:#f92672">.</span>loc[x,<span style="color:#e6db74">&#39;Floor K&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
df[<span style="color:#e6db74">&#39;Floor&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;Floor&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;K&#39;</span>,<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)

<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(len(df)):
    <span style="color:#66d9ef">if</span><span style="color:#e6db74">&#39;L&#39;</span> <span style="color:#f92672">in</span> df [<span style="color:#e6db74">&#39;Floor&#39;</span>][x]:
        df<span style="color:#f92672">.</span>loc[x,<span style="color:#e6db74">&#39;Floor L&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
df[<span style="color:#e6db74">&#39;floor&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;floor&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;L&#39;</span>,<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)

<span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(len(df)):
    <span style="color:#66d9ef">if</span><span style="color:#e6db74">&#39;S&#39;</span> <span style="color:#f92672">in</span> df [<span style="color:#e6db74">&#39;Floor&#39;</span>][x]:
        df<span style="color:#f92672">.</span>loc[x,<span style="color:#e6db74">&#39;Floor S&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
df[<span style="color:#e6db74">&#39;floor&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;floor&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;S&#39;</span>,<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#39;</span>)

df[<span style="color:#e6db74">&#39;floor&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(df[<span style="color:#e6db74">&#39;floor&#39;</span>])

splitted9 <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;address&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;ward&#39;</span>, expand<span style="color:#f92672">=</span>True)
splitted9<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;ward&#39;</span>,<span style="color:#e6db74">&#39;city&#39;</span>]
splitted9[<span style="color:#e6db74">&#39;ku&#39;</span>] <span style="color:#f92672">=</span> splitted9[<span style="color:#e6db74">&#39;ku&#39;</span>] <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;ku&#39;</span>
splitted9[<span style="color:#e6db74">&#39;ward&#39;</span>] <span style="color:#f92672">=</span> splitted9[<span style="color:#e6db74">&#39;ward&#39;</span>]<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;Tokyo&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([df, splitted9], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

df_for_search <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>copy()

df[[<span style="color:#e6db74">&#39;Route 1&#39;</span>,<span style="color:#e6db74">&#39;Route 2&#39;</span>,<span style="color:#e6db74">&#39;Route 3&#39;</span>,<span style="color:#e6db74">&#39;Station 1&#39;</span>,<span style="color:#e6db74">&#39;Station 2&#39;</span>,<span style="color:#e6db74">&#39;Station 3&#39;</span>,<span style="color:#e6db74">&#39;Municipalities&#39;</span>]] <span style="color:#f92672">=</span> df[[<span style="color:#e6db74">&#39;Route 1&#39;</span>,<span style="color:#e6db74">&#39;Route 2&#39;</span> <span style="color:#e6db74">&#39;,&#39;</span>Route <span style="color:#ae81ff">3</span><span style="color:#e6db74">&#39;,&#39;</span>Station <span style="color:#ae81ff">1</span><span style="color:#e6db74">&#39;,&#39;</span>Station <span style="color:#ae81ff">2</span><span style="color:#e6db74">&#39;,&#39;</span>Station <span style="color:#ae81ff">3</span><span style="color:#e6db74">&#39;,&#39;</span>Municipalities<span style="color:#e6db74">&#39;]].fillna(&#34;NAN&#34;)</span>

oe <span style="color:#f92672">=</span> preprocessing<span style="color:#f92672">.</span>OrdinalEncoder()
df[[<span style="color:#e6db74">&#39;Route 1&#39;</span>,<span style="color:#e6db74">&#39;Route 2&#39;</span>,<span style="color:#e6db74">&#39;Route 3&#39;</span>,<span style="color:#e6db74">&#39;Station 1&#39;</span>,<span style="color:#e6db74">&#39;Station 2&#39;</span>,<span style="color:#e6db74">&#39;Station 3&#39;</span>,<span style="color:#e6db74">&#39;Municipalities&#39;</span>]] <span style="color:#f92672">=</span> oe<span style="color:#f92672">.</span>fit_transform(df[[<span style="color:#e6db74">&#39;Route 1&#39;</span> ,<span style="color:#e6db74">&#39;Route 2&#39;</span>,<span style="color:#e6db74">&#39;Route 3&#39;</span>,<span style="color:#e6db74">&#39;Station 1&#39;</span>,<span style="color:#e6db74">&#39;Station 2&#39;</span>,<span style="color:#e6db74">&#39;Station 3&#39;</span>,<span style="color:#e6db74">&#39;City&#39;</span>]]<span style="color:#f92672">.</span>values)

df[<span style="color:#e6db74">&#39;rent + management fee&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;rent&#39;</span>] <span style="color:#f92672">+</span> df[<span style="color:#e6db74">&#39;administration fee&#39;</span>]

<span style="color:#75715e"># Set maximum price</span>
df <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;rent + management fee&#39;</span>] <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">300000</span>]

df <span style="color:#f92672">=</span> df[[<span style="color:#e6db74">&#34;Apartment name&#34;</span>,<span style="color:#e6db74">&#39;Rent + Management fee&#39;</span>,<span style="color:#e6db74">&#39;Age&#39;</span>,<span style="color:#e6db74">&#39;Building height&#39;</span>,<span style="color:#e6db74">&#39;Floor 1&#39;</span>,
       <span style="color:#e6db74">&#39;Exclusive area&#39;</span>,<span style="color:#e6db74">&#39;Route 1&#39;</span>,<span style="color:#e6db74">&#39;Route 2&#39;</span>,<span style="color:#e6db74">&#39;Route 3&#39;</span>,<span style="color:#e6db74">&#39;Station 1&#39;</span>,<span style="color:#e6db74">&#39;Station 2&#39;</span>,<span style="color:#e6db74">&#39;Station 3&#39;</span>,<span style="color:#e6db74">&#39;Walk 1&#39;</span>,<span style="color:#e6db74">&#39;Walk 2&#39;</span>,<span style="color:#e6db74">&#39;Walk 3&#39;</span>, <span style="color:#e6db74">&#39;Floor&#39;</span>,<span style="color:#e6db74">&#39;Floor DK&#39;</span>,<span style="color:#e6db74">&#39;Floor K&#39;</span>,<span style="color:#e6db74">&#39;Floor L&#39;</span>,<span style="color:#e6db74">&#39;Floor S&#39;</span>,
       <span style="color:#e6db74">&#34;City&#34;</span>]]

df<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;name&#39;</span>,<span style="color:#e6db74">&#39;real_rent&#39;</span>,<span style="color:#e6db74">&#39;age&#39;</span>,<span style="color:#e6db74">&#39;hight&#39;</span>,<span style="color:#e6db74">&#39;level&#39;</span>,<span style="color:#e6db74">&#39;area&#39;</span>,<span style="color:#e6db74">&#39;route_1&#39;</span>,<span style="color:#e6db74">&#39;route_2&#39;</span>,<span style="color:#e6db74">&#39;route_3&#39;</span>,<span style="color:#e6db74">&#39;station_1&#39;</span>,<span style="color:#e6db74">&#39;station_2&#39;</span>,<span style="color:#e6db74">&#39; station_3&#39;</span>,<span style="color:#e6db74">&#39;distance_1&#39;</span>,<span style="color:#e6db74">&#39;distance_2&#39;</span>,<span style="color:#e6db74">&#39;distance_3&#39;</span>,<span style="color:#e6db74">&#39;room_number&#39;</span>,<span style="color:#e6db74">&#39;DK&#39;</span>,<span style="color:#e6db74">&#39;K&#39;</span>,<span style="color:#e6db74">&#39;L&#39;</span>,<span style="color:#e6db74">&#39;S&#39;</span>,<span style="color:#e6db74">&#39;adress&#39;</span>]


pdp<span style="color:#f92672">.</span>ProfileReport(df)
</code></pre></div><p>I will explain four points.
・Since it is determined that it is not necessary for analysis, information such as &ldquo;ward&rdquo; and &ldquo;detail url&rdquo; is not entered.
For example, this time I&rsquo;m doing in Bunkyo Ward, but all the data is in Bunkyo Ward, so that information will be worthless.
However, keep in mind that the information of &ldquo;ward&rdquo; is very important when analyzing all data of 23 wards of Tokyo, for example.</p>
<p>・The information of &ldquo;Security Deposit&rdquo; and &ldquo;Key Money&rdquo; is not entered. Contrary to the previous reason, this is because prediction is too easy (meaningless). In most rentals, the security deposit and key money are set equal to or two to three times the rent. Even if you say &ldquo;The rent for a key money of 70,000 yen is expected to be 70,000 yen!&rdquo;, you have nothing to gain&hellip;</p>
<p>・The objective variable is &ldquo;rent + administration fee&rdquo; instead of rent. The actual monthly payment is &ldquo;rent + management fee&rdquo;.
Furthermore, the data of the property whose rent + management cost exceeds 300,000 yen is the third row from the bottom.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">
df <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;rent + management fee&#39;</span>] <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">300000</span>]
</code></pre></div><p>Excluded.
I analyzed even without a rent upper limit and tried to find a good property, &ldquo;The estimated rent of this property is 2 million yen, but it is actually 1.5 million yen! What a profit of 500,000 yen a month!&rdquo; It made me feel sad. (I can&rsquo;t live in a house with a rent of 300,000 at all&hellip;) You can change the value here.</p>
<p>・Pandas-profiling is used for <strong>Exploratory Data Analysis (EDA)</strong>.
This is a library that I personally love.</p>
<p>From the whole information of the data&hellip;
<img width="673" alt="Screenshots 2019-12-17 20.06.56.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/e4ef3ec1-7ed5-c9dd-aa4a-e03d5bde9b4f.png">
Basic statistics for each variable,
<img width="598" alt="Screenshots 2019-12-17 20.07.09.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/72de0d0a-f28a-2c30-170e-a1bed8fe17e3.png">
It even displays the correlation coefficient matrix&hellip;
Too convenient&hellip;</p>
<img width="621" alt="Screenshots 2019-12-17 20.13.33.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/fd6e2d11-a525-5f93-ce58-5e25f681c0e9.png">
<p><strong>Added (2020/1/7)</strong>
<strong>Currently lightgbm does not seem to be able to use Japanese for feature names</strong></p>
<h2 id="feature-creation">Feature creation</h2>
<p>Now on to the part of feature quantity creation.
This is also included as preprocessing.</p>
<p>Here, we will create new features that will work (explaining explanatory variables well) from existing features.
For example in the code below
・Area per room, divided by the number of rooms
・The product of the type of the nearest station and the distance to the nearest station (the latter seems to have higher rent if it is a 5-minute walk to a minor station and a 5-minute station to a major station)
The feature quantity such as is created and added.</p>
<p>If you have a little experience with Python, please make an original feature quantity.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
df[<span style="color:#e6db74">&#34;per_area&#34;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#34;area&#34;</span>]<span style="color:#f92672">/</span>df[<span style="color:#e6db74">&#34;room_number&#34;</span>]
df[<span style="color:#e6db74">&#34;height_level&#34;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#34;height&#34;</span>]<span style="color:#f92672">*</span>df[<span style="color:#e6db74">&#34;level&#34;</span>]
df[<span style="color:#e6db74">&#34;area_height_level&#34;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#34;area&#34;</span>]<span style="color:#f92672">*</span>df[<span style="color:#e6db74">&#34;height_level&#34;</span>]
df[<span style="color:#e6db74">&#34;distance_staion_1&#34;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#34;station_1&#34;</span>]<span style="color:#f92672">*</span>df[<span style="color:#e6db74">&#34;distance_1&#34;</span>]
</code></pre></div><h2 id="machine-learning">Machine learning</h2>
<p>It&rsquo;s finally learning! ! !
We will create a price prediction model based on the shaped and created data.</p>
<p>The machine learning algorithm used here is <strong>lightgbm</strong>.
・High accuracy
・Processing is fast
It is said that it is the most major method in the competition that competes for the accuracy of machine learning. (In the offline competition where the time limit was tight before, the top 10 were all using this algorithm&hellip;!)</p>
<p>First, in terminal or command prompt</p>
<pre><code>conda install -c conda-forge lightgbm
</code></pre><p>Type in and install lightgbm.</p>
<p>Now let&rsquo;s run the code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> japanize_matplotlib
<span style="color:#f92672">import</span> lightgbm <span style="color:#f92672">as</span> lgb
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> train_test_split
<span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> LabelEncoder
<span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> mean_squared_error
<span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> r2_score

y <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#34;real_rent&#34;</span>]
X <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#39;real_rent&#39;</span>,<span style="color:#e6db74">&#34;name&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

X_train, X_test, y_train, y_test <span style="color:#f92672">=</span> train_test_split(X, y,test_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0.33</span>, random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)

lgb_train <span style="color:#f92672">=</span> lgb<span style="color:#f92672">.</span>Dataset(X_train, y_train)lgb_eval <span style="color:#f92672">=</span> lgb<span style="color:#f92672">.</span>Dataset(X_test, y_test, reference<span style="color:#f92672">=</span>lgb_train)

lgbm_params <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;objective&#39;</span>:<span style="color:#e6db74">&#39;regression&#39;</span>,
        <span style="color:#e6db74">&#39;metric&#39;</span>:<span style="color:#e6db74">&#39;rmse&#39;</span>,
        <span style="color:#e6db74">&#39;num_leaves&#39;</span>:<span style="color:#ae81ff">80</span>
}

model <span style="color:#f92672">=</span> lgb<span style="color:#f92672">.</span>train(lgbm_params, lgb_train, valid_sets<span style="color:#f92672">=</span>lgb_eval, verbose_eval<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)
    
y_pred <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(X_test, num_iteration<span style="color:#f92672">=</span>model<span style="color:#f92672">.</span>best_iteration)

<span style="color:#66d9ef">print</span>(r2_score(y_test, y_pred))
lgb<span style="color:#f92672">.</span>plot_importance(model, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">6</span>))
plt<span style="color:#f92672">.</span>show()
</code></pre></div><Results>
<img width="674" alt="Screenshots 2019-12-17 20.44.49.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/89e35f73-42ee-98d9-ce65-eba55ecdcfaa.png">
<p>I will add some explanation here as well.</p>
<ul>
<li>The resulting numbers show the accuracy of this <strong>model</strong>.
This index takes a value from 0 to 1, and the closer to <strong>1, the better</strong>.
From the index of &ldquo;0.945&rdquo; in my analysis this time, you can see that this model has high performance.
The image can be predicted with an accuracy of about 94%.</li>
</ul>
<p>・Feature_importance indicates the degree of importance of each feature.
After all, you can see that the occupied area and the building age are important.
~~ I&rsquo;m glad that the features I made by myself worked pretty well. ~~</p>
<h1 id="advantageous-property-search">Advantageous property search</h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">pred <span style="color:#f92672">=</span> list(model<span style="color:#f92672">.</span>predict(X, num_iteration<span style="color:#f92672">=</span>model<span style="color:#f92672">.</span>best_iteration))
pred <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(pred, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;predicted value&#34;</span>)
diff <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df[<span style="color:#e6db74">&#34;Rent + Management fee&#34;</span>]<span style="color:#f92672">-</span>pred,name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Difference from predicted value&#34;</span>)
df_search <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([df_for_search,diff,pred], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
df_search <span style="color:#f92672">=</span> df_search<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#34;Difference with predicted value&#34;</span>)
df_search <span style="color:#f92672">=</span> df_search[[<span style="color:#e6db74">&#34;Apartment name&#34;</span>,<span style="color:#e6db74">&#39;Rent + Management fee&#39;</span>,<span style="color:#e6db74">&#39;Forecast value&#39;</span>,<span style="color:#e6db74">&#39;Difference from forecast value&#39;</span>,<span style="color:#e6db74">&#39;Detail URL&#39;</span>]]
df_search<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">&#39;otoku.csv&#39;</span>, sep <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span>,encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf-16&#39;</span>)
</code></pre></div><p>Executing the above code will create the following csv file.
This code uses the created model to predict the rent for all properties and creates a table in which the difference is large, that is, sorted by profit.
In other words, in the created csv file, ** the higher it is, the more profitable it is.</p>
<img width="884" alt="Screenshots 2019-12-17 21.26.35.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/ff67a452-c930-d324-3ee0-5422522561f3.png">
For example, let's look at the property "A-standard Hongo 3-chome," which was the best deal in this model.
You can fly from the detail url on the right.
<img width="540" alt="Screenshots 2019-12-17 21.27.47.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/aaa15589-2ecf-790f-9bea-5599ca2572ea.png">
<img width="734" alt=" Screenshot 2019-12-17 21.35.16.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/b18de1a4-acd4-b185-bbf3-21ac6c8ae657.png">
<blockquote>
<p>3 minutes walk to the nearest station
2LDK
54㎡
7 years old
9th floor</p>
</blockquote>
<p>With this, 130,000 yen a month is certainly a good condition&hellip;
<strong>To say the least, I want to live in a mess&hellip;</strong>
Since the predicted value was 230,000 yen,
・Bunkyo Ward
・Within 10 years
・Within 10 minutes walk from the nearest station
・Area more than 45㎡
When you search with SUUMO by specifying the condition of, you can see that there are really about 20 to 230,000 properties, and this property is a good deal. (By the way, it wasn&rsquo;t an accident property either)</p>
<p>Please use this table to find a property!</p>
<p>#Actually&hellip;</p>
<p>In this chapter, we will talk about &ldquo;<strong>If you don&rsquo;t study machine learning, you will be easily tricked</strong>&rdquo;.
The table I just made seems very effective and wonderful.
<strong>But actually 67% of the information in that table is almost meaningless</strong>
In fact, there is a good chance that there is a better deal in that data than you think is the best deal right now.</p>
<p>The reason is that &ldquo;the model created using the training data is applied to the training data, so it cannot be recognized as a good deal.&rdquo;</p>
<p>In the first place, a profitable property is a property where (predicted value)-(actual price (teacher data)) becomes large. We estimated 230,000 yen for the condominium mentioned earlier, but it is actually 130,000 yen, and it can be said that it is worth 100,000 yen.
However, if we include this property in the learning data, we will calculate a predicted value that is almost the same as the actual price, &ldquo;I know that.&rdquo;
The point is that something like &ldquo;cheat&rdquo; is happening. It is the same as how difficult and special problems can be solved if you know the answer.
The purpose was &ldquo;Let&rsquo;s find an affordable property&rdquo;, so this issue is obviously quite bad.</p>
<p>In other words, <strong>do not include the data you want to predict in the training data</strong></p>
<p>By the way, as a solution, as shown in the image below, you can consider learning and prediction in several steps.
<img width="885" alt="Screenshots 2019-12-18 1.27.04.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/540234/8a48669f-c32a-1bae-88d3-3c43f3f862be.png"></p>
<p>Even if you think, &ldquo;I don&rsquo;t know what you mean,&rdquo; it&rsquo;s OK. Don&rsquo;t worry, it&rsquo;s a bit complicated.
In this chapter
<strong>If you don&rsquo;t have knowledge of data analysis, you can easily be fooled&hellip;</strong>
** Data analysis has a lot of depth **
I am writing it because I want to introduce that.</p>
<h1 id="at-the-end">At the end</h1>
<p>That concludes the content of this article.
Thank you so much for staying with us!
I would be very happy if you could feel the joy and dynamic of data analysis, and the fear and depth.
Analyzing data is important both to be happy and not to be unhappy.
Humans are weaker in numbers than they realize.
Also, if you want to study data analysis with this, we are introducing a self-study method in <a href="(https://haraso.hatenablog.com/entry/2019/09/03/211005)">different article</a> Please try to reference. It&rsquo;s a sequel.</p>
<p>#reference
<a href="http://www.analyze-world.com/entry/2017/10/09/062445">I tried to find a bargain rental property in Tokyo&rsquo;s 23 wards using machine learning</a>
Most of the scraping code was based on this person&rsquo;s code.
However, I fixed it because there were some places where I could not move with copy and paste as it was.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
