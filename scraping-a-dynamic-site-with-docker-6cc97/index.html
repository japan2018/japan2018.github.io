<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Scraping a dynamic site with Docker | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Scraping a dynamic site with Docker</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 13, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/selenium"> Selenium</a></code></small>


<small><code><a href="https://memotut.com/tags/scraping"> scraping</a></code></small>


<small><code><a href="https://memotut.com/tags/docker"> Docker</a></code></small>


<small><code><a href="https://memotut.com/tags/docker-compose"> docker-compose</a></code></small>

</p>
<pre><code>#Introduction
</code></pre>
<p>This is the 13th day article from Kinki University Advent Calendar 2019.</p>
<p>First of all, note that scraping is basically the last method you shouldn&rsquo;t do if you don&rsquo;t need it. This time, scraping Qiita&rsquo;s tag ranking, Qiita has an api and gets tag ranking there. There was no api to do (as of December 8, 2019) so I scraped it. If you can get the information you want with api, get it with api. Also, when scraping, wait on connection Give yourself some time and make some connections.</p>
<h2 id="things-necessary">Things necessary</h2>
<p>Docker</p>
<p>The version I am using is below.
<code>Docker version 19.03.5, build 633a0ea</code></p>
<h2 id="docker-composeyml">docker-compose.yml</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docekr-compsoe.yml" data-lang="docekr-compsoe.yml"><span style="color:#66d9ef">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>

<span style="color:#66d9ef">services</span>:
    <span style="color:#66d9ef">selenium-hub</span>:
        <span style="color:#66d9ef">image</span>: selenium/hub
        <span style="color:#66d9ef">container_name</span>: selenium-hub
        <span style="color:#66d9ef">ports</span>:
          -<span style="color:#e6db74">&#34;4444:4444&#34;</span>
      
    <span style="color:#66d9ef">chrome</span>:
        <span style="color:#66d9ef">image</span>: selenium/node-chrome-debug
        <span style="color:#66d9ef">depends_on</span>:
          -selenium-hub
        <span style="color:#66d9ef">environment</span>:
          -HUB_PORT_4444_TCP_ADDR=selenium-hub
          -HUB_PORT_4444_TCP_PORT=<span style="color:#ae81ff">4444</span>
    
    <span style="color:#66d9ef">python</span>:
        build:.
        <span style="color:#66d9ef">container_name</span>: python
        <span style="color:#66d9ef">volumes</span>:
            -.:/workspace
        <span style="color:#66d9ef">command</span>: /bin/bash
        <span style="color:#66d9ef">tty</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#66d9ef">stdin_open</span>: <span style="color:#66d9ef">true</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.7</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /workspace</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    selenium <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    beautifulsoup4<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><h3 id="dockerfile-and-compose-description">dockerfile and compose description</h3>
<p>I do not write what dokcer-compose or dockerfile is, so if you do not understand it <a href="https://qiita.com/niya1123/items/192b4f93878830c2ede5">I tried using Elixir&rsquo;s Phoenix and PostgreSQL on Docker</a> Please refer to that as it is written in detail.</p>
<p>Let&rsquo;s start with docker-compse.yml.</p>
<p>To scrape a dynamic site, I think it is currently a basic <code>Selenium</code> choice.</p>
<p>Create a container using the images <code>selenium/hub</code> and <code>selenium/node-chrome-debug</code>.
Here, <code>environment</code> is set in <code>selenium/node-chrome-debug</code>. Please note that scraping cannot be done without this.</p>
<p>The Dockerfile is building the python environment.The necessary library is downloaded with the <code>RUN</code> command.</p>
<p>If you place these files and the code below in the same layer and execute <code>docker-compose up -d --build</code>, the container will start up.</p>
<h2 id="code-example">Code example</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> selenium <span style="color:#f92672">import</span> webdriver
<span style="color:#f92672">from</span> selenium.webdriver.common.desired_capabilities <span style="color:#f92672">import</span> DesiredCapabilities
<span style="color:#f92672">from</span> selenium.webdriver.support <span style="color:#f92672">import</span> expected_conditions <span style="color:#66d9ef">as</span> EC
<span style="color:#f92672">from</span> selenium.webdriver.support.ui <span style="color:#f92672">import</span> WebDriverWait
<span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
<span style="color:#f92672">import</span> pprint

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">QiitaGetRanking</span>():
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    A class that acquires ranking data from Qiita.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_tag_ranking</span>(self, browser: webdriver) <span style="color:#f92672">-&gt;</span> dict:
        <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">        A function to get information about tag ranking from Qiita.
</span><span style="color:#e6db74">        
</span><span style="color:#e6db74">        Parameters
</span><span style="color:#e6db74">        ----------
</span><span style="color:#e6db74">        browser: webdrive
</span><span style="color:#e6db74">            Webdriver object for scraping
</span><span style="color:#e6db74">        
</span><span style="color:#e6db74">        Returns
</span><span style="color:#e6db74">        -------
</span><span style="color:#e6db74">        tag_ranking_data: dict
</span><span style="color:#e6db74">            A dictionary object containing tag rankings.
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        html <span style="color:#f92672">=</span> browser<span style="color:#f92672">.</span>page_source<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
        soup <span style="color:#f92672">=</span> BeautifulSoup(html, <span style="color:#e6db74">&#34;html.parser&#34;</span>)
        ra_tag_names <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ra-Tag_name pr-1&#39;</span>)
        tag_ranking_data <span style="color:#f92672">=</span> {}
        <span style="color:#66d9ef">for</span> i, ra_tag_name <span style="color:#f92672">in</span> enumerate(ra_tag_names):
            tag_ranking_data[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> [ra_tag_name<span style="color:#f92672">.</span>text,
            <span style="color:#e6db74">&#39;https://qiita.com/tags/</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">%</span>(ra_tag_name<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>lower())]
        <span style="color:#66d9ef">return</span> tag_ranking_data

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    main sentence.The browser should be closed as soon as the html is acquired. The same applies when an error occurs.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    
    <span style="color:#66d9ef">try</span>:
        browser <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Remote(
            command_executor<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;http://selenium-hub:4444/wd/hub&#39;</span>,
            desired_capabilities<span style="color:#f92672">=</span>DesiredCapabilities<span style="color:#f92672">.</span>CHROME)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;start scrape&#34;</span>)
        browser<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;https://qiita.com&#39;</span>)
        <span style="color:#75715e">#Wait until all javascript is read.If it does not finish loading after 15 seconds, it will be judged as timeout.</span>
        WebDriverWait(browser, <span style="color:#ae81ff">15</span>)<span style="color:#f92672">.</span>until(EC<span style="color:#f92672">.</span>presence_of_all_elements_located)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;generate object&#34;</span>)
        qgr <span style="color:#f92672">=</span> QiitaGetRanking()
        ranking_data <span style="color:#f92672">=</span> qgr<span style="color:#f92672">.</span>get_tag_ranking(browser)
        browser<span style="color:#f92672">.</span>close()
        browser<span style="color:#f92672">.</span>quit()
        pprint<span style="color:#f92672">.</span>pprint(ranking_data)
    <span style="color:#66d9ef">except</span>:
        browser<span style="color:#f92672">.</span>close()
        browser<span style="color:#f92672">.</span>quit()
</code></pre></div><p>I think the code is very simple.When scraping with docker, building a selenium server and scraping is easier and lighter than building a selenium environment on ubuntu.</p>
<p>For webdrriver.Remote, refer to <a href="https://kurozumi.github.io/selenium-python/getting-started.html#using-selenium-with-remote-webdriver">2.5. Using Selenium with remote WebDriver</a>. Please try.</p>
<h2 id="execution-result">Execution result</h2>
<p>Make sure that 3 containers are built with <code>docker ps</code>, then execute the program with <code>docker exec -it python python qiita.py</code>.</p>
<pre><code>start scrape
generate object
{1: ['Python','https://qiita.com/tags/python'],
 2: ['JavaScript','https://qiita.com/tags/javascript'],
 3: ['AWS','https://qiita.com/tags/aws'],
 4: ['Rails','https://qiita.com/tags/rails'],
 5: ['Ruby','https://qiita.com/tags/ruby'],
 6: ['Beginner','https://qiita.com/tags/Beginner'],
 7: ['Docker','https://qiita.com/tags/docker'],
 8: ['PHP','https://qiita.com/tags/php'],
 9: ['Vue.js','https://qiita.com/tags/vue.js'],
 10: ['Go','https://qiita.com/tags/go']}
</code></pre><p>If you see something like this, you&rsquo;re a complete win.</p>
<h1 id="at-the-end">at the end</h1>
<p>This time, I showed you how to scrape a dynamic site using Docker. Let&rsquo;s enjoy scraping within the limits!</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
