<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>I tried to develop a Formatter that outputs Python log in JSON | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>I tried to develop a Formatter that outputs Python log in JSON</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 2, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/json">JSON</a></code></small>

</p>
<pre><code>I usually use Python mainly, but structural data is more convenient when setting up a log collection/analysis infrastructure for cloud services. However, using the normal logging formatter in Python's standard library, you have to convert it once into structured data. It's nogure to create another application just to convert.
</code></pre>
<p>Therefore, I tried to develop a Formatter that outputs the log in JSON.</p>
<p>#Environment</p>
<ul>
<li>
<p>OS (guaranteed operation)
-MacOS Catalina
-Ubuntu 18.04</p>
</li>
<li>
<p>Language
-Python ^3.7</p>
</li>
<li>
<p>Package manager
-Poetry</p>
</li>
<li>
<p>Library
-Standard library only</p>
</li>
<li>
<p>Development library
-Black
-Pytest
-Flake8</p>
</li>
</ul>
<h1 id="artifact">Artifact</h1>
<p>The developed Formatter is in <a href="https://github.com/homoluctus/json-pyformatter">homoluctus/json-pyformatter</a>.
Also published on PyPI -&gt; <a href="https://pypi.org/project/json-pyformatter/">json-pyformatter 0.1.0</a></p>
<h2 id="how-to-use">how to use</h2>
<h3 id="1-installation">1. Installation</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pip install json-pyformatter
</code></pre></div><h3 id="2-example">2. Example</h3>
<p>The field that can be output is <a href="https://docs.python.org/3/library/logging.html#logrecord-attributes">logrecord-attributes</a> of standard library Logging.
The default fields output by the developed Formatter are <code>asctime</code>, <code>levelname</code>, and <code>message</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> logging
<span style="color:#f92672">from</span> json_pyformmatter <span style="color:#f92672">import</span> JsonFormatter

logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(__name__)
logger<span style="color:#f92672">.</span>setLevel(logging<span style="color:#f92672">.</span>INFO)
handler <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>StreamHandler()
fields <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;levelname&#39;</span>,<span style="color:#e6db74">&#39;filename&#39;</span>,<span style="color:#e6db74">&#39;message&#39;</span>)
formatter <span style="color:#f92672">=</span> JsonFormatter(fields<span style="color:#f92672">=</span>fields)
handler<span style="color:#f92672">.</span>setFormatter(formatter)
logger<span style="color:#f92672">.</span>addHandler(hander)

logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;hello&#39;</span>)
</code></pre></div><p>When you execute this, JSON log will be output as below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;levelname&#34;</span>: <span style="color:#e6db74">&#34;INFO&#34;</span>, <span style="color:#e6db74">&#34;filename&#34;</span>: <span style="color:#e6db74">&#34;test_formatter.py&#34;</span>, <span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;hello&#34;</span><span style="color:#f92672">}</span>
</code></pre></div><p>Also, if you specify <code>indent=2</code> as an argument of JsonFormatter, it will be easier to see.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;levelname&#34;</span>: <span style="color:#e6db74">&#34;INFO&#34;</span>,
  <span style="color:#e6db74">&#34;filename&#34;</span>: <span style="color:#e6db74">&#34;test_formatter.py&#34;</span>,
  <span style="color:#e6db74">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;hello&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Of course you can also output traceback. It is hard to see if it is one line, so it is arranged.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#39;asctime&#39;</span>: <span style="color:#e6db74">&#39;2019-12-01 13:58:34&#39;</span>,
  <span style="color:#e6db74">&#39;levelname&#39;</span>:<span style="color:#e6db74">&#39;ERROR&#39;</span>,
  <span style="color:#e6db74">&#39;message&#39;</span>:<span style="color:#e6db74">&#39;error occurred !!&#39;</span>,
  <span style="color:#e6db74">&#39;traceback&#39;</span>: <span style="color:#f92672">[</span>
    <span style="color:#e6db74">&#39;Traceback (most rec...ll last):&#39;</span>,
    <span style="color:#e6db74">&#39;File &#34;/example/test..._exc_info&#39;</span>,
    <span style="color:#e6db74">&#39;raise TypeError(message)&#39;</span>,
    <span style="color:#e6db74">&#39;TypeError: error occurred !!&#39;</span>
  <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
</code></pre></div><h1 id="source-code-explanation">Source code explanation</h1>
<p>From here, I will explain the source code.</p>
<h2 id="all-source-code">All source code</h2>
<p>I will write the whole source code for the time being.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> json
<span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> OrderedDict
<span style="color:#f92672">from</span> logging <span style="color:#f92672">import</span> Formatter


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JsonFormatter</span>(Formatter):
    default_fields <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;asctime&#39;</span>,<span style="color:#e6db74">&#39;levelname&#39;</span>,<span style="color:#e6db74">&#39;message&#39;</span>)

    <span style="color:#66d9ef">def</span> __init__(self, fields<span style="color:#f92672">=</span>None, datefmt<span style="color:#f92672">=</span>None, indent<span style="color:#f92672">=</span>None):
        <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">        Args:
</span><span style="color:#e6db74">            fields (tuple, list)
</span><span style="color:#e6db74">            datefmt (str)
</span><span style="color:#e6db74">            indent (str, int)
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>

        self<span style="color:#f92672">.</span>fields <span style="color:#f92672">=</span> (
            self<span style="color:#f92672">.</span>get_or_none(fields, (list, tuple)) <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>default_fields
        )
        <span style="color:#75715e"># default time format is %Y-%m-%d %H:%M:%S</span>
        self<span style="color:#f92672">.</span>datefmt <span style="color:#f92672">=</span> (
            self<span style="color:#f92672">.</span>get_or_none(datefmt, str) <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>default_time_format
        )
        self<span style="color:#f92672">.</span>_indent <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_or_none(indent, (str, int))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_or_none</span>(self, target, types):
        <span style="color:#e6db74">&#34;&#34;&#34;Check whether target value is expected type.
</span><span style="color:#e6db74">        If target type does not match expected type, returns None.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Args:
</span><span style="color:#e6db74">            target (any)
</span><span style="color:#e6db74">            types (class, tuple)
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Returns:
</span><span style="color:#e6db74">            target or None
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>

        <span style="color:#66d9ef">if</span> isinstance(target, types):
            <span style="color:#66d9ef">return</span> target
        <span style="color:#66d9ef">return</span> None

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getMessage</span>(self, record):
        <span style="color:#66d9ef">if</span> isinstance(record<span style="color:#f92672">.</span>msg, (list, tuple, dict)):
            <span style="color:#66d9ef">return</span> record<span style="color:#f92672">.</span>msg
        <span style="color:#66d9ef">return</span> record<span style="color:#f92672">.</span>getMessage()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_format_json</span>(self, record):
        <span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>dumps(record, ensure_ascii<span style="color:#f92672">=</span>False, indent<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>_indent)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_format</span>(self, record):
        log <span style="color:#f92672">=</span> OrderedDict()

        <span style="color:#66d9ef">try</span>:
            <span style="color:#66d9ef">for</span> field <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>fields:
                log[field] <span style="color:#f92672">=</span> getattr(record, field)
            <span style="color:#66d9ef">return</span> log
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">AttributeError</span> <span style="color:#66d9ef">as</span> err:
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(f<span style="color:#e6db74">&#39;Formatting field not found in log record {err}&#39;</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">format</span>(self, record):
        record<span style="color:#f92672">.</span>message <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>getMessage(record)
        record<span style="color:#f92672">.</span>asctime <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>formatTime(record, self<span style="color:#f92672">.</span>datefmt)
        formatted_record <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_format(record)
        <span style="color:#66d9ef">if</span> record<span style="color:#f92672">.</span>exc_info:
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> record<span style="color:#f92672">.</span>exc_text:
                record<span style="color:#f92672">.</span>exc_text <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>formatException(record<span style="color:#f92672">.</span>exc_info)
        <span style="color:#66d9ef">if</span> record<span style="color:#f92672">.</span>exc_text:
            formatted_record[<span style="color:#e6db74">&#39;traceback&#39;</span>] <span style="color:#f92672">=</span> [
                msg<span style="color:#f92672">.</span>strip() <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> record<span style="color:#f92672">.</span>exc_text<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
            ]
        <span style="color:#66d9ef">if</span> record<span style="color:#f92672">.</span>stack_info:
            formatted_record[<span style="color:#e6db74">&#39;stack&#39;</span>] <span style="color:#f92672">=</span> record<span style="color:#f92672">.</span>stack_info<span style="color:#f92672">.</span>strip()

        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_format_json(formatted_record)
</code></pre></div><h2 id="get_or_none">get_or_none</h2>
<p>The method used when creating an instance.
If it is not the expected type, use the default value or just assign None.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_or_none</span>(self, target, types):
    <span style="color:#e6db74">&#34;&#34;&#34;Check whether target value is expected type.
</span><span style="color:#e6db74">    If target type does not match expected type, returns None.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Args:
</span><span style="color:#e6db74">       target (any)
</span><span style="color:#e6db74">       types (class, tuple)
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">        target or None
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>

    <span style="color:#66d9ef">if</span> isinstance(target, types):
        <span style="color:#66d9ef">return</span> target
    <span style="color:#66d9ef">return</span> None
</code></pre></div><h2 id="getmessage">getMessage</h2>
<p>It is a method to get the message of the argument of logger.info(). The return value of this getMessage is set in the JSON <code>message</code> field.
If the instance type of record.msg is (list, tuple, dict), it is returned as it is, otherwise, the return value of the getMessage method of the record instance is returned. By doing so, when any of (list, tuple, dict) is passed, the log can be output as a JSON array/object.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getMessage</span>(self, record):
    <span style="color:#66d9ef">if</span> isinstance(record<span style="color:#f92672">.</span>msg, (list, tuple, dict)):
        <span style="color:#66d9ef">return</span> record<span style="color:#f92672">.</span>msg
    <span style="color:#66d9ef">return</span> record<span style="color:#f92672">.</span>getMessage()<span style="color:#e6db74">``</span><span style="color:#960050;background-color:#1e0010">`</span>

<span style="color:#75715e">## \_format\_json</span>
This method dumps the argument record <span style="color:#66d9ef">as</span> JSON<span style="color:#f92672">.</span>

<span style="color:#e6db74">``</span><span style="color:#960050;background-color:#1e0010">`</span>python
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_format_json</span>(self, record):
    <span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>dumps(record, ensure_ascii<span style="color:#f92672">=</span>False, indent<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>_indent)
</code></pre></div><h2 id="_format">_format</h2>
<p>This is a method to convert record into a Python dictionary.
The fields specified by the user are not always present in the record attributes, so they are <code>try-except</code>. The log value returned is set to <code>OrderedDict</code> to guarantee the order.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_format</span>(self, record):
    log <span style="color:#f92672">=</span> OrderedDict()

    <span style="color:#66d9ef">try</span>:
        <span style="color:#66d9ef">for</span> field <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>fields:
            log[field] <span style="color:#f92672">=</span> getattr(record, field)
        <span style="color:#66d9ef">return</span> log
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">AttributeError</span> <span style="color:#66d9ef">as</span> err:
        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(f<span style="color:#e6db74">&#39;Formatting field not found in log record {err}&#39;</span>)
</code></pre></div><h2 id="format">format</h2>
<p>This method is called from logging.Handler. I don&rsquo;t think that you will create a Formatter yourself and use the format of the parent class (logging.Formatter), so be sure to overwrite this method.
Format the record.exc_text to output the traceback as an array. After removing extra spaces, etc., it is split into new lines to form an array.
Finally, I&rsquo;m dumping a Python dict as JSON.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">format</span>(self, record):
    record<span style="color:#f92672">.</span>message <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>getMessage(record)
    record<span style="color:#f92672">.</span>asctime <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>formatTime(record, self<span style="color:#f92672">.</span>datefmt)
    formatted_record <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_format(record)
    <span style="color:#66d9ef">if</span> record<span style="color:#f92672">.</span>exc_info:
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> record<span style="color:#f92672">.</span>exc_text:
            record<span style="color:#f92672">.</span>exc_text <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>formatException(record<span style="color:#f92672">.</span>exc_info)
    <span style="color:#66d9ef">if</span> record<span style="color:#f92672">.</span>exc_text:
        formatted_record[<span style="color:#e6db74">&#39;traceback&#39;</span>] <span style="color:#f92672">=</span> [
            msg<span style="color:#f92672">.</span>strip() <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> record<span style="color:#f92672">.</span>exc_text<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
        ]
    <span style="color:#66d9ef">if</span> record<span style="color:#f92672">.</span>stack_info:
        formatted_record[<span style="color:#e6db74">&#39;stack&#39;</span>] <span style="color:#f92672">=</span> record<span style="color:#f92672">.</span>stack_info<span style="color:#f92672">.</span>strip()

    <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_format_json(formatted_record)
</code></pre></div><p>#References</p>
<ul>
<li><a href="https://docs.python.org/3/library/logging.html">logging &mdash; Logging function for Python</a></li>
<li><a href="https://github.com/python/cpython/blob/3.7/Lib/logging/__init__.py">logging/__init__.py</a></li>
</ul>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
