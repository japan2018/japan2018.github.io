<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] If not, let&#39;s create one, something like AWS Chatbot for Microsoft Teams | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] If not, let&rsquo;s create one, something like AWS Chatbot for Microsoft Teams</h1>
<p>
  <small class="text-secondary">
  
  
  Mar 9, 2020
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/aws">AWS</a></code></small>


<small><code><a href="https://memotut.com/tags/office365">Office365</a></code></small>


<small><code><a href="https://memotut.com/tags/chatbot">chatbot</a></code></small>


<small><code><a href="https://memotut.com/tags/teams">Teams</a></code></small>

</p>
<pre><code>## What is AWS Chatbot
</code></pre>
<p><a href="https://aws.amazon.com/jp/chatbot/">https://aws.amazon.com/jp/chatbot/</a></p>
<p>Roughly speaking, you can notify Slack and Amazon Chime of events that occurred on AWS, and operate with slash commands.</p>
<p>At the time of writing this article, it is a beta version, so <em><strong>1.10 Beta of <a href="https://d1.awsstatic.com/legal/awsserviceterms/AWS%20Service%20Terms%20-%20Japanese%20Translation.pdf">this document</a> In accordance with Service Participation</strong></em>, we will not make any further reference.</p>
<h2 id="background">background</h2>
<p>At the moment, it&rsquo;s only for Slack and Amazon Chime, so we&rsquo;re going to make something like AWS Chatbot for Microsoft Teams.</p>
<p>Hoping that it will be adopted when the beta is off&hellip;</p>
<h2 id="recipe">recipe</h2>
<h3 id="character">Character</h3>
<ul>
<li>Microsoft Teams</li>
<li>AWS Lambda</li>
<li>Amazon SNS</li>
<li>Amazon CloudWatch</li>
</ul>
<p>If you want to implement something like Slash&rsquo;s slash command, you can also use Amazon API Gateway.</p>
<h3 id="microsoft-teams-settings">Microsoft Teams settings</h3>
<p>Set to receive notifications from AWS.
Click [&hellip;] to the right of the channel for the team you want to receive notifications for.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/35d60d89-929b-8136-cd6c-6b17b0745084.png" alt="image.png"></p>
<p>Then, the following menu is displayed. Click [Connector].
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/67dce720-6611-def0-9573-cafda005eb0e.png" alt="image.png"></p>
<p>When the list of connectors is displayed, click the [Incoming Webhook] configuration button.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/de02513f-59bf-3609-44cd-140472a4a661.png" alt="image.png"></p>
<p>Then give it an arbitrary name.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/518944ed-03be-9aea-3abb-63aea6e5535b.png" alt="image.png"></p>
<p>Finally upload an image if you like and click the &ldquo;Create&rdquo; button
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/f0221879-9e81-0bc5-6656-db83525bb981.png" alt="image.png"></p>
<p>When the creation is complete, a URL for receiving notifications from AWS will be generated, so copy it and make a note of it. When you are finished, click the [Finish] button to close.
You will use this URL in subsequent code on AWS Lambda.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/0762fdcb-6248-9864-4c66-d529417d1f8f.png" alt="image.png"></p>
<p>If you forget to write down the URL, you can go back to the connector&rsquo;s screen and follow &ldquo;Configured&rdquo; on the left.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/55b8a8f7-c860-1a56-57c0-b9cd4cfcda7b.png" alt="image.png"></p>
<p>The following articles will be posted on the channel where the connector was created.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/9930086e-1c28-6b4b-eaed-5bd01bf20596.png" alt="image.png"></p>
<h3 id="code-on-aws-lambda">Code on AWS Lambda</h3>
<ul>
<li>This time, it is a sample that receives the alarm of CloudWatch metric and sends it to Microsoft Teams.</li>
<li><strong>PIL</strong>(pillow) and <strong>requests</strong> are used as modules that are not included in Lambda.
*Please arrange appropriately.</li>
<li>Operation has been confirmed with Python 3.8.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:lambda_function.py" data-lang="python:lambda_function.py"><span style="color:#f92672">import</span> boto3
<span style="color:#f92672">import</span> json
<span style="color:#f92672">import</span> io
<span style="color:#f92672">import</span> base64
<span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
<span style="color:#f92672">from</span> io <span style="color:#f92672">import</span> BytesIO
<span style="color:#f92672">import</span> requests

teams_endpoint <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Specify the URL saved in the Microsoft Teams settings&#39;</span>
<span style="color:#75715e"># Please use KMS to encrypt the URL as necessary, or use the environment variable function.</span>
                  
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lambda_handler</span>(event, context):
    subjet <span style="color:#f92672">=</span> event[<span style="color:#e6db74">&#39;Records&#39;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;Sns&#39;</span>][<span style="color:#e6db74">&#39;Subject&#39;</span>]
    
    <span style="color:#75715e"># Since the text below the Message element in Json sent by SNS is a String, read it as Json</span>
    message <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(event[<span style="color:#e6db74">&#39;Records&#39;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;Sns&#39;</span>][<span style="color:#e6db74">&#39;Message&#39;</span>])
    
    newStateReason <span style="color:#f92672">=</span> message[<span style="color:#e6db74">&#39;NewStateReason&#39;</span>]
    newStateValue <span style="color:#f92672">=</span> message[<span style="color:#e6db74">&#39;NewStateValue&#39;</span>]
    nameSpace <span style="color:#f92672">=</span> message[<span style="color:#e6db74">&#39;Trigger&#39;</span>][<span style="color:#e6db74">&#39;Namespace&#39;</span>]
    metricName <span style="color:#f92672">=</span> message[<span style="color:#e6db74">&#39;Trigger&#39;</span>][<span style="color:#e6db74">&#39;MetricName&#39;</span>]
    topicName <span style="color:#f92672">=</span> event[<span style="color:#e6db74">&#39;Records&#39;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;Sns&#39;</span>][<span style="color:#e6db74">&#39;TopicArn&#39;</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;:&#39;</span>)[<span style="color:#ae81ff">5</span>]
    resourceId <span style="color:#f92672">=</span> message[<span style="color:#e6db74">&#39;Trigger&#39;</span>][<span style="color:#e6db74">&#39;Dimensions&#39;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;value&#39;</span>]
    resourceType <span style="color:#f92672">=</span> message[<span style="color:#e6db74">&#39;Trigger&#39;</span>][<span style="color:#e6db74">&#39;Dimensions&#39;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;name&#39;</span>]
    
    <span style="color:#75715e"># Create content to post on Microsoft Teams</span>
    text <span style="color:#f92672">=</span> []
    text<span style="color:#f92672">.</span>append(newStateReason)
    text<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>)
    text<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#34;**Alarm State:** {0} 　**Name Space:**: {1}&#34;</span><span style="color:#f92672">.</span>format(newStateValue, nameSpace))
    text<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#34;**Metric:** {0} ‥**Topic Name:** {1}&#34;</span><span style="color:#f92672">.</span>format(metricName, topicName))
    text<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>)
    
    <span style="color:#75715e"># Get the target metric image</span>
    cw <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74">&#39;cloudwatch&#39;</span>)
    widget <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">            &#34;view&#34;: &#34;timeSeries&#34;,</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">            &#34;stacked&#34;: false,</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">            &#34;metrics&#34;: [</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">                [&#34;&#39;</span><span style="color:#f92672">+</span> nameSpace <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;&#34;, &#34;&#39;</span><span style="color:#f92672">+</span> metricName <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;&#34;, &#34;&#39;</span><span style="color:#f92672">+</span> resourceType <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;&#34;, &#34;&#39;</span><span style="color:#f92672">+</span> resourceId <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;&#34; ]</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">            ], </span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">            &#34;width&#34;: 480,</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">            &#34;height&#34;: 180,</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">            &#34;start&#34;: &#34;-PT2H&#34;,</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">            &#34;end&#34;: &#34;P0D&#34;,</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">            &#34;timezone&#34;: &#34;+0900&#34;</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#e6db74">        }&#39;</span>

    response <span style="color:#f92672">=</span> cw<span style="color:#f92672">.</span>get_metric_widget_image(MetricWidget <span style="color:#f92672">=</span> widget)
    img <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(BytesIO(response[<span style="color:#e6db74">&#34;MetricWidgetImage&#34;</span>]))

    <span style="color:#75715e"># Store images in memory</span>
    buffer <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>BytesIO()
    img<span style="color:#f92672">.</span>save(buffer,<span style="color:#e6db74">&#34;PNG&#34;</span>)
    
    <span style="color:#75715e"># Base64 encode the image saved in memory</span>
    imgBase64 <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64encode(buffer<span style="color:#f92672">.</span>getvalue())<span style="color:#f92672">.</span>decode()<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;&#39;&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
    
    <span style="color:#75715e">#BASE64 encoded string added to content sent to Microsoft Teams</span>
    text<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#34;![Chart](data:image/png;base64,{0})&#34;</span><span style="color:#f92672">.</span>format(imgBase64))
    
    <span style="color:#75715e"># Prepare for sending to Microsoft Teams</span>
    request <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;title&#39;</span>: subjet,
        <span style="color:#e6db74">&#39;text&#39;</span>:<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(text)
        }
    
    <span style="color:#75715e">#Send to Microsoft Teams</span>
    response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(teams_endpoint, json<span style="color:#f92672">.</span>dumps(request))
</code></pre></div><h3 id="amazon-sns-settings">Amazon SNS settings</h3>
<h4 id="create-topic">Create topic</h4>
<p>Display the Amazon SNS screen and click the [Create Topic] button.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/0870250d-2ca7-2a78-7646-1a2f2635c894.png" alt="image.png">
Specify a name or display name. Make any other required settings and click the [Create Topic] button.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/12543eca-431f-0714-4860-490ae63f541d.png" alt="image.png"></p>
<h4 id="create-subscription">Create Subscription</h4>
<p>When the topic creation is complete, the following screen will be displayed. Click the [Create subscription] button.<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/a2e023c1-2bf9-79c7-92f1-89c6c0bc8ab8.png" alt="image.png">
Select AWS Lambda as the protocol.
Then, specify the Lambda function of AWS Lambda that you created earlier on the endpoint, configure other settings as necessary, and click the [Create subscription] button.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/dca455ca-bf04-d9c3-3217-4db4e1c6e478.png" alt="image.png"></p>
<h3 id="amazon-cloudwatch-alarm-settings">Amazon CloudWatch Alarm Settings</h3>
<p>Display the Amazon CloudWatch screen and click &ldquo;Alarm&rdquo; on the left side.
When the list of alarms is displayed, click the [Create Alarm] button.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/a17aec17-7193-2603-35d5-9e8233f601f9.png" alt="image.png"></p>
<p>Click the Select Metric button.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/7bd4d13a-3afa-2834-0f2b-6c21c1b4adbb.png" alt="image.png"></p>
<p>In the field that specifies the filter condition, specify the instance ID of the EC2 instance you want to notify, and then press the Enter key.
Then, as shown below, only ***EC2&gt; Metrics by Instance *** will be clicked.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/94250b0c-f4e5-1b97-c311-6fe4cb8e9f5a.png" alt="image.png"></p>
<p>Select the metric you want to be notified about. In this example, CPUUtilization is selected.
Once selected, click the &ldquo;Select Metrics&rdquo; button at the bottom of the screen
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/e67ec240-c9fb-af65-e247-55354c97f003.png" alt="image.png"></p>
<p>Set the metric conditions.
Set the conditions you want to be notified. In this example, the notification is sent when the CPU usage exceeds 80.
Click the [Next] button to proceed.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/67520f92-0c77-4820-a23a-e11075d3b245.png" alt="image.png"></p>
<p>Since the SNS topic uses the one created earlier,
Select Select an existing SNS topic.
Then, specify the created one in [Notification destination].
Click the [Next] button to proceed.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/8612142f-4987-c6b5-e0cb-875fcd1184de.png" alt="image.png"></p>
<p>Specify the name of the alarm. Anything is fine.
Click the [Next] button.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/ac546b23-2cb7-a897-8014-0acc2a91afa3.png" alt="image.png"></p>
<p>A preview and creation screen will be displayed, so check the settings and
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/8044ef42-9294-e53c-2b49-0bc6070d545f.png" alt="image.png">
Scroll the screen and click the Create Alarm button.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/b42adafd-90d4-5835-c905-97367f3e1f0d.png" alt="image.png"></p>
<h2 id="test">test</h2>
<p>After setting various things, fire the Cloudwatch alarm.
If the alarmed EC2 instance is Linux, you can easily increase the CPU usage by executing the following command.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo yes &gt;&gt; /dev/null &amp;
<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span> <span style="color:#ae81ff">10968</span>
</code></pre></div><p>After a while, Microsoft Teams will add the following articles:
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/548623/5a562874-44a5-0b3b-58ee-317ee85cad59.png" alt="image.png"></p>
<p>When you&rsquo;re done testing, <code>kill</code> the process.</p>
<h2 id="summary">Summary</h2>
<p>Because your communication infrastructure is Microsoft Teams, not Slack or Amazon Chime, you can&rsquo;t immediately benefit from AWS Chatbot! I hope that those who are sad will smile with a smile based on this example.</p>
<h2 id="reference-materials">Reference materials</h2>
<p><a href="https://hacknote.jp/archives/51333/">https://hacknote.jp/archives/51333/</a>
<a href="https://qiita.com/m_hama123/items/c40c8f5271ca03fc57e9">https://qiita.com/m_hama123/items/c40c8f5271ca03fc57e9</a></p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
