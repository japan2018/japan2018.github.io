<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://japan2018.github.io/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://japan2018.github.io/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://japan2018.github.io/favicon-16x16.png">

  
  <link rel="manifest" href="https://japan2018.github.io/site.webmanifest">

  
  <link rel="mask-icon" href="https://japan2018.github.io/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://japan2018.github.io/css/bootstrap.min.css" />

  
  <title>Until the API made with Flask&#43;MySQL is converted to Docker | Some Title</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Until the API made with Flask+MySQL is converted to Docker</h1>
<p>
  <small class="text-secondary">
  
  
  Jan 10, 2020
  </small>
  

<small><code><a href="https://japan2018.github.io/tags/python">Python</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/flask">Flask</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/docker">Docker</a></code></small>

</p>
<pre><code>## this is?
</code></pre>
<p>I want to make an API. I want to make it with Flask+MySQL. And I want to make it Docker.
Make a note of this procedure. I don&rsquo;t really know where to use Docker, so concentrate on this.</p>
<h2 id="things-to-do">things to do</h2>
<ol>
<li>Create a simple API with Flask alone.
Convert 2.1 to Docker.</li>
<li>Prepare MySQL.</li>
<li>Enable the integration of Flask and MySQL with docker-compose.</li>
</ol>
<h3 id="1-create-a-simple-api-with-flask-alone">1. Create a simple API with Flask alone.</h3>
<p>First of all, make a simple API because it can be anything. This time, I decided to create a list that only returns the data that meets the conditions from the member list (provisional).</p>
<p>From the file below, create a function to return a list of mail_address where the perfectness matches the request parameters.</p>
<pre><code class="language-{personal_info.csv}" data-lang="{personal_info.csv}">mail_address,sex,age,name,prefecture
hoge1@gmail.com,male,18,itirou,tokyo
hoge2@gmail.com,male,23,zirou,osaka
hoge3@gmail.com,male,31,saburou,tokyo
hoge4@gmail.com,female,29,itiko,tokyo
hoge5@gmail.com,mail,11,shirou,osaka
hoge6@gmail.com,female,42,fumiko,tokyo
</code></pre><p>The code using Flask is <a href="https://github.com/ys201810/docker_test/blob/master/flask_test3/pure_flask/resource/app.py">here</a>.</p>
<p>It&rsquo;s super simple, if you run app.py and add ?pref=xxx to <code>http://127.0.0.1:5000/</code>, mail_address matching pref=xxx will be returned in a list.</p>
<p><img width="353" alt="Screenshot 2020-01-02 20.43.38.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/549365/d0fd8533-7afd-38de-55ee-deb6d1ee3e1b.png"> <img width="347" alt="Screenshot 2020-01-02 20.43.26.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/549365/eedc28d1-5042-d19a-c338-fd66ab5a2d6d.png"> <img width="335" alt=" screenshot 2020-01-02 20.43.51 .png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/549365/db8cc3eb-2046-56ea-7612-77cb7ac23349.png"></p>
<p>Next, make this API a Docker.</p>
<h3 id="21-is-converted-to-docker">2.1 is converted to Docker.</h3>
<p>&ldquo;To convert to Docker&rdquo; aims to create a Dockerfile, docker build it to create a Docker image, and execute app.py in the container with docker run to create a state where API requests can be thrown.</p>
<p>A Dockerfile describes the behavior of &ldquo;Specify a base image, describe the settings of the container to be created, and execute the command in the container&rdquo; for the container you want to create.</p>
<h4 id="2-1-specify-the-base-image">2-1 Specify the base image</h4>
<p>I want to be able to execute the flask with python, so I will base it on the python image.</p>
<h4 id="2-2-describe-container-settings">2-2 Describe container settings</h4>
<p>The following is required to run the flask code.</p>
<ul>
<li>Place local source code and data in a container.</li>
<li>Install the required libraries.</li>
</ul>
<h4 id="2-3-execute-the-command-in-the-container">2-3 Execute the command in the container.</h4>
<p>Execute the created app.py.</p>
<p>Below is a Dockerfile created with these 2-1 to 2-3 in mind.</p>
<pre><code class="language-{Dockerfile}" data-lang="{Dockerfile}"># 2-1 Specify the base image
FROM python:3.6
#2-2 Describe container settings
ARG work_dir=/work # Create variables handled in Dockerfile
ADD pure_flask $work_dir/pure_flask # Copy code to /work/ (Note that when copying a directory, you have to write the directory name on the right side)

Image of WORKDIR $work_dir/pure_flask # cd work_directory

RUN pip install -r requirements.txt # install required libraries with requirements.txt
# 2-3 execute command in container
CMD [&quot;python&quot;, &quot;/work/pure_flask/app.py&quot;] # There is only one CMD in the Dockerfile.
</code></pre><p>requirements.txt is very easy to describe only the flask.</p>
<pre><code class="language-{requirements.txt}" data-lang="{requirements.txt}">flask
</code></pre><p>Execute <code>docker build -t flask:ver1 .</code> in the directory containing the Dockerfile in this state.
The &ldquo;.&rdquo; in the above command means to build the image using the Dockerfile in the current directory.</p>
<p>Then run <code>docker run -it -d -p 5000:5000 flask:ver1</code>.</p>
<ul>
<li>d specifies background execution, -p 5000:5000 specifies local port 5000 and port forwarding of container port 5000.</li>
</ul>
<p>In this state, if you check with localhost:5000 on the local machine with a browser, you can check the API return.</p>
<img width="345" alt="Screenshot 2020-01-03 11.01.41.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/549365/1db436c3-6451-b340-9058-4baf79fb9553.png">
<p>By the way, in this state, <code>docker ps</code> and <code>docker images</code> are as follows.
If nothing is displayed by docker ps, it may be broken due to an error, so using the container ID displayed by docker ps -a, you may find the reason by doing <code>docker logs [container ID]</code>. ..</p>
<pre><code>$ docker ps
&gt; CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
&gt; dc371c597cef flask:ver1 &quot;python /work/pure_fâ€¦&quot; 9 minutes ago Up 9 minutes 0.0.0.0:5000-&gt;5000/tcp quizzical_margulis
$ docker images
&gt; REPOSITORY TAG IMAGE ID CREATED SIZE
&gt; flask ver1 b4cda0e56563 9 minutes ago 923MB
&gt; python 3.6 138869855e44 5 days ago 913MB
</code></pre><p>I was able to confirm the same operation on Docker by making a simple API with Flask alone.</p>
<p>Next, prepare to use MySQL.</p>
<h3 id="3-prepare-mysql">3. Prepare MySQL.</h3>
<p>MySQL is also prepared with Docker. This time, I will also use Docker-compose.yaml.</p>
<p>Docker-compose.yaml is similar to Dockerfile, but is for describing cooperation of multiple containers.
Since DB is supposed to be connected, I think it is natural to describe it with Docker-compose.</p>
<h4 id="3-1-specify-the-base-image">3-1 Specify the base image</h4>
<p>Since I want to use MySQL, I use the image of MySQL as a base.</p>
<h4 id="3-2-describe-container-settings">3-2 Describe container settings</h4>
<p>Initialize MySQL configuration file and database.</p>
<h4 id="3-3-execute-the-command-in-the-container">3-3 Execute the command in the container.</h4>
<p>Start the MySQL process.</p>
<p>The Dockerfile is below.</p>
<pre><code># 3-1 Specify base image
FROM mysql:5.7

#3-2 Describe container settings
COPY conf.d/mysql.cnf /etc/mysql/conf.d/mysql.cnf # Set of character code settings
COPY initdb.d/init.sql /docker-entrypoint-initdb.d/init.sql # Set of SQL files for initialization
</code></pre><p>The config file and init.sql copied in the Dockerfile are as follows.</p>
<pre><code class="language-{mysql.cnf}" data-lang="{mysql.cnf}">[mysqld]
character-set-server=utf8

[mysql]
default-character-set=utf8

[client]
default-character-set=utf8
</code></pre><pre><code class="language-{init.sql}" data-lang="{init.sql}">CREATE TABLE `personal_info` (
    mail_address VARCHAR(100) NOT NULL,
    sex VARCHAR(6) NOT NULL,
    age INT NOT NULL,
    name VARCHAR(50) NOT NULL,
    prefecture VARCHAR(50) NOT NULL,
    createdAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (mail_address)
);

INSERT INTO `personal_info` (mail_address, sex, age, name, prefecture, createdAt, updatedAt)
VALUES
('hoge1_1@gmail.com','male', 18,'ichirou1' ,'tokyo', current_timestamp(), current_timestamp()),('hoge2@gmail.com','male', 23,'zirou2','osaka', current_timestamp(), current_timestamp()),
('hoge3_3@gmail.com','male', 31,'saburou','tokyo', current_timestamp(), current_timestamp()),
('hoge4@gmail.com','female', 29,'itiko','tokyo', current_timestamp(), current_timestamp()),
('hoge5_5@gmail.com','mail', 11,'shirou','osaka', current_timestamp(), current_timestamp()),
('hoge6@gmail.com','female', 42,'fumiko','tokyo', current_timestamp(), current_timestamp());
</code></pre><p>docker-compose.yaml is below.</p>
<pre><code>version: '3' # version of the docker-compose.yaml description
services:
  db:
    build: mysql # Specify Dockerfile under mysql directory
    container_name: db_server # Docker container name
    ports:
      -'3306:3306' # specify port forwarding
    environment: # set environment variables
      MYSQL_ROOT_PASSWORD: pass # MySQL root user password
      MYSQL_DATABASE: testdb # MySQL schema
      TZ: Asia/Tokyo # Specify time zone
    volumes: # Volume mount for persisting MySQL data
      -db-data/:/var/lib/mysql
    #3-3 execute a command in a container
    command: mysqld # Execute mysqld command
volumes:
  db-data:
</code></pre><p>Once the above is done, start the db container with <code>docker-compose up -d</code>.
After that, login with <code>docker exec -it [Container ID] /bin/bash</code>, enter the password from <code>mysql -u root -p</code> to check the table, and if the contents of init.sql are entered, it is OK. ..</p>
<h4 id="remarks-tips-around-mysql">[Remarks] tips around mysql</h4>
<p>If data is not saved in volume for persisting MySQL data, confirm the volume with docker volume ls on the Docker host, delete it, and then docker-compose up -d.</p>
<p>Copy init.sql to /docker-entrypoint-initdb.d/ permanently.</p>
<p>Next, connect flask and MySQL.</p>
<h3 id="4-enable-linkage-between-flask-and-mysql-with-docker-compose">4. Enable linkage between Flask and MySQL with docker-compose.</h3>
<p>Combine the two Docker containers created in 2 and 4.
Here&rsquo;s what you need to do to combine:</p>
<ul>
<li>Put flask in docker-compose.yaml.</li>
<li>Allow flask to connect to MySQL (network).</li>
<li>Allow flask to connect to MySQL (code).</li>
</ul>
<h4 id="4-1-put-flask-into-docker-composeyaml">4-1 Put flask into docker-compose.yaml</h4>
<p>The following is an addition of the flask container to MySQL docker-compose.yaml.</p>
<pre><code>version: '3'
services:
  api:
    build: python
    container_name: api_server
    ports:
      -&quot;5000:5000&quot;
    tty: yes
    environment:
      TZ: Asia/Tokyo
      FLASK_APP: app.py
    depends_on: # api server starts after db server is up
      -db
    networks: # common network specification to connect api and db
      -app_net
  db:
    build: mysql
    container_name: db_server
    ports:
      -'3306:3306'
    environment:
      MYSQL_ROOT_PASSWORD: pass
      MYSQL_DATABASE: testdb
      TZ: Asia/Tokyo
    volumes:
      -./db-data:/var/lib/mysql
    command: mysqld
    networks:
      -app_net
volumes:
  db-data:
networks:
  app_net:
    driver: bridge
</code></pre><p>Describe api as the same hierarchy as db in the hierarchy directly under services.</p>
<h4 id="4-2-allow-connection-from-flask-to-mysql-network">4-2 Allow connection from flask to MySQL (network).</h4>
<p>When starting two containers and connecting between them, it is necessary to handle the two containers on the same network.
Add the following to each service in docker-compose.yaml of 4-1.</p>
<pre><code>networks:
      -app_net
</code></pre><p>This allows you to specify which network each container uses. It means that the two are in the same network.
Then, write the following in the top level hierarchy of docker-compose.yaml.</p>
<pre><code>networks:
  app_net:
    driver: bridge
</code></pre><p>This means the creation of docker&rsquo;s network, and the specification to make driver with bridge specification.
Now that the api and db containers are on the same network, it is possible to connect from api to db.</p>
<h4 id="4-3-allow-flask-to-connect-to-mysql-code">4-3-Allow flask to connect to MySQL (code).</h4>
<p>Modification of flask side code and module.
There are various ways to connect to MySQL from python, but this time I used mysqlclient.</p>
<p>Install mysqlclient with <code>pip install mysqlclient</code>, connect with the following code, and use it.</p>
<pre><code>import MySQLdb

conn = MySQLdb.connect(user='root', passwd='pass', host='db_server', db='testdb')
cur = conn.cursor()
sql = &quot;select * from personal_info;&quot;
cur.execute(sql)
rows = cur.fetchall()
</code></pre><p>A tuple is returned to this rows, and a tuple with the length of the number of records can be acquired.</p>
<pre><code class="language-{image" data-lang="{image">(
 (Value of the first column of the first record, Value of the second column of the first record, ...),
 (Value of the 1st column of the 2nd record, Value of the 2nd column of the 2nd record, ...),
 (Value of 1st column of 3rd record, Value of 2nd column of 3rd record, ...)
)
</code></pre><p>An image that receives this with python, stores it in a list and returns it with json.</p>
<p>The corrected source is <a href="https://github.com/ys201810/docker_test/tree/master/flask_test3/mysql_flask">here</a>.
Please refer to this for the directory structure and the location of the Dockerfile.</p>
<p>After that, I added mysqlclient to requirements.txt because the number of modules I want to handle with python has increased.</p>
<p>You&rsquo;re done.
After starting all with <code>docker-compose up -d</code>, put <code>http://0.0.0.0:5000/?pref=osaka</code> etc. locally to see the result.</p>
<p>that&rsquo;s all.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
