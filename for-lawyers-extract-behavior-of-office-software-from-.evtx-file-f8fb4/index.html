<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://japan2018.github.io/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://japan2018.github.io/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://japan2018.github.io/favicon-16x16.png">

  
  <link rel="manifest" href="https://japan2018.github.io/site.webmanifest">

  
  <link rel="mask-icon" href="https://japan2018.github.io/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://japan2018.github.io/css/bootstrap.min.css" />

  
  <title>(For lawyers) Extract behavior of Office software from .evtx file | Some Title</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>(For lawyers) Extract behavior of Office software from .evtx file</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 16, 2019
  </small>
  

<small><code><a href="https://japan2018.github.io/tags/python">Python</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/windows7"> windows7</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/log-analysis"> log analysis</a></code></small>

</p>
<pre><code>About a year ago, I wrote an article [Parsing .evtx files with Python](https://qiita.com/kasanma3104/items/6971d3e7d09de134da37), but roughly speaking, it is called its application. Or?
</code></pre>
<p>Regardless of whether a lawyer uses it to prove working hours in a court&hellip; wondering if you might want to work and extract that data from an EVTX (Windows XML Event Log) file that records the Windows system log? think. (The EVTX file seems to be in Win7 format, but it may be different format depending on the OS version, but I think the idea will not change so much.)
If it is a PC that you do not take out from the office, it seems that it will be good from start to finish, but if you are allowed to take out the PC, it is not always clear whether the PC startup on holidays is for work or for personal use.
But if you&rsquo;re using Office software, it might be work-like.
So, continuing from the previous article, let&rsquo;s use <a href="https://github.com/williballenthin/python-evtx">Python-Evtx</a> to extract such event logs using Office software.</p>
<p>Since the idea is almost the same as the previous article, please refer to that article.
Then, I wrote a script to list what programs would appear in <code>Data[@Name=ProcessName]</code> or <code>Data[@Name=NewProcessName]</code>, but apparently it contained the character string <code>Office</code>. I felt that the Office software was working as it was.
So, if you make a code roughly like this and make it like <code>$ python ExtractOffice.py EventLog.evtx</code>, it will spit out the file as <code>Events_office.tsv</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python:ExtractOffice.py" data-lang="Python:ExtractOffice.py"><span style="color:#f92672">import</span> Evtx.Evtx <span style="color:#f92672">as</span> evtx
<span style="color:#f92672">from</span> lxml <span style="color:#f92672">import</span> etree

schema <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://schemas.microsoft.com/win/2004/08/events/event&#34;</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    f <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;events_office.tsv&#34;</span>, <span style="color:#e6db74">&#34;w&#34;</span>) <span style="color:#75715e">#File direct hit (sweat</span>
    <span style="color:#f92672">import</span> argparse
    
    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser(
        description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Dump a binary EVTX file into XML.&#34;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;evtx&#34;</span>, type<span style="color:#f92672">=</span>str,
                        help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Path to the Windows EVTX event log file&#34;</span>)
    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
    
    <span style="color:#75715e">#EVTX file operations</span>
    <span style="color:#66d9ef">with</span> evtx<span style="color:#f92672">.</span>Evtx(args<span style="color:#f92672">.</span>evtx) <span style="color:#66d9ef">as</span> log:
        counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#75715e"># for progress reporting</span>
        <span style="color:#66d9ef">for</span> record <span style="color:#f92672">in</span> log<span style="color:#f92672">.</span>records():
            elm <span style="color:#f92672">=</span> record<span style="color:#f92672">.</span>lxml()
            <span style="color:#75715e">#progress report</span>
            counter <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
            <span style="color:#66d9ef">if</span> counter <span style="color:#f92672">%</span><span style="color:#ae81ff">1000</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
                <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Now on record:&#34;</span><span style="color:#f92672">+</span>str(counter))
            
            pn <span style="color:#f92672">=</span> elm<span style="color:#f92672">.</span>xpath(<span style="color:#e6db74">&#34;//event:Data[@Name=&#39;ProcessName&#39;]&#34;</span>, namespaces<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;event&#34;</span>:schema})
            npn <span style="color:#f92672">=</span> elm<span style="color:#f92672">.</span>xpath(<span style="color:#e6db74">&#34;//event:Data[@Name=&#39;NewProcessName&#39;]&#34;</span>, namespaces<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;event&#34;</span>:schema})
            pnt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span> Set the default value of <span style="color:#75715e">#ProcessName to &#34;&#34;</span>
            npnt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span> (short <span style="color:#66d9ef">for</span> <span style="color:#75715e">#NewProcessName)</span>
            <span style="color:#66d9ef">try</span>: <span style="color:#75715e"># Some kind of failure cast may occur, so try</span>
                <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#34;Office&#34;</span> <span style="color:#f92672">in</span> pn[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>text): <span style="color:#75715e"># Search here for a string</span>
                    pnt <span style="color:#f92672">=</span> pn[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>text
            <span style="color:#66d9ef">except</span>:
                pnt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
            <span style="color:#66d9ef">try</span>:
                <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;Office&#34;</span> <span style="color:#f92672">in</span> npn[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>text:
                    npnt <span style="color:#f92672">=</span> npn[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>text
            <span style="color:#66d9ef">except</span>:
                npnt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
            
            <span style="color:#66d9ef">if</span> (len(pnt) <span style="color:#f92672">or</span> len(npnt) ):
                <span style="color:#66d9ef">print</span>(
                    elm<span style="color:#f92672">.</span>xpath(<span style="color:#e6db74">&#34;//event:EventID&#34;</span>, namespaces<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;event&#34;</span>:schema})[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>text
                    <span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">+</span>
                    elm<span style="color:#f92672">.</span>xpath(<span style="color:#e6db74">&#34;//event:TimeCreated&#34;</span>, namespaces<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;event&#34;</span>:schema})[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;SystemTime&#34;</span>)
                    <span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">+</span>pnt
                    <span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">+</span>npnt
                , file<span style="color:#f92672">=</span>f)
        <span style="color:#66d9ef">print</span>(counter) <span style="color:#75715e"># Write out the number of events when finished.</span>
    f<span style="color:#f92672">.</span>close()


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    main()
</code></pre></div><p>Therefore, read the exhaled <code>Events_office.tsv</code> with Excel and format it appropriately (→[<a href="https://qiita.com/kasanma3104/items/2d551d98c789102d4622">like this (another article)</a>), If you put it together properly, it might look like that.
#Some supplementary explanation
The EVTX file is XML for each event (Record), and the <code>Data</code> elements under <code>//Event/EventData/</code> do not seem to be constant depending on the type of <code>Event</code>.
However, if there is either <code>ProcessName</code> or <code>NewProcessName</code>, it seems that it is possible to know from which program the log was emitted.
So I tried to supplement one of these.
Since the same contents are processed in ProcessName and NewProcessName, I understand that it is better to do refactoring that goes out as a function&hellip;</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
