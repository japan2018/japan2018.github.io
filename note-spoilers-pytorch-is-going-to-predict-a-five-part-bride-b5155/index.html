<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Note spoilers] PyTorch is going to predict a five-part bride | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Note spoilers] PyTorch is going to predict a five-part bride</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 21, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/machine-learning"> Machine Learning</a></code></small>


<small><code><a href="https://memotut.com/tags/deeplearning"> DeepLearning</a></code></small>


<small><code><a href="https://memotut.com/tags/pytorch"> PyTorch</a></code></small>


<small><code><a href="https://memotut.com/tags/the-five-quarter-bride"> The Five-Quarter Bride</a></code></small>

</p>
<pre><code>I'm going to rely on the five equally divided bride (serious face)
</code></pre>
<p>Learn the techniques of pytorch and Deep Learning while applying a five-part bride</p>
<p>The pytorch code I used this time is basically here</p>
<p><a href="https://github.com/yoyoyo-yo/DeepLearningMugenKnock">https://github.com/yoyoyo-yo/DeepLearningMugenKnock</a></p>
<p><strong>This is spoiler for some viewers, so if you don&rsquo;t like it, please close the window immediately</strong></p>
<p><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br> &gt;<br><br><br><br></p>
<p>Recently, the author has declared that the comic will be finished in 14 volumes, and it seemed like a great progress in terms of story.</p>
<p>I am in May and I believe it is May.
We will do this by proving it to be May in DeepLearning, having the author see it, and praying for the end of May.</p>
<p>#Flow</p>
<ol>
<li>Data set collection</li>
<li>Detection + recognition by YOLO-v3 (Keras)</li>
<li>Data collection for recognition</li>
<li>Recognition by CNN</li>
<li>Visualization with GradCAM</li>
</ol>
<h1 id="1-dataset-collection">1. Dataset collection</h1>
<p>I did something similar to the past.
<a href="https://qiita.com/yoyoyo_/items/a30332833ce45c84fafd">Use deep learning to predict the future bride of a five-part bride</a></p>
<p>We used YOLO-v3 (keras, <a href="https://github.com/qqwweee/keras-yolo3">https://github.com/qqwweee/keras-yolo3</a>) for detection and recognition.</p>
<p>As for the learning data, I opened one comic volume on the Kindle, and repeated repeated screenshot → annotation (dying)</p>
<h1 id="2-yolo-v3-keras-detection--recognition">2. YOLO-v3 (Keras) detection + recognition</h1>
<p>YOLO-v3, which handles detection and recognition at the same time, has a result of May.</p>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/046b572c-362d-492f-bf97-be817c1af2f1.png">
<h1 id="3-data-collection-for-recognition">3. Data collection for recognition</h1>
<p>Next, we will further cut out the face part and bring it in the direction that CNN will recognize.</p>
<p>I needed to collect face images for that purpose, so I cut out the face part with YOLO-v3.
After that, I visually cleaned the data and gathered,</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="right">Number of images</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">Ichika</td>
<td align="right">273</td>
</tr>
<tr>
<td align="center">Nino</td>
<td align="right">447</td>
</tr>
<tr>
<td align="center">Miku</td>
<td align="right">289</td>
</tr>
<tr>
<td align="center">Yotsuba</td>
<td align="right">397</td>
</tr>
<tr>
<td align="center">May</td>
<td align="right">443</td>
</tr>
</tbody>
</table>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/799520c9-5de8-bc06-6fbc-e7d68c828624.png" width=400>
<p>May and Nino are the most, followed by Yotsuba.</p>
<p>The captured image looks something like this</p>
<table>
<thead>
<tr>
<th align="center">Ichika</th>
<th align="center">Nino</th>
<th align="center">Mitsuhisa</th>
<th align="center">Yotsuba</th>
<th align="center">May</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/876b6773-da3f-6ae5-3183-419946e97c73.png" width=50> <img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/51bd095e-7009-56d8-875a-bb8754ca1405.png" width=50></td>
<td align="center"><img src= "https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/702ff4d3-ddfa-ae43-ac35-6a0f131ea43c.png" width=50> <img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/aa3ca731-e0f4-e49b-4603-db796bc83f29.png" width=50></td>
<td align="center"><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/fffadf74-bc9a-e09e-589d-15a87c0030b6.png" width=50> <img src="https://qiita-image.-store.s3.ap-northeast-1.amazonaws.com/0/192361/63915f99-b7c3-3b45-9c57-23e4a13a0a3c.png" width=50></td>
<td align="center"><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/56b68c0c-9899-d97b-d0a6-480082c1dbe8.png" width=50> <img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/886a55e3-6817-20aa-e023-3eaedc64bad7.png" width=50></td>
<td align="center"><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/33f55b8d-169a-024c-862b-7cb959c6e704.png" width=50> <img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/36216cba-5473-1b07-c6eb-8c121bf72aab.png" width=50></td>
</tr>
</tbody>
</table>
<p>With this, 250 images were used as learning data and 20 images were used as test data.</p>
<h1 id="4-recognition-by-cnn">4. Recognition by CNN</h1>
<p>It was put into 5 class classification by Res101.</p>
<p>The code looks something like this. To use this code, use the following directory structure</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Gotobun <span style="color:#f92672">---</span> Res101<span style="color:#f92672">.</span>py
         <span style="color:#f92672">|-</span> Train <span style="color:#f92672">-+-</span> Ichika <span style="color:#f92672">---</span> <span style="color:#f92672">***.</span>jpg
                   <span style="color:#f92672">+-</span> Nino <span style="color:#f92672">---</span> <span style="color:#f92672">***.</span>jpg
                   <span style="color:#f92672">+-</span> Miku <span style="color:#f92672">---</span> <span style="color:#f92672">***.</span>jpg
                   <span style="color:#f92672">+-</span> Yotsuba <span style="color:#f92672">---</span> <span style="color:#f92672">***.</span>jpg
                   <span style="color:#f92672">+-</span> Itsuki <span style="color:#f92672">---</span> <span style="color:#f92672">***.</span>jpg
         <span style="color:#f92672">|-</span> Test <span style="color:#f92672">---</span> <span style="color:#f92672">...</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:Res101.py" data-lang="python:Res101.py"><span style="color:#f92672">import</span> torch
<span style="color:#f92672">import</span> torch.nn.functional <span style="color:#f92672">as</span> F
<span style="color:#f92672">import</span> argparse
<span style="color:#f92672">import</span> cv2
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">from</span> glob <span style="color:#f92672">import</span> glob
<span style="color:#f92672">import</span> copy
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> seaborn <span style="color:#f92672">as</span> sns

CLS <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;Ichika&#39;</span>,<span style="color:#e6db74">&#39;Nino&#39;</span>,<span style="color:#e6db74">&#39;Miku&#39;</span>,<span style="color:#e6db74">&#39;Yotsuba&#39;</span>,<span style="color:#e6db74">&#39;Itsuki&#39;</span>]
num_classes <span style="color:#f92672">=</span> len(CLS)
img_height, img_width <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>
channel <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>

<span style="color:#75715e"># GPU</span>
GPU <span style="color:#f92672">=</span> True
device <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>device(<span style="color:#e6db74">&#34;cuda&#34;</span> <span style="color:#66d9ef">if</span> GPU <span style="color:#f92672">and</span> torch<span style="color:#f92672">.</span>cuda<span style="color:#f92672">.</span>is_available() <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;cpu&#34;</span>)

<span style="color:#75715e"># random seed</span>
torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">0</span>)
        
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ResBlock</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
    <span style="color:#66d9ef">def</span> __init__(self, in_f, f_1, out_f, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
        super(ResBlock, self)<span style="color:#f92672">.</span>__init__()

        self<span style="color:#f92672">.</span>stride <span style="color:#f92672">=</span> stride
        self<span style="color:#f92672">.</span>fit_dim <span style="color:#f92672">=</span> False

        self<span style="color:#f92672">.</span>block <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Sequential(
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Conv2d(in_f, f_1, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, stride<span style="color:#f92672">=</span>stride),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>BatchNorm2d(f_1),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>ReLU(),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Conv2d(f_1, f_1, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>BatchNorm2d(f_1),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>ReLU(),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Conv2d(f_1, out_f, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>BatchNorm2d(out_f),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>ReLU()
        )

        <span style="color:#66d9ef">if</span> in_f <span style="color:#f92672">!=</span> out_f:
            self<span style="color:#f92672">.</span>fit_conv <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Conv2d(in_f, out_f, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
            self<span style="color:#f92672">.</span>fit_bn <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>BatchNorm2d(out_f)
            self<span style="color:#f92672">.</span>fit_dim <span style="color:#f92672">=</span> True
            
            
        
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x):
        res_x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>block(x)
        
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>fit_dim:
            x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>fit_conv(x)
            x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>fit_bn(x)
            x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(x)
        
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>stride <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
            x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>max_pool2d(x, <span style="color:#ae81ff">2</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
            
        x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>add(res_x, x)
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(x)
        <span style="color:#66d9ef">return</span> x

        
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Res101</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
    <span style="color:#66d9ef">def</span> __init__(self):
        super(Res101, self)<span style="color:#f92672">.</span>__init__()

        self<span style="color:#f92672">.</span>conv1 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Conv2d(channel, <span style="color:#ae81ff">64</span>, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)self<span style="color:#f92672">.</span>bn1 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>BatchNorm2d(<span style="color:#ae81ff">64</span>)
        
        self<span style="color:#f92672">.</span>resblock2_1 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">256</span>)
        self<span style="color:#f92672">.</span>resblock2_2 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">256</span>)
        self<span style="color:#f92672">.</span>resblock2_3 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">256</span>)

        self<span style="color:#f92672">.</span>resblock3_1 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">512</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
        self<span style="color:#f92672">.</span>resblock3_2 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">512</span>)
        self<span style="color:#f92672">.</span>resblock3_3 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">512</span>)
        self<span style="color:#f92672">.</span>resblock3_4 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">512</span>)

        self<span style="color:#f92672">.</span>resblock4_1 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">1024</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
        block <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">22</span>):
            block<span style="color:#f92672">.</span>append(ResBlock(<span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">1024</span>))
        self<span style="color:#f92672">.</span>resblock4s <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Sequential(<span style="color:#f92672">*</span>block)

        self<span style="color:#f92672">.</span>resblock5_1 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">2048</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
        self<span style="color:#f92672">.</span>resblock5_2 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">2048</span>, <span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">2048</span>)
        self<span style="color:#f92672">.</span>resblock5_3 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">2048</span>, <span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">2048</span>)
        
        self<span style="color:#f92672">.</span>linear <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">2048</span>, num_classes)
        
        
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x):
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv1(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>bn1(x)
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(x)
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>max_pool2d(x, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)

        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock2_1(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock2_2(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock2_3(x)

        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock3_1(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock3_2(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock3_3(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock3_4(x)

        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock4_1(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock4s(x)

        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock5_1(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock5_2(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock5_3(x)

        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>avg_pool2d(x, [img_height<span style="color:#f92672">//</span><span style="color:#ae81ff">32</span>, img_width<span style="color:#f92672">//</span><span style="color:#ae81ff">32</span>], padding<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
        x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>view(list(x<span style="color:#f92672">.</span>size())[<span style="color:#ae81ff">0</span>], <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>linear(x)
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>softmax(x, dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
        
        <span style="color:#66d9ef">return</span> x

    


<span style="color:#75715e"># get train data</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">data_load</span>(path, hf<span style="color:#f92672">=</span>False, vf<span style="color:#f92672">=</span>False, rot<span style="color:#f92672">=</span>False):
    xs <span style="color:#f92672">=</span> []
    ts <span style="color:#f92672">=</span> []
    paths <span style="color:#f92672">=</span> []
    
    <span style="color:#66d9ef">for</span> dir_path <span style="color:#f92672">in</span> glob(path <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/*&#39;</span>):
        <span style="color:#66d9ef">for</span> path <span style="color:#f92672">in</span> glob(dir_path <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/*&#39;</span>):
            x <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imread(path)
            x <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>resize(x, (img_width, img_height))<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>float32)
            x <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255.</span>
            x <span style="color:#f92672">=</span> x[<span style="color:#f92672">...</span>, ::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
            xs<span style="color:#f92672">.</span>append(x)

            <span style="color:#66d9ef">for</span> i, cls <span style="color:#f92672">in</span> enumerate(CLS):
                <span style="color:#66d9ef">if</span> cls <span style="color:#f92672">in</span> path:
                    t <span style="color:#f92672">=</span> i
            
            ts<span style="color:#f92672">.</span>append(t)

            paths<span style="color:#f92672">.</span>append(path)

            <span style="color:#66d9ef">if</span> hf:
                xs<span style="color:#f92672">.</span>append(x[:, ::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
                ts<span style="color:#f92672">.</span>append(t)
                paths<span style="color:#f92672">.</span>append(path)

            <span style="color:#66d9ef">if</span> vf:
                xs<span style="color:#f92672">.</span>append(x[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
                ts<span style="color:#f92672">.</span>append(t)
                paths<span style="color:#f92672">.</span>append(path)

            <span style="color:#66d9ef">if</span> hf <span style="color:#f92672">and</span> vf:
                xs<span style="color:#f92672">.</span>append(x[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, ::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
                ts<span style="color:#f92672">.</span>append(t)
                paths<span style="color:#f92672">.</span>append(path)

            <span style="color:#66d9ef">if</span> rot <span style="color:#f92672">!=</span> False:
                angle <span style="color:#f92672">=</span> rot
                scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>

                <span style="color:#75715e"># show</span>
                a_num <span style="color:#f92672">=</span> <span style="color:#ae81ff">360</span> <span style="color:#f92672">//</span> rot
                w_num <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>ceil(np<span style="color:#f92672">.</span>sqrt(a_num))
                h_num <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>ceil(a_num <span style="color:#f92672">/</span> w_num)
                count <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
                <span style="color:#75715e">#plt.subplot(h_num, w_num, count)</span>
                <span style="color:#75715e">#plt.axis(&#39;off&#39;)</span>
                <span style="color:#75715e">#plt.imshow(x)</span>
                <span style="color:#75715e">#plt.title(&#34;angle=0&#34;)</span>
                
                <span style="color:#66d9ef">while</span> angle <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">360</span>:
                    _h, _w, _c <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>shape
                    max_side <span style="color:#f92672">=</span> max(_h, _w)
                    tmp <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((max_side, max_side, _c))
                    tx <span style="color:#f92672">=</span> int((max_side <span style="color:#f92672">-</span> _w) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>)
                    ty <span style="color:#f92672">=</span> int((max_side <span style="color:#f92672">-</span> _h) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>)
                    tmp[ty: ty<span style="color:#f92672">+</span>_h, tx: tx<span style="color:#f92672">+</span>_w] <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>copy()
                    M <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>getRotationMatrix2D((max_side<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>, max_side<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>), angle, scale)
                    _x <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>warpAffine(tmp, M, (max_side, max_side))
                    _x <span style="color:#f92672">=</span> _x[tx:tx<span style="color:#f92672">+</span>_w, ty:ty<span style="color:#f92672">+</span>_h]
                    xs<span style="color:#f92672">.</span>append(_x)
                    ts<span style="color:#f92672">.</span>append(t)
                    paths<span style="color:#f92672">.</span>append(path)

                    <span style="color:#75715e"># show</span>
                    <span style="color:#75715e">#count += 1</span>
                    <span style="color:#75715e">#plt.subplot(h_num, w_num, count)</span>
                    <span style="color:#75715e">#plt.imshow(_x)</span>
                    <span style="color:#75715e">#plt.axis(&#39;off&#39;)</span>
                    <span style="color:#75715e">#plt.title(&#34;angle={}&#34;.format(angle))</span>

                    angle <span style="color:#f92672">+=</span> rot
                <span style="color:#75715e">#plt.show()</span>


    xs <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(xs, dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>float32)
    ts <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(ts, dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>int)
    
    xs <span style="color:#f92672">=</span> xs<span style="color:#f92672">.</span>transpose(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>)

    <span style="color:#66d9ef">return</span> xs, ts, paths



<span style="color:#75715e"># train</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>():
    <span style="color:#75715e"># model</span>
    model <span style="color:#f92672">=</span> Res101()<span style="color:#f92672">.</span>to(device)
    opt <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>, momentum<span style="color:#f92672">=</span><span style="color:#ae81ff">0.9</span>)
    model<span style="color:#f92672">.</span>train()

    xs, ts, paths <span style="color:#f92672">=</span> data_load(<span style="color:#e6db74">&#39;Train/&#39;</span>, hf<span style="color:#f92672">=</span>True, vf<span style="color:#f92672">=</span>True, rot<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)

    <span style="color:#75715e"># training</span>
    mb <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>
    mbi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    train_ind <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(len(xs))
    np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>seed(<span style="color:#ae81ff">0</span>)
    np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>shuffle(train_ind)

    loss_fn <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>CrossEntropyLoss()
    
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10000</span>):
        <span style="color:#66d9ef">if</span> mbi <span style="color:#f92672">+</span> mb <span style="color:#f92672">&gt;</span> len(xs):
            mb_ind <span style="color:#f92672">=</span> copy<span style="color:#f92672">.</span>copy(train_ind)[mbi:]
            np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>shuffle(train_ind)
            mb_ind <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>hstack((mb_ind, train_ind[:(mb<span style="color:#f92672">-</span>(len(xs)<span style="color:#f92672">-</span>mbi))]))
        <span style="color:#66d9ef">else</span>:
            mb_ind <span style="color:#f92672">=</span> train_ind[mbi: mbi<span style="color:#f92672">+</span>mb]
            mbi <span style="color:#f92672">+=</span> mb

        x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(xs[mb_ind], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float)<span style="color:#f92672">.</span>to(device)
        t <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(ts[mb_ind], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long)<span style="color:#f92672">.</span>to(device)

        opt<span style="color:#f92672">.</span>zero_grad()
        y <span style="color:#f92672">=</span> model(x)<span style="color:#75715e">#y = F.log_softmax(y, dim=1)</span>
        loss <span style="color:#f92672">=</span> loss_fn(y, t)
        
        loss<span style="color:#f92672">.</span>backward()
        opt<span style="color:#f92672">.</span>step()
    
        pred <span style="color:#f92672">=</span> y<span style="color:#f92672">.</span>argmax(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, keepdim<span style="color:#f92672">=</span>True)
        acc <span style="color:#f92672">=</span> pred<span style="color:#f92672">.</span>eq(t<span style="color:#f92672">.</span>view_as(pred))<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>item() <span style="color:#f92672">/</span> mb
        
        <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;iter &gt;&gt;&#34;</span>, i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;, loss &gt;&gt;&#39;</span>, loss<span style="color:#f92672">.</span>item(), <span style="color:#e6db74">&#39;, accuracy &gt;&gt;&#39;</span>, acc)

    torch<span style="color:#f92672">.</span>save(model<span style="color:#f92672">.</span>state_dict(), <span style="color:#e6db74">&#39;Res101.pt&#39;</span>)

    
<span style="color:#75715e"># test</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>():
    model <span style="color:#f92672">=</span> Res101()<span style="color:#f92672">.</span>to(device)
    model<span style="color:#f92672">.</span>eval()
    model<span style="color:#f92672">.</span>load_state_dict(torch<span style="color:#f92672">.</span>load(<span style="color:#e6db74">&#39;Res101.pt&#39;</span>, map_location<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>device(device)))

    xs, ts, paths <span style="color:#f92672">=</span> data_load(<span style="color:#e6db74">&#39;Test/&#39;</span>)

    Matrix <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros([<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">5</span>])

    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(paths)):
        x <span style="color:#f92672">=</span> xs[i]
        t <span style="color:#f92672">=</span> ts[i]
        path <span style="color:#f92672">=</span> paths[i]
        
        x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>expand_dims(x, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
        x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(x, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float)<span style="color:#f92672">.</span>to(device)
        
        pred <span style="color:#f92672">=</span> model(x)
        pred <span style="color:#f92672">=</span> pred<span style="color:#f92672">.</span>detach()<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()[<span style="color:#ae81ff">0</span>]

        Matrix[t, pred<span style="color:#f92672">.</span>argmax()] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
    
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;in {}, predict &gt;&gt; {}, probabilities &gt;&gt; {}&#34;</span><span style="color:#f92672">.</span>format(path, CLS[pred<span style="color:#f92672">.</span>argmax()], pred))

    <span style="color:#66d9ef">print</span>(Matrix)
    <span style="color:#75715e">#plt.imshow(Matrix)</span>
    sns<span style="color:#f92672">.</span>heatmap(Matrix, square<span style="color:#f92672">=</span>True, annot<span style="color:#f92672">=</span>True)
    plt<span style="color:#f92672">.</span>show()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">arg_parse</span>():
    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser(description<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;CNN implemented with Keras&#39;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--train&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;train&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--test&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;test&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>)
    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
    <span style="color:#66d9ef">return</span> args


<span style="color:#75715e"># main</span>
<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    args <span style="color:#f92672">=</span> arg_parse()

    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>train:
        train()
    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>test:
        test()

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> (args<span style="color:#f92672">.</span>train <span style="color:#f92672">or</span> args<span style="color:#f92672">.</span>test):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;please select train or test flag&#34;</span>)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;train: python main.py --train&#34;</span>)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;test:  python main.py --test&#34;</span>)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;both:  python main.py --train --test&#34;</span>)
</code></pre></div><p>正直学習回数は途中でめんどくさくなったので、これが最適とも言えないかも知れなくもない</p>
<h1 id="cnn認識の結果">CNN認識の結果</h1>
<p>縦軸に正解、横軸に予測で表をつくるとこんな感じ、それなりにあたっている(Accuracy 70%)くらい</p>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/9539a40c-9cbb-b487-d051-a95c8b5e7e46.png" width=300>
<h1 id="花嫁画像の予測">花嫁画像の予測</h1>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/aacff4e3-8664-b3f8-d679-e4ea07b4f20b.png" width=100>
<table>
<thead>
<tr>
<th align="center">一花</th>
<th align="center">二乃</th>
<th align="center">三久</th>
<th align="center">四葉</th>
<th align="center">五月</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">15%</td>
<td align="center">40%</td>
<td align="center">15%</td>
<td align="center">15%</td>
<td align="center">15%</td>
</tr>
</tbody>
</table>
<p>ん？　二乃？？</p>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/f3ef0989-526f-2a03-ca53-bf4ec3d9ceba.png" width=100>
<table>
<thead>
<tr>
<th align="center">一花</th>
<th align="center">二乃</th>
<th align="center">三久</th>
<th align="center">四葉</th>
<th align="center">五月</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">15%</td>
<td align="center">40%</td>
<td align="center">15%</td>
<td align="center">15%</td>
<td align="center">15%</td>
</tr>
</tbody>
</table>
<h1 id="grad-cam">Grad-Cam</h1>
<p>CNNの判断を可視化するGrad-CAMを使用する。</p>
<p>コードは</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> torch
<span style="color:#f92672">import</span> torch.nn.functional <span style="color:#f92672">as</span> F
<span style="color:#f92672">import</span> argparse
<span style="color:#f92672">import</span> cv2
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">from</span> glob <span style="color:#f92672">import</span> glob
<span style="color:#f92672">import</span> copy
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> matplotlib.cm <span style="color:#f92672">as</span> cm
<span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> OrderedDict

Class_label <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;Ichika&#39;</span>, <span style="color:#e6db74">&#39;Nino&#39;</span>, <span style="color:#e6db74">&#39;Miku&#39;</span>, <span style="color:#e6db74">&#39;Yotsuba&#39;</span>, <span style="color:#e6db74">&#39;Itsuki&#39;</span>]
Class_N <span style="color:#f92672">=</span> len(Class_label)
img_height, img_width <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>
channel <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>

<span style="color:#75715e"># GPU</span>
GPU <span style="color:#f92672">=</span> False
device <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>device(<span style="color:#e6db74">&#34;cuda&#34;</span> <span style="color:#66d9ef">if</span> GPU <span style="color:#f92672">and</span> torch<span style="color:#f92672">.</span>cuda<span style="color:#f92672">.</span>is_available() <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;cpu&#34;</span>)

<span style="color:#75715e"># random seed</span>
torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">0</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ResBlock</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
    <span style="color:#66d9ef">def</span> __init__(self, in_f, f_1, out_f, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
        super(ResBlock, self)<span style="color:#f92672">.</span>__init__()

        self<span style="color:#f92672">.</span>stride <span style="color:#f92672">=</span> stride
        self<span style="color:#f92672">.</span>fit_dim <span style="color:#f92672">=</span> False

        self<span style="color:#f92672">.</span>block <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Sequential(
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Conv2d(in_f, f_1, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, stride<span style="color:#f92672">=</span>stride),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>BatchNorm2d(f_1),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>ReLU(),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Conv2d(f_1, f_1, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>BatchNorm2d(f_1),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>ReLU(),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Conv2d(f_1, out_f, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>BatchNorm2d(out_f),
            torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>ReLU()
        )

        <span style="color:#66d9ef">if</span> in_f <span style="color:#f92672">!=</span> out_f:
            self<span style="color:#f92672">.</span>fit_conv <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Conv2d(in_f, out_f, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
            self<span style="color:#f92672">.</span>fit_bn <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>BatchNorm2d(out_f)
            self<span style="color:#f92672">.</span>fit_dim <span style="color:#f92672">=</span> True
            
            
        
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x):
        res_x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>block(x)
        
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>fit_dim:
            x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>fit_conv(x)
            x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>fit_bn(x)
            x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(x)
        
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>stride <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
            x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>max_pool2d(x, <span style="color:#ae81ff">2</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
            
        x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>add(res_x, x)
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(x)
        <span style="color:#66d9ef">return</span> x

        
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Res101</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
    <span style="color:#66d9ef">def</span> __init__(self):
        super(Res101, self)<span style="color:#f92672">.</span>__init__()

        self<span style="color:#f92672">.</span>conv1 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Conv2d(channel, <span style="color:#ae81ff">64</span>, kernel_size<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
        self<span style="color:#f92672">.</span>bn1 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>BatchNorm2d(<span style="color:#ae81ff">64</span>)
        
        self<span style="color:#f92672">.</span>resblock2_1 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">256</span>)
        self<span style="color:#f92672">.</span>resblock2_2 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">256</span>)
        self<span style="color:#f92672">.</span>resblock2_3 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">256</span>)

        self<span style="color:#f92672">.</span>resblock3_1 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">512</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
        self<span style="color:#f92672">.</span>resblock3_2 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">512</span>)
        self<span style="color:#f92672">.</span>resblock3_3 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">512</span>)
        self<span style="color:#f92672">.</span>resblock3_4 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">512</span>)

        self<span style="color:#f92672">.</span>resblock4_1 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">1024</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)block <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">22</span>):
            block<span style="color:#f92672">.</span>append(ResBlock(<span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">1024</span>))
        self<span style="color:#f92672">.</span>resblock4s <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Sequential(<span style="color:#f92672">*</span>block)

        self<span style="color:#f92672">.</span>resblock5_1 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">2048</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
        self<span style="color:#f92672">.</span>resblock5_2 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">2048</span>, <span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">2048</span>)
        self<span style="color:#f92672">.</span>resblock5_3 <span style="color:#f92672">=</span> ResBlock(<span style="color:#ae81ff">2048</span>, <span style="color:#ae81ff">512</span>, <span style="color:#ae81ff">2048</span>)
        
        self<span style="color:#f92672">.</span>linear <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">2048</span>, Class_N)
        
        
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x):
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>conv1(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>bn1(x)
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(x)
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>max_pool2d(x, <span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)

        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock2_1(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock2_2(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock2_3(x)

        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock3_1(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock3_2(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock3_3(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock3_4(x)

        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock4_1(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock4s(x)

        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock5_1(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock5_2(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resblock5_3(x)

        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>avg_pool2d(x, [img_height<span style="color:#f92672">//</span><span style="color:#ae81ff">32</span>, img_width<span style="color:#f92672">//</span><span style="color:#ae81ff">32</span>], padding<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
        x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>view(list(x<span style="color:#f92672">.</span>size())[<span style="color:#ae81ff">0</span>], <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>linear(x)
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>softmax(x, dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
        
        <span style="color:#66d9ef">return</span> x



<span style="color:#75715e"># get train data</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">data_load</span>(path, hf<span style="color:#f92672">=</span>False, vf<span style="color:#f92672">=</span>False, rot<span style="color:#f92672">=</span>False):
    xs <span style="color:#f92672">=</span> []
    ts <span style="color:#f92672">=</span> []
    paths <span style="color:#f92672">=</span> []
    
    <span style="color:#66d9ef">for</span> dir_path <span style="color:#f92672">in</span> glob(path <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/*&#39;</span>):
        <span style="color:#66d9ef">for</span> path <span style="color:#f92672">in</span> glob(dir_path <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/*&#39;</span>):
            x <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imread(path)
            x <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>resize(x, (img_width, img_height))<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>float32)
            x <span style="color:#f92672">/=</span> <span style="color:#ae81ff">255.</span>
            x <span style="color:#f92672">=</span> x[<span style="color:#f92672">...</span>, ::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
            xs<span style="color:#f92672">.</span>append(x)

            t <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
            <span style="color:#66d9ef">for</span> i, _Class_label <span style="color:#f92672">in</span> enumerate(Class_label):
                <span style="color:#66d9ef">if</span> _Class_label <span style="color:#f92672">in</span> path:
                    t <span style="color:#f92672">=</span> i
            
            ts<span style="color:#f92672">.</span>append(t)

            paths<span style="color:#f92672">.</span>append(path)

            <span style="color:#66d9ef">if</span> hf:
                xs<span style="color:#f92672">.</span>append(x[:, ::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
                ts<span style="color:#f92672">.</span>append(t)
                paths<span style="color:#f92672">.</span>append(path)

            <span style="color:#66d9ef">if</span> vf:
                xs<span style="color:#f92672">.</span>append(x[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
                ts<span style="color:#f92672">.</span>append(t)
                paths<span style="color:#f92672">.</span>append(path)

            <span style="color:#66d9ef">if</span> hf <span style="color:#f92672">and</span> vf:
                xs<span style="color:#f92672">.</span>append(x[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, ::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
                ts<span style="color:#f92672">.</span>append(t)
                paths<span style="color:#f92672">.</span>append(path)

            <span style="color:#66d9ef">if</span> rot <span style="color:#f92672">!=</span> False:
                angle <span style="color:#f92672">=</span> rot
                scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>

                <span style="color:#75715e"># show</span>
                a_num <span style="color:#f92672">=</span> <span style="color:#ae81ff">360</span> <span style="color:#f92672">//</span> rot
                w_num <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>ceil(np<span style="color:#f92672">.</span>sqrt(a_num))
                h_num <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>ceil(a_num <span style="color:#f92672">/</span> w_num)
                count <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
                <span style="color:#75715e">#plt.subplot(h_num, w_num, count)</span>
                <span style="color:#75715e">#plt.axis(&#39;off&#39;)</span>
                <span style="color:#75715e">#plt.imshow(x)</span>
                <span style="color:#75715e">#plt.title(&#34;angle=0&#34;)</span>
                
                <span style="color:#66d9ef">while</span> angle <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">360</span>:
                    _h, _w, _c <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>shape
                    max_side <span style="color:#f92672">=</span> max(_h, _w)
                    tmp <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((max_side, max_side, _c))
                    tx <span style="color:#f92672">=</span> int((max_side <span style="color:#f92672">-</span> _w) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>)
                    ty <span style="color:#f92672">=</span> int((max_side <span style="color:#f92672">-</span> _h) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>)
                    tmp[ty: ty<span style="color:#f92672">+</span>_h, tx: tx<span style="color:#f92672">+</span>_w] <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>copy()
                    M <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>getRotationMatrix2D((max_side<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>, max_side<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>), angle, scale)
                    _x <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>warpAffine(tmp, M, (max_side, max_side))
                    _x <span style="color:#f92672">=</span> _x[tx:tx<span style="color:#f92672">+</span>_w, ty:ty<span style="color:#f92672">+</span>_h]
                    xs<span style="color:#f92672">.</span>append(_x)
                    ts<span style="color:#f92672">.</span>append(t)
                    paths<span style="color:#f92672">.</span>append(path)

                    <span style="color:#75715e"># show</span>
                    <span style="color:#75715e">#count += 1</span>
                    <span style="color:#75715e">#plt.subplot(h_num, w_num, count)</span>
                    <span style="color:#75715e">#plt.imshow(_x)</span>
                    <span style="color:#75715e">#plt.axis(&#39;off&#39;)</span>
                    <span style="color:#75715e">#plt.title(&#34;angle={}&#34;.format(angle))</span>

                    angle <span style="color:#f92672">+=</span> rot
                <span style="color:#75715e">#plt.show()</span>


    xs <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(xs, dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>float32)
    ts <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(ts, dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>int)
    
    xs <span style="color:#f92672">=</span> xs<span style="color:#f92672">.</span>transpose(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>)

    <span style="color:#66d9ef">return</span> xs, ts, paths



<span style="color:#75715e"># train</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>():
    <span style="color:#75715e"># model</span>
    model <span style="color:#f92672">=</span> Res101()<span style="color:#f92672">.</span>to(device)
    opt <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD(model<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>, momentum<span style="color:#f92672">=</span><span style="color:#ae81ff">0.9</span>)
    model<span style="color:#f92672">.</span>train()

    xs, ts, paths <span style="color:#f92672">=</span> data_load(<span style="color:#e6db74">&#39;../Dataset/train/images/&#39;</span>, hf<span style="color:#f92672">=</span>True, vf<span style="color:#f92672">=</span>True, rot<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)

    <span style="color:#75715e"># training</span>
    mb <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
    mbi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    train_ind <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(len(xs))
    np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>seed(<span style="color:#ae81ff">0</span>)
    np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>shuffle(train_ind)

    loss_fn <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>NLLLoss()
    
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">500</span>):
        <span style="color:#66d9ef">if</span> mbi <span style="color:#f92672">+</span> mb <span style="color:#f92672">&gt;</span> len(xs):
            mb_ind <span style="color:#f92672">=</span> copy<span style="color:#f92672">.</span>copy(train_ind)[mbi:]
            np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>shuffle(train_ind)
            mb_ind <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>hstack((mb_ind, train_ind[:(mb<span style="color:#f92672">-</span>(len(xs)<span style="color:#f92672">-</span>mbi))]))
        <span style="color:#66d9ef">else</span>:
            mb_ind <span style="color:#f92672">=</span> train_ind[mbi: mbi<span style="color:#f92672">+</span>mb]
            mbi <span style="color:#f92672">+=</span> mb

        x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(xs[mb_ind], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float)<span style="color:#f92672">.</span>to(device)
        t <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(ts[mb_ind], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long)<span style="color:#f92672">.</span>to(device)

        opt<span style="color:#f92672">.</span>zero_grad()
        y <span style="color:#f92672">=</span> model(x)
        <span style="color:#75715e">#y = F.log_softmax(y, dim=1)</span>
        loss <span style="color:#f92672">=</span> loss_fn(torch<span style="color:#f92672">.</span>log(y), t)
        
        loss<span style="color:#f92672">.</span>backward()
        opt<span style="color:#f92672">.</span>step()
    
        pred <span style="color:#f92672">=</span> y<span style="color:#f92672">.</span>argmax(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, keepdim<span style="color:#f92672">=</span>True)
        acc <span style="color:#f92672">=</span> pred<span style="color:#f92672">.</span>eq(t<span style="color:#f92672">.</span>view_as(pred))<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>item() <span style="color:#f92672">/</span> mb

        <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">50</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;iter &gt;&gt;&#34;</span>, i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#39;, loss &gt;&gt;&#39;</span>, loss<span style="color:#f92672">.</span>item(), <span style="color:#e6db74">&#39;, accuracy &gt;&gt;&#39;</span>, acc)

    torch<span style="color:#f92672">.</span>save(model<span style="color:#f92672">.</span>state_dict(), <span style="color:#e6db74">&#39;Res101.pt&#39;</span>)

<span style="color:#75715e"># test</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>(target_layer_name):model <span style="color:#f92672">=</span> Res101()<span style="color:#f92672">.</span>to(device)
    model<span style="color:#f92672">.</span>eval()
    model<span style="color:#f92672">.</span>load_state_dict(torch<span style="color:#f92672">.</span>load(<span style="color:#e6db74">&#39;Res101.pt&#39;</span>, map_location<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>device(device)))

    xs, ts, paths <span style="color:#f92672">=</span> data_load(<span style="color:#e6db74">&#39;Test/&#39;</span>)

    target_layer <span style="color:#f92672">=</span> None

    <span style="color:#66d9ef">for</span> name, module <span style="color:#f92672">in</span> model<span style="color:#f92672">.</span>named_modules():
      <span style="color:#66d9ef">if</span> target_layer_name <span style="color:#f92672">==</span> name:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;target:&#39;</span>, name)
        target_layer <span style="color:#f92672">=</span> module

    <span style="color:#66d9ef">if</span> target_layer <span style="color:#f92672">is</span> None:
      <span style="color:#66d9ef">for</span> name, module <span style="color:#f92672">in</span> model<span style="color:#f92672">.</span>named_modules():
        <span style="color:#66d9ef">print</span>(name)
      <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;invalid target layer name &gt;&gt;&#39;</span>, target_layer_name)

    <span style="color:#66d9ef">if</span> type(target_layer) <span style="color:#f92672">is</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Sequential:
      target_layer <span style="color:#f92672">=</span> target_layer[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]

    <span style="color:#66d9ef">print</span>(target_layer)

    fmap_pool <span style="color:#f92672">=</span> OrderedDict()
    grad_pool <span style="color:#f92672">=</span> OrderedDict()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward_hook</span>(key):
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward_hook_</span>(module, input, output):
            <span style="color:#75715e"># Save featuremaps</span>
            fmap_pool[key] <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>detach()

        <span style="color:#66d9ef">return</span> forward_hook_

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">backward_hook</span>(key):
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">backward_hook_</span>(module, grad_in, grad_out):
            <span style="color:#75715e"># Save the gradients correspond to the featuremaps</span>
            grad_pool[key] <span style="color:#f92672">=</span> grad_out[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>detach()

        <span style="color:#66d9ef">return</span> backward_hook_

    <span style="color:#75715e"># If any candidates are not specified, the hook is registered to all the layers.</span>
    <span style="color:#66d9ef">for</span> name, module <span style="color:#f92672">in</span> model<span style="color:#f92672">.</span>named_modules():
            module<span style="color:#f92672">.</span>register_forward_hook(forward_hook(name))
            module<span style="color:#f92672">.</span>register_backward_hook(backward_hook(name))


    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(paths)):
        _x <span style="color:#f92672">=</span> xs[i]
        t <span style="color:#f92672">=</span> ts[i]
        path <span style="color:#f92672">=</span> paths[i]
        
        x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>expand_dims(_x, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
        x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(x, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float)<span style="color:#f92672">.</span>to(device)
        
        <span style="color:#75715e"># forward network</span>
        logit <span style="color:#f92672">=</span> model(x)
        pred <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>softmax(logit, dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>detach()<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()

        raw_image <span style="color:#f92672">=</span> (_x )<span style="color:#f92672">.</span>transpose(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>)

        plt<span style="color:#f92672">.</span>subplot(<span style="color:#ae81ff">1</span>, Class_N <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)
        plt<span style="color:#f92672">.</span>imshow(raw_image)
        <span style="color:#66d9ef">if</span> t <span style="color:#f92672">&lt;</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:
            plt<span style="color:#f92672">.</span>title(Class_label[t])
        <span style="color:#66d9ef">else</span>:
            plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;?&#39;</span>)
        plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)

        <span style="color:#66d9ef">for</span> i, class_label <span style="color:#f92672">in</span> enumerate(Class_label):
            <span style="color:#75715e"># set one-hot class activity</span>
            class_index <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(pred<span style="color:#f92672">.</span>shape)<span style="color:#f92672">.</span>to(device)

            _index <span style="color:#f92672">=</span> Class_label<span style="color:#f92672">.</span>index(class_label)
            class_index[:, _index] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>

            logit<span style="color:#f92672">.</span>backward(gradient<span style="color:#f92672">=</span>class_index, retain_graph<span style="color:#f92672">=</span>True)
            
            <span style="color:#75715e">#target_layer_output = target_layer.forward(x)</span>
            fmaps <span style="color:#f92672">=</span> fmap_pool[target_layer_name]
            grads <span style="color:#f92672">=</span> grad_pool[target_layer_name]
            weights <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>adaptive_avg_pool2d(grads, <span style="color:#ae81ff">1</span>)

            gcam <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>mul(fmaps, weights)<span style="color:#f92672">.</span>sum(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, keepdim<span style="color:#f92672">=</span>True)
            gcam <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>relu(gcam)

            gcam <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>interpolate(gcam, [img_height, img_width], mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bilinear&#34;</span>, align_corners<span style="color:#f92672">=</span>False)

            B, C, H, W <span style="color:#f92672">=</span> gcam<span style="color:#f92672">.</span>shape
            gcam <span style="color:#f92672">=</span> gcam<span style="color:#f92672">.</span>view(B, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
            gcam <span style="color:#f92672">-=</span> gcam<span style="color:#f92672">.</span>min(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, keepdim<span style="color:#f92672">=</span>True)[<span style="color:#ae81ff">0</span>]
            gcam <span style="color:#f92672">/=</span> gcam<span style="color:#f92672">.</span>max(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, keepdim<span style="color:#f92672">=</span>True)[<span style="color:#ae81ff">0</span>]
            gcam <span style="color:#f92672">=</span> gcam<span style="color:#f92672">.</span>view(B, C, H, W)

            gcam <span style="color:#f92672">=</span> gcam<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()[<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>]
            cmap <span style="color:#f92672">=</span> cm<span style="color:#f92672">.</span>jet_r(gcam)[<span style="color:#f92672">...</span>, :<span style="color:#ae81ff">3</span>]
            gcam <span style="color:#f92672">=</span> (cmap<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>float) <span style="color:#f92672">+</span> raw_image<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>float)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
        
            plt<span style="color:#f92672">.</span>subplot(<span style="color:#ae81ff">1</span>, Class_N <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, i <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>)
            plt<span style="color:#f92672">.</span>imshow(gcam)
            plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;{}:{:.2f}&#39;</span><span style="color:#f92672">.</span>format(class_label, pred[<span style="color:#ae81ff">0</span>, i]), fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
            plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)

        plt<span style="color:#f92672">.</span>show()

        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;in {}, predicted probabilities &gt;&gt; {}&#34;</span><span style="color:#f92672">.</span>format(path, pred))



<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">arg_parse</span>():
    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser(description<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;CNN implemented with Keras&#39;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--train&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;train&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--test&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;test&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>)
    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--target&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;target_layer&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;conv3&#39;</span>, type<span style="color:#f92672">=</span>str)
    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
    <span style="color:#66d9ef">return</span> args

<span style="color:#75715e"># main</span>
<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    args <span style="color:#f92672">=</span> arg_parse()

    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>train:
        train()
    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>test:
        test(args<span style="color:#f92672">.</span>target_layer)

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> (args<span style="color:#f92672">.</span>train <span style="color:#f92672">or</span> args<span style="color:#f92672">.</span>test):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;please select train or test flag&#34;</span>)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;train: python main.py --train&#34;</span>)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;test:  python main.py --test&#34;</span>)
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;both:  python main.py --train --test&#34;</span>)

</code></pre></div><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/3eaf4c97-1d7e-6c84-a789-b02ed6e42e80.png" width=300>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/285d8e3a-0bc1-4ad9-620a-754443bc5699.png" width=300>
<p>どうやら左目が二乃なのか、、</p>
<p>二乃で調べてみると確かに目に反応する結果がみられる</p>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/f5172b5d-1f69-7aa2-1fbf-d865e9a17d65.png" width=300>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/c889c1bd-5eac-f776-e4f6-791ad93a6a18.png" width=300>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/192361/60c0019f-733e-c93a-eb11-32e76c58edb0.png" width=300>
<h1 id="結果">結果</h1>
<p>途中力尽きて雑にやったけど、、</p>
<p>ニ乃？</p>
<p>五月だと信じてる</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
