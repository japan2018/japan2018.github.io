<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>(◎◎) {Let Python do the boring stuff.........(He? Hona Python will do the homework}} (゜) (゜) | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>(◎◎) {Let Python do the boring stuff&hellip;&hellip;&hellip;(He? Hona Python will do the homework}} (゜) (゜)</h1>
<p>
  <small class="text-secondary">
  
  
  Mar 29, 2020
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/selenium"> Selenium</a></code></small>


<small><code><a href="https://memotut.com/tags/deeplearning"> DeepLearning</a></code></small>


<small><code><a href="https://memotut.com/tags/automation"> automation</a></code></small>


<small><code><a href="https://memotut.com/tags/ai"> AI</a></code></small>

</p>
<pre><code># Did you make Python do boring stuff?
</code></pre>
<h2 id="i-didnt-let-it-do">I didn&rsquo;t let it do</h2>
<p>A book on the cover with a robot like this C-3PO playing grass</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/435280/03f22513-2881-152b-9575-f86ddfeaa219.png" alt="image.png"></p>
<p>It&rsquo;s well-known as a good Python book, and many people have read it.</p>
<p>So who read this book and did Python actually do the boring stuff?
Isn&rsquo;t it quite small? I think there are many people who are satisfied with reading.
I was one of them. I only read it about a year ago. .. .. was</p>
<h1 id="ai-training-started">AI training started</h1>
<p>AI has become a buzz these days. It seems that various companies are starting to introduce AI.
My company is no exception and has begun to introduce AI training.</p>
<p>During the training, I had to create a machine learning model by myself and predict handwritten characters.
*It is almost the same as Kaggle&rsquo;s digit recognizer.</p>
<h3 id="task-flow">Task flow</h3>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/435280/caf9b37b-5d1a-0b3a-a8c8-408cc0e1159f.png" alt="image.png"></p>
<h4 id="1-model-creation">1. Model creation</h4>
<p>Define a model for deep learning.
How many deep learning layers are there, and how many nodes are in each layer?
The overall configuration and fine tuning of the model such as.
‥</p>
<h4 id="2-learning">2. Learning</h4>
<p>The model is trained by passing the data (training data) in which the correct label and the image of the handwritten character are paired.
Here, a part of the training data can be used as verification data (see 3. Prediction) to measure the tentative prediction result. Use the model with the higher tentative prediction results for further work.</p>
<h4 id="3-prediction">3. Prediction:</h4>
<p>The handwritten character is predicted by passing the data (verification data) only for the image of the handwritten character.
The forecast is output as a CSV file.</p>
<h4 id="4-submission">4. Submission:</h4>
<p>Upload the forecast CSV file to the web server prepared by the training company via a browser.</p>
<h4 id="5-result-receipt">5. Result receipt:</h4>
<p>The accuracy of the prediction result is displayed on the web server.</p>
<p>The challenge was to repeat steps 1-5 above to obtain the accuracy of the passing score.</p>
<h3 id="work-game">Work game</h3>
<p>After repeating it several times, I started to think that this was a routine work.
Once the outline of the model is decided, the parameters of the model are tuned and learning -&gt; prediction → submission is just repeated. Moreover, the waiting time is very long! !
I started thinking that this could be automated.</p>
<h1 id="lets-automation-with-python">Let&rsquo;s automation with python</h1>
<p>Let&rsquo;s get Python to do boring things.</p>
<h2 id="once-again-organize-the-flow-of-issues">Once again organize the flow of issues</h2>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/435280/b4d30dec-c021-c358-92ce-6840aad2f23b.png" alt="image.png"></p>
<h3 id="model-creationlearningprediction">Model creation/learning/prediction</h3>
<p>It is done in an interactive python execution environment called Jupyter notebook.
I thought that automation could be realized by making the code written in Jupyter notebook into a python class/function and passing the parameters used for tuning to it as arguments.</p>
<p>How to convert jupyter notebook code to python file
<a href="https://qiita.com/abts/items/25bb611b6d83e646abdd">https://qiita.com/abts/items/25bb611b6d83e646abdd</a></p>
<h3 id="submission-resultresult-reception">Submission result/result reception</h3>
<p>Upload the CSV file output in the prediction to the upload site via google chrome.
It seems that the web browser can be automated by using the Python library called Selenium.</p>
<p>About Selenium
<a href="https://qiita.com/Chanmoro/items/9a3c86bb465c1cce738a">https://qiita.com/Chanmoro/items/9a3c86bb465c1cce738a</a></p>
<h3 id="constraint-only-5-files-can-be-uploaded-per-day">Constraint: Only 5 files can be uploaded per day</h3>
<p>There was a limitation that you can upload only 5 predictive CSV files per day.
Without this, it would be nice to be able to just repeat the above process in a loop. .. ..
It seems that it is necessary to devise here.</p>
<h2 id="automation-flow">Automation flow</h2>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/435280/aff620d4-a903-7aa0-7bcf-8857c27a8616.png" alt="image.png"></p>
<h3 id="what-humans-do">What humans do</h3>
<ul>
<li>Define dozens/hundreds of sets of parameters to be passed to the model in the JSON file in advance.</li>
<li>Watch comics or youtube until all the passed parameters are processed.</li>
<li>After completing all, check the result, if you have reached the goal, end, consider the next parameter based on the result</li>
</ul>
<h3 id="python">Python</h3>
<h4 id="model-creationlearningprediction-1">Model creation/learning/prediction</h4>
<p>This is a loop process.</p>
<ul>
<li>Get parameters used for model from JSON file</li>
<li>Model creation</li>
<li>Learning (temporary prediction accuracy calculated at this time is stored in CSV)</li>
<li>Prediction (one result CSV is created per loop)</li>
</ul>
<h3 id="submissionresult-reception">Submission/Result reception</h3>
<p>Once a day, it loops only 5 times after midnight.
Five times is the maximum number of submissions per day.</p>
<ul>
<li>First, check the CSV that stores the temporary prediction results, and extract the top 5 predicted CSVs</li>
<li>Submit the extracted CSV one loop at a time</li>
<li>Get the prediction result displayed in upload and write it in CSV</li>
</ul>
<h2 id="implementation-coding">Implementation (coding)</h2>
<h3 id="before-that">before that</h3>
<p>As expected, we can not publish the upload site of the training company, so this time we will use kaggle&rsquo;s digit recognizer instead. The basic flow does not change.
Also, kaggle has an API for uploading, but please do not worry about it this time (-_-)
I hope this is a reproduction.</p>
<p>Now, let&rsquo;s briefly explain the actual code used.</p>
<h3 id="code">code</h3>
<h4 id="machine-learning-class">Machine learning class</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:ai.py" data-lang="python:ai.py"><span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> product
<span style="color:#f92672">import</span> os

<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np

np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>seed(<span style="color:#ae81ff">2</span>)

<span style="color:#f92672">from</span> keras.utils.np_utils <span style="color:#f92672">import</span> to_categorical <span style="color:#75715e"># convert to one-hot-encoding</span>
<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> Sequential
<span style="color:#f92672">from</span> keras.layers <span style="color:#f92672">import</span> Dense, Dropout, Flatten, Conv2D, MaxPool2D
<span style="color:#f92672">from</span> keras.optimizers <span style="color:#f92672">import</span> RMSprop
<span style="color:#f92672">from</span> keras.preprocessing.image <span style="color:#f92672">import</span> ImageDataGenerator
<span style="color:#f92672">from</span> keras.callbacks <span style="color:#f92672">import</span> ReduceLROnPlateau
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> train_test_split


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MnistModel</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, train_data_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;train.csv&#39;</span>, test_data_csv<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;test.csv&#39;</span>):
        input_dir <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_dir_path(<span style="color:#e6db74">&#39;input&#39;</span>)
        train_data_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(input_dir, train_data_name)
        test_data_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(input_dir, test_data_csv)
        <span style="color:#75715e">#Load the data</span>
        self<span style="color:#f92672">.</span>train <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(train_data_path)
        self<span style="color:#f92672">.</span>test <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(test_data_path)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_dir_path</span>(self, dir_name):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to directory path
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">            dir_name(str): The name of directory
</span><span style="color:#e6db74">        Return:
</span><span style="color:#e6db74">            str: The directory path
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        base_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(__file__)))
        data_directory <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(base_dir, dir_name)
        <span style="color:#66d9ef">return</span> data_directory


    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">learning_and_predict</span>(self, csv_file_path, config):
        label <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>train[<span style="color:#e6db74">&#34;label&#34;</span>]
        train <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>drop(labels<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;label&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)


        <span style="color:#75715e"># Normalize the data</span>
        train <span style="color:#f92672">=</span> train <span style="color:#f92672">/</span> <span style="color:#ae81ff">255.0</span>
        test <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>test <span style="color:#f92672">/</span> <span style="color:#ae81ff">255.0</span>

        <span style="color:#75715e"># Reshape image in 3 dimensions (height = 28px, width = 28px ,canal = 1)</span>
        train <span style="color:#f92672">=</span> train<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">1</span>)
        test <span style="color:#f92672">=</span> test<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">1</span>)

        <span style="color:#75715e"># Encode labels to one hot vectors (ex :2 -&gt; [0,0,1,0,0,0,0,0,0,0])</span>
        label <span style="color:#f92672">=</span> to_categorical(label, num_classes<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)

        <span style="color:#75715e"># Set the random seed</span>
        random_seed <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>

        <span style="color:#75715e"># Split the train and the validation set for the fitting</span>
        X_train, X_val, Y_train, Y_val <span style="color:#f92672">=</span> train_test_split(train, label, test_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>, random_state<span style="color:#f92672">=</span>random_seed)

        model <span style="color:#f92672">=</span> Sequential()model<span style="color:#f92672">.</span>add(Conv2D(filters<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>, kernel_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">5</span>), padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Same&#39;</span>,
                              activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>, input_shape<span style="color:#f92672">=</span>(<span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">1</span>)))
        model<span style="color:#f92672">.</span>add(Conv2D(filters<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>, kernel_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">5</span>), padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Same&#39;</span>,
                              activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>))
        model<span style="color:#f92672">.</span>add(MaxPool2D(pool_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>)))
        model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.25</span>))
        model<span style="color:#f92672">.</span>add(Conv2D(filters<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>, kernel_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Same&#39;</span>,
                              activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>))
        model<span style="color:#f92672">.</span>add(Conv2D(filters<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>, kernel_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Same&#39;</span>,
                              activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>))
        model<span style="color:#f92672">.</span>add(MaxPool2D(pool_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), strides<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>)))
        model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.25</span>))
        model<span style="color:#f92672">.</span>add(Flatten())
        model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">256</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;relu&#34;</span>))
        model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.5</span>))
        model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">10</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;softmax&#34;</span>))

        optimizer <span style="color:#f92672">=</span> RMSprop(lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>, rho<span style="color:#f92672">=</span><span style="color:#ae81ff">0.9</span>, epsilon<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-08</span>, decay<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0</span>)
        model<span style="color:#f92672">.</span>compile(optimizer<span style="color:#f92672">=</span>optimizer, loss<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;categorical_crossentropy&#34;</span>, metrics<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;accuracy&#34;</span>])

        datagen <span style="color:#f92672">=</span> ImageDataGenerator(
            featurewise_center<span style="color:#f92672">=</span>False,  <span style="color:#75715e"># set input mean to 0 over the dataset</span>
            samplewise_center<span style="color:#f92672">=</span>False,  <span style="color:#75715e"># set each sample mean to 0</span>
            featurewise_std_normalization<span style="color:#f92672">=</span>False,  <span style="color:#75715e"># divide inputs by std of the dataset</span>
            samplewise_std_normalization<span style="color:#f92672">=</span>False,  <span style="color:#75715e"># divide each input by its std</span>
            zca_whitening<span style="color:#f92672">=</span>False,  <span style="color:#75715e"># apply ZCA whitening</span>
            rotation_range<span style="color:#f92672">=</span>config[<span style="color:#e6db74">&#39;ROTATION_RANGE&#39;</span>],  <span style="color:#75715e"># randomly rotate images in the range (degrees, 0 to 180)</span>
            zoom_range<span style="color:#f92672">=</span>config[<span style="color:#e6db74">&#39;ZOOM_RANGE&#39;</span>],  <span style="color:#75715e"># Randomly zoom image</span>
            width_shift_range<span style="color:#f92672">=</span>config[<span style="color:#e6db74">&#39;WIDTH_SHIFT_RANGE&#39;</span>],  <span style="color:#75715e"># randomly shift images horizontally (fraction of total width)</span>
            height_shift_range<span style="color:#f92672">=</span>config[<span style="color:#e6db74">&#39;HEIGHT_SHIFT_RANGE&#39;</span>],  <span style="color:#75715e"># randomly shift images vertically (fraction of total height)</span>
            horizontal_flip<span style="color:#f92672">=</span>False,  <span style="color:#75715e"># randomly flip images</span>
            vertical_flip<span style="color:#f92672">=</span>False)  <span style="color:#75715e"># randomly flip images</span>
        datagen<span style="color:#f92672">.</span>fit(X_train)

        learning_rate_reduction <span style="color:#f92672">=</span> ReduceLROnPlateau(
                                                    monitor<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;val_acc&#39;</span>,
                                                    patience<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,
                                                    verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
                                                    factor<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>,
                                                    min_lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.00001</span>
        )

        epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">86</span>

        history <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>fit_generator(
            datagen<span style="color:#f92672">.</span>flow(
                X_train,
                Y_train,
                batch_size<span style="color:#f92672">=</span>batch_size
            ),
            epochs<span style="color:#f92672">=</span>epochs,
            validation_data<span style="color:#f92672">=</span>(
                X_val,
                Y_val
            ),
            verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,
            steps_per_epoch<span style="color:#f92672">=</span>X_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">//</span> batch_size,
            callbacks<span style="color:#f92672">=</span>[learning_rate_reduction])

        results <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(test)
        results <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argmax(results, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
        results <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(results, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Label&#34;</span>)
        submission <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([pd<span style="color:#f92672">.</span>Series(range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">28001</span>), name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ImageId&#34;</span>), results], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
        submission<span style="color:#f92672">.</span>to_csv(csv_file_path, index<span style="color:#f92672">=</span>False)

        <span style="color:#66d9ef">return</span> history<span style="color:#f92672">.</span>history[<span style="color:#e6db74">&#39;val_acc&#39;</span>][<span style="color:#ae81ff">0</span>]


</code></pre></div><p>今回の機械学習のモデルは以下を参考(丸パクリ)して作成しました。
<a href="https://www.kaggle.com/yassineghouzam/introduction-to-cnn-keras-0-997-top-6">https://www.kaggle.com/yassineghouzam/introduction-to-cnn-keras-0-997-top-6</a></p>
<p>learning_and_predictメソッドにてモデル作成/学習/予測をすべて行います。
configがパラメータを格納したリストになります。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">datagen <span style="color:#f92672">=</span> ImageDataGenerator(
<span style="color:#f92672">....</span>
    rotation_range<span style="color:#f92672">=</span>config[<span style="color:#e6db74">&#39;ROTATION_RANGE&#39;</span>],  <span style="color:#75715e"># randomly rotate images in the range (degrees, 0 to 180)</span>
    zoom_range<span style="color:#f92672">=</span>config[<span style="color:#e6db74">&#39;ZOOM_RANGE&#39;</span>],  <span style="color:#75715e"># Randomly zoom image</span>
    width_shift_range<span style="color:#f92672">=</span>config[<span style="color:#e6db74">&#39;WIDTH_SHIFT_RANGE&#39;</span>],  <span style="color:#75715e"># randomly shift images horizontally (fraction of total width)</span>
    height_shift_range<span style="color:#f92672">=</span>config[<span style="color:#e6db74">&#39;HEIGHT_SHIFT_RANGE&#39;</span>],  <span style="color:#75715e"># randomly shift images vertically (fraction of total height)</span>
<span style="color:#f92672">....</span>
        datagen<span style="color:#f92672">.</span>fit(X_train)
</code></pre></div><p>今回はImageDataGenerator(画像拡張)のパラメータをチューニングの対象にしています。
※なんのことかわからない人は、とりあえず機械学習モデルのパラメータの一つなんだと思っておいてください。</p>
<h4 id="パラメータ定義json">パラメータ定義JSON</h4>
<pre><code>{
    &quot;CONFIG&quot;: [
        {
        &quot;ROTATION_RANGE&quot;: 10,
        &quot;ZOOM_RANGE&quot;: 0.1,
        &quot;WIDTH_SHIFT_RANGE&quot;: 0.1,
        &quot;HEIGHT_SHIFT_RANGE&quot;: 0.1
        },
        {
        &quot;ROTATION_RANGE&quot;: 10,
        &quot;ZOOM_RANGE&quot;: 0.1,
        &quot;WIDTH_SHIFT_RANGE&quot;: 0.1,
        &quot;HEIGHT_SHIFT_RANGE&quot;: 0.2
        },
        {
        &quot;ROTATION_RANGE&quot;: 10,
        &quot;ZOOM_RANGE&quot;: 0.1,
        &quot;WIDTH_SHIFT_RANGE&quot;: 0.1,
        &quot;HEIGHT_SHIFT_RANGE&quot;: 0.3
        },
        {
        &quot;ROTATION_RANGE&quot;: 10,
        &quot;ZOOM_RANGE&quot;: 0.1,
        &quot;WIDTH_SHIFT_RANGE&quot;: 0.1,
        &quot;HEIGHT_SHIFT_RANGE&quot;: 0.4
        }
    ]
}
</code></pre><h4 id="webアップロード用クラス">webアップロード用クラス</h4>
<p>予測CSVをwebサイトにアップロードするためのクラスになります。
主にseleniumにて実装されています。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> time
<span style="color:#f92672">from</span> selenium <span style="color:#f92672">import</span> webdriver
<span style="color:#f92672">from</span> selenium.webdriver.common.by <span style="color:#f92672">import</span> By
<span style="color:#f92672">from</span> selenium.webdriver.support.ui <span style="color:#f92672">import</span> WebDriverWait
<span style="color:#f92672">from</span> selenium.webdriver.support <span style="color:#f92672">import</span> expected_conditions <span style="color:#66d9ef">as</span> EC


DRIVER_FILE_PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;C:\Drivers\chromedriver_win32\chromedriver.exe&#39;</span>DRIVER_FILE_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;chromedriver&#39;</span>
TIMEOUT <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseBrowserOperator</span>(object):
    <span style="color:#e6db74">&#34;&#34;&#34; Base model of browser operator &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">def</span> __init__(self, headless <span style="color:#f92672">=</span> False):
        driver_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(DRIVER_FILE_PATH), DRIVER_FILE_NAME)
        <span style="color:#66d9ef">if</span> headless <span style="color:#f92672">==</span> True:
            options <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>ChromeOptions()
            options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--headless&#39;</span>)
            self<span style="color:#f92672">.</span>browser <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Chrome(driver_path, options<span style="color:#f92672">=</span>options)
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>browser <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Chrome(driver_path)

    <span style="color:#66d9ef">def</span> __del__(self):
        self<span style="color:#f92672">.</span>browser<span style="color:#f92672">.</span>close()


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BrowserOperator</span>(BaseBrowserOperator):
    <span style="color:#e6db74">&#34;&#34;&#34; The browser operator model &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">go_to_page</span>(self, url):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to go to a page
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">            url(str): The url of page
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        self<span style="color:#f92672">.</span>browser<span style="color:#f92672">.</span>get(url)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">click</span>(self, element_xpath, wait<span style="color:#f92672">=</span>True):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to click the page&#39;s element
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        TODO:
</span><span style="color:#e6db74">            implement finding element method other than xpath
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">            element_xpath(str): The xpath of element be clicked
</span><span style="color:#e6db74">            wait(boolean): If disable waiting, please give False.
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        <span style="color:#66d9ef">if</span> wait:
            self<span style="color:#f92672">.</span>wait_element(element_xpath)
        self<span style="color:#f92672">.</span>browser<span style="color:#f92672">.</span>find_element_by_xpath(element_xpath)<span style="color:#f92672">.</span>click()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">input_value</span>(self, element_xpath, value, wait<span style="color:#f92672">=</span>True):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to input value to page&#39;s element
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        TODO:
</span><span style="color:#e6db74">            implement finding element method other than xpath
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">            element_xpath(str): The xpath of element be clicked
</span><span style="color:#e6db74">            value(str): The value be inputed
</span><span style="color:#e6db74">            wait(boolean): If disable waiting, please give False.
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        <span style="color:#66d9ef">if</span> wait:
            self<span style="color:#f92672">.</span>wait_element(element_xpath)
        self<span style="color:#f92672">.</span>browser<span style="color:#f92672">.</span>find_element_by_xpath(element_xpath)<span style="color:#f92672">.</span>send_keys(value)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_value</span>(self, element_xpath, wait<span style="color:#f92672">=</span>True):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to get value from page&#39;s element
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">            element_xpath(str): The xpath of element be clicked
</span><span style="color:#e6db74">            wait(boolean): If disable waiting, please give False.
</span><span style="color:#e6db74">        Returns:
</span><span style="color:#e6db74">            str: Value from page&#39;s element
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        <span style="color:#66d9ef">if</span> wait:
            self<span style="color:#f92672">.</span>wait_element(element_xpath)
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>browser<span style="color:#f92672">.</span>find_element_by_xpath(element_xpath)<span style="color:#f92672">.</span>text

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">import_cookies</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to import cookie informations &#34;&#34;&#34;</span>
        cookies <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>browser<span style="color:#f92672">.</span>get_cookies()
        <span style="color:#66d9ef">for</span> cookie <span style="color:#f92672">in</span> cookies:
            self<span style="color:#f92672">.</span>browser<span style="color:#f92672">.</span>add_cookie({
                <span style="color:#e6db74">&#39;name&#39;</span>: cookie[<span style="color:#e6db74">&#39;name&#39;</span>],
                <span style="color:#e6db74">&#39;value&#39;</span>: cookie[<span style="color:#e6db74">&#39;value&#39;</span>],
                <span style="color:#e6db74">&#39;domain&#39;</span>: cookie[<span style="color:#e6db74">&#39;domain&#39;</span>],
            })

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wait_element</span>(self, element_xpath):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to wait to appear element on page
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        TODO:
</span><span style="color:#e6db74">            implement finding element method other than xpath
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">            element_xpath(str): The xpath of element be used to wait
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        WebDriverWait(self<span style="color:#f92672">.</span>browser, TIMEOUT)<span style="color:#f92672">.</span>until(EC<span style="color:#f92672">.</span>element_to_be_clickable((By<span style="color:#f92672">.</span>XPATH, element_xpath)))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wait_value</span>(self, element_xpath, value, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">300</span>):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to wait until element&#39;s value equal the specific value
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">            element_xpath(str): The xpath of element be used for wait
</span><span style="color:#e6db74">            value(str): The used value for wait
</span><span style="color:#e6db74">            timeout(int): The waiting timeout(sec)
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        state <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
        sec <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> state <span style="color:#f92672">==</span> value:
            state <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>browser<span style="color:#f92672">.</span>find_element_by_xpath(element_xpath)<span style="color:#f92672">.</span>text
            time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
            <span style="color:#66d9ef">if</span> sec <span style="color:#f92672">&gt;</span> timeout:
                <span style="color:#66d9ef">raise</span> TimeoutError(<span style="color:#e6db74">&#34;Timeout!! The value wasn&#39;t available&#34;</span>)
            sec <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>


</code></pre></div><p>各メソッドは以下のように使用します。</p>
<ul>
<li>go_to_page
<ul>
<li>指定のURLに遷移するためのメソッドです。</li>
</ul>
</li>
<li>click
<ul>
<li>webページの要素をクリックするためのメソッドです。</li>
<li>waitを使用することで、要素がクリックできる状態になるまで待機することができます</li>
</ul>
</li>
<li>input_value
<ul>
<li>webページの入力欄に、文字を入力するためのメソッドです。</li>
<li>waitを使用することで、要素がクリックできる状態になるまで待機することができます</li>
</ul>
</li>
<li>get_value
<ul>
<li>webページの要素から値を取得するメソッドです。</li>
<li>waitを使用することで、要素がクリックできる状態になるまで待機することができます</li>
</ul>
</li>
<li>import_cookies
<ul>
<li>cookieをインポートします</li>
</ul>
</li>
</ul>
<p>kaggleにて予測CSVファイルのアップロードは以下のコードで実現できます。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upload_csv_to_kaggle</span>(self, file_path):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to upload csv file to kaggle
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">            file_path(str): The path of csv file uploaded
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        uploader <span style="color:#f92672">=</span> BrowserOperator()
        <span style="color:#75715e"># kaggleのページに遷移</span>
        uploader<span style="color:#f92672">.</span>go_to_page(
            <span style="color:#e6db74">&#39;https://www.kaggle.com/c/digit-recognizer&#39;</span>
        )
        <span style="color:#75715e"># Sign inボタンをクリック</span>
        uploader<span style="color:#f92672">.</span>click(
            <span style="color:#e6db74">&#39;/html/body/main/div[1]/div/div[1]/div[2]/div[2]/div[1]/a/div/button&#39;</span>
        )
        <span style="color:#75715e"># Sign in with google をクリック</span>
        uploader<span style="color:#f92672">.</span>click(
            <span style="color:#e6db74">&#39;/html/body/main/div/div[1]/div/form/div[2]/div/div[1]/a/li/span&#39;</span>
        )
        <span style="color:#75715e"># メールアドレスを入力</span>
        uploader<span style="color:#f92672">.</span>input_value(
            <span style="color:#e6db74">&#39;/html/body/div[1]/div[1]/div[2]/div/div[2]/div/div/div[2]/div/div[1]/div/form/span/section/div/div/div[1]/div/div[1]/div/div[1]/input&#39;</span>,
            GOOGLE_MAILADDRESS
        )
        uploader<span style="color:#f92672">.</span>click(<span style="color:#e6db74">&#39;/html/body/div[1]/div[1]/div[2]/div/div[2]/div/div/div[2]/div/div[2]/div/div[1] /div&#39;</span>
        )
        <span style="color:#75715e"># Enter password</span>
        uploader<span style="color:#f92672">.</span>input_value(
            <span style="color:#e6db74">&#39;/html/body/div[1]/div[1]/div[2]/div/div[2]/div/div/div[2]/div/div[1]/div/form/span/ section/div/div/div[1]/div[1]/div/div/div/div/div[1]/div/div[1]/input&#39;</span>,
            GOOGLE_PASSWORD
        )
        uploader<span style="color:#f92672">.</span>click(
            <span style="color:#e6db74">&#39;/html/body/div[1]/div[1]/div[2]/div/div[2]/div/div/div[2]/div/div[2]/div/div[1] /div/span/span&#39;</span>
        )
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">10</span>) <span style="color:#75715e"># It didn&#39;t go well unless I put sleep</span>
Import <span style="color:#75715e"># cookies</span>
        uploader<span style="color:#f92672">.</span>import_cookies()
Transition to the CSV submission screen of <span style="color:#75715e"># digit recognizer</span>
        uploader<span style="color:#f92672">.</span>go_to_page(<span style="color:#e6db74">&#39;https://www.kaggle.com/c/digit-recognizer/submit&#39;</span>)
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">30</span>) <span style="color:#75715e"># It didn&#39;t go well unless I put sleep</span>
     <span style="color:#75715e"># file upload</span>
        uploader<span style="color:#f92672">.</span>input_value(
            <span style="color:#e6db74">&#39;/html/body/main/div[1]/div/div[5]/div[2]/div/div[3]/div[2]/div[2]/div[1]/div[2 ]/div[1]/div/input&#39;</span>,
            file_path,
            wait<span style="color:#f92672">=</span>False
        )
Input of <span style="color:#75715e"># comment</span>
        uploader<span style="color:#f92672">.</span>input_value(
            <span style="color:#e6db74">&#39;/html/body/main/div[1]/div/div[5]/div[2]/div/div[3]/div[2]/div[2]/div[2]/div[2 ]/div/div/div/div[2]/div/div/textarea&#39;</span>,
            <span style="color:#e6db74">&#39;test&#39;</span>
        )
        uploader<span style="color:#f92672">.</span>wait_element(
            <span style="color:#e6db74">&#39;/html/body/main/div[1]/div/div[5]/div[2]/div/div[3]/div[2]/div[2]/div[1]/div[2 ]/div[1]/ul/li/div/span[1]&#39;</span>)
        uploader<span style="color:#f92672">.</span>click(<span style="color:#e6db74">&#39;/html/body/main/div[1]/div/div[5]/div[2]/div/div[3]/div[2]/div[2]/div[3] /div[2]/div/a&#39;</span>)
        uploader<span style="color:#f92672">.</span>wait_value(
            <span style="color:#e6db74">&#39;/html/body/main/div[1]/div/div[5]/div[2]/div/div[2]/div[2]/div/div[3]/div[1]/div [1]/span&#39;</span>,
            <span style="color:#e6db74">&#39;Complete&#39;</span>
        )

</code></pre></div><h4 id="issue-execution-class">Issue execution class</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:homeworker.py" data-lang="python:homeworker.py"><span style="color:#f92672">import</span> csv
<span style="color:#f92672">import</span> datetime
<span style="color:#f92672">import</span> json
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> time


<span style="color:#f92672">import</span> retrying


<span style="color:#f92672">from</span> mnist_auto.models.operator <span style="color:#f92672">import</span> BrowserOperator
<span style="color:#f92672">from</span> mnist_auto.models.ai <span style="color:#f92672">import</span> MnistModel


DEFAULT_DAILY_SCORES_DIR <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;daily_scores&#39;</span>
DEFAULT_CSVS_DIR <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;results&#39;</span>
DEFAULT_UPLOADED_SCORE_FILE_NAME <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;uploaded_score.csv&#39;</span>
DEFAULT_KAGGLE_DAILY_LIMIT <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
COLUMN_DATETIME <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;DATETIME&#39;</span>
COLUMN_SCORE <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;SCORE&#39;</span>
GOOGLE_MAILADDRESS <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;xxxx@google.com&#39;</span>
GOOGLE_PASSWORD <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;password&#39;</span>



<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseHomeworker</span>(object):
    <span style="color:#e6db74">&#34;&#34;&#34; Base model of homeworker &#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> __init__(self, daily_score_dir_name, csvs_dir_name):
        self<span style="color:#f92672">.</span>daily_score_dir_path <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_dir_path(daily_score_dir_name)
        self<span style="color:#f92672">.</span>csvs_dir_path <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_dir_path(csvs_dir_name)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_dir_path</span>(self, dir_name):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to get directory path
</span><span style="color:#e6db74">            if direcotry doen&#39;t exist, The direcotry will be made
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">            dir_name(str): The directory name
</span><span style="color:#e6db74">        Returns:
</span><span style="color:#e6db74">            str: The directory path
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        base_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(__file__)))
        dir_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(base_dir, dir_name)
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(dir_path):
            os<span style="color:#f92672">.</span>mkdir(dir_path)
        <span style="color:#66d9ef">return</span> dir_path


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Homeworker</span>(BaseHomeworker):
    <span style="color:#e6db74">&#34;&#34;&#34; The homeworker model &#34;&#34;&#34;</span>

    <span style="color:#66d9ef">def</span> __init__(self):
        super()<span style="color:#f92672">.</span>__init__(daily_score_dir_name<span style="color:#f92672">=</span>DEFAULT_DAILY_SCORES_DIR, csvs_dir_name<span style="color:#f92672">=</span>DEFAULT_CSVS_DIR)
        self<span style="color:#f92672">.</span>uploaded_scores <span style="color:#f92672">=</span> []
        self<span style="color:#f92672">.</span>config <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_confing()
        self<span style="color:#f92672">.</span>mnist_model <span style="color:#f92672">=</span> MnistModel()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_confing</span>(self, config_file_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;config.json&#39;</span>):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to get configuration with json format
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">            config_file_name(str): The name of config file
</span><span style="color:#e6db74">        Return:
</span><span style="color:#e6db74">            dict: The dict including config
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        base_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(__file__)))
        config_file_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(base_dir, config_file_name)
        json_file <span style="color:#f92672">=</span> open(config_file_path,<span style="color:#e6db74">&#39;r&#39;</span>)
        <span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>load(json_file)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_daily_to_file</span>(self, date_ymd, date_ymdhm, score):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to write daily data to file
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">            date_ymd(str): The formatted date (YYYYmmdd)
</span><span style="color:#e6db74">            date_ymdhm(str): The formatted date (YYYYmmddHHMM)
</span><span style="color:#e6db74">            score(int): The score
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        date_ymd <span style="color:#f92672">=</span> date_ymd <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;.csv&#39;</span>
        file_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>daily_score_dir_path, date_ymd)
        <span style="color:#66d9ef">with</span> open(file_path,<span style="color:#e6db74">&#39;a&#39;</span>, newline<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>) <span style="color:#66d9ef">as</span> csv_file:
            fieldnames <span style="color:#f92672">=</span> [COLUMN_DATETIME, COLUMN_SCORE]
            writer <span style="color:#f92672">=</span> csv<span style="color:#f92672">.</span>DictWriter(csv_file, fieldnames<span style="color:#f92672">=</span>fieldnames)
            writer<span style="color:#f92672">.</span>writerow({
                COLUMN_DATETIME: date_ymdhm,
                COLUMN_SCORE: score
            })


    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upload_csv_files</span>(self, date_ymd, num<span style="color:#f92672">=</span>DEFAULT_KAGGLE_DAILY_LIMIT):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to upload designated number csv files
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">            data_ymd(str): The formatted data
</span><span style="color:#e6db74">            num(int): The number of file that will be uploaded
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        targets_uploaded <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_tops(date_ymd, num)
        <span style="color:#66d9ef">for</span> target <span style="color:#f92672">in</span> targets_uploaded:
            file_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>daily_score_dir_path, target[COLUMN_DATETIME]) <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;.csv&#39;</span>
            <span style="color:#66d9ef">try</span>:
                self<span style="color:#f92672">.</span>upload_csv_to_kaggle(file_path)
            <span style="color:#66d9ef">except</span> retrying<span style="color:#f92672">.</span>RetryError:<span style="color:#66d9ef">continue</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_tops</span>(self, date_ymd, num):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to get data that have some high score from daily data
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">            num(int): The number of data that will be gotten
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Return:
</span><span style="color:#e6db74">            list: The list that includes some highest data
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        file_name <span style="color:#f92672">=</span> date_ymd <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.csv&#39;</span>
        file_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>daily_score_dir_path, file_name)
        scores <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">with</span> open(file_path, <span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> csv_file:
            reader <span style="color:#f92672">=</span> csv<span style="color:#f92672">.</span>reader(csv_file)
            <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> reader:
                scores<span style="color:#f92672">.</span>append({
                    COLUMN_DATETIME: row[<span style="color:#ae81ff">0</span>],
                    COLUMN_SCORE: row[<span style="color:#ae81ff">1</span>]
                })
        sorted_list <span style="color:#f92672">=</span> sorted(scores, key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> x: x[COLUMN_SCORE], reverse<span style="color:#f92672">=</span>True)
        <span style="color:#66d9ef">if</span> len(sorted_list) <span style="color:#f92672">&lt;</span> num:
            num <span style="color:#f92672">=</span> len(sorted_list)
        <span style="color:#66d9ef">return</span> sorted_list[:num]

    <span style="color:#a6e22e">@retrying.retry</span>(stop_max_attempt_number<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upload_csv_to_kaggle</span>(self, file_path):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to upload csv file to kaggle
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        Params:
</span><span style="color:#e6db74">            file_path(str): The path of csv file uploaded
</span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
        uploader <span style="color:#f92672">=</span> BrowserOperator()
        uploader<span style="color:#f92672">.</span>go_to_page(
            <span style="color:#e6db74">&#39;https://www.kaggle.com/c/digit-recognizer&#39;</span>
        )
        uploader<span style="color:#f92672">.</span>click(
            <span style="color:#e6db74">&#39;/html/body/main/div[1]/div/div[1]/div[2]/div[2]/div[1]/a/div/button&#39;</span>
        )
        uploader<span style="color:#f92672">.</span>click(
            <span style="color:#e6db74">&#39;/html/body/main/div/div[1]/div/form/div[2]/div/div[1]/a/li/span&#39;</span>
        )
        uploader<span style="color:#f92672">.</span>input_value(
            <span style="color:#e6db74">&#39;/html/body/div[1]/div[1]/div[2]/div/div[2]/div/div/div[2]/div/div[1]/div/form/span/section/div/div/div[1]/div/div[1]/div/div[1]/input&#39;</span>,
            GOOGLE_MAILADDRESS
        )
        uploader<span style="color:#f92672">.</span>click(
            <span style="color:#e6db74">&#39;/html/body/div[1]/div[1]/div[2]/div/div[2]/div/div/div[2]/div/div[2]/div/div[1]/div&#39;</span>
        )
        uploader<span style="color:#f92672">.</span>input_value(
            <span style="color:#e6db74">&#39;/html/body/div[1]/div[1]/div[2]/div/div[2]/div/div/div[2]/div/div[1]/div/form/span/section/div/div/div[1]/div[1]/div/div/div/div/div[1]/div/div[1]/input&#39;</span>,
            GOOGLE_PASSWORD
        )
        uploader<span style="color:#f92672">.</span>click(
            <span style="color:#e6db74">&#39;/html/body/div[1]/div[1]/div[2]/div/div[2]/div/div/div[2]/div/div[2]/div/div[1]/div/span/span&#39;</span>
        )
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">10</span>)
        uploader<span style="color:#f92672">.</span>import_cookies()
        uploader<span style="color:#f92672">.</span>go_to_page(<span style="color:#e6db74">&#39;https://www.kaggle.com/c/digit-recognizer/submit&#39;</span>)
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">30</span>)
        uploader<span style="color:#f92672">.</span>input_value(
            <span style="color:#e6db74">&#39;/html/body/main/div[1]/div/div[5]/div[2]/div/div[3]/div[2]/div[2]/div[1]/div[2]/div[1]/div/input&#39;</span>,
            file_path,
            wait<span style="color:#f92672">=</span>False
        )
        uploader<span style="color:#f92672">.</span>input_value(
            <span style="color:#e6db74">&#39;/html/body/main/div[1]/div/div[5]/div[2]/div/div[3]/div[2]/div[2]/div[2]/div[2]/div/div/div/div[2]/div/div/textarea&#39;</span>,
            <span style="color:#e6db74">&#39;test&#39;</span>
        )
        uploader<span style="color:#f92672">.</span>wait_element(
            <span style="color:#e6db74">&#39;/html/body/main/div[1]/div/div[5]/div[2]/div/div[3]/div[2]/div[2]/div[1]/div[2]/div[1]/ul/li/div/span[1]&#39;</span>)
        uploader<span style="color:#f92672">.</span>click(<span style="color:#e6db74">&#39;/html/body/main/div[1]/div/div[5]/div[2]/div/div[3]/div[2]/div[2]/div[3]/div[2]/div/a&#39;</span>)
        uploader<span style="color:#f92672">.</span>wait_value(
            <span style="color:#e6db74">&#39;/html/body/main/div[1]/div/div[5]/div[2]/div/div[2]/div[2]/div/div[3]/div[1]/div[1]/span&#39;</span>,
            <span style="color:#e6db74">&#39;Complete&#39;</span>
        )
        
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">work</span>(self):
        <span style="color:#e6db74">&#34;&#34;&#34; Function to run　a series of tasks
</span><span style="color:#e6db74">                1.  learning and prediction with parameter (It&#39;s written on json)
</span><span style="color:#e6db74">                    one prediction results is outputed as one csv
</span><span style="color:#e6db74">                2.  Writing learning&#39;s score (acc) to another csv.
</span><span style="color:#e6db74">                3.  Once a day, uploading result csv files to kaggle in high score order
</span><span style="color:#e6db74">         &#34;&#34;&#34;</span>
        last_upload_time <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>now()
        <span style="color:#66d9ef">for</span> config <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;CONFIG&#39;</span>]:
            now <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>now()
            now_format_ymdhm <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{0:%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">%H%M}&#39;</span><span style="color:#f92672">.</span>format(now)
            now_format_ymd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;{0:%Y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">}&#39;</span><span style="color:#f92672">.</span>format(now)
            <span style="color:#66d9ef">if</span> (now <span style="color:#f92672">-</span> last_upload_time)<span style="color:#f92672">.</span>days <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
                last_upload_time <span style="color:#f92672">=</span> now
                self<span style="color:#f92672">.</span>upload_csv_files()
            csv_file_name <span style="color:#f92672">=</span> now_format_ymdhm <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.csv&#39;</span>
            csv_file_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>csvs_dir_path, csv_file_name)
            score <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>mnist_model<span style="color:#f92672">.</span>learning_and_predict(csv_file_path<span style="color:#f92672">=</span>csv_file_path, config<span style="color:#f92672">=</span>config)
            self<span style="color:#f92672">.</span>write_daily_to_file(date_ymd<span style="color:#f92672">=</span>now_format_ymd, date_ymdhm<span style="color:#f92672">=</span>now_format_ymdhm, score<span style="color:#f92672">=</span>score)
</code></pre></div><p>workメソッドがメインとなる部分です。</p>
<h1 id="結果発表">結果発表</h1>
<p>ほとんど寝てるだけで、課題をパスすることができました！
各研修受講生のアップロードした回数が表示されるのですが、私だけ桁違いでしたｗ</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/435280/9b0cd532-3882-82e7-9b1c-f8b749ed0de7.png" alt="image.png"></p>
<p>みなさんも退屈なことはPythonにやらせましょう！！では！</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
