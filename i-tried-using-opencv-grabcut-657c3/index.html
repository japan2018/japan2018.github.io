<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>I tried using OpenCV GrabCut | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>I tried using OpenCV GrabCut</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 9, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/image-processing"> image processing</a></code></small>


<small><code><a href="https://memotut.com/tags/opencv"> OpenCV</a></code></small>


<small><code><a href="https://memotut.com/tags/grabcut"> Grabcut</a></code></small>

</p>
<pre><code>It is the 9th day of [MYJlab Advent Calendar](https://qiita.com/advent-calendar/2019/myjlab).
</code></pre>
<h2 id="what-is-this">What is this</h2>
<p>It&rsquo;s the nth decoction, but this is an article using GrabCut of OpenCV to extract the foreground region of an image.</p>
<h2 id="background">background</h2>
<p>My only hobby other than programming is guitar, but I&rsquo;m thinking of creating a service that makes it easy to search the guitar from the outside. In the process, it seems that I will need an image of the guitar alone, so I was looking for a way to remove the background.
Especially when I think that I can do something with a model for segmentation unless I find something good, I tried it because it seems that OpenCV&rsquo;s GrabCut can be easily done.</p>
<h2 id="implementation">Implementation</h2>
<p>Regarding the mechanism, <a href="http://labs.eecs.tottori-u.ac.jp/sd/Member/oyamada/OpenCV/html/py_tutorials/py_imgproc/py_grabcut/py_grabcut.html">Python tutorial</a> is detailed.
The work being done is as follows.</p>
<ol>
<li>Load the image</li>
<li>Specify the rectangle that contains the desired foreground</li>
<li>Run GrabCut</li>
<li>Reflect the result of GrabCut on the original image</li>
</ol>
<p>This time I brought the guitar image from free material</p>
<ul>
<li><a href="https://unsplash.com/photos/YStboKiFPVw">https://unsplash.com/photos/YStboKiFPVw</a></li>
</ul>
<h3 id="load-image">Load image</h3>
<p>The above three images are large in size, so make them smaller beforehand.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">resize_image</span>(filepath, width, height):
    img <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(filepath)
    img<span style="color:#f92672">.</span>thumbnail((width, height),resample<span style="color:#f92672">=</span>Image<span style="color:#f92672">.</span>BICUBIC)
    <span style="color:#66d9ef">return</span> img
IMG_BASE_PATH <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;./img/&#39;</span>
filename <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;guitar.jpeg&#39;</span>
WIDTH <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
HEIGHT <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
file_path <span style="color:#f92672">=</span> IMG_BASE_PATH <span style="color:#f92672">+</span> filename
pillow_img <span style="color:#f92672">=</span> resize_image(file_path, WIDTH, HEIGHT)
resized_image_path <span style="color:#f92672">=</span> f<span style="color:#e6db74">&#39;{IMG_BASE_PATH}resized_{filename}&#39;</span>
pillow_img<span style="color:#f92672">.</span>save(resized_image_path)
</code></pre></div><p>After resizing, use OpenCV to reload. Actually, I think there is a method to convert the image read by Pillow to the image of OpenCV, but this time it is good.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">img <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imread(resized_image_path)
</code></pre></div><h3 id="specify-the-rectangle-that-encloses-the-desired-foreground">Specify the rectangle that encloses the desired foreground</h3>
<p>GrabCut is an interactive method for extracting the foreground. So you need to specify where the person you are using contains the desired foreground. This time it&rsquo;s a pain, so I&rsquo;ll enclose almost all of the image in a rectangle.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#Argument is x coordinate, y coordinate, width, height</span>
rect <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>, pillow_img<span style="color:#f92672">.</span>size[<span style="color:#ae81ff">0</span>],pillow_img<span style="color:#f92672">.</span>size[<span style="color:#ae81ff">1</span>])
</code></pre></div><p>If 0 is specified for the x and y coordinates here, the following error occurred when GrabCut was executed.</p>
<pre><code>- ------------------------------------------------- -------------------------
error Traceback (most recent call last)
&lt;ipython-input-46-73e975b54ddd&gt; in &lt;module&gt;
      1 rect = (0,0, pillow_img.size[0],pillow_img.size[1])
- ---&gt; 2 cv2.grabCut(img,mask,rect,bgdModel,fgdModel,5,cv2.GC_INIT_WITH_RECT)

error: OpenCV(4.1.2) /io/opencv/modules/imgproc/src/grabcut.cpp:386: error: (-215:Assertion failed) !bgdSamples.empty() &amp;&amp; !fgdSamples.empty() in function ' initGMMs'
</code></pre><p>If you look at the tutorial</p>
<blockquote>
<p>The user first draws a rectangle around the foreground area as an initial value (foreground objects should not stick out of this rectangle).</p>
</blockquote>
<p>In this case, it doesn&rsquo;t jump out, but since it surrounds all areas, it feels like it&rsquo;s no good.</p>
<h3 id="execute-grabcut">execute GrabCut</h3>
<p>Create the numpy array for mask and the array needed for GrabCut.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">mask <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros(img<span style="color:#f92672">.</span>shape[:<span style="color:#ae81ff">2</span>],np<span style="color:#f92672">.</span>uint8)

bgdModel <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">65</span>),np<span style="color:#f92672">.</span>float64)
fgdModel <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">65</span>),np<span style="color:#f92672">.</span>float64)
</code></pre></div><p>The number of iterations is 5 as it is in the tutorial.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">cv2<span style="color:#f92672">.</span>grabCut(img,mask,rect,bgdModel,fgdModel,<span style="color:#ae81ff">5</span>,cv2<span style="color:#f92672">.</span>GC_INIT_WITH_RECT)
</code></pre></div><h3 id="reflect-the-result-of-grabcut-on-the-original-image">Reflect the result of GrabCut on the original image</h3>
<p>Let&rsquo;s see the result of GrabCut before reflecting it.
GrabCut makes four classifications for each pixel of the image. According to the tutorial, these four categories have the following meanings:</p>
<blockquote>
<p>Pixel value 0 in the mask image is background, 1 pixel is foreground, 2 pixel is background, 3 pixel is foreground</p>
</blockquote>
<p>You can get only the foreground image by filling the mask 0 and 2 with black.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">mask2 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where((mask<span style="color:#f92672">==</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">|</span>(mask<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>),<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;uint8&#39;</span>)
img <span style="color:#f92672">=</span> img<span style="color:#f92672">*</span>mask2[:,:,np<span style="color:#f92672">.</span>newaxis]
</code></pre></div><h2 id="result">result</h2>
<h3 id="before-processing">Before processing</h3>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/167075/2a76786c-8b60-4924-de92-5863bc5a4b48.jpeg" alt="guitar3.jpeg"></p>
<h3 id="after-treatment">After treatment</h3>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/167075/d5d1e4b8-57cf-82be-58e4-090df956e1ba.jpeg" alt="segmented_guitar3.jpeg"></p>
<p>It&rsquo;s cut off nicely, but the background on the bottom left and the gloss of the floor remain. Actually, it is possible to correct it, but this time there is no problem with this accuracy, so I will end here.</p>
<p>##Finally
I tried using OpenCV GrabCut. I&rsquo;m surprised that you can do this without using a neural network.
Depending on the image size, the speed may be abnormally slow, so I would like to investigate if there is a solution to this problem in the future.</p>
<h2 id="referenced-site">Referenced site</h2>
<ul>
<li><a href="http://labs.eecs.tottori-u.ac.jp/sd/Member/oyamada/OpenCV/html/py_tutorials/py_imgproc/py_grabcut/py_grabcut.html">http://labs.eecs.tottori-u.ac.jp/sd/Member/oyamada/OpenCV/html/py_tutorials/py_imgproc/py_grabcut/py_grabcut.html</a></li>
<li><a href="https://qiita.com/knok/items/63e32adef9cfff095d49">https://qiita.com/knok/items/63e32adef9cfff095d49</a></li>
<li><a href="https://note.nkmk.me/python-opencv-bgr-rgb-cvtcolor/">https://note.nkmk.me/python-opencv-bgr-rgb-cvtcolor/</a></li>
<li><a href="https://ky-orihara.hatenablog.com/entry/2019/03/12/021106">https://ky-orihara.hatenablog.com/entry/2019/03/12/021106</a></li>
</ul>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
