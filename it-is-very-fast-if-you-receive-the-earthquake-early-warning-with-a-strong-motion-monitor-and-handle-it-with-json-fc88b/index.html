<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://japan2018.github.io/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://japan2018.github.io/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://japan2018.github.io/favicon-16x16.png">

  
  <link rel="manifest" href="https://japan2018.github.io/site.webmanifest">

  
  <link rel="mask-icon" href="https://japan2018.github.io/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://japan2018.github.io/css/bootstrap.min.css" />

  
  <title>It is very fast if you receive the Earthquake Early Warning with a strong motion monitor and handle it with JSON | Some Title</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>It is very fast if you receive the Earthquake Early Warning with a strong motion monitor and handle it with JSON</h1>
<p>
  <small class="text-secondary">
  
  
  May 13, 2020
  </small>
  

<small><code><a href="https://japan2018.github.io/tags/python">Python</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/centos"> CentOS</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/discord"> discord</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/earthquake-early-warning"> Earthquake early warning</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/strong-motion-monitor"> Strong motion monitor</a></code></small>

</p>
<pre><code>## Overview
</code></pre>
<ul>
<li>POST JSON to the Python web server from the Chrome extension &ldquo;strong motion monitor&rdquo;</li>
<li>Cook the received JSON and throw it to Discord&rsquo;s webhook, Slack, etc. (POST)</li>
<li>Fast, cheap, delicious</li>
<li>How fast it is, it is output to the channel of Discord at the moment when the breaking news is received on the strong motion monitor of the macbook</li>
</ul>
<h2 id="assumptions">Assumptions</h2>
<ul>
<li>Operation has been confirmed with CentOS7 and Python3.</li>
<li>Use Google Chrome extension &ldquo;strong motion monitor extension&rdquo;.</li>
<li>JSON is sent to the Python web server by &ldquo;Send earthquake information&rdquo; from the above extension.</li>
</ul>
<h2 id="background">Background</h2>
<ul>
<li>I created a mechanism to get tweets of Twitter Earthquake Early Warning account via IFTTT,
The response time varies depending on the server status of Twitter and it is sharp.
In the worst case, timely acquisition is not possible.</li>
<li>I want to output and share the Earthquake Early Warnings to my Discord channel as well as myself.</li>
<li>My hobby is earthquake monitoring.</li>
<li>Because it started to be rough in 2020, for data collection.</li>
</ul>
<h2 id="how-to-realize">How to realize</h2>
<h3 id="data-flow-image-sorry-for-the-character-string">Data flow image (sorry for the character string)</h3>
<p>Strong motion monitor Earthquake information Push server → CentOS 7 Google Chrome → CentOS 7 Python Web server → Discord/Slack/Twitter API</p>
<h3 id="centos-side">CentOS side</h3>
<ul>
<li>Start with runlevel 5 because it handles GUI</li>
<li>Install Google Chrome</li>
<li>Install Chrome Extension &ldquo;Strong Quake Monitor Extension&rdquo;</li>
<li>I wrote a web server in Python, so I installed Python3. I think that Node.js is all right.</li>
<li>Specify &ldquo;http://localhost:8000&rdquo; for &ldquo;Send earthquake information&rdquo; in the settings of the extension</li>
</ul>
<h4 id="supplement">Supplement</h4>
<ul>
<li>Dependency of rpm package required for installing Google Chrome is complicated (it is also related to booting OS with minimal configuration)</li>
<li>The data to fly from the extension is in JSON format.</li>
<li>Quoting from the log as of May 13, 2020.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JSON" data-lang="JSON">{
<span style="color:#960050;background-color:#1e0010">&#39;type&#39;:&#39;eew&#39;,</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">In</span> <span style="color:#960050;background-color:#1e0010">case</span> <span style="color:#960050;background-color:#1e0010">of</span> <span style="color:#960050;background-color:#1e0010">Earthquake</span> <span style="color:#960050;background-color:#1e0010">Early</span> <span style="color:#960050;background-color:#1e0010">Warning,</span> <span style="color:#960050;background-color:#1e0010">String</span> <span style="color:#960050;background-color:#1e0010">type</span> <span style="color:#960050;background-color:#1e0010">eew</span> <span style="color:#960050;background-color:#1e0010">string</span>
<span style="color:#960050;background-color:#1e0010">&#39;time&#39;:</span> <span style="color:#960050;background-color:#1e0010">&#39;1589131429000&#39;,</span>
<span style="color:#960050;background-color:#1e0010">&#39;report&#39;:</span> <span style="color:#960050;background-color:#1e0010">&#39;1&#39;,</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">In</span> <span style="color:#960050;background-color:#1e0010">the</span> <span style="color:#960050;background-color:#1e0010">case</span> <span style="color:#960050;background-color:#1e0010">of</span> <span style="color:#960050;background-color:#1e0010">the</span> <span style="color:#960050;background-color:#1e0010">first</span> <span style="color:#960050;background-color:#1e0010">report,</span> <span style="color:#960050;background-color:#1e0010">String</span> <span style="color:#960050;background-color:#1e0010">type</span> <span style="color:#960050;background-color:#1e0010">1</span> <span style="color:#960050;background-color:#1e0010">string.</span> <span style="color:#960050;background-color:#1e0010">The</span> <span style="color:#960050;background-color:#1e0010">final</span> <span style="color:#960050;background-color:#1e0010">report</span> <span style="color:#960050;background-color:#1e0010">is</span> <span style="color:#960050;background-color:#1e0010">a</span> <span style="color:#960050;background-color:#1e0010">character</span> <span style="color:#960050;background-color:#1e0010">string</span> <span style="color:#960050;background-color:#1e0010">called</span> <span style="color:#960050;background-color:#1e0010">final</span> <span style="color:#960050;background-color:#1e0010">of</span> <span style="color:#960050;background-color:#1e0010">String</span> <span style="color:#960050;background-color:#1e0010">type</span>
<span style="color:#960050;background-color:#1e0010">&#39;epicenter&#39;:&#39;Iyonada&#39;,</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">Epicenter</span>
<span style="color:#960050;background-color:#1e0010">&#39;depth&#39;:</span> <span style="color:#960050;background-color:#1e0010">&#39;60km&#39;,</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">hypocenter</span> <span style="color:#960050;background-color:#1e0010">depth</span>
<span style="color:#960050;background-color:#1e0010">&#39;magnitude&#39;:</span> <span style="color:#960050;background-color:#1e0010">3.5,</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">magnitude</span> <span style="color:#960050;background-color:#1e0010">indicating</span> <span style="color:#960050;background-color:#1e0010">the</span> <span style="color:#960050;background-color:#1e0010">magnitude</span> <span style="color:#960050;background-color:#1e0010">of</span> <span style="color:#960050;background-color:#1e0010">the</span> <span style="color:#960050;background-color:#1e0010">earthquake</span>
<span style="color:#960050;background-color:#1e0010">&#39;latitude&#39;:</span> <span style="color:#960050;background-color:#1e0010">33.8,</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">The</span> <span style="color:#960050;background-color:#1e0010">two</span> <span style="color:#960050;background-color:#1e0010">lines</span> <span style="color:#960050;background-color:#1e0010">here</span> <span style="color:#960050;background-color:#1e0010">are</span> <span style="color:#960050;background-color:#1e0010">probably</span> <span style="color:#960050;background-color:#1e0010">latitude</span> <span style="color:#960050;background-color:#1e0010">and</span> <span style="color:#960050;background-color:#1e0010">longitude</span>
<span style="color:#960050;background-color:#1e0010">&#39;longitude&#39;:</span> <span style="color:#960050;background-color:#1e0010">132.1,</span>
<span style="color:#960050;background-color:#1e0010">&#39;intensity&#39;:</span> <span style="color:#960050;background-color:#1e0010">&#39;2&#39;,</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">predicted</span> <span style="color:#960050;background-color:#1e0010">seismic</span> <span style="color:#960050;background-color:#1e0010">intensity</span>
<span style="color:#960050;background-color:#1e0010">&#39;index&#39;:</span> <span style="color:#960050;background-color:#1e0010">2</span>
}
</code></pre></div><p>The information I want is mostly String type and Float type, so be aware of only that.
The acceleration detection log is also posted for reference.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JSON" data-lang="JSON">{
<span style="color:#960050;background-color:#1e0010">&#39;type&#39;:&#39;pga_alert&#39;,</span>
<span style="color:#960050;background-color:#1e0010">&#39;time&#39;:</span> <span style="color:#960050;background-color:#1e0010">&#39;1589131441839&#39;,</span>
<span style="color:#960050;background-color:#1e0010">&#39;max_pga&#39;:</span> <span style="color:#960050;background-color:#1e0010">0.637,</span>
<span style="color:#960050;background-color:#1e0010">&#39;new&#39;:</span> <span style="color:#960050;background-color:#1e0010">True,</span>
<span style="color:#960050;background-color:#1e0010">&#39;estimated_intensity&#39;:</span> <span style="color:#960050;background-color:#1e0010">0,</span>
<span style="color:#960050;background-color:#1e0010">&#39;region_list&#39;:</span> <span style="color:#960050;background-color:#1e0010">[&#39;Ehime&#39;]</span>
}
</code></pre></div><h3 id="python-side">Python side</h3>
<p>Run as a web server.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> http.server <span style="color:#f92672">import</span> BaseHTTPRequestHandler, HTTPServer
<span style="color:#f92672">from</span> urllib.parse <span style="color:#f92672">import</span> parse_qs, urlparse
<span style="color:#f92672">import</span> sendToDiscord <span style="color:#75715e"># Own code. I cooked in this and posted on the Discord webhook.</span>


address <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;0.0.0.0&#39;</span>, <span style="color:#ae81ff">8000</span>)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyHTTPRequestHandler</span>(BaseHTTPRequestHandler):

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_GET</span>(self):

parsed_path <span style="color:#f92672">=</span> urlparse(self<span style="color:#f92672">.</span>path)
self<span style="color:#f92672">.</span>send_response(<span style="color:#ae81ff">200</span>)
self<span style="color:#f92672">.</span>send_header(<span style="color:#e6db74">&#39;Content-Type&#39;</span>,<span style="color:#e6db74">&#39;text/plain; charset=utf-8&#39;</span>)
self<span style="color:#f92672">.</span>end_headers()
self<span style="color:#f92672">.</span>wfile<span style="color:#f92672">.</span>write(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Hello from do_GET&#39;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_POST</span>(self):

parsed_path <span style="color:#f92672">=</span> urlparse(self<span style="color:#f92672">.</span>path)
content_length <span style="color:#f92672">=</span> int(self<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#39;content-length&#39;</span>])
It<span style="color:#e6db74">&#39;s a sequel.</span>
sendToDiscord<span style="color:#f92672">.</span>readJson(<span style="color:#e6db74">&#39;{}&#39;</span><span style="color:#f92672">.</span>format((self<span style="color:#f92672">.</span>rfile<span style="color:#f92672">.</span>read(content_length)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))))
It<span style="color:#e6db74">&#39;s a sequel.</span>
self<span style="color:#f92672">.</span>send_response(<span style="color:#ae81ff">200</span>)
self<span style="color:#f92672">.</span>send_header(<span style="color:#e6db74">&#39;Content-Type&#39;</span>,<span style="color:#e6db74">&#39;text/plain; charset=utf-8&#39;</span>)
self<span style="color:#f92672">.</span>end_headers()
self<span style="color:#f92672">.</span>wfile<span style="color:#f92672">.</span>write(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Hello from do_POST&#39;</span>)

<span style="color:#66d9ef">with</span> HTTPServer(address, MyHTTPRequestHandler) <span style="color:#66d9ef">as</span> server:
    server<span style="color:#f92672">.</span>serve_forever()
</code></pre></div><p>It&rsquo;s clever, but I just added one line to the sample code.
The received JSON is poured into the function as it is and processed.</p>
<p>2020/05/19 Addendum
to @sirorabi516
Paste a part of the throwing code to Discord&rsquo;s webhook.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> json
<span style="color:#f92672">import</span> requests

webhookUrl <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;DISCORD WEBHOOK URL&#34;</span>

<span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">Send a message to Discord Webhook
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sendDiscord</span>(msg):

<span style="color:#75715e"># Create JSON</span>
payload <span style="color:#f92672">=</span> {
<span style="color:#e6db74">&#34;content&#34;</span>: <span style="color:#e6db74">&#34;{0}&#34;</span><span style="color:#f92672">.</span>format(msg)
}

<span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">It is better to check the status code in the contents of res and incorporate retry processing
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>
<span style="color:#75715e"># Send to Discord</span>
res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(webhookUrl, json<span style="color:#f92672">.</span>dumps(payload), headers<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;Content-Type&#39;</span>:<span style="color:#e6db74">&#39;application/json&#39;</span>})
<span style="color:#66d9ef">return</span>


<span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">Create a message by converting the JSON received from the web server into a dictionary
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">readJson</span>(jsonData):
jsonData <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(jsonData)

<span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">If the earthquake early warning, first report, and expected seismic intensity 3 or more are processed
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>
It<span style="color:#e6db74">&#39;s a sequel.</span>
<span style="color:#75715e"># get first eew message</span>
<span style="color:#66d9ef">if</span> jsonData<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;type&#39;</span>) <span style="color:#f92672">==</span><span style="color:#e6db74">&#39;eew&#39;</span> <span style="color:#f92672">and</span> jsonData<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;report&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#f92672">and</span> int(jsonData<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;intensity&#39;</span>)) <span style="color:#f92672">&gt;</span><span style="color:#ae81ff">2</span>:
magnitude <span style="color:#f92672">=</span> float(jsonData<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;magnitude&#39;</span>))

<span style="color:#75715e"># get EQ Data</span>
epicenter <span style="color:#f92672">=</span> str(jsonData<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;epicenter&#39;</span>))
depth <span style="color:#f92672">=</span> str(jsonData<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;depth&#39;</span>))
intensity <span style="color:#f92672">=</span> str(jsonData<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;intensity&#39;</span>))

<span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">Output message creation part of discord. If fix is specified, the whole sentence can be made yellow.
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>
<span style="color:#75715e"># add EQ Data</span>
msg <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;&#39;`&#39;&#39;fix
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Earth Earthquake Bulletin (1st report)
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">Earthquake source: {0}
</span><span style="color:#e6db74">Expected seismic intensity: {1}
</span><span style="color:#e6db74">Regulation: M{2}
</span><span style="color:#e6db74">Depth: {3}
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">```&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(epicenter, intensity, str(magnitude), depth)
sendDiscord(msg)
<span style="color:#66d9ef">return</span>

<span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">In the case of a false alarm, pga_alert_cancel will be sent, so be sure to detect that as well.
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>
<span style="color:#75715e"># Alert Cancel</span>
<span style="color:#66d9ef">if</span> jsonData<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;type&#39;</span>) <span style="color:#f92672">==</span><span style="color:#e6db74">&#39;pga_alert_cancel&#39;</span>:
msg <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;### Cancel Message ###&#39;</span>
sendDiscord(msg)
<span style="color:#66d9ef">return</span>
</code></pre></div><p>I wrote it like this.
I think the last&rsquo;pga_alert_cancel&rsquo; is mandatory.
Because, in the past, the information &ldquo;Northern Tokyo Bay, seismic intensity 7&rdquo; flew from the observation point in Tokyo in the first report.
After receiving it, I panicked, &ldquo;Eh? Isn&rsquo;t this the level at which Tokyo will be destroyed?&rdquo;
After all, it was a bad news that it was a false alarm due to the impact of lightning strike, but sending information to other places does not cause a strange panic.
I have to inform them that it was a false alarm.
Of course for myself.</p>
<p><strong>Notes</strong></p>
<ul>
<li>If you do not leave do_GET, JSON will not come from Chrome extension.</li>
<li>When checking Chrome extension in developer mode, the information destination is that it is a health check.</li>
<li>At that time, if you do not return a normal response, you will not be sent information.</li>
</ul>
<h2 id="finally">Finally</h2>
<p>At the moment, I think this method is easy to handle earthquake information for advanced users at a detonating speed without incurring any cost.
Since data is passed in JSON, you can embed it in the message as you like,
There is also an atmosphere that information can be passed to any place you like, so you can still use it in other ways.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
