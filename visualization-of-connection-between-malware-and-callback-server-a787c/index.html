<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Visualization of connection between malware and callback server | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Visualization of connection between malware and callback server</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 11, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/networkx"> networkx</a></code></small>


<small><code><a href="https://memotut.com/tags/graph-theory"> graph theory</a></code></small>


<small><code><a href="https://memotut.com/tags/malware"> Malware</a></code></small>


<small><code><a href="https://memotut.com/tags/callback_server"> callback_server</a></code></small>

</p>
<pre><code>Visualization of connection between #malware and callback server
</code></pre>
<p>##this is
This article is about visualization of connection between malware and callback server for practicing networkx.</p>
<p>##environment
Kali Linux
python 2.2.17</p>
<h2 id="rough-implementation-flow">Rough implementation flow</h2>
<ol>
<li>Argument setting
2.suffix organization
3.Hostname acquisition function</li>
<li>Scan target directory</li>
<li>Network creation</li>
</ol>
<h2 id="load-the-required-libraries">Load the required libraries</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pefile
<span style="color:#f92672">import</span> sys
<span style="color:#f92672">import</span> argparse
<span style="color:#f92672">import</span> os
<span style="color:#f92672">import</span> pprint
<span style="color:#f92672">import</span> networkx
<span style="color:#f92672">import</span> re
<span style="color:#f92672">from</span> networkx.drawing.nx_agraph <span style="color:#f92672">import</span> write_dot
<span style="color:#f92672">import</span> collections
<span style="color:#f92672">from</span> networkx.algorithms <span style="color:#f92672">import</span> bipartite
</code></pre></div><h2 id="setting-command-line-arguments">Setting command line arguments</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">args <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
args<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;target&#34;</span>)
args<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;filename&#34;</span>)
args<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;malware_pro&#34;</span>)
args<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;hostname_pro&#34;</span>)
args <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>parse_args()
network <span style="color:#f92672">=</span> networkx<span style="color:#f92672">.</span>Graph()
</code></pre></div><h2 id="rearranging-suffixes">Rearranging suffixes</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">suffixes <span style="color:#f92672">=</span> map(<span style="color:#66d9ef">lambda</span> string: string<span style="color:#f92672">.</span>strip(), open(<span style="color:#e6db74">&#34;suffixes.txt&#34;</span>))
suffixes <span style="color:#f92672">=</span> set(suffixes)
</code></pre></div><p><font color="SlateGray"> In the last two lines, sort the suffixes in suffixes.txt using map and lambda expressions. You can create your own suffixes.txt, but it&rsquo;s a pain. This time I borrow from <a href="https://www.malwaredatascience.com/">Malware Data Science</a>.Also,borrowthemalwaresampletopasstothetargetargument.Firstofall,becausethelinefeedcodeinsuffixes.txtisanobstacle,strip(). Note that in python3, the return value of the map function will be the object of the map function. </font>
<br></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_hostnames</span>(string):
    tmp <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-]{,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}&#39;</span>,string)
    hostnames <span style="color:#f92672">=</span> filter(<span style="color:#66d9ef">lambda</span> hostname: hostname<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;.&#34;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>lower() <span style="color:#f92672">in</span> suffixes, tmp)
    <span style="color:#66d9ef">return</span> hostnames
</code></pre></div><p><font color="SlateGray">Specify the domain with regular expression and separate with &ldquo;.&rdquo;. Make the last element lowercase and check if it matches suffixes using filter and lambda expression. This is also python3&hellip;</font>
<br></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">for</span> root,dirs,files <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>walk(args<span style="color:#f92672">.</span>target):
    <span style="color:#66d9ef">for</span> file <span style="color:#f92672">in</span> files:
    <span style="color:#66d9ef">try</span>:
         pe <span style="color:#f92672">=</span> pefile<span style="color:#f92672">.</span>PE(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(root, file))
    <span style="color:#66d9ef">except</span> pefile<span style="color:#f92672">.</span>PEFormatError:
        <span style="color:#66d9ef">continue</span>
        f_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(root, file)
        contents <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>popen(<span style="color:#e6db74">&#34;strings&#39;{0}&#39;&#34;</span><span style="color:#f92672">.</span>format(f_path))<span style="color:#f92672">.</span>read()
        hostnames <span style="color:#f92672">=</span> get_hostnames(contents)
        <span style="color:#66d9ef">if</span> len(hostnames):
            network<span style="color:#f92672">.</span>add_node(file,label<span style="color:#f92672">=</span>file ,color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;blue&#39;</span>, penwidth<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,bipartite<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
        <span style="color:#66d9ef">for</span> hostname <span style="color:#f92672">in</span> hostnames:
            network<span style="color:#f92672">.</span>add_node(hostname,label<span style="color:#f92672">=</span>hostname,color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;purple&#39;</span>, penwidth<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>,bipartite<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
            network<span style="color:#f92672">.</span>add_edge(hostname, file ,penwidth<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
    <span style="color:#66d9ef">if</span> hostnames:
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Extracted hostname from:&#34;</span>, file
        pprint<span style="color:#f92672">.</span>pprint(hostname)
</code></pre></div><p>Scan the target directory with <font color="SlateGray">walk, get the root directory, subdirectory, and file path with the for statement, and check pefile mobilization with try. If not, go to the next loop. Store the full path of the pe file in f_path and pass the printable character string as an argument to the get_hostnames function.
Once you get the host name, create the contentsalware and host networks respectively. Next, if the host name is found, register the file path to one of the two-part network, and register the host name itself to the other part of the two-part network. Show the file path where the host name was acquired on the command line at the time of execution with the last if statement </font>
<br></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">write_dot(network, args<span style="color:#f92672">.</span>filename)
codes<span style="color:#f92672">=</span> set(n <span style="color:#66d9ef">for</span> n,d <span style="color:#f92672">in</span> network<span style="color:#f92672">.</span>nodes(data<span style="color:#f92672">=</span>True) <span style="color:#66d9ef">if</span> d[<span style="color:#e6db74">&#39;bipartite&#39;</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>)
hostname <span style="color:#f92672">=</span> set(network)<span style="color:#f92672">-</span>codes
</code></pre></div><p><font color="SlateGray"> Write the network to filename in the first line. Store the malware side with bipartite=0 in code. By setting network.nodes(data=True), a tuple consisting of a dictionary of node names and attributes of nodes is returned. Similarly, enter the host name in hostname. <font>
<br></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">codes <span style="color:#f92672">=</span> bipartite<span style="color:#f92672">.</span>projected_graph(network, codes)
hostname <span style="color:#f92672">=</span> bipartite<span style="color:#f92672">.</span>projected_graph(network, hostname)
</code></pre></div><p><font color="SlateGray"> Create a projection for each malware and host. Here, the projection is a simplification of the two-part network, and in the case of malware (codes), for example, malware that has a common host name is connected. </font>
<br></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">write_dot(codes ,args<span style="color:#f92672">.</span>malware_pro)
write_dot(hostname ,args<span style="color:#f92672">.</span>hostname_pro)
</code></pre></div><p><font color="SlateGray"> Write each created projection to a file. </font>
Visualize with ##fdp</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">fdp filename<span style="color:#f92672">.</span>dot <span style="color:#f92672">-</span>T png <span style="color:#f92672">-</span>o filename<span style="color:#f92672">.</span>png <span style="color:#f92672">-</span>Goverlap<span style="color:#f92672">=</span>false
fdp malware_pro<span style="color:#f92672">.</span>dot <span style="color:#f92672">-</span>T png <span style="color:#f92672">-</span>o malwre_pro<span style="color:#f92672">.</span>png <span style="color:#f92672">-</span>Goverlap<span style="color:#f92672">=</span>false
fdp hostname_pro<span style="color:#f92672">.</span>dot <span style="color:#f92672">-</span>T png <span style="color:#f92672">-</span>o hostname_pro<span style="color:#f92672">.</span>png <span style="color:#f92672">-</span>Goverlap<span style="color:#f92672">=</span>false
</code></pre></div><p><font color="SlateGray">fdp is a tool that visualizes networks based on force orientation. There are other tools such as sfdp, but this time I will omit them. Try to run. <font></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">filename<span style="color:#f92672">.</span>png
malware_pro<span style="color:#f92672">.</span>pnf
hostname_pro<span style="color:#f92672">.</span>png
</code></pre></div><p>You can do it with an image file called <font color="SlateGray">. <font>
<br></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">eog filename<span style="color:#f92672">.</span>png
</code></pre></div><p><font color="SlateGray"> Trying to open it <font>
<br>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/197716/f7a2fcfb-5935-609c-6991-a25f7444b2b4.png" alt="a.png"></p>
<p><font color="SlateGray"> completed ^^<font>
<br></p>
<p>##By the way, is power oriented?
<font color="SlateGray"> The length of the edge is a problem when laying out the network. If the node weights are the same, it is desirable that the edge lengths are the same. However, if the number of nodes is 4 or more, it is absolutely impossible to make all the nodes the same length, right? Therefore, we try to minimize this distortion. That is where the force-oriented algorithm comes out. Simulating the edges like springs will automatically try to make the distance between the nodes as uniform as possible. It&rsquo;s great. Then. </font></p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
