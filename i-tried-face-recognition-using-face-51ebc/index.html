<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>I tried face recognition using Face&#43;&#43; | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>I tried face recognition using Face++</h1>
<p>
  <small class="text-secondary">
  
  
  Nov 14, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/opencv"> OpenCV</a></code></small>


<small><code><a href="https://memotut.com/tags/face-recognition"> face recognition</a></code></small>

</p>
<pre><code>#Execution environment
</code></pre>
<p><strong>Ubuntu 16.04</strong>
<strong>Python 3.7</strong>
<strong>opencv-python 4.1.0.25</strong>
#Overview
Let&rsquo;s try face recognition using the API &ldquo;<a href="https://www.faceplusplus.com/">Face++</a>&rdquo; developed by China.
The procedure is as follows.</p>
<p>** ① Account registration
② Get the API to use
③ Confirmation of demo
④ Program
⑤ Face recognition**</p>
<p>##** ① Account registration**
First, you need to register an account to use Face++.
Register on the official page and get your **API Key** and **API Secret**.
These are required when using each API.</p>
<p>You can check the created API Key and API Secret in Face++ Apps/API Key.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/dd6bed5c-a243-f1cb-7847-06b04322936f.png" alt="a.png"></p>
<p>##** ② Acquire the API to use **
There are three types of APIs used in the face recognition program created this time.
Both are in a group called Facial Recognition,
**Detect API** and **Search API** are used to identify faces, and **FaceSet Create API** is used to register faces.
The parameters of each API can be confirmed in the official <a href="https://console.faceplusplus.com/documents/5678948">API reference</a>.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/85d030bd-e2f0-39de-a458-30e77b5c9826.png" alt="b.png">
This time, use the API in the red frame.</p>
<p>##<strong>③ Confirmation of demo</strong>
Since Search API etc. is <a href="https://www.faceplusplus.com/face-searching/#demo">Demo</a> on the official page of Face++, let&rsquo;s see what kind of output can be obtained.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/356ceaf1-a947-a2d8-90a5-72487ef311bf.png" alt="Screenshot from 2019-11-13 10-34-50.png"></p>
<p>In the image above, <strong><font color="blue">Probe Face</font></strong> is the comparison source image.
<strong><font color="orange">Candidate Face</font></strong> is selected from the images in the database in descending order of similarity.
(In the created face recognition program, <font color="blue">Probe Face</font> is set as an unknown input image,
Prepare <font color="orange">Candidate Face</font> as an image of the person you want to recognize. )</p>
<p>The comparison result of each image is output as a JSON file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-result.json" data-lang="result.json">{
  <span style="color:#f92672">&#34;time_used&#34;</span>: <span style="color:#ae81ff">420</span>,
  <span style="color:#f92672">&#34;thresholds&#34;</span>: {
    <span style="color:#f92672">&#34;1e-3&#34;</span>: <span style="color:#ae81ff">62.327</span>,
    <span style="color:#f92672">&#34;1e-5&#34;</span>: <span style="color:#ae81ff">73.975</span>,
    <span style="color:#f92672">&#34;1e-4&#34;</span>: <span style="color:#ae81ff">69.101</span>
  },
  <span style="color:#f92672">&#34;faces&#34;</span>: [
    {
      <span style="color:#f92672">&#34;face_token&#34;</span>: <span style="color:#e6db74">&#34;8d25b53edf9e20bad18bebe3b0c8e06c&#34;</span>,
      <span style="color:#f92672">&#34;face_rectangle&#34;</span>: {
        <span style="color:#f92672">&#34;width&#34;</span>: <span style="color:#ae81ff">252</span>,
        <span style="color:#f92672">&#34;top&#34;</span>: <span style="color:#ae81ff">170</span>,
        <span style="color:#f92672">&#34;height&#34;</span>: <span style="color:#ae81ff">252</span>,
        <span style="color:#f92672">&#34;left&#34;</span>: <span style="color:#ae81ff">102</span>
      }
    }
  ],
  <span style="color:#f92672">&#34;results&#34;</span>: [
    {
      <span style="color:#f92672">&#34;confidence&#34;</span>: <span style="color:#ae81ff">97.076</span>,
      <span style="color:#f92672">&#34;user_id&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;face_token&#34;</span>: <span style="color:#e6db74">&#34;8323ce719cb1129e4abf4ada1129cbc9&#34;</span>
    },
    {
      <span style="color:#f92672">&#34;confidence&#34;</span>: <span style="color:#ae81ff">93.254</span>,
      <span style="color:#f92672">&#34;user_id&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;face_token&#34;</span>: <span style="color:#e6db74">&#34;fd6c81b63615b62b8506f33a6748fd95&#34;</span>
    },
    {
      <span style="color:#f92672">&#34;confidence&#34;</span>: <span style="color:#ae81ff">66.15</span>,
      <span style="color:#f92672">&#34;user_id&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;face_token&#34;</span>: <span style="color:#e6db74">&#34;192672385b603e6b54cf884cd019a620&#34;</span>
    },
    {
      <span style="color:#f92672">&#34;confidence&#34;</span>: <span style="color:#ae81ff">63.826</span>,
      <span style="color:#f92672">&#34;user_id&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;face_token&#34;</span>: <span style="color:#e6db74">&#34;34bbf05899b53968dcee620aa06a35e7&#34;</span>
    },
    {
      <span style="color:#f92672">&#34;confidence&#34;</span>: <span style="color:#ae81ff">57.875</span>,
      <span style="color:#f92672">&#34;user_id&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
      <span style="color:#f92672">&#34;face_token&#34;</span>: <span style="color:#e6db74">&#34;ee6cbca281f449d3ed6040ca63b4c52c&#34;</span>
    }
  ],
  <span style="color:#f92672">&#34;image_id&#34;</span>: <span style="color:#e6db74">&#34;+b1mqy/4tPkV6QMTyRVGyA==&#34;</span>,
  <span style="color:#f92672">&#34;request_id&#34;</span>: <span style="color:#e6db74">&#34;1573608536,e6ac4f2a-62fb-40a9-890b-696eba9a32a1&#34;</span>
}
</code></pre></div><p>Each element of the results key represents the comparison result between <font color="blue">Probe Face</font> and <font color="orange">Candidate Face</font>.
The similarity between two images is output as <strong>&ldquo;confidence&rdquo;</strong>.
Looking at the above result, the confidence of <font color="orange">Candidate Face1</font> is 97.076,
The <font color="orange">Candidate Face2</font> has a confidence of 93.254, which is a high degree of similarity.
The other results are less than 70 in similarity.
A face recognition program is created using this similarity.</p>
<p>##④ Program
The face recognition program is as follows.
Refer to the URL below for how to use the API.
<a href="https://github.com/Doarakko/api-challenge/tree/master/facepp-api">https://github.com/Doarakko/api-challenge/tree/master/facepp-api</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python:main.py" data-lang="Python:main.py">
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> re
<span style="color:#f92672">import</span> base64
<span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> glob
<span style="color:#f92672">import</span> cv2

API_KEY <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;My API Key&#39;</span>
API_SECRET <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;My API Secret&#39;</span>

<span style="color:#75715e"># Face detection API</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">detect_image</span>(img):
    endpoint <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://api-us.faceplusplus.com&#39;</span>
    response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(
        endpoint <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;/facepp/v3/detect&#39;</span>,
        {
            <span style="color:#e6db74">&#39;api_key&#39;</span>: API_KEY,
            <span style="color:#e6db74">&#39;api_secret&#39;</span>: API_SECRET,
            <span style="color:#e6db74">&#39;image_base64&#39;</span>: img,
        }
    )
    <span style="color:#75715e"># 1 second sleep</span>
    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
    <span style="color:#75715e">#When the response status code is other than 200</span>
    <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;[Error]&#39;</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
    resources <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
    <span style="color:#66d9ef">return</span> resources

<span style="color:#75715e"># Face identification API</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">search_image</span>(img,face_set):
    endpoint <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;https://api-us.faceplusplus.com&#39;</span>
    res, dst_data <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imencode(<span style="color:#e6db74">&#39;.jpg&#39;</span>, img)
    img_base64 <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64encode(dst_data)
    <span style="color:#75715e"># Send a request to the face detection API</span>
    faces<span style="color:#f92672">=</span>detect_image(img_base64)
    <span style="color:#66d9ef">for</span> face <span style="color:#f92672">in</span> faces[<span style="color:#e6db74">&#34;faces&#34;</span>]:
        <span style="color:#66d9ef">try</span>:
            response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(
                endpoint <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;/facepp/v3/search&#39;</span>,
                {
                    <span style="color:#e6db74">&#39;api_key&#39;</span>: API_KEY,
                    <span style="color:#e6db74">&#39;api_secret&#39;</span>: API_SECRET,
                    <span style="color:#e6db74">&#39;face_token&#39;</span>: str(face[<span style="color:#e6db74">&#34;face_token&#34;</span>]),
                    <span style="color:#e6db74">&#39;faceset_token&#39;</span>: face_set[<span style="color:#e6db74">&#34;faceset_token&#34;</span>],
                    <span style="color:#e6db74">&#39;return_result_count&#39;</span>: <span style="color:#ae81ff">1</span>,
                }
            )
            <span style="color:#75715e"># 1 second sleep</span>
            time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
            <span style="color:#75715e">#When the response status code is other than 200</span>
            <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>:
                <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
            resources <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;success&#34;</span>)
            <span style="color:#66d9ef">print</span>(resources)
            img<span style="color:#f92672">=</span>draw_img(face,resources,img)
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
    <span style="color:#75715e">#Save image</span>
    cv2<span style="color:#f92672">.</span>imwrite(<span style="color:#e6db74">&#34;./output/result_&#34;</span><span style="color:#f92672">+</span>filename, img)
    <span style="color:#66d9ef">return</span> resources

<span style="color:#75715e"># Draw the face information with the highest probability</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">draw_img</span>(face,resources,img):
    <span style="color:#66d9ef">try</span>:
        left <span style="color:#f92672">=</span> face[<span style="color:#e6db74">&#34;face_rectangle&#34;</span>][<span style="color:#e6db74">&#34;left&#34;</span>]
        top <span style="color:#f92672">=</span> face[<span style="color:#e6db74">&#34;face_rectangle&#34;</span>][<span style="color:#e6db74">&#34;top&#34;</span>]
        right <span style="color:#f92672">=</span> left <span style="color:#f92672">+</span> face[<span style="color:#e6db74">&#34;face_rectangle&#34;</span>][<span style="color:#e6db74">&#34;width&#34;</span>]
        bottom <span style="color:#f92672">=</span> top <span style="color:#f92672">+</span> face[<span style="color:#e6db74">&#34;face_rectangle&#34;</span>][<span style="color:#e6db74">&#34;height&#34;</span>]
        <span style="color:#75715e"># Draw a rectanglecv2.rectangle(img, (left, top), (right, bottom), (0, 0, 255), 3)</span>
        font <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>FONT_HERSHEY_SIMPLEX
        <span style="color:#75715e"># 確率の描画</span>
        cv2<span style="color:#f92672">.</span>putText(img, str(resources[<span style="color:#e6db74">&#34;results&#34;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;confidence&#34;</span>]) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;%&#34;</span>, (left, top), font, <span style="color:#ae81ff">0.5</span>, (<span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>), <span style="color:#ae81ff">3</span>, cv2<span style="color:#f92672">.</span>LINE_AA)
        cv2<span style="color:#f92672">.</span>putText(img, str(resources[<span style="color:#e6db74">&#34;results&#34;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;confidence&#34;</span>]) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;%&#34;</span>, (left, top), font, <span style="color:#ae81ff">0.5</span>, (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), <span style="color:#ae81ff">1</span>, cv2<span style="color:#f92672">.</span>LINE_AA)
        <span style="color:#75715e"># 名前の描画</span>
        cv2<span style="color:#f92672">.</span>putText(img, str(resources[<span style="color:#e6db74">&#34;results&#34;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;user_id&#34;</span>]) , (left, top<span style="color:#f92672">-</span><span style="color:#ae81ff">20</span>), font, <span style="color:#ae81ff">0.5</span>, (<span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>), <span style="color:#ae81ff">3</span>, cv2<span style="color:#f92672">.</span>LINE_AA)
        cv2<span style="color:#f92672">.</span>putText(img, str(resources[<span style="color:#e6db74">&#34;results&#34;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;user_id&#34;</span>]) , (left, top<span style="color:#f92672">-</span><span style="color:#ae81ff">20</span>), font, <span style="color:#ae81ff">0.5</span>, (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), <span style="color:#ae81ff">1</span>, cv2<span style="color:#f92672">.</span>LINE_AA)
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;none&#34;</span>)

    <span style="color:#66d9ef">return</span> img

<span style="color:#75715e"># 比較する顔画像を登録</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_faceset</span>(face_list,tags):
    id_list <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> (img_path,face_id) <span style="color:#f92672">in</span> zip(face_list,tags):
        img_file <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>encodebytes(open(img_path, <span style="color:#e6db74">&#39;rb&#39;</span>)<span style="color:#f92672">.</span>read())
        resources <span style="color:#f92672">=</span> detect_image(img_file)
        set_userid(resources[<span style="color:#e6db74">&#34;faces&#34;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;face_token&#34;</span>],face_id)
        id_list<span style="color:#f92672">.</span>append(resources[<span style="color:#e6db74">&#34;faces&#34;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;face_token&#34;</span>])

    id_list<span style="color:#f92672">=</span>str(id_list)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;&#39;&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
    id_list<span style="color:#f92672">=</span>str(id_list)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;[&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
    id_list<span style="color:#f92672">=</span>str(id_list)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;]&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
    id_list<span style="color:#f92672">=</span>str(id_list)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34; &#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)

    <span style="color:#66d9ef">print</span>(resources)
    <span style="color:#66d9ef">print</span>(id_list)

    endpoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://api-us.faceplusplus.com&#39;</span>
    <span style="color:#66d9ef">try</span>:
        response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(
            endpoint <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/facepp/v3/faceset/create&#39;</span>,
            {
                <span style="color:#e6db74">&#39;api_key&#39;</span>: API_KEY,
                <span style="color:#e6db74">&#39;api_secret&#39;</span>: API_SECRET,
                <span style="color:#e6db74">&#39;display_name&#39;</span>: <span style="color:#e6db74">&#39;facebank&#39;</span>,
                <span style="color:#e6db74">&#39;face_tokens&#39;</span>: id_list,
            }
        )
        <span style="color:#75715e"># 1秒スリープ</span>
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
        <span style="color:#75715e"># レスポンスのステータスコードが200以外の場合</span>
        <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
        resources <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
        <span style="color:#66d9ef">print</span>(resources)
        <span style="color:#66d9ef">return</span> resources
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_userid</span>(face_token,user):
    endpoint <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://api-us.faceplusplus.com&#39;</span>
    <span style="color:#66d9ef">try</span>:
        response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(
            endpoint <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/facepp/v3/face/setuserid&#39;</span>,
            {
                <span style="color:#e6db74">&#39;api_key&#39;</span>: API_KEY,
                <span style="color:#e6db74">&#39;api_secret&#39;</span>: API_SECRET,
                <span style="color:#e6db74">&#39;display_name&#39;</span>: <span style="color:#e6db74">&#39;facebank&#39;</span>,
                <span style="color:#e6db74">&#39;face_token&#39;</span>:face_token,
                <span style="color:#e6db74">&#39;user_id&#39;</span>:user,
        }
        )
        <span style="color:#75715e"># 1秒スリープ</span>
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
        <span style="color:#75715e"># レスポンスのステータスコードが200以外の場合</span>
        <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
        resources <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
        <span style="color:#66d9ef">print</span>(resources)
        <span style="color:#66d9ef">return</span> resources
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    <span style="color:#75715e"># 識別したい画像を取得</span>
    filename<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;input.jpg&#34;</span>
    img<span style="color:#f92672">=</span>cv2<span style="color:#f92672">.</span>imread(<span style="color:#e6db74">&#39;./input/&#39;</span><span style="color:#f92672">+</span>filename)
    <span style="color:#75715e"># フォルダ内の画像を取得</span>
    face_list <span style="color:#f92672">=</span> glob<span style="color:#f92672">.</span>glob(<span style="color:#e6db74">&#39;./facebank/*/*.jpg&#39;</span>)
    face_list<span style="color:#f92672">.</span>sort()
    tags<span style="color:#f92672">=</span>[]<span style="color:#75715e"># 各名前(user_id)格納用</span>
    <span style="color:#75715e"># 登録データから読み取り</span>
    <span style="color:#66d9ef">for</span> face_path <span style="color:#f92672">in</span> face_list:
        tags<span style="color:#f92672">.</span>append(str(re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;./facebank/(.+)/.+&#39;</span>, face_path)<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">1</span>)))
    <span style="color:#75715e"># APIで比較する顔を定義</span>
    face_set <span style="color:#f92672">=</span> create_faceset(face_list,tags)
    <span style="color:#75715e"># 識別するAPIにリクエストを送る</span>
    resources <span style="color:#f92672">=</span> search_image(img,face_set)

</code></pre></div><p>各APIの引数などについては<a href="https://console.faceplusplus.com/documents/5678948">公式のリファレンス</a>を参照。</p>
<p>フォルダ階層は以下の通り。</p>
<pre><code>─ facebank/
    ├ A/ 
    │ └ A.jpg
    ├ B/ 
    │ └ B.jpg
    ├ C/ 
    │ └ C.jpg
    ├ D/ 
    │ └ D.jpg
    └ E/
      └ E.jpg
─ input/
    └ input.jpg
─ output/
    └ result_input.jpg
─ main.py
</code></pre><p>inputフォルダには識別する画像を入れる。
facebankフォルダの中に各人物名のフォルダを用意し、
そのフォルダ内に顔写真を入れておく。(顔写真の名前は任意)</p>
<p>##⑤顔認識
いざ、顔認識。
登録＆認識する写真は、人物のフリー素材を公開している「<a href="https://www.pakutaso.com/">ぱくたそ</a>」から拝借した。
今回認識対象として登録した写真は以下の5枚。</p>
<ul>
<li>ezakiさん <img width="200" alt="ezakisan" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/919c4326-151d-ebef-7540-778ca948fba1.jpeg"></li>
<li>murataさん <img width="200" alt="muratasan" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/c25f2653-1af9-fc5e-b7e4-ee1ad26807f2.jpeg"></li>
<li>narishigeさん <img width="200" alt="muratasan" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/f443a3e8-0cc6-a18c-875d-04fb8fe3af4f.jpeg"></li>
<li>okawaさん <img width="200" alt="muratasan" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/3416fa33-272c-a1d7-ef03-6855200aef75.jpeg"></li>
<li>yuseiさん <img width="200" alt="muratasan" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/bb3b5a91-30ea-1c29-7259-29eb4c425207.jpeg"></li>
</ul>
<p>そして、認識結果がこちら！
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/3f13603c-697b-44d2-b46d-3795b22e08ef.jpeg" alt="result.jpg">
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/4e82fecf-5bce-0da3-25c2-2345762db4c2.jpeg" alt="result_helpIMGL6330_TP_V.jpg">
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/22f3fc01-9b87-4cf4-69b5-facd94cc2f29.jpeg" alt="result_PAK86_sotugyousei15213941_TP_V.jpg">
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/04b36cd2-2d8d-07f2-d154-8c40bbe95cff.jpeg" alt="result_N612_shibuyagawadedenwasuruikemen_TP_V.jpg"></p>
<p>なんと顔を登録した人は80%以上の類似度で全員正解！The number of facial photos registered is high for each person.</p>
<p>People with unregistered faces are also identified as those with the highest degree of similarity among registered people,
It can be seen that the similarity is low as shown in the figure below.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/6ca01fe7-48fa-260d-af00-8f001760a10a.jpeg" alt="333.jpg"><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/426498/d60ca08a-c81c-6f12-7187-c76748273ca1.jpeg" alt="222.jpg"></p>
<p>If you register an account with Face++, you can use face recognition with your own image on <a href="https://www.faceplusplus.com/face-searching/#demo">Demo</a> on the WEB page.
If you are interested, why not give it a try?</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
