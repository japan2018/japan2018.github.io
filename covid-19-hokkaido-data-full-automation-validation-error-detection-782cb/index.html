<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>COVID-19 Hokkaido data ③ Full automation (validation/error detection) | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>COVID-19 Hokkaido data ③ Full automation (validation/error detection)</h1>
<p>
  <small class="text-secondary">
  
  
  Mar 17, 2020
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/opendata">opendata</a></code></small>


<small><code><a href="https://memotut.com/tags/slack">Slack</a></code></small>


<small><code><a href="https://memotut.com/tags/githubactions">GitHubActions</a></code></small>


<small><code><a href="https://memotut.com/tags/covid-19">COVID-19</a></code></small>

</p>
<pre><code>## Table of contents
</code></pre>
<p><a href="https://qiita.com/Kanahiro/items/b47984fbf77f4e632663">COVID-19 Hokkaido data edition (1) Initial data creation by scraping etc.</a>
<a href="https://qiita.com/Kanahiro/items/8f0768708d2c47ae3206">COVID-19 Hokkaido Data Edition (2) To Open Data + Automatic Update</a>
<a href="https://qiita.com/Kanahiro/items/782cb6d5497d3c3704ec">COVID-19 Hokkaido data ③ Fully automated</a> ←This article!</p>
<h2 id="towards-full-automation">Towards full automation</h2>
<h4 id="current-status">Current status</h4>
<ul>
<li>GitHub Actions has already automated the reading of original data and the generation of json files</li>
<li>GitHub Pages implements hosting of automatically generated json files</li>
</ul>
<h4 id="task">Task</h4>
<ul>
<li>Although the original data is open data, the file is created manually by the person in charge of each local government, so it is necessary to validate the input value.</li>
<li>Some kind of alert is required when json file generation fails due to data inconsistency</li>
</ul>
<h2 id="validation">Validation</h2>
<p>I generate a dict inside Python and write it to a json file with json.dump(). In other words, you can say that you should validate the data in dict.
So what should we validate? For example, it would be a problem if the key referenced at the front does not exist, so you need to check the key. Also, if there is an integer value in the date key for some reason, this is also a problem. So type check is required for each key.</p>
<p>It seems that these two points can be implemented with full scratch, but I will use the wheels invented by my ancestors. Use &ldquo;json schema&rdquo;.</p>
<p>Reference site: <a href="https://medium.com/veltra-engineering/python-json-schema-validation-6936238f107d">https://medium.com/veltra-engineering/python-json-schema-validation-6936238f107d</a></p>
<h4 id="install-jsonschema">Install jsonschema</h4>
<pre><code>pip install jsonschema
</code></pre><h4 id="validation-with-jsonschema">Validation with jsonschema</h4>
<p>Checks if the given dict matches the JSON structure/type defined in advance.
If it does not match, an error will be output, and if it matches, nothing will be output.</p>
<p>How to use is explained carefully on the above reference site, so only the implementation is introduced.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">SCHEMAS <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#34;patients&#34;</span>:{schema definition},
    <span style="color:#e6db74">&#34;contacts&#34;</span>:{schema definition}
    <span style="color:#75715e"># ~</span>
}
</code></pre></div><p>So, define the schema definition as SCHEMAS for each key.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate</span>(self):
    <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>data:
        jsonschema<span style="color:#f92672">.</span>validate(self<span style="color:#f92672">.</span>data[key], SCHEMAS[key])
</code></pre></div><p>The keys of self.data and SCHEMAS match. self.data[key] is a dict that should be output to json as it is.
Therefore, if the key is missing or the types do not match due to an input error, an error will occur and the processing will be interrupted (<b>json is not generated</b>).
No strange json is generated, and the last normally output json remains.
(If 5 is entered in the place where 5 should be entered, it will be caught, but if 6 is entered, it will pass through. Although I feel that this kind of human error is inevitable in the first place)</p>
<p>For example, if you define that date should contain integer, but the data is string, the following error occurs and the process is interrupted.</p>
<pre><code>
Traceback (most recent call last):
  File &quot;main.py&quot;, line 231, in &lt;module&gt;
    dm.validate()
  File &quot;main.py&quot;, line 90, in validate
    jsonschema.validate(self.data[key], SCHEMAS[key])
  File &quot;/opt/hostedtoolcache/Python/3.8.2/x64/lib/python3.8/site-packages/jsonschema/validators.py&quot;, line 934, in validate
    raise error
jsonschema.exceptions.ValidationError: '2020-03-17T21:31:40.309090+09:00' is not of type'integer'

Failed validating'type' in schema['properties']['last_update']:
    {'default':'','type':'integer'}

On instance['last_update']:
    '2020-03-17T21:31:40.309090+09:00'
##[error]Process completed with exit code 1.
</code></pre><h2 id="alert-slack-for-errors">Alert Slack for errors</h2>
<p>Reference site:
<a href="https://qiita.com/vmmhypervisor/items/18c99624a84df8b31008">Qiita-Slack Webhook URL acquisition procedure</a>
<a href="https://qiita.com/DotaKobayashi/items/7f8c6275f410d22ed6bd">Qiita-Run GitHub Actions regularly and notify Slack of the result</a></p>
<p>For whatever reason, let Slack know when data generation fails.
I wrote yaml as follows with reference to the above site.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">
<span style="color:#66d9ef">name</span>: Python application

<span style="color:#66d9ef">on</span>:
  <span style="color:#66d9ef">schedule</span>:
    <span style="color:#66d9ef">-cron</span>: <span style="color:#e6db74">&#39;0 * * * *&#39;</span>

<span style="color:#66d9ef">jobs</span>:
  <span style="color:#66d9ef">build</span>:

    <span style="color:#66d9ef">runs-on</span>: ubuntu-latest

    <span style="color:#66d9ef">steps</span>:
    <span style="color:#66d9ef">-uses</span>: actions/checkout@v2
    <span style="color:#66d9ef">-name</span>: Set up Python <span style="color:#ae81ff">3.8</span>
      <span style="color:#66d9ef">uses</span>: actions/setup-python@v1
      <span style="color:#66d9ef">with</span>:
        <span style="color:#66d9ef">python-version</span>: <span style="color:#ae81ff">3.8</span>
    <span style="color:#66d9ef">-name</span>: Install dependencies
      <span style="color:#66d9ef">run</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        python -m pip install --upgrade pip</span>
        pip install -r requirements.txt
    <span style="color:#66d9ef">-name</span>: Run script
      <span style="color:#66d9ef">run</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        python main.py</span>
    <span style="color:#66d9ef">-name</span>: Slack Notification
      <span style="color:#75715e"># from here</span>
      <span style="color:#66d9ef">if</span>: failure()
      <span style="color:#66d9ef">uses</span>: rtCamp/action-slack-notify@master
      <span style="color:#66d9ef">env</span>:
        SLACK_MESSAGE:<span style="color:#e6db74">&#39;Error occurred! Please check a log!&#39;</span>
        <span style="color:#66d9ef">SLACK_TITLE:&#39;:fire</span>: Data Update Error :fire:&#39;
        <span style="color:#66d9ef">SLACK_USERNAME</span>: covid19hokkaido_scraping
        <span style="color:#66d9ef">SLACK_WEBHOOK</span>: ${{ secrets.SLACK_WEBHOOK }}
      <span style="color:#75715e"># Add up to here</span>
    <span style="color:#66d9ef">-name</span>: deploy
      <span style="color:#66d9ef">uses</span>: peaceiris/actions-gh-pages@v3
      <span style="color:#66d9ef">with</span>:
        <span style="color:#66d9ef">github_token</span>: ${{ secrets.GITHUB_TOKEN }}
        <span style="color:#66d9ef">publish_dir</span>: ./data
        <span style="color:#66d9ef">publish_branch</span>: gh-pages
</code></pre></div><p>You need to add SLACK_WEBHOOK to Setting → Secrets (otherwise the webhook URL will be open source).</p>
<p>The value stored in Secrets is encrypted. You can get it from yaml with secrets.{name}.
You cannot use {name} starting with GITHUB.</p>
<p>If you implement the above, when an error occurs, it will be posted to Slack as follows.
<img width="647" alt="Screenshots 2020-03-17 22.04.29.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/73197/71faa50b-55bb-ce49-aba6-ad93a16d9855.png"></p>
<h2 id="at-the-end">At the end</h2>
<p>With the above, the automated process including validation of data acquisition → json file generation is completed.
However, currently there are only key checks and type checks, so there is no need for validation, such as a mechanism to detect excessive abnormal values.
Data generation was automated, but asynchronous communication on the front side is being implemented including debugging.
There is room for improvement in the future, but I think the operation has become dramatically easier compared to the initial half-manual work. This is the end of the three-part serialization, thank you.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
