<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>CNN (U-net, DnCNN, WIN5-RB) that restores images full of noise and graffiti, and images blurred with zoom | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>CNN (U-net, DnCNN, WIN5-RB) that restores images full of noise and graffiti, and images blurred with zoom</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 21, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/image-processing"> image processing</a></code></small>


<small><code><a href="https://memotut.com/tags/machine-learning"> machine learning</a></code></small>


<small><code><a href="https://memotut.com/tags/deep-learning"> deep learning</a></code></small>


<small><code><a href="https://memotut.com/tags/pytorch"> PyTorch</a></code></small>

</p>
<pre><code>#Introduction
</code></pre>
<p>Deep learning is a method recently used to clean dirty images, remove graffiti from images, and restore poorly-zoomed images.</p>
<p>The principle is simple, just input a noisy image to the converter and output a beautiful image.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/1560d332-bd02-d6b3-758c-c06ee654b879.jpeg" alt=""></p>
<p>Such converters are often made up of <strong>Convolutional Neural Networks (CNN)</strong>.</p>
<p>In this article, I will try to implement such CNN with pytorch and see the results.</p>
<p>There are various CNN models like this, but this time I will try with three CNN models and compare the results.</p>
<h1 id="overview">Overview</h1>
<p>To make a converter that transforms a noisy image into a clean one, first decide on a CNN model.</p>
<p>The CNN takes a noisy image as an input and the output is an image of the same size as the input.</p>
<p>If you create a CNN according to the model, the parameters in the CNN are random at first, so the first output should be a cod.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/4f1ee9f0-75b9-02da-d15b-9673a623661a.jpeg" alt=""></p>
<p>As a result, compared with the model image, <strong>MSE (mean square error)</strong> is calculated, the parameters are updated by the error backpropagation method, and the output becomes cleaner.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/50ac5028-967d-a286-385b-caac19d9113e.jpeg" alt=""></p>
<p>In the end, the output image looks almost the same as the model.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/73bf79ce-a78c-e6ad-a994-75b7c080e358.jpeg" alt=""></p>
<p>After the training is completed, if you input an image that was not used for training, the noise will be similarly deleted. (If not, it means that you are overtraining.)</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/049c61a8-33a1-399f-027c-641288971c6d.jpeg" alt=""></p>
<p>For more information, there are many helpful articles on qiita.</p>
<ul>
<li><a href="https://qiita.com/cvusk/items/019c254db883957b3050">Image reproduction, noise removal, segmentation by convolutional auto encoder</a></li>
<li><a href="https://qiita.com/cvusk/items/9b822860bb2c501a0fe4">Erase graffiti with deep learning</a></li>
<li><a href="https://qiita.com/omochi64/items/22d0162b5044331fa226">Use AI for denoising ray tracing</a></li>
</ul>
<h1 id="preparation-of-image-data-to-use">Preparation of image data to use</h1>
<p>The image used this time was obtained from safebooru, the same as the last time I tried implementing DCGAN.</p>
<p>See the DCGAN article for more details <a href="https://qiita.com/phyblas/items/bcab394e1387f15f66ee">https://qiita.com/phyblas/items/bcab394e1387f15f66ee</a></p>
<p>You can download an image and cut it to a size of 256x256 to create an image like this.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/e48be051-f236-02af-3fdf-20e53493ad03.jpeg" alt=""></p>
<p>And like this, you can tamper with images in three ways.</p>
<ul>
<li>Gaussian noise</li>
</ul>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/fe1cc818-fe6d-db47-3504-aa297afb07af.jpeg" alt=""></p>
<ul>
<li>Graffiti</li>
</ul>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/8c654683-327a-0401-1298-c41e9ec019b9.jpeg" alt=""></p>
<ul>
<li>Shrink and expand again</li>
</ul>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/3373fc85-ec00-7e0a-84ec-dbd002ffbe02.jpeg" alt=""></p>
<p>Either way, the noise is added to reduce the quality of the image. Try to restore such an image with CNN.</p>
<p>However, instead of preparing such an image in advance when learning CNN, noise is randomly added from a beautiful sample each time and used. This way an image with random and different noise is used each time.</p>
<h1 id="model-to-use">Model to use</h1>
<p>I tried to use four models this time</p>
<p><strong>U-net</strong>
Paper <a href="https://arxiv.org/abs/1505.04597">Ronneberger &amp; Fischer &amp; Brox 2015</a>
Code <a href="https://github.com/DuFanXin/U-net">https://github.com/DuFanXin/U-net</a> ,https://github.com/milesial/Pytorch-UNet</p>
<p><strong>RED-Net</strong>
Paper <a href="https://ui.adsabs.harvard.edu/abs/2016arXiv160608921M">Mao &amp; Shen &amp; Yang 2016</a>
Code <a href="https://github.com/ved27/RED-net">https://github.com/ved27/RED-net</a></p>
<p><strong>DnCNN</strong>
Paper <a href="https://ui.adsabs.harvard.edu/abs/2017ITIP...26.3142Z">Zhang et al. 2017</a>
Code <a href="https://github.com/cszn/DnCNN">https://github.com/cszn/DnCNN</a></p>
<p><strong>WIN5-RB</strong>
Paper <a href="https://ui.adsabs.harvard.edu/abs/2017arXiv170705414L">Liu &amp; Fang 2017</a>
Code <a href="https://github.com/cswin/WIN">https://github.com/cswin/WIN</a></p>
<p>However, RED-Net is too big to use, so it takes too much time and is not effective, so I gave up after all.</p>
<p>I tried to write the model structure with <strong>extend script</strong> of <strong>adobe illustrator</strong>.</p>
<h2 id="u-net">U-net</h2>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/59801382-9815-61b0-feac-52517bbfe5be.png" alt="unet.png"></p>
<h2 id="red-net">RED-Net</h2>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/04418d95-4d83-cd70-3166-d0695c27b06d.png" alt="rednet.png"></p>
<h2 id="dncnn">DnCNN</h2>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/c9bf0dab-d8b9-47dc-a49f-20206d018140.png" alt="dncnn.png"></p>
<h2 id="win5-rb">WIN5-RB</h2>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/34eb2e4c-a927-79e8-7352-72513345b2ad.png" alt="win5rb.png"></p>
<h1 id="implementation">Implementation</h1>
<p>Code I implemented this time</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> glob <span style="color:#f92672">import</span> glob
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">from</span> matplotlib.image <span style="color:#f92672">import</span> imsave,imread
<span style="color:#f92672">from</span> skimage.transform <span style="color:#f92672">import</span> resize
<span style="color:#f92672">import</span> os<span style="color:#f92672">,</span>time<span style="color:#f92672">,</span>torch
<span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
mse <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>MSELoss()

<span style="color:#75715e">## Neural network model ##</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Unet</span>(nn<span style="color:#f92672">.</span>Module):
    <span style="color:#66d9ef">def</span> __init__(self,cn<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>):
        super(Unet,self)<span style="color:#f92672">.</span>__init__()

        self<span style="color:#f92672">.</span>copu1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(
            nn<span style="color:#f92672">.</span>Conv2d(cn,<span style="color:#ae81ff">48</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
            nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True),
            nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">48</span>,<span style="color:#ae81ff">48</span>,<span style="color:#ae81ff">3</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
            nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True),
            nn<span style="color:#f92672">.</span>MaxPool2d(<span style="color:#ae81ff">2</span>)
        )

        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">6</span>):
            self<span style="color:#f92672">.</span>add_module(<span style="color:#e6db74">&#39;copu</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">%</span>i,
                nn<span style="color:#f92672">.</span>Sequential(
                    nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">48</span>,<span style="color:#ae81ff">48</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
                    nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True),
                    nn<span style="color:#f92672">.</span>MaxPool2d(<span style="color:#ae81ff">2</span>)
                )
            )

        self<span style="color:#f92672">.</span>coasa1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(
            nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">48</span>,<span style="color:#ae81ff">48</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
            nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True),
            nn<span style="color:#f92672">.</span>ConvTranspose2d(<span style="color:#ae81ff">48</span>,<span style="color:#ae81ff">48</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,output_padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
        )

        self<span style="color:#f92672">.</span>coasa2 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(
            nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
            nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True),
            nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
            nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True),
            nn<span style="color:#f92672">.</span>ConvTranspose2d(<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,output_padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
        )

        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">6</span>):
            self<span style="color:#f92672">.</span>add_module(<span style="color:#e6db74">&#39;coasa</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">%</span>i,
                nn<span style="color:#f92672">.</span>Sequential(nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">144</span>,<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
                    nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True),
                    nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
                    nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True),
                    nn<span style="color:#f92672">.</span>ConvTranspose2d(<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,output_padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
                )
            )

        self<span style="color:#f92672">.</span>coli <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(
            nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">96</span><span style="color:#f92672">+</span>cn,<span style="color:#ae81ff">64</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
            nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True),
            nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">64</span>,<span style="color:#ae81ff">32</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
            nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True),
            nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">32</span>,cn,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
            nn<span style="color:#f92672">.</span>LeakyReLU(<span style="color:#ae81ff">0.1</span>)
        )

        <span style="color:#66d9ef">for</span> l <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>modules(): <span style="color:#75715e"># 重みの初期値</span>
            <span style="color:#66d9ef">if</span>(type(l) <span style="color:#f92672">in</span> (nn<span style="color:#f92672">.</span>ConvTranspose2d,nn<span style="color:#f92672">.</span>Conv2d)):
                nn<span style="color:#f92672">.</span>init<span style="color:#f92672">.</span>kaiming_normal_(l<span style="color:#f92672">.</span>weight<span style="color:#f92672">.</span>data)
                l<span style="color:#f92672">.</span>bias<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>zero_()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self,x):
        x1 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>copu1(x)
        x2 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>copu2(x1)
        x3 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>copu3(x2)
        x4 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>copu4(x3)
        x5 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>copu5(x4)

        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>coasa1(x5)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>coasa2(torch<span style="color:#f92672">.</span>cat((z,x4),<span style="color:#ae81ff">1</span>))
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>coasa3(torch<span style="color:#f92672">.</span>cat((z,x3),<span style="color:#ae81ff">1</span>))
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>coasa4(torch<span style="color:#f92672">.</span>cat((z,x2),<span style="color:#ae81ff">1</span>))
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>coasa5(torch<span style="color:#f92672">.</span>cat((z,x1),<span style="color:#ae81ff">1</span>))

        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>coli(torch<span style="color:#f92672">.</span>cat((z,x),<span style="color:#ae81ff">1</span>))



<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DnCNN</span>(nn<span style="color:#f92672">.</span>Sequential):
    <span style="color:#66d9ef">def</span> __init__(self,cn<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>):
        super(DnCNN,self)<span style="color:#f92672">.</span>__init__()
        
        self<span style="color:#f92672">.</span>add_module(<span style="color:#e6db74">&#39;coba1&#39;</span>,nn<span style="color:#f92672">.</span>Sequential(
                nn<span style="color:#f92672">.</span>Conv2d(cn,<span style="color:#ae81ff">64</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
                nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True),
            )
        )

        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">17</span>):
            self<span style="color:#f92672">.</span>add_module(<span style="color:#e6db74">&#39;coba</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">%</span>i,
                nn<span style="color:#f92672">.</span>Sequential(
                    nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">64</span>,<span style="color:#ae81ff">64</span>,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
                    nn<span style="color:#f92672">.</span>BatchNorm2d(<span style="color:#ae81ff">64</span>),
                    nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True),
                )
            )
        
        self<span style="color:#f92672">.</span>add_module(<span style="color:#e6db74">&#39;coba17&#39;</span>,nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">64</span>,cn,<span style="color:#ae81ff">3</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
        
        <span style="color:#66d9ef">for</span> l <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>modules(): <span style="color:#75715e"># 重みの初期値</span>
            <span style="color:#66d9ef">if</span>(type(l)<span style="color:#f92672">==</span>nn<span style="color:#f92672">.</span>Conv2d):
                nn<span style="color:#f92672">.</span>init<span style="color:#f92672">.</span>kaiming_normal_(l<span style="color:#f92672">.</span>weight<span style="color:#f92672">.</span>data)
                l<span style="color:#f92672">.</span>bias<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>zero_()
            <span style="color:#66d9ef">elif</span>(type(l)<span style="color:#f92672">==</span>nn<span style="color:#f92672">.</span>BatchNorm2d):
                l<span style="color:#f92672">.</span>weight<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>fill_(<span style="color:#ae81ff">1</span>)
                l<span style="color:#f92672">.</span>bias<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>zero_()



<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Win5RB</span>(nn<span style="color:#f92672">.</span>Module):
    <span style="color:#66d9ef">def</span> __init__(self,cn<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>):
        super(Win5RB,self)<span style="color:#f92672">.</span>__init__()

        inc <span style="color:#f92672">=</span> cn
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">5</span>):
            self<span style="color:#f92672">.</span>add_module(<span style="color:#e6db74">&#39;coba</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">%</span>i,
                nn<span style="color:#f92672">.</span>Sequential(
                    nn<span style="color:#f92672">.</span>Conv2d(inc,<span style="color:#ae81ff">64</span>,<span style="color:#ae81ff">7</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>),
                    nn<span style="color:#f92672">.</span>BatchNorm2d(<span style="color:#ae81ff">64</span>),
                    nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True),
                )
            )
            inc <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>
        
        self<span style="color:#f92672">.</span>add_module(<span style="color:#e6db74">&#39;coba5&#39;</span>,nn<span style="color:#f92672">.</span>Sequential(
                nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">64</span>,cn,<span style="color:#ae81ff">7</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>),
                nn<span style="color:#f92672">.</span>BatchNorm2d(cn)
            )
        )
        
        <span style="color:#66d9ef">for</span> l <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>modules(): <span style="color:#75715e"># 重みの初期値</span>
            <span style="color:#66d9ef">if</span>(type(l)<span style="color:#f92672">==</span>nn<span style="color:#f92672">.</span>Conv2d):
                nn<span style="color:#f92672">.</span>init<span style="color:#f92672">.</span>kaiming_normal_(l<span style="color:#f92672">.</span>weight<span style="color:#f92672">.</span>data)
                l<span style="color:#f92672">.</span>bias<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>zero_()
            <span style="color:#66d9ef">elif</span>(type(l)<span style="color:#f92672">==</span>nn<span style="color:#f92672">.</span>BatchNorm2d):
                l<span style="color:#f92672">.</span>weight<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>fill_(<span style="color:#ae81ff">1</span>)
                l<span style="color:#f92672">.</span>bias<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>zero_()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self,x):
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>coba1(x)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>coba2(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>coba3(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>coba4(z)
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>coba5(z) <span style="color:#f92672">+</span> x



<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Rednet</span>(nn<span style="color:#f92672">.</span>Module):
    <span style="color:#66d9ef">def</span> __init__(self,cn<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>):
        super(Rednet,self)<span style="color:#f92672">.</span>__init__()

        self<span style="color:#f92672">.</span>add_module(<span style="color:#e6db74">&#39;con1&#39;</span>,nn<span style="color:#f92672">.</span>Sequential(
                nn<span style="color:#f92672">.</span>Conv2d(cn,<span style="color:#ae81ff">64</span>,<span style="color:#ae81ff">7</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>),
                nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True)
            )
        )

        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">16</span>):
            self<span style="color:#f92672">.</span>add_module(<span style="color:#e6db74">&#39;con</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">%</span>i,
                nn<span style="color:#f92672">.</span>Sequential(
                    nn<span style="color:#f92672">.</span>Conv2d(<span style="color:#ae81ff">64</span>,<span style="color:#ae81ff">64</span>,<span style="color:#ae81ff">7</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>),
                    nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True)
                )
            )

        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">15</span>):
            self<span style="color:#f92672">.</span>add_module(<span style="color:#e6db74">&#39;cont</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">%</span>i,
                nn<span style="color:#f92672">.</span>Sequential(
                    nn<span style="color:#f92672">.</span>ConvTranspose2d(<span style="color:#ae81ff">64</span>,<span style="color:#ae81ff">64</span>,<span style="color:#ae81ff">7</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>),
                    nn<span style="color:#f92672">.</span>ReLU(inplace<span style="color:#f92672">=</span>True)
                )
            )

        self<span style="color:#f92672">.</span>add_module(<span style="color:#e6db74">&#39;cont15&#39;</span>,nn<span style="color:#f92672">.</span>ConvTranspose2d(<span style="color:#ae81ff">64</span>,cn,<span style="color:#ae81ff">7</span>,stride<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>))

        <span style="color:#66d9ef">for</span> l <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>modules(): <span style="color:#75715e"># 重みの初期値</span>
            <span style="color:#66d9ef">if</span>(type(l) <span style="color:#f92672">in</span> (nn<span style="color:#f92672">.</span>ConvTranspose2d,nn<span style="color:#f92672">.</span>Conv2d)):
                nn<span style="color:#f92672">.</span>init<span style="color:#f92672">.</span>kaiming_normal_(l<span style="color:#f92672">.</span>weight<span style="color:#f92672">.</span>data)
                l<span style="color:#f92672">.</span>bias<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>zero_()

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self,x):
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con1(x)
        x2 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con2(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con3(x2)
        x4 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con4(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con5(x4)
        x6 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con6(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con7(x6)
        x8 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con8(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con9(x8)
        x10 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con10(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con11(x10)
        x12 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con12(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con13(x12)
        x14 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con14(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>con15(x14)

        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont1(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont2(x14<span style="color:#f92672">+</span>z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont3(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont4(x12<span style="color:#f92672">+</span>z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont5(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont6(x10<span style="color:#f92672">+</span>z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont7(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont8(x8<span style="color:#f92672">+</span>z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont9(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont10(x6<span style="color:#f92672">+</span>z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont11(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont12(x4<span style="color:#f92672">+</span>z)z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont13(z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont14(x2<span style="color:#f92672">+</span>z)
        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cont15(z)

        <span style="color:#66d9ef">return</span> z


<span style="color:#75715e">## Data Loader ##</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Gazoudalo</span>:
    <span style="color:#66d9ef">def</span> __init__(self,folder,fnoise,px<span style="color:#f92672">=</span><span style="color:#ae81ff">256</span>,n_batch<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>,random<span style="color:#f92672">=</span>False):
        self<span style="color:#f92672">.</span>folder <span style="color:#f92672">=</span> folder <span style="color:#75715e"># Folder where data is saved</span>
        self<span style="color:#f92672">.</span>fnoise <span style="color:#f92672">=</span> fnoise <span style="color:#75715e"># noise function to use</span>
        self<span style="color:#f92672">.</span>px <span style="color:#f92672">=</span> px <span style="color:#75715e"># image size</span>
        self<span style="color:#f92672">.</span>n_batch <span style="color:#f92672">=</span> n_batch <span style="color:#75715e"># batch size</span>
        self<span style="color:#f92672">.</span>random <span style="color:#f92672">=</span> random <span style="color:#75715e"># whether to randomize</span>
        self<span style="color:#f92672">.</span>file <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>sort(glob(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(folder,<span style="color:#e6db74">&#39;*.jpg&#39;</span>))) <span style="color:#75715e"># the names of all the images in the folder</span>
        self<span style="color:#f92672">.</span>len <span style="color:#f92672">=</span> len(self<span style="color:#f92672">.</span>file) <span style="color:#75715e"># number of images</span>
        self<span style="color:#f92672">.</span>nkai <span style="color:#f92672">=</span> int(np<span style="color:#f92672">.</span>ceil(self<span style="color:#f92672">.</span>len<span style="color:#f92672">/</span>n_batch)) <span style="color:#75715e"># number of times this batch size can be repeated</span>
    
    <span style="color:#66d9ef">def</span> __iter__(self):
        self<span style="color:#f92672">.</span>i_iter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        <span style="color:#66d9ef">if</span>(self<span style="color:#f92672">.</span>random):
            np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>seed(None)
            <span style="color:#75715e"># Change order randomly</span>
            self<span style="color:#f92672">.</span>i_rand <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>permutation(self<span style="color:#f92672">.</span>len)
        <span style="color:#66d9ef">else</span>:
            np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>seed(<span style="color:#ae81ff">0</span>)
            self<span style="color:#f92672">.</span>i_rand <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(self<span style="color:#f92672">.</span>len)
        <span style="color:#66d9ef">return</span> self
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__next__</span>(self):
        <span style="color:#66d9ef">if</span>(self<span style="color:#f92672">.</span>i_iter<span style="color:#f92672">&gt;=</span>self<span style="color:#f92672">.</span>len):
            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">StopIteration</span>
        
        x <span style="color:#f92672">=</span> []
        y <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>i_rand[self<span style="color:#f92672">.</span>i_iter:self<span style="color:#f92672">.</span>i_iter<span style="color:#f92672">+</span>self<span style="color:#f92672">.</span>n_batch]:
            yi <span style="color:#f92672">=</span> imread(self<span style="color:#f92672">.</span>file[i])<span style="color:#f92672">/</span><span style="color:#ae81ff">255.</span> <span style="color:#75715e"># Read image</span>
            <span style="color:#66d9ef">if</span>(self<span style="color:#f92672">.</span>random <span style="color:#f92672">and</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>random()<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0.5</span>):
                yi <span style="color:#f92672">=</span> yi[:,::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#75715e"># Randomly reverse image left and right</span>
            xi <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>fnoise(yi,self<span style="color:#f92672">.</span>px) <span style="color:#75715e"># add noise</span>
            
            <span style="color:#75715e"># Change to specified size</span>
            xi <span style="color:#f92672">=</span> resize(xi,(self<span style="color:#f92672">.</span>px,self<span style="color:#f92672">.</span>px),anti_aliasing<span style="color:#f92672">=</span>True,mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;constant&#39;</span>)
            yi <span style="color:#f92672">=</span> resize(yi,(self<span style="color:#f92672">.</span>px,self<span style="color:#f92672">.</span>px),anti_aliasing<span style="color:#f92672">=</span>True,mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;constant&#39;</span>)
            xi <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>Tensor(xi<span style="color:#f92672">.</span>transpose(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>))
            yi <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>Tensor(yi<span style="color:#f92672">.</span>transpose(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>))
            x<span style="color:#f92672">.</span>append(xi)
            y<span style="color:#f92672">.</span>append(yi)
            
        x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>stack(x)
        y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>stack(y)
        self<span style="color:#f92672">.</span>i_iter <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>n_batch
        <span style="color:#66d9ef">return</span> x,y


<span style="color:#75715e">## Image converter ##</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dinonet</span>:
    <span style="color:#66d9ef">def</span> __init__(self,net,cn,hozon_folder,gakushuuritsu<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-3</span>,gpu<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
        self<span style="color:#f92672">.</span>gakushuuritsu <span style="color:#f92672">=</span> gakushuuritsu
        self<span style="color:#f92672">.</span>cn <span style="color:#f92672">=</span> cn
        self<span style="color:#f92672">.</span>net <span style="color:#f92672">=</span> net(cn<span style="color:#f92672">=</span>cn)
        self<span style="color:#f92672">.</span>opt <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(self<span style="color:#f92672">.</span>net<span style="color:#f92672">.</span>parameters(),lr<span style="color:#f92672">=</span>gakushuuritsu)
        <span style="color:#66d9ef">if</span>(gpu):
            <span style="color:#75715e"># When using GPU</span>
            self<span style="color:#f92672">.</span>dev <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>device(<span style="color:#e6db74">&#39;cuda&#39;</span>)
            self<span style="color:#f92672">.</span>net<span style="color:#f92672">.</span>cuda()
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>dev <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>device(<span style="color:#e6db74">&#39;cpu&#39;</span>)
            
        self<span style="color:#f92672">.</span>hozon_folder <span style="color:#f92672">=</span> hozon_folder
        <span style="color:#75715e"># If you don&#39;t originally have a save folder, create one in advance</span>
        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(hozon_folder)):
            os<span style="color:#f92672">.</span>mkdir(hozon_folder)
        
        <span style="color:#75715e"># File to store the trained parameters and results</span>
        netparam_file <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(hozon_folder,<span style="color:#e6db74">&#39;netparam.pkl&#39;</span>)
        <span style="color:#66d9ef">if</span>(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(netparam_file)):
            <span style="color:#75715e"># If there is already saved data, continue from the previous</span>
            s <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>load(netparam_file)
            self<span style="color:#f92672">.</span>net<span style="color:#f92672">.</span>load_state_dict(s[<span style="color:#e6db74">&#39;w&#39;</span>])
            self<span style="color:#f92672">.</span>opt<span style="color:#f92672">.</span>load_state_dict(s[<span style="color:#e6db74">&#39;o&#39;</span>])
            self<span style="color:#f92672">.</span>mounankai <span style="color:#f92672">=</span> s[<span style="color:#e6db74">&#39;n&#39;</span>]
            self<span style="color:#f92672">.</span>sonshitsu <span style="color:#f92672">=</span> s[<span style="color:#e6db74">&#39;l&#39;</span>]
        <span style="color:#66d9ef">else</span>:
            <span style="color:#75715e"># Start from the beginning</span>
            self<span style="color:#f92672">.</span>mounankai <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
            self<span style="color:#f92672">.</span>sonshitsu <span style="color:#f92672">=</span> []
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gakushuu</span>(self,dalo_kunren,dalo_kenshou,n_kurikaeshi,n_kaku<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,yokukataru<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Training: </span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> | Verification </span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;&#39;((dalo_kunren.len,dalo_kenshou.len))</span>
        t0 <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
        kenshou_data <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> da_ken <span style="color:#f92672">in</span> dalo_kenshou:
            kenshou_data<span style="color:#f92672">.</span>append(da_ken)
        dalo_kunren<span style="color:#f92672">.</span>random <span style="color:#f92672">=</span> True
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;It took </span><span style="color:#e6db74">%.3f</span><span style="color:#e6db74"> minutes to prepare the image&#39;</span><span style="color:#f92672">%</span>((t0<span style="color:#f92672">-</span>time<span style="color:#f92672">.</span>time())<span style="color:#f92672">/</span><span style="color:#ae81ff">60</span>))
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;==start learning==&#39;</span>)
        
        t0 <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
        <span style="color:#75715e"># Train many times</span>
        <span style="color:#66d9ef">for</span> kaime <span style="color:#f92672">in</span> range(self<span style="color:#f92672">.</span>mounankai,self<span style="color:#f92672">.</span>mounankai<span style="color:#f92672">+</span>n_kurikaeshi):
            <span style="color:#75715e"># Start mini batch</span>
            <span style="color:#66d9ef">for</span> i_batch,(x,y) <span style="color:#f92672">in</span> enumerate(dalo_kunren):
                z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>net(x<span style="color:#f92672">.</span>to(self<span style="color:#f92672">.</span>dev))
                sonshitsu <span style="color:#f92672">=</span> mse(z,y<span style="color:#f92672">.</span>to(self<span style="color:#f92672">.</span>dev)) <span style="color:#75715e"># Loss of training data</span>
                self<span style="color:#f92672">.</span>opt<span style="color:#f92672">.</span>zero_grad()
                sonshitsu<span style="color:#f92672">.</span>backward()
                self<span style="color:#f92672">.</span>opt<span style="color:#f92672">.</span>step()
                
                <span style="color:#75715e"># Test on verification data</span>
                <span style="color:#66d9ef">if</span>((i_batch<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">%</span>int(np<span style="color:#f92672">.</span>ceil(dalo_kunren<span style="color:#f92672">.</span>nkai<span style="color:#f92672">/</span>yokukataru))<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> <span style="color:#f92672">or</span> i_batch<span style="color:#f92672">==</span>dalo_kunren<span style="color:#f92672">.</span>nkai<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>):
                    self<span style="color:#f92672">.</span>net<span style="color:#f92672">.</span>eval()
                    sonshitsu <span style="color:#f92672">=</span> []
                    <span style="color:#66d9ef">if</span>(n_kaku):
                        gazou <span style="color:#f92672">=</span> []
                        n_kaita <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
                    
                    <span style="color:#66d9ef">for</span> x,y <span style="color:#f92672">in</span> kenshou_data:
                        z <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>net(x<span style="color:#f92672">.</span>to(self<span style="color:#f92672">.</span>dev))
                        <span style="color:#75715e"># Loss of verification data</span>
                        sonshitsu<span style="color:#f92672">.</span>append(mse(z,y<span style="color:#f92672">.</span>to(self<span style="color:#f92672">.</span>dev))<span style="color:#f92672">.</span>item())
                        <span style="color:#75715e"># Write some images made from verification data</span>
                        <span style="color:#66d9ef">if</span>(n_kaita<span style="color:#f92672">&lt;</span>n_kaku):
                            x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>numpy()<span style="color:#f92672">.</span>transpose(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>) <span style="color:#75715e"># input</span>
                            y <span style="color:#f92672">=</span> y<span style="color:#f92672">.</span>numpy()<span style="color:#f92672">.</span>transpose(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>) <span style="color:#75715e"># model</span>
                            z <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>clip(z<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>detach()<span style="color:#f92672">.</span>numpy(),<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>transpose(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>) <span style="color:#75715e"># output</span>
                            <span style="color:#66d9ef">for</span> i,(xi,yi,zi) <span style="color:#f92672">in</span> enumerate(zip(x,y,z)):
                                <span style="color:#75715e"># [Input, output, model]</span>
                                gazou<span style="color:#f92672">.</span>append(np<span style="color:#f92672">.</span>vstack([xi,zi,yi]))
                                n_kaita <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
                                <span style="color:#66d9ef">if</span>(n_kaita<span style="color:#f92672">&gt;=</span>n_kaku):
                                    <span style="color:#66d9ef">break</span>
                    sonshitsu <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(sonshitsu)<span style="color:#66d9ef">if</span>(n_kaku):
                        gazou <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>hstack(gazou)
                        imsave(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>hozon_folder,<span style="color:#e6db74">&#39;kekka</span><span style="color:#e6db74">%03d</span><span style="color:#e6db74">.jpg&#39;</span><span style="color:#f92672">%</span>(kaime<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)),gazou)
                    
                    <span style="color:#75715e"># Output the current status</span>
                    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">:</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">/</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> ~ Loss: </span><span style="color:#e6db74">%.4e</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%.2f</span><span style="color:#e6db74"> minutes have passed&#39;</span><span style="color:#f92672">%</span>(kaime<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,i_batch<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,dalo_kunren<span style="color:#f92672">.</span>nkai,sonshitsu,(time<span style="color:#f92672">.</span>time()<span style="color:#f92672">-</span>t0)<span style="color:#f92672">/</span> <span style="color:#ae81ff">60</span>))
                    self<span style="color:#f92672">.</span>net<span style="color:#f92672">.</span>train()
            
            <span style="color:#75715e"># Mini batch once completed</span>
            self<span style="color:#f92672">.</span>sonshitsu<span style="color:#f92672">.</span>append(sonshitsu)
            <span style="color:#75715e"># Save parameters and state</span>
            sd <span style="color:#f92672">=</span> dict(w<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>net<span style="color:#f92672">.</span>state_dict(),o<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>opt<span style="color:#f92672">.</span>state_dict(),n<span style="color:#f92672">=</span>kaime<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,l<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>sonshitsu)
            torch<span style="color:#f92672">.</span>save(sd,os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>hozon_folder,<span style="color:#e6db74">&#39;netparam.pkl&#39;</span>))
            
            <span style="color:#75715e"># Draw a graph showing the change in loss (MSE)</span>
            plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>[<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">4</span>])
            plt<span style="color:#f92672">.</span>gca(ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;MSE&#39;</span>)
            ar <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">1</span>,kaime<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)
            plt<span style="color:#f92672">.</span>plot(ar,self<span style="color:#f92672">.</span>sonshitsu,<span style="color:#e6db74">&#39;#11aa99&#39;</span>)
            plt<span style="color:#f92672">.</span>tight_layout()
            plt<span style="color:#f92672">.</span>savefig(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>hozon_folder,<span style="color:#e6db74">&#39;graph.png&#39;</span>))
            plt<span style="color:#f92672">.</span>close()

    <span style="color:#66d9ef">def</span> __call__(self,x,n_batch<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>):
        self<span style="color:#f92672">.</span>net<span style="color:#f92672">.</span>eval()
        x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>Tensor(x)
        y <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,len(x),n_batch):
            y<span style="color:#f92672">.</span>append(self<span style="color:#f92672">.</span>net(x[i:i<span style="color:#f92672">+</span>n_batch]<span style="color:#f92672">.</span>to(self<span style="color:#f92672">.</span>dev))<span style="color:#f92672">.</span>detach()<span style="color:#f92672">.</span>cpu())
        <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>cat(y)<span style="color:#f92672">.</span>numpy()


<span style="color:#75715e">## Noise function ##</span>

<span style="color:#75715e"># Gaussian noise</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Gaussnoise</span>:
    <span style="color:#66d9ef">def</span> __init__(self,a,clip<span style="color:#f92672">=</span>True):
        self<span style="color:#f92672">.</span>a <span style="color:#f92672">=</span> a <span style="color:#75715e"># noise size</span>
        self<span style="color:#f92672">.</span>clip <span style="color:#f92672">=</span> clip <span style="color:#75715e"># Whether to make noise within [0,1] after adding noise</span>
    
    <span style="color:#66d9ef">def</span> __call__(self,y,px):
        x <span style="color:#f92672">=</span> y <span style="color:#f92672">+</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randn(<span style="color:#f92672">*</span>y<span style="color:#f92672">.</span>shape)<span style="color:#f92672">*</span>self<span style="color:#f92672">.</span>a
        <span style="color:#66d9ef">if</span>(self<span style="color:#f92672">.</span>clip):
            x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>clip(x,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)
        <span style="color:#66d9ef">return</span> x

<span style="color:#75715e"># Graffiti noise</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Rakugaki</span>:
    <span style="color:#66d9ef">def</span> __init__(self,l0,l1,n):
        self<span style="color:#f92672">.</span>l0 <span style="color:#f92672">=</span> l0 <span style="color:#75715e"># shortest line length / image pixel</span>
        self<span style="color:#f92672">.</span>l1 <span style="color:#f92672">=</span> l1 <span style="color:#75715e"># longest line length / image pixel</span>
        self<span style="color:#f92672">.</span>n <span style="color:#f92672">=</span> n <span style="color:#75715e"># number of lines</span>
    
    <span style="color:#66d9ef">def</span> __call__(self,y,px):
        x <span style="color:#f92672">=</span> y<span style="color:#f92672">.</span>copy()
        h <span style="color:#f92672">=</span> min(y<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>],y<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>])
        l0 <span style="color:#f92672">=</span> int(h<span style="color:#f92672">*</span>self<span style="color:#f92672">.</span>l0) <span style="color:#75715e"># shortest line pixel</span>
        l1 <span style="color:#f92672">=</span> int(h<span style="color:#f92672">*</span>self<span style="color:#f92672">.</span>l1) <span style="color:#75715e"># longest line pixel</span>
        
        kk <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>,h,[self<span style="color:#f92672">.</span>n,<span style="color:#ae81ff">2</span>])
        cc <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">256</span>,[self<span style="color:#f92672">.</span>n,<span style="color:#ae81ff">3</span>])<span style="color:#f92672">/</span><span style="color:#ae81ff">255.</span>
        ll <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randint(l0,l1<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,self<span style="color:#f92672">.</span>n)
        <span style="color:#66d9ef">for</span> k,c,l <span style="color:#f92672">in</span> zip(kk,cc,ll):
            p <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros([l,<span style="color:#ae81ff">2</span>],dtype<span style="color:#f92672">=</span>int)
            p1 <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">4</span>,l<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
            p[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> k
            p2 <span style="color:#f92672">=</span> p1<span style="color:#f92672">%</span><span style="color:#ae81ff">2</span>
            p3 <span style="color:#f92672">=</span> p1<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">1</span>
            p[<span style="color:#ae81ff">1</span>:,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+=</span> (p2<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>)<span style="color:#f92672">*</span>np<span style="color:#f92672">.</span>where(p3,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)
            p[<span style="color:#ae81ff">1</span>:,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+=</span> (p2<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span>np<span style="color:#f92672">.</span>where(p3,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)
            p <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>cumsum(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">%</span>h
            x[p[:,<span style="color:#ae81ff">0</span>],p[:,<span style="color:#ae81ff">1</span>]] <span style="color:#f92672">=</span> c
        <span style="color:#66d9ef">return</span> x

<span style="color:#75715e"># Noise generated by reduction</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Shukushou</span>:
    <span style="color:#66d9ef">def</span> __init__(self,scale<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>):
        self<span style="color:#f92672">.</span>scale <span style="color:#f92672">=</span> scale
    
    <span style="color:#66d9ef">def</span> __call__(self,y,px):
        px <span style="color:#f92672">=</span> int(px<span style="color:#f92672">*</span>self<span style="color:#f92672">.</span>scale)
        <span style="color:#66d9ef">return</span> resize(y,(px,px),anti_aliasing<span style="color:#f92672">=</span>True,mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;constant&#39;</span>)



<span style="color:#75715e">## execute ##</span>

kunren_folder <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kunren&#39;</span> <span style="color:#75715e"># Training data folder</span>
kenshou_folder <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;kenshou&#39;</span> <span style="color:#75715e"># Verification data folder</span>
hozon_folder <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;hozon&#39;</span> <span style="color:#75715e"># Folder to save the results</span>
cn <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#75715e"># Number of channels (3 color data)</span>
n_batch <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span> <span style="color:#75715e"># batch size</span>
px <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span> <span style="color:#75715e"># image size</span>
n_kurikaeshi <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span> <span style="color:#75715e"># how many times to repeat</span>
n_kaku <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span> <span style="color:#75715e"># output a number of resulting images for viewing</span>
yokukataru <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#75715e"># How many times the result is output in one training</span>

<span style="color:#75715e"># Choose a model to use</span>
model <span style="color:#f92672">=</span> Unet
<span style="color:#75715e">#net = DnCNN</span>
<span style="color:#75715e">#net = Win5RB</span>

<span style="color:#75715e"># Choose a function that causes noise</span>
fnoise <span style="color:#f92672">=</span> Gaussnoise(<span style="color:#ae81ff">0.3</span>)
<span style="color:#75715e">#noise = Rakugaki(0.5,5,25)</span>
<span style="color:#75715e">#noise = Shukushou(0.25)</span>

dalo_kunren <span style="color:#f92672">=</span> Gazoudalo(kunren_folder,fnoise,px,n_batch) <span style="color:#75715e"># training data</span>
dalo_kenshou <span style="color:#f92672">=</span> Gazoudalo(kenshou_folder,fnoise,px,n_batch) <span style="color:#75715e"># Verification data</span>
dino <span style="color:#f92672">=</span> Dinonet(model,cn,hozon_folder)
<span style="color:#75715e"># Start learning</span>
dino<span style="color:#f92672">.</span>gakushuu(dalo_kunren,dalo_kenshou,n_kurikaeshi,n_kaku,yokukataru)
</code></pre></div><p>#Result</p>
<p>Next, we will see the results of testing with verification data after practicing 30 times with those three models.</p>
<h2 id="gaussian-noise">Gaussian noise</h2>
<p>Learning progress</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/9ce48a56-0d29-d11c-7ff9-7830b086ee8f.png" alt=""></p>
<p>The output image. From top to bottom &ldquo;Input, DnCNN, U-net, WIN4-RB, original&rdquo;</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/3cfc5fae-b721-5a1b-52c5-ddeb158fa090.jpeg" alt=""></p>
<h2 id="graffiti">graffiti</h2>
<p>Learning progress</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/cdc4b50e-62d6-a0a5-4185-b75314601829.png" alt=""></p>
<p>The output image</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/4c4fbc55-64b6-18ba-7644-44b8e07a3d46.jpeg" alt=""></p>
<h2 id="restore-from-reduction">Restore from reduction</h2>
<p>Learning progress</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/f4b2fac4-6d81-7b1b-ba59-ce05275e2b11.png" alt=""></p>
<p>The output image</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/202903/c57756f2-9da8-be57-436d-b79b36a79924.jpeg" alt=""></p>
<p>#Summary</p>
<p>From the results, it seems that some models can remove noise to some extent.</p>
<p>From the loss value, U-net seems to be the best for Gaussian noise and reduction, but DnCNN seems best for graffiti.</p>
<p>In addition, there is a method called noise2noise that can be learned without a beautiful image. I&rsquo;m writing about this in this article. <a href="https://qiita.com/phyblas/items/d4884a58041eaa01ef5e">https://qiita.com/phyblas/items/d4884a58041eaa01ef5e</a></p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
