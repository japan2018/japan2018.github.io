<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>Why is the floating point number of 0.1 greater than 0.1, but less than 1.0 when added 10 times [Part 1] | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Why is the floating point number of 0.1 greater than 0.1, but less than 1.0 when added 10 times [Part 1]</h1>
<p>
  <small class="text-secondary">
  
  
  Jan 28, 2020
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/float"> float</a></code></small>


<small><code><a href="https://memotut.com/tags/double"> double</a></code></small>


<small><code><a href="https://memotut.com/tags/floating-decimal-point"> floating decimal point</a></code></small>


<small><code><a href="https://memotut.com/tags/computer"> computer</a></code></small>

</p>
<pre><code>In this article, I found that converting ``0.1`` to a floating point number yields a slightly larger number than ``0.1``.
</code></pre>
<p><a href="https://qiita.com/yucatio/items/c03def631bc5eaaa9887">Why is 0.1 displayed as a floating point number but is displayed as 0.1 when printed?</a>
This means that if you add <code>0.1</code>, positive errors should accumulate. For example, I expected that adding <code>0.1</code> ten times would be slightly larger than <code>1</code>.
I&rsquo;ll give it a try.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">total <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
    total <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0.1</span>

<span style="color:#66d9ef">print</span>(total)
<span style="color:#75715e">#=&gt; 0.9999999999999999</span>
</code></pre></div><p>Unexpectedly, a number smaller than <code>1</code> was output. I investigated this phenomenon this time.</p>
<p>#Environment
This article uses Python 3.7.</p>
<h1 id="assumption-floating-point-number">[Assumption] Floating point number</h1>
<p>Throughout this article, the term &ldquo;floating point number&rdquo; refers to &ldquo;IEEE 754 double precision&rdquo;.</p>
<p>The floating-point number format is a number converted into the following format, in which <code>sign</code>, <code>exp</code>, and <code>frac</code> are arranged in order.</p>
<pre><code class="language-math" data-lang="math">(-1)^{sign} \times 2^{exp-1023} \times (1 + frac \times 2^{-52})
</code></pre><p>The name and number of bits of each symbol are as follows.</p>
<table>
<thead>
<tr>
<th>Symbol</th>
<th>Japanese name</th>
<th>English name</th>
<th>Bit number</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>sign</td>
<td>sign part</td>
<td>sign</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>exp</td>
<td>Exponent part</td>
<td>exponent</td>
<td>11</td>
<td></td>
</tr>
<tr>
<td>frac</td>
<td>mantissa</td>
<td>fraction</td>
<td>52</td>
<td></td>
</tr>
</tbody>
</table>
<p>#0.1 is expressed as a floating point number
<img width="896" alt="to_float_point_0_1.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/288329/82699691-ef8a-b613-f7ea-243bf1ed0e19.png">
<a href="https://tools.m-bsys.com/calculators/ieee754.php">https://tools.m-bsys.com/calculators/ieee754.php</a></p>
<p>``0.1&rsquo;&rsquo; is the binary representation of a floating point number,</p>
<pre><code>Sign = 0
Index = 01111111011
Mantissa = 1001100110011001100110011001100110011001100110011010
</code></pre><p>Converted to decimal,</p>
<pre><code>Sign = 0
Index = 1019
Mantissa = 2702159776422298
</code></pre><p>is. Floating point format exponent has <code>1023</code> added, so subtracting this yields <code>-4</code>.</p>
<p>If you change ``0.1&rsquo;&rsquo; represented by a floating point number into a decimal number,</p>
<pre><code>0.1000000000000000055511151231257827021181583404541015625
</code></pre><p>is.</p>
<h1 id="the-number-when-adding-01">The number when adding 0.1</h1>
<p>The floating point number of <code>0.1'' is slightly larger than </code>0.1<code>, but it seems that the reverse phenomenon occurs somewhere if it does not become </code>1&rsquo;&rsquo; when 10 times are added.
Let&rsquo;s see the calculation result on the way. If you pass a floating point number to <code>Decimal</code> and <code>print</code>, the value when the floating point number is converted to decimal is displayed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> decimal <span style="color:#f92672">import</span> Decimal

total <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
d_total <span style="color:#f92672">=</span> Decimal(<span style="color:#e6db74">&#39;0&#39;</span>)

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
    total <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0.1</span>
    d_total <span style="color:#f92672">+=</span> Decimal(<span style="color:#e6db74">&#39;0.1&#39;</span>)
    <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#39;{d_total}|{Decimal(total)}&#39;</span>)
</code></pre></div><p>Here is the execution result.</p>
<p>Decimal|Calculation result</p>
<ul>
<li>&ndash;|&mdash;
0.1|<code>0.1000000000000000055511151231257827021181583404541015625</code>
0.2|<code>0.200000000000000011102230246251565404236316680908203125</code>
0.3|<code>0.3000000000000000444089209850062616169452667236328125</code>
0.4|<code>0.40000000000000002220446049250313080847263336181640625</code>
0.5|<code>0.5</code>
0.6|<code>0.59999999999999997779553950749686919152736663818359375</code>
0.7|<code>0.6999999999999999555910790149937383830547332763671875</code>
0.8|<code>0.79999999999999993338661852249060757458209991455078125</code>
0.9|<code>0.899999999999999911182158029987476766109466552734375</code>
1.0|<code>0.99999999999999988897769753748434595763683319091796875</code></li>
</ul>
<p><code>0.1'' to </code>0.4&rsquo;&rsquo; is more than each calculated as a decimal number, <code>0.5'' is exactly, </code>0.6&rsquo;&rsquo; to ``1.0&rsquo;&rsquo; is more than calculated as a decimal number The result is also small.</p>
<h1 id="when-adding-01-each-check-how-much-each-is-added">When adding 0.1 each, check how much each is added</h1>
<p>Let&rsquo;s check how much is actually added when adding <code>0.1</code>. The program is here. Since the Decimal of Python has 28 significant digits by default, change it to a sufficient size in advance.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> decimal <span style="color:#f92672">import</span> Decimal, getcontext

Changed the number of significant digits of <span style="color:#75715e"># Decimal to 64</span>
getcontext()<span style="color:#f92672">.</span>prec <span style="color:#f92672">=</span> <span style="color:#ae81ff">64</span>

total <span style="color:#f92672">=</span> prev <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
d_total <span style="color:#f92672">=</span> Decimal(<span style="color:#e6db74">&#39;0&#39;</span>)

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
    total <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0.1</span>
    d_total <span style="color:#f92672">+=</span> Decimal(<span style="color:#e6db74">&#39;0.1&#39;</span>)
    <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#39; |{Decimal(total)-Decimal(prev)}&#39;</span>)
    <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#39;{d_total}|{Decimal(total)}&#39;</span>)
    prev <span style="color:#f92672">=</span> total
</code></pre></div><p>This is the execution result. Floating-point calculation results are shown in the odd lines except the header, and the differences are shown in the even lines.</p>
<p>Decimal| Calculation result/difference</p>
<ul>
<li>&ndash;|:&mdash;
0.1|<code>0.1000000000000000055511151231257827021181583404541015625</code>
|<code>0.1000000000000000055511151231257827021181583404541015625</code>
0.2|<code>0.200000000000000011102230246251565404236316680908203125</code>
|<code>0.100000000000000033306690738754696212708950042724609375</code>
0.3|<code>0.3000000000000000444089209850062616169452667236328125</code>
|<code>0.09999999999999997779553950749686919152736663818359375</code>
0.4|<code>0.40000000000000002220446049250313080847263336181640625</code>
|<code>0.09999999999999997779553950749686919152736663818359375</code>
0.5|<code>0.5</code>
|<code>0.09999999999999997779553950749686919152736663818359375</code>
0.6|<code>0.59999999999999997779553950749686919152736663818359375</code>
|<code>0.09999999999999997779553950749686919152736663818359375</code>
0.7|<code>0.6999999999999999555910790149937383830547332763671875</code>
|<code>0.09999999999999997779553950749686919152736663818359375</code>
0.8|<code>0.79999999999999993338661852249060757458209991455078125</code>
|<code>0.09999999999999997779553950749686919152736663818359375</code>
0.9|<code>0.899999999999999911182158029987476766109466552734375</code>
|<code>0.09999999999999997779553950749686919152736663818359375</code>
1.0|<code>0.99999999999999988897769753748434595763683319091796875</code></li>
</ul>
<p>The difference of <code>0.1 → 0.2</code> is the same as the floating point number of <code>0.1</code>, but <code>0.2 → 0.3</code> is larger than that.
After <code>0.3</code>, the same value is added, and it is smaller than the value that <code>0.1</code> is represented by a floating point number.</p>
<p>By the way, in all values after <code>0.4</code>, numbers smaller than <code>0.1</code> are not added, but it increases again with <code>1.1 → 1.2</code>.</p>
<p>Expected value | Calculation result/difference</p>
<ul>
<li>&ndash;|:&mdash;
1.0|<code>0.99999999999999988897769753748434595763683319091796875</code>
|<code>0.09999999999999997779553950749686919152736663818359375</code>
1.1|<code>1.0999999999999998667732370449812151491641998291015625</code>
|<code>0.1000000000000000888178419700125232338905334472656250</code>
1.2|<code>1.1999999999999999555910790149937383830547332763671875</code>
|<code>0.1000000000000000888178419700125232338905334472656250</code>
1.3|<code>1.3000000000000000444089209850062616169452667236328125</code>
|<code>0.1000000000000000888178419700125232338905334472656250</code>
1.4|<code>1.4000000000000001332267629550187848508358001708984375</code>
|<code>0.1000000000000000888178419700125232338905334472656250</code>
1.5|<code>1.5000000000000002220446049250313080847263336181640625</code></li>
</ul>
<p>Why doesn&rsquo;t it increment by <code>0.1</code> when adding <code>0.1</code>?
It has rounding errors associated with it.#Floating point addition procedure
Addition of positive floating point numbers is performed by the following procedure.</p>
<p>① Match the smaller index to the larger index
② Adjust the mantissa by making the exponent larger and making it smaller.
③ Add mantissas
④ When a carry occurs, add 1 to the exponent and reduce the mantissa accordingly.
⑤ Round the digit where the mantissa overflows (round even number)</p>
<p>#Decimal addition example</p>
<p>The procedure for adding floating-point numbers is shown in decimal.
Consider the addition of a decimal number with 5 significant digits.</p>
<pre><code class="language-math" data-lang="math">\begin{array}{llcll}
    &amp;9.8192 &amp; \times &amp; 10^2 &amp; (= 981.92)\\
 + &amp;4.7533 &amp; \times &amp; 10^1 &amp; (= 47.533)\\
\hline
\end{array}
</code></pre><p>The following is a step-by-step explanation.</p>
<p>① Match the smaller index to the larger index
② Adjust the mantissa by making the exponent larger and making it smaller.</p>
<p>Align the exponents to add them. This time, the one with the larger index is <code>9.8192 x 10^2</code>, so modify <code>4.7533 x 10^1</code> to fit it.</p>
<pre><code class="language-math" data-lang="math">\begin{array}{llcr}
&amp;4.7533 &amp; \times &amp; 10^1\\
 = &amp;0.47533 &amp; \times &amp; 10^2
\end{array}
</code></pre><p>③ Add mantissas
Addition is done.</p>
<pre><code class="language-math" data-lang="math">\begin{array}{llcr}
    &amp;\phantom{1}9.8192 &amp; \times &amp; 10^2\\
 + &amp;\phantom{1}0.47533 &amp; \times &amp; 10^2\\
\hline
 &amp; 10.29453 &amp; \times &amp; 10^2
\end{array}
</code></pre><p>④ When a carry occurs, add 1 to the exponent and reduce the mantissa accordingly.</p>
<p>Since the integer part is 10, a carry has occurred. To make the integer part one digit, add 1 to the exponent, and divide the mantissa by that much.</p>
<pre><code class="language-math" data-lang="math">\begin{array}{llcr}
&amp;10.29453 &amp; \times &amp; 10^2\\
 = &amp;1.029453 &amp; \times &amp; 10^3
\end{array}
</code></pre><p>⑤ Round the overflowing digits (even rounding)</p>
<p>Since there are 5 significant digits this time, we have to consider the processing of <code>53</code> at the end. Since even rounding is used here, it is rounded up.</p>
<pre><code class="language-math" data-lang="math">\begin{array}{llcr}
&amp;1.029453 &amp; \times &amp; 10^3\\
\rightarrow &amp;1.0295 &amp; \times &amp; 10^3
\end{array}
</code></pre><p>The procedure for adding floating point numbers has been verified in decimal.</p>
<h1 id="even-rounding">Even rounding</h1>
<p>Even rounding is a rounding method similar to rounding, but when the target to be rounded is exactly in the middle of two values, it is rounded up or down so that the digit above it is an even number.</p>
<p>For example, when rounding to the first decimal place, <code>1.5</code> becomes <code>2</code> and <code>4.5</code> becomes <code>4</code>.
<code>4.51</code> is <code>5</code>.</p>
<p>#Protective digits and sticky bits</p>
<p>In the decimal addition example, the last digit (<code>53</code> in the above example) overflowed from the significant digits when the exponents were matched. These values are rounded off at the end and must be saved. (Don&rsquo;t truncate just because the exponent is increased and the mantissa is decreased to adjust it in step 2) because it does not fill the significant digits.</p>
<p>With even rounding,</p>
<ul>
<li>Greater than 5 → round up</li>
<li>5 perfect → round up or round down</li>
<li>Less than 5 → round down</li>
</ul>
<p>So we need not only the most significant digit of the overflowed digit, but also the information of the digits below it. However, what is needed for the information other than the most significant digit is whether or not it is exactly 0, so it seems sufficient to prepare one boolean value.</p>
<p>The Guard digits are the area to store the overflowed digits. For adding positive numbers, one guard digit is sufficient. (One more bit is needed to handle subtraction and negative numbers). In the above example, if the number of protected digits is 1, the most significant bit <code>5</code> of the overflowed digits <code>53</code> will be stored.
A sticky bit is a boolean value that indicates whether the number of digits below the guard digit includes one or more. In the above example, <code>true</code> (or <code>1</code>) is set because the overflowed digit <code>3</code> is 1 or more.</p>
<h1 id="rewrite-decimal-addition-using-guard-digits-and-sticky-bits">Rewrite decimal addition using guard digits and sticky bits</h1>
<p>Apply guard digits and sticky bits to the decimal addition example above.</p>
<pre><code class="language-math" data-lang="math">\begin{array}{llcll}
    &amp;9.8192 &amp; \times &amp; 10^2 &amp; (= 981.92)\\
 + &amp;4.7533 &amp; \times &amp; 10^1 &amp; (= 47.533)\\
\hline
\end{array}
</code></pre><p>① Match the smaller index to the larger index
② Adjust the mantissa by making the exponent larger and making it smaller.</p>
<pre><code class="language-math" data-lang="math">\begin{array}{lrcll}
&amp;4.7533 &amp; \times &amp; 10^1&amp;\\
 = &amp;0.47533 &amp; \times &amp; 10^2&amp; (Protect digit = 3)
\end{array}
</code></pre><p>The last <code>3</code> has overflowed, so I saved it in a guard digit.</p>
<p>③ Add mantissas</p>
<pre><code class="language-math" data-lang="math">\begin{array}{llcr}
    &amp;\phantom{1}9.8192 &amp; \times &amp; 10^2&amp;\\
 + &amp;\phantom{1}0.4753 &amp; \times &amp; 10^2&amp; (guard digit=3)\\
\hline
 &amp; 10.2945 &amp; \times &amp; 10^2&amp; (Protect digit = 3)
\end{array}
</code></pre><p>④ When a carry occurs, add 1 to the exponent and reduce the mantissa accordingly.</p>
<pre><code class="language-math" data-lang="math">\begin{array}{llcrl}
&amp;10.2945 &amp; \times &amp; 10^2&amp;\\
 = &amp;1.0294 &amp; \times &amp; 10^3&amp; (Protect digit = 5, Sticky bit = true)
\end{array}
</code></pre><p>The last <code>5</code> has overflowed, so I saved it in a guard digit. At this time, <code>3</code> that was originally stored in the guard digit is stored in the sticky bit. The sticky bit holds whether the number is greater than or equal to 1, so it is set to <code>true</code>.</p>
<p>⑤ Round the overflowing digits (even rounding)
Rounds using guard digits and sticky bits,
Rounding up is done because the sticky bit = <code>true</code> with the protection digit = <code>5</code>.</p>
<pre><code class="language-math" data-lang="math">\begin{array}{llcrl}
&amp;1.0294 &amp; \times &amp; 10^3&amp;(Protect digit=5, Sticky bit=true)\\
\rightarrow &amp;1.0295 &amp; \times &amp; 10^3
\end{array}
</code></pre><p>The procedure for adding floating-point numbers using guard digits and sticky bits has been verified in decimal. Do the same for binary numbers.</p>
<h1 id="to-the-second-part">To the second part</h1>
<p>Since it&rsquo;s long, I&rsquo;ll divide the article. In the second part, we will check the behavior when adding <code>0.1</code>. The sites that I referred to are also summarized in the second part.</p>
<p><a href="https://qiita.com/yucatio/items/b5ed14bbd1e9a751b703">Why is 0.1 floating point greater than 0.1, but less than 1.0 when added 10 times [Part 2]</a></p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
