<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://japan2018.github.io/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://japan2018.github.io/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://japan2018.github.io/favicon-16x16.png">

  
  <link rel="manifest" href="https://japan2018.github.io/site.webmanifest">

  
  <link rel="mask-icon" href="https://japan2018.github.io/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://japan2018.github.io/css/bootstrap.min.css" />

  
  <title>[Python] Practical Beautiful Soup ~Scraping the triple odds table on the official website for boat racing~ | Some Title</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] Practical Beautiful Soup ~Scraping the triple odds table on the official website for boat racing~</h1>
<p>
  <small class="text-secondary">
  
  
  May 12, 2020
  </small>
  

<small><code><a href="https://japan2018.github.io/tags/python">Python</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/scraping"> Scraping</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/beginners"> Beginners</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/python3"> Python3</a></code></small>


<small><code><a href="https://japan2018.github.io/tags/beautifulsoup"> BeautifulSoup</a></code></small>

</p>
<pre><code># Purpose
</code></pre>
<p>Data collection is a pain.
I thought that I would like to analyze boat racing in the future, so as a practice of data collection <a href="https://www.boatrace.jp/owpc/pc/race/odds3t?rno=12&amp;jcd=02&amp;hd=20200511">Odds table of official boat racing site</a>.</p>
<h1 id="overview">Overview</h1>
<ul>
<li>I can only think of a convenient language = python for scraping, so I use python3.7.</li>
<li>Python 3.7 is called beatutiful soup ~~ It seems a little erotic ~~ It seems that the library with the name is convenient for scraping</li>
<li>By using the beautifulsoup css selector, you can specify the location of the table without deciphering the html one by one!</li>
<li>Copy the CSS selector using the verification tool installed in the browser (easy)</li>
<li>Because it is a practical beautifulsoup, I will not explain the method in detail (There are many other good articles!)</li>
<li>Do your best, pull out the information of the triple table, and store it in a dictionary this time</li>
</ul>
<h3 id="what-you-want-to-scrape-and-output-method">What you want to scrape and output method</h3>
<img width=500 alt="file name" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/407322/346f390d-d2cd-8e18-bcde-05619206cacf.png">
â†‘ This is a triple table!
If you like gambling, you should have seen it!
From this figure, I want to get the value and make it a python dictionary type and call it as follows!
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;sample1:&#39;</span>, three_rentan_odds_dict[<span style="color:#e6db74">&#39;1&#39;</span>][<span style="color:#e6db74">&#39;2&#39;</span>][<span style="color:#e6db74">&#39;3&#39;</span>])
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;sample2:&#39;</span>, three_rentan_odds_dict[<span style="color:#e6db74">&#39;6&#39;</span>][<span style="color:#e6db74">&#39;5&#39;</span>][<span style="color:#e6db74">&#39;4&#39;</span>])

<span style="color:#75715e"># output:</span>
<span style="color:#75715e"># sample1: 47.2</span>
<span style="color:#75715e"># sample2: 285.7</span>
</code></pre></div><p>Of course you can use a list type, but the dictionary type is faster to access and the order in the array is irrelevant, so don&rsquo;t plunge here too much!</p>
<h1 id="advance-preparation">Advance preparation</h1>
<p>I use python 3.7 for development, but I think I can do any 3 system!
It might be easier to copy and paste with jupyter!</p>
<h3 id="package-to-install">Package to install</h3>
<ul>
<li>request</li>
<li>beautifulsoup4</li>
<li>numpy</li>
</ul>
<p>Enter with pip</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">For <span style="color:#75715e">#pip</span>
pip install request, beautifulsoup4, numpy

For <span style="color:#75715e">#pipenv</span>
pipenv install request beautifulsoup4 numpy
</code></pre></div><p>#Do not do anything at all</p>
<h3 id="acts-that-put-a-load-on-the-other-server">Acts that put a load on the other server</h3>
<p>Please do not put a load on the other server <strong>with or without intention</strong>. There are also cases of arrest.
Specifically, it is okay to copy and paste the source code introduced here as it is and execute it only once, but if you try to scrape all schedule information using <strong>for statement, the server will be overloaded. Doing so may cause troubles</strong>, so please do not stop.
Scraping itself for data analysis is not illegal.
For more information <a href="https://services.sms-datatech.co.jp/pig-data/2019/07/03/scrapinglaw/">here</a></p>
<h1 id="implementation">Implementation</h1>
<h3 id="specify-html-and-import-html">Specify HTML and import HTML</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> urllib.request <span style="color:#f92672">import</span> urlopen
<span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
<span style="color:#75715e"># Use the triple odds table of the 12th race of Toda Boat Race Track on May 11, 2020 as an example</span>
target_url <span style="color:#f92672">=</span> \
    <span style="color:#e6db74">&#39;https://www.boatrace.jp/owpc/pc/race/odds3t?rno=12&amp;jcd=02&amp;hd=20200511&#39;</span>
<span style="color:#75715e"># load html</span>
html_content <span style="color:#f92672">=</span> urlopen(target_url)<span style="color:#f92672">.</span>read()
<span style="color:#66d9ef">print</span>(type(html_content))

<span style="color:#75715e"># output</span>
<span style="color:#75715e"># &lt;class&#39;bytes&#39;&gt;</span>
</code></pre></div><h3 id="load-with-beautifulsoup-for-scraping">load with beautifulsoup for scraping</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
soup <span style="color:#f92672">=</span> BeautifulSoup(html_content,<span style="color:#e6db74">&#39;html.parser&#39;</span>)
<span style="color:#66d9ef">print</span>(type(soup))

<span style="color:#75715e"># output</span>
<span style="color:#75715e"># &lt;class&#39;bs4.BeautifulSoup&#39;&gt;</span>
</code></pre></div><h3 id="use-the-select-method-provided-by-beautifulsoup">Use the <code>select</code> method provided by beautifulsoup.</h3>
<p>With the <code>select</code> method, you can specify the location of the html tag using the specified css selector and perform scraping.
This time, I want to take out the part of the odds table for a triad.
Then, use the verification tool of the browser to get the css selector of the target location.
In particular</p>
<ol>
<li>Move the cursor to the table and right-click to open <strong>verification</strong> (I think F12 is good, but I use tilix at F12, so I use the mouse)
<img height=300 alt="file name" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/407322/500caa90-74d3-c1e7-8b77-a18a4ec5c560.png"></li>
<li>If you move the mouse over the html of the verification tool, the relevant part of the html description will be knitted on the page, so find where the table part is selected. <img height=300 alt="file name" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/407322/8bc3ec34-0cb2-621c-47de-f98306af8be7.png"></li>
<li>Right click at this timing and select Copy -&gt; Copy Selector <img height=300 alt="file name" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/407322/890086be-26b0-8e27-b548-082f46a6ece3.png"></li>
<li>Prepare the variable <code>target_table_selector</code> and paste it.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Paste the copied css selector</span>
target_table_selector <span style="color:#f92672">=</span> \
    <span style="color:#e6db74">&#39;body &gt;main &gt;div &gt;div &gt;div &gt;&#39;</span>\
    <span style="color:#e6db74">&#39;div.contentsFrame1_inner&gt; div:nth-child(6)&gt; table&#39;</span>

<span style="color:#75715e"># Retrieve html specified by select_one method</span>
odds_table <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>select_one(target_table_selector)
<span style="color:#66d9ef">print</span>(type(odds_table))

<span style="color:#75715e"># output:</span>
<span style="color:#75715e"># &lt;class&#39;bs4.element.Tag&#39;&gt;</span>
When you execute <span style="color:#75715e"># print(odds_table), html of only the specified table part is displayed</span>
</code></pre></div><h3 id="extract-elements-of-odds-table">Extract elements of odds table</h3>
<p>Looking at the browser validation tool I looked at earlier, in order to extract elements, only the <code>'tbody'</code> part in <code>odds_table</code> is required, so specify it with <code>select_one</code>.
Then, to store each line as a list, use <code>select</code> to specify the <code>'tr'</code> part and make it a list.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#tbody specification</span>
odds_table_elements <span style="color:#f92672">=</span> odds_table<span style="color:#f92672">.</span>select_one(<span style="color:#e6db74">&#39;tbody&#39;</span>)

specify <span style="color:#75715e"># tr and store as a list</span>
row_list <span style="color:#f92672">=</span> odds_table_elements<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#39;tr&#39;</span>)
<span style="color:#66d9ef">print</span>(len(row_list))

<span style="color:#75715e"># output:</span>
<span style="color:#75715e">#20: Match the number of rows in the table</span>
</code></pre></div><p>Next, looking at the tag that stores the value of the odds that is an element, you can see that it is a class called <code>oddsPoint</code> in the td tag.
<img height=300 alt="file name" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/407322/96fac91f-62ee-32c8-1d75-e3126b12174b.png">
To extract this for each line, create a function first.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#Processing for each line</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">getoddsPoint2floatlist</span>(odds_tr):
    <span style="color:#75715e">#Get list of html where odds value is stored</span>
    html_list <span style="color:#f92672">=</span> odds_tr<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#39;td.oddsPoint&#39;</span>)
    <span style="color:#66d9ef">print</span>(html_list[<span style="color:#ae81ff">0</span>])
    <span style="color:#75715e"># example output:</span>
    <span style="color:#75715e"># &lt;td class=&#34;oddsPoint&#34;&gt;47.2&lt;/td&gt;</span>
    Only the elements enclosed by tags can be extracted by using <span style="color:#75715e">#text</span>
    text_list <span style="color:#f92672">=</span> list(map(<span style="color:#66d9ef">lambda</span> x: x<span style="color:#f92672">.</span>text, html_list))
    <span style="color:#75715e"># print(text_list)</span>
    <span style="color:#75715e"># example output:</span>
    <span style="color:#75715e"># [&#39;47.2&#39;, &#39;60.3&#39;, &#39;588.7&#39;, &#39;52.8&#39;, &#39;66.0&#39;, &#39;248.7&#39;]</span>
    <span style="color:#75715e">#Odds is a decimal value, so cast to a float type</span>
    float_list <span style="color:#f92672">=</span> list(map(
        <span style="color:#66d9ef">lambda</span> x: float(x), text_list))
    <span style="color:#66d9ef">return</span> float_list
</code></pre></div><p>Generate a matrix by extracting only the elements of the entire table using the map function</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">odds_matrix <span style="color:#f92672">=</span> list(map(
    <span style="color:#66d9ef">lambda</span> x: getoddsPoint2floatlist(x),
    row_list
))

<span style="color:#66d9ef">print</span>(odds_matrix)

<span style="color:#75715e"># output</span>
<span style="color:#75715e"># [[47.2, 60.3, 588.7, 52.8, 66.0, 248.7],</span>
<span style="color:#75715e"># [14.7, 13.3, 994.9, 361.6, 363.8, 1276.0],</span>
<span style="color:#75715e"># [12.0, 11.1, 747.7, 67.1, 137.8, 503.6],</span>
<span style="color:#75715e"># [26.7, 26.6, 1155.0, 96.5, 123.7, 414.5],</span>
<span style="color:#75715e"># [157.0, 188.8, 566.8, 50.4, 64.3, 241.5],</span>
<span style="color:#75715e"># [242.2, 215.7, 660.5, 261.5, 314.5, 1037.0],</span>
<span style="color:#75715e"># [237.5, 190.8, 561.6, 36.4, 66.8, 183.4],</span>
<span style="color:#75715e"># [403.5, 281.1, 926.8, 49.2, 73.1, 183.6],</span>
<span style="color:#75715e"># [35.0, 25.4, 1276.0, 750.0, 930.3, 2462.0],# [219.2, 152.2, 959.6, 517.5, 799.1, 1950.0],</span>
<span style="color:#75715e"># [59.6, 23.6, 963.4, 650.0, 1139.0, 1779.0],</span>
<span style="color:#75715e"># [89.4, 38.4, 1433.0, 639.7, 1237.0, 2321.0],</span>
<span style="color:#75715e"># [34.6, 23.8, 1019.0, 63.9, 119.7, 387.5],</span>
<span style="color:#75715e"># [212.5, 143.8, 752.3, 36.9, 64.1, 174.3],</span>
<span style="color:#75715e"># [76.3, 30.5, 1231.0, 270.8, 452.2, 952.1],</span>
<span style="color:#75715e"># [79.6, 35.8, 1614.0, 44.9, 84.1, 244.4],</span>
<span style="color:#75715e"># [83.7, 90.6, 2031.0, 110.1, 171.1, 391.8],</span>
<span style="color:#75715e"># [356.3, 308.5, 1552.0, 63.2, 103.9, 201.7],</span>
<span style="color:#75715e"># [159.7, 77.7, 1408.0, 326.7, 560.3, 1346.0],</span>
<span style="color:#75715e"># [136.0, 69.0, 1562.0, 71.4, 148.1, 285.7]]</span>
</code></pre></div><p>** This completes scraping! ! **</p>
<h3 id="bonus-store-in-dictionary">Bonus: Store in dictionary</h3>
<p>Since this is not an essential part of scraping, detailed explanation is omitted.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#75715e">#numpy array</span>
odds_matrix <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(odds_matrix)
<span style="color:#75715e"># Take a transpose and connect them into a list</span>
odds_list <span style="color:#f92672">=</span> list(odds_matrix<span style="color:#f92672">.</span>T<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))

<span style="color:#75715e"># Store in dictionary</span>
three_rentan_odds_dict <span style="color:#f92672">=</span> {}
<span style="color:#66d9ef">for</span> fst <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">7</span>):
    <span style="color:#66d9ef">if</span> fst <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> three_rentan_odds_dict<span style="color:#f92672">.</span>keys():
        three_rentan_odds_dict[str(fst)] <span style="color:#f92672">=</span> {}
    <span style="color:#66d9ef">for</span> snd <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">7</span>):
        <span style="color:#66d9ef">if</span> snd <span style="color:#f92672">!=</span> fst:
            <span style="color:#66d9ef">if</span> snd <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> three_rentan_odds_dict[str(fst)]<span style="color:#f92672">.</span>keys():
                three_rentan_odds_dict[str(fst)][str(snd)] <span style="color:#f92672">=</span> {}
            <span style="color:#66d9ef">for</span> trd <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">7</span>):
                <span style="color:#66d9ef">if</span> trd <span style="color:#f92672">!=</span> fst <span style="color:#f92672">and</span> trd <span style="color:#f92672">!=</span> snd:
                    three_rentan_odds_dict[str(fst)][str(snd)][str(trd)] <span style="color:#f92672">=</span> \
                        odds_list<span style="color:#f92672">.</span>pop(<span style="color:#ae81ff">0</span>)

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;sample1:&#39;</span>, three_rentan_odds_dict[<span style="color:#e6db74">&#39;1&#39;</span>][<span style="color:#e6db74">&#39;2&#39;</span>][<span style="color:#e6db74">&#39;3&#39;</span>])
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;sample2:&#39;</span>, three_rentan_odds_dict[<span style="color:#e6db74">&#39;6&#39;</span>][<span style="color:#e6db74">&#39;5&#39;</span>][<span style="color:#e6db74">&#39;4&#39;</span>])

<span style="color:#75715e"># output:</span>
<span style="color:#75715e"># sample1: 47.2</span>
<span style="color:#75715e"># sample2: 285.7</span>

</code></pre></div><h3 id="complete">complete</h3>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
