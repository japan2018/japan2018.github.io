<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] Prediction of horse racing: If I thought that the collection rate exceeded 100% in machine learning (Light GBM), I did it | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] Prediction of horse racing: If I thought that the collection rate exceeded 100% in machine learning (Light GBM), I did it</h1>
<p>
  <small class="text-secondary">
  
  
  May 26, 2020
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/machine-learning"> machine learning</a></code></small>


<small><code><a href="https://memotut.com/tags/data-analysis"> data analysis</a></code></small>


<small><code><a href="https://memotut.com/tags/horse-racing"> horse racing</a></code></small>

</p>
<pre><code>#Thank you
</code></pre>
<h3 id="note">Note!!!</h3>
<p><strong>This article is completely disguised</strong></p>
<p>I&rsquo;m sorry for the person who stocked it.</p>
<p>Thanks to @hal27 for pointing it out, thank you.</p>
<p>・What I did
I made a fatal mistake from the scraping stage.
I was going to get the data for the previous 3 races from the time of the race, but in fact I was getting the information for the latest 3 races from the scraping execution time.</p>
<p>However, when I predicted without using the information of the previous race, the average recovery rate was about 90%, so
Even if we use the correct data, I think we can exceed 100%.</p>
<p><strong>Try again!</strong></p>
<p>Please take a look while thinking that this article has been done. (Pay particular attention to the scraping part of the previous run information)</p>
<p>#Introduction
Recently I&rsquo;ve been into data analysis.</p>
<p>When I&rsquo;m running Kaggle, a data analysis competition, what I often think about is &ldquo;Sales forecast? Is there a more interesting theme?**&rdquo;.</p>
<p>That&rsquo;s why I decided to make a horse racing prediction model from scratch for studying. If you go well, you can make money and it is the best analysis theme for me who loves horse racing.</p>
<p>Although I am almost a beginner, as a result, I was able to create a model with a stable collection rate of more than 100% **, so in this article, I will describe the rough flow of creating a horse racing model and details of simulation I will do it. If there is something wrong with your thinking, please give us guidance.</p>
<h1 id="condition-setting">Condition setting</h1>
<p>**Estimate the running time of the running horse and win the horse with the fastest time. **</p>
<p>On the streets, there were many models that cited the hit rate of one horse, but I think that there were many cases where the recovery rate did not grow as expected. If that&rsquo;s the case, then it might be a good idea to predict the time purely before betting. I thought ** (argument) ** and set it to this setting.</p>
<p>Actually, there were other reasons&hellip;..</p>
<p>In horse racing, it is said that more people bet on popular horses than their abilities. (Reference: <a href="https://ameblo.jp/xmjqm156/entry-11099913303.html">Theory that cannot be won by using popular horses as the axis</a>)
In other words, it may be possible to raise the recovery rate by looking at the odds and forecasting rather than pursuing the one-to-one ratio.
However, I want to buy a betting ticket with plenty of time, so I do not want to incorporate the odds that are fixed just before the race into the features.</p>
<p>What should I do&hellip;</p>
<p>There are various factors involved in horse racing, so it is difficult to predict the running time purely. Isn&rsquo;t it difficult to predict horses with high expected values that people would not bet on? ** (Ranging) **. Okay, let&rsquo;s go in running time.</p>
<h3 id="learning-and-simulation-targets"><strong>Learning and simulation targets</strong></h3>
<p>Since I live in Kyoto, I targeted <strong>Kyoto horse racing only</strong>. The data will be for almost all races from 2009 to 2019 (described in the data preprocessing section).
We divided them into learning data and test data, and performed a simulation on the test data. It is a total of 7 years of simulation.</p>
<p>The following is the contents of data division.</p>
<table>
<thead>
<tr>
<th align="center">Learning data</th>
<th align="center">Testing data</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">2009~2018</td>
<td align="center">2019</td>
</tr>
<tr>
<td align="center">2009~2017</td>
<td align="center">2018</td>
</tr>
<tr>
<td align="center">2009~2016</td>
<td align="center">2017</td>
</tr>
<tr>
<td align="center">2009~2015</td>
<td align="center">2016</td>
</tr>
<tr>
<td align="center">2009~2014</td>
<td align="center">2015</td>
</tr>
<tr>
<td align="center">2009~2013</td>
<td align="center">2014</td>
</tr>
<tr>
<td align="center">2009~2012</td>
<td align="center">2013</td>
</tr>
</tbody>
</table>
<p>In the unlikely event of a leak, the learning data is set in a year before the test data.</p>
<p>Details of the features handled are explained below.</p>
<p>#Flow to model creation</p>
<ol>
<li>Data acquisition (web scraping)</li>
<li>Data pre-processing</li>
<li>Model creation</li>
</ol>
<h1 id="1-acquisition-of-data">1. Acquisition of data</h1>
<p>It seems that you can easily get the data if you pay the money, but I also acquired the data by web scraping for the purpose of studying.</p>
<p>First, you can easily study HTML/CSS with <a href="https://prog-8.com/dashboard">Progate</a>. Because I couldn&rsquo;t know where to find the data I needed without knowledge.</p>
<p>Regarding web scraping, I created it by referring to the following articles. To be honest, I think this was the hardest part. (Too many exceptions!)</p>
<ul>
<li>[The story of applying the Emperor&rsquo;s emblem by machine learning at Oi Horse Racing](
(<a href="https://qiita.com/ishizakiiii/items/3b894b6e987fdf87093e">https://qiita.com/ishizakiiii/items/3b894b6e987fdf87093e</a>)</li>
<li><a href="https://qiita.com/penguinz222/items/6a30d026ede2e822e245">python3 crawling &amp; scraping</a></li>
</ul>
<p>The site to be scraped is <a href="https://www.netkeiba.com/">https://www.netkeiba.com/</a>.</p>
<p>Below is the actual scraping data. The code is in <a href="#Appendix">Appendix</a>.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/3aa2526c-1465-ca7c-d9b8-70f127741b53.png" alt="image.png">
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/db1eecb6-8d76-eab9-d027-ebc7b053e1a4.png" alt="image.png"></p>
<p>The acquired data is as follows</p>
<table>
<thead>
<tr>
<th align="center">feature</th>
<th align="center">Description</th>
<th align="center">feature</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">race_num</td>
<td align="center">what race</td>
<td align="center">field</td>
<td align="center">turf or dirt</td>
</tr>
<tr>
<td align="center">dist</td>
<td align="center">distance</td>
<td align="center">l_or_r</td>
<td align="center">clockwise or counterclockwise</td>
</tr>
<tr>
<td align="center">sum_num</td>
<td align="center">head</td>
<td align="center">weather</td>
<td align="center">weather</td>
</tr>
<tr>
<td align="center">field_cond</td>
<td align="center">Baba condition</td>
<td align="center">rank</td>
<td align="center">Order of arrival</td>
</tr>
<tr>
<td align="center">horse_num</td>
<td align="center">horse number</td>
<td align="center">horse_name</td>
<td align="center">horse name</td>
</tr>
<tr>
<td align="center">gender</td>
<td align="center">gender</td>
<td align="center">age</td>
<td align="center">age</td>
</tr>
<tr>
<td align="center">weight</td>
<td align="center">horse weight</td>
<td align="center">weight_c</td>
<td align="center">jockey weight</td>
</tr>
<tr>
<td align="center">time</td>
<td align="center">Running time</td>
<td align="center">sum_score</td>
<td align="center">Total results</td>
</tr>
<tr>
<td align="center">odds</td>
<td align="center">win odds</td>
<td align="center">popu</td>
<td align="center">popular</td>
</tr>
</tbody>
</table>
<p>The data for the previous three races is obtained with **+. **</p>
<p>Of these, **Run time, finish order, odds, popularity, horse name features are not used as learning data. **</p>
<p>In addition, **Information is deleted for horses that do not have three races in the previous race. **However, if there is information on even one horse in each race, we will predict the earliest horse among them. Of course, if there is a first horse in the erased data, the prediction will be disappointing.</p>
<p>About 450 races worth of data remain per year. (Almost all races)</p>
<h1 id="2-data-pre-processing">2. Data pre-processing</h1>
<p>Transform the resulting data into a machine learning model. That said, we just changed the categorical variable to <strong>label encoding</strong> or changed the character type to a numeric type**.</p>
<p>Since it is a kind of algorithm tree model of the model handled this time, we have not standardized it.</p>
<p>In addition, we are making some new features using the acquired features. ** (distance and time to speed etc.)</p>
<h1 id="3-model-creation">3. Model creation</h1>
<p>Implemented using the <strong>LightGBM</strong> library of the <strong>gradient boosting decision tree algorithm</strong>. Kaggle is one of the most popular ones these days.</p>
<p>Below is the implementation code.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">lgb_train <span style="color:#f92672">=</span> lgb<span style="color:#f92672">.</span>Dataset(X_train, y_train)
lgb_eval <span style="color:#f92672">=</span> lgb<span style="color:#f92672">.</span>Dataset(X_valid, y_valid, reference<span style="color:#f92672">=</span>lgb_train)

params <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;objective&#39;</span>:<span style="color:#e6db74">&#39;regression&#39;</span>,
          <span style="color:#e6db74">&#39;metric&#39;</span>:<span style="color:#e6db74">&#39;rmse&#39;</span>,
          }

model <span style="color:#f92672">=</span> lgb<span style="color:#f92672">.</span>train(
    params, lgb_train,
    valid_sets<span style="color:#f92672">=</span>[lgb_train, lgb_eval],
    verbose_eval<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>,
    num_boost_round<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>,
    early_stopping_rounds<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
</code></pre></div><p>As you can see, we haven&rsquo;t made any efforts (laughs).</p>
<p>I tried to tune the parameters using Optuna etc., but it didn&rsquo;t lead to the improvement of the recovery rate because the evaluation function and recovery rate were different.</p>
<h1 id="simulation">simulation</h1>
<p>The following is the simulation result for 7 years</p>
<p>** Horizontal axis **: How many races
<strong>Vertical axis</strong>: Win odds when hit (0 if missed)
<strong>hit_rate</strong>: Hit rate
<strong>back_rate</strong>: Recovery rate
The title train and test represent the period of data used for each. (09 is 2009)</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/1381ed90-cad1-5535-3d2f-f57008801458.jpeg" alt="09-10-11-12,13.jpg">
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/4136fbe3-cbf7-43e5-3672-7ac28dca81c7.jpeg" alt="09-10-11-12-13,14.jpg">
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/3459ade9-15f8-91fa-5068-7ccee7331ac6.jpeg" alt="09-10-11-12-13-14,15.jpg">
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/113188c4-ce51-b5e5-17d8-056d286dd21b.jpeg" alt="09-10-11-12-13-14-15,16.jpg">
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/457ad568-9ca9-241d-8ce0-8791b78ebc5f.jpeg" alt="09-10-11-12-13-14-15-16,17.jpg">
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/0103ff75-6bdf-91a1-abbb-2e2f827b36e2.jpeg" alt="09-10-11-12-13-14-15-16-17,18.jpg">
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/27e7cb5d-25c8-16a3-9df6-859885abf1aa.jpeg" alt="09-10-11-12-13-14-15-16-17-18,19.jpg"></p>
<p>The results are summarized below</p>
<table>
<thead>
<tr>
<th align="center">Simulation year</th>
<th align="center">Hit frequency</th>
<th align="center">Hit rate</th>
<th align="center">Recovery rate</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">2013</td>
<td align="center">116/460</td>
<td align="center">25.2%</td>
<td align="center">171.9%</td>
</tr>
<tr>
<td align="center">2014</td>
<td align="center">89/489</td>
<td align="center"><strong>18.5%</strong></td>
<td align="center">155.3%</td>
</tr>
<tr>
<td align="center">2015</td>
<td align="center">120/489</td>
<td align="center">24.5%</td>
<td align="center"><strong>154.7%</strong></td>
</tr>
<tr>
<td align="center">2016</td>
<td align="center">101/491</td>
<td align="center">20.6%</td>
<td align="center">163.6%</td>
</tr>
<tr>
<td align="center">2017</td>
<td align="center">131/472</td>
<td align="center">27.8%</td>
<td align="center"><strong>263.5%</strong></td>
</tr>
<tr>
<td align="center">2019</td>
<td align="center">136/459</td>
<td align="center">29.6%</td>
<td align="center">161.7%</td>
</tr>
<tr>
<td align="center"><strong>Average</strong></td>
<td align="center">&mdash;&mdash;</td>
<td align="center"><strong>25.5%</strong></td>
<td align="center"><strong>180.4%</strong></td>
</tr>
</tbody>
</table>
<p>It&rsquo;s too good.</p>
<p>The hit rate is pretty good, but what surprised me was that I was hitting horses with high odds.</p>
<p>**In 2017, we hit 250 times more horses! **</p>
<p>I&rsquo;m curious, so let&rsquo;s look at the contents
The following is the content of the race of the day. (Sort in order of time_pred)</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/ca6e94c2-582c-dcb3-a582-331ba4655df9.png" alt="image.png"></p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/327bca56-b82f-389c-4e97-aebc9e36e2cb.png" alt="image.png"></p>
<p>I really hit it.</p>
<p>I&rsquo;ve become afraid that I&rsquo;m doing something wrong. Is it all right to exceed 100% in the first place?</p>
<p>What should I look for in such a case?&hellip;.</p>
<p>**I have to try it in real life! **</p>
<p>The following is what I searched for.
・** Are you using only the features that can be used on the day**
・** Is the calculation formula of the recovery rate correct?**
・** Is there any discrepancy with the information on the Internet? **
・** Can you select the person with the earliest expected time **
*Play with the created model from various directions**
――</p>
<h2 id="i-tried-playing-with-the-model">I tried playing with the model</h2>
<p>Since it&rsquo;s just a matter of fact, I will try various verifications.</p>
<h4 id="1-try-the-horse-you-predicted-to-be-the-slowest">1 Try the horse you predicted to be the slowest</h4>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/6059949e-bde6-d321-7dcf-0d4fbd423c83.png" alt="aaa.png"></p>
<p>I only hit it 6 times.</p>
<h4 id="2-importance-of-features">2 Importance of features</h4>
<p>The following is lightGBM&rsquo;s feature-importannces (2019).
<code>a</code>,<code>b</code>,<code>c</code> are the horse speed (dist/time) of the previous run, the previous run, and the previous run.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/2de0c470-0fd3-e877-498f-33a6e61b737a.png" alt="aaa.png"></p>
<p>I know that <code>dist (race distance)</code> is important because I predict the time, but why is <code>race_id (what race number of the year)</code> is important?</p>
<p>Is the season important for predicting time?</p>
<p>In addition, the environment occupies a great importance, such as <code>race_cond (baba condition)</code> and <code>race_num (what race of the day)</code>.</p>
<p><strong>※ I wrote <a href="#Addition">Addition</a>.(2020/05/28)</strong></p>
<h4 id="3-what-happens-if-you-continue-to-be-popular">3 What happens if you continue to be popular?</h4>
<p>It has nothing to do with the created model (laugh)</p>
<p>The following are the results of <strong>2019</strong></p>
<table>
<thead>
<tr>
<th align="center">nth popularity</th>
<th align="center">hit rate</th>
<th align="center">recovery rate</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">Most Popular</td>
<td align="center">30.9%</td>
<td align="center">71.1%</td>
</tr>
<tr>
<td align="center">2nd most popular</td>
<td align="center">17.3%</td>
<td align="center">77.2%</td>
</tr>
<tr>
<td align="center">Third most popular</td>
<td align="center">15.3%</td>
<td align="center">90.3%</td>
</tr>
<tr>
<td align="center">#4 Popularity</td>
<td align="center">10.1%</td>
<td align="center">81.3%</td>
</tr>
<tr>
<td align="center">5th popular</td>
<td align="center">8.4%</td>
<td align="center">100.5%</td>
</tr>
<tr>
<td align="center">6th popular</td>
<td align="center">6.2%</td>
<td align="center">92.4%</td>
</tr>
<tr>
<td align="center">#7 most popular</td>
<td align="center">3.2%</td>
<td align="center">64.2%</td>
</tr>
<tr>
<td align="center">8th popular</td>
<td align="center">2.4%</td>
<td align="center">52.1%</td>
</tr>
<tr>
<td align="center">9th popular</td>
<td align="center">1.5%</td>
<td align="center">48.2%</td>
</tr>
<tr>
<td align="center">10th popular</td>
<td align="center">1.3%</td>
<td align="center">59.1%</td>
</tr>
<tr>
<td align="center">11th popular</td>
<td align="center">1.5%</td>
<td align="center">127.6%</td>
</tr>
<tr>
<td align="center">12th popular</td>
<td align="center">1.3%</td>
<td align="center">113.9%</td>
</tr>
<tr>
<td align="center">13th popular</td>
<td align="center">1.5%</td>
<td align="center">138.6%</td>
</tr>
<tr>
<td align="center">14th popularity</td>
<td align="center">0.4%</td>
<td align="center">77.8%</td>
</tr>
</tbody>
</table>
<p>Very interesting result
If you are aiming for recovery, you may continue to buy unpopular horses.
Since it hardly hits, it seems to be fun to watch (laugh)</p>
<p>It&rsquo;s interesting, so I looked at the <strong>2013 to 2019 average</strong>.</p>
<table>
<thead>
<tr>
<th align="center">nth popularity</th>
<th align="center">hit rate</th>
<th align="center">recovery rate</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">Most Popular</td>
<td align="center">31.7%</td>
<td align="center">73.4%</td>
</tr>
<tr>
<td align="center">2nd most popular</td>
<td align="center">20.0%</td>
<td align="center">83.7%</td>
</tr>
<tr>
<td align="center">#3 most popular</td>
<td align="center">13.2%</td>
<td align="center">80.2%</td>
</tr>
<tr>
<td align="center">#4 Popularity</td>
<td align="center">9.9%</td>
<td align="center">81.9%</td>
</tr>
<tr>
<td align="center">#5 most popular</td>
<td align="center">7.8%</td>
<td align="center">89.1%</td>
</tr>
<tr>
<td align="center">#6 Popularity</td>
<td align="center">5.5%</td>
<td align="center">89.8%</td>
</tr>
<tr>
<td align="center">7th popular</td>
<td align="center">4.2%</td>
<td align="center">86.0%</td>
</tr>
<tr>
<td align="center">8th popular</td>
<td align="center">2.4%</td>
<td align="center">64.8%</td>
</tr>
<tr>
<td align="center">9th popular</td>
<td align="center">2.1%</td>
<td align="center">64.8%</td>
</tr>
<tr>
<td align="center">10th popular</td>
<td align="center">1.7%</td>
<td align="center">80.9%</td>
</tr>
<tr>
<td align="center">11th popular</td>
<td align="center">1.1%</td>
<td align="center">98.2%</td>
</tr>
<tr>
<td align="center">12th popular</td>
<td align="center">1.0%</td>
<td align="center">69.4%</td>
</tr>
<tr>
<td align="center">13th popular</td>
<td align="center">1.1%</td>
<td align="center">113.2%</td>
</tr>
<tr>
<td align="center">14th popular</td>
<td align="center">0.2%</td>
<td align="center">35.4%</td>
</tr>
<tr>
<td align="center">*Note that the verification was performed only on the data that could be acquired</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>interesting</p>
<p>#Summary</p>
<p>Recovery rate can exceed 100% with almost no ingenuity
light GBM is amazing</p>
<h1 id="appendix">Appendix</h1>
<p>Please understand that this is a dirty code.</p>
<p>・<strong>Scraping (Get race information and URL of each horse)</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">url_to_soup</span>(url):
    
    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
        
    html <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
    html<span style="color:#f92672">.</span>encoding <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;EUC-JP&#39;</span>
    <span style="color:#66d9ef">return</span> BeautifulSoup(html<span style="color:#f92672">.</span>text,<span style="color:#e6db74">&#39;html.parser&#39;</span>)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">race_info_df</span>(url):
    
    df1 <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
    HorseLink <span style="color:#f92672">=</span> []
    
    <span style="color:#66d9ef">try</span>:
        <span style="color:#75715e"># year = &#39;2018&#39;</span>
        <span style="color:#75715e"># url =&#39;https://race.sp.netkeiba.com/?pid=race_result&amp;race_id=201108030409&amp;rf=rs&#39;</span>
        soup <span style="color:#f92672">=</span> url_to_soup(url)
        
        <span style="color:#66d9ef">if</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;li&#39;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;NoData&#39;</span>) <span style="color:#f92672">!=</span> []:
            <span style="color:#66d9ef">return</span> df1,HorseLink
            
        <span style="color:#66d9ef">else</span>:
            
            race_cols <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;year&#39;</span>,<span style="color:#e6db74">&#39;date&#39;</span>,<span style="color:#e6db74">&#39;place&#39;</span>,<span style="color:#e6db74">&#39;race_num&#39;</span> ,<span style="color:#e6db74">&#39;race_class&#39;</span>,<span style="color:#e6db74">&#39;field&#39;</span>,<span style="color:#e6db74">&#39;dist&#39;</span>,<span style="color:#e6db74">&#39;l_or_r&#39;</span>,\
                        <span style="color:#e6db74">&#39;sum_num&#39;</span>,<span style="color:#e6db74">&#39;weather&#39;</span>,<span style="color:#e6db74">&#39;field_cond&#39;</span>,<span style="color:#e6db74">&#39;rank&#39;</span>,<span style="color:#e6db74">&#39;horse_num&#39;</span>,<span style="color:#e6db74">&#39;horse_name&#39;</span>,<span style="color:#e6db74">&#39;gender&#39;</span>,<span style="color:#e6db74">&#39;age&#39;</span>,\
                        <span style="color:#e6db74">&#39;weight&#39;</span>,<span style="color:#e6db74">&#39;weight_c&#39;</span>,<span style="color:#e6db74">&#39;time&#39;</span>,<span style="color:#e6db74">&#39;jackie&#39;</span>,<span style="color:#e6db74">&#39;j_weght&#39;</span>,<span style="color:#e6db74">&#39;odds&#39;</span>,<span style="color:#e6db74">&#39;popu&#39;</span>]
            
            <span style="color:#75715e"># Common Items #</span>
            <span style="color:#75715e"># Year = year</span>
            Date <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;div&#39;</span>, class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Change_Btn Day&#39;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">0</span>]
            Place <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;div&#39;</span>, class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Change_Btn Course&#34;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">0</span>]

            RaceClass <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;div&#39;</span>, class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;RaceDetail fc&#34;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">0</span>][<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>:]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;,&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)

            RaceNum <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;span&#39;</span>, id<span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">&#34;kaisaiDate&#34;</span>))<span style="color:#f92672">.</span>text
            RaceData <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;dd&#39;</span>, class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Race_Data&#34;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>contents
            Field <span style="color:#f92672">=</span> RaceData[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>text[<span style="color:#ae81ff">0</span>]
            Dist <span style="color:#f92672">=</span> RaceData[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>text[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">5</span>]

            l_index <span style="color:#f92672">=</span> RaceData[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;(&#39;</span>)
            r_index <span style="color:#f92672">=</span> RaceData[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;)&#39;</span>)
            LOrR <span style="color:#f92672">=</span> RaceData[<span style="color:#ae81ff">3</span>][l_index<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:r_index]

            RD <span style="color:#f92672">=</span> RaceData[<span style="color:#ae81ff">3</span>][r_index<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:]
            SumNum <span style="color:#f92672">=</span> RD<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">0</span>]
            Weather <span style="color:#f92672">=</span> RD<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">1</span>]
            FieldCond <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;span&#39;</span>,class_<span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">&#34;Item&#34;</span>))[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>text

            <span style="color:#75715e"># Not common #</span>
            HorseLink <span style="color:#f92672">=</span> []
            <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> range(int(SumNum[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])):
                HN <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;dt&#39;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Horse_Name&#39;</span>)[m]<span style="color:#f92672">.</span>contents[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>text
                HL <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;dt&#39;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Horse_Name&#39;</span>)[m]<span style="color:#f92672">.</span>contents[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;href&#39;</span>)
                HorseLink<span style="color:#f92672">.</span>append(HL <span style="color:#66d9ef">if</span> HN<span style="color:#f92672">!=</span><span style="color:#e6db74">&#39;&#39;</span> <span style="color:#66d9ef">else</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;dt&#39;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Horse_Name&#39;</span>)[m]<span style="color:#f92672">.</span>contents[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;href&#39;</span>))

            HorseName <span style="color:#f92672">=</span> []
            <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> range(int(SumNum[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])):
                HN <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;dt&#39;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Horse_Name&#39;</span>)[m]<span style="color:#f92672">.</span>contents[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>text
                HorseName<span style="color:#f92672">.</span>append(HN <span style="color:#66d9ef">if</span> HN<span style="color:#f92672">!=</span><span style="color:#e6db74">&#39;&#39;</span> <span style="color:#66d9ef">else</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;dt&#39;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Horse_Name&#39;</span>)[m]<span style="color:#f92672">.</span>contents[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>text)
            <span style="color:#75715e"># print(soup.find_all(&#39;dt&#39;,class_=&#39;Horse_Name&#39;)[m].contents[3])</span>

            Rank <span style="color:#f92672">=</span> [soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;div&#39;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Rank&#39;</span>)[m]<span style="color:#f92672">.</span>text <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> range(int(SumNum[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))]

            <span style="color:#75715e"># Acquire information obtained from hereHorseNum = [soup.find_all(&#39;td&#39;, class_ = re.compile(&#39;Num Waku&#39;))[m].text.strip() for m in range(1,int(SumNum[:-1])*2+1,2)]</span>

            Detail_Left <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;span&#39;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Detail_Left&#39;</span>)
            Gender <span style="color:#f92672">=</span> [Detail_Left[m]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> range(int(SumNum[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))]
            Age <span style="color:#f92672">=</span>  [Detail_Left[m]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> range(int(SumNum[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))]
            Weight <span style="color:#f92672">=</span> [Detail_Left[m]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">3</span>] <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> range(int(SumNum[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))]
            WeightC <span style="color:#f92672">=</span> [Detail_Left[m]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">3</span>:]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;(&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;)&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>) <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> range(int(SumNum[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))]

            Time <span style="color:#f92672">=</span> [soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;td&#39;</span>, class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Time&#34;</span>)[m]<span style="color:#f92672">.</span>contents[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)[<span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> range(int(SumNum[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))]

            Detail_Right <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;span&#39;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Detail_Right&#39;</span>)
            Jackie <span style="color:#f92672">=</span> [Detail_Right[m]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> range(int(SumNum[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))]
            JWeight <span style="color:#f92672">=</span> [Detail_Right[m]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split()[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;(&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;)&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> range(int(SumNum[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))]
            Odds <span style="color:#f92672">=</span> [soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;td&#39;</span>, class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Odds&#34;</span>)[m]<span style="color:#f92672">.</span>contents[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)[<span style="color:#ae81ff">1</span>][:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> range(int(SumNum[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))]
            Popu <span style="color:#f92672">=</span> [soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;td&#39;</span>, class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Odds&#34;</span>)[m]<span style="color:#f92672">.</span>contents[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)[<span style="color:#ae81ff">2</span>][:<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>] <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> range(int(SumNum[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))]

            Year <span style="color:#f92672">=</span> [year <span style="color:#66d9ef">for</span> a <span style="color:#f92672">in</span> range(int(SumNum[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]))]
            RaceCols <span style="color:#f92672">=</span>  [Year, Date, Place, RaceNum ,RaceClass, Field, Dist, LOrR,\
                      SumNum,Weather, FieldCond, Rank, HorseNum, HorseName, Gender, Age,\
                      Weight, WeightC, Time, Jackie, JWeight, Odds, Popu]
            <span style="color:#66d9ef">for</span> race_col,RaceCol <span style="color:#f92672">in</span> zip(race_cols,RaceCols):
                df1[race_col] <span style="color:#f92672">=</span> RaceCol

            <span style="color:#66d9ef">return</span> df1,HorseLink
        
    <span style="color:#66d9ef">except</span>:
        <span style="color:#66d9ef">return</span> df1,HorseLink
</code></pre></div><p>・<strong>スクレイピング（各馬の今までのレース情報）</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">horse_info_df</span>(HorseLink, df1):
    
    df2 <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
    <span style="color:#75715e"># print(HorseLink)</span>

    <span style="color:#66d9ef">for</span> n,url2 <span style="color:#f92672">in</span> enumerate(HorseLink):

        <span style="color:#66d9ef">try</span>: 
            soup2 <span style="color:#f92672">=</span> url_to_soup(url2)

            horse_cols <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;sum_score&#39;</span>,\
                          <span style="color:#e6db74">&#39;popu_1&#39;</span>,<span style="color:#e6db74">&#39;rank_1&#39;</span>,<span style="color:#e6db74">&#39;odds_1&#39;</span>,<span style="color:#e6db74">&#39;sum_num_1&#39;</span>,<span style="color:#e6db74">&#39;field_1&#39;</span>,<span style="color:#e6db74">&#39;dist_1&#39;</span>,<span style="color:#e6db74">&#39;time_1&#39;</span>,\
                          <span style="color:#e6db74">&#39;popu_2&#39;</span>,<span style="color:#e6db74">&#39;rank_2&#39;</span>,<span style="color:#e6db74">&#39;2&#39;</span>,<span style="color:#e6db74">&#39;sum_num_2&#39;</span>,<span style="color:#e6db74">&#39;field_2&#39;</span>,<span style="color:#e6db74">&#39;dist2&#39;</span>,<span style="color:#e6db74">&#39;time_2&#39;</span>,\
                          <span style="color:#e6db74">&#39;popu_3&#39;</span>,<span style="color:#e6db74">&#39;rank_3&#39;</span>,<span style="color:#e6db74">&#39;odds_3&#39;</span>,<span style="color:#e6db74">&#39;sum_num_3&#39;</span>,<span style="color:#e6db74">&#39;field_3&#39;</span>,<span style="color:#e6db74">&#39;dist_3&#39;</span>,<span style="color:#e6db74">&#39;time_3&#39;</span>]

            sec <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
            ya <span style="color:#f92672">=</span> soup2<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;section&#39;</span>,class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;RaceResults Sire&#34;</span>)
            <span style="color:#75715e">#ya = soup.find_all(&#39;div&#39;,class_=&#34;Title_Sec&#34;)</span>
            <span style="color:#66d9ef">if</span> ya <span style="color:#f92672">!=</span>[]:
                sec <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
            tbody1 <span style="color:#f92672">=</span> soup2<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;tbody&#39;</span>)[sec] 
            SomeScore <span style="color:#f92672">=</span> tbody1<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;td&#39;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>text
            <span style="color:#75715e"># print(SomeScore)</span>

            tbody3 <span style="color:#f92672">=</span> soup2<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;tbody&#39;</span>)[<span style="color:#ae81ff">2</span><span style="color:#f92672">+</span>sec]

            HorseCols <span style="color:#f92672">=</span> [SomeScore]

            <span style="color:#66d9ef">for</span> late <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">4</span>):
                HorseCols<span style="color:#f92672">.</span>append(tbody3<span style="color:#f92672">.</span>contents[late]<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;td&#39;</span>)[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>text)  <span style="color:#75715e"># Popu</span>
                HorseCols<span style="color:#f92672">.</span>append(tbody3<span style="color:#f92672">.</span>contents[late]<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;td&#39;</span>)[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>text)  <span style="color:#75715e"># Rank</span>
                HorseCols<span style="color:#f92672">.</span>append(tbody3<span style="color:#f92672">.</span>contents[late]<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;td&#39;</span>)[<span style="color:#ae81ff">6</span>]<span style="color:#f92672">.</span>text)  <span style="color:#75715e"># Odds</span>
                HorseCols<span style="color:#f92672">.</span>append(tbody3<span style="color:#f92672">.</span>contents[late]<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;td&#39;</span>)[<span style="color:#ae81ff">7</span>]<span style="color:#f92672">.</span>text)  <span style="color:#75715e"># SumNum</span>
                HorseCols<span style="color:#f92672">.</span>append(tbody3<span style="color:#f92672">.</span>contents[late]<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;td&#39;</span>)[<span style="color:#ae81ff">10</span>]<span style="color:#f92672">.</span>text[<span style="color:#ae81ff">0</span>]) <span style="color:#75715e"># Field</span>
                HorseCols<span style="color:#f92672">.</span>append(tbody3<span style="color:#f92672">.</span>contents[late]<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;td&#39;</span>)[<span style="color:#ae81ff">10</span>]<span style="color:#f92672">.</span>text[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">5</span>]) <span style="color:#75715e"># Dist</span>
                HorseCols<span style="color:#f92672">.</span>append(tbody3<span style="color:#f92672">.</span>contents[late]<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;td&#39;</span>)[<span style="color:#ae81ff">14</span>]<span style="color:#f92672">.</span>text) <span style="color:#75715e"># Time</span>


            dfplus <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame([HorseCols], columns<span style="color:#f92672">=</span>horse_cols)
            dfplus[<span style="color:#e6db74">&#39;horse_name&#39;</span>] <span style="color:#f92672">=</span> df1[<span style="color:#e6db74">&#39;horse_name&#39;</span>][n]

            df2 <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([df2,dfplus])
        <span style="color:#66d9ef">except</span>:
            <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">return</span> df2
</code></pre></div><h1 id="追記">追記</h1>
<h3 id="特徴量の重要度に関する考察20200528">特徴量の重要度に関する考察　(2020/05/28)</h3>
<p>feature-importancesで<code>race_id</code>の重要度が高いことへの考察をします。
まず、次の2ステップから<code>race_id</code>の重要度が高く見積もられていることがわかります。</p>
<p><strong>1 race_idがない場合とある場合で比較</strong></p>
<p>&lsquo;race_id&rsquo;の特徴量を消した場合、7年間すべての年で、回収率が10%程、testに対するrmseが0.1程悪くなりました。
このことから、<code>race_id</code>の特徴量が必要であることがわかります。</p>
<p><strong>2 2番目に重要度の高いdistで1と同じことを行う</strong>
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/62f6f826-4371-a392-2a3b-d36315444c0a.png" alt="aaa.png"></p>
<p>かなり予測精度が悪くなっていることがわかります。</p>
<p><strong>1.2から<code>race_id</code>の重要度が、現状より大きく見積もられていることがわかります。</strong></p>
<p>####&lt;原因&gt;</p>
<p>今回以下のようにランダムに<code>valid</code>,<code>train</code>を分けています。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">X_train, X_valid, y_train, y_valid <span style="color:#f92672">=</span> train_test_split(X_train, y_train, test_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>,\
                                                      random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</code></pre></div><p>これにより、<code>race_id</code>がわかれば、おおよそのタイムがわかることになります。</p>
<p>以下は、試しに<code>shuffle=False</code>をいれて行ってみた結果です。
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/622490/23aa2d6f-6725-f70d-7a3b-349f53418242.png" alt="aaa.png"></p>
<p>このように<code>race_id</code>の重要度は下がります。だたし、回収率やrmse&rsquo;sがよくなることとは別次元のお話です。
現に悪くなりました。</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
