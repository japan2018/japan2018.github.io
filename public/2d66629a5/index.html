<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] Easy IoT to start with Razpai and MESH | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] Easy IoT to start with Razpai and MESH</h1>
<p>
  <small class="text-secondary">
  
  
  Dec 4, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/javascript">JavaScript</a></code></small>


<small><code><a href="https://memotut.com/tags/raspberrypi">RaspberryPi</a></code></small>


<small><code><a href="https://memotut.com/tags/iot">IoT</a></code></small>


<small><code><a href="https://memotut.com/tags/mesh">Mesh</a></code></small>

</p>
<pre><code>Ubiregi Advent Calendar 2019 On the 4th day, we will introduce easy IoT using Razpai and MESH.
</code></pre>
<h1 id="what-to-make">What to make</h1>
<p>We make a very simple thing: pressing a &ldquo;button&rdquo; on the MESH block will post a fixed message to Slack.
As an application, I attach a monitor to Raspberry Pi and use it as an intercom. I think that I would like to see it. While living alone, there is a problem that I do not know if people are visiting while I am away, so if I put a MESH button instead, it seems like I can notify the smartphone that a person came.</p>
<h1 id="items-to-prepare-things-used-this-time">Items to prepare (things used this time)</h1>
<ul>
<li>MESH button block</li>
<li>Raspberry Pi Zero WH (Raspberry Pi)</li>
<li>smartphone</li>
</ul>
<p>#Prerequisites</p>
<ul>
<li>Make sure Raspbian is working on Rasppies</li>
<li>The MESH app is installed on your smartphone</li>
<li>Must have a Slack account</li>
</ul>
<h1 id="procedure">Procedure</h1>
<h2 id="make-raspberry-pi-a-mesh-hub">Make Raspberry Pi a &ldquo;MESH hub&rdquo;</h2>
<p>The formula is very generous in this regard, so you should refer to it.</p>
<p>[I would like to know how to install the &ldquo;MESH hub&rdquo; app on the Raspberry Pi – MESH support | A block-shaped electronic tag that can be connected to the app to make it playful](<a href="https://support.meshprj.com/hc/(en/articles/115002125554)">https://support.meshprj.com/hc/(en/articles/115002125554)</a></p>
<h3 id="supplement">Supplement</h3>
<p>The Razpai I used this time is Zero, so it is very heavy to launch the browser.
So, the part accessed by the browser in the above procedure is done on a normal PC,
<code>②How to login to Raspberry Pi and execute the download command</code>
I think it is easy to copy the command of and download it via SSH.</p>
<h2 id="get-incoming-webhook-url">Get Incoming Webhook URL</h2>
<p>In advance, decide/create a notification destination channel.</p>
<p>next,
<a href="https://qiita.com/ik-fib/items/b4a502d173a22b3947a0">Defeat Slack&rsquo;s Incoming Webhooks - Qiita</a>
Add the Incoming Webhook and copy the URL by referring to.
It is recommended to save the URL because it can be memo pad or anything (we will use it next).</p>
<h2 id="writing-a-server-in-python">Writing a Server in Python</h2>
<p>I&rsquo;m using Python simply because I use Python a lot, so any language will do as long as I can do the same.
By the way, Rasbian has Python installed by default, so you do not need to install Python itself.
The Python version used this time is <code>Python 2.7.13</code>.</p>
<p>We will create a simple HTTP Server to hit the Razpi program from MESH.
This time, I used a lightweight micro web framework called <code>bottle</code>.</p>
<h3 id="advance-preparation">Advance preparation</h3>
<p>Install the library used in the source code with <code>pip</code>.
(<code>requests</code> is used when hitting Slack)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ pip install bottle requests
</code></pre></div><h3 id="source-code">Source code</h3>
<p>Since the place can be anywhere, create a file in an appropriate place and write the following source code.
The name can be anything, but this time it is <code>server.py</code>.
(Refer to &ldquo;<a href="https://qiita.com/Ktrips/items/b94e827eb3b9ef6dadf5">Using Raspberry Pi MESH to create a talking robot operated by Apple Watch - Qiita</a>&quot;)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python:server.py" data-lang="python:server.py"><span style="color:#75715e"># -*- coding: utf-8 -*-</span>

<span style="color:#f92672">from</span> bottle <span style="color:#f92672">import</span> route, run, template
<span style="color:#f92672">import</span> json
<span style="color:#f92672">import</span> requests

slack_settings <span style="color:#f92672">=</span> {
    Let<span style="color:#e6db74">&#39;s change # channel_name arbitrarily</span>
    <span style="color:#75715e"># This is because it is easy to increase the settings when you want to notify other channels as well</span>
    <span style="color:#e6db74">&#39;channel_name&#39;</span>: {
        <span style="color:#e6db74">&#39;url&#39;</span> :<span style="color:#e6db74">&#39;{URL obtained in the step of &#34;Get URL of Incoming Webhook&#34;}&#39;</span>,
        <span style="color:#e6db74">&#39;botname&#39;</span>:<span style="color:#e6db74">&#39;test&#39;</span>,
        <span style="color:#e6db74">&#39;icon&#39;</span> :<span style="color:#e6db74">&#39;:muscle:&#39;</span>,
        <span style="color:#e6db74">&#39;message&#39;</span>:<span style="color:#e6db74">&#39;&lt;!here&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Notification from MESH&#39;</span>
    }
}

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">push</span>(setting):
    datas <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;username&#39;</span>: setting[<span style="color:#e6db74">&#39;botname&#39;</span>],
        <span style="color:#e6db74">&#39;icon_emoji&#39;</span>: setting[<span style="color:#e6db74">&#39;icon&#39;</span>],
        <span style="color:#e6db74">&#39;text&#39;</span>: setting[<span style="color:#e6db74">&#39;message&#39;</span>],
        <span style="color:#e6db74">&#39;contentType&#39;</span>:<span style="color:#e6db74">&#39;application/json&#39;</span>
    }
    payload <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>dumps(datas)
    result <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(setting[<span style="color:#e6db74">&#39;url&#39;</span>], payload)
    <span style="color:#66d9ef">print</span>(result)

<span style="color:#a6e22e">@route</span>(<span style="color:#e6db74">&#39;/post/slack/&lt;command&gt;&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">mesh_button</span>(command):
    <span style="color:#66d9ef">if</span> command <span style="color:#f92672">==</span><span style="color:#e6db74">&#39;channel_name&#39;</span>:
        push(slack_settings[<span style="color:#e6db74">&#39;channel_name&#39;</span>])
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">raise</span> Error

run(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;localhost&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span>, reloader<span style="color:#f92672">=</span>True)
</code></pre></div><h3 id="start-the-server">start the server</h3>
<p>Start the server with the following command. I don&rsquo;t think there is anything particularly difficult.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$python server.py
</code></pre></div><p>If you start it up properly, you will see this display.</p>
<pre><code>Bottle v0.12.17 server starting up (using WSGIRefServer())...
Listening on http://localhost:8080/
Hit Ctrl-C to quit.
</code></pre><p>Let&rsquo;s hit it with <code>curl</code> to try it out. If you close the console that uses <code>python server.py</code>, the server will stop, so let&rsquo;s open another console (even if SSH is connected).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl http://localhost:8080/post/slack/channel_name
</code></pre></div><p>On the side running the server</p>
<pre><code>&lt;Response [200]&gt;
127.0.0.1--[04/Dec/2019 13:46:15] &quot;GET /post/slack/channel_name HTTP/1.1&quot; 200 0
</code></pre><p>I think that a log will appear, so if it is, it is successful.</p>
<h2 id="create-custom-block-from-mesh-sdk">Create custom block from MESH SDK</h2>
<p>In MESH, processing is created by connecting standard processing called blocks with lines.
(Set later)
So, it is necessary to create a block that hits the URL of the <code>server.py</code> created earlier. So, first make it.</p>
<h3 id="access-custom-block-creation-page">Access custom block creation page</h3>
<p>Access <a href="https://meshprj.com/sdk-jp/">SDK_TOP_JP</a>.
You can go to the custom block management screen from &ldquo;Use MESH SDK&rdquo;.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/6e317b45-b280-ef3d-f868-d604e6dc3e82.png" alt="FireShot Capture 005-SDK_TOP_JP-meshprj.com.png"></p>
<h3 id="create-a-custom-block">Create a custom block</h3>
<p>Clicking <code>Create New Block</code> will bring you to the custom block creation screen, so set it.
The settings are as follows. Once you have made all the settings, click &ldquo;Save&rdquo; in the upper left to save.</p>
<p>![FireShot Capture 010-MESH SDK-meshprj.com.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/8b574659-f079-3388-607e-(49ec60b01991.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/8b574659-f079-3388-607e-(49ec60b01991.png)</a>
![FireShot Capture 011-MESH SDK-meshprj.com.png](<a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/fe78c5a4-a87d-35ba-0dd7-(2cdb26ca06c4.png)">https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/fe78c5a4-a87d-35ba-0dd7-(2cdb26ca06c4.png)</a></p>
<pre><code class="language-Source" data-lang="Source">var localhost ='http://localhost:8080' + properties.path;

ajax({
  url: localhost,
  type:'get',
  timeout: 5000,
  success: function (data) {
    callbackSuccess({
      resultType:'continue'
    });
  },
  error: function(request, errorMessage) {
    log('ERROR:'+ errorMessage);
    callbackSuccess({
      resultType:'continue'
    });
  }
});

return {
  resultType:'pause'
}
</code></pre><h4 id="brief-description-of-settings">Brief description of settings</h4>
<p>The settings for this area are based on &ldquo;<a href="https://qiita.com/Ktrips/items/b94e827eb3b9ef6dadf5">Using Raspberry Pi MESH to create a talking robot operated by Apple Watch - Qiita</a>&rdquo;.</p>
<h5 id="connector">Connector</h5>
<p>This only configured the Input Connector.
As you can see later by touching the MESH application, there are Input and Output in the MESH block.
This time, after pressing the button, the process of this custom block is started and it feels like it is finished, so there is no setting in the Output Connector.
If you want to do something else after running this custom block, you&rsquo;ll also need to configure the Output Connector.</p>
<h5 id="property">Property</h5>
<p>This allows you to create properties that you can reference in your code. You can tamper with the value of the property when placing a custom block. So, for example, even if you want to notify another channel, you do not need to create a new block, you can do it by just touching the property value when placing it.</p>
<h5 id="codethis-is-the-javascript-code-that-will-be-executed-when-the-custom-block-is-kicked-when-the-code-is-kicked-im-going-to-hit-the-server-i-wrote-in-python-with-ajax">CodeThis is the JavaScript code that will be executed when the custom block is kicked. When the code is kicked, I&rsquo;m going to hit the server I wrote in Python with Ajax.</h5>
<h2 id="create-recipe-with-mesh-app">Create recipe with MESH app</h2>
<h3 id="brief-description-of-mesh-app">Brief description of MESH app</h3>
<p>To make a process using MESH, you need to make a &ldquo;recipe&rdquo; with the MESH app. **This recipe can only be made from the MESH app. **The recipe to run on Razpi will also be made from the MESH app.</p>
<h3 id="mesh-hub-registration">MESH Hub Registration</h3>
<p>As a preparation, let&rsquo;s turn on the Bluetooth of the smartphone and Razpai.
Start the MESH application from your smartphone. There is a smartphone mark on the upper right, but tap this and you will see &ldquo;Change to another terminal&rdquo; below, so tap this.</p>
<img width="375" alt="IMG_5206.PNG" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/260e94d7-c7da-86e6-60e1-6253f9efe043.png">
<p>Then, the &ldquo;Select a device&rdquo; screen will appear, so sign in and tap &ldquo;Add hub&rdquo;.
<img width="375" alt="IMG_5208.PNG" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/1c57041d-5280-4c30-cbd8-91e9eaf11f05.png"></p>
<p>Tap &ldquo;Add Hub&rdquo; to display the following screen. Tap &ldquo;Start setup&rdquo; to go to the next.
<img width="375" alt="IMG_5210.PNG" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/1f963f9e-376b-8642-30ef-ab6031f26194.png"></p>
<p>This screen also advances with &ldquo;Next&rdquo;.
<img width="375" alt="IMG_5211.PNG" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/d81a2384-97a4-09d6-ed27-4df63b1c4c1c.png"></p>
<p>The following screen will be displayed if the smartphone and Raspberry Pi are successfully connected. If you can&rsquo;t wait for a few minutes, check your Bluetooth or make sure your Raspberry Pi is ready to set up (tap the link on the screen to see how) ..
<img width="375" alt="IMG_5213.PNG" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/a9362640-0b46-65e6-907c-ebdc5a80cc06.png"></p>
<p>This screen is a screen whether or not to set the Wi-Fi of Razpi. Unless it is connected by wire, basically Wi-Fi connection should be finished, so skip it.
<img width="375" alt="IMG_5215.PNG" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/c7acd370-df33-d611-7dfa-4d97419fa066.png"></p>
<p>Decide on a hub name and proceed to the next step.
<img width="375" alt="IMG_5218.PNG" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/6bcf2a2a-782f-6c51-7b88-4344d047153e.png"></p>
<p>If it works well, this screen will be finally displayed, so select the MESH hub of Razpi that you added earlier and tap &ldquo;Select&rdquo; at the bottom of the screen.
<img width="375" alt="IMG_5220.PNG" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/05d7f876-ddbe-ee54-7482-9e0d7be2ab57.png"></p>
<h3 id="add-blockscustom-blocks-create-recipes">Add blocks/custom blocks, create recipes</h3>
<ul>
<li>We recommend that you turn off your smartphone&rsquo;s Bluetooth before starting this process. When you turn on the MESH block, it will try to pair with the smartphone, but the partner of the pairing is Razpai. If you don&rsquo;t turn off your smartphone&rsquo;s Bluetooth, MESH will try to pair with your smartphone forever, so it won&rsquo;t pair with Razpi.</li>
</ul>
<p>This screen appears when you tap &ldquo;New Recipe&rdquo; on the app top screen. First, let&rsquo;s add a MESH block. Turn on the MESH block and tap the &ldquo;Add block&rdquo; plus mark on the bottom left.
(For power supply, long press the silicon material part of MESH block to enter, if it does not enter, please charge)
<img width="375" alt="IMG_5222.PNG" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/53f80791-f06b-a9da-f6fb-cc50ef38ff5e.png"></p>
<p>If you can add it well, a &ldquo;button block&rdquo; will be displayed at the bottom left block, so let&rsquo;s place it by tapping and dragging. It should look like the screen below.
<img width="375" alt="IMG_5226.PNG" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/18cf024b-2dc3-0fbd-6308-df58b3310b05.png"></p>
<p>Then add a custom block. I registered the JavaScript code on the Web screen earlier. You can go to the addition screen by tapping the plus sign of &ldquo;Custom addition&rdquo; as shown in the screen above. Then, the custom block you registered earlier will be displayed as follows, so tap it and tap the &ldquo;Add&rdquo; button.
<img width="375" alt="IMG_5227.PNG" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/e2a8e829-de4a-d7bc-826a-68ddb06885a5.png"></p>
<p>I think that I was able to add it safely, so arrange the custom block in the same way as the &ldquo;button block&rdquo; was arranged earlier, and connect the end of the button block and the end of the custom block as shown below. You can connect by dragging from the placed button block to the custom block.
<img width="375" alt="IMG_5230.PNG" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/5188f678-e889-63d1-70f1-0cd518b857f2.png"></p>
<h4 id="supplement-1">Supplement</h4>
<p>If you tap the placed custom block, you will see a screen like this. You can change the value of the property here. If you change the Python server-side program, you can change the behavior by changing the Path here in the same custom block.
<img width="375" alt="IMG_5231.PNG" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/6fc116fe-bc43-8a77-6492-6df7bf0b4fc8.png"></p>
<h2 id="operation-check">Operation check</h2>
<p>Now that the settings are complete, let&rsquo;s press the MESH button. It will be successful if it is posted to Slack.
<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/222089/a3be2de6-767e-8678-264f-65bf061464f2.png" alt="Untitled.png"></p>
<p>#Summary
With the above, when you press the button of MESH, notification with Slack (via Raspai) is completed.
There are quite a lot of procedures, but as you&rsquo;ve noticed, the source code I wrote is small. In the first place, there are hurdles that you must install Raspai, but if you exceed that, you will be able to do it quite quickly.
In addition to buttons, MESH has various blocks such as LED, motion sensor, motion sensor, temperature and humidity sensor, brightness sensor, GPIO. The strength is that you can make your own IoT even if you can not do electronic work at all (except GPIO). When it comes to electronic work, some knowledge of electrical and electronic is inevitably necessary, so for someone who has been a software engineer, the hurdles are a little high. However, the MESH tag is recommended because it requires almost no knowledge of electronic work and most of the software can be used.
By the way, if you want to do something physically, but you don&rsquo;t have knowledge of electronic work&hellip; there is a very useful thing called the Eject command, so you may want to try using it (reference: <a href="https://www.slideshare.net/Akkiesoft/ejectraspberry-picdrom">Eject command for Raspberry Play with Pi -Easy work with a CD-ROM drive-</a>).</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
