<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <meta name="generator" content="Hugo 0.72.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://memotut.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://memotut.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://memotut.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://memotut.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://memotut.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://memotut.com/css/bootstrap.min.css" />

  
  <title>[Python] Convert Tamiya&#39;s fun work series to Donkey Car | Memo Tut</title>
  

  <style>
body {
  min-width: 300px;
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block; 
  padding: 18px 0;
  margin-right: 1em; 
  font-weight: bold; 
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none; 
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #fff;
}



body {
  color: #212529;
}



a {
  color: #007bff;
}



a:hover,
a:focus {
  color: #0056b3;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: rgba(255, 255, 255, 0.75);
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: rgba(255, 255, 255, 1);
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 9.5px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre code {
  padding: 0;
  font-size: inherit;
  color: inherit; 
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 4px;
  color: inherit; 
  background-color: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: .9em;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Posts</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/about/">About</a>
    
    <a href="/index.xml">RSS</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>[Python] Convert Tamiya&rsquo;s fun work series to Donkey Car</h1>
<p>
  <small class="text-secondary">
  
  
  Nov 26, 2019
  </small>
  

<small><code><a href="https://memotut.com/tags/python">Python</a></code></small>


<small><code><a href="https://memotut.com/tags/pigpio">pigpio</a></code></small>


<small><code><a href="https://memotut.com/tags/donkeycar">donkeycar</a></code></small>


<small><code><a href="https://memotut.com/tags/dc-motor">DC motor</a></code></small>


<small><code><a href="https://memotut.com/tags/tb6612">TB6612</a></code></small>

</p>
<pre><code>&gt; AI RC Car Advent Calendar 2019 Participating article.
</code></pre>
<p><a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/a42cc8e8-78b1-ed74-530b-1a7c0fe1340f.jpeg">Let&rsquo;s make a Donkey car using Tamiya work series</a></p>
<p>I made an AI autonomous car Donkey Car based on <a href="https://www.tamiya.com/japan/products/70104/index.html">Tamiya&rsquo;s work series &ldquo;Bulldozer&rdquo;</a>. I actually ran the orbital course at the driving session using the next learning model.</p>
<p>The source code used this time and how to make it are written in detail on <a href="https://github.com/coolerking/caterpillar">GitHub</a> side, so this article will introduce the outline and modification points.</p>
<ul>
<li><a href="https://github.com/coolerking/caterpillar">GitHub: Donkey car of the fun work series &ldquo;Bulldozer&rdquo;</a></li>
</ul>
<h2 id="1-what-is-donkey-car">1 What is Donkey Car</h2>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/b38f3b7e-2e21-cfca-a3a3-dbaaca4270c4.jpeg" alt="Donkey Car"></p>
<p><a href="http://www.donkeycar.com">Donkeycar</a>isanMIT-compliantopensourceandMIT-compliantopensourcethatenablesautonomousdrivingbyusingrelativelyeasilyavailablepartssuchasRaspberryPi/JetsonNanoandcommerciallyavailableRCcars.Asetofdocumentsincludingblueprints(CreativeCommons) for 3D printers.</p>
<ul>
<li><a href="http://www.donkeycar.com">Donkeycar Official Website</a></li>
<li><a href="http://docs.donkeycar.com/">Donkeycar Official Documentation</a></li>
<li><a href="https://github.com/autorope/donkeycar">GitHub:Donkeycar source code</a></li>
</ul>
<h2 id="2-how-to-get-started-with-donkey-car">2. How to get started with Donkey Car</h2>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/d86944ff-570a-b6a5-f271-bbc56ea5e905.jpeg" alt="Standard Donkey Car purchased at Hong Kong shop"></p>
<p>To start Donkey Car, you need to procure parts, assemble Donkey Car, install software, and configure software according to <a href="http://docs.donkeycar.com/">Documentation</a>. The community sells standard Donkey Car kits so that those who are not good at DIY or who are not familiar with programming and software can participate, so we recommend that you purchase this first.</p>
<p>I also bought and assembled my first Donkey Car at <a href="https://www.robocarstore.com/">Robocar Store</a>inHongKong.Pleasereferto<a href="https://www.slideshare.net/HoriTasuku/donkey-car">here</a> for how to assemble.</p>
<ul>
<li><a href="https://www.slideshare.net/HoriTasuku/donkey-car">SlideShare: Assembling DonkeyCar as seen in the photo</a></li>
</ul>
<blockquote>
<p>Hong Kong standard Donkey Car battery uses Tamiya mini connector. It may be difficult to obtain this type of battery in Japan.</p>
</blockquote>
<p>If you are a little buying from overseas sites.., there are several companies that are sold in Japan, so please search.</p>
<h2 id="3-donkey-car-autonomous-driving">3. Donkey Car Autonomous Driving</h2>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/d8d9b51c-4dec-6466-90c9-e599f5ad10b6.jpeg" alt="Standard Donkey Car running autonomously"></p>
<p>Autonomous driving in the Donkey Car is aimed at <strong>driving the orbital course as fast as possible</strong>. For this reason, complicated autonomous driving, such as carrying and moving people and things at designated locations, is not possible. If you put the Donkey Car on the course and set it to automatic driving mode, it will continue to run the lap course.</p>
<p>Donkey Car&rsquo;s default autonomous driving model uses &ldquo;supervised machine learning&rdquo;.</p>
<blockquote>
<p>Although not explained in detail, it is also possible to handle a reinforcement learning model using the Donkey simulator.
<img width="468" alt="Donkey Simulator" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/75c8d724-bbd9-f2fc-fb89-ac3124f6767c.png"></p>
</blockquote>
<p>The input data is the image of the camera mounted in the front (120x160x3, nd.array type), and the output data is the output value (float x 2) to the steering/throttle of the RC car. However, Donkey Car also has <a href="https://fight-tsk.blogspot.com/2019/09/donkeycar310.html">several different models</a>, and there are some with different input and output data. Masu</p>
<img width="650" alt="linear.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/4b3d6893-aa5d-54f1-2cff-cec82accd41b.png">
<blockquote>
<p>Please refer to <a href="https://fight-tsk.blogspot.com/2019/09/donkeycar310.html">here</a> for the model groups prepared in Donkey Car 3.1.</p>
</blockquote>
<img width="611" alt="Flow from learning Donkey Car to autonomous driving" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/1443aba6-5e8a-f86a-1e6e-83ad4dfe0183.png">
<p>If you use the default model, it is &ldquo;supervised&rdquo;, so you must first collect the training data. Once the Donkey Car is built,</p>
<ol>
<li>Record correct driving using the remote control (create learning data by manual driving)</li>
<li>Execute the training process on the PC based on the acquired record (machine learning model training)</li>
<li>Automatic driving according to the learned model (Automatic driving based on the inference result of the learned model)</li>
</ol>
<p>Will be performed.</p>
<p>Although it is the amount of data required for learning, the official document says that it is about 10 laps. If it is a simple course, it is not necessary so much, but if there are people or moving objects around the course, it will take a little more laps. First, by traveling to prospect for more than 10 laps, please try to devise.</p>
<h2 id="4-how-donkey-car-works">4. How Donkey Car Works</h2>
<h3 id="41-rc-car">4.1 RC Car</h3>
<p>Donkey Car is a relatively easy-to-obtain component and is designed based on the idea of autonomous driving. For this reason, RC cars are used as the base of the vehicle body.
There are various types of RC cars on the market, but we will use a common <strong>hobby RC car</strong> such as Tamiya&rsquo;s 1/10 scale. The structure of the RC car for hobby is configured as shown in the figure below.</p>
<img width="468" alt="How RC cars work" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/cef970dc-71e6-4885-51fa-0ca97dac4c33.png">
<p>** Propo is a controller for operation, and it is sold as a pair with the ** receiver ** mounted on the vehicle body (gray part). If you purchase only the vehicle body, you need to assemble the receiver to the vehicle body.</p>
<p>The steering of the RC car is driven by the <strong>servo motor</strong>, and the three cables (power supply, GND, PWM) from the steering servo are attached to the receiver.</p>
<p>The powerful <strong>throttle motor</strong> is powered from the RC car battery, but instead of being connected directly, it is connected to a box larger than the matchbox called the <strong>Speed Controller (ESC)</strong>. The speed controller sends the adjusted amount of electricity to the throttle motor according to the instruction received from the receiver. Please note that the speed controller differs depending on the motor type.</p>
<h3 id="42-wiring-on-donkey-car">4.2 Wiring on Donkey Car</h3>
<p>Of course, RC car props are not required for autonomous driving (the RC car shop for hobbies sells propo separately, so you can only get the RC car body). I will connect the one that changes to the radio instead.</p>
<p>The figure below is a block diagram of the RC car.
Seeing from the receiver, it is like operating two servo motors.</p>
<img width="459" alt="rc_car_02.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/771655d9-30a3-bd7c-0dc8-52fed64aa43f.png">
<p>The Donkey Car has a structure in which the part corresponding to the receiver and the transmitter is replaced with a servo controller.</p>
<img width="502" alt="Donkey Car Mechanism 2" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/a57eda7d-36da-4a62-8ff3-dbca5684bdef.png">
<p>The servo controller is a board that enables the servo motor to be operated by a microcomputer equipped with GPIO such as Raspberry Pi. The standard Donkey Car uses a 16-channel PCA9685, that is, a board that can operate up to 16 servomotors.</p>
<p>Connect the servo motor with three cables, GND(-), Vcc(3.3V), and PWM. PWM is a method to realize pseudo analog output by alternately outputting digital output pins (0 or 1) in a short time.</p>
<p>However, the GPIO of the Raspberry Pi has only 4 pins that implement PWM at the hardware level, and only 2 if you want to output multiple waveforms at the same time.</p>
<p>In such cases, the Raspberry Pi provides a way to operate multiple devices with a fixed number of pins such as serial, I2C and SPI.<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/9f484b93-4c9a-28b2-7d63-a614d2c37be1.jpeg" alt="PCA9685"></p>
<p>When operating two or more servo motors with a standard Donkey Car, we are using a motor driver called PCA9685 (blue board in the above figure). Since this PCA9685 connects to the Raspberry Pi in I2C format, multiple servo motors can be used with a small number of pins (4 pins including GND and Vcc).</p>
<blockquote>
<p>The weak point of Raspberry Pi is that it has few PWM pins and <strong>no analog pins</strong>. An analog pin is a pin that can literally input and output a voltage between 0 and 1. Especially, since the analog input is used for connecting sensors, etc., when adding many other types of sensors, there is a method such as serial or I2C communication with an analog-to-digital converter (ADC) or a microcomputer with analog pins. Should take</p>
</blockquote>
<h3 id="43-software">4.3 Software</h3>
<p>Donkey Car is written in Python. Even if you don&rsquo;t know Python, you don&rsquo;t need much knowledge to run standard Donkey Car.</p>
<p>However, if you make changes such as changing the servo motor driver to a DC motor driver like this time, you need to add or rewrite the program.</p>
<p>If Donkey Car software is installed on the Donkey Car microcomputer according to the document, the module called <code>manage.py</code> is the entry point for startup.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Example command to drive Donkeycar manually with joystick</span>
python manage.py drive --js
</code></pre></div><p>If you pass <code>drive</code> as the first argument, the manual/automatic operation process will be executed. If you pass <code>train</code>, the training process will be executed.</p>
<blockquote>
<p>If you specify <code>drive</code>, you can switch between manual and automatic by operating the game pad or smartphone that corresponds to the R/C system.</p>
</blockquote>
<p>Since the input data and output data of the machine learning model are not changed this time, the modified part is only when <code>drive</code> is specified, that is, in the function <code>drive()</code> in <code>manage.py</code>.</p>
<h4 id="431-vehicle-framework">4.3.1 Vehicle framework</h4>
<p>Donkey Car consists of Python package donkeycar and an execution program that actually (manually/automatically) drives and trains using this package.</p>
<p>These programs are implemented based on the framework (here called the vehicle framework) that uses the <code>Vehicle</code> class on the <code>donkeycar.vehicle</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">:
<span style="color:#f92672">import</span> donkey <span style="color:#f92672">as</span> dk
:
<span style="color:#75715e">#Veicle Object Generation</span>
V <span style="color:#f92672">=</span> dk<span style="color:#f92672">.</span>vehicle<span style="color:#f92672">.</span>Veichle()
:
<span style="color:#75715e"># Add parts</span>
core_fighter <span style="color:#f92672">=</span> anaheim<span style="color:#f92672">.</span>core<span style="color:#f92672">.</span>Fighter()
V<span style="color:#f92672">.</span>add(core_fighter, outputs<span style="color:#f92672">=</span>[
    <span style="color:#e6db74">&#39;amuro/left/arm&#39;</span>,<span style="color:#e6db74">&#39;amuro/right/arm&#39;</span>,
    <span style="color:#e6db74">&#39;amuro/left/leg&#39;</span>,<span style="color:#e6db74">&#39;amuro/right/leg&#39;</span>],
    threaded<span style="color:#f92672">=</span>True)
a_part <span style="color:#f92672">=</span> anaheim<span style="color:#f92672">.</span>rx_78<span style="color:#f92672">.</span>APart()
V<span style="color:#f92672">.</span>add(a_part,
    inputs<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;amuro/left/arm&#39;</span>,<span style="color:#e6db74">&#39;amuro/right_arm&#39;</span>])
b_part <span style="color:#f92672">=</span> anaheim<span style="color:#f92672">.</span>rx_78<span style="color:#f92672">.</span>BPart()
V<span style="color:#f92672">.</span>add(b_part,
    inputs<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;amuro/left/leg&#39;</span>,<span style="color:#e6db74">&#39;amuro/right/leg&#39;</span>])
:
<span style="color:#75715e">#Veichle loop execution (20 times per second, up to 100,000 times)</span>
V<span style="color:#f92672">.</span>start(start_hz<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>,
    max_loop_count<span style="color:#f92672">=</span><span style="color:#ae81ff">100000</span>)

</code></pre></div><p>It is easy to use, after creating a <code>Vehicle</code> object and adding (<code>add</code>) a class called a part, and finally making the loop <code>start</code>, the part class is <code>add</code> according to the specified arguments. It is executed in order.</p>
<p>The value of the dictionary <code>V.mem</code> stored in the key specified in the <code>inputs</code> and <code>outputs</code> specified when the part is <code>added</code> is used to exchange values between the part classes.</p>
<blockquote>
<p>If you want to set the initial value before doing <code>start</code>, you can specify it by writing, for example, <code>V.mem['amuro/left/arm'] = 0.0</code>.</p>
</blockquote>
<h4 id="432-parts-class">4.3.2 Parts class</h4>
<p>When Veicle starts <code>start</code>, the <code>run</code> method of each class (<code>run_threaded</code> method if <code>threaded=True</code>) is called in the order of <code>add</code>.</p>
<p>For the argument of the <code>run</code> method, the value specified in <code>inputs</code> at the time of <code>add</code> is stored. The return value of the <code>run</code> method is stored in the framework side <code>V.mem</code> as the value of the key specified in <code>outputs</code>.</p>
<p>The Veicle framework executes the loop at the specified cycle (<code>rate_hz</code>), but since it is processed by the basic single thread, the cycle cannot be protected if the processing time of the <code>run</code> method becomes long. Therefore, the parts that are likely to take a long time to process are implemented as multi-threaded parts.</p>
<p>The multithreaded part implements the <code>run_threaded</code> method instead of the <code>run</code> method. When the multi-threaded part is created, another thread is created and the <code>update</code> method without arguments is executed periodically. The main thread on the Veicle framework side calls <code>run_threaded</code> every time the loop goes around. For this reason, common usage is for reading parts such as sensors. The <code>update</code> method is the method executed in the new thread. Normally, create an infinite loop in the <code>update</code> method, store the value read from the sensor in the instance variable in the class, and execute the <code>time.sleep</code> method. Then, in the <code>run_threaded</code> method, implementation such as outputting the value of the instance variable updated by the <code>update</code> method to the Vehicle framework side is performed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#Example of threaded part reading sensor value</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ThreadedSamplePart</span>:
    <span style="color:#66d9ef">def</span> __init__(self):
        <span style="color:#75715e">#Preparing the sensor</span>
        self<span style="color:#f92672">.</span>sensor <span style="color:#f92672">=</span> HogehogeSensor()
        <span style="color:#75715e">#Initialize the instance variable that stores the sensor value</span>
        self<span style="color:#f92672">.</span>value <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update</span>(self):
        <span style="color:#66d9ef">while</span> True:
            <span style="color:#75715e"># Read data from sensor and store in instance variable</span>
            self<span style="color:#f92672">.</span>value <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>sensor<span style="color:#f92672">.</span>read()
            time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.1</span>)
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_threaded</span>(self):
        <span style="color:#75715e">#Return the latest value stored in the instance variable</span>
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>value
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">shutdown</span>(self):
        <span style="color:#75715e"># Call sensor termination processing, etc.</span>
        self<span style="color:#f92672">.</span>sensor<span style="color:#f92672">.</span>close()
</code></pre></div><p>To install and execute it in the Vehicle framework, add parts like the example below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Vehicle object generation</span>
V <span style="color:#f92672">=</span> donkey<span style="color:#f92672">.</span>vehicle<span style="color:#f92672">.</span>Veicle()
:
<span style="color:#75715e"># Store return value in dictionary V.mem with key&#39;value&#39;</span>
V<span style="color:#f92672">.</span>add(ThreadedSamplePart(),
    outputs<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;value&#39;</span>],
    threaded<span style="color:#f92672">=</span>True)
:
<span style="color:#75715e"># Vehicle loop start (20 times per second, 10000 times in total)</span>
V<span style="color:#f92672">.</span>start(rate_hz<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, max_loop_count<span style="color:#f92672">=</span><span style="color:#ae81ff">10000</span>)
</code></pre></div><blockquote>
<p>If the sensor vendor provides a multi-threaded data reading module, write it in a normal single-threaded part class. It works with <code>theaded=True</code>, but it&rsquo;s hard to debug, so it&rsquo;s better not to add extra threads as much as possible. However.. For heavy processing that can not be completed within 1/20 seconds which is the default loop circulation time, it is better to make it a multi-thread part class.</p>
</blockquote>
<h4 id="433-gpio-operation">4.3.3 GPIO operation</h4>
<p>There are several ways to interact with the Raspberry Pi GPIO from Python.</p>
<table>
<thead>
<tr>
<th align="left">** Package name **</th>
<th align="left">** Description **</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><a href="https://sourceforge.net/projects/raspberry-gpio-python/">RPi.GPIO</a></td>
<td align="left">GPIO operation library that has been used for a long time. Describe each GPIO pin operation one by one. It&rsquo;s an intuitive way to write code if you are familiar with hardware, and it is still used by many people.</td>
</tr>
<tr>
<td align="left"><a href="http://wiringpi.com/">WireingPi</a></td>
<td align="left">There are many cases and there are many sample codes on Qitta. Later than RPi.GPIO, and therefore easier to use.</td>
</tr>
<tr>
<td align="left"><a href="http://abyz.me.uk/rpi/pigpio/">pigpio</a></td>
<td align="left">Newest in this table. It is assumed that the pigpiod daemon is running, but remote operation is also possible by communication between daemons. High accuracy of software PWM. I feel that the design is more than a software shop.</td>
</tr>
<tr>
<td align="left"><a href="https://github.com/vsergeev/python-periphery">python-periphery</a></td>
<td align="left">AlibraryformanipulatingGPIOcharacterdevices.<a href="https://coral.withgoogle.com/docs/dev-board/datasheet/#io-header-pinout">CoralDevBoardofficialdocument</a> describes the example using this library.</td>
</tr>
</tbody>
</table>
<p>The donkeycar package uses the RPi.GPIO package. The motor driver uses <a href="https://github.com/adafruit/Adafruit_Python_PCA9685">Library provided by Adafruit</a>. This driver also uses the RPi.GPIO package, although I have not sourced it all.</p>
<h4 id="434-donkey-command">4.3.4 donkey command</h4>
<p>If you install donkeycar package, command line support tool <code>donkey</code> can be used. This command does not mean manual operation or automatic operation. This is a support tool only, and a program (Donkey Car application) that performs manual operation or automatic operation of Donkey Car is generated using this support tool.</p>
<p>There are several other functions besides the Donkey Car application generation. The table below lists the values that can be specified in the first argument.|** First argument **|** Description **|
|:&ndash;|:&ndash;|
|<code>createcar</code>| Generate a Donkey Car application. |
|<code>findcar</code>|If an alive DonkeyCar exists on the same segment, the IP address is returned. Only mac/Unix OS can be executed. |
|<code>calibrate</code>| Used to adjust the steering and throttle before driving the Donkey Car. |
|<code>tubclean</code>|Delete unnecessary Tub data using Web UI. However, the serial number of Tub data after deletion is scattered. |
|<code>makemovie</code>|Tub Connect the images on the data to make a movie. Running in salient mode overlays the part where the model reacts on the video, but it takes time to process. |
|<code>checktub</code>|Tub Check the validity of the data and confirm whether it can be used as a machine learning corpus. |
|<code>tubhist</code>| Creates and displays a histogram from Tub data. For checking statistical information. |
|<code>tubplot</code>|Displays throttle angle values from Tub data as a time series graph. |
|<code>consync</code>| Continuously copy files from Donkey Car to host PC. It can be used for Tub data copy, but it needs to be set because rsync is used. |
|<code>contrain</code>| Continuously checks for new data every 1 epoch of the training process, and if there is existing data, use them for the next epoch. If a model with a better loss value is created by the training process on the host side, it can be replaced. |
|<code>createjs</code>| A wizard that will generate the base Python code for you if you want to use unsupported joysticks. |
|<code>cnnactivation</code>| Visualize where the model fires for each image. While <code>makemovie</code> visualizes only the first Conv layer, this command visualizes all Conv layers. |</p>
<h4 id="435-donkey-car-application">4.3.5 Donkey Car Application</h4>
<p>The Python programs that are generated by executing the <code>donkey createcar</code> command are called Donkey Car applications. This application handles (manual/automatic) driving and training processes.</p>
<p>The reason why it is not packaged and why it is generated one by one is that you need to set Donkey Car specific settings.</p>
<p>For example, the steering and throttle of Donkey Car have different characteristics depending on the RC car used. This is done by making &ldquo;tuning&rdquo; for each characteristic and modifying the Donkey Car application to reflect the definition in the Donkey Car application.</p>
<p>The Donkey Car application has the following components:</p>
<table>
<thead>
<tr>
<th align="left"><strong>File name</strong></th>
<th align="left"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>config.py</code></td>
<td align="left">File that defines the default parameters passed to Donkey Car. Basically, do not edit this file.</td>
</tr>
<tr>
<td align="left"><code>myconfig.py</code></td>
<td align="left">A file for configuring Donkey Car specific settings. At the time of generation, all the configuration of <code>config.py</code> is commented out, and the value specified here is overridden by the value of <code>config.py</code>. Some donkey commands also use this setting.</td>
</tr>
<tr>
<td align="left"><code>manage.py</code></td>
<td align="left">Entry Point of Donkey Car application. When this file is executed by specifying <code>drive</code> as the first argument, (automatic/manual) operation is started, and when it is executed by specifying <code>train</code>, the training process is started. If you want to use sensor or unsupported gamepad for Donkey Car, modify this file.</td>
</tr>
<tr>
<td align="left"><code>train.py</code></td>
<td align="left">Training process is implemented. When <code>manage.py</code> is executed in <code>train</code> mode, the processing moves to this file. If there is no case where the original model is modified to change the input layer and output layer, there is no need to change it.</td>
</tr>
</tbody>
</table>
<p>To change the initial parameters, edit <code>myconfig.py</code>, to edit your own Donkey Car specifications, edit <code>manage.py</code>, and to use your own model, edit <code>train.py</code>.</p>
<blockquote>
<p>The Vehicle framework described above is described in <code>manage.py</code>. Not used in the training process.</p>
</blockquote>
<h4 id="436-tub-data">4.3.6 Tub data</h4>
<p>Tub data is a group of files corresponding to the corpus of Donkey Car&rsquo;s machine learning model.</p>
<p>When manual operation is started without specifying the directory where Tub data is stored, the subdirectory <code>data/tub_N_YY-MM-DD/</code> of the Donkey Car application directory is created and the files shown in the table below are created. Will be done.</p>
<table>
<thead>
<tr>
<th align="left">** File name format **</th>
<th align="left">** Description **</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>NNN_cam-image_array_.jpg</code></td>
<td align="left">A front camera image file. 120x160 JPG format.</td>
</tr>
<tr>
<td align="left"><code>record_NNN.json</code></td>
<td align="left">A JSON format file that digitizes the driver&rsquo;s operation. By default, the throttle value, angle value, operation mode, corresponding image file name, and recording time are recorded.</td>
</tr>
<tr>
<td align="left"><code>meta.json</code></td>
<td align="left">A JSON format file that stores the definitions of the elements that make up the Tub data, and describes each element and its type.</td>
</tr>
</tbody>
</table>
<p><code>NNN</code> is a sequential number starting from 1. When manual operation is started, image files and record files are created every 1/20 seconds. If you want to know the total number, sort by file name.</p>
<blockquote>
<p>When IMU sensor such as MPU6050 is installed (imu model) or when using behavior model, the number of record file components increases. Although it is possible to add elements to the record file by installing a unique sensor, training processing time will increase.</p>
</blockquote>
<h2 id="5-tamiya-modification-to-bulldozer-a-fun-work-series">5 Tamiya Modification to &ldquo;Bulldozer&rdquo;, a fun work series</h2>
<p>Before thinking about which part of the Donkey Car to modify, let&rsquo;s first check the configuration of the &ldquo;bulldozer&rdquo;.</p>
<h3 id="51-tamiya-fun-work-series-bulldozer">5.1 Tamiya Fun Work Series &ldquo;Bulldozer&rdquo;</h3>
<p>Tamiya&rsquo;s fun work series is different from those selling parts such as gears, pulleys, universal plates, tires, tracks for making something by yourself, bulldozers and excavators powered by DC motors and rubber, forklifts, ships, There are kits such as cars and ropeways.</p>
<p>This time, I chose &ldquo;Bulldozer&rdquo; that can be operated by remote control from the kit.</p>
<p>&lt;a target=&rdquo;_blank&rdquo; href=&quot;https://www.amazon.co.jp/gp/product/B002DR3H4Y/ref=as_li_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=B002DR3H4Y&amp;linkCode=as2&amp;tag=hara2dev0d-22&amp;linkId=a91e0626318) &gt;<img border="0" src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=JP&ASIN=B002DR3H4Y&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL250_&tag=hara2dev0d-22" >&lt;/ a&gt;<img src="//ir-jp.amazon-adsystem.com/e/ir?t=hara2dev0d-22&l=am2&o=9&a=B002DR3H4Y" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>
<p>The reason I chose it is that turning right and left is going forward and backward, it is a structure that makes it easy to install a Raspberry Pi and battery, and above all it is cheaper than the RC car.</p>
<p>There are some problems when converting an RC car to this bulldozer.</p>
<h3 id="52-dc-motor">5.2 DC motor</h3>
<p>The DC motor used in the bulldozer is the familiar [FA-130RA motor] from Mini 4WD (<a href="https://product.mabuchi-motor.co.jp/detail.html?id=9">https://product.mabuchi-motor.co.jp/detail.html?id=9</a>) (bulk product) is.</p>
<p>It has two units, but the big difference from the RC car is that it is driven separately on the left and right. The input layer of Donkey Car is the angle value and the throttle value, but the bulldozer has the left motor input value and the right motor input value, and it may be necessary to change the model.</p>
<p>Since the modification seems to be large when the model is changed, the configuration of the input layer is not changed and the angle value and throttle value are converted to the left motor input value and the right motor input value immediately before the output to the DC motor. ..</p>
<ul>
<li><a href="https://github.com/coolerking/caterpillar/blob/master/parts/actuator.py">GitHub:actuator.py</a></li>
</ul>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/7127dad9-b21e-d269-f320-82c0d28634c4.jpeg" alt="DC motor noise countermeasures"></p>
<p>In addition, since DC is a noise source for motors, <a href="https://monoist.atmarkit.co.jp/mn/articles/1602/19/news010.html">0.1μF capacitor is soldered</a>. ..</p>
<h3 id="53-motor-driver">5.3 Motor driver</h3>
<p>&lt;a target=&rdquo;_blank&rdquo; href=&quot;https://www.amazon.co.jp/gp/product/B01D1D0CX2/ref=as_li_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=B01D1D0CX2&amp;linkCode=as2&amp;tag=hara2dev0d-22&amp;linkId8ded8def8df8df8df8df8df8df8df8df8df8df8df8 &gt;<img border="0" src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=JP&ASIN=B01D1D0CX2&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL250_&tag=hara2dev0d-22" >&lt;/ a&gt;<img src="//ir-jp.amazon-adsystem.com/e/ir?t=hara2dev0d-22&l=am2&o=9&a=B01D1D0CX2" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>
<p>Donkey Car standard motor driver is PCA9685, but this board cannot be used because it is a DC motor this time.Therefore, Akizuki Denshi has been searching for a motor driver that can operate two DC motors. It is &ldquo;<a href="http://akizukidenshi.com/catalog/g/gK-11219/">Dual DC motor drive kit using TB6612</a>&rdquo;.</p>
<img width="604" alt="Akizuki Denshi TB6612" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/77c53395-4780-4a11-bb00-d49d538849f5.png">
<ul>
<li><a href="http://akizukidenshi.com/catalog/g/gK-11219/">Dual DC motor drive kit using TB6612</a></li>
</ul>
<p>Since it is a kit product, soldering is required, but since it is a pin connector and a terminal block, the points are that you can connect and disconnect the wiring freely and operate two DC motors individually with one sheet.</p>
<p>However, this board uses three GPIOs for operation per DC motor rather than I2C connections. One of them must be the PWM pin.</p>
<p>The Raspberry Pi has only two hardware PWM pins that can be operated at the same time, so I can make it in time, but this time I also had a technical desire and tried the software PWM using the <code>pigpio</code> package. As I wrote earlier, I wanted to know how good the software PWM (using normal GPIO pins as PWM pins) in the <code>pigpio</code> package is.</p>
<p>For this reason, I have created a separate <a href="https://github.com/coolerking/caterpillar/blob/master/parts/pigpio_wrapper.py">Wrapper class using the <code>pigpio</code> package</a>.</p>
<p>In addition to the above, to supply power to the TB6612 itself, Vcc pin (5V), GND pin, and STBY pin that manages the enable/disable of the motor driver are used, so a total of 9 pins are used for the Raspberry Pi. It is connected using a jumper cable.</p>
<blockquote>
<p>The STBY pin can be omitted by soldering JP1 on the board.</p>
</blockquote>
<h3 id="54-battery">5.4 Battery</h3>
<p>Raspberry Pi is <a href="https://en.wikipedia.org/wiki/%E3%83%A6%E3%83%8B%E3%83%90%E3%83%BC%E3%82%B5%E3%83%AB%E3%83%BB%E3%82%B7%E3%83%AA%E3%82%A2%E3%83%AB%E3%83%BB%E3%83%90%E3%82%B9">USB power supply</a>, so it is clear that a 5V power supply is needed.</p>
<p>If one battery is used to power the Raspberry Pi and two DC motors, a step-down circuit is required, increasing the difficulty of the electric circuit. Therefore, this time we prepared batteries separately.</p>
<p>&lt;a target=&rdquo;_blank&rdquo; href=&quot;https://www.amazon.co.jp/gp/product/B01HUX8YDY/ref=as_li_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=B01HUX8YDY&amp;linkCode=as2&amp;tag=hara2dev0d-22&amp;linkId25f5567368944. &gt;<img border="0" src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=JP&ASIN=B01HUX8YDY&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL250_&tag=hara2dev0d-22" >&lt;/ a&gt;<img src="//ir-jp.amazon-adsystem.com/e/ir?t=hara2dev0d-22&l=am2&o=9&a=B01HUX8YDY" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>
<p>First of all, for the battery of two DC motors, this was supported by a 3V AA battery. For the battery box, we chose a square one in consideration of ease of mounting on the main body.</p>
<p>And the battery on the Raspberry Pi side. As I mentioned earlier, it is powered by USB, so the quickest way is to use a mobile battery such as a cell phone.</p>
<p>The Raspberry Pi will not start even if you connect it if you do not have enough power. Even if it starts up, it seems that the battery error frequently occurs in syslog and it may be shut down without permission.</p>
<p>After some purchase and trial and error, I chose <a href="https://www.yodobashi.com/product/100000001002808783/">Maxell Mobile Battery MPC-C2600</a>. This is because it is the lightest mobile battery that can be activated and has a shape like a thin plate, so it was easy to attach to the main body.</p>
<ul>
<li><a href="https://www.yodobashi.com/product/100000001002808783/">Yodobashi.com: Maxell MPC-C2600BK [Mobile Rechargeable Battery 2.600mAh Black]</a></li>
</ul>
<h3 id="55-camera-mount">5.5 Camera mount</h3>
<p>The battery I was looking for at Yodobashi.com, I found one that looked good. Clip type camera stand.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/1d6a9542-4090-0b0f-c4ee-8d2ea07a3827.jpeg" alt="Camera stand that design is not good but convenient"></p>
<p>It seems to be for mounting a general camera, and since this clip is quite strong, I immediately adopted it. It was also nice that the camera case for Raspberry Pi had nuts for general cameras.</p>
<p>However, since this camera case and Wide Angle Pi camera can not be attached, it is changed to a standard camera.</p>
<h3 id="56-joystick">5.6 Joystick</h3>
<p>When driving the Donkey Car manually, you can select either Web UI or joystick. However, few people are using this Web UI. It is difficult to drive.</p>
<p>So I will use a joystick. The joystick types supported by the standard are also written in the <code>CONTROLLER_TYPE</code> comment of <code>myconfig.py</code>, but PS3/PS4 controller, XBox controller, Nimbus (Apple TV etc.) controller, WiiU controller, Logitech F710 controller And so on.</p>
<blockquote>
<p>There is also a class called <a href="https://github.com/autorope/donkeycar/blob/5f67f59004efae8d7d608c2430b6ca7955d217c0/donkeycar/parts/controller.py#L1278">RC3ChanJoystick</a>, but I was not sure which joystick this was. ..</p>
</blockquote>
<p>Since Raspberry Pi is equipped with Bluetooth, I think that many people think that PS3/PS4 controller is used by using it, but when bluetooth is enabled with Raspberry Pi Stretch, the daemon is giving a Permission error. , The OS has become unstable and the image has to be recreated, which often does not work well, and I have never seen anyone using it.</p>
<p><A target = "_ blank" href = "https://www.amazon.co.jp/gp/product/B00475S13W/ref=as_li_tl?ie=UTF8&camp=247&creative=1211&creativeASIN=B00475S13W&linkCode=as2&tag=hara2dev0d-22&linkId=d0b8971a87777b10c8ae797ae8f4703c" ><img border="0" src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=JP&ASIN=B00475S13W&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL250_&tag=hara2dev0d-22" >&lt;/ a&gt;<img src="//ir-jp.amazon-adsystem.com/e/ir?t=hara2dev0d-22&l=am2&o=9&a=B00475S13W" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>
<p>Many domestic Donkey Cars use the Logitech F710 wireless joystick. Once you insert the dongle into the USB port, the <code>CONTROLL_TYPE</code> value can be set to <code>f710</code> and the operation is very easy.</p>
<p>However, when I tried to move the Donkey Car at a big driving event such as Maker Fair, there was a problem that the F710 had a conflict and the driving operation became impossible.</p>
<p>&lt;a target=&rdquo;_blank&rdquo; href=&quot;https://www.amazon.co.jp/gp/product/B01NCIYC3F/ref=as_li_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=B01NCIYC3F&amp;linkCode=as2&amp;tag=hara2dev0d-22&amp;linkId=473b15ea55a7b55ea2a3a55a2a5a5e7a5a5e7a5ab7a5e7a5ab7a5e7a7a5a7e7a7b55a7e7a7b55ea2a7b7a5a5eee7a7a5ea5a7a7a5eee5 &gt;<img border="0" src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=JP&ASIN=B01NCIYC3F&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL250_&tag=hara2dev0d-22" >&lt;/ a&gt;<img src="//ir-jp.amazon-adsystem.com/e/ir?t=hara2dev0d-22&l=am2&o=9&a=B01NCIYC3F" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>
<p>So I used a minor joystick, the ELECOM JC-U3912T, a minor gamepad.</p>
<p>If you want to use your own gamepad, you have to create your own controller part class, but you can use the <code>donkey createjs</code> command introduced earlier to create this class interactively.* <a href="https://github.com/coolerking/caterpillar/blob/master/parts/controller.py">GitHub:controller.py</a></p>
<h3 id="57-managepy">5.7 <code>manage.py</code></h3>
<p>The parts created to convert the bulldozer into a Donkey Car are as follows.</p>
<p>*Pigpio wrapper parts and motor driver parts for moving TB6612</p>
<ul>
<li>Parts for moving the JC-U3912T</li>
</ul>
<p>It is completed by incorporating this in <code>manage.py</code>. Therefore, you need to understand what parts <code>manage.py</code> is built in by default.</p>
<p>The following table is a list of the part classes processed by the Vehicle loop when run in the default state.</p>
<table>
<thead>
<tr>
<th align="left">Part Class</th>
<th align="left"><code>inputs</code></th>
<th align="left"><code>outputs</code></th>
<th align="center"><code>threaded</code></th>
<th align="left">Uses</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>PiCamera</code></td>
<td align="left">N/A</td>
<td align="left"><code>['cam/image_array']</code></td>
<td align="center"><code>False</code></td>
<td align="left">Pi camera image captured</td>
</tr>
<tr>
<td align="left"><code>LocalWebController</code></td>
<td align="left"><code>['cam/image_array']</code></td>
<td align="left"><code>['user/angle','user/throttle','user/mode','recording']</code></td>
<td align="center"><code>True</code></td>
<td align="left">Input from web screen Get the value</td>
</tr>
<tr>
<td align="left"><code>ThrottleFilter</code></td>
<td align="left"><code>['user/throttle']</code></td>
<td align="left"><code>['user/throttle']</code></td>
<td align="center"><code>False</code></td>
<td align="left">Set the throttle value to zero when going backwards</td>
</tr>
<tr>
<td align="left"><code>PilotCondition</code></td>
<td align="left"><code>['user/mode']</code></td>
<td align="left"><code>['run_pilot']</code></td>
<td align="center"><code>False</code></td>
<td align="left">Convert the operation mode 3 values (string) to Boolean</td>
</tr>
<tr>
<td align="left"><code>RecordTracker</code></td>
<td align="left"><code>[&quot;tub/num_records&quot;]</code></td>
<td align="left"><code>['records/alert']</code></td>
<td align="center"><code>False</code></td>
<td align="left">Display alerts every certain number of items</td>
</tr>
<tr>
<td align="left"><code>ImgPreProcess</code></td>
<td align="left"><code>['cam/image_array']</code></td>
<td align="left"><code>['cam/normalized/cropped']</code></td>
<td align="center"><code>False</code></td>
<td align="left">If the run_condition` is true, the image is deleted by the specified values. Reshape |</td>
</tr>
<tr>
<td align="left"><code>FileWatcher</code></td>
<td align="left">N/A</td>
<td align="left"><code>['modelfile/modified']</code></td>
<td align="center"><code>False</code></td>
<td align="left">Whether to update the specified file</td>
</tr>
<tr>
<td align="left"><code>FileWatcher</code></td>
<td align="left">N/A</td>
<td align="left"><code>outputs=['modelfile/dirty']</code></td>
<td align="center"><code>False</code></td>
<td align="left"><code>ai_running</code> is true only if the specified file is updated</td>
</tr>
<tr>
<td align="left"><code>DelayedTrigger</code></td>
<td align="left"><code>['modelfile/dirty']</code></td>
<td align="left"><code>['modelfile/reload']</code></td>
<td align="center"><code>False</code></td>
<td align="left"><code>ai_running</code> is true, returns a true value for each specified number</td>
</tr>
<tr>
<td align="left"><code>TriggeredCallback</code></td>
<td align="left"><code>[&quot;modelfile/reload&quot;],</code></td>
<td align="left">N/A</td>
<td align="center"><code>False</code></td>
<td align="left"><code>ai_running</code> executes the specified method if true</td>
</tr>
<tr>
<td align="left"><code>KerasLinear</code></td>
<td align="left"><code>'cam/normalized/cropped']</code></td>
<td align="left"><code>['pilot/angle','pilot/throttle']</code></td>
<td align="center"><code>False</code></td>
<td align="left"><code>ai_running</code> if true performs machine learning model inference</td>
</tr>
<tr>
<td align="left"><code>DriveMode</code></td>
<td align="left"><code>['user/mode','user/angle','user/throttle','pilot/angle','pilot/throttle']</code></td>
<td align="left"><code>['angle','throttle']</code></td>
<td align="center"><code>False</code></td>
<td align="left">Determines the final output value according to the operation mode</td>
</tr>
<tr>
<td align="left"><code>AiLaunch</code></td>
<td align="left"><code>['user/mode','throttle']</code></td>
<td align="left"><code>['throttle']</code></td>
<td align="center"><code>False</code></td>
<td align="left">Maintain a constant throttle from the initial startup of the machine learning model until it stabilizes</td>
</tr>
<tr>
<td align="left"><code>AiRunCondition</code></td>
<td align="left"><code>['user/mode']</code></td>
<td align="left"><code>['ai_running']</code></td>
<td align="center"><code>False</code></td>
<td align="left">Determine if automatic operation is in progress</td>
</tr>
<tr>
<td align="left"><code>AiRecordingCondition</code></td>
<td align="left"><code>['user/mode','recording']</code></td>
<td align="left"><code>['recording']</code></td>
<td align="center"><code>False</code></td>
<td align="left">Always enable the recording mode during automatic operation</td>
</tr>
<tr>
<td align="left"><code>PWMSteering</code></td>
<td align="left"><code>['angle']</code></td>
<td align="left">N/A</td>
<td align="center"><code>False</code></td>
<td align="left">Transmit the input value to the steering servo</td>
</tr>
<tr>
<td align="left"><code>PWMThrottle</code></td>
<td align="left"><code>['throttle']</code></td>
<td align="left">N/A</td>
<td align="center"><code>False</code></td>
<td align="left">Transmit the input value to the throttle motor (ESC)</td>
</tr>
<tr>
<td align="left"><code>TubWriter</code></td>
<td align="left"><code>['cam/image_array','user/angle','user/throttle','user/mode']</code></td>
<td align="left"><code>[&quot;tub/num_records&quot;]</code></td>
<td align="center"><code>False</code></td>
<td align="left"><code>ai_recording</code> If is a true value, write one Tub data and get the current number</td>
</tr>
</tbody>
</table>
<p>Of the above, there are two parts classes that operate the PCA9685 directly: <code>PWMSteering</code> and <code>PWMThottle</code>. You have to create and add a function that converts the input value to a two-wheel drive motor value and a class that outputs these alternatives to TB6612.</p>
<p>The difference in the motor driver is branched by the <code>DRIVE_TRAIN_TYPE</code> value of <code>myconfig.py</code>, so the branch for TB6612 was added and added.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    :
    <span style="color:#75715e">#DC2 motor pigpio control, no TB6612 jumper setting</span>
    <span style="color:#66d9ef">elif</span> cfg<span style="color:#f92672">.</span>DRIVE_TRAIN_TYPE <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;DC_TWO_WHEEL_PIGPIO&#34;</span>:
        <span style="color:#66d9ef">try</span>:
            <span style="color:#f92672">import</span> pigpio
        <span style="color:#66d9ef">except</span>:
            <span style="color:#66d9ef">raise</span>
        <span style="color:#75715e"># pigpio control start</span>
        pgio <span style="color:#f92672">=</span> pigpio<span style="color:#f92672">.</span>pi()

        <span style="color:#f92672">from</span> parts <span style="color:#f92672">import</span> PIGPIO_OUT, PIGPIO_PWM, CaterpillerMotorDriver

        <span style="color:#75715e">#TB6612 STBY Pin initialization</span>
        stby <span style="color:#f92672">=</span> PIGPIO_OUT(pin<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>TB6612_STBY_GPIO, pgio<span style="color:#f92672">=</span>pgio, debug<span style="color:#f92672">=</span>use_debug)
        stby<span style="color:#f92672">.</span>run(<span style="color:#ae81ff">1</span>)

        <span style="color:#75715e"># Convert joystick output value to DC motor input value</span>
        driver <span style="color:#f92672">=</span> CaterpillerMotorDriver(
            left_balance<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>LEFT_PWM_BALANCE,
            right_balance<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>RIGHT_PWM_BALANCE,
            debug<span style="color:#f92672">=</span>use_debug)
        V<span style="color:#f92672">.</span>add(driver,
                inputs<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;throttle&#39;</span>,<span style="color:#e6db74">&#39;angle&#39;</span>],
                outputs<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;left_motor_vref&#39;</span>,<span style="color:#e6db74">&#39;left_motor_in1&#39;</span>,<span style="color:#e6db74">&#39;left_motor_in2&#39;</span>,
                <span style="color:#e6db74">&#39;right_motor_vref&#39;</span>,<span style="color:#e6db74">&#39;right_motor_in1&#39;</span>,<span style="color:#e6db74">&#39;right_motor_in2&#39;</span>])

        <span style="color:#75715e">#Left motor control</span>
        left_in1 <span style="color:#f92672">=</span> PIGPIO_OUT(pin<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>LEFT_MOTOR_IN1_GPIO, pgio<span style="color:#f92672">=</span>pgio, debug<span style="color:#f92672">=</span>use_debug)
        left_in2 <span style="color:#f92672">=</span> PIGPIO_OUT(pin<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>LEFT_MOTOR_IN2_GPIO, pgio<span style="color:#f92672">=</span>pgio, debug<span style="color:#f92672">=</span>use_debug)
        left_vref <span style="color:#f92672">=</span> PIGPIO_PWM(pin<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>LEFT_MOTOR_PWM_GPIO, pgio<span style="color:#f92672">=</span>pgio, freq<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>PWM_FREQ, range<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>PWM_RANGE, debug<span style="color:#f92672">=</span>use_debug)
        V<span style="color:#f92672">.</span>add(left_in1, inputs<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;left_motor_in1&#39;</span>])
        V<span style="color:#f92672">.</span>add(left_in2, inputs<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;left_motor_in2&#39;</span>])
        V<span style="color:#f92672">.</span>add(left_vref, inputs<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;left_motor_vref&#39;</span>])

        <span style="color:#75715e"># Right motor control</span>
        right_in1 <span style="color:#f92672">=</span> PIGPIO_OUT(pin<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>RIGHT_MOTOR_IN1_GPIO, pgio<span style="color:#f92672">=</span>pgio, debug<span style="color:#f92672">=</span>use_debug)
        right_in2 <span style="color:#f92672">=</span> PIGPIO_OUT(pin<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>RIGHT_MOTOR_IN2_GPIO, pgio<span style="color:#f92672">=</span>pgio, debug<span style="color:#f92672">=</span>use_debug)
        right_vref <span style="color:#f92672">=</span> PIGPIO_PWM(pin<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>RIGHT_MOTOR_PWM_GPIO, pgio<span style="color:#f92672">=</span>pgio, freq<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>PWM_FREQ, range<span style="color:#f92672">=</span>cfg<span style="color:#f92672">.</span>PWM_RANGE, debug<span style="color:#f92672">=</span>use_debug)
        V<span style="color:#f92672">.</span>add(right_in1, inputs<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;right_motor_in1&#39;</span>])
        V<span style="color:#f92672">.</span>add(right_in2, inputs<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;right_motor_in2&#39;</span>])
        V<span style="color:#f92672">.</span>add(right_vref, inputs<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;right_motor_vref&#39;</span>])
</code></pre></div><p>In the default state, the operation is not the joystick but the Web UI. This is done by <code>LocalWebController</code>. We need to change this to a joystick, but the joystick parts class is not generated directly in <code>manage.py</code>. It is instantiated using the factory function <code>get_js_controller()</code>.</p>
<p>Therefore, this time, I created a function that wraps <code>get_js_controller()</code> and replaced it with the corresponding function on <code>manage.py</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">        :
        <span style="color:#75715e"># Change to your own factory function</span>
        <span style="color:#75715e">#from donkeycar.parts.controller import get_js_controller</span>
        <span style="color:#f92672">from</span> parts <span style="color:#f92672">import</span> get_js_controller
        
        ctr <span style="color:#f92672">=</span> get_js_controller(cfg)
</code></pre></div><p>In addition, in the <a href="https://github.com/coolerking/caterpillar/">public GitHub repository</a>, the <code>manage.py</code> for the bulldozer is saved with the name <code>manage_cat.py</code>.</p>
<h3 id="58-myconfigpy">5.8 <code>myconfig.py</code></h3>
<p>Added/changed the following variables for some parts added to <code>manage_cat.py</code>.</p>
<table>
<thead>
<tr>
<th align="left">** Variable name **</th>
<th align="left">** Value **</th>
<th align="left">** Description **</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>DRIVE_TRAIN_TYPE</code></td>
<td align="left"><code>DC_TWO_WHEEL_PIGPIO</code></td>
<td align="left">Built-in parts group to operate two DC motors using the <code>pigpio</code> package with the TB6612</td>
</tr>
<tr>
<td align="left"><code>RIGHT_PWM_BALANCE</code></td>
<td align="left"><code>1.0</code></td>
<td align="left">Index (0.0 to 1.0) multiplied by the right wheel DC motor output to adjust the left/right balance.</td>
</tr>
<tr>
<td align="left"><code>PWM_RANGE</code></td>
<td align="left"><code>255</code></td>
<td align="left">Range value of PWM output pin</td>
</tr>
<tr>
<td align="left"><code>PWM_FREQ</code></td>
<td align="left"><code>50</code></td>
<td align="left">PWM time slice (Hz)</td>
</tr>
<tr>
<td align="left"><code>LEFT_MOTOR_PWM_GPIO</code></td>
<td align="left"><code>13</code></td>
<td align="left">GPIO number of the PWM output pin that controls the voltage level of the right wheel drive motor</td>
</tr>
<tr>
<td align="left"><code>LEFT_MOTOR_IN1_GPIO</code></td>
<td align="left"><code>26</code></td>
<td align="left">GPIO number of the output pin that controls forward/reverse rotation of the left wheel drive motor (operates with 2 pins)</td>
</tr>
<tr>
<td align="left"><code>LEFT_MOTOR_IN2_GPIO</code></td>
<td align="left"><code>19</code></td>
<td align="left">GPIO number of the output pin that controls forward/reverse rotation of the left wheel drive motor (operates with 2 pins)</td>
</tr>
<tr>
<td align="left"><code>RIGHT_MOTOR_PWM_GPIO</code></td>
<td align="left"><code>16</code></td>
<td align="left">GPIO number of the PWM output pin that controls the voltage level of the right-wheel drive motor</td>
</tr>
<tr>
<td align="left"><code>RIGHT_MOTOR_IN1_GPIO</code></td>
<td align="left"><code>21</code></td>
<td align="left">GPIO number of the output pin that operates forward/reverse rotation of the right wheel drive motor (operates with 2 pins)</td>
</tr>
<tr>
<td align="left"><code>RIGHT_MOTOR_IN2_GPIO</code></td>
<td align="left"><code>20</code></td>
<td align="left">GPIO number of the output pin that controls the forward/reverse rotation of the right-wheel drive motor (operates with 2 pins)</td>
</tr>
<tr>
<td align="left"><code>TB6612_STBY_GPIO</code></td>
<td align="left"><code>4</code></td>
<td align="left">GPIO number of the standby pin that enables/disables TB6612</td>
</tr>
<tr>
<td align="left"><code>USE_JOYSTICK_AS_DEFAULT</code></td>
<td align="left"><code>True</code></td>
<td align="left">Use the joystick by default</td>
</tr>
<tr>
<td align="left"><code>AUTO_RECORD_ON_THROTTLE</code></td>
<td align="left"><code>True</code></td>
<td align="left">While manual operation, if the throttle value is not 0.0, Tub data will be recorded automatically</td>
</tr>
<tr>
<td align="left"><code>CONTROLLER_TYPE</code></td>
<td align="left"><code>JCU3912T</code></td>
<td align="left">Using ELECOM JC-U3912T as the controller</td>
</tr>
<tr>
<td align="left"><code>JOYSTICK_DEADZONE</code></td>
<td align="left"><code>0.1</code></td>
<td align="left">The minimum value of the throttle analog input value from the joystick, and the value less than this is the throttle zero</td>
</tr>
</tbody>
</table>
<h2 id="6-problems">6 problems</h2>
<p>I actually made it and tried it somehow, but I found some problems.</p>
<h3 id="61-track-rubber-stretch-problem">6.1 Track rubber stretch problem</h3>
<p>As you can see when you wrap the track of a bulldozer (or anything that uses tracks in a more fun craft series), it&rsquo;s a bit tight. For this reason, if you don&rsquo;t drive and roll it for a long time, it will stretch, and if you drive, the track will easily come off.</p>
<p>For this reason, it must be removed frequently.</p>
<h3 id="62-the-problem-of-not-going-straight">6.2 The problem of not going straight</h3>
<p>Sometimes the track is rewound each time, but the left and right motor output ratio adjustments are different each time. And the troublesome thing is that it goes straight at low speed, but it depends on which one becomes faster.</p>
<p>For this reason, the Tub data for each time becomes learning data that is valid only on the spot and cannot be reused.</p>
<h3 id="63-the-problem-that-movement-changes-when-greasing">6.3 The problem that movement changes when greasing</h3>
<p>Adding grease will allow you to drive smoothly and improve drivability. However, like the problem of not going straight, we cannot reuse past Tub data.</p>
<h3 id="64-the-problem-of-becoming-a-running-chicane-at-a-driving-event">6.4 The problem of becoming a running chicane at a driving event</h3>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/b00fed6e-2077-ec56-64cc-3edb058d4c54.jpeg" alt="First driving event"></p>
<p>At the driving event I participated in, all the self-driving cars except myself were RC car base, so it will not be a race in the first place.</p>
<h2 id="7-finally">7. Finally</h2>
<p>If you are looking to start a Donkey Car, we recommend starting with the standard Donkey Car kit. With the standard Donkey Car, you don&rsquo;t need to know RC car, Raspberry Pi, or Python.</p>
<p><img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/51bfe2f6-dd22-675f-5550-63cc7888c4ab.jpeg" alt="The standard Donkey Car I made first"></p>
<p>However, those who have knowledge of RC cars may want to try with brushless or engine (!) cars, and those who have knowledge of Python or Tensorflow will try Tensorflow Lite or Tensorflow Extension. maybe. If you are familiar with IoT, you may consider expansion such as ROS, MQTT broker, Edge by IoT gateway. I&rsquo;m not sure if you can, but you might want to try Arduino, M5, Corel Dev Board, Pi4B. Or you might consider installing LiDAR, ultrasonic sensor, IMU sensor, etc.</p>
<p><a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/5977ec6e-f0bb-775d-1e90-fba652014b93.jpeg">Donkey Car based on the second WARRIOR RC car</a></p>
<p>And you might want to show off your own car. If that happens, let&rsquo;s participate in a running event where other cars are also running.</p>
<p><a href="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/213774/76806c63-4090-65c2-58d6-018996825e08.jpeg">All Donkey Cars from the first driving event I participated in</a></p>
<p>As you can see by searching, running events are held somewhere in Japan once every 1-2 months.</p>
<p>And maybe you meet me somewhere.</p>
<p>p.s.</p>
<p>Tying band, the strongest.</p>
<p>&lt;a target=&rdquo;_blank&rdquo; href=&quot;https://www.amazon.co.jp/gp/product/B004OCQH8O/ref=as_li_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=B004OCQH8O&amp;linkCode=as2&amp;tag=hara2dev0b-22&amp;linkId=08a3c456768d &gt;<img border="0" src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=JP&ASIN=B004OCQH8O&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL250_&tag=hara2dev0b-22" >&lt;/ a&gt;<img src="//ir-jp.amazon-adsystem.com/e/ir?t=hara2dev0b-22&l=am2&o=9&a=B004OCQH8O" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-169005401-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
